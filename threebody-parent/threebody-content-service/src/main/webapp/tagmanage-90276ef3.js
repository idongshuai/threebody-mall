var TagManage={wpsTags:{},forfree:{all:"",pay:"false",free:"true"},hasNewTags:{all:"","no-wpstag":"false","has-wpstag":"true"},wpsVisible:{all:"","wps-visible":"true","wps-invisible":"false"},hasMorePage:!0,loadParams:{sourceType:"",forFree:"",hasNewTags:"",wpsVisible:"",chartiId:"",keyWord:"",page:1,timeStart:"",timeEnd:"",category:"",industry:"",status:"true"},loadTagParam:{keyWord:""},tempLoading:!1,requesting:!1,init:function(){var p=this,e=$("#file-list");$(".select-group").on("click",function(e){e.stopPropagation();var t=$(this);if(t.hasClass("drop-down"))t.removeClass("drop-down");else{var a=t.children(".selected-option").attr("source");t.children(".drop-menu").find('.drop-menu-i[data-value="'+a+'"]').addClass("active").siblings().removeClass("active"),$(".select-group").removeClass("drop-down"),t.addClass("drop-down")}}),$(".drop-menu").on("click",".drop-menu-i",function(e){var t=$(this),a=t.text(),s=t.data("value"),i=t.parents().siblings(".selected-option");i.text(a),i.attr("source",s)}),$("body").on("click",function(){var e=$(".select-group");e.removeClass("drop-down"),e.find(".drop-menu-i").removeClass("active")}),$("#btn-query-temp").on("click",function(){p.loadParams.chartId=$("#tempid-input").val(),p.loadParams.keyWord=$("#keyword-input").val(),p.loadParams.timeStart=$("#date-start").val(),p.loadParams.timeEnd=$("#date-end").val();var e=$("#temp-source").attr("source"),t=$("#temp-price").attr("source"),a=$("#temp-newtag").attr("source"),s=$("#temp-wpssee").attr("source");"all"==e&&(e=""),p.loadParams.page=1,p.loadParams.industry=$("#temp-industry").attr("source"),p.loadParams.sourceType=e,p.loadParams.forFree=p.forfree[t],p.loadParams.hasNewTags=p.hasNewTags[a],p.loadParams.wpsVisible=p.wpsVisible[s],p.loadTemp()}),$("#btn-sync-temp-click").off("click").on("click",function(){$(".sync-temp-potag-pop").show()}),$(".sync-temp-pop-close-btn").off("click").on("click",function(){$(".sync-temp-potag-pop").hide()}),$("#btn-sync-temp").on("click",function(){var e=$("#create-time-start").val(),t=$("#create-time-end").val();p.syncTemp(e,t)}),e.off("click.poptag").on("click.poptag",".potags-btn",function(){var e=$(this).parents(".file-item");e.addClass("selected");var t=e.find(".potag-name");if(0<t.length)for(var a=0;a<t.length;a++)for(var s=$(t[a]).text(),i=$(".new-tag-i"),o=0,n=i.length;o<n;o++)$(i[o]).text()==s&&$(i[o]).addClass("active");$(".potag-pop").show()}),$(".pop-close-btn").off("click").on("click",function(){$(".new-tag-i").removeClass("active"),$(".potag-pop").hide(),$(".file-item").removeClass("selected")}),$(".new-tag-list").off("click").on("click",".new-tag-i",function(e){var t=$(this);t.hasClass("active")?t.removeClass("active"):t.addClass("active")}),$(".clear-actag-btn").off("click").on("click",function(e){$(".new-tag-i").removeClass("active")}),$(".tag-to-file-btn").on("click",function(){var c=$(".file-item.selected"),e=[],r=c.length;if(!(0<r))return Util.globalTopTip("请选择模板","top_success",2e3,$(".main-content"),"noarrow"),void $(".pop-close-btn").trigger("click");for(var t=0;t<r;t++)e.push($(c[t]).attr("chartid"));for(var a=$(".new-tag-i.active"),s=[],i=0,o=a.length;i<o;i++)s.push($(a[i]).text());p.requesting||(p.requesting=!0,Util.loading({content:"loading...",show:1e6,delay:0,model:!1}),Util.ajax({url:"/wwpstemplate/save_tags",data:{tags:s.join(","),chartId:e.join(",")},success:function(e){p.requesting=!1,Util.loading({content:"loading...",show:100,delay:0,model:!1});var t=e.chartTags;if(0<r)for(var a=0;a<r;a++){for(var s=$(c[a]),i=t[s.attr("chartid")]||[],o="",n=0,l=i.length;n<l;n++)o+='<div class="potag-item"><div class="potag-name">'+i[n]+'</div><div class="potag-item-delete icons">&#xe637;</div></div>';s.find(".potags-cell-bd").html(o)}$(".pop-close-btn").trigger("click"),"success"==e.result?Util.globalTopTip("添加成功","top_success",2e3,$(".main-content"),"noarrow"):Util.globalTopTip("添加失败","top_error",2e3,$(".main-content"),"noarrow")},error:function(){p.requesting=!1,Util.loading({content:"loading...",show:100,delay:0,model:!1})}}))}),e.on("click",".wps-see-btn",function(){var t=$(this),e=$(this).parents(".file-item"),a=e.attr("chartid");if(t.hasClass("set-wps-not"))Util.ajax({url:"/wwpstemplate/wps_invisible",data:{chartId:a},success:function(e){"success"==e.result&&(t.removeClass("set-wps-not").text("设置可见"),Util.globalTopTip("已设置WPS不可见","top_success",2e3,$(".main-content"),"noarrow")),"error"==e.result&&Util.globalTopTip("设置WPS不可见失败,"+e.msg,"top_error",2e3,$(".main-content"),"noarrow")},error:function(){}});else{var s=e.find(".wps-price-num").val()-0;Util.ajax({url:"/wwpstemplate/wps_visible",data:{chartId:a,price:s},success:function(e){"success"==e.result&&(Util.globalTopTip("设置WPS可见成功","top_success",2e3,$(".main-content"),"noarrow"),t.removeClass("set-wps-not").addClass("set-wps-not").text("取消可见")),"error"==e.result&&Util.globalTopTip("设置WPS可见失败,"+e.msg,"top_error",2e3,$(".main-content"),"noarrow")},error:function(){}})}}),$("#btn-check-temp").on("click",function(){var e=$(this),t=$(".file-item");if(e.hasClass("cancel-check"))return $(this).removeClass("cancel-check").text("多选"),t.removeClass("check-status"),void $(".check-addtag").css("display","none");e.addClass("cancel-check").text("取消多选"),t.addClass("check-status"),$(".check-addtag").css("display","inline-block")}),e.off("click.select").on("click.select",".check-status",function(){var e=$(this);e.hasClass("selected")?e.removeClass("selected"):e.addClass("selected")}),$("#btn-check-addtag").on("click",function(){$(".potag-pop").show()}),e.off("click.potag_delete").on("click.potag_delete",".potag-item-delete",function(){var e=$(this).parents(".potag-item"),t=$(this).parents(".file-item");confirm("删除后,如果用户设置过此标签也会删除")&&(e.remove(),Util.ajax({url:"/wwpstemplate/remove_tags",data:{tags:e.find(".potag-name").text(),chartId:t.attr("chartid")},success:function(e){"success"!=e.result?Util.globalTopTip("删除wps标签失败,"+e.msg,"top_error",2e3,$(".main-content"),"noarrow"):Util.globalTopTip("删除wps标签成功","top_success",2e3,$(".main-content"),"noarrow")},error:function(){}}))}),$(".main-content").on("scroll",function(){if(p.hasMorePage&&!p.tempLoading){var e=$(this).scrollTop();$("#file-list").outerHeight()-e-$(this).outerHeight()<100&&(p.loadParams.page+=1,p.loadTemp("loadmore"))}}),this.loadTemp(),this.loadTags(),window.onresize=function(){p.setFileWidth()}},initFileEvent:function(){$(".file-thumb-con").off().on("click.view",function(e){var t=$(this).parents(".file-item").attr("chartid");window.open("https://v3.processon.com/wwpstemplate/view/"+t)})},setFileWidth:function(){for(var e=$(".main-content").width(),t=Math.ceil(e/250),a=document.getElementsByClassName("file-item"),s=0,i=a.length,o=0;o<i;o++){var n=a[o];n.style.cssText="width:-webkit-calc("+100/t+"% - 16px);width:calc("+100/t+"% - 16px);";var l=$(n).height();s<l&&(s=l)}for(var c=0;c<i;c++)$(a[c]).height(s-0+45);var r=$(".top-op-bar").height();document.querySelector(".main-content").style.cssText="height:-webkit-calc(100% - "+r+"px);height:calc(100% - "+r+"px);"},setFileHeight:function(){},loadTags:function(){var t=this;Util.ajax({url:"/wwpstemplate/get_category",data:t.loadTagParam,success:function(e){t.wpsTags=e.data,t.renderWPSTags()},error:function(){}})},renderWPSTags:function(){for(var e=this.wpsTags,t="",a=0,s=e.length;a<s;a++){var i=e[a];t+='<div class="tag-class">'+i.name+"</div>";for(var o=i.tagNames||[],n=0,l=o.length;n<l;n++)t+='<span class="new-tag-i">'+o[n]+"</span>"}$("#new-tag-list").html(t)},loadTemp:function(t){var a=this;this.tempLoading||(this.tempLoading=!0,Util.loading({content:"loading...",show:1e6,delay:0,model:!1}),Util.ajax({url:"/wwpstemplate/query",data:a.loadParams,success:function(e){a.tempLoading=!1,Util.loading({content:"loading...",show:1,delay:0,model:!1}),e.total-e.page<1?a.hasMorePage=!1:a.hasMorePage=!0,a.randerTemp(e,t),$("#file-count-num").text(e.records)},error:function(){a.tempLoading=!1,Util.loading({content:"loading...",show:1,delay:0,model:!1})}}))},randerTemp:function(e,t){for(var a=e.rows,s="",i=0,o=a.length;i<o;i++){var n=a[i],l=0,c="",r="",p="设置可见",d=n.themeTags||[],g="";0!=n.wpsPrice?l=n.wpsPrice:0<n.publicClonePrice-0&&(l=n.publicClonePrice+2),"visible"==n.wpsStatus&&(c="set-wps-not",p="取消可见"),n.tags&&(r=n.tags.join(","));var m=d.length;if(0<m)for(var u=0;u<m;u++)g+='<div class="potag-item"><div class="potag-name">'+d[u]+'</div><div class="potag-item-delete icons">&#xe637;</div></div>';s+='<div class="file-item " chartid="'+n.id+'"><div class="file-thumb-con"><img class="file-thumb" src="https://assets.processon.com/chart_image/template/thumb/'+n.thumbnail+'.png"  /></div><div class="file-dex-box"><div class="file-title">'+n.title+'</div><div class="file-des">'+n.description+'</div><div class="usertag-con"><span class="icons tag-icons">&#xe63c;</span><span class="utags-list">'+r+'</span></div></div><div class="potags-cell"><div class="potags-cell-bd">'+g+'</div></div><div class="user-price-cell"><span class="user-price-label">用户定价:</span><span class="user-price">'+n.publicClonePrice+'</span><span>元</span></div><div class="wps-price-cell"><span class="wps-price-label">WP价格:</span><span class="wps-price"><input class="wps-price-num" type="text" value="'+l+'"  /></span><span>元</span></div><div class="chart-op"><span class="icons">&#xe7f7;</span><span class="font">'+n.viewCount+'</span><span class="icons p-like">&#xe63a;</span><span class="font">'+n.likeCount+'</span><span class="icons">&#xe67a;</span><span class="font">'+n.cloneCount+'</span></div><div class="bot-btn-group"><div class="potags-btn button mini-button">添加标签</div><div class="wps-see-btn button mini-button '+c+'">'+p+"</div></div></div>"}var v=$("#file-list");"loadmore"==t?v.append(s):v.html(s),this.setFileWidth(),this.initFileEvent()},syncTemp:function(e,t){if(null!=e&&""!=e)if(null!=t&&""!=t){e+=" 00:00:00",t+=" 23:59:59";var a=this;this.tempLoading||(this.tempLoading=!0,Util.loading({content:"loading...",show:1e6,delay:0,model:!1}),$.ajax({url:"/manage/chart/template/syncTemp/"+e+"/"+t,type:"GET",success:function(e){if($(".sync-temp-potag-pop").hide(),a.tempLoading=!1,Util.loading({content:"loading...",show:1,delay:0,model:!1}),"success"==e.result){var t="同步了"+e.sync+"个模板";0!=e.exist&&(t=t+", "+e.exist+"个模板已存在"),Util.globalTopTip(t,"top_success",3e3,$(".main-content"),"noarrow")}else Util.globalTopTip(e.msg,"top_error",2e3,$(".main-content"),"noarrow")},error:function(){$(".sync-temp-potag-pop").hide(),a.tempLoading=!1,Util.loading({content:"loading...",show:1,delay:0,model:!1}),Util.globalTopTip("未知错误","top_error",2e3,$(".main-content"),"noarrow")}}))}else Util.globalTopTip("结束日期不能为空","top_error",2e3,$(".main-content"),"noarrow");else Util.globalTopTip("开始日期不能为空","top_error",2e3,$(".main-content"),"noarrow")}};TagManage.init();