!function(be){var ye=Math.abs,ge=Math.max,xe=Math.min,we=Math.round;function ve(){return be("<div/>")}be.imgAreaSelect=function(o,n){var t,i,r,d,a,c,s,l,u,h,f,m,e,p,b,y,g,x,w,v,S,z,k,C,A,W,I,P,K=be(o),N=ve(),H=ve(),M=ve().add(ve()).add(ve()).add(ve()),O=ve().add(ve()).add(ve()).add(ve()),E=be([]),T={left:0,top:0},L={left:0,top:0},j=0,D="absolute",R={x1:0,y1:0,x2:0,y2:0,width:0,height:0},$=document.documentElement;function q(e){return e+T.left-L.left}function B(e){return e+T.top-L.top}function Q(e){return e-T.left+L.left}function X(e){return e-T.top+L.top}function Y(e){return e.pageX-L.left}function F(e){return e.pageY-L.top}function G(e){var t=e||h,e=e||f;return{x1:we(R.x1*t),y1:we(R.y1*e),x2:we(R.x2*t),y2:we(R.y2*e),width:we(R.x2*t)-we(R.x1*t),height:we(R.y2*e)-we(R.y1*e)}}function J(e,t,o,i,s){var n=s||h,s=s||f;(R={x1:we(e/n||0),y1:we(t/s||0),x2:we(o/n||0),y2:we(i/s||0)}).width=R.x2-R.x1,R.height=R.y2-R.y1}function U(){K.width()&&(T={left:we(K.offset().left),top:we(K.offset().top)},a=K.innerWidth(),c=K.innerHeight(),T.top+=K.outerHeight()-c>>1,T.left+=K.outerWidth()-a>>1,e=we(n.minWidth/h)||0,p=we(n.minHeight/f)||0,b=we(xe(n.maxWidth/h||1<<24,a)),y=we(xe(n.maxHeight/f||1<<24,c)),"1.3.2"!=be().jquery||"fixed"!=D||$.getBoundingClientRect||(T.top+=ge(document.body.scrollTop,$.scrollTop),T.left+=ge(document.body.scrollLeft,$.scrollLeft)),L=/absolute|relative/.test(s.css("position"))?{left:we(s.offset().left)-s.scrollLeft(),top:we(s.offset().top)-s.scrollTop()}:"fixed"==D?{left:be(document).scrollLeft(),top:be(document).scrollTop()}:{left:0,top:0},r=q(0),d=B(0),(R.x2>a||R.y2>c)&&se())}function V(e){if(x){switch(N.css({left:q(R.x1),top:B(R.y1)}).add(H).width(W=R.width).height(I=R.height),H.add(M).add(E).css({left:0,top:0}),M.width(ge(W-M.outerWidth()+M.innerWidth(),0)).height(ge(I-M.outerHeight()+M.innerHeight(),0)),be(O[0]).css({left:r,top:d,width:R.x1,height:c}),be(O[1]).css({left:r+R.x1,top:d,width:W,height:R.y1}),be(O[2]).css({left:r+R.x2,top:d,width:a-R.x2,height:c}),be(O[3]).css({left:r+R.x1,top:d+R.y2,width:W,height:c-R.y2}),W-=E.outerWidth(),I-=E.outerHeight(),E.length){case 8:be(E[4]).css({left:W>>1}),be(E[5]).css({left:W,top:I>>1}),be(E[6]).css({left:W>>1,top:I}),be(E[7]).css({top:I>>1});case 4:E.slice(1,3).css({left:W}),E.slice(2,4).css({top:I})}!1!==e&&(be.imgAreaSelect.keyPress!=fe&&be(document).unbind(be.imgAreaSelect.keyPress,be.imgAreaSelect.onKeyPress),n.keys&&be(document)[be.imgAreaSelect.keyPress](be.imgAreaSelect.onKeyPress=fe)),be.browser.msie&&M.outerWidth()-M.innerWidth()==2&&(M.css("margin",0),setTimeout(function(){M.css("margin","auto")},0))}}function Z(e){U(),V(e),w=q(R.x1),v=B(R.y1),S=q(R.x2),z=B(R.y2)}function _(e,t){n.fadeSpeed?e.fadeOut(n.fadeSpeed,t):e.hide()}function ee(e){var t=Q(Y(e))-R.x1,e=X(F(e))-R.y1;P||(U(),P=!0,N.one("mouseout",function(){P=!1})),m="",n.resizable&&(e<=n.resizeMargin?m="n":e>=R.height-n.resizeMargin&&(m="s"),t<=n.resizeMargin?m+="w":t>=R.width-n.resizeMargin&&(m+="e")),N.css("cursor",m?m+"-resize":n.movable?"move":""),i&&i.toggle()}function te(e){be("body").css("cursor",""),!n.autoHide&&R.width*R.height!=0||_(N.add(O),function(){be(this).hide()}),be(document).unbind("mousemove",ne),N.mousemove(ee),n.onSelectEnd(o,G())}function oe(e){return 1!=e.which||(U(),m?(be("body").css("cursor",m+"-resize"),w=q(R[/w/.test(m)?"x2":"x1"]),v=B(R[/n/.test(m)?"y2":"y1"]),be(document).mousemove(ne).one("mouseup",te),N.unbind("mousemove",ee)):n.movable?(l=r+R.x1-Y(e),u=d+R.y1-F(e),N.unbind("mousemove",ee),be(document).mousemove(de).one("mouseup",function(){n.onSelectEnd(o,G()),be(document).unbind("mousemove",de),N.mousemove(ee)})):K.mousedown(e)),!1}function ie(e){g&&(e?(S=ge(r,xe(r+a,w+ye(z-v)*g*(w<S||-1))),z=we(ge(d,xe(d+c,v+ye(S-w)/g*(v<z||-1)))),S=we(S)):(z=ge(d,xe(d+c,v+ye(S-w)/g*(v<z||-1))),S=we(ge(r,xe(r+a,w+ye(z-v)*g*(w<S||-1)))),z=we(z)))}function se(){w=xe(w,r+a),v=xe(v,d+c),ye(S-w)<e&&((S=w-e*(S<w||-1))<r?w=r+e:r+a<S&&(w=r+a-e)),ye(z-v)<p&&((z=v-p*(z<v||-1))<d?v=d+p:d+c<z&&(v=d+c-p)),S=ge(r,xe(S,r+a)),z=ge(d,xe(z,d+c)),ie(ye(S-w)<ye(z-v)*g),ye(S-w)>b&&(S=w-b*(S<w||-1),ie()),ye(z-v)>y&&(z=v-y*(z<v||-1),ie(!0)),R={x1:Q(xe(w,S)),x2:Q(ge(w,S)),y1:X(xe(v,z)),y2:X(ge(v,z)),width:ye(S-w),height:ye(z-v)},V(),n.onSelectChange(o,G())}function ne(e){return S=/w|e|^$/.test(m)||g?Y(e):q(R.x2),z=/n|s|^$/.test(m)||g?F(e):B(R.y2),se(),!1}function re(e,t){S=(w=e)+R.width,z=(v=t)+R.height,be.extend(R,{x1:Q(w),y1:X(v),x2:Q(S),y2:X(z)}),V(),n.onSelectChange(o,G())}function de(e){return w=ge(r,xe(l+Y(e),r+a-R.width)),v=ge(d,xe(u+F(e),d+c-R.height)),re(w,v),e.preventDefault(),!1}function ae(){be(document).unbind("mousemove",ae),U(),S=w,z=v,se(),m="",O.is(":visible")||N.add(O).hide().fadeIn(n.fadeSpeed||0),x=!0,be(document).unbind("mouseup",ce).mousemove(ne).one("mouseup",te),N.unbind("mousemove",ee),n.onSelectStart(o,G())}function ce(){be(document).unbind("mousemove",ae).unbind("mouseup",ce),_(N.add(O)),J(Q(w),X(v),Q(w),X(v)),!this instanceof be.imgAreaSelect&&(n.onSelectChange(o,G()),n.onSelectEnd(o,G()))}function le(e){return 1!=e.which||O.is(":animated")||(U(),l=w=Y(e),u=v=F(e),be(document).mousemove(ae).mouseup(ce)),!1}function ue(){Z(!1)}function he(){t=!0,pe(n=be.extend({classPrefix:"imgareaselect",movable:!0,parent:"body",resizable:!0,resizeMargin:10,onInit:function(){},onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}},n)),N.add(O).css({visibility:""}),n.show&&(x=!0,U(),V(),N.add(O).hide().fadeIn(n.fadeSpeed||0)),setTimeout(function(){n.onInit(o,G())},0)}var fe=function(e){var t,o=n.keys,i=e.keyCode,s=isNaN(o.alt)||!e.altKey&&!e.originalEvent.altKey?!isNaN(o.ctrl)&&e.ctrlKey?o.ctrl:!isNaN(o.shift)&&e.shiftKey?o.shift:isNaN(o.arrows)?10:o.arrows:o.alt;if("resize"==o.arrows||"resize"==o.shift&&e.shiftKey||"resize"==o.ctrl&&e.ctrlKey||"resize"==o.alt&&(e.altKey||e.originalEvent.altKey)){switch(i){case 37:s=-s;case 39:t=ge(w,S),w=xe(w,S),S=ge(t+s,w),ie();break;case 38:s=-s;case 40:t=ge(v,z),v=xe(v,z),z=ge(t+s,v),ie(!0);break;default:return}se()}else switch(w=xe(w,S),v=xe(v,z),i){case 37:re(ge(w-s,r),v);break;case 38:re(w,ge(v-s,d));break;case 39:re(w+xe(s,a-Q(S)),v);break;case 40:re(w,v+xe(s,c-X(z)));break;default:return}return!1};function me(e,t){for(option in t)void 0!==n[option]&&e.css(t[option],n[option])}function pe(e){if(e.parent&&(s=be(e.parent)).append(N.add(O)),be.extend(n,e),U(),null!=e.handles){for(E.remove(),E=be([]),C=e.handles?"corners"==e.handles?4:8:0;C--;)E=E.add(ve());E.addClass(n.classPrefix+"-handle").css({position:"absolute",fontSize:0,zIndex:j+1||1}),0<=!parseInt(E.css("width"))&&E.width(5).height(5),(A=n.borderWidth)&&E.css({borderWidth:A,borderStyle:"solid"}),me(E,{borderColor1:"border-color",borderColor2:"background-color",borderOpacity:"opacity"})}for(h=n.imageWidth/a||1,f=n.imageHeight/c||1,null!=e.x1&&(J(e.x1,e.y1,e.x2,e.y2),e.show=!e.hide),e.keys&&(n.keys=be.extend({shift:1,ctrl:"resize"},e.keys)),O.addClass(n.classPrefix+"-outer"),H.addClass(n.classPrefix+"-selection"),C=0;C++<4;)be(M[C-1]).addClass(n.classPrefix+"-border"+C);me(H,{selectionColor:"background-color",selectionOpacity:"opacity"}),me(M,{borderOpacity:"opacity",borderWidth:"border-width"}),me(O,{outerColor:"background-color",outerOpacity:"opacity"}),(A=n.borderColor1)&&be(M[0]).css({borderStyle:"solid",borderColor:A}),(A=n.borderColor2)&&be(M[1]).css({borderStyle:"dashed",borderColor:A}),N.append(H.add(M).add(i).add(E)),be.browser.msie&&((A=O.css("filter").match(/opacity=(\d+)/))&&O.css("opacity",A[1]/100),(A=M.css("filter").match(/opacity=(\d+)/))&&M.css("opacity",A[1]/100)),e.hide?_(N.add(O)):e.show&&t&&(x=!0,N.add(O).fadeIn(n.fadeSpeed||0),Z()),g=(A=(n.aspectRatio||"").split(/:/))[0]/A[1],K.add(O).unbind("mousedown",le),n.disable||!1===n.enable?(N.unbind("mousemove",ee).unbind("mousedown",oe),be(window).unbind("resize",ue)):(!n.enable&&!1!==n.disable||((n.resizable||n.movable)&&N.mousemove(ee).mousedown(oe),be(window).resize(ue)),n.persistent||K.add(O).mousedown(le)),n.enable=n.disable=void 0}for(this.remove=function(){pe({disable:!0}),N.add(O).remove()},this.getOptions=function(){return n},this.setOptions=pe,this.getSelection=G,this.setSelection=J,this.cancelSelection=ce,this.update=Z,k=K;k.length;)j=ge(j,isNaN(k.css("z-index"))?j:k.css("z-index")),"fixed"==k.css("position")&&(D="fixed"),k=k.parent(":not(body)");j=n.zIndex||j,be.browser.msie&&K.attr("unselectable","on"),be.imgAreaSelect.keyPress=be.browser.msie||be.browser.safari?"keydown":"keypress",be.browser.opera&&(i=ve().css({width:"100%",height:"100%",position:"absolute",zIndex:j+2||2})),N.add(O).css({visibility:"hidden",position:D,overflow:"hidden",zIndex:j||"0"}),N.css({zIndex:j+2||2}),H.add(M).css({position:"absolute",fontSize:0}),o.complete||"complete"==o.readyState||!K.is("img")?he():K.one("load",he),be.browser.msie&&7<=be.browser.version&&(o.src=o.src)},be.fn.imgAreaSelect=function(e){return e=e||{},this.each(function(){be(this).data("imgAreaSelect")?e.remove?(be(this).data("imgAreaSelect").remove(),be(this).removeData("imgAreaSelect")):be(this).data("imgAreaSelect").setOptions(e):e.remove||(void 0===e.enable&&void 0===e.disable&&(e.enable=!0),be(this).data("imgAreaSelect",new be.imgAreaSelect(this,e)))}),e.instance?be(this).data("imgAreaSelect"):this}}(jQuery);