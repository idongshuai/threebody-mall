var multipartFileIds="";KindEditor.plugin("image",function(T){var D=this,S="image",t=T.undef(D.allowImageUpload,!0),i=T.undef(D.allowImageRemote,!0),L=T.undef(D.formatUploadUrl,!0),_=T.undef(D.allowFileManager,!1),P=T.undef(D.uploadJson,D.basePath+"php/upload_json.php"),a=T.undef(D.imageTabIndex,0),W=D.pluginsPath+"image/images/",A=T.undef(D.extraFileUploadParams,{}),B=T.undef(D.filePostName,"imgFile"),R=T.undef(D.fillDescAfterUploadImage,!1),j=D.lang(S+".");D.plugin.imageDialog=function(e){e.imageUrl,T.undef(e.imageWidth,""),T.undef(e.imageHeight,""),T.undef(e.imageTitle,""),T.undef(e.imageAlign,"");var t,n=T.undef(e.showRemote,!0),o=T.undef(e.showLocal,!0),i=T.undef(e.tabIndex,0),d=e.clickFn,a="kindeditor_upload_iframe_"+(new Date).getTime(),l=[];for(t in A)l.push('<input type="hidden" name="'+t+'" value="'+A[t]+'" />');var r,s=['<div style="padding:20px;">','<div class="tabs"></div>','<div class="tab1" style="display:none;">','<div class="ke-dialog-row">','<label for="remoteUrl" style="width:60px;">'+j.remoteUrl+"</label>",'<input type="text" id="remoteUrl" class="ke-input-text" name="url" value="" style="width:200px;" /> &nbsp;','<span class="ke-button-common ke-button-outer">','<input type="button" class="ke-button-common ke-button" name="viewServer" value="'+j.viewServer+'" />',"</span>","</div>",'<div class="ke-dialog-row">','<label for="remoteWidth" style="width:60px;">'+j.size+"</label>",j.width+' <input type="text" id="remoteWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> ',j.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> ','<img class="ke-refresh-btn" src="'+W+'refresh.png" width="16" height="16" alt="" style="cursor:pointer;" title="'+j.resetSize+'" />',"</div>",'<div class="ke-dialog-row">','<label style="width:60px;">'+j.align+"</label>",'<input type="radio" name="align" class="ke-inline-block" value="" checked="checked" /> <img name="defaultImg" src="'+W+'align_top.gif" width="23" height="25" alt="" />',' <input type="radio" name="align" class="ke-inline-block" value="left" /> <img name="leftImg" src="'+W+'align_left.gif" width="23" height="25" alt="" />',' <input type="radio" name="align" class="ke-inline-block" value="right" /> <img name="rightImg" src="'+W+'align_right.gif" width="23" height="25" alt="" />',"</div>",'<div class="ke-dialog-row">','<label for="remoteTitle" style="width:60px;">'+j.imgTitle+"</label>",'<input type="text" id="remoteTitle" class="ke-input-text" name="title" value="" style="width:200px;" />',"</div>","</div>",'<div class="tab2" style="display:none;">','<iframe name="'+a+'" style="display:none;"></iframe>','<form class="ke-upload-area ke-form" method="post" enctype="multipart/form-data" target="'+a+'" action="'+T.addParam(P,"dir=image")+'">','<div class="ke-dialog-row" style="position:relative;">',l.join(""),'<label style="width:60px;">'+j.localUrl+"</label>",'<input type="text" name="localUrl" class="ke-input-text" tabindex="-1" style="width:200px;" readonly="true" /> &nbsp;','<input type="button" class="ke-upload-button" value="'+j.upload+'" />',"</div>","</form>","</div>","</div>"].join(""),u=o||_?450:400,g=o&&n?300:250,m=D.createDialog({name:S,width:u,height:g,title:D.lang(S),body:s,yesBtn:{name:D.lang("yes"),click:function(){if(!m.isLoading){if(o&&n&&r&&1===r.selectedIndex||!n)return""==x.fileBox.val()?void 0:(m.showLoading(D.lang("uploadLoading")),x.submit(),void h.val(""));var e=T.trim(p.val()),t=v.val(),i=b.val(),a=w.val(),l="";y.each(function(){if(this.checked)return l=this.value,!1}),"http://"==e||T.invalidUrl(e)?p[0].focus():/^\d*$/.test(t)?/^\d*$/.test(i)?d.call(D,e,a,t,i,0,l):b[0].focus():v[0].focus()}}},beforeRemove:function(){f.unbind(),v.unbind(),b.unbind(),k.unbind()}}),c=m.div,p=T('[name="url"]',c),h=T('[name="localUrl"]',c),f=T('[name="viewServer"]',c),v=T('.tab1 [name="width"]',c),b=T('.tab1 [name="height"]',c),k=T(".ke-refresh-btn",c),w=T('.tab1 [name="title"]',c),y=T('.tab1 [name="align"]',c);n&&o?((r=T.tabs({src:T(".tabs",c),afterSelect:function(){}})).add({title:j.remoteImage,panel:T(".tab1",c)}),r.add({title:j.localImage,panel:T(".tab2",c)}),r.select(i)):n?T(".tab1",c).show():o&&T(".tab2",c).show();var x=T.uploadbutton({button:T(".ke-upload-button",c)[0],fieldName:B,form:T(".ke-form",c),target:a,width:60,afterUpload:function(e){var t;m.hideLoading(),0===e.error&&(t=e.url,""!=multipartFileIds&&(multipartFileIds+=","),multipartFileIds+=t,L&&(t=T.formatUrl(t,"absolute")),D.afterUpload&&D.afterUpload.call(D,t,e,S),R?(T(".ke-dialog-row #remoteUrl",c).val(t),T(".ke-tabs-li",c)[0].click(),T(".ke-refresh-btn",c).click()):d.call(D,t,e.title,e.width,e.height,e.border,e.align))},afterError:function(e){m.hideLoading(),D.errorDialog(e)}});x.fileBox.change(function(e){h.val(x.fileBox.val())}),_?f.click(function(e){D.loadPlugin("filemanager",function(){D.plugin.filemanagerDialog({viewType:"VIEW",dirName:"image",clickFn:function(e){1<D.dialogs.length&&(T('[name="url"]',c).val(e),D.afterSelectFile&&D.afterSelectFile.call(D,e),D.hideDialog())}})})}):f.hide();var I=0,U=0;function F(e,t){v.val(e),b.val(t),I=e,U=t}return k.click(function(e){var t=T('<img src="'+p.val()+'" />',document).css({position:"absolute",visibility:"hidden",top:0,left:"-1000px"});t.bind("load",function(){F(t.width(),t.height()),t.remove()}),T(document.body).append(t)}),v.change(function(e){0<I&&b.val(Math.round(U/I*parseInt(this.value,10)))}),b.change(function(e){0<U&&v.val(Math.round(I/U*parseInt(this.value,10)))}),p.val(e.imageUrl),F(e.imageWidth,e.imageHeight),w.val(e.imageTitle),y.each(function(){if(this.value===e.imageAlign)return!(this.checked=!0)}),n&&0===i&&(p[0].focus(),p[0].select()),m},D.plugin.image={edit:function(){var e=D.plugin.getSelectedImage();D.plugin.imageDialog({imageUrl:e?e.attr("data-ke-src"):"http://",imageWidth:e?e.width():"",imageHeight:e?e.height():"",imageTitle:e?e.attr("title"):"",imageAlign:e?e.attr("align"):"",showRemote:i,showLocal:t,tabIndex:e?0:a,clickFn:function(e,t,i,a,l,n){D.exec("insertimage",e,t,i,a,l,n),setTimeout(function(){D.hideDialog().focus()},0)}})},delete:function(){var e=D.plugin.getSelectedImage();"a"==e.parent().name&&(e=e.parent()),e.remove()}},D.clickToolbar(S,D.plugin.image.edit)});