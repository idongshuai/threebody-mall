KindEditor.plugin("filemanager",function(g){var k=this,_="filemanager",b=g.undef(k.fileManagerJson,k.basePath+"php/file_manager_json.php"),w=k.pluginsPath+_+"/images/",y=k.lang(_+".");function C(e,i){var a;i.is_dir?e.attr("title",i.filename):e.attr("title",(a=i.filename,e=i.filesize,i=i.datetime,a+" ("+Math.ceil(e/1024)+"KB, "+i+")"))}k.plugin.filemanagerDialog=function(e){var i=g.undef(e.width,650),a=g.undef(e.height,510),n=g.undef(e.dirName,""),l=g.undef(e.viewType,"VIEW").toUpperCase(),o=e.clickFn,e=['<div style="padding:10px 20px;">','<div class="ke-plugin-filemanager-header">','<div class="ke-left">','<img class="ke-inline-block" name="moveupImg" src="'+w+'go-up.gif" width="16" height="16" border="0" alt="" /> ','<a class="ke-inline-block" name="moveupLink" href="javascript:;">'+y.moveup+"</a>","</div>",'<div class="ke-right">',y.viewType+' <select class="ke-inline-block" name="viewType">','<option value="VIEW">'+y.viewImage+"</option>",'<option value="LIST">'+y.listImage+"</option>","</select> ",y.orderType+' <select class="ke-inline-block" name="orderType">','<option value="NAME">'+y.fileName+"</option>",'<option value="SIZE">'+y.fileSize+"</option>",'<option value="TYPE">'+y.fileType+"</option>","</select>","</div>",'<div class="ke-clearfix"></div>',"</div>",'<div class="ke-plugin-filemanager-body"></div>',"</div>"].join(""),t=k.createDialog({name:_,width:i,height:a,title:k.lang(_),body:e}),e=t.div,s=g(".ke-plugin-filemanager-body",e),r=(g('[name="moveupImg"]',e),g('[name="moveupLink"]',e)),d=(g('[name="viewServer"]',e),g('[name="viewType"]',e)),c=g('[name="orderType"]',e);function m(e,i,a){i="path="+e+"&order="+i+"&dir="+n;t.showLoading(k.lang("ajaxLoading")),g.ajax(g.addParam(b,i+"&"+(new Date).getTime()),function(e){t.hideLoading(),a(e)})}var p=[];function f(e,i,a,n){var l=g.formatUrl(i.current_url+a.filename,"absolute"),t=encodeURIComponent(i.current_dir_path+a.filename+"/");a.is_dir?e.click(function(e){m(t,c.val(),n)}):a.is_photo?e.click(function(e){o.call(this,l,a.filename)}):e.click(function(e){o.call(this,l,a.filename)}),p.push(e)}function u(i,a){function e(){"VIEW"==d.val()?m(i.current_dir_path,c.val(),h):m(i.current_dir_path,c.val(),v)}g.each(p,function(){this.unbind()}),r.unbind(),d.unbind(),c.unbind(),i.current_dir_path&&r.click(function(e){m(i.moveup_dir_path,c.val(),a)}),d.change(e),c.change(e),s.html("")}function v(e){u(e,v);var i=document.createElement("table");i.className="ke-table",i.cellPadding=0,i.cellSpacing=0,i.border=0,s.append(i);for(var a=e.file_list,n=0,l=a.length;n<l;n++){var t=a[n],o=g(i.insertRow(n));o.mouseover(function(e){g(this).addClass("ke-on")}).mouseout(function(e){g(this).removeClass("ke-on")});var r=w+(t.is_dir?"folder-16.gif":"file-16.gif"),r=g('<img src="'+r+'" width="16" height="16" alt="'+t.filename+'" align="absmiddle" />'),r=g(o[0].insertCell(0)).addClass("ke-cell ke-name").append(r).append(document.createTextNode(" "+t.filename));!t.is_dir||t.has_file?(o.css("cursor","pointer"),r.attr("title",t.filename),f(r,e,t,v)):r.attr("title",y.emptyFolder),g(o[0].insertCell(1)).addClass("ke-cell ke-size").html(t.is_dir?"-":Math.ceil(t.filesize/1024)+"KB"),g(o[0].insertCell(2)).addClass("ke-cell ke-datetime").html(t.datetime)}}function h(e){u(e,h);for(var i=e.file_list,a=0,n=i.length;a<n;a++){var l=i[a],t=g('<div class="ke-inline-block ke-item"></div>');s.append(t);var o=g('<div class="ke-inline-block ke-photo"></div>').mouseover(function(e){g(this).addClass("ke-on")}).mouseout(function(e){g(this).removeClass("ke-on")});t.append(o);var r=e.current_url+l.filename,r=l.is_dir?w+"folder-64.gif":l.is_photo?r:w+"file-64.gif",r=g('<img src="'+r+'" width="80" height="80" alt="'+l.filename+'" />');!l.is_dir||l.has_file?(o.css("cursor","pointer"),C(o,l),f(o,e,l,h)):o.attr("title",y.emptyFolder),o.append(r),t.append('<div class="ke-name" title="'+l.filename+'">'+l.filename+"</div>")}}return d.val(l),m("",c.val(),"VIEW"==l?h:v),t}});