KindEditor.plugin("table",function(I){var R=this,o="table",n=R.lang(o+"."),$="ke-zeroborder";function a(e,l){l=l.toUpperCase(),e.css("background-color",l),e.css("color","#000000"===l?"#FFFFFF":"#000000"),e.html(l)}var i=[];function r(o,e){function n(){I.each(i,function(){this.remove()}),i=[],I(document).unbind("click,mousedown",n),o.unbind("click,mousedown",n)}e.bind("click,mousedown",function(e){e.stopPropagation()}),e.click(function(e){n();var l=I(this),t=l.pos(),t=I.colorpicker({x:t.x,y:t.y+l.height(),z:811214,selectedColor:I(this).html(),colors:R.colorTable,noColor:R.lang("noColor"),shadowMode:R.shadowMode,click:function(e){a(l,e),n()}});i.push(t),I(document).bind("click,mousedown",n),o.bind("click,mousedown",n)})}function d(e,l,t){for(var o=0,n=0,a=l.cells.length;n<a&&l.cells[n]!=t;n++)o+=l.cells[n].rowSpan-1;return t.cellIndex-o}R.plugin.table={prop:function(e){var l,m,t=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keRows" style="width:90px;">'+n.cells+"</label>",n.rows+' <input type="text" id="keRows" class="ke-input-text ke-input-number" name="rows" value="" maxlength="4" /> &nbsp; ',n.cols+' <input type="text" class="ke-input-text ke-input-number" name="cols" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+n.size+"</label>",n.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+n.percent+"</option>",'<option value="px">'+n.px+"</option>","</select> &nbsp; ",n.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+n.percent+"</option>",'<option value="px">'+n.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="kePadding" style="width:90px;">'+n.space+"</label>",n.padding+' <input type="text" id="kePadding" class="ke-input-text ke-input-number" name="padding" value="" maxlength="4" /> &nbsp; ',n.spacing+' <input type="text" class="ke-input-text ke-input-number" name="spacing" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+n.align+"</label>",'<select id="keAlign" name="align">','<option value="">'+n.alignDefault+"</option>",'<option value="left">'+n.alignLeft+"</option>",'<option value="center">'+n.alignCenter+"</option>",'<option value="right">'+n.alignRight+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+n.border+"</label>",n.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',n.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+n.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),t=R.createDialog({name:o,width:500,title:R.lang(o),body:t,beforeRemove:function(){A.unbind()},yesBtn:{name:R.lang("yes"),click:function(){var e=b.val(),l=w.val(),t=k.val(),o=f.val(),n=x.val(),a=S.val(),i=y.val(),r=C.val(),c=T.val(),d=B.val(),s=I(A[0]).html()||"",p=I(A[1]).html()||"";if(0!=e&&/^\d+$/.test(e))if(0!=l&&/^\d+$/.test(l))if(/^\d*$/.test(t))if(/^\d*$/.test(o))if(/^\d*$/.test(i))if(/^\d*$/.test(r))if(/^\d*$/.test(d)){if(m)return""!==t?m.width(t+n):m.css("width",""),void 0!==m[0].width&&m.removeAttr("width"),""!==o?m.height(o+a):m.css("height",""),void 0!==m[0].height&&m.removeAttr("height"),m.css("background-color",p),void 0!==m[0].bgColor&&m.removeAttr("bgColor"),""!==i?m[0].cellPadding=i:m.removeAttr("cellPadding"),""!==r?m[0].cellSpacing=r:m.removeAttr("cellSpacing"),""!==c?m[0].align=c:m.removeAttr("align"),""!==d?m.attr("border",d):m.removeAttr("border"),""===d||"0"===d?m.addClass($):m.removeClass($),""!==s?m.attr("borderColor",s):m.removeAttr("borderColor"),void R.hideDialog().focus();var g="";""!==t&&(g+="width:"+t+n+";"),""!==o&&(g+="height:"+o+a+";"),""!==p&&(g+="background-color:"+p+";");var u="<table";""!==g&&(u+=' style="'+g+'"'),""!==i&&(u+=' cellpadding="'+i+'"'),""!==r&&(u+=' cellspacing="'+r+'"'),""!==c&&(u+=' align="'+c+'"'),""!==d&&(u+=' border="'+d+'"'),""!==d&&"0"!==d||(u+=' class="'+$+'"'),""!==s&&(u+=' bordercolor="'+s+'"'),u+=">";for(var v=0;v<e;v++){u+="<tr>";for(var h=0;h<l;h++)u+="<td>"+(I.IE?"&nbsp;":"<br />")+"</td>";u+="</tr>"}u+="</table>",I.IE||(u+="<br />"),R.insertHtml(u),R.select().hideDialog().focus(),R.addBookmark()}else B[0].focus();else C[0].focus();else y[0].focus();else f[0].focus();else k[0].focus();else w[0].focus();else b[0].focus()}}}).div,b=I('[name="rows"]',t).val(3),w=I('[name="cols"]',t).val(2),k=I('[name="width"]',t).val(100),f=I('[name="height"]',t),x=I('[name="widthType"]',t),S=I('[name="heightType"]',t),y=I('[name="padding"]',t).val(2),C=I('[name="spacing"]',t).val(0),T=I('[name="align"]',t),B=I('[name="border"]',t).val(1),A=I(".ke-input-color",t);r(t,A.eq(0)),r(t,A.eq(1)),a(A.eq(0),"#000000"),a(A.eq(1),""),b[0].focus(),b[0].select(),e||(m=R.plugin.getSelectedTable())&&(b.val(m[0].rows.length),w.val(0<m[0].rows.length?m[0].rows[0].cells.length:0),b.attr("disabled",!0),w.attr("disabled",!0),t=m[0].style.width||m[0].width,e=m[0].style.height||m[0].height,void 0!==t&&(l=/^(\d+)((?:px|%)*)$/.exec(t))?(k.val(l[1]),x.val(l[2])):k.val(""),void 0!==e&&(l=/^(\d+)((?:px|%)*)$/.exec(e))&&(f.val(l[1]),S.val(l[2])),y.val(m[0].cellPadding||""),C.val(m[0].cellSpacing||""),T.val(m[0].align||""),B.val(void 0===m[0].border?"":m[0].border),a(A.eq(0),I.toHex(m.attr("borderColor")||"")),a(A.eq(1),I.toHex(m[0].style.backgroundColor||m[0].bgColor||"")),k[0].focus(),k[0].select())},cellprop:function(){var e=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+n.size+"</label>",n.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+n.percent+"</option>",'<option value="px">'+n.px+"</option>","</select> &nbsp; ",n.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+n.percent+"</option>",'<option value="px">'+n.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+n.align+"</label>",n.textAlign+' <select id="keAlign" name="textAlign">','<option value="">'+n.alignDefault+"</option>",'<option value="left">'+n.alignLeft+"</option>",'<option value="center">'+n.alignCenter+"</option>",'<option value="right">'+n.alignRight+"</option>","</select> ",n.verticalAlign+' <select name="verticalAlign">','<option value="">'+n.alignDefault+"</option>",'<option value="top">'+n.alignTop+"</option>",'<option value="middle">'+n.alignMiddle+"</option>",'<option value="bottom">'+n.alignBottom+"</option>",'<option value="baseline">'+n.alignBaseline+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+n.border+"</label>",n.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',n.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+n.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join(""),l=R.createDialog({name:o,width:500,title:R.lang("tablecell"),body:e,beforeRemove:function(){w.unbind()},yesBtn:{name:R.lang("yes"),click:function(){var e=d.val(),l=s.val(),t=p.val(),o=g.val(),n=(u.val(),v.val(),h.val()),a=m.val(),i=b.val(),r=I(w[0]).html()||"",c=I(w[1]).html()||"";/^\d*$/.test(e)?/^\d*$/.test(l)?/^\d*$/.test(i)?(k.css({width:""!==e?e+t:"",height:""!==l?l+o:"","background-color":c,"text-align":n,"vertical-align":a,"border-width":i,"border-style":""!==i?"solid":"","border-color":r}),R.hideDialog().focus(),R.addBookmark()):b[0].focus():s[0].focus():d[0].focus()}}}).div,d=I('[name="width"]',l).val(100),s=I('[name="height"]',l),p=I('[name="widthType"]',l),g=I('[name="heightType"]',l),u=I('[name="padding"]',l).val(2),v=I('[name="spacing"]',l).val(0),h=I('[name="textAlign"]',l),m=I('[name="verticalAlign"]',l),b=I('[name="border"]',l).val(1),w=I(".ke-input-color",l);r(l,w.eq(0)),r(l,w.eq(1)),a(w.eq(0),"#000000"),a(w.eq(1),""),d[0].focus(),d[0].select();var k=R.plugin.getSelectedCell(),e=k[0].style.width||k[0].width||"",l=k[0].style.height||k[0].height||"";(e=/^(\d+)((?:px|%)*)$/.exec(e))?(d.val(e[1]),p.val(e[2])):d.val(""),(e=/^(\d+)((?:px|%)*)$/.exec(l))&&(s.val(e[1]),g.val(e[2])),h.val(k[0].style.textAlign||""),m.val(k[0].style.verticalAlign||"");e=(e=k[0].style.borderWidth||"")&&parseInt(e);b.val(e),a(w.eq(0),I.toHex(k[0].style.borderColor||"")),a(w.eq(1),I.toHex(k[0].style.backgroundColor||"")),d[0].focus(),d[0].select()},insert:function(){this.prop(!0)},delete:function(){var e=R.plugin.getSelectedTable();R.cmd.range.setStartBefore(e[0]).collapse(!0),R.cmd.select(),e.remove(),R.addBookmark()},colinsert:function(e){var l=R.plugin.getSelectedTable()[0],t=R.plugin.getSelectedRow()[0],o=R.plugin.getSelectedCell()[0],n=o.cellIndex+e;n+=l.rows[0].cells.length-t.cells.length;for(var a=0,i=l.rows.length;a<i;a++){var r=l.rows[a],c=r.insertCell(n);c.innerHTML=I.IE?"":"<br />",n=d(0,r,c)}R.cmd.range.selectNodeContents(o).collapse(!0),R.cmd.select(),R.addBookmark()},colinsertleft:function(){this.colinsert(0)},colinsertright:function(){this.colinsert(1)},rowinsert:function(e){var l=R.plugin.getSelectedTable()[0],t=R.plugin.getSelectedRow()[0],o=R.plugin.getSelectedCell()[0],n=t.rowIndex;1===e&&(n=t.rowIndex+(o.rowSpan-1)+e);for(var a=l.insertRow(n),i=0,r=t.cells.length;i<r;i++){1<t.cells[i].rowSpan&&(r-=t.cells[i].rowSpan-1);var c=a.insertCell(i);1===e&&1<t.cells[i].colSpan&&(c.colSpan=t.cells[i].colSpan),c.innerHTML=I.IE?"":"<br />"}for(var d=n;0<=d;d--){var s=l.rows[d].cells;if(s.length>i){for(var p=o.cellIndex;0<=p;p--)1<s[p].rowSpan&&(s[p].rowSpan+=1);break}}R.cmd.range.selectNodeContents(o).collapse(!0),R.cmd.select(),R.addBookmark()},rowinsertabove:function(){this.rowinsert(0)},rowinsertbelow:function(){this.rowinsert(1)},rowmerge:function(){var e=R.plugin.getSelectedTable()[0],l=R.plugin.getSelectedRow()[0],t=R.plugin.getSelectedCell()[0],o=l.rowIndex+t.rowSpan,n=e.rows[o];e.rows.length<=o||(o=d(0,l,t),n.cells.length<=o||(l=n.cells[o],t.colSpan===l.colSpan&&(t.rowSpan+=l.rowSpan,n.deleteCell(o),R.cmd.range.selectNodeContents(t).collapse(!0),R.cmd.select(),R.addBookmark())))},colmerge:function(){R.plugin.getSelectedTable()[0];var e,l=R.plugin.getSelectedRow()[0],t=R.plugin.getSelectedCell()[0],o=(l.rowIndex,t.cellIndex+1);l.cells.length<=o||(e=l.cells[o],t.rowSpan===e.rowSpan&&(t.colSpan+=e.colSpan,l.deleteCell(o),R.cmd.range.selectNodeContents(t).collapse(!0),R.cmd.select(),R.addBookmark()))},rowsplit:function(){var e=R.plugin.getSelectedTable()[0],l=R.plugin.getSelectedRow()[0],t=R.plugin.getSelectedCell()[0],o=l.rowIndex;if(1!==t.rowSpan){for(var n=d(0,l,t),a=1,i=t.rowSpan;a<i;a++){var r=e.rows[o+a],c=r.insertCell(n);1<t.colSpan&&(c.colSpan=t.colSpan),c.innerHTML=I.IE?"":"<br />",n=d(0,r,c)}I(t).removeAttr("rowSpan"),R.cmd.range.selectNodeContents(t).collapse(!0),R.cmd.select(),R.addBookmark()}},colsplit:function(){R.plugin.getSelectedTable()[0];var e=R.plugin.getSelectedRow()[0],l=R.plugin.getSelectedCell()[0],t=l.cellIndex;if(1!==l.colSpan){for(var o=1,n=l.colSpan;o<n;o++){var a=e.insertCell(t+o);1<l.rowSpan&&(a.rowSpan=l.rowSpan),a.innerHTML=I.IE?"":"<br />"}I(l).removeAttr("colSpan"),R.cmd.range.selectNodeContents(l).collapse(!0),R.cmd.select(),R.addBookmark()}},coldelete:function(){for(var e=R.plugin.getSelectedTable()[0],l=R.plugin.getSelectedRow()[0],t=R.plugin.getSelectedCell()[0].cellIndex,o=0,n=e.rows.length;o<n;o++){var a=e.rows[o],i=a.cells[t];1<i.colSpan?(--i.colSpan,1===i.colSpan&&I(i).removeAttr("colSpan")):a.deleteCell(t),1<i.rowSpan&&(o+=i.rowSpan-1)}0===l.cells.length?(R.cmd.range.setStartBefore(e).collapse(!0),R.cmd.select(),I(e).remove()):R.cmd.selection(!0),R.addBookmark()},rowdelete:function(){for(var e=R.plugin.getSelectedTable()[0],l=R.plugin.getSelectedRow()[0],t=R.plugin.getSelectedCell()[0],o=l.rowIndex,n=t.rowSpan-1;0<=n;n--)e.deleteRow(o+n);0===e.rows.length?(R.cmd.range.setStartBefore(e).collapse(!0),R.cmd.select(),I(e).remove()):R.cmd.selection(!0),R.addBookmark()}},R.clickToolbar(o,R.plugin.table.prop)});