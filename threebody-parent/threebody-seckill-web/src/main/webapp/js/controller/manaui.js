var UI={init:function(){var e,t,i,o;vipUpgradePos="topright",networkTimer=null,offlineMask=!1,openCloudApiSupport=!1,"wpsyun"==deviceType&&($("#btn_export").hide(),$("#btnimport1").hide(),$("#flow-file_btn").hide(),$("#save-wps-topbtn").css("visibility","hidden"),$('li[tit="feedback"]').hide(),$(".yunhide").hide()),$("#menu-item-openwpscloud").hide(),window.openCloudCallback=function(e){if(JSON.parse(e).result)return openCloudApiSupport=!0,$("#menu-item-openwpscloud").show(),void $("#tip-link-cloud").show();$("#menu-item-openwpscloud").hide(),$("#tip-link-cloud").hide()},Utils.testVipState(function(){CLB.collaStart()}),"wpsclient_mac"==deviceType&&($('.file_menu-item[tit="quick_open"]').hide(),$('li[tit="feedback"]').hide(),e=$("[title]"),$.each(e,function(e,t){var i=$(t).attr("title");-1<i.indexOf("Ctrl")&&(i=i.replace("Ctrl","Cmd"),$(t).attr("title",i)),i=null}),t=$(".extend"),$.each(t,function(e,t){var i=$(t).text();-1<i.indexOf("Ctrl")&&(i=i.replace("Ctrl","Cmd"),$(t).text(i)),i=null}),i=$(".hotkey"),$.each(i,function(e,t){var i=$(t).text();-1<i.indexOf("Ctrl")&&(i=i.replace("Ctrl","Cmd"),$(t).text(i)),i=null}),o=$(".hotkey_desc"),$.each(o,function(e,t){var i=$(t).html();-1<i.indexOf("Ctrl")&&(i=i.replace("Ctrl","Cmd"),$(t).html(i)),i=null}),$('.menu.list [tit="pom"]').hide(),$('.menu.list [ac="pom"]').hide()),window.userTypeChangeInit=function(e){var t=JSON.parse(e).result;t&&(wpsVipInit(t),UI.setTopUpgradeBtnB())},$(".checkbox-con").off("click").on("click",function(){$(this).children(".check-box").toggleClass("checked")}),$(".diagram_title").bind("click",function(){var e;$(this).hasClass("readonly")||(e=$.trim($(this).text()),$(this).hide(),$("#title_container").append("<input type='text' style='margin-top:0'/>"),$("#title_container").children("input").val(e).select(),$("#title_container").children("input").bind("blur",function(){var e=$.trim($(this).val());UI.changeTitle(e)}).bind("keydown",function(e){var t;60<$.trim($(this).val()).length&&$(this).val($.trim($(this).val()).substring(0,60)),13==e.keyCode&&(t=$.trim($(this).val()),UI.changeTitle(t))}))}),$(".header-op-item [tit],.header-op-item[tit]").on("click",function(e){e.stopPropagation();var t,i,o,n=$(this);switch(n.attr("tit")){case"bar_undo":MessageSource.undo();break;case"bar_redo":MessageSource.redo();break;case"bar_brush":$("#bar_brush").button("isSelected")?($("#bar_brush").button("unselect"),$("#designer_op_help").hide(),$(document).unbind("keydown.cancelbrush"),Utils.selectCallback=null):Designer.clipboard.brush();break;case"mind_topic_insert":UI.showDropdown(n,$("#bar_list_insert"),function(e){var t=e.attr("tp");"insert_img"==t?(UI.showImageSelect(function(e,t,i){var o=Model.define.page,n=o.width-2*o.padding,a=o.height-2*o.padding,r=Math.max(t/n,i/a);1<r&&(t=Math.round(t/r),i=Math.round(i/r)),UI.insertImage(e,t,i)}),tdocCollect({opername:"flowchart",module:"insert",action:"image"})):"insert_link"==t&&(UI.showInsertLink(),tdocCollect({opername:"flowchart",module:"insert",action:"link"}))});break;case"bar_theme":UI.showThemeSelect();break;case"bar_page_color":var a=$("#bar_page_color").find(".color_line"),r=a.css("backgroundColor");$.colorpicker({target:$("#bar_page_color"),trans:!0,onSelect:function(e,t){Designer.setPageStyle({backgroundColor:e}),a.css("backgroundColor","rgb("+e+")"),tdocCollect({opername:"flowchart",module:"canvas",action:"color",ver5:t})},color:r,extend:'<div class="extend_item page_more"><span class="mind-icons">&#xe729;</span>更多画布设置<span class="mind-icons">&#xe613;</span></div>'}),$(".color_extend .page_more").unbind().bind("click",function(){$("#color_picker").dropdown("close"),UI.showDrawer($("#dock_view_page")),Dock.currentView="page",Dock.update(!0)});break;case"bar_font_family":UI.showDropdown(n,$("#font_list"),function(e){var t=e.text();Designer.setFontStyle({fontFamily:t}),$("#bar_font_family").children().eq(0).text(t),tdocCollect({opername:"flowchart",module:"text",action:"font",ver5:9<e.index()?e.index():e.index()+1})});var s=$("#bar_font_family span.data").text().trim();$("#font_list").children().each(function(){if($(this).text()==s)return $("#font_list").dropdown("select",$(this)),!1});break;case"bar_font_size":UI.showDropdown(n,$("#fontsize_list"),function(e){var t=e.text().replace("px","");Designer.setFontStyle({size:t}),$("#bar_font_size").children().eq(0).text(e.text()),tdocCollect({opername:"flowchart",module:"text",action:"size",ver5:e.index()+1})});s=$("#bar_font_size").children().eq(0).text().trim();$("#fontsize_list").children().each(function(){if($(this).text()==s)return $("#fontsize_list").dropdown("select",$(this)),!1});break;case"bar_font_bold":var l=!$("#bar_font_bold").button("isSelected");Designer.setFontStyle({bold:l}),$("#bar_font_bold").toggleClass("selected"),tdocCollect({opername:"flowchart",module:"text",action:"bold"});break;case"bar_font_italic":var d=!$("#bar_font_italic").button("isSelected");Designer.setFontStyle({italic:d}),$("#bar_font_italic").toggleClass("selected"),tdocCollect({opername:"flowchart",module:"text",action:"italic"});break;case"bar_font_underline":var c=!$("#bar_font_underline").button("isSelected");Designer.setFontStyle({underline:c}),$("#bar_font_underline").toggleClass("selected"),tdocCollect({opername:"flowchart",module:"text",action:"underscore"});break;case"bar_font_color":r=$("#bar_font_color").find(".color_line").css("backgroundColor");$.colorpicker({target:$("#bar_font_color"),onSelect:function(e,t){Designer.setFontStyle({color:e}),$("#bar_font_color").find(".color_line").css("backgroundColor","rgb("+e+")"),tdocCollect({opername:"flowchart",module:"text",action:"color",ver5:t})},color:r,trans:!1});break;case"bar_font_align":var p=n.attr("cate");$("#font_align_list li").hide(),$("#font_align_list li[cate="+p+"]").show(),UI.showDropdown(n,$("#font_align_list"),function(e){var t={};t[e.attr("cate")]=e.attr("al"),Designer.setFontStyle(t),tdocCollect({opername:"flowchart",module:"text",action:"align",ver5:e.index()+1})});break;case"bar_fill":r=$("#bar_fill").find(".color_line").css("backgroundColor");$.colorpicker({target:$("#bar_fill"),onSelect:function(e,t){Designer.setFillStyle({type:"solid",color:e}),$("#bar_fill").find(".color_line").css("backgroundColor","rgb("+e+")"),tdocCollect({opername:"flowchart",module:"shape",action:"filling",ver5:t})},color:r});break;case"bar_line_color":var u,r=$("#bar_line_color").find(".color_line").css("backgroundColor"),h=$(".line_style_list").prop("outerHTML"),g=$(".line_width_list").prop("outerHTML");$.colorpicker({target:$("#bar_line_color"),onSelect:function(e,t){Designer.setLineStyle({lineColor:e}),$("#bar_line_color").find(".color_line").css("backgroundColor","rgb("+e+")"),tdocCollect({opername:"flowchart",module:"shape",action:"frame",ver5:t})},color:r,trans:!1,extend:'<div class="extend_item"><span class="mind-icons">&#xe762;</span>类型<span class="mind-icons">&#xe613;</span>'+h+'</div><div class="extend_item"><span class="mind-icons">&#xe75a;</span>粗细<span class="mind-icons">&#xe613;</span>'+g+"</div>"});var _=(u="linker"==(v=Utils.getSelected()[0]).name?Utils.getLinkerLineStyle(v.lineStyle):Utils.getShapeLineStyle(v.lineStyle)).lineWidth;$(".extend_item .line_width_list").children().each(function(){parseInt($(this).attr("line"))==_&&$(".extend_item .line_width_list").dropdown("select",$(this))});var m=u.lineStyle,f=$(".extend_item .line_style_list").children("li[line="+m+"]");$(".extend_item .line_style_list").dropdown("select",f),$(".extend_item .line_style_list").off().on("click","li",function(){var e=$(this).attr("line");Designer.setLineStyle({lineStyle:e}),$("#color_picker").dropdown("close")}),$(".extend_item .line_width_list").off().on("click","li",function(){var e=parseInt($(this).text());Designer.setLineStyle({lineWidth:e}),$("#color_picker").dropdown("close")});break;case"bar_linkertype":UI.showDropdown(n,$("#line_type_list"),function(e){var t=e.attr("tp");Designer.setLinkerType(t);var i=e.children("span").attr("class");$("#bar_linkertype").children("span:eq(0)").attr("class",i).text("")});var v,b=(v=Utils.getSelected()[0]).linkerType,f=$("#line_type_list").children("li[tp="+b+"]");$("#line_type_list").dropdown("select",f);break;case"bar_beginarrow":UI.showDropdown(n,$("#beginarrow_list"),function(e){var t=e.attr("arrow");Designer.setLineStyle({beginArrowStyle:t});var i=e.children(".ico_arrow").attr("class");$("#bar_beginarrow").children("span:eq(0)").attr("class",i)});m=(u="linker"==(v=Utils.getSelected()[0]).name?Utils.getLinkerLineStyle(v.lineStyle):Utils.getShapeLineStyle(v.lineStyle)).beginArrowStyle,f=$("#beginarrow_list").children("li[arrow="+m+"]");$("#beginarrow_list").dropdown("select",f);break;case"bar_endarrow":UI.showDropdown(n,$("#endarrow_list"),function(e){var t=e.attr("arrow");Designer.setLineStyle({endArrowStyle:t});var i=e.children(".ico_arrow").attr("class");$("#bar_endarrow").children("span:eq(0)").attr("class",i)});m=(u="linker"==(v=Utils.getSelected()[0]).name?Utils.getLinkerLineStyle(v.lineStyle):Utils.getShapeLineStyle(v.lineStyle)).endArrowStyle,f=$("#endarrow_list").children("li[arrow="+m+"]");$("#endarrow_list").dropdown("select",f);break;case"bar_pos":UI.showDropdown(n,$("#bar_list_pos"),function(e){var t=e.attr("tp");"pos_forward"==t?Designer.layerShapes("forward"):"pos_backward"==t?Designer.layerShapes("backward"):"bar_front"==t?Designer.layerShapes("front"):"bar_back"==t&&Designer.layerShapes("back")});break;case"bar_routate":$(e.target).hasClass("down")?UI.showDropdown(n,$("#bar_list_routate"),function(e){var t,i,o,n=e.attr("tp");"pos_routate_90"==n?(t=Utils.getSelected()[0],o=(i=Math.round(t.props.angle/Math.PI*180)%360)-90<0?270+i:i-90,Designer.setShapeProps({angle:o/180*Math.PI}),tdocCollect({opername:"flowchart",module:"shape",action:"spin"})):"pos_more"==n&&(UI.showDrawer($("#dock_view_pos")),Dock.currentView="metric",Dock.update(!0),tdocCollect({opername:"flowchart",module:"shape",action:"more"}))}):(v=Utils.getSelected()[0],i=(t=Math.round(v.props.angle/Math.PI*180)%360)-90<0?270+t:t-90,Designer.setShapeProps({angle:i/180*Math.PI}),tdocCollect({opername:"flowchart",module:"shape",action:"spin"}));break;case"bar_align":UI.showDropdown(n,$("#bar_list_align"),function(e){V(e),tdocCollect({opername:"flowchart",module:"shape",action:"align",ver5:6<e.index()?e.index()-1:3<e.index()?e.index():e.index()+1})});break;case"bar_group_set":UI.showDropdown(n,$("#bar_list_group"),function(e){var t=e.attr("tp");"bar_group"==t?Designer.group():"bar_ungroup"==t&&Designer.ungroup()});break;case"arrange_match":UI.showDropdown(n,$("#bar_list_match"),function(e){V(e),tdocCollect({opername:"flowchart",module:"shape",action:"match_size",ver5:e.index()+1})});break;case"hotkey":UI.showHotKey();break;case"getting_started":UI.gettingStart();break;case"feedback":UI.showFeedBack();break;case"dock_btn_navigator":$(".dock_view_navigator").is(":visible")?(n.removeClass("selected").attr("original-title","显示视图导航"),$("#hover_tip:visible").find(".tip_content").html("显示视图导航"),$(".dock_view").hide(),CLB.setConfig("dock","none")):(n.addClass("selected").attr("original-title","关闭视图导航"),$("#hover_tip:visible").find(".tip_content").html("关闭视图导航"),$(".dock_view_navigator").show(),Dock.update(!0),CLB.setConfig("dock","navigator"));break;case"zoomout":Designer.zoomOut();break;case"zoomin":Designer.zoomIn();break;case"zoomreset":var w=$("#bar_list_view");UI.showDropdown(n,$("#bar_list_view"),function(e){var t,i=e.attr("zoom");"reset"==i?Designer.setZoomScale(1):(t=parseFloat(i),Designer.setZoomScale(t))},"center","top");var y=w.children(".static[zoom='"+Designer.config.scale+"']");y.length&&(w.children(".static[zoom]").menuitem("unselect"),y.menuitem("select"));break;case"full_screen":n.hasClass("open")?Dock.exitFullScreen():Dock.enterFullScreen();break;case"bar_watermark":Model.define.page.watermark||""?$("#bar_list_watermark li[tp=mind_watermark_del]").removeAttr("original-title").removeClass("disabled"):$("#bar_list_watermark li[tp=mind_watermark_del]").attr("original-title","暂无可删除的水印").addClass("disabled"),UI.showDropdown(n,$("#bar_list_watermark"),function(e){var t=e.attr("tp");"mind_watermark_set"==t&&($("#watermark-dlg").dlg({onClose:function(){$("#svg-view-wrap").html("")}}),UI.waterMark.init()),"mind_watermark_del"!=t||e.hasClass("mind-disable1")||(Designer.setPageStyle({watermark:""}),UI.showTip("已删除水印"),setTimeout(function(){UI.hideTip()},5e3))});break;case"bar_lock":Designer.lockShapes();break;case"bar_unlock":Designer.unlockShapes();break;case"bar_page_size":UI.showDropdown(n,$("#bar_list_pagesize"),function(e){var t=parseInt(e.attr("w")),i=parseInt(e.attr("h"));Designer.setPageStyle({width:t,height:i})}),Model.define.page.width&&Model.define.page.height&&(f=(o=$("#bar_list_pagesize")).children("li[w="+Model.define.page.width+"][h="+Model.define.page.height+"]"),o.children().menuitem("unselect"),f.menuitem("select"));break;case"bar_page_orientation":var k=$("#bar_list_orientation");UI.showDropdown(n,$("#bar_list_orientation"),function(e){var t=e.attr("ori");Designer.setPageStyle({orientation:t})});var x="portrait";Model.define.page.orientation&&(x=Model.define.page.orientation);var S=k.children("li[ori="+x+"]");k.children().menuitem("unselect"),S.menuitem("select");break;case"bar_page_jumps":var I=$("#bar_list_jumps");UI.showDropdown(n,$("#bar_list_jumps"),function(e){var t="true"==(t=e.attr("jumps"));Designer.setPageStyle({lineJumps:t}),Designer.events.push("resetBrokenLinker",!t)});var C=!1;Model.define.page.lineJumps&&(C=Model.define.page.lineJumps);var D=I.children("li[jumps="+C+"]");I.children().menuitem("unselect"),D.menuitem("select");break;case"bar_page_padding":var T=$("#bar_list_padding");UI.showDropdown(n,$("#bar_list_padding"),function(e){var t=parseInt(e.attr("p"));Designer.setPageStyle({padding:t})});var U="20";Model.define.page.orientation&&(U=Model.define.page.padding);var P=T.children("li[p="+U+"]");T.children().menuitem("unselect"),P.menuitem("select");break;case"bar_page_gridsize":var M=$("#bar_list_gridsize");UI.showDropdown(n,$("#bar_list_gridsize"),function(e){var t=parseInt(e.attr("s"));0==t?Designer.setPageStyle({showGrid:!1}):(Designer.setPageStyle({showGrid:!0}),Designer.setPageStyle({gridSize:t}))});var A="15",L=!0;null!=Model.define.page.showGrid&&(L=Model.define.page.showGrid),Model.define.page.gridSize&&(A=Model.define.page.gridSize),M.children().menuitem("unselect");(L?M.children("li[s="+A+"]"):M.children("li[s='0']")).menuitem("select")}}),$("#flow-file_btn").button({onClick:function(e){e.stopPropagation();var t=$("#flow-file_btn"),i=$("#flow_file_menu");UI.showDropdown(t,i,function(e){var i,o,t,n=e.attr("tit");"rename"==n?(i=$("#dlg_rename"),o=$("#file_new_title"),i.dlg(),o.val(document.title).focus(),$("#btn_rename_cancel").off("click").on("click",function(e){i.dlg("close")}),$("#btn_submit_rename").unbind("click").bind("click",function(e){var t=o.val();if(""==$.trim(t))return o.focus(),$("#tip_result").html("文件名不能为空").show(),void setTimeout(function(){$("#tip_result").hide()},1500);if(/[`~!@#\$%\^\&\*\+<>\?:"\{\}\\\/;'\[\]]/im.test(t))return o.focus(),$("#tip_result").html("文件名称不允许出现特殊字符").show(),void setTimeout(function(){$("#tip_result").hide()},1500);if(!o.attr("submitting")){if($.trim(t)==document.title)return o.removeAttr("submitting"),void i.dlg("close");$("#tip_result").html("正在提交……").show();t.indexOf(".pom"),o.attr("submitting","true"),setTimeout(function(){o.removeAttr("submitting")},2e3)}}),t=0,o.on("compositionstart",function(e){t=1}),o.on("compositionend",function(e){"undefined"!=typeof comPinyinEnd&&clearTimeout(comPinyinEnd),comPinyinEnd=setTimeout(function(){t=0},100)}),o.off("keydown").on("keydown",function(e){if(13==e.keyCode){if(1==t)return void(t=0);$("#btn_submit_rename").trigger("click")}e.stopPropagation()})):"import"==n&&UI.showImport()})}}),$("#drop-menu-download").off("click").on("click","li",function(e){e.stopPropagation();var t=$(this).attr("tit");if(!t)return!1;UI.exportFile.handle(t)}),$("#header-help-icon").off("click").on("click",function(){var e,t,i,o;$("#right-help-con");$("#right-help-con").is(":visible")?smartAiHelpCon.close():(e="<div id='extra-box' style='margin-top:12px'><ul class='op-menu-list'><li tit= 'shortcut'><span class='mind-icons'>&#xe69e;</span>快捷键说明</li><li tit= 'guide'><span class='mind-icons'>&#xe6a4;</span>新用户指引</li><li tit= 'mind_book'><span class='mind-icons'>&#xe69f;</span>详细使用手册</li>"+("wpsclient_mac"==deviceType||"wpsclient"==deviceType?"<li tit= 'feedback'><span class='mind-icons'>&#xe67c;</span>意见反馈</li>":"")+"<li tit= 'privilege'><span class='mind-icons'>&#xe6a6;</span>会员特权说明</li>"+("undefined"==typeof upgradeLog?"":"<li tit= 'upLog'><span class='mind-icons'>&#xe77f;</span>更新日志</li></ul>")+"</div>",t=$("#designer_header"),i=$(document).outerHeight()-t.outerHeight(),o=t.outerHeight()+1,$("#right-help-con").length<1?smartAiHelpCon.init({height:i,top:o,designerType:0,channel:1,subUnit:[e]}):smartAiHelpCon.spread(),$("#extra-box").off("mousedown.power").on("mousedown.power","li[tit]",function(){var e=$(this).attr("tit");if(smartAiHelpCon.close(),e)switch(e){case"shortcut":UI.showHotKey();break;case"guide":UI.gettingStart();break;case"mind_book":window.open("/support");break;case"feedback":UI.showFeedBack();break;case"privilege":$("#top-wps-dif-btn").trigger("mousedown");break;case"upLog":window.open("https://kdocs.cn/l/seEiH2mxZ?f=501")}}),$("#right-help-con").off("click.help-pin").on("click.help-pin",".res-temp",function(e){var t=$(this);!function(e,t,i){if(t||i)return smartAiHelpCon.tutorial(e,t,i);var o=$("[tit="+e+"]");if(o.length<1)return;var n="center";o.parents("div[tit=edit]").length?s("edit",o):o.parents("div[tit=pos]").length?s("pos",o):o.parents("div[tit=canvas]").length?s("canvas",o):o.parents("#mind_file_menu").length&&"none"==$("#mind_file_menu").css("display")&&(n="left",$("#mind_file_btn").trigger("click"));var a=$("#header-op-container").outerWidth(),r=o.offset().left;$("#fold-headerop-btn").hasClass("opened")||$("#fold-headerop-btn").trigger("click");r<70||r+o.outerWidth()>a?setTimeout(function(){l(e)},330):l(e);function s(e,t){var i=$(".header-center span[tit="+e+"]"),o=$("#header-op-container > [tit="+e+"]");i.addClass("active").siblings().removeClass("active"),o.css("display","flex").siblings().hide();var n=$("#header-op-container").outerWidth(),a=t.offset().left;(a<70||a+t.outerWidth()>n)&&$("#head-slither").trigger("click")}function l(e){smartAiHelpCon.drawingPin(o,n),"dock_btn_navigator"!=e&&"dock_btn_graphic"!=e&&"dock_btn_metric"!=e&&"dock_btn_attribute"!=e&&"dock_btn_page"!=e||smartAiHelpCon.close()}}(t.attr("tit")||t.text(),t.attr("desc")||"",t.attr("photoUrl")||""),e.stopPropagation()}),$("#header-op-container,#designer").off("mousedown.clsoeAi").on("mousedown.clsoeAi",function(e){smartAiHelpCon.close()}))});var n=$("#fold-headerop-btn");function V(e){var t,i,o,n,a,r,s,l,d,c,p=e.attr("ac");if("rename"==p)$(".diagram_title").trigger("click");else if("close"==p)window.location.href="/wps/diagrams";else if("image"==p)exportHDPDF("image");else if("pdfHD"==p)exportHDPDF("pdfHD");else if("pos"==p)exportHDPDF("pos");else if("new"==p)createNewChart("未命名文件","flow","");else if("export"==p){if($("#export_dialog").attr("key"))return $("#export_pdfHD").click(),void $("#export_ok").click();$("#export_dialog").dlg(),$("#export_png").click()}else{"undo"==p?MessageSource.undo():"redo"==p?MessageSource.redo():"cut"==p?Designer.clipboard.cut():"copy"==p?Designer.clipboard.copy():"paste"==p?Designer.clipboard.paste():"duplicate"==p?Designer.clipboard.duplicate():"brush"==p?Designer.clipboard.brush():"defaultStyle"==p?UI.setDefaultStyle(e):"selectall"==p?Designer.selectAll():"delete"==p?Designer.op.removeShape():"zoom"==p?"in"==(t=e.attr("zoom"))?Designer.zoomIn():"out"==t?Designer.zoomOut():(i=parseFloat(t),Designer.setZoomScale(i)):"insert"==p?"text"==(o=e.attr("in"))?Designer.op.changeState("creating_free_text"):"image"==o?UI.showImageSelect(function(e,t,i){UI.insertImage(e,t,i)}):"line"==o&&Designer.op.changeState("creating_free_linker"):"set_page_size"==p?(d=parseInt(e.attr("w")),c=parseInt(e.attr("h")),Designer.setPageStyle({width:d,height:c})):"set_page_padding"==p?(n=parseInt(e.attr("p")),Designer.setPageStyle({padding:n})):"set_page_orientation"==p?(a=e.attr("ori"),Designer.setPageStyle({orientation:a})):"set_page_showgrid"==p?e.menuitem("isSelected")?(e.menuitem("unselect"),Designer.setPageStyle({showGrid:!1})):(e.menuitem("select"),Designer.setPageStyle({showGrid:!0})):"set_page_gridsize"==p?(r=parseInt(e.attr("s")),Designer.setPageStyle({gridSize:r})):"front"==p?Designer.layerShapes("front"):"back"==p?Designer.layerShapes("back"):"forward"==p?Designer.layerShapes("forward"):"backward"==p?Designer.layerShapes("backward"):"align_shape"==p?(s=e.attr("al"),Designer.alignShapes(s)):"distribute_shape"==p?(l=e.attr("dis"),Designer.distributeShapes(l)):"match_size"==p?e.attr("custom")?Dock.showView("metric",!0):(l={},d=e.attr("w"),c=e.attr("h"),d&&(l.w=d),c&&(l.h=c),Designer.matchSize(l)):"lock"==p?Designer.lockShapes():"unlock"==p?Designer.unlockShapes():"group"==p?Designer.group():"ungroup"==p?Designer.ungroup():"hotkey"==p||("feedback"==p?UI.showFeedBack():"getting_started"==p&&UI.gettingStart())}}n.button({onClick:function(){var e=n;$("#header-op-container");e.hasClass("opened")?e.removeClass("opened"):e.removeClass("opened").addClass("opened")}}),$("#bar_beautify").button({onClick:function(){$("#bar_beautify").addClass("disabled");var e=Beautify.getBeautifyDefinition();0<e.updates.length&&(Model.updateWithBeautify(e.updates,e.content,e.theme),Utils.unselect(),UI.showTip("美化完成"),setTimeout(function(){UI.hideTip()},3e3)),$("#bar_beautify").removeClass("disabled")}}),$("#bar_collapse").button({onClick:function(){var e=UI.toogleTitleBar();CLB.setConfig("showToolbar",e)}}),$("[click-btn]").off("click").on("click",function(e){switch($(this).attr("click-btn")){case"clearStyle":Model.clearDefaultStyle(),UI.showTip("<@i18n resource='diagraming.defaultStyle.tip2'/>"),$(this).hide(),$("#bar_list_edit").hide(),setTimeout(function(){UI.hideTip()},1e3)}e.stopPropagation()});var a=$("#color_picker").html(),r=$("<div class='menu color_picker extend_menu'>"+a+"</div>").appendTo($("#bar_page_color"));r.css("right","-179px"),r.children(".color_items").children("div").unbind().bind("click",function(){var e=$(this).css("background-color");e=(e=e.replace(/\s/g,"")).substring(4,e.length-1),Designer.setPageStyle({backgroundColor:e}),$("#bar_list_page").dropdown("close")}),r.children(".color_items").children("div").off("mouseenter").on("mouseenter",function(){var e=(e=$(this).css("background-color")).replace(/\s/g,"");e=UI.RGB2Hex(e),r.children(".color_hex").find("input").val(e)}),r.children(".color_hex").find("input").off("keyup").on("keyup",function(){var e,t=$(this).val();3!=t.length&&6!=t.length||(e=UI.hex2RGB("#"+t),Designer.setPageStyle({backgroundColor:e}))}),r.children(".color_transparent").bind("click",function(){Designer.setPageStyle({backgroundColor:"transparent"}),$("#bar_list_page").dropdown("close")});var s,l,d=Model.define.page;"transparent"!=d.backgroundColor&&(s=d.backgroundColor,l=UI.RGB2Hex("rgb("+s+")"),r.children(".color_hex").find("input").val(l)),Designer.events.push("selectChanged",0),Designer.events.push("clipboardChanged",0),Designer.events.push("undoStackChanged",0),Designer.events.push("redoStackChanged",0),"network"==cateType&&($("#export_svg, #export_pdfHD").attr("disabled","true").disable(),$("#export_svg, #export_pdfHD").next().css({opacity:.4})),$(".switch-btn").off("click.switch").on("click.switch",function(e){e.stopPropagation();var t=$(this);Dock.switchCheck(t)}),$("#version-upgrade-btn").off("click").on("click",function(e){e.stopPropagation(),$("#apiSupport-error-dlg").dlg("close")}),$("#top-wps-dif-btn, .download-vip-dif-btn").off("mousedown.upgrade").on("mousedown.upgrade",function(e){upgradePosFlag="wps";var t=$(".vip-dlg");t.removeClass("vip3-dlg").addClass("vip3-dlg");var i=$(this).attr("id");vipUpgradePos="top-wps-dif-btn"==i?"top_contrast":"download_vip_contrast";var o=t.find("#dlg-wps-upgrade-btn");-1<tdocVipInfo.indexOf(40)?o.text("已开通，点击续费"):-1<tdocVipInfo.indexOf(12)||-1<tdocVipInfo.indexOf(20)?o.text("升级超级会员"):o.text("开通超级会员"),t.dlg({onClose:function(){t.removeClass("vip3-dlg")}})}),$(document).off("click.upgrade").on("click.upgrade"," #bot-nodevip-btn",function(e){var t,i,o;e.stopPropagation(),"bot-nodevip-btn"==$(this).attr("id")&&(type="leftdown_nodecout"),UI.upgradeVip(type),type&&"leftdown_nodecout"!=type&&(t="mind",i="node",-1<type.indexOf("download")&&(t="download",i=-1<type.indexOf("pnghd")?"PNG":-1<type.indexOf("pdf")?"PDF":-1<type.indexOf("jpg")?"JPG":-1<type.indexOf("pos")?"POS":""),-1<type.indexOf("pasteimg")&&(t="paste",i="screencut"),o=vipOrderPosition[type].replace("_po_","_act_"),tdocCollect({opername:t,module:i,action:o,ver5:2,ver6:""}))}),$("[title-tip]").live("mouseenter",function(){var e=$(this),t=$(this).attr("title-tip"),i=$("#title-tip");t&&(0==i.length&&(i=$('<div id="title-tip">'+t+"</div>").appendTo("body")),i.html(t).css({left:parseInt(e.offset().left+e.outerWidth()/2-i.outerWidth()/2),top:parseInt(e.offset().top+e.outerHeight()+14)}).show())}).live("mouseleave",function(){$("#title-tip").hide()}),poCollect("page_show",{page:"flow_editor",page_from:"",userId:userId,vip:tdoc_is_vip,povip:po_is_vip,device:deviceType})},topUpgradeBtnVal:"open",insertDocerImage:{params:{page:1,limit:15,keyword:"",tags:""},pageObj:{homePage:$("#docer-con"),searchPage:$("#docer-search-con")},insertPage:1,dataImages:{},imgUrl:"",loadList:!1,homeLimit:15,currentPage:"homePage",init:function(){var o=this,e=$("#img-docer-vip-btn");-1<tdocVipInfo.indexOf(40)||-1<tdocVipInfo.indexOf(12)?e.hide():e.show(),$(".insert_scroll").off("scroll").on("scroll",function(){var e=$(this).outerHeight(),t=$(this).scrollTop(),i=$(this).attr("place");if(!o.loadList)if("home"==i){if($("#docer-popular").height()+80+56-150<e+t){if(o.insertPage*o.homeLimit>=o.homeTotal)return;o.loadDocerImagelist("loadmore")}}else if($("#docer-search").height()-150<e+t){if(o.params.page*o.params.limit>=o.searchTotal)return;o.loaderSearchImage("loadmore")}});var n=$("#search-docer-img");$(".search-icon").off("click.search").on("click.search",function(e){e.stopPropagation();var t=$(this).siblings("input").val(),i=$(".docer-search-title").find("span");""!=t||""==o.params.keyword?o.params.keyword!=t&&(o.params.keyword=t,o.params.page=1,"homePage"==o.currentPage&&($("#docer-con").hide().siblings("#docer-search-con").show(),n.val(o.params.keyword)),$(".chart_image").removeClass("active"),$("#searchInsertImage").addClass("flow-disable"),o.currentPage="searchPage",i.text(o.params.keyword),o.loaderSearchImage()):$("#docer-search-con .search-img-del").trigger("click")}),$("#docer-search-con").off("").on("click.del",".search-img-del",function(e){e.stopPropagation();$(this);var t=$("#searchImg");$("#docer-popular");o.currentPage="homePage",o.params.keyword="",o.params.tags="",t.val(""),n.val(""),$(".chart_image").removeClass("active"),$("#searchInsertImage").addClass("flow-disable"),$("#docer-con").show().siblings("#docer-search-con").hide()}),$(".searchImg").off("keyup.search").on("keyup.search",function(e){13==e.keyCode&&$(this).siblings(".search-icon").trigger("click")}),$(".popular-con").off("click.label").on("click.label","li",function(e){e.stopPropagation();var t=$(this).text();$("#searchImg").val(t),$("#searchImg").siblings(".search-icon").trigger("click")}),$(".docer-image").off().on("click",".chart_image",function(e){e.stopPropagation(),$(".chart_image").removeClass("active"),$("#searchInsertImage").removeClass("flow-disable"),$(this).addClass("active")}),$("#docer-con").show().siblings("#docer-search-con").hide(),o.currentPage="homePage",$("#searchImg").val(""),$("#docer-popular").html(""),o.params.page=1,this.insertPage=1,o.params.keyword="",this.loadLabel(),this.loadDocerImagelist()},loadLabel:function(){$.ajax({url:"/docer/word_rec",success:function(e){var t=e.data.keyword,i=$("#popular-con"),o=["<ul>"];if(!(0<i.find("li").length)){for(var n=0;n<t.length&&!(7<n);n++)o.push("<li>"+t[n].word+"</li>");i.append(o.join("")+"</ul>")}},error:function(e){console.log(e)}})},docerLoding:!1,loadDocerImagelist:function(o){var n=$("#docer-popular"),a=this;$("#docer-con").find(".template-loading").show(),this.docerLoding||("loadmore"==o&&this.insertPage++,this.docerLoding=!0,$.ajax({url:"/docer/rec_pic",data:{page:a.insertPage,limit:a.homeLimit},success:function(e){a.docerLoding=!1;var t=e.data,i=t.total;if(i<1&&"firstload"==o)return $("#docer-con").find(".template-loading").hide(),void n.html("<div style='text-align:center;'><div style='margin-top:90px;color:#a0a0a0;'><span style='font-size:80px;' class='mind-icons'>&#xe746;</span><br><br>暂无推荐图片</div></div>");1==a.insertPage&&(a.dataImages=t),a.homeTotal=i,a.renderImageList(n,t,o)},error:function(e){a.docerLoding=!1,console.log(e)}}))},searchLoading:!1,loaderSearchImage:function(o){var n=$("#docer-search"),a=this;$("#docer-search-con").find(".template-loading").show(),this.searchLoading||("loadmore"==o&&this.params.page++,this.searchLoading=!0,$.ajax({url:"/docer/pic/search",data:this.params,success:function(e){a.searchLoading=!1;var t=e.data,i=t.total;if(i<1&&"loadmore"!=o)return $("#docer-search-con").find(".template-loading").hide(),void n.height("auto").html("<div style='text-align:center;'><div style='margin-top:125px;color:#a0a0a0;'><span style='font-size:80px;' class='mind-icons'>&#xe746;</span><br><br>未找到图片</div></div>");a.searchTotal=i,a.renderImageList(n,t,o)},error:function(e){a.searchLoading=!1,console.log(e)}}))},renderImageList:function(i,e,t){var i=i,o=this,n=e.list;o.loadList=!0,"loadmore"!=t&&i.html("");for(var a,r=0;r<n.length;r++){var s=3==n[r].moban_type?'<div class="docer_image"><img src="/assets/images/svip_icon_new.svg"/></div>':'<div class="docer_image"><img src="/assets/images/vip_free_icon.svg"/></div>',l=$('<div class="chart_image" style="visibility: hidden;" mobantype = "'+n[r].moban_type+'" id="'+n[r].id+'"><img class="insert_image" src="'+n[r].thumb_big_url+'" alt="图片加载失败" />'+s+'<span class="img_mask"></span></div>');i.append(l)}var d=!0;!function e(t){i.find(".chart_image img").each(function(){if(0===this.height)return d=!1});d?(clearTimeout(a),t()):(d=!0,a=setTimeout(function(){e(t)},500))}(function(){$(".template-loading").hide(),o.waterfall(i),o.loadList=!1})},waterfall:function(e){var r=e.find(".chart_image"),s=r.eq(0).outerWidth(),l=Math.floor(e.width()/s),d=(e.width()-s*l)/2-2,c=parseInt(e.css("marginTop")),p=[];r.each(function(e,t){var i,o,n,a=r.eq(e).outerHeight();e<l?(i=e%l,p[e]=a-c,$(t).css({position:"absolute",left:i*s+i*d})):(o=Math.min.apply(null,p),n=$.inArray(o,p),$(t).css({position:"absolute",top:o+d,left:n*s+n*d}),p[n]+=r.eq(e).outerHeight()+d)}),e.find(".chart_image").css("visibility","visible");var t=Math.max.apply(null,p);e.height(t+50),this.isLoading=!0}},switchExpireTime:function(e){if(!e)return"";var t=new Date(e);return t.getFullYear()+"/"+(+t.getMonth()+1)+"/"+t.getDate()},expireTimeJudge:function(e,t){var i=(new Date).getTime();return 0<e-i&&e-i<24*t*60*60*1e3},upgradeVip:function(e){var t,i=vipOrderPosition[e];i&&(t={encrypted_session:encrypted_session,user_id:userId,trace_id:trace_id,client_id:client_id,file_id:file_id,file_type:"mind",source:"mind"},$.ajax({url:"/order/preOrder",type:"POST",data:t,success:function(e){if("success"==e.result)return orderId=e.order_id,$(".tdoc-vip-dlg").dlg("close"),sendMessage("notify",{eventType:"joinMembership",aid:i}),void poCollect("result_pre_order",{result:"success",position:i,orderid:orderId,page:"flow_editor",userId:userId,vip:tdoc_is_vip,povip:po_is_vip,device:deviceType});Util.globalTopTip("打开开通会员窗口失败","top_error",5e3),poCollect("result_pre_order",{result:"failed",position:i,page:"flow_editor",userId:userId,vip:tdoc_is_vip,povip:po_is_vip,device:deviceType,reason:e.msg})},error:function(e){Util.globalTopTip("打开开通会员窗口失败","top_error",5e3),console.log(e.statusText),poCollect("result_pre_order",{result:"failed",position:i,page:"flow_editor",userId:userId,vip:tdoc_is_vip,povip:po_is_vip,device:deviceType,reason:e.statusText})}}))},opensdkAuthSupportCallback:function(e){JSON.parse(e).result?(UI.sdkAuthSupport=!0,oauthParamsObj):UI.getOpenAuthCode(UI.getOpenAuthCodeCallBack,"old_logic")},sdkAuthCodeGetCallback:function(e){var t=JSON.parse(e);"ok"==t.callstatus&&t.code?UI.updateServerVipState(t.code,UI.getOpenAuthCodeCallBack):Util.globalTopTip("授权失败","top_error",5e3)},updateServerVipState:function(e,t){$.ajax({url:"/oauth/callback",data:{code:e,state:userId},type:"post",success:function(e){"success"!=JSON.parse(e).result?Util.globalTopTip("会员状态同步失败","top_error",5e3):t&&t()},error:function(){Util.globalTopTip("会员状态同步失败","top_error",5e3)}})},getOpenAuthCode:function(e,t){UI.getOpenAuthCodeCallBack=null,UI.getOpenAuthCodeCallBack=e;var i=(new Date).getTime();$("#oauth_target").attr("src",oauthUrl+"&timestr="+i),$("#oauth_target").off("load").on("load",function(){e&&e()})},getOpenAuthCodeCallBack:null,showImport:function(){window.importSupportCallback=null,window.importSupportCallback=function(e){JSON.parse(e).result?bigPipe.render({js:["/assets/js/plugins/promise-1.0.0.js","/assets/js/plugins/jquery.xml2json.js","/assets/js/plugins/zip.js","/assets/js/plugins/flow_import.min.js"]},function(){$("#dlg_import").dlg({onClose:function(){$("#import_btn").html("添加文件"),document.querySelector("#share_upload_form").reset(),$("#share_doc_import").replaceWith('<input id="share_doc_input" class="file-upload" name="file" type="file" accept=".pos,.mmap,.mm,.km,.opml,.txt" />')}})}):$(".apiSupport-error-dlg").dlg()}},renameCallback:function(e){$("#tip_result").hide(),$("#dlg_rename").dlg("close"),$("#file_new_title").removeAttr("submitting"),"ok"==(e=JSON.parse(e)).result?($('<div id="download_tip" class="toast"><span class="mind-icons toast-icon">&#xe6d9;</span><span>&nbsp;&nbsp;重命名成功</span><span onclick="$(this).parent().remove()" class="mind-icons toast-close">&#xe623;</span></div>').appendTo("body"),document.title=e.newname,title=e.newname,$("#file_new_title").val(e.newname)):$('<div id="download_tip" class="toast"><span style="color:#f60;" class="mind-icons toast-icon">&#xe6b8;</span><span>&nbsp;&nbsp;'+e.description+'</span><span onclick="$(this).parent().remove()" class="mind-icons toast-close">&#xe623;</span></div>').appendTo("body"),setTimeout(function(){$("#download_tip").fadeOut().remove()},3e3)},changeTitle:function(e){var t,i=$(".diagram_title").text();e&&e!=i&&""!=chartId&&(t={action:"changeTitle",title:e},CLB.send(t));var o=""!=e?e:i;$("title").text(o+" - ProcessOn"),$(".diagram_title").text(o).show(),$("#title_container").children("input").remove()},update:function(){var e,t,i,o,n,a=Utils.getSelectedIds(),r=a.length,s=Utils.getSelectedLinkerIds(),l=s.length,d=Utils.getSelectedShapeIds(),c=d.length,p=Utils.getSelectedLockedIds().length,u=Utils.getSelectedGroups().length,h=$("#bar_list_arrange");0==r?($(".header-op-group-page").show(),$(".header-op-group-one").hide(),$(".header-op-group-two").hide()):($(".header-op-group-page").hide(),$(".header-op-group-one").show(),$(".header-op-group-two").hide(),1<r&&$(".header-op-group-two").show()),0==l?$(".header-op-group-three").hide():$(".header-op-group-three").show(),0==r?($(".header-op").find(".selected").removeClass("selected"),$("#designer_op_help").is(":visible")?($("#bar_brush").button("enable"),$("#bar_brush").button("select")):$("#bar_brush").button("disable"),$("#bar_font_family").button("disable"),$("#bar_font_size").button("disable"),$("#bar_font_bold").button("disable"),$("#bar_font_italic").button("disable"),$("#bar_font_underline").button("disable"),$("#bar_font_color").button("disable"),$("#bar_font_color").find(".color_line").css("background","transparent"),$(".bar_font_align").button("disable"),$("#bar_opacity").button("disable"),$("#pos_routate").spinner("setValue","0%"),$("#bar_pos").button("disable"),$("#pos_forward").button("disable"),$("#pos_backward").button("disable"),$("#bar_front").button("disable"),$("#bar_back").button("disable"),$("#bar_align").button("disable"),$("#arrange_align").button("disable"),$("#arrange_dist").button("disable"),$("#arrange_match").button("disable"),$("#bar_routate").button("disable"),$("#pos_routate_90").button("disable"),$("#pos_routate").button("disable"),$("#pos_x").button("disable"),$("#pos_y").button("disable"),$("#pos_w").button("disable"),$("#pos_h").button("disable"),$("#bar_line_color").button("disable"),$("#bar_line_width").button("disable"),$("#bar_line_style").button("disable"),$("#bar_line_color").find(".color_line").css("background","transparent"),$("#bar_fill").find(".color_line").css("background","transparent"),$("#bar_front").button("disable"),$("#bar_back").button("disable"),$("#bar_group_set").button("disable"),$("#bar_group").button("disable"),$("#bar_ungroup").button("disable"),$("#bar_lock").button("disable"),(e=$("#bar_list_edit")).children("li[ac=cut]").menuitem("disable"),e.children("li[ac=copy]").menuitem("disable"),e.children("li[ac=duplicate]").menuitem("disable"),e.children("li[ac=brush]").menuitem("disable"),e.children("li[ac=delete]").menuitem("disable"),h.children("li[ac=front]").menuitem("disable"),h.children("li[ac=back]").menuitem("disable"),h.children("li[ac=forward]").menuitem("disable"),h.children("li[ac=backward]").menuitem("disable"),h.children("li[ac=lock]").menuitem("disable")):($("#bar_brush").button("enable"),$("#designer_op_help").is(":visible")&&$("#bar_brush").button("select"),$("#bar_font_family").button("enable"),$("#bar_font_size").button("enable"),$("#bar_font_bold").button("enable"),$("#bar_font_italic").button("enable"),$("#bar_font_underline").button("enable"),$("#bar_font_color").button("enable"),$(".bar_font_align").button("enable"),$("#bar_opacity").button("enable"),$("#bar_line_color").button("enable"),$("#bar_line_width").button("enable"),$("#bar_line_style").button("enable"),$("#bar_pos").button("enable"),$("#bar_front").button("enable"),$("#bar_back").button("enable"),$("#pos_forward").button("enable"),$("#pos_backward").button("enable"),$("#bar_lock").button("enable"),(e=$("#bar_list_edit")).children("li[ac=cut]").menuitem("enable"),e.children("li[ac=copy]").menuitem("enable"),e.children("li[ac=duplicate]").menuitem("enable"),e.children("li[ac=brush]").menuitem("enable"),e.children("li[ac=delete]").menuitem("enable"),h.children("li[ac=front]").menuitem("enable"),h.children("li[ac=back]").menuitem("enable"),h.children("li[ac=forward]").menuitem("enable"),h.children("li[ac=backward]").menuitem("enable"),h.children("li[ac=lock]").menuitem("enable"),"linker"==(o=Model.getShapeById(a[0])).name?(t=Utils.getLinkerFontStyle(o.fontStyle),n=Utils.getLinkerLineStyle(o.lineStyle),$("#bar_opacity").button("disable"),$("#bar_opacity").spinner("setValue","0%"),$("#bar_routate").button("disable").hide(),$("#pos_routate_90").button("disable"),$("#pos_routate").button("disable"),$("#pos_routate").spinner("setValue","0%"),$("#pos_x").button("disable").spinner("setValue","0"),$("#pos_y").button("disable").spinner("setValue","0"),$("#pos_w").button("disable").spinner("setValue","0"),$("#pos_h").button("disable").spinner("setValue","0")):(t=Utils.getShapeFontStyle(o.fontStyle),n=Utils.getShapeLineStyle(o.lineStyle),$("#bar_opacity").button("enable"),$("#bar_opacity").spinner("setValue",Math.round(100*o.shapeStyle.alpha)+"%"),$("#bar_routate").button("enable").show(),$("#pos_routate_90").button("enable"),$("#pos_routate").button("enable"),$("#pos_routate").spinner("setValue",Math.round(o.props.angle/Math.PI*180)+"°"),$("#pos_x").button("enable").spinner("setValue",Math.round(o.props.x)),$("#pos_y").button("enable").spinner("setValue",Math.round(o.props.y)),$("#pos_w").button("enable").spinner("setValue",Math.round(o.props.w)),$("#pos_h").button("enable").spinner("setValue",Math.round(o.props.h))),$("#bar_font_family").children().eq(0).text(t.fontFamily),$("#bar_font_size").children().eq(0).text(t.size+"px"),t.bold?$("#bar_font_bold").button("select"):$("#bar_font_bold").button("unselect"),t.italic?$("#bar_font_italic").button("select"):$("#bar_font_italic").button("unselect"),t.underline?$("#bar_font_underline").button("select"):$("#bar_font_underline").button("unselect"),$("#bar_font_color").find(".color_line").css("backgroundColor","rgb("+t.color+")"),$("#bar_line_color").find(".color_line").css("backgroundColor","rgb("+n.lineColor+")")),0==c?$("#bar_fill").button("disable").hide():($("#bar_fill").button("enable").show(),o=Model.getShapeById(d[0]),"solid"==(i=Utils.getShapeFillStyle(o.fillStyle)).type?$("#bar_fill").find(".color_line").css("backgroundColor","rgb("+i.color+")"):"gradient"==i.type&&$("#bar_fill").find(".color_line").css("backgroundColor",i.endColor)),1!=c?$("#bar_link").button("disable"):$("#bar_link").button("enable"),0==l?($("#bar_linkertype").button("disable"),$("#bar_beginarrow").button("disable"),$("#bar_endarrow").button("disable")):($("#bar_linkertype").button("enable"),$("#bar_beginarrow").button("enable"),$("#bar_endarrow").button("enable"),o=Model.getShapeById(s[0]),n=Utils.getLinkerLineStyle(o.lineStyle),$("#bar_linkertype").children("span:eq(0)").attr("class","mind-icons linkertype_"+o.linkerType.toLowerCase()),$("#bar_beginarrow").children("span:eq(0)").attr("class","mind-icons ico_arrow larrow_"+n.beginArrowStyle.toLowerCase()),$("#bar_endarrow").children("span:eq(0)").attr("class","mind-icons ico_arrow rarrow_"+n.endArrowStyle.toLowerCase())),0==p?($("#bar_unlock").button("disable"),h.children("li[ac=unlock]").menuitem("disable")):($("#bar_unlock").button("enable"),h.children("li[ac=unlock]").menuitem("enable")),r<2?(h.children("li[ac=group]").menuitem("disable"),$("#bar_align").button("disable"),$("#bar_arrange_align").menuitem("disable"),$("#bar_group_set").button("disable"),$("#bar_group").button("disable"),$("#bar_ungroup").button("disable"),$("#arrange_align").button("disable")):(h.children("li[ac=group]").menuitem("enable"),$("#bar_align").button("enable"),$("#bar_arrange_align").menuitem("enable"),$("#bar_group_set").button("enable"),$("#bar_group").button("enable"),$("#bar_ungroup").button("enable"),$("#arrange_align").button("enable")),c<2?($("#bar_arrange_match").menuitem("disable"),$("#arrange_match").button("disable")):($("#bar_arrange_match").menuitem("enable"),$("#arrange_match").button("enable")),r<3?($("#bar_arrange_dist").menuitem("disable"),$("#bar_list_align li[ac=distribute_shape]").button("disable")):($("#bar_arrange_dist").menuitem("enable"),$("#bar_list_align li[ac=distribute_shape]").button("enable")),0==u?(h.children("li[ac=ungroup]").menuitem("disable"),$("#bar_ungroup").button("disable")):(h.children("li[ac=ungroup]").menuitem("enable"),$("#bar_ungroup").button("enable"))},showInsertLink:function(){$("#link_dialog").dlg();var e=(e=Utils.getSelected()[0].link)||"";$("#linkto_addr").val(e).select(),$("#linkto_addr").unbind().bind("keydown",function(e){13==e.keyCode&&UI.setLink()})},setLink:function(){var e=$("#linkto_addr").val(),t=Utils.getSelected()[0];t.link=e,Model.update(t),$("#link_dialog").dlg("close")},imageSelectedCallback:null,showImageSelect:function(i){$("#input_upload_image").unbind().bind("change",function(){var e=this.files[0];if($(this).val(""),!/image\/\w+/.test(e.type))return Util.globalTopTip("图片格式错误","top_error",2e3),!1;if(2097152<e.size)return Util.globalTopTip("图片大小不能超过2M","top_error",2e3),!1;var t=new FormData;t.append("image",e),t.append("fileID",file_id),t.append("type","flowchart"),t.append("scene",scene),$.ajax({url:"https://docs.qq.com/cooperation/v1/images",type:"post",crossDomain:!0,xhrFields:{"Access-Control-Allow-Origin":"*",withCredentials:!0},headers:{"Client-Id":client_id,"Access-Token":encrypted_session,"Open-Id":tdoc_user_id},data:t,processData:!1,contentType:!1,success:function(e){var t;"size_wrong"!=(e=JSON.parse(e)).result?"type_wrong"!=e.result?e.ret?Util.globalTopTip("上传失败","top_error",2e3):e.data&&(t=e.data,i&&i(t.url,t.width,t.height)):Util.globalTopTip("只能上传图片格式","top_error",2e3):Util.globalTopTip("图片大小不能超过10M","top_error",2e3)},error:function(){Util.globalTopTip("上传失败","top_error",2e3)}})}),$("#input_upload_image").trigger("click")},networkTesting:function(){},networkTestingCallback:function(e){offlineMask||($(".offline-dlg").dlg(),offlineMask=!0)},networkTestingCallbackS:function(){offlineMask&&($(".offline-dlg").dlg("close"),offlineMask=!1)},showImageSelectContent:function(e){$(".image_list").hide(),$("#image_select_"+e).find(".chart_image.active, .image_item.image_item_selected").length?$("#searchInsertImage").removeClass("flow-disable"):$("#searchInsertImage").addClass("flow-disable"),$(".image_sources").children().removeClass("active"),$(".image_sources").children("li[ty="+e+"]").addClass("active"),"url"==e?($("#image_select_"+e).show().find("input[type=text]").select(),$("#searchInsertImage").css("visibility","hidden")):($("#image_select_"+e).show(),$("#searchInsertImage").css("visibility","visible"))},loadUserImages:function(e){$("#user_image_items").empty(),$.ajax({url:"/user_image/list",data:{key:userId},success:function(e){if(e.images){for(var t=0;t<e.images.length;t++){var i=e.images[t];UI.appendUserImage(i)}$("#user_image_items").append("<div style='clear: both'></div>")}}}),$("#user_image_items").attr("loaded","true")},searchIndex:0,searchKeywords:"",searchImage:function(){var e=$("#input_img_search").val();""!=e.trim()?($("#google_image_items").empty(),this.searchKeywords=encodeURI(e),this.searchIndex=0,UI.loadSearchImg()):$("#input_img_search").focus()},loadSearchImg:function(){$.getJSON("https://api.iconfinder.com/v2/icons/search?query="+this.searchKeywords+"&offset="+this.searchIndex+"&count=24&minimum_size=128&vector=false&premium=false",function(e){if(0==e.total_count)$("#google_image_items").html("<div class='img_gg_loading_tip'><@i18n resource='diagraming.selectimage.search.none'/></div>");else{for(var t=e.icons,i=0;i<t.length;i++){var o=t[i].raster_sizes;o.sort(function(e,t){return e.size-t.size});for(var n=0;n<o.length;n++){var a=o[n];if(128==a.size||n==o.length-1){var r=a.formats[0].preview_url,s=$("<div class='image_item' u='"+r+"' w='"+a.size_width+"' h='"+a.size_height+"'></div>").appendTo($("#google_image_items"));s.unbind().bind("click",function(){$(".image_item_selected").removeClass("image_item_selected"),$(this).addClass("image_item_selected")});$("<div class='image_box'><img src='"+r+"'/></div>").appendTo(s);var l=$("<div class='drop_size'><span>"+a.size_width+"x"+a.size_height+"</span></div>").appendTo(s);l.data("sizes",o),1<o.length?(l.append("<div class='mind-icons ico_accordion'>&#xe613;</div>"),l.bind("click",function(){UI.dropImageSizes($(this))})):l.css({"padding-left":"9px",cursor:"default"});break}}}$("#google_image_items").append("<div style='clear: both'></div>"),$(".img_gg_loading_tip").remove(),$(".gg_img_more").remove(),UI.searchIndex+24<e.total_count&&$("#google_image_items").append("<div onclick='UI.loadSearchImg()' class='gg_img_more toolbar_button active'><@i18n resource='diagraming.selectimage.showmore'/></div>")}}),$(".gg_img_more").remove(),$("#google_image_items").append("<div class='img_gg_loading_tip'><@i18n resource='diagraming.selectimage.loadinggoogle'/></div>"),this.searchIndex+=24},dropImageSizes:function(i){var e=i.data("sizes");e.sort(function(e,t){return e.size-t.size});var t=$("#img_size_menu");0==t.length&&(t=$("<ul id='img_size_menu' class='menu list' style='z-index:1'></ul>").appendTo("#ui_container")),t.empty();for(var o=0;o<e.length;o++){var n=e[o],a=n.formats[0].preview_url;t.append("<li u='"+a+"' w='"+n.size_width+"' h='"+n.size_height+"'>"+n.size_width+"x"+n.size_height+"</li>")}t.dropdown({target:i,onSelect:function(e){var t=i.parent();t.attr("u",e.attr("u")),t.attr("w",e.attr("w")),t.attr("h",e.attr("h")),i.children("span").text(e.text()),t.find("img").attr("src",e.attr("u"))}})},appendUserImage:function(e){var t=$("<div class='image_item' id='"+e.imageId+"' fileId='"+e.fileId+"' w='"+e.imageW+"' h='"+e.imageH+"'></div>").appendTo($("#user_image_items"));t.unbind().bind("click",function(){$(".image_item_selected").removeClass("image_item_selected"),$(this).addClass("image_item_selected"),$("#searchInsertImage").removeClass("flow-disable")}).bind("mouseenter",function(){var e=$(this),t=$("<div class='ico ico_remove_red'></div>").appendTo(e),i=e.attr("id");t.bind("click",function(){e.remove(),$.ajax({url:"/user_image/remove",data:{imageId:i},success:function(e){0==$("#user_image_items").children(".image_item_selected").length&&$(".image_btns").css("visibility","hidden")}})})}).bind("mouseleave",function(){$(this).find(".ico_remove_red").remove()});var i="https://www.processon.com/file/id/"+e.fileId+"/diagram_user_image";null!=e.fileId&&0<=e.fileId.indexOf("http")&&(0<=(i=e.fileId).indexOf("orgu2a928.bkt.clouddn.com")?i=i.replace("orgu2a928.bkt.clouddn.com","cdn2.processon.com"):0<=i.indexOf("7xt9nt.com1.z0.glb.clouddn.com")?i=i.replace("7xt9nt.com1.z0.glb.clouddn.com","cdn.processon.com"):0<=i.indexOf("p7o7ul1nf.bkt.clouddn.com")&&(i=i.replace("p7o7ul1nf.bkt.clouddn.com","cdn1.processon.com")));$("<div class='image_box'><img src='"+i+"'/></div>").appendTo(t)},setShapeImage:function(e,t,i){this.imageSelectedCallback&&this.imageSelectedCallback(e,t,i),$("#image_dialog").dlg("close"),clearInterval(networkTimer)},insertImage:function(e,t,i){t=parseInt(t),i=parseInt(i);var o=$("#designer_layout"),n=o.width()/2+o.offset().left,a=o.height()/2+o.offset().top,r=Utils.getRelativePos(n,a,$("#designer_canvas")),s=Model.create("standardImage",r.x.restoreScale()-t/2,r.y.restoreScale()-i/2);s.props.w=t,s.props.h=i,s.fillStyle={type:"image",fileId:e,display:"stretch",imageW:t,imageH:i},Model.add(s),Designer.painter.renderShape(s),Utils.unselect(),Utils.selectShape(s.id)},openImportGuide:function(){$(".import-guide-dlg").dlg({onClose:function(){UI.closeImportGuide(!0)}}),$("#import-guide-dlg-submit").off("click").on("click",function(e){e.stopPropagation(),UI.exportFile.clientRequest(),UI.closeImportGuide()})},closeImportGuide:function(e){$("#importGuide-nodlg-check").hasClass("checked")&&localStorage.setItem("flow-importGuide-nodlg-flag","1"),e||$(".import-guide-dlg").dlg("close")},showDownloading:function(){},hideDownloading:function(){$(".mind-download-tip").remove()},sendVersion:function(e,i){var t={user_id:userId,encrypted_session:encrypted_session,file_id:file_id,client_id:"processon",trace_id:trace_id,scene:scene,version:e,type:i};$.post("/diagrams/revision",t,function(e){var t;if("success"==e.result){if("view"==i)Dock.openHistory(e.def),$("#flow_ui_tip").css({top:56,marginLeft:520}).show().find(".flow-tip-text").html("<@i18n resource='diagraming.history.viewing'/><a href='javascript:' style='margin-left: 10px;color:#fff;text-decoration:underline;' onclick='Dock.closeHistory()'><@i18n resource='diagraming.history.back'/></a>");else if("rollback"==i){if(null==e.def)return;Dock.revertHistory(data.def)}}else"view"==i?(console.log("view","预览失败------------------------------------------"),t={ret:1,message:"预览失败"},sendMessage("view",t)):"rollback"==i&&(console.log("rollback","还原失败------------------------------------------"),t={ret:0,message:"还原失败"},sendMessage("rollback",t))})},exportFile:{type:null,handle:function(e){this.errorNum=0,this.errorUrls=[],this.proUrlObj={},this._errorUrls=[];var t;"pom"!=(this.type=e)?(this.openAfterDownloaded="false",this.exportUrlType="pnghd"==e?"png":"jpghd"==e?"jpg":"pdfhd"==e?"pdf":e,this.url=encodeURI(exportUrl+"/diagram_export/mind?chartId="+chartId+"&type="+this.exportUrlType+"&title="+encodeURIComponent(title)+"&user_id="+userId+"&encrypted_session="+encrypted_session+"&client_id="+client_id+"&file_id="+file_id+"&trace_id="+trace_id+"&scene="+scene),this.filter="png"==e||"pnghd"==e?"图片格式 (*.png)":"pos"==e?"POS格式(*.pos)":"jpg"==e||"jpghd"==e?"JPG图片文件(*.jpg)":"pdf"==e||"pdfhd"==e?"PDF格式 (*.pdf)":"svg"==e?"SVG格式 (*.svg)":"图片格式 (*.png)",t=this,Utils.testVipState(function(){"png"==e||-1<tdocVipInfo.indexOf(20)||-1<tdocVipInfo.indexOf(30)||-1<tdocVipInfo.indexOf(40)?("png"!=e&&Designer.events.push("po-vip-limit","download_"+e),"png"==e||"jpg"==e||"svg"==e||"pdf"==e||"pnghd"==e||"jpghd"==e||"pdfhd"==e?(UI.showDownloading(),setTimeout(function(){t.drawImage(e)},0)):t.clientRequest()):(t.url=null,UI.showVipLimitDlg("download_"+e))})):localStorage.getItem("userpoftips")?createQuickOpen():(localStorage.setItem("userpoftips","1"),$(".quick-open-dlg").dialog())},url:"",openAfterDownloaded:!1,exportUrlType:"",filter:"",clientRequest:function(e){UI.hideDownloading();var t={ret:e||0,type:this.exportUrlType};this.url&&(t.url=this.url),sendMessage("export_file",t),poCollect("result_downfile",{result:"success",type:t.type,page:"flow_editor",userId:userId,vip:tdoc_is_vip,povip:po_is_vip,device:deviceType})},drawImage:function(c){var p=this;Designer.setZoomScale(1);var t=flow2svg.init(c,!0),i=$("#svg_exporter").html().replace(/&nbsp;/g," ").replace(/NS[0-9]+:href/g,"xlink:href");"svg"!=c?function l(e){var d=e||1;-1!=c.indexOf("hd")&&null==e&&(d=p.scaleMax(t.w,t.h));console.log("图片大小："+t.w+"*"+t.h+"="+t.w*t.h);if(t.w*t.h>268435456/Math.pow(d,2))return UI.hideDownloading(),sendMessage("export_file",{ret:1,message:"文件内容超出下载限制"}),Util.globalTopTip("文件内容超出下载限制","top_error"),void poCollect("result_downfile",{result:"failed",type:c,reason:"文件内容超出下载限制",page:"flow_editor",userId:userId,vip:tdoc_is_vip,povip:po_is_vip,device:deviceType});$("#svg_exporter").html('<canvas id="canvas_exporter" width="'+t.w*d+'" height="'+t.h*d+'"></canvas>');canvg("canvas_exporter",i.replace(/\u00a0/g,"<tspan> </tspan>"),{log:!0,ignoreDimensions:!0,enableRedraw:!0,ignoreClear:!0,forceRedraw:!0,useCORS:!0,scaleWidth:t.w*d,scaleHeight:t.h*d,renderCallback:function(){if(0<p.errorNum)console.log("后台导出");else{var e,t,i,o=document.getElementById("canvas_exporter");if(i="jpg"==c||"jpghd"==c?(e=o.toDataURL(),t=title||"无标题流程图","jpg"):"png"==c||"pnghd"==c?(e=o.toDataURL(),t=title||"无标题流程图","png"):(e=o.toDataURL(),t=title||"无标题流程图","pdf"),e.length<10)2<d?l(2):1<d?l(1):(UI.hideDownloading(),sendMessage("export_file",{ret:1,message:"文件内容超出下载限制"}),Util.globalTopTip("文件内容超出下载限制","top_error"),poCollect("result_downfile",{result:"failed",type:c,reason:"文件内容超出下载限制",page:"flow_editor",userId:userId,vip:tdoc_is_vip,povip:po_is_vip,device:deviceType}));else{if(flow2svg.cleanSvgHtml(),console.log("实际放大倍数："+d),"jpg"==i||"png"==i)return UI.hideDownloading(),s(URL.createObjectURL(r(e)),t+"."+i),p.url=null,void p.clientRequest();var n=new FormData,a=new Blob([e],{type:"text/plain"});n.append("content",a),n.append("category",i),n.append("chartId",chartId),n.append("userid",userId),n.append("fileId",fileId),n.append("ignore",i+"Text"),$.ajax({url:"/mindmap/pre_export_image",data:n,timeout:6e4,type:"post",processData:!1,contentType:!1,success:function(e){"success"==e.result?(p.url=encodeURI(exportUrl+"/diagram_export/mind?chartId="+chartId+"&type="+p.exportUrlType+"&title="+encodeURIComponent(t)+"&user_id="+userId+"&encrypted_session="+encrypted_session+"&client_id="+client_id+"&file_id="+file_id+"&trace_id="+trace_id+"&scene="+scene+"&exportType=base64"),p.clientRequest()):(console.log(e),UI.hideDownloading(),sendMessage("export_file",{ret:1,message:"下载图片失败，请重新尝试"}),Util.globalTopTip("下载图片失败，请重新尝试","top_error"),poCollect("result_downfile",{result:"failed",type:c,reason:"下载图片失败",page:"flow_editor",userId:userId,vip:tdoc_is_vip,povip:po_is_vip,device:deviceType}))},error:function(e){console.log("[下载高清PNG] 上传图片失败"),UI.hideDownloading(),sendMessage("export_file",{ret:1,message:"下载图片失败，请重新尝试"}),Util.globalTopTip("下载图片失败，请重新尝试","top_error"),poCollect("result_downfile",{result:"failed",type:c,reason:e.statusText,page:"flow_editor",userId:userId,vip:tdoc_is_vip,povip:po_is_vip,device:deviceType})},complete:function(e,t){"timeout"==t&&(UI.hideDownloading(),sendMessage("export_file",{ret:1,message:"下载图片超时，请重新尝试"}),Util.globalTopTip("下载图片超时，请重新尝试","top_error"),poCollect("result_downfile",{result:"failed",type:c,reason:"下载图片超时",page:"flow_editor",userId:userId,vip:tdoc_is_vip,povip:po_is_vip,device:deviceType}))}})}}function r(e){for(var t=atob(e.split(",")[1]),i=t.length,o=new Uint8Array(i),n=0;n<i;n++)o[n]=t.charCodeAt(n);return new Blob([o],{type:"image/png"})}function s(e,t){var i=new MouseEvent("click",{view:window,bubbles:!1,cancelable:!0}),o=document.createElement("a");o.setAttribute("download",t),o.setAttribute("href",e),o.setAttribute("target","_blank"),o.dispatchEvent(i)}}})}():$.ajax({url:"/mindmap/pre_export_svg",data:{svgText:i,category:"svg",chartId:chartId,userid:userId,fileId:fileId,ignore:"svgText"},type:"post",success:function(e){"success"==e.result?(p.url=encodeURI(exportUrl+"/diagram_export/mind?chartId="+chartId+"&type="+p.exportUrlType+"&title="+encodeURIComponent(title)+"&user_id="+userId+"&encrypted_session="+encrypted_session+"&client_id="+client_id+"&file_id="+file_id+"&trace_id="+trace_id+"&scene="+scene+"&exportType=base64"),p.clientRequest()):(console.log("上传svg失败"),UI.hideDownloading(),Util.globalTopTip("下载SVG图片失败，请重新尝试","top_error"))},error:function(){console.log("上传svg失败"),UI.hideDownloading(),Util.globalTopTip("下载SVG图片失败，请重新尝试","top_error")}})},scaleMax:function(e,t){var i=Math.sqrt(268435456/(Math.ceil(e)*Math.ceil(t))),o=Math.floor(10*i)/10;return console.log("最大放大倍数："+o),8<o?3:4<o?2:2<o?1.5:1},errorNum:0,errorUrls:[],proUrlObj:{},_errorUrls:[],exportError:function(e){this.errorUrls.indexOf(e)<0&&this.errorUrls.push(e),this.type.indexOf("hd"),0<this.errorNum||(console.log("后台导出"),this.url=null,Util.globalTopTip("有不授信图片无法下载","top_error",3e3),this.clientRequest("E004"),$("#svg-wrap").remove(),this.errorNum++)},exportErrorTip:function(e){console.log(e),0<this.errorNum||(Util.globalTopTip("不授信图片无法下载","top_error",5e3),this.errorNum++)}},doExport:function(){$("#export_dialog").dlg("close"),$.simpleAlert("<@i18n resource='diagraming.export.wait'/>","info","no"),$("#export_title").val($(".diagram_title").text()||"<@i18n resource='diagraming.default_title'/>");$("#export_form input[name='type']:checked").val();$.simpleAlert("close"),$("#export_form").submit(),$("#export_ok").disable(),setTimeout(function(){$("#export_ok").enable()},2e3)},exportSVG:function(e){var t,i=Model.define,o=i.elements,n=[];$("#svg_dialog").empty();var a=SVG("svg_dialog");a.attr("id","drawing");var r,s,l,d,c,p=Export.flow;for(var u in o){(t=$.extend({},o[u])).from&&t.from.x==t.to.x&&t.from.y==t.to.y||(d={bold:!(l={type:"solid",color:"255,255,255",alpha:1}),color:"0,0,0",underline:!(s={lineColor:"50,50,50",lineStyle:"solid",lineWidth:2,beginArrowStyle:"none",endArrowStyle:"solidArrow"}),textAlign:"center",italic:!1,size:13},(c={}).parent=t.parent,c.id=t.id,c.index=t.props.zindex,c.x=t.props.x,c.y=t.props.y,c.w=t.props.w,c.h=t.props.h,c.angle=t.props.angle,c.font=t.fontStyle=$.extend(d,t.fontStyle),c.font.color=Export.getColor(t.fontStyle.color),c.font.bold=c.font.bold?"bold":"normal",c.font.underline=c.font.underline?"underline":"blink",c.font.italic=c.font.italic?"italic":"normal",c.font.family=c.font.fontFamily||"微软雅黑,黑体,Arial",c.line=t.lineStyle=$.extend(s,t.lineStyle),c.line.lineColor=Export.getColor(c.line.lineColor),t.fillStyle&&(c.fill=t.fillStyle=$.extend(l,t.fillStyle),1!=c.fill.alpha&&(c.fill.color&&(c.fill.color+=","+c.fill.alpha),c.fill.beginColor&&(c.fill.beginColor+=","+c.fill.alpha),c.fill.endColor&&(c.fill.endColor+=","+c.fill.alpha)),c.fill.color&&(c.fill.color=Export.getColor(c.fill.color)),c.fill.beginColor&&(c.fill.beginColor=Export.getColor(c.fill.beginColor)),c.fill.endColor&&(c.fill.endColor=Export.getColor(c.fill.endColor))),t.shapeStyle&&(c.shape=t.shapeStyle),t.path&&(c.path=p.json2path(t.props,t.path,c.line,c.fill)),t.linkerType&&(r=p.line2path(t),c.path=r[0],c.points=r[1],c.linker=t.linkerType),t.textBlock&&0<t.textBlock.length&&(c.strs=p.textSplit(t.props,t.textBlock,c.font)),t.attribute&&t.attribute.markers&&t.attribute.markers.length&&(c.markers=p.marker2svg(t.attribute,t.props,t)),t.dataAttributes&&t.dataAttributes.length&&(c.attrs=p.attr2svg(t.props,t.dataAttributes,c.angle)),n.push(c))}n.sort(function(e,t){return e.index==t.index&&e.parent==t.id?1:e.index-t.index});for(var h=a.group(),g=h.path().fill(Export.getColor(i.page.backgroundColor)),_=h.group(),m=0;m<n.length;m++)"number"==typeof n[m].x?p.shape2svg(n[m],_.group(),e):p.flowline2svg(n[m],h,_.group());var f=p.getRect(_);a.viewbox(f.left-20,f.top-20,f.width+40,f.height+40),a.size(f.width+40,f.height+40);var v=[["M",f.left-20,f.top-20],["h",f.width+40],["v",f.height+40],["h",-f.width-40],["v",-f.height-40],["z"]];g.plot(v),setTimeout(function(){var e=$("#svg_dialog").html(),e=encodeURIComponent(e);$.simpleAlert("close"),$("#svg_dialog").empty(),$("svg").remove(),$("#export_title").after("<input id='export_definition' type='hidden' name='definition'/>"),$("#export_definition").val(e),$("#export_form").submit(),$("#export_definition").remove()},3e3)},showHotKey:function(){$("#hotkey_list").dlg()},showFeedBack:function(){},getAppInfoCallback:function(e){e=JSON.parse(e);var t=encodeURIComponent("流程图"),i="https://qa.wps.cn/feedback/front?wpsid="+wpsId+"&product_name="+t+"&app_type=web&app_name=flowchart&app_version="+e.version+"&app_dist="+e.channel;window.open(encodeURI(i))},sendFeedBack:function(e){var t=$.trim($("#feedback_message").val());if(""==t)return $("#feedback_message").val("").focus(),void $(".feedback_error_msg").show();t=t.substring(0,600),Util.ajax({url:"/mindmap/save_ask",data:{content:t,url:location.href},success:function(e){$(".dlg_mask").remove(),$("#send_feedback").dlg("close"),UI.showTip("提交车成功，感谢您的反馈"),setTimeout(function(){$("#designer_ui_tip").remove()},3e3)}})},gettingStart:function(e){this.showStartStep(1)},showStartStep:function(e,t){$(".mark_content").hide();var i,o,n,a=$(".mark"+e+"_content");a.show(),1==e?(i=$("#shape_panel").offset().top+70,o=$("#shape_panel").offset().left+$("#shape_panel").width()+10):2==e?((n=$(".header-center")).find("[tit=edit]").trigger("click"),i=$("#designer_header").offset().top+40,o=n.offset().left+n.width()-6*a.outerWidth()/7):3==e?(i=$("#designer_header").offset().top+105,o=$(".header-center").offset().left+$(".header-center").width()-6*a.outerWidth()/7):4==e?(i=$("#dock").offset().top+10,o=$("#dock").offset().left-a.outerWidth()-10):"created"==e&&((i=t.offset().top+t.height()/2-a.outerHeight()/2)<=0&&(i=0),i+a.outerHeight()>$(window).height()&&(i=$(window).height()-a.outerHeight()),o=t.offset().left+t.width()+10),a.css({top:i,left:o})},closeGettingStart:function(e){$(".mark_content").hide()},showAddColla:function(){Util.ajax({url:"/collaboration/get_colla_role_list",data:{chartId:chartId},success:function(e){$("#colla_dialog").find(".role_list").html(e).scrollTop(999),$("#colla_dialog").removeClass("_update"),$("#colla_dialog").css({top:.5*($(window).height()-$("#colla_dialog").outerHeight())+"px"}),$("#colla_dialog").dlg(),$("#add_prompt4").hide(),$("#add_prompt3").hide(),$("#add_prompt2").hide(),$("#add_prompt1").show(),$("#colla_suggest_box").addClass("colla").html('<div class="suggest_colla_box colla_loading"></div>'),UI.getCollaTeamMembers()}});var t="";$("#input_add_colla").val("").unbind().bind("keyup",function(){var e=$(this).val();if(e!=t){if(""==(t=e))return $("#add_prompt4").hide(),$("#add_prompt3").hide(),$("#add_prompt2").hide(),$("#add_prompt1").show(),void($("#colla_suggest_box").hasClass("colla")||($(".suggest_bot_tip").html("<span class=\"left\"><strong><@i18n resource='collaboration.add.collaborationcontacter'/></strong><@i18n resource='global.colon'/></span><span class=\"right\"><strong><@i18n resource='collaboration.add.my_team_members'/></strong><@i18n resource='global.colon'/></span>"),$("#colla_suggest_box").addClass("colla").html('<div class="suggest_colla_box colla_loading"></div>'),UI.getCollaTeamMembers()));Util.ajax({url:"/collaboration/get_new_members",data:{value:e},success:function(e){$(".suggest_bot_tip").html('<strong><@i18n resource="diagraming.collaboation_select_from_list_now"/> </strong>'),$("#colla_suggest_box").removeClass("colla").html(""),$("#colla_suggest_box").html(e),0<$("#colla_suggest_box").find("ul").length?($("#add_prompt4").hide(),$("#add_prompt3").hide(),$("#add_prompt2").show(),$("#add_prompt1").hide()):($("#add_prompt4").hide(),$("#add_prompt3").hide(),$("#add_prompt2").hide(),$("#add_prompt1").show()),$(".colla_suggest").find("li").on("click",function(){var e,t,i;"team"!=$(this).attr("joinType")&&($("#add_prompt4").hide(),$("#add_prompt3").hide(),$("#add_prompt2").show(),$("#add_prompt1").hide(),$.trim($("#input_add_colla").val()),$(".colla_suggest").find("li").removeClass("seled"),$(this).addClass("seled"),e=$(this).attr("joinType"),t=$(this).attr("target"),"user"==e?(i=$(this).attr("username"),$("#input_add_colla").val(i)):$("#input_add_colla").val(t),$("#add_userid").val(t),$("#add_type").val(e))})}})}})},showMoreContacter:function(e,t){var i,o={},l=+$(t).attr("all");"contacters"==e?(i=$(t).parent().find("li[joinType='user']").length,o.source=e,o.split=i):"team"==e&&(i=$(t).parent().find("li[joinType='user']").length,o.source=e,o.teamId=$(t).parent().attr("target"),o.split=i),Util.ajax({url:"/collaboration/get_add_more",data:o,success:function(e){var i,o,n,a=e.users,r="",s="";$.each(a,function(e){var t=a[e];r="/images/default/default/profile-full-male.png",i=t.userId,null!=t.photoFileName&&""!=t.photoFileName&&(r="/file/"+t.photoFileName+"/photo"),o=t.fullName,n=t.email,s+='<li joinType="user" target="'+i+'" username="'+o+'" email="'+n+'"><img src="'+r+'"/>'+o+"</li>"}),$(t).before(s),$(t).parent().find("li[joinType='user']").length==l?$(t).hide():$(t).show(),$(t).parent().scrollTop(9999)}})},getCollaTeamMembers:function(){Util.ajax({url:"/collaboration/get_contacter_team_members",data:{source:"designer"},success:function(e){$("#colla_suggest_box").find(".suggest_colla_box").removeClass("colla_loading").html(e),$(".colla_suggest").find("li").on("click",function(){var d,e,t,i;"team"==$(this).attr("joinType")&&(d=$(this).attr("target"),$(this).hasClass("active")?($(this).removeClass("active"),$(".team_member[target='"+d+"']").hide(),$(".team_member[target='"+d+"']").html(""),$(".team_member[target='"+d+"']").css({background:"url(/images/default/view_loading.gif) center center no-repeat"})):($(this).addClass("active"),$(".team_member[target='"+d+"']").show(),Util.ajax({url:"/collaboration/show_team_member",data:{teamId:d},success:function(e){var i,o,n,t=+e.teamMemberCount,a=+e.firstSize,r=e.users,s="",l="";$.each(r,function(e){l="/images/default/default/profile-full-male.png";var t=r[e];i=t.userId,null!=t.photoFileName&&""!=t.photoFileName&&(l="/file/"+t.photoFileName+"/photo"),o=t.fullName,n=t.email,s+='<li joinType="user" target="'+i+'" username="'+o+'" email="'+n+'"><img src="'+l+'"/>'+o+"</li>"}),a<t&&(s+='<div class="slider" all="'+t+'" onclick="UI.showMoreContacter(\'team\', this)"><span></span></div>'),$(".team_member[target='"+d+"']").css({background:"none"}),$(".team_member[target='"+d+"']").append(s),$(".colla_suggest.team_member").find("li").on("click",function(){$("#add_prompt4").hide(),$("#add_prompt3").hide(),$("#add_prompt2").show(),$("#add_prompt1").hide();$.trim($("#input_add_colla").val());$(".colla_suggest").find("li").removeClass("seled"),$(this).addClass("seled");var e,t=$(this).attr("joinType"),i=$(this).attr("target");"user"==t?(e=$(this).attr("username"),$("#input_add_colla").val(e)):$("#input_add_colla").val(i),$("#add_userid").val(i),$("#add_type").val(t)})}}))),"user"!=$(this).attr("joinType")&&"email"!=$(this).attr("joinType")||($("#add_prompt4").hide(),$("#add_prompt3").hide(),$("#add_prompt2").show(),$("#add_prompt1").hide(),$.trim($("#input_add_colla").val()),$(".colla_suggest").find("li").removeClass("seled"),$(this).addClass("seled"),e=$(this).attr("joinType"),t=$(this).attr("target"),"user"==e?(i=$(this).attr("username"),$("#input_add_colla").val(i)):$("#input_add_colla").val(t),$("#add_userid").val(t),$("#add_type").val(e))})}})},doAddCollaboration:function(){var e,t,i,o,n,a,r;0<$(".colla_suggest").length&&(0==$(".colla_suggest").find(".seled").length?($("#add_prompt1").hide(),$("#add_prompt2").show(),$("#add_prompt3").hide(),$("#add_prompt4").hide(),e=.5*($(window).outerHeight()-104)+100,t=.5*($(window).outerWidth()-272),$("#confirm_dlg").removeClass("newSize").css({top:e+"px",left:t+"px"}),$("#confirm_dlg").addClass("newSize").css({top:.5*($(window).outerHeight()-$("#confirm_dlg").height())+"px",left:.5*($(window).outerWidth()-$("#confirm_dlg").width())+"px",display:"block"})):($(".colla_suggest").find(".seled").find("img").attr("src"),30<(i=$("#input_add_colla").val()).length&&(i=i.substr(0,30)+"..."),o=$("#add_userid").val(),n=$("#invit_role").val(),a=$("#add_type").val(),$(".add_new_button").find(".designer_button").text("<@i18n resource='diagraming.collaboation_sending'/>"),"email"==a&&$(".role_list").find(".role_item").each(function(){$(this).attr("type")==a&&$(this).attr("target")==o&&($(this),$(this).find(".inviting_").text("<@i18n resource='diagraming.collaboation_inviting_again'/>"))}),r={type:a,target:o,role:n,chartId:chartId},Util.ajax({url:"/collaboration/add",data:r,success:function(e){var t=e.result;"exists"==t?($("#add_prompt2").hide(),$("#add_prompt1").hide(),$("#add_prompt4").hide(),$("#add_prompt3").show()):Util.ajax({url:"/collaboration/get_colla_role_list",data:{chartId:chartId},success:function(e){$(".role_list").html(e).scrollTop(999)}}),$(".add_new_button").find(".designer_button").text("<@i18n resource='diagraming.collaboation_send_invitation'/>"),$("#colla_dialog").addClass("_update").css({top:.5*($(window).height()-$("#colla_dialog").outerHeight())+"px"}),"exists"!=t&&setTimeout(function(){$("#add_prompt3").hide(),$("#add_prompt2").hide(),$("#add_prompt1").hide(),$("#add_prompt4").show()},400),setTimeout(function(){$("#add_prompt3").hide(),$("#add_prompt2").hide(),$("#add_prompt4").hide(),$("#add_prompt1").show(),$("#input_add_colla").val(""),$("#colla_suggest_box").hasClass("colla")||($(".suggest_bot_tip").html("<span class=\"left\"><strong><@i18n resource='collaboration.add.collaborationcontacter'/></strong><@i18n resource='global.colon'/></span><span class=\"right\"><strong><@i18n resource='collaboration.add.my_team_members'/></strong><@i18n resource='global.colon'/></span>"),$("#colla_suggest_box").addClass("colla").html('<div class="suggest_colla_box colla_loading"></div>'),UI.getCollaTeamMembers())},1e3)}})))},deleteCollaRole:function(e){var t=$(e).parent(".role_item"),i=t.attr("collaborationId");Util.ajax({url:"/collaboration/delete",data:{collaborationId:i},success:function(e){"success"==e.result&&t.remove()}}),$("#colla_dialog").addClass("_update").css({top:.5*($(window).height()-$("#colla_dialog").outerHeight())+"px"})},changeCollaRole:function(e,t){Util.ajax({url:"/collaboration/set_role",data:{collaborationId:e,role:$(t).val()},success:function(e){"success"==e.result&&$(t).parent(".given_role").find(".change_success").stop().animate({left:"-38px"},200).delay(400).animate({left:"0px"},200)}})},showShapesManage:function(){function i(e){var t=e.val().split(","),i=e.is(":checked");1<t.length?$("#shape_manage_list").find("input").each(function(){var e=$(this).val();0<=t.indexOf(e)&&$(this).attr("checked",i)}):$("#shape_manage_list").find(".cate_parent").each(function(){for(var e=$(this).val().split(","),t=!0,i=0;i<e.length;i++){var o=e[i];if(!$("#shape_manage_list").find("input[value="+o+"]").is(":checked")){t=!1;break}}$(this).attr("checked",t)})}$("#shapes_dialog").dlg(),$("#shape_manage_list").children("li").unbind().bind("click",function(){var e=$(this).find("input"),t=!e.is(":checked");e.attr("checked",t),i(e)}),$("#shape_manage_list").find("input").unbind().bind("click",function(e){e.stopPropagation(),i($(this))}).each(function(){for(var e=$(this).val().split(","),t=!0,i=0;i<e.length;i++){var o=e[i];if(CategoryMapping.network&&"network"==o||CategoryMapping.aws_analytics&&"network_aws"==o||CategoryMapping.cisco_bulidings&&"network_cisco"==o||CategoryMapping.azure&&"network_azure"==o){t=!0;break}if(!CategoryMapping[o]){t=!1;break}}$(this).attr("checked",t)})},operating:!1,saveShapesManage:function(){var e,t;UI.operating||(UI.operating=!0,t={action:"changeSchema",categories:(e=$("#shape_manage_list").find("input:checked:not(.cate_parent)").map(function(){return $(this).val()}).get()).join(",")},CLB.send(t),Designer.setSchema(e,function(){$("#shapes_dialog").dlg("close"),UI.operating=!1}))},showUserMenu:function(e){e.stopPropagation(),$("#user_menu").dropdown({target:$(".user"),position:"right",onSelect:function(e){var t=e.attr("ac");"dia"==t?location.href="/diagrams":"net"==t?location.href="/network":"out"==t&&(location.href="/login/out")}})},showDownload:function(){$("#download_menu").dropdown({target:$("#btn_export"),position:"left",onSelect:function(e){var t=e.attr("ac");t&&UI.exportFile.handle(t)}})},showShareMenu:function(e){e.stopPropagation(),$("#share_menu").dropdown({target:$("#share_btn"),onSelect:function(e){var t=e.attr("ac");"colla"==t?UI.showAddColla():"download"==t||("link"==t?UI.showViewLink():"embed"==t&&UI.showEmbed())}}),$(".share_to_a").off("mousedown").on("mousedown",function(){var n=$(this);Util.ajax({url:"/view/getlink",async:!1,data:{chartId:chartId},success:function(e){var t,i,o;""!=e.viewLinkId&&((t=n.attr("hrefs")).indexOf("/view/link/")<0&&n.attr("hrefs",t.replace("=https://www.processon.com","=https://www.processon.com/view/link/"+e.viewLinkId)),n.hasClass("weixin")?(i=n.attr("hrefs").replace("https://www.processon","http://test.processon"),(o=$("<div><img src='"+i+"&size=180x180'/><div>微信扫一扫 分享</div></div>").appendTo("body")).css({position:"absolute",width:200,height:216,left:"50%",top:"40%",marginLeft:-100,marginTop:-100,textAlign:"center",zIndex:9999999,border:"1px solid #ccc",background:"#fff",boxShadow:"1px 1px 12px #bbb"}),o.find("img").css({width:"180px",height:"180px",marginTop:10}),$(document).on("mousedown.weixin",function(){o.remove()})):window.open(n.attr("hrefs")))}})})},showEmbed:function(){var e,t;""!=chartId&&($("#embed_designer_chart").dlg(),$("#iframe_html").val(""),$(".embed_preview").html(""),e=$("#embed_width").val(),t=$("#embed_height").val(),UI.changeEmbedWH(e,t),$("#iframe_html").select(),$(".embed_size").find("input").keyup(function(){var e=""==$.trim($("#embed_width").val())?340:$.trim($("#embed_width").val()),t=""==$.trim($("#embed_height").val())?160:$.trim($("#embed_height").val()),e=parseInt(e),t=parseInt(t);$(".embed_preview").find("div:first").css({width:e+"px",height:t+"px"}),$(".embed_preview").find("iframe").css({width:e+"px",height:t+"px"}),UI.changeEmbedWH(e,t)}),$("#iframe_html").unbind().bind("click",function(){$(this).select()}),$(".embed_preview").keydown(function(){$(".embed_size").find("input").blur()}))},changeEmbedWH:function(e,t){var i='<iframe id="embed_dom" name="embed_dom" frameborder="0" style="border:1px solid #000;display:block;width:'+e+"px; height:"+t+'px;" src="https://www.processon.com/embed/'+chartId+'"></iframe>';$("#iframe_html").val(i),$(".embed_preview_wrap").css({"margin-top":-t/2+"px","margin-left":-e/2+"px"}),$(".embed_preview").html("").html(i);var o=document.getElementById("embed_dom");o.onload=o.onreadystatechange=function(){o.readyState&&"complete"!=o.readyState||setTimeout(function(){$(".embed_preview .preview_dis").remove(),setTimeout(function(){$(".embed_obj").fadeIn()},100)},400)}},showViewLink:function(){var a,r;""!=chartId&&(a=null,r="",Util.get("/folder/get_chart",{id:chartId},function(e){a=e.chart,r=a.viewLinkId;var t,i,o,n=a.title;$(".create_view_link h3").find("span._tip2").html(n),$("#share_link_win").dlg(),""==r||null==r?UI.showCreateViewLink():(t="off",(i=null)==a.viewPassword&&""==a.viewPassword||(t="on",i=a.viewPassword),UI.showShareViewLink(t,i),o="https://www.processon.com/view/link/"+r,$("#_view_link_input").val(o).select())}))},showCreateViewLink:function(){$(".create_view_link h3").find("span._tip1").html('<@i18n resource="diagraming.create_view_link_tip"/>'),$("#share_link_win").find(".txt").css({width:"390px"}).removeAttr("readonly","readonly"),"zh"===$("#_locale").val()&&$("#share_link_win").find(".txt").css({width:"410px"}),$("#_view_link_input").val("");$(".create_dis").html('<p><@i18n resource="diagraming.create_view_link_declare1"/> </p><p><@i18n resource="diagraming.create_view_link_declare2"/> </p>'),setTimeout(function(){$(".create.designer_button").show()},200)},showShareViewLink:function(e,t){var i="-1px",o="#fff;color:#323232;text-shadow:0px 1px 0px rgba(255,255,255,0.3)";"on"==e&&""!=t&&null!=t&&(i="33px",o="#5da206;color:#fff;text-shadow:0px 1px 0px rgba(0,0,0,0.3)"),$(".create_view_link h3").find("span._tip1").html('<@i18n resource="diagraming.share_this_link_to_view"/> '),$(".create.designer_button").hide(),$("#share_link_win").find(".txt").css({width:"98%"}).attr("readonly","readonly");var n='<p><@i18n resource="diagraming.share_view_link_declare1"/></p><p><a href="javascript:;" onclick="UI.deleteViewLink()"><@i18n resource="diagraming.share_view_link_declare2"/></a>&nbsp;<@i18n resource="diagraming.share_view_link_declare3"/></p><div class="edit_pw_protect" style="background:'+o+';" onclick="UI.changePWState(this)"><span class="pw_protect_on"><@i18n resource="global.on"/></span><span class="pw_protect_off"><@i18n resource="global.off"/></span><div class="pw_protect_watch" style="left: '+i+';"></div></div><div class="password_input_w"><input type="text" class="_pw txt" value="" placeholder=\'<@i18n resource="global.password"/>\' /><span class="button add_pw_btn" onclick="UI.addViewLinkPassword(this)"><@i18n resource="global.add"/> </span><div style="clear:both;"></div></div>';$(".create_dis").html(n),"on"==e&&""!=t&&null!=t&&($(".button.add_pw_btn").text('<@i18n resource="golbal.change"/>'),$(".password_input_w").show().find("._pw").val(t))},createViewLink:function(e){Util.ajax({url:"/view/addlink",data:{chartId:chartId},success:function(e){UI.showShareViewLink("off");var t="https://www.processon.com/view/link/"+e.viewLinkId;$("#_view_link_input").val(t).select()}})},deleteViewLink:function(){Util.ajax({url:"/view/dellink",data:{chartId:chartId},success:function(e){UI.showCreateViewLink()}})},changePWState:function(e){var t=$(e).find(".pw_protect_watch")[0];-1==t.offsetLeft?($(t).css({left:"33px"}),$(".button.add_pw_btn").text('<@i18n resource="global.add"/>'),$(".password_input_w").show().find("._pw").val("").focus()):Util.ajax({url:"/view/removepassword",data:{chartId:chartId},success:function(e){$(t).css({left:"-1px"}),$(".edit_pw_protect").css({background:"#fff",color:"#323232","text-shadow":"0px 1px 0px rgba(255,255,255,0.3)"}),$(".password_input_w").find("._pw").val(""),$(".password_input_w").hide()}})},addViewLinkPassword:function(e){var t=$.trim($(e).parent().find("._pw").val());if(""==t)return $("._pw").focus(),!1;Util.ajax({url:"/view/addpassword",data:{viewPassword:t,chartId:chartId},success:function(e){$(".edit_pw_protect").css({background:"#5da206",color:"#fff","text-shadow":"0px 1px 0px rgba(0,0,0,0.3)"}),$(".button.add_pw_btn").text('<@i18n resource="golbal.change"/>')}})},showPublish:function(e){if(e)return $("#unpublish_dialog").dlg("close"),void $("#publish_dialog").dlg();"public"==cstatus?$("#unpublish_dialog").dlg():$("#publish_dialog").dlg()},savePublish:function(){var e,t=$("#publish_category").val(),i=$("#publish_language").val(),o=$("#publish_description").val(),n=$("#publish_tags").val();""!=$.trim(n)?""!=$.trim(o)?(e=n.replace("，",",").split(","),Utils.removeFromArray(e,""),0!=e.length?($("#publish_dialog_savebtn").disable(),$.ajax({url:"/folder/publish",data:{id:chartId,status:"public",language:i,industry:t,description:o,tags:e,_public_edit:$("#public_edit").is(":checked"),_public_clone:$("#public_clone").is(":checked")},traditional:!0,success:function(e){$("#publish_dialog_savebtn").enable()}}),cstatus="public",$("#publish_dialog").dlg("close")):$("#publish_tags").focus()):$("#publish_description").focus():$("#publish_tags").focus()},cancelPublish:function(){$.ajax({url:"/folder/publish",data:{id:chartId,status:"private"},success:function(e){"overed"==e.result?UI.showTip("<@i18n resource='network.privilege.filecounttip6'/> <a target='_blank' href='/support/privatefile'><@i18n resource='network.privilege.exnted'/></a>"):cstatus="private"}}),$("#unpublish_dialog").dlg("close")},showSaveAs:function(){$("#saveas_dialog").dlg(),$("#saveas_title").val($(".diagram_title").text()).select()},doSaveAs:function(){""!=$("#saveas_title").val().trim()?($("#hid_saveas_id").val(chartId),$("#saveas_form").submit(),$("#btn_dosaveas").removeAttr("onclick")):$("#saveas_title").focus()},showShapeOptions:function(){var e=Utils.getSelectedShapeIds();if(UI.hideShapeOptions(),1==e.length){var u=Model.getShapeById(e[0]);if("uiTab"==u.name){for(var t=0,i=0;i<u.path.length-1;i++){if(void 0===u.path[i].fillStyle){t=i+1;break}}a(u,[{label:"<@i18n resource='diagraming.options.tabs'/>",type:"spinner",value:u.path.length-1,onChange:function(e){for(var t=0,i=0;i<u.path.length-1;i++){if(void 0===u.path[i].fillStyle){t=i;break}}var o=u.path[u.path.length-1];if(e!=u.path.length-1){e-1<t&&(t=e-1,$("#change_uitab_index").spinner("setValue",e)),u.path=[];for(var n=[],i=0;i<e;i++){var a,r={actions:[{action:"move",x:"w/"+e+"*"+i,y:"h"},{action:"line",x:"w/"+e+"*"+i,y:7},{action:"quadraticCurve",x1:"w/"+e+"*"+i,y1:0,x:"w/"+e+"*"+i+"+7",y:0},{action:"line",x:"w/"+e+"*"+(i+1)+"-7",y:0},{action:"quadraticCurve",x1:"w/"+e+"*"+(i+1),y1:0,x:"w/"+e+"*"+(i+1),y:7},{action:"line",x:"w/"+e+"*"+(i+1),y:"h"}]};i!=t&&(r.fillStyle={color:"r-20,g-20,b-20"},r.actions.push({action:"close"})),u.path.push(r),i<u.textBlock.length?((a=u.textBlock[i]).position.x="w/"+e+"*"+i+"+5",a.position.w="w/"+e+"-10",n.push(a)):n.push({position:{x:"w/"+e+"*"+i+"+5",y:5,w:"w/"+e+"-10",h:"h-10"},text:"Tab "+(i+1)})}u.textBlock=n,u.path.push(o),Schema.initShapeFunctions(u),Model.update(u),Designer.painter.renderShape(u),$("#change_uitab_index").spinner("setOptions",{max:e})}}},{id:"change_uitab_index",label:"<@i18n resource='diagraming.options.selected'/>",type:"spinner",value:t,max:u.path.length-1,onChange:function(e){for(var t=0,i=0;i<u.path.length-1;i++){if(void 0===u.path[i].fillStyle){t=i;break}}t!=e-1&&(u.path[t].fillStyle={color:"r-20,g-20,b-20"},u.path[t].actions.push({action:"close"}),delete u.path[e-1].fillStyle,u.path[e-1].actions.splice(6,1),Schema.initShapeFunctions(u),Model.update(u),Designer.painter.renderShape(u))}}])}else if(u.attribute.collapsable)a(u,[{type:"button",value:u.attribute.collapsed?"<@i18n resource='diagraming.options.expand'/>":"<@i18n resource='diagraming.options.collapse'/>",onClick:function(e){MessageSource.beginBatch();var t=[];if(u.attribute.markers||(u.attribute.markers=[]),u.attribute.collapsed){for(var i=Utils.getCollapsedShapesById(u.id),o=0;o<i.length;o++){delete(s=i[o]).attribute.collapseBy,t.push(s),Designer.painter.renderShape(s)}for(var n=Utils.getOutlinkers(i),o=0;o<n.length;o++){delete(d=n[o]).attribute,t.push(d),Designer.painter.renderLinker(d)}Utils.removeFromArray(u.attribute.markers,"expand"),u.attribute.container=!0,u.attribute.collapsed=!1;var a=u.attribute.collapseW?u.attribute.collapseW:400,r=u.attribute.collapseH?u.attribute.collapseH:300;Designer.setShapeProps({w:a,h:r},[u]),e.text("<@i18n resource='diagraming.options.collapse'/>")}else{for(var s,l=Utils.getContainedShapes([u]),o=0;o<l.length;o++){void 0===(s=l[o]).attribute&&(s.attribute={}),s.attribute.collapseBy=u.id,t.push(s),Designer.painter.renderShape(s)}for(var d,n=Utils.getOutlinkers(l),o=0;o<n.length;o++){(d=n[o]).attribute={collapseBy:u.id},t.push(d),Designer.painter.renderLinker(d)}u.attribute.markers.push("expand"),u.attribute.container=!1,u.attribute.collapsed=!0,u.attribute.collapseW=u.props.w,u.attribute.collapseH=u.props.h,Designer.setShapeProps({w:120,h:80},[u]),e.text("<@i18n resource='diagraming.options.expand'/>")}0<t.length&&Model.updateMulti(t),Utils.selectShape(u.id),MessageSource.commit()}}]);else if("uiGrid"==u.name){for(var h=1,g=1,o=u.path[2],i=0;i<o.actions.length-1;i++){var n=o.actions[i];"move"==n.action&&0==n.x?h++:"move"==n.action&&0==n.y&&g++}a(u,[{id:"change_uigrid_row",label:"<@i18n resource='diagraming.options.row'/>",type:"spinner",value:h,onChange:function(e){var t=u.path[1].actions;t[2].y="h/"+e+"+0.5",t[3].y="h/"+e+"+0.5";for(var i=[],o=1;o<e;o++){var n="Math.round(h*"+o+"/"+e+")+0.5";i.push({action:"move",x:0,y:n}),i.push({action:"line",x:"w",y:n})}for(o=0;o<u.path[2].actions.length;o++){var a=u.path[2].actions[o];0!=a.y&&"h"!=a.y||i.push(a)}u.path[2].actions=i;var r=0,s=0;if(h<e){for(var l=0;l<u.textBlock.length;l++){(p=u.textBlock[l]).position.y="h/"+e+"*"+s,p.position.h="h/"+e,++r==g&&(r=0,s++)}for(r=0;s<e;){for(;r<g;){var d={x:"w/"+g+"*"+r+"+5",y:"h/"+e+"*"+s,w:"w/"+g+"-10",h:"h/"+e};u.textBlock.push({position:d}),r++}r=0,s++}}else if(e<h){for(var c=[];s<e;){for(;r<g;){var p,l=s*g+r;(p=u.textBlock[l]).position.y="h/"+e+"*"+s,p.position.h="h/"+e,c.push(p),r++}r=0,s++}u.textBlock=c}Schema.initShapeFunctions(u),Model.update(u),Designer.painter.renderShape(u),h=e}},{id:"change_uigrid_column",label:"<@i18n resource='diagraming.options.column'/>",type:"spinner",value:g,onChange:function(e){for(var t=[],i=0;i<u.path[2].actions.length;i++){var o=u.path[2].actions[i];if(0!=o.x&&"w"!=o.x)break;t.push(o)}for(i=1;i<e;i++){var n="Math.round(w*"+i+"/"+e+")+0.5";t.push({action:"move",x:n,y:0}),t.push({action:"line",x:n,y:"h"})}var a=0,r=0;if(g<e){for(var s=[],l=0;l<u.textBlock.length;l++){if((c=u.textBlock[l]).position.x="w/"+e+"*"+a+"+5",c.position.w="w/"+e+"-10",s.push(c),++a==g){for(;a<e;){var d={position:{x:"w/"+e+"*"+a+"+5",y:"h/"+h+"*"+r,w:"w/"+e+"-10",h:"h/"+h}};0==r&&(d.text="<@i18n resource='schema.ui.grid.head'/> "+(a+1)),s.push(d),a++}a=0,r++}}u.textBlock=s}else if(e<g){for(s=[];r<h;){for(;a<e;){var c,l=r*g+a;(c=u.textBlock[l]).position.x="w/"+e+"*"+a+"+5",c.position.w="w/"+e+"-10",s.push(c),a++}a=0,r++}u.textBlock=s}u.path[2].actions=t,Schema.initShapeFunctions(u),Model.update(u),Designer.painter.renderShape(u),g=e}}])}}function a(e,t){var i=$("#shape_opt_box");0==i.length&&((i=$("<div id='shape_opt_box'><div class='shape_opts'></div><div class='ico dlg_close'></div></div>").appendTo("#designer_canvas")).bind("mousedown",function(e){e.stopPropagation()}).bind("mousemove",function(e){e.stopPropagation()}),i.children(".dlg_close").bind("click",function(e){i.hide()})),i.show();var o=Utils.getShapeBox(e);i.css({left:o.x+o.w+10,top:o.y,"z-index":Model.orderList.length+1});var n=i.children(".shape_opts");n.empty();for(var a=0;a<t.length;a++){var r,s,l,d=t[a],c=$("<div class='opt'></div>").appendTo(n);"spinner"==d.type?(c.append("<label>"+d.label+"</label>"),r=$("<div class='field'></div>").appendTo(c),s=$("<div class='spinner active' style='width: 55px;'></div>").appendTo(r),d.id&&s.attr("id",d.id),s.spinner({min:1,max:void 0!==d.max?d.max:20,step:1,onChange:d.onChange}),s.spinner("setValue",d.value)):"button"==d.type&&(l=$("<div class='button_box'></div>").appendTo(c),$("<div class='toolbar_button active'>"+d.value+"</div>").appendTo(l).bind("click",function(){d.onClick($(this))}))}}},hideShapeOptions:function(){$("#shape_opt_box").hide()},toogleTitleBar:function(){var e=$("#bar_collapse").children("div");return e.hasClass("collapse")?(e.attr("class","ico expand"),$(".titlebar").slideUp(200),$(".layout").animate({height:$(window).height()-73},200),$("#bar_return").show(),!1):(e.attr("class","ico collapse"),$(".titlebar").slideDown(200),$(".layout").animate({height:$(window).height()-143},200),$("#bar_return").hide(),!0)},showThemeSelect:function(){var e=$("#bar_theme");if(e.hasClass("selected"))e.removeClass("selected");else{if(e.removeClass("selected"),$(".header-op-item.selected").not("[tit=bar_font_bold], [tit=bar_font_italic], [tit=bar_font_underline], [tit=dock_btn_navigator]").removeClass("selected"),e.addClass("selected"),$("#themes").dropdown({position:"left",target:e}),0==$("#themes").children(".theme_box").length)for(var t in Schema.themes){var i=Schema.themes[t],o=$("<div theme='"+t+"' class='theme_box'><canvas width='130' height='130'></canvas></div>").appendTo($("#themes"));o.bind("click",function(){var e=$(this).attr("theme");UI.setTheme(e),tdocCollect({opername:"flowchart",module:"style",action:"style",ver5:$(this).index()+1})});var n=o.children("canvas")[0].getContext("2d");n.save(),n.fillStyle="rgb("+i.shape.fillStyle.color+")",n.lineWidth=i.shape.lineStyle.lineWidth,n.strokeStyle="rgb("+i.shape.lineStyle.lineColor+")",n.beginPath(),n.moveTo(10,14),n.quadraticCurveTo(10,10,14,10),n.lineTo(81,10),n.quadraticCurveTo(85,10,85,14),n.lineTo(85,51),n.quadraticCurveTo(85,55,81,55),n.lineTo(14,55),n.quadraticCurveTo(10,55,10,51),n.closePath(),n.closePath(),n.fill(),n.stroke(),n.beginPath(),n.moveTo(140,70),n.lineTo(100,100),n.lineTo(140,130),n.closePath(),n.fill(),n.stroke(),n.restore(),n.fillStyle="rgb("+i.linker.lineStyle.lineColor+")",n.lineWidth=i.linker.lineStyle.lineWidth,n.strokeStyle="rgb("+i.linker.lineStyle.lineColor+")",n.beginPath(),n.moveTo(47,56),n.lineTo(47,100),n.lineTo(90,100),n.stroke(),n.beginPath(),n.moveTo(83,96),n.lineTo(95,100),n.lineTo(83,104),n.closePath(),n.fill(),n.stroke(),n.textAlign="center",n.textBaseline="middle";var a="";i.shape.fontStyle.italic&&(a+=" italic"),i.shape.fontStyle.bold&&(a+=" bold"),a+=" "+i.shape.fontStyle.size+"px "+i.shape.fontStyle.fontFamily,n.font=a,n.fillStyle="rgb("+i.shape.fontStyle.color+")",n.fillText("<@i18n resource='diagraming.theme.text.process'/>",47,32),a="",i.linker.fontStyle.italic&&(a+=" italic"),i.linker.fontStyle.bold&&(a+=" bold"),a+=" "+i.linker.fontStyle.size+"px "+i.linker.fontStyle.fontFamily,n.font=a,n.fillStyle="rgb("+i.linker.fontStyle.color+")",n.clearRect(30,71,30,18),n.fillText("<@i18n resource='diagraming.theme.text.yes'/>",47,80)}$("#themes").append("<div style='clear:both'></div>")}},setTheme:function(e){var t=Schema.themes[e];Model.setTheme(t),$("#themes").dropdown("close")},setDefaultStyle:function(e){var t=Designer.op.setDefaultStyle();if(null!=t&&"error"==t)return UI.showTip("<@i18n resource='diagraming.defaultStyle.tip1'/>"),void setTimeout(function(){UI.hideTip()},1e3);e.find("[click-btn]").show()},showTip:function(e,t,i){t=t||"center";var o=$("#designer_ui_tip");0==o.length&&((o=$("<div id='designer_ui_tip'><div class='ui_tip_text'></div></div>").appendTo("#designer_viewport")).append("<div class='mind-icons ui_tip_close'>&#xe6fc;</div>"),o.children(".ui_tip_close").bind("click",function(){UI.hideTip()})),i?o.children(".ui_tip_close").bind("click.callback",function(){i()}):o.children(".ui_tip_close").unbind("click.callback"),o.children(".ui_tip_text").html(e),"center"==t?o.css("left",($("#designer_viewport").width()-o.outerWidth())/2):o.css("left","20px"),o.fadeIn("fast")},hideTip:function(){$("#designer_ui_tip").hide()},RGB2Hex:function(e){if("#"==e.charAt(0))return e;var t=e.split(/\D+/),i=65536*Number(t[1])+256*Number(t[2])+Number(t[3]);return""+UI.toHex(i,6)},toHex:function(e,t){for(var i=e.toString(16);i.length<t;)i="0"+i;return i},hex2RGB:function(e){if(e&&/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/.test(e)){if(4===e.length){for(var t="#",i=1;i<4;i+=1)t+=e.slice(i,i+1).concat(e.slice(i,i+1));e=t}for(var o=[],i=1;i<7;i+=2)o.push(parseInt("0x"+e.slice(i,i+2)));return o.join(",")}return e},showDropdown:function(e,t,i,o,n){var a;e.hasClass("selected")?e.removeClass("selected"):(e.addClass("selected"),$(".header-op-item.selected").not("[tit=bar_font_bold], [tit=bar_font_italic], [tit=bar_font_underline], [tit=dock_btn_navigator]").removeClass("selected"),e.addClass("selected"),a=o||"left",t.dropdown({target:e,position:a,top:n,onSelect:function(e){i(e)}}))},showDrawer:function(e){var t,i;e.hasClass("drawer-open")||(t=$(".drawer-open"),i=e.outerWidth(),0==t.length?(e.addClass("drawer-open"),$("#designer_viewport").css("marginRight",i+"px")):(t.removeClass("drawer-open"),e.addClass("drawer-open")),e.find(".header_box").off().on("click",".close",function(){e.removeClass("drawer-open"),$("#designer_viewport").css("marginRight",0),Dock.currentView=""}),e.off().on("click",".dock_group_title",function(){$(this).toggleClass("closed"),$(this).siblings(".dock_group_content").stop().slideToggle(100)}))},showVipLimitDlg:function(t){var e="";(-1<tdocVipInfo.indexOf(101)||-1<tdocVipInfo.indexOf("101"))&&(e="type3");var i,o,n,a=vipLimitTitle[t+e],r=vipLimitTxt[t+e],s=$(".tdoc-vip-dlg");s.length<1||(-1<tdocVipInfo.indexOf(101)||-1<tdocVipInfo.indexOf("101")?($(".footerStyle").children().hide(),$(".footerStyle").children(".tipStyle").show()):($(".footerStyle").children().show(),$(".footerStyle").children(".tipStyle").hide()),s.find("h3").text(a),s.find(".tdoc-vip-content").html("<span>"+r+"</span>"),s.find(".confirmStyle").html("立即开通"),i="mind",o="node",-1<t.indexOf("download")&&(i="download",o=-1<t.indexOf("pnghd")?"PNG":-1<t.indexOf("pdf")?"PDF":-1<t.indexOf("jpg")?"JPG":-1<t.indexOf("pos")?"POS":""),-1<t.indexOf("pasteimg")&&(i="paste",o="screencut"),n=vipOrderPosition[t].replace("_po_","_act_"),s.dlg({onClose:function(){Designer.status="",$(".trigger_vip_dlg").removeClass("trigger_vip_dlg"),tdocCollect({opername:i,module:o,action:n,ver5:1,ver6:""})}}),poCollect("fun_viplimit",{limit:vipOrderPosition[t],page:"flow_editor",userId:userId,vip:tdoc_is_vip,povip:po_is_vip,device:deviceType}),$(".footerStyle").off("click.cancel").on("click.cancel",".cancelStyle, .tipStyle",function(e){e.stopPropagation(),s.dlg("close")}),$(".footerStyle").off("click.ok").on("click.ok",".confirmStyle",function(e){e.stopPropagation(),UI.upgradeVip(t),tdocCollect({opername:i,module:o,action:n,ver5:2,ver6:""})}))},setTopUpgradeBtn:function(){var e=document.querySelector("#top-wps-upgrade-btn");tdocVipInfo.indexOf(40)<0&&(-1<tdocVipInfo.indexOf(20)||-1<tdocVipInfo.indexOf(12))?$(e).css("display","none"):(-1<tdocVipInfo.indexOf(40)?(e.innerText="续费超级会员",UI.topUpgradeBtnVal="renew"):UI.topUpgradeBtnVal="open",$(e).css("display","inline-block"))},setTopUpgradeBtnB:function(){var e=$(".footer-left-con"),t=e.find("#bot-nodevip-btn");0<t.length&&t.remove(),(t=$('<div title="当前上限60，升级节点数上限" title_pos="top" id="bot-nodevip-btn" class="bot-nodevip-btn">升级上限</div>')).appendTo(e),-1<tdocVipInfo.indexOf(30)||-1<tdocVipInfo.indexOf(40)?t.hide():(t.css("display","inline-block"),-1<tdocVipInfo.indexOf(20)?t.attr("title","当前上限180，升级节点数上限"):t.attr("title","当前上限60，升级节点数上限"))},setDocerUpgradeBtn:function(){var e=$("#img-docer-vip-btn");-1<tdocVipInfo.indexOf(40)||-1<tdocVipInfo.indexOf(12)?e.hide():e.show()},showUploading:function(){var e=$("<div class='uploading-tip'><span class='left_arrow'><img src='/assets/images/tip_loading.png' class='rotate1' /></span><span>加载中...</span></div>");e.appendTo("body"),e.css("opacity",1).show()},hideUploading:function(){$(".uploading-tip").remove()},newfile:function(e){var t="/diagrams/flow";"_blank"==e&&(t="/new.jsp?type=flow&wpsid="+wpsId),window.open(t)},getUrlParams:function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),i=window.location.search.substr(1).match(t);return null!=i?unescape(i[2]):null},showShareBtn:function(e){JSON.parse(e).result&&($("#top-wps-share-btn").show(),$("#top-wps-share-btn").off("click").on("click",function(){file_id,group_id,title}))},waterMark:{data:{wrapW:552,wrapH:301,imgW:0,imgH:0,bg:""},init:function(){var i=this,o=$("#watermark-dlg .watermark-text .input_text");Designer.setZoomScale(1),Utils.unselect(),$("#svg-view-wrap").html(""),this.inputTip("",!0),-1==tdocVipInfo.indexOf(40)&&$("#watermark-dlg .watermark-submit-button img").show(),$("#watermark-dlg").off("mousedown").on("mousedown",function(e){e.stopPropagation()}),Model.define.page.watermark?o.val($("<span/>").html(Model.define.page.watermark).text()).focus():o.val("").focus(),setTimeout(function(){var e=flow2svg.init("svg",!0,!0),t=Model.define.page;i.data.imgW=e.w,i.data.imgH=e.h,null==t.backgroundColor||"transparent"==t.backgroundColor?i.data.bg="rgb(255,255,255)":i.data.bg=t.backgroundColor,i.watermarkImgView()},300),o.unbind("input propertychange").bind("input propertychange",function(e){e.stopPropagation();var t=$.trim($(this).val());!i.inputTip(t)&&""!=t||i.setWatermarkView(t)}),$(".watermark-submit-button").off("click").on("click",function(){var e,t=$.trim(o.val());o.val(t),i.inputTip(t)&&(-1<tdocVipInfo.indexOf(40)?(e=i.byteCut(t,30),Designer.setPageStyle({watermark:e}),$("#watermark-dlg").dlg("close")):UI.showVipLimitDlg("insert_watermark"))})},inputTip:function(e,t){return""!=e||t?($("#watermark-dlg .watermark-text .input_text").removeClass("error"),$("#watermark-dlg .watermark-text .text-tip").removeClass("error").text("可输入30个字符，约15个汉字，超出部分将不显示"),!0):($("#watermark-dlg .watermark-text .input_text").addClass("error"),$("#watermark-dlg .watermark-text .text-tip").addClass("error").text("请先输入水印文字"),!1)},setWatermarkView:function(e){var t=this.byteCut(e,30);$("#svg-view-wrap #pattern_mark text")[0].textContent=$("<span/>").html(t).text()},watermarkImgView:function(){var e=this.data,t=e.imgW>e.wrapW?e.imgW-e.wrapW:0,i=e.imgH>e.wrapH?e.imgH-e.wrapH:0,d=$("#watermark-dlg .watermark-preview"),o=$("#svg-view-wrap");o.css({backgroundColor:e.bg,width:e.imgW,height:e.imgH}),$("#svg-view-wrap #mind-svg-view-con").css({transform:"translate(-50% , -50%)"}),t||i?(o.addClass("move"),d.scrollLeft(t/2),d.scrollTop(i/2),o.off("mousedown").on("mousedown",function(e){e.stopPropagation();var a=d.scrollLeft(),r=d.scrollTop(),s=e.pageX,l=e.pageY;$(document).off("mousemove.watermarkView").on("mousemove.watermarkView",function(e){e.stopPropagation();var t=e.pageX,i=e.pageY,o=Math.round(a-(t-s)),n=Math.round(r-(i-l));d.scrollLeft(o),d.scrollTop(n)}),$(document).off("mouseup.watermarkView").on("mouseup.watermarkView",function(e){e.stopPropagation(),$(document).off("mousemove.watermarkView"),$(document).off("mouseup.watermarkView")})})):(o.removeClass("move"),d.scrollLeft(0),d.scrollTop(0))},byteCut:function(e,t){if(""==e)return e;for(var i="",o=0,n=/[^\u0000-\u00ff]/,a=0;a<e.length;a++){var r=e[a];if(n.test(r)){if(t<o+2)break;o+=2,i+=r}else{if(t<o+1)break;o++,i+=r}}return $("<span/>").text(i).html()}}},vipLimitTitle={addShape:"无法添加图形",addShapetype3:"无法添加图形",addShape_svip:"无法添加图形",addShape_sviptype3:"无法添加图形",download_pos:"无法导出POS",download_svg:"当前账号不支持导出svg格式文件，如有需要，请开通超级会员。",download_jpg:"无法导出JPG",download_jpgtype3:"无法导出JPG",download_pdf:"无法导出PDF",download_pdftype3:"无法导出PDF",download_pnghd:"无法导出高清PNG",download_pnghdtype3:"无法导出高清PNG",download_postype3:"无法导出POS",screenshot:"无法粘贴图片",screenshottype3:"无法粘贴图片",addHistory:"免费账户不支持手动创建历史版本，升级会员可以享受更多高级功能",docer_image:"免费账户不支持使用稻壳会员免费图片",insert_watermark:"当前账号不支持自定义水印，如有需要，请开通超级会员"},vipLimitTxt={addShape:"开通文档超级尊享图形无限添加特权。",addShapetype3:"已达上限，无法继续添加图形。",addShape_svip:"开通文档超级尊享图形无限添加特权。",addShape_sviptype3:"已达上限，无法继续添加图形。",download_pnghd:"开通文档超级会员即可导出高清PNG、JPG、PDF、POS。",download_pnghdtype3:"当前账号不支持导出高清png格式文件。",download_jpg:"开通文档超级会员即可导出高清PNG、JPG、PDF、POS。",download_jpgtype3:"当前账号不支持导出jpg格式文件。",download_pdf:"开通文档超级会员即可导出高清PNG、JPG、PDF、POS。",download_pdftype3:"当前账号不支持导出pdf格式文件。",download_pos:"开通文档超级会员即可导出高清PNG、JPG、PDF、POS。",download_postype3:"当前账号不支持导出pos格式文件。",download_svg:"当前账号不支持导出svg格式文件。",download:"免费账户不支持下载pos格式、svg格式",screenshot:"开通文档超级会员可粘贴图片。",screenshottype3:"当前账号无法粘贴图片。",addHistory:"免费账户不支持手动创建历史版本，升级会员可以享受更多高级功能",docer_image:"免费账户不支持使用稻壳会员免费图片",insert_watermark:"当前账号不支持自定义水印，如有需要，请开通超级会员"},limitType="",Device_platform=UI.getUrlParams("platform")||1e3,limitAid_platform={1e3:"wdweb",1001:"ios",1002:"an",1003:"wdmac",1004:"wdpc"},vipOrderPosition={addShape:limitAid_platform[Device_platform]+"_flow_po_graphslimit",addShape_svip:limitAid_platform[Device_platform]+"_flow_po_graphsunlimit",download_pnghd:limitAid_platform[Device_platform]+"_flow_po_downloadpnghd",download_jpg:limitAid_platform[Device_platform]+"_flow_po_downloadjpg",download_pdf:limitAid_platform[Device_platform]+"_flow_po_downloadpdf",download_pos:limitAid_platform[Device_platform]+"_flow_po_downloadpos",screenshot:limitAid_platform[Device_platform]+"_flow_po_pastescreenshot",nodecout_warn:limitAid_platform[Device_platform]+"_flow_po_graphsalert",leftdown_nodecout:limitAid_platform[Device_platform]+"_flow_po_graphsshow"},dwVipPostion={addShape:"shape_vip",addShape_svip:"shape_svip",download_pos:"edit_export",download_svg:"edit_export",download_pnghd:"edit_export",download_jpghd:"edit_export",download_pdfhd:"edit_export",download:"edit_export",pasteimg:"pasteimg",top_contrast:"contrast",download_vip_contrast:"edit_introduce","docer-upsvip":"docer_upgrade",topright:"top_right","yunsave-spacefull":"flow_edit_spacefull",insert_watermark:"insert_watermark"},paySubmiting=!1,wpsServerId={wps:"processon_flow_chart",docer:"docer_flow_tree",common:"common_flow_tree"},upgradePosFlag="docer",ViphitsPosition="",orderPayfunc={wpsyun:function(){var e;paySubmiting||(paySubmiting=!0,e=vipOrderPosition[vipUpgradePos],"docer"==upgradePosFlag&&(e="|a|"+vipOrderPosition[vipUpgradePos]+"_"+ViphitsPosition+csourceUserVip),console.log("csource="+e,"serverId="+wpsServerId[upgradePosFlag]),$.ajax({url:"/order/upgrade",data:{userid:userId,fileType:"flow",serverId:wpsServerId[upgradePosFlag],csource:e},dataType:"json",success:function(e){paySubmiting=!1,"success"!=e.result||window.parent.postMessage(JSON.stringify({eventName:"pom_pay",orderId:e.billno}),"*")},error:function(e){paySubmiting=!1}}))},wpsclient:function(){var e;paySubmiting||(paySubmiting=!0,e=vipOrderPosition[vipUpgradePos],"docer"==upgradePosFlag&&(e="|a|"+vipOrderPosition[vipUpgradePos]+"_"+ViphitsPosition+csourceUserVip),console.log("csource="+e,"serverId="+wpsServerId[upgradePosFlag]),$.ajax({url:"/order/upgrade",data:{userid:userId,fileType:"flow",serverId:wpsServerId[upgradePosFlag],csource:e},dataType:"json",success:function(e){paySubmiting=!1,"success"!=e.result||wpsInstance.pay.buy(e.billno,"","超级会员","",function(e){wpsVipInit(e.vipInfo),UI.setTopUpgradeBtnB(),UI.setDocerUpgradeBtn(),(-1<tdocVipInfo.indexOf(40)||-1<tdocVipInfo.indexOf(20))&&$(".vip-dlg").dlg("close")})},error:function(e){paySubmiting=!1}}))}},smartAiHelpCon={params:{width:"320px",height:"770px",newclass:"",hotCon:"",guide:!0,subUnit:!1,designerType:1,channel:1,tutorial:"45%",extra:!0,resultNum:5},init:function(e){var i=this,t=$("#right-help-con"),o=i.params=$.extend({},this.params,e);if(t.length<1){t=$("<div id='right-help-con' class='right-help-con'></div>").appendTo("body").hide(),o.newclass&&t.addClass(o.newclass);var n=$("<div class='brain-power-search-input'><span class='search-btn mind-icons'>&#xe691;</span><input id='powerIpt' autocomplete='off' class='power-input search-input' type='text' placeholder='搜索你想要的功能' /><div class='search-hot tag-box'><div class='hot-temp'></div></div><div class='power-search-del' style='display:none'><i class='mind-icons'>&#xe634;</i></div></div>");t.append(n);var a=$("<div class='tag-box power-hot-tag colle-box' style='display:none'><h6>热搜</h6><div class='hot-temp'></div></div>");t.append(a);var r=$("<div class='power-search-result' style='display: none'></div>");if(t.append(r),o.subUnit){var s=o.subUnit,l="";if("string"==typeof s)l=s;else{if(!(s instanceof Array))return;$.each(s,function(e,t){l+=t})}t.append(l)}t.css({top:o.top,left:o.left,right:o.right,width:o.width,height:o.height}),this.spread()}var d,c=$(".brain-power-search-input"),p=c.find(".power-search-del"),u=$("#powerIpt");u.off().on({keydown:function(e){e.stopPropagation()},keyup:function(e){e.stopPropagation()},input:function(e){d=e.timeStamp,setTimeout(function(){d==e.timeStamp&&u.siblings(".search-btn").trigger("click")},400)},focus:function(e){e.preventDefault();var t=u.val();if(""==t)i.hotLabelHideorShow("hide","show");else{if(i.hotLabelHideorShow("hide","hide"),"block"==$(".power-search-result").css("display"))return;i.powerSearch(t)}o.extra||$("#extra-box").hide(),p.show()},blur:function(e){""==u.val()?(setTimeout(function(){i.hotLabelHideorShow("show","hide")},10),o.extra||$("#extra-box").show(),p.hide()):i.hotLabelHideorShow("hide","hide"),e.stopPropagation()}}),c.off("click.search").on("click.search",".search-btn",function(e){var t=u.val();""!=t?(i.powerSearch(t),i.hotLabelHideorShow("hide","hide"),p.show()):($(".power-search-result").hide(),i.hotLabelHideorShow("hide","show"),p.hide()),e.stopPropagation()}),c.off("click.del").on("click.del",".power-search-del",function(){u.val(""),$(".power-search-result").hide(),i.hotLabelHideorShow("show","hide"),$("#extra-box").css("display","block"),p.hide()}),$(".search-hot").off("click.hot").on("click.hot",".hot-item",function(e){e.stopPropagation();var t=$(this).text();t!=u.val()&&(u.val(t),u.focus())}),$(".power-hot-tag, .power-search-result").off("mousedown").on("mousedown",".hot-item",function(e){e.stopPropagation();var t=$(this).text(),i=u.val();u.focus(),t!=i&&(u.val(t),u.siblings(".search-btn").trigger("click"))}),$("#right-help-con").off("mousedown.helpcon").on("mousedown.helpcon",function(e){e.stopPropagation()}),i.getHotCon(o)},receiveHot:!1,getHotCon:function(n){var e,a=this;a.receiveHot||(e="https://ai.processon.com/searchTag/"+n.channel+"/"+n.designerType,$.ajax({url:e,type:"POST",success:function(e){if("success"==e.result){if("success"==e.result){if(null==e.data)return;n.hotCon=e.data.tag;var t=n.hotCon.split(","),i="",o="";$.each(t,function(e,t){return!(3<e)&&(e<2&&(i+="<span class='hot-item'>"+t+"</span>"),void(o+="<span class='hot-item'>"+t+"</span>"))})}$(".brain-power-search-input").find(".hot-temp").html(i),$(".power-hot-tag").find(".hot-temp").html(o),a.receiveHot=!0}},error:function(){console.log("error")}}))},resultLoading:!1,powerSearch:function(p){var u,e,h=this;h.resultLoading||(h.resultLoading=!0,u=$(".power-search-result"),e=JSON.stringify({keyword:p,designerType:h.params.designerType,channel:h.params.channel}),$.ajax({url:"https://ai.processon.com/search",type:"POST",contentType:"application/json",data:e,success:function(e){if("success"==e.result){var t=e.data,i=t.toolbarList,o=t.docList,n=[];if(!t.elementsCount||t.elementsCount<1){if(0<$(".tag-box.empty-rec").length)return h.resultLoading=!1,void u.show();u.hide(),n.push("<div class='tag-box empty-rec colle-box'><h6 style='margin-top:-3px'>找不到你想要的，试试这样搜</h6><div class='hot-temp'>");var a=h.params.hotCon.split(",");$.each(a,function(e,t){e<4&&n.push("<span class='hot-item'>"+t+"</span>")}),n.push("</div></div>")}else{if(u.hide(),i.length)for(var r=0;r<i.length;r++){var s=c((d=i[r]).func.split(",")[0],p);r<h.params.resultNum&&n.push("<div id='"+d.id+"' class='res-temp' tit='"+d.tit+"'>"+s+"</div>")}if(o.length)for(var l=0;l<o.length;l++){var d,s=c((d=o[l]).title.split(",")[0],p);l<h.params.resultNum&&n.push("<div desc='"+d.desc+"' photoUrl='"+d.photoUrl+"' id='"+d.id+"' class='res-temp'>"+s+"</div>")}}function c(e,t){var i=t.length,o=e.indexOf(t);return-1<o?e.substring(0,o)+'<span style="color:#DE0F18">'+t+"</span>"+e.substring(o+i):e}n=n.splice(0,h.params.resultNum).join(""),u.html(n).show(),h.resultLoading=!1}else{if(0<$(".tag-box.empty-rec").length)return void(h.resultLoading=!1);n="<div class='tag-box empty-rec colle-box'><h6 style='margin-top:-3px'>找不到你想要的，试试这样搜</h6><div class='hot-temp'>",a=h.params.hotCon.split(",");$.each(a,function(e,t){e<4&&(n+="<span class='hot-item'>"+t+"</span>")}),n+="</div></div>",$(".power-search-result").html(n),h.resultLoading=!1}},error:function(e){h.resultLoading=!1}}))},drawingTime:null,drawingPin:function(e,t){var i,o,n,a,r,s,l,d,c;e.length&&((a=$("#earch-drawing-pin")).length?clearTimeout(this.drawingTime):(o=(i=$("#right-help-con").find(".search-btn").offset()).top,n=i.left,a=$("<div id='earch-drawing-pin' style='top:"+(o-2)+"px; left:"+n+"px' class='search-drawing-pin'><div class='pin'><span class='mind-icons'>&#xe6c1c;</span></div><div class='pulse'></div></div>").appendTo($("body"))),s=(r=e.offset()).left,l=r.top,d=s,c=l-24,"center"==t&&(d+=e.outerWidth()/2-8),c=0<c?c:0,setTimeout(function(){a.css({top:c,left:d})}),this.drawingTime=setTimeout(function(){a.remove()},5e3),$(".power-search-result").hide())},tutorial:function(e,t,i,o){$("#power-tutorial-con").remove();var n=$('<div id="power-tutorial-con" style="overflow:hidden" class="tutorial-con"><h3></h3><h2></h2><div class="tutorial-image"></div><div class="tutorial-text"><div class="textarea"></div></div></div>');n.appendTo("body");var a,r=n.find("h2"),s=n.find(".tutorial-image"),l=n.find(".tutorial-text");function d(e){e.dialog()}r.text(e),l.find(".textarea").html(t),null!=i?(s.css({border:"1px solid #e3e3e3",padding:"20px 0px 20px 0px"}),n.css({"z-index":11,width:this.params.tutorial}),a='<img style="width:100%" src="'+i+'"/>',s.html(a),s.find("img").on("load",function(){d(n)})):(s.empty(),s.css({border:"none",padding:0}),d(n)),$(".power-search-result").hide()},close:function(){var e=$("#right-help-con");e.addClass("remove"),$(".brain-power-search-input").find(".search-img-del").trigger("click"),setTimeout(function(){e.css("display","none")},300)},spread:function(){$("#right-help-con").removeClass("remove").css("display","block")},hotLabelHideorShow:function(e,t){var i=$(".tag-box.power-hot-tag"),o=$(".brain-power-search-input").find(".search-hot");"show"==e?o.css({display:"block"}):o.css({display:"none"}),"show"==t?i.css({display:"block"}):i.css({display:"none"})}},Dock={init:function(){var e=$("#designer_layout").width()-$("#layout_block").width();$("#dock").css("right",e);var t,i=e+$("#dock").outerWidth()-1;$(".dock_view").css("right",i),$("#demo_signup").length&&(t=$("#demo_signup").outerHeight(),$("#dock").css("top",t),$(".dock_view").css("top",t+10)),$(".ico_dock_collapse").bind("click",function(){$(".dock_view").hide(),$(".dock_buttons").children().removeClass("selected"),"history"==Dock.currentView&&Dock.closeHistory(),Dock.currentView="",CLB.setConfig("dock","none")}),$(window).bind("resize.dock",function(){"attribute"==Dock.currentView&&Dock.fitAttrList()}),$("#dock_opacity").spinner({min:0,max:100,unit:"%",step:5,onChange:function(e){Designer.setShapeStyle({alpha:e/100})}}),$("#dock_fill_type").button({onMousedown:function(){$("#dock_fill_list").dropdown({target:$("#dock_fill_type"),onSelect:function(e){var t,i,o,n=e.attr("ty");$("#dock_fill_type").button("setText",e.text()),"image"==n?UI.showImageSelect(function(e,t,i){Designer.setFillStyle({type:"image",fileId:e,imageW:t,imageH:i})}):(Designer.setFillStyle({type:n}),t=Utils.getSelectedShapeIds(),i=Model.getShapeById(t[0]),o=Utils.getShapeFillStyle(i.fillStyle),Dock.setFillStyle(o))}});var e=$("#dock_fill_type").text();$("#dock_fill_list").children().each(function(){if($(this).text()==e)return $("#dock_fill_list").dropdown("select",$(this)),!1})}}),$("#fill_solid_btn").colorButton({onSelect:function(e){Designer.setFillStyle({type:"solid",color:e})}}),$("#fill_gradient_begin").colorButton({onSelect:function(e){Designer.setFillStyle({beginColor:e}),$("#fill_gradient_begin").attr("c",e)}}),$("#fill_gradient_end").colorButton({onSelect:function(e){Designer.setFillStyle({endColor:e}),$("#fill_gradient_end").attr("c",e)}}),$("#gradient_swap").button({onClick:function(){var e=$("#fill_gradient_begin").attr("c"),t=$("#fill_gradient_end").attr("c");$("#fill_gradient_begin").attr("c",t).colorButton("setColor",t),$("#fill_gradient_end").attr("c",e).colorButton("setColor",e),Designer.setFillStyle({beginColor:t,endColor:e})}}),$("#gradient_type").button({onMousedown:function(){$("#gradient_type_list").dropdown({target:$("#gradient_type"),onSelect:function(e){var t=e.attr("ty");$("#gradient_type").button("setText",e.text()),Designer.setFillStyle({gradientType:t}),$(".gradient_details").hide(),$("#gradient_type_"+t).show();var i=Utils.getSelectedShapeIds(),o=Model.getShapeById(i[0]),n=Utils.getShapeFillStyle(o.fillStyle);"linear"==t?$("#gradient_angle").spinner("setValue",Math.round(n.angle/Math.PI*180)+"°"):$("#gradient_radius").spinner("setValue",Math.round(100*n.radius)+"%")}});var e=$("#gradient_type").text().trim();$("#gradient_type_list").children().each(function(){if($(this).text()==e)return $("#gradient_type_list").dropdown("select",$(this)),!1})}}),$("#gradient_angle").spinner({min:0,max:360,unit:"°",step:15,onChange:function(e){var t=e/180*Math.PI;Designer.setFillStyle({angle:t})}}),$("#gradient_radius").spinner({min:0,max:100,unit:"%",step:5,onChange:function(e){Designer.setFillStyle({radius:e/100})}}),$("#fill_change_img").button({onClick:function(){UI.showImageSelect(function(e,t,i){Designer.setFillStyle({type:"image",fileId:e,imageW:t,imageH:i})})}}),$("#fill_img_display").button({onMousedown:function(){$("#img_display_list").dropdown({target:$("#fill_img_display"),onSelect:function(e){var t=e.attr("ty");$("#fill_img_display").button("setText",e.text()),Designer.setFillStyle({display:t})}})}}),$("#pos_routate").spinner({min:0,max:360,unit:"°",step:15,onChange:function(e){var t=e/180*Math.PI;Designer.setShapeProps({angle:t})}}),$("#pos_routate1").spinner({min:0,max:360,unit:"°",step:90,onChange:function(e){var t=e/180*Math.PI;Designer.setShapeProps({angle:t})}}),$("#spinner_opacity").spinner({min:0,max:100,unit:"%",step:5,onChange:function(e){Designer.setShapeStyle({alpha:e/100})}}),$("#pos_x").spinner({min:-800,unit:"",step:5,onChange:function(e){Designer.setShapeProps({x:e})}}),$("#pos_y").spinner({min:-800,unit:"",step:5,onChange:function(e){Designer.setShapeProps({y:e})}}),$("#pos_w").spinner({min:20,unit:"",step:5,onChange:function(e){Designer.setShapeProps({w:e})}}),$("#pos_h").spinner({min:20,unit:"",step:5,onChange:function(e){Designer.setShapeProps({h:e})}}),$("#dock_page_size").button({onMousedown:function(){$("#page_size_list").dropdown({target:$("#dock_page_size"),onSelect:function(e){if("dock_size_custom"==e.attr("id"))return $(".dock_size_custom").slideDown(100),$("#dock_page_size").button("setText",e.text()),void tdocCollect({opername:"flowchart",module:"canvas",action:"size",ver5:4});$(".dock_size_custom").slideUp(100);var t=parseInt(e.attr("w")),i=parseInt(e.attr("h"));Designer.setPageStyle({width:t,height:i}),$("#dock_page_size").button("setText",e.text()),tdocCollect({opername:"flowchart",module:"canvas",action:"size",ver5:e.index()+1})}});var e=$("#page_size_list").children("li[w="+Model.define.page.width+"][h="+Model.define.page.height+"]");$(".dock_size_custom").is(":visible")?$("#page_size_list").dropdown("select",$("#dock_size_custom")):0<e.length&&$("#page_size_list").dropdown("select",e)}}),$("#dock_size_w").spinner({min:200,unit:"",step:100,onChange:function(e){Designer.setPageStyle({width:e})}}),$("#dock_size_h").spinner({min:200,unit:"",step:100,onChange:function(e){Designer.setPageStyle({height:e})}}),$("#dock_page_padding").button({onMousedown:function(){$("#page_padding_list").dropdown({target:$("#dock_page_padding"),onSelect:function(e){var t=parseInt(e.attr("p"));Designer.setPageStyle({padding:t}),$("#dock_page_padding").button("setText",e.text()),tdocCollect({opername:"flowchart",module:"canvas",action:"margins",ver5:e.index()+1})}});var e=$("#page_padding_list").children("li[p="+Model.define.page.padding+"]");$("#page_padding_list").dropdown("select",e)}}),$("#dock_page_color").colorButton({position:"center",onSelect:function(e){Designer.setPageStyle({backgroundColor:e})}}),$(".dock_page_ori_list").find("input").unbind().bind("click",function(){var e=$(this).val();Designer.setPageStyle({orientation:e}),tdocCollect({opername:"flowchart",module:"canvas",action:"direction",ver5:"landscape"==e?1:2})}),$(".dock_page_jumps_list").find("input").unbind().bind("click",function(){var e=Model.define.page.lineJumps,t="true"==$(this).val();e!=t&&(Designer.setPageStyle({lineJumps:t}),Designer.events.push("resetBrokenLinker",e),tdocCollect({opername:"flowchart",module:"canvas",action:"line",ver5:t?1:2}))}),$("#dock_page_showgrid").bind("change",function(){var e=$(this).is(":checked");Designer.setPageStyle({showGrid:e}),e?$("#dock_gridsize_box").show():$("#dock_gridsize_box").hide()}),$("#dock_page_gridsize").button({onMousedown:function(){$("#page_gridsize_list").dropdown({target:$("#dock_page_gridsize"),onSelect:function(e){var t=parseInt(e.attr("s"));Designer.setPageStyle({gridSize:t}),$("#dock_page_gridsize").button("setText",e.text()),tdocCollect({opername:"flowchart",module:"canvas",action:"grid",ver5:e.index()+1})}});var e=$("#page_gridsize_list").children("li[s="+Model.define.page.gridSize+"]");$("#page_gridsize_list").dropdown("select",e)}}),$("#btn_history_add").button({onClick:function(){Dock.toggleAddHistory()}}),$("#btn_history_restore").button({onClick:function(){var e=$("#history_versions").children(".selected");$("<div class='dock_history_remove_con dock_history_revert_con'><div class='dock_history_remove_div'>确认还原至此历史版本？<div style='margin-top:5px;'><span class='toolbar_button active'><@i18n resource='global.ok'/></span>&nbsp;&nbsp;<span class='toolbar_button active'><@i18n resource='global.cancel'/></span></div></div></div>").appendTo(e),$("#btn_history_restore").button("disable"),$(".dock_history_revert_con").find("span:first").off().on("click",function(e){Dock.restoreVersion(),Dock.currentDefinition=null,$(".dock_history_revert_con").remove(),Dock.currentDefinition=null,e.stopPropagation()}),$(".dock_history_revert_con").find("span:last").off().on("click",function(e){$(".dock_history_revert_con").remove(),$("#btn_history_restore").button("enable"),e.stopPropagation()})}}),$("#txt_sub_comment").bind("keyup",function(e){if(13==e.keyCode){var t=$(this),i=t.val().replace(/\n/g,"");if(""==i.trim())return;var o="",n=Utils.getSelectedShapeIds();1==n.length&&(o=n[0]);var a,r={action:"comment",userId:userId,id:Utils.newId(),name:userName,content:i,shapeId:o,replyId:""};CLB.send(r),Dock.appendComment(r),Dock.bindComment(),$("#comment_container").scrollTop(9999),t.val(""),Model.comments||(Model.comments=[]),Model.comments.push(r),""!=o&&(a=Model.getShapeById(o),Designer.painter.renderShape(a))}}),$("#show_comment_ico").bind("click",function(e){var t=$("#show_comment_ico").is(":checked");for(var i in CLB.setConfig("showCommentIco",t),showCommentIco=t,Model.define.elements){var o=Model.getShapeById(i);"linker"!=o.name&&Designer.painter.renderShape(o)}}),"none"!=dock&&(""==dock&&(dock="navigator"),this.showView(dock)),window.onresize=function(){document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen||document.webkitFullScreen||document.msFullScreen?(console.log("全屏状态"),$("#full_screen").addClass("open").attr("original-title","退出全屏")):$("#full_screen").hasClass("open")&&(console.log("退出全屏"),$("#full_screen").removeClass("open").attr("original-title","全屏模式"))}},currentView:"",showView:function(e,t){$("#dock_btn_"+e).button("isDisabled")||($(".dock_view").hide(),$(".dock_view_"+e).show(),$(".dock_buttons").children().removeClass("selected"),$("#dock_btn_"+e).addClass("selected"),"history"==Dock.currentView&&"history"!=e&&Dock.closeHistory(),this.currentView=e,this.update(!0),t&&CLB.setConfig("dock",e))},setFillStyle:function(e){var t;$("#dock_fill_type").button("setText",$("#dock_fill_list").children("li[ty="+e.type+"]").text()),$(".fill_detail").hide(),"solid"==e.type?($(".fill_detail_solid").show(),$("#fill_solid_btn").colorButton("setColor",e.color)):"gradient"==e.type?($(".fill_detail_gradient").show(),$("#fill_gradient_begin").attr("c",e.beginColor).colorButton("setColor",e.beginColor),$("#fill_gradient_end").attr("c",e.endColor).colorButton("setColor",e.endColor),$("#gradient_type").button("setText",$("#gradient_type_list").children("li[ty="+e.gradientType+"]").text()),$(".gradient_details").hide(),"linear"==e.gradientType?($("#gradient_type_linear").show(),$("#gradient_angle").spinner("setValue",Math.round(e.angle/Math.PI*180)+"°")):($("#gradient_type_radial").show(),$("#gradient_radius").spinner("setValue",Math.round(100*e.radius)+"%"))):"image"==e.type&&($(".fill_detail_image").show(),t="fill",e.display&&(t=e.display),$("#fill_img_display").button("setText",$("#img_display_list").children("li[ty="+t+"]").text()))},update:function(e){var t,i,o,n,a,r,s,l,d,c,p,u,h,g,_,m,f;$("#dock_zoom").text(Math.round(100*Designer.config.scale)+"%"),$("#navigation_view").is(":visible")&&e&&Navigator.draw(),"graphic"==this.currentView?(f=(m=Utils.getSelectedIds()).length,a=(n=Utils.getSelectedShapeIds()).length,0==f?($("#dock_line_color").button("disable"),$("#dock_line_style").button("disable"),$("#dock_line_width").button("disable")):($("#dock_line_color").button("enable"),$("#dock_line_style").button("enable"),$("#dock_line_width").button("enable"),t="linker"==(r=Model.getShapeById(m[0])).name?Utils.getLinkerLineStyle(r.lineStyle):Utils.getShapeLineStyle(r.lineStyle),$("#dock_line_color").colorButton("setColor",t.lineColor),i=$("#line_style_list").children("li[line="+t.lineStyle+"]").children().attr("class"),$("#dock_line_style").children(".linestyle").attr("class",i),$("#dock_line_width").spinner("setValue",t.lineWidth+"px")),0==a?($("#dock_fill_type").button("disable"),$("#spinner_opacity").button("disable"),Dock.setFillStyle({type:"none"})):($("#dock_fill_type").button("enable"),$("#spinner_opacity").button("enable"),r=Model.getShapeById(n[0]),o=Utils.getShapeFillStyle(r.fillStyle),Dock.setFillStyle(o),$("#spinner_opacity").spinner("setValue",Math.round(100*r.shapeStyle.alpha)+"%"))):"metric"==this.currentView?0==(a=(n=Utils.getSelectedShapeIds()).length)?($("#pos_x").button("disable"),$("#pos_w").button("disable"),$("#pos_y").button("disable"),$("#pos_h").button("disable"),$("#pos_routate").button("disable")):(r=Model.getShapeById(n[0]),$("#pos_x").button("enable").spinner("setValue",Math.round(r.props.x)),$("#pos_w").button("enable").spinner("setValue",Math.round(r.props.w)),$("#pos_y").button("enable").spinner("setValue",Math.round(r.props.y)),$("#pos_h").button("enable").spinner("setValue",Math.round(r.props.h)),"lane"==r.category?($("#pos_x").button("disable"),$("#pos_w").button("disable"),$("#pos_y").button("disable"),$("#pos_h").button("disable"),$("#pos_routate").button("disable")):$("#pos_routate").button("enable").spinner("setValue",Math.round(r.props.angle/Math.PI*180)+"°")):"page"==this.currentView?(l=(s=Model.define.page).width,d=s.height,p="",0<(c=$("#page_size_list").children("li[w="+l+"][h="+d+"]")).length?(p=c.text(),$(".dock_size_custom").hide()):(p=$("#dock_size_custom").text(),$(".dock_size_custom").show()),$("#dock_page_size").button("setText",p),$("#dock_page_padding").button("setText",s.padding+"px"),$("#dock_page_color").colorButton("setColor",s.backgroundColor),$("#dock_page_showgrid").attr("checked",s.showGrid),s.showGrid?$("#dock_gridsize_box").show():$("#dock_gridsize_box").hide(),h="",0<(u=$("#page_gridsize_list").children("li[s="+s.gridSize+"]")).length&&(h=u.text()),$("#dock_page_gridsize").button("setText",h),g="portrait",Model.define.page.orientation&&(g=Model.define.page.orientation),$(".dock_page_ori_list").find("input[value="+g+"]").attr("checked",!0),_=!1,1==Model.define.page.lineJumps&&(_=!0),$(".dock_page_jumps_list").find("input[value="+_+"]").attr("checked",!0)):"attribute"==this.currentView?1!=(f=(m=Utils.getSelectedIds()).length)?($(".attr_list").html("<li class='attr_none'><@i18n resource='diagraming.addattr.empty'/></li>"),$(".attr_add").hide(),this.fitAttrList()):(this.setAttributeList(),$(".attr_add").show(),this.cancelAttrAdd()):"history"==this.currentView?e&&null==Dock.historyVersions&&this.loadHistorys():"comment"==this.currentView&&(this.loadComments(),showCommentIco?$("#show_comment_ico").attr("checked",!0):$("#show_comment_ico").attr("checked",!1));var v=Model.define.page.backgroundColor;$("#bar_page_color").find(".color_line").css("backgroundColor","rgb("+v+")"),$("#dock_size_w").spinner("setValue",Model.define.page.width+"px"),$("#dock_size_h").spinner("setValue",Model.define.page.height+"px")},historyVersions:null,automation:!1,splitDate:function(e){if(""!=e){var t,i="",o=e.split(" ");return 0<=o[0].indexOf("-")&&(t=o[0].split("-"),i=(new Date).getFullYear()==t[0]?t[1]+"-"+t[2]:t),0<=o[1].indexOf(":")&&(i+=" "+(t=o[1].split(":"))[0]+":"+t[1]),i}},switchCheck:function(e){e.hasClass("opened")?(e.removeClass("opened"),e.attr("original-title","仅显示手动创建"),$(".switch-des").text("显示全部版本记录"),Dock.automation=!1):(e.addClass("opened"),e.attr("original-title","显示全部版本记录"),$(".switch-des").text("仅显示手动创建"),Dock.automation=!0),null!=this.currentDefinition&&Dock.closeHistory(),Dock.loadHistorys()},loadHistorys:function(){var r,s;""!=chartId?(r=$("#history_versions"),s="",0==r.length&&(r=$('<ul id="history_versions"><ul>').appendTo($("#history_container"))),$.ajax({url:"/diagraming/get_versions",data:{chartId:chartId},cache:!1,success:function(e){Dock.historyVersions="loaded";for(var t=e.list,i=0,o=t.length;i<o;i++){var n=t[i],a=n._id.$oid;(!Dock.automation||"自动存储"!=n.remark)&&(s+='<li vid="'+a+'" def="'+n.definitionId+'"><div class="history_remark">'+n.remark+'</div><div class="version_name"><span>'+n.fullName+"</span> "+Dock.splitDate(n.createDate)+'</div><span class="ico dlg_close dock_history_remove"></span></li>')}r.html(s),0<$("#history_versions li").length?$("#history-none-tip").hide():$("#history-none-tip").show(),Dock.resetVersions(),Dock.initRemoveHistory()}})):$("#history_container").html("<div style='padding: 20px 10px;'><@i18n resource='diagraming.demo.nohistory'/></div>")},resetVersions:function(){0!=$("#history_versions").length&&$("#history_versions").children("li").off().on("click",function(){var e;$(this).hasClass("selected")?Dock.closeHistory():($("#history_versions").children(".selected").removeClass("selected"),$(this).addClass("selected"),e=$(this).attr("def"),Dock.showHistoryVersion(e));var t=$("#history_versions").children(".selected");0!=t.length&&"0"!=t.attr("ind")?$("#btn_history_restore").button("enable"):$("#btn_history_restore").button("disable")})},toggleAddHistory:function(){$(".area_history").toggle(),$("#area_history_add").is(":visible")&&$("#history_remark").focus()},addHistory:function(){if(""!=chartId){var e=$("#history_remark").val();if(!e.trim())return $("#history_remark").focus(),!1;Utils.testVipState(function(){-1<tdocVipInfo.indexOf(20)||-1<tdocVipInfo.indexOf(30)?CLB.saveVersion(e):UI.showVipLimitDlg("addHistory")})}},initRemoveHistory:function(){$(".dock_history_remove").off().on("click",function(e){$(".dock_history_remove_con").remove();var t=$(this).parent();t.hasClass("selected")||(t.attr("vid"),$("<div class='dock_history_remove_con'><div class='dock_history_remove_div'><@i18n resource='diagraming.removehistory'/><div style='margin-top:5px;'><span class='toolbar_button active'><@i18n resource='global.ok'/></span>&nbsp;&nbsp;<span class='toolbar_button active'><@i18n resource='global.cancel'/></span></div></div></div>").appendTo(t),$(".dock_history_remove_div").find("span:first").off().on("click",function(e){var t,i=$(this).parents("li");i.hasClass("selected")||(t=i.attr("vid"),""!=chartId&&$.ajax({url:"/diagraming/del_version",data:{vid:t},cache:!1,success:function(e){i.remove(),$("#history_versions li").length<1&&$("#history-none-tip").show()}}),e.stopPropagation())}),$(".dock_history_remove_div").find("span:last").off().on("click",function(e){$(".dock_history_remove_con").remove(),e.stopPropagation()})),e.stopPropagation()})},showHistoryVersion:function(e){$("#btn_history_restore").button("disable"),$.ajax({url:"/diagraming/get_versiondef",data:{id:e},success:function(e){null!=e.def&&(Dock.openHistory(e.def),$("#btn_history_restore").button("enable"),UI.showTip("<@i18n resource='diagraming.history.viewing'/><a href='javascript:' style='margin-left: 10px;color:#fff;text-decoration:underline;' onclick='Dock.closeHistory()'><@i18n resource='diagraming.history.back'/></a>"))}})},currentDefinition:null,openHistory:function(e){null==this.currentDefinition&&(this.currentDefinition=$.extend(!0,{},Model.define)),Utils.unselect(),Designer.open(e),Designer.hotkey.cancel(),Designer.op.cancel(),$("#menu_bar").children().addClass("readonly"),$(".diagram_title").addClass("readonly"),$(".dock_buttons").children().addClass("disabled"),$("#dock_btn_history").removeClass("disabled"),$(".panel_box").addClass("readonly")},revertHistory:function(e){sendMessage("restore",{ret:0,message:"还原成功"}),location.reload()},closeHistory:function(){null!=this.currentDefinition&&(Designer.open(this.currentDefinition),this.currentDefinition=null,this.activeOperation(),UI.hideTip(),$("#flow_ui_tip").css({top:-56}).hide())},activeOperation:function(){Designer.hotkey.init(),Designer.op.init(),$("#menu_bar").children().removeClass("readonly"),$(".diagram_title").removeClass("readonly"),$(".dock_buttons").children().removeClass("disabled"),$("#dock_btn_history").removeClass("disabled"),$(".panel_box").removeClass("readonly"),$("#history_versions").children(".selected").removeClass("selected"),$("#btn_history_restore").button("disable")},restoreVersion:function(){if($("#history_versions").children(".selected").length){MessageSource.beginBatch();var e=Dock.currentDefinition.elements,t=[];if(e)for(var i in e)t.push(e[i]);MessageSource.send("remove",t);var o={page:Utils.copy(Dock.currentDefinition.page),update:Utils.copy(Model.define.page)};MessageSource.send("updatePage",o);var n=Model.define.elements,a=[];if(n)for(var i in n)a.push(n[i]);MessageSource.send("create",a);var r={theme:Utils.copy(Dock.currentDefinition.theme),update:Utils.copy(Model.define.theme)};MessageSource.send("setTheme",r),MessageSource.commit(),Dock.activeOperation(),UI.hideTip(),$("#btn_history_clear").button("disable"),$("#history_versions").find("input[type=checkbox]").prop("checked","")}},currentCommentId:"-1",commentOperate:"",loadComments:function(){if("viewing_comment"!=this.commentOperate){var e=$("#comment_container"),t=Utils.getSelectedShapeIds(),i=1==t.length?t[0]:"";if(this.currentCommentId!=i)if(this.currentCommentId=i,Model.comments&&0!=Model.comments.length){e.empty();for(var o=0;o<Model.comments.length;o++){var n=Model.comments[o];n.shapeId!=i&&""!=i||Dock.appendComment(n)}Dock.bindComment(),Dock.fitComments()}else e.html("<div class='comment_none'><@i18n resource='diagraming.comments.empty'/></div>")}},bindComment:function(){var t=$("#comment_container");t.find("input").unbind("click").bind("click",function(e){e.stopPropagation()}),t.find(".input_comment_reply").unbind("keydown").bind("keydown",function(e){if(13==e.keyCode){var t=$(this).val();if(""==t)return;$(this).val("");var i=$(this).parent().parent().parent().attr("id"),o={action:"comment",userId:userId,id:Utils.newId(),name:userName,content:t,shapeId:"",replyId:i};CLB.send(o),Dock.appendComment(o),Dock.bindComment()}Dock.fitComments()}),t.find(".comment_remove").unbind("click").bind("click",function(e){e.stopPropagation(),$(this).parent().remove();var t=$(this).parent().attr("id"),i={action:"removeComment",id:t};CLB.send(i),Dock.fitComments();for(var o=[],n=0;n<Model.comments.length;n++){var a=Model.comments[n];a.id!=t&&a.replyId!=t&&o.push(a)}Model.comments=o;var r=$(this).parent().attr("shapeId"),s=Model.getShapeById(r);null!=s&&"linker"!=s.name&&Designer.painter.renderShape(s)}),t.children(".comment_item_outer").unbind().bind("click",function(){$(this).hasClass("selected")?$(this).removeClass("selected"):(t.children(".selected").removeClass("selected"),$(this).addClass("selected"));var e=$(this).attr("shapeId");Dock.commentOperate="viewing_comment",e&&null!=Model.getShapeById(e)&&Utils.selectShape(e),Dock.fitComments(),Dock.commentOperate=""})},fitComments:function(){var e=$("#comment_container"),t=e.scrollTop();e.height("auto");var i,o=e.offset().top;o+e.height()+145>$(window).height()?((i=$(window).height()-o-145)<120&&(i=120),e.height(i)):e.height("auto"),e.scrollTop(t)},appendComment:function(e){$(".comment_none").remove();var t,i=$("<div class='comment_item' id='"+e.id+"'></div>").appendTo(t);i=e.replyId?(t=$("#comment_container").children("#"+e.replyId+".comment_item").find(".comment_reply_list"),$("<div class='comment_item comment_item_inner' id='"+e.id+"'></div>").appendTo(t)):(t=$("#comment_container"),$("<div class='comment_item comment_item_outer' id='"+e.id+"'></div>").appendTo(t)),"owner"!=role&&e.userId!=userId||i.append("<div class='ico comment_remove' disableTitle='true' title='<@i18n resource='global.delete'/>'></div>"),e.shapeId&&i.attr("shapeId",e.shapeId),i.append("<img src='/photo/"+e.userId+".png'/>");var o=$("<div class='comment_content_box'></div>").appendTo(i);o.append("<div class='comment_name'>"+e.name+"</div>"),o.append("<div class='comment_content'>"+e.content+"</div>");var n=new Date;e.time&&n.setTime(e.time);var a=n.format(dateFormat);o.append("<div class='comment_date'>"+a+"</div>"),e.replyId||(o.append("<div class='comment_reply_list'></div>"),o.append("<div class='comment_reply'><input type='text' class='input_text input_comment_reply' placeholder='<@i18n resource='diagraming.comments.reply'/>'/></div>")),Dock.fitComments()},setAttributeList:function(){var e=Utils.getSelectedIds(),t=Model.getShapeById(e[0]);if($(".attr_list").empty(),t.dataAttributes)for(var i=0;i<t.dataAttributes.length;i++){var o=t.dataAttributes[i],n=$("#attr_add_type").children("option[value="+o.type+"]").text(),a=$("<li id='"+o.id+"' class='attr_item attr_item_"+o.id+"' onclick=\"Dock.editAttr('"+o.id+"')\"><div class='attr_name'>"+Util.filterXss(o.name)+"</div><div class='attr_type'>"+n+"</div><div class='attr_value'>"+Util.filterXss(o.value)+"</div><div style='clear: both'></div></li>").appendTo($(".attr_list"));"default"!=o.category&&a.append("<div class='ico ico_attr_delete' onclick=\"Dock.deleteAttr('"+o.id+"', event)\"></div>")}this.fitAttrList()},fitAttrList:function(){var e=$(".attr_list").scrollTop();$(".attr_list").height("auto");var t,i=$(".attr_list").offset().top;i+$(".attr_list").height()+10>$(window).height()?((t=$(window).height()-i-10)<140&&(t=140),$(".attr_list").height(t)):$(".attr_list").height("auto"),$(".attr_list").scrollTop(e)},showAttrAdd:function(){$("#attr_add_btn").hide(),$(".attr_add_items").show(),$("#attr_add_name").val("").focus(),$("#attr_add_type").val("string"),$("#attr_add_type").unbind().bind("change",function(){Dock.setAttrValueInput(null,$(this).val())}),Dock.setAttrValueInput(null,"string"),this.fitAttrList()},saveAttrAdd:function(){var e,t,i,o=$("#attr_add_name").val();""!=o?(e=$("#attr_add_type").val(),t=$("#attr_add_value_arera").children().val(),t=Util.filterXss(t),i={name:o=Util.filterXss(o),type:e,value:t},Designer.addDataAttribute(i),this.setAttributeList(),this.showAttrAdd()):$("#attr_add_name").focus()},cancelAttrAdd:function(){$("#attr_add_btn").show(),$(".attr_add_items").hide(),this.fitAttrList()},editAttr:function(t){var e,i,o,n,a,r,s,l,d,c=$(".attr_item_"+t);c.hasClass("attr_editing")||(0<$(".attr_editing").length&&(e=$(".attr_editing").attr("id"),this.saveAttrEdit(e)),(c=$(".attr_item_"+t)).addClass("attr_editing"),i=Designer.getDataAttrById(t),this.setAttrValueInput(i,i.type).val(i.value).select(),"default"!=i.category&&((o=c.children(".attr_name")).empty(),$("<input type='text' class='input_text' style='width: 88px'/>").appendTo(o).val(i.name).select(),(n=c.children(".attr_type")).empty(),(a=$("<select class='input_select' style='width: 60px'></select>").appendTo(n)).html($("#attr_add_type").html()).val(i.type),a.bind("change",function(){Dock.setAttrValueInput(i,$(this).val())})),(r=$("<div class='attr_edit_display'></div>").appendTo(c)).append("<div class='dock_label'><@i18n resource='diagraming.addattr.displayas'/></div>"),r.append("<div id='attr_edit_showtype' class='toolbar_button active btn_inline' style='width: 75px;'><div class='text_content'></div><div class='ico ico_dropdown'></div></div>"),r.append("<div style='clear: both'></div>"),r.append("<div class='attr_display_options'></div>"),this.appendDisplayItems(),s="none",i.showType&&(s=i.showType),this.setAttrDisplay(s),$("#attr_edit_showtype").attr("ty",s).button({onMousedown:function(){$("#attr_display_list").dropdown({target:$("#attr_edit_showtype"),onSelect:function(e){var t=e.attr("ty");$("#attr_edit_showtype").attr("ty",t).button("setText",e.text()),Dock.setAttrDisplay(t)}});var e=$("#attr_edit_showtype").text().trim();$("#attr_display_list").children().each(function(){if($(this).text()==e)return $("#attr_display_list").dropdown("select",$(this)),!1})}}),$("#attr_edit_showtype").attr("ty",s).button("setText",$("#attr_display_list").children("li[ty="+s+"]").html()),"none"!=s&&($("#attr_display_name").attr("checked",i.showName),"icon"==s&&this.setAttrIcon(i.icon)),l="mostright",i.horizontal&&(l=i.horizontal),d="mostbottom",i.vertical&&(d=i.vertical),$("#attr_location_h").button("setText",$("#attr_location_h_list").children("li[loc="+l+"]").html()),$("#attr_location_h").attr("loc",l),$("#attr_location_v").button("setText",$("#attr_location_v_list").children("li[loc="+d+"]").html()),$("#attr_location_v").attr("loc",d),c.append("<div class='attr_edit_btns'><div id='save_edit_attr' class='toolbar_button active'><@i18n resource='global.ok'/></div><div id='cancel_edit_attr' class='toolbar_button active' style='margin-left: 5px;'><@i18n resource='global.cancel'/></div></div>"),$("#save_edit_attr").bind("click",function(e){e.stopPropagation(),Dock.saveAttrEdit(t)}),$("#cancel_edit_attr").bind("click",function(e){e.stopPropagation(),Dock.setAttributeList()}))},setAttrValueInput:function(e,t){var i,o=null!=e?$(".attr_editing").children(".attr_value"):$("#attr_add_value_arera");if(o.empty(),"boolean"==t)i=$("<select class='input_select'><option value=''></option><option value='true'>true</option><option value='false'>false</option></select>").appendTo(o);else if("list"==t){if(i=$("<select class='input_select'></select>").appendTo(o),e.listItems)for(var n=0;n<e.listItems.length;n++){var a=e.listItems[n];i.append("<option value='"+a+"'>"+a+"</option>")}}else i=$("<input type='text' class='input_text'/>").appendTo(o);return null==e?o.children().css("width","260px"):o.children().css("width","128px"),i},appendDisplayItems:function(){var e=$(".attr_display_options"),t=$("<div class='opt_area'></div>").appendTo(e);t.append("<input id='attr_display_name' type='checkbox'/><label for='attr_display_name'><@i18n resource='diagraming.addattr.showname'/></label>");var i=$("<div id='attr_icon_area' style='padding-top:5px;'></div>").appendTo(t);if(i.append("<div class='dock_label'><@i18n resource='diagraming.addattr.icon'/></div>"),i.append("<div id='attr_display_icon' ico='' class='toolbar_button active btn_inline' style='width: 50px'><div class='text_content'></div><div class='ico ico_dropdown'></div></div>"),i.append("<div style='clear: both'></div>"),""==$("#attr_icon_list").children("li").html()){for(var o="",n=1;n<=49;)30==n&&(o+="<div></div>"),o+="<div onmousedown='Dock.setAttrIcon("+n+")' class='attr_icon_item'></div>",n++;$("#attr_icon_list").children("li").html(o)}var a=$("<div class='opt_area location_area'></div>").appendTo(e);a.append("<div><@i18n resource='diagraming.addattr.display.location'/></div>"),a.append("<div class='dock_label'><@i18n resource='diagraming.addattr.display.h'/></div>"),a.append("<div id='attr_location_h' class='toolbar_button active btn_inline' loc='mostright'><div class='text_content location_content'><div><span style='left: 11px'></span></div>Most Right</div><div class='ico ico_dropdown'></div></div>"),a.append("<div style='clear: both'></div>"),a.append("<div class='dock_label'><@i18n resource='diagraming.addattr.display.v'/></div>"),a.append("<div id='attr_location_v' class='toolbar_button active btn_inline' loc='mostbottom'><div class='text_content location_content'><div><span style='top: 11px'></span></div>Most Bottom</div><div class='ico ico_dropdown'></div></div>"),a.append("<div style='clear: both'></div>"),e.append("<div style='clear: both'></div>"),$("#attr_display_icon").button({onMousedown:function(){$("#attr_icon_list").dropdown({target:$("#attr_display_icon")})}}),$("#attr_location_h").button({onMousedown:function(){$("#attr_location_h_list").dropdown({target:$("#attr_location_h"),onSelect:function(e){$("#attr_location_h").button("setText",e.html()),$("#attr_location_h").attr("loc",e.attr("loc"))}})}}),$("#attr_location_v").button({onMousedown:function(){$("#attr_location_v_list").dropdown({target:$("#attr_location_v"),onSelect:function(e){$("#attr_location_v").button("setText",e.html()),$("#attr_location_v").attr("loc",e.attr("loc"))}})}})},setAttrDisplay:function(e){"none"==e?$(".attr_display_options").hide():($(".attr_display_options").show(),"icon"==e?$("#attr_icon_area").show():$("#attr_icon_area").hide())},setAttrIcon:function(e){$("#attr_display_icon").attr("ico",e).button("setText",""),e&&$("#attr_display_icon").button("setText","<img src='/images/data-attr/"+e+".png'/>")},saveAttrEdit:function(e){var t=$(".attr_item_"+e);if(t.hasClass("attr_editing")){var i=Designer.getDataAttrById(e);if("default"!=i.category){var o=t.children(".attr_name").children("input").val();if(""==o)return void t.children(".attr_name").children("input").focus();i.name=o,i.type=t.children(".attr_type").children("select").val()}i.value=t.children(".attr_value").children().val();var n=$("#attr_edit_showtype").attr("ty");"none"!=(i.showType=n)&&(i.showName=$("#attr_display_name").is(":checked"),i.horizontal=$("#attr_location_h").attr("loc"),i.vertical=$("#attr_location_v").attr("loc"),"icon"==n&&(i.icon=$("#attr_display_icon").attr("ico")));var a,r,s,l=Utils.getSelectedIds(),d=Model.getShapeById(l[0]);"default"==i.category&&"bpmn"==d.category&&(d.attribute||(d.attribute={}),d.attribute.markers||(d.attribute.markers=[]),a=d.attribute.markers,"loopCharacteristics"==i.name||"循环特征"==i.name?(Utils.removeFromArray(a,"loop"),Utils.removeFromArray(a,"sequential"),Utils.removeFromArray(a,"parallel"),"StandardLoopCharacteristics"==i.value||"标准"==i.value?Utils.addToArray(a,"loop"):"MultipleLoopCharacteristics"!=i.value&&"多例"!=i.value||(null==(r=Designer.getDefaultDataAttrByName("isSequantial"))&&(r=Designer.getDefaultDataAttrByName("是否为序列")),null!=r&&("true"==r.value?Utils.addToArray(a,"sequential"):Utils.addToArray(a,"parallel")))):"isSequantial"==i.name||"是否为序列"==i.name?(Utils.removeFromArray(a,"sequential"),Utils.removeFromArray(a,"parallel"),null==(s=Designer.getDefaultDataAttrByName("loopCharacteristics"))&&(s=Designer.getDefaultDataAttrByName("循环特征")),null==s||"MultipleLoopCharacteristics"!=s.value&&"多例"!=s.value||("true"==i.value?Utils.addToArray(a,"sequential"):Utils.addToArray(a,"parallel"))):"isForCompensation"==i.name||"是否为补偿"==i.name?(Utils.removeFromArray(a,"compensation"),"true"==i.value&&Utils.addToArray(a,"compensation")):"isCollection"==i.name||"participantMultiplicity"==i.name||"是否为集合"==i.name||"多重参与者"==i.name?(Utils.removeFromArray(a,"parallel"),"true"==i.value&&Utils.addToArray(a,"parallel")):"loopType"!=i.name&&"循环类型"!=i.name||(Utils.removeFromArray(a,"loop"),Utils.removeFromArray(a,"sequential"),Utils.removeFromArray(a,"parallel"),"Standard"==i.value||"标准"==i.value?Utils.addToArray(a,"loop"):"MultiInstanceSequential"==i.value||"实例化多例序列"==i.value?Utils.addToArray(a,"sequential"):"MultiInstanceParallel"!=i.value&&"实例化多例并行"!=i.value||Utils.addToArray(a,"parallel"))),i.value=Util.filterXss(i.value),i.name=Util.filterXss(i.name),Designer.updateDataAttribute(i),this.setAttributeList()}},deleteAttr:function(e,t){t.stopPropagation(),$(".attr_item_"+e).remove(),this.fitAttrList(),Designer.deleteDataAttribute(e)},fullScreen:function(e,t){e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():(t?$("#fullscreen_tip").find(".t").text("<@i18n resource='diagraming.presentation.tip'/>"):$("#fullscreen_tip").find(".t").text("<@i18n resource='diagraming.fullscreen.tip'/>"),$("#fullscreen_tip").fadeIn())},exitFullScreen:function(){var e,t=document.exitFullscreen||document.mozCancelFullScreen||document.webkitExitFullscreen||document.webkitExitFullscreen;t?t.call(document):void 0===window.ActiveXObject||null!==(e=new ActiveXObject("WScript.Shell"))&&e.SendKeys("{F11}")},enterPresentation:function(){$("#designer").bind("webkitfullscreenchange",function(e){Dock.manageFullScreen()}),$(document).bind("mozfullscreenchange",function(e){Dock.manageFullScreen()}).bind("fullscreenchange",function(e){Dock.manageFullScreen()}),this.fullScreen(Utils.getDomById("designer"),!0)},enterFullScreen:function(){this.fullScreen(document.documentElement)},manageFullScreen:function(){Utils.getDomById("designer");document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement?($("#shape_panel").addClass("readonly"),$("#designer_viewport").addClass("readonly"),$(window).unbind("resize.designer"),$("#designer_layout").height(window.screen.height),Designer.hotkey.cancel(),Designer.op.cancel(),$("#dock").hide(),$(".dock_view").hide(),Designer.contextMenu.destroy(),Designer.op.canvasFreeDraggable()):($("#shape_panel").removeClass("readonly"),$("#designer_viewport").removeClass("readonly"),Designer.initialize.initLayout(),Designer.hotkey.init(),Designer.op.init(),$("#dock").show(),""!=Dock.currentView&&Dock.showView(Dock.currentView),Designer.contextMenu.init(),$("#designer").unbind("webkitfullscreenchange"),$("#designer").unbind("mozfullscreenchange").unbind("fullscreenchange"))}},Navigator={init:function(){$("#designer_layout").bind("scroll",function(){Navigator.setView()}),$("#navigation_eye").bind("mousedown",function(a){var r=$(this),s=r.position();$("#designer_layout").unbind("scroll");var l=$("#designer_layout"),d=l.scrollTop(),c=l.scrollLeft(),e=$("#designer_canvas"),t=e.width(),i=e.height(),o=$("#navigation_canvas"),n=o.width(),p=o.height(),u=t/n,h=i/p;$(document).bind("mousemove.navigator",function(e){var t=e.pageX-a.pageX,i=e.pageY-a.pageY,o=c+t*u;l.scrollLeft(o);var n=d+i*h;l.scrollTop(n),r.css({left:s.left+t,top:s.top+i})}),$(document).bind("mouseup.navigator",function(e){$(document).unbind("mousemove.navigator"),$(document).unbind("mouseup.navigator"),Navigator.setView(),$("#designer_layout").bind("scroll",function(){Navigator.setView()})})}),$("#navigation_canvas").bind("click",function(e){var t=Utils.getRelativePos(e.pageX,e.pageY,$(this)),i=$("#designer_canvas"),o=i.width(),n=i.height(),a=$("#navigation_canvas"),r=o/a.width(),s=n/a.height(),l=t.x*r,d=t.y*s,c=$("#designer_layout"),p=Designer.config.pageMargin;c.scrollLeft(l+p-c.width()/2),c.scrollTop(d+p-c.height()/2)}),this.setView()},draw:function(){this.drawNavigationTimeout&&window.clearTimeout(this.drawNavigationTimeout),this.drawNavigationTimeout=setTimeout(function(){var e=$("#navigation_canvas"),t=e[0].getContext("2d");t.save(),t.clearRect(0,0,e.width(),e.height()),t.scale(e.width()/Model.define.page.width,e.height()/Model.define.page.height);for(var i=0;i<Model.orderList.length;i++){var o=Model.orderList[i].id,n=Model.getShapeById(o);if(t.save(),"linker"!=n.name){var a=n.props,r=Utils.getShapeLineStyle(n.lineStyle);t.translate(a.x,a.y),t.translate(a.w/2,a.h/2),t.rotate(a.angle),t.translate(-a.w/2,-a.h/2),t.globalAlpha=n.shapeStyle.alpha,Designer.painter.renderShapePath(t,n)}else{var s=n,r=Utils.getLinkerLineStyle(s.lineStyle),l=s.points,d=s.from,c=s.to;if(t.beginPath(),t.moveTo(d.x,d.y),"curve"==s.linkerType){var p=l[0],u=l[1];t.bezierCurveTo(p.x,p.y,u.x,u.y,c.x,c.y)}else{for(var h=0;h<l.length;h++){var g=l[h];t.lineTo(g.x,g.y)}t.lineTo(c.x,c.y)}t.lineWidth=r.lineWidth,t.strokeStyle="rgb("+r.lineColor+")",t.stroke()}t.restore()}t.restore(),Navigator.setView(),this.drawNavigationTimeout=null},100)},setView:function(){var e=$("#navigation_eye"),t=$("#designer_layout"),i=t.width(),o=t.height(),n=$("#navigation_canvas"),a=n.width(),r=n.height(),s=$("#designer_canvas"),l=s.width(),d=s.height(),c=Designer.config.pageMargin,p=c-t.scrollLeft(),u=p+l;p<0?p=0:i<p&&(p=i),i<u?u=i:u<0&&(u=0);var h=c-t.scrollTop(),g=h+d;h<0?h=0:o<h&&(h=o),o<g?g=o:g<0&&(g=0);var _,m,f,v,b=u-p,w=g-h;0==b||0==w?e.hide():((_=t.scrollLeft()-c)<0&&(_=0),_*=a/l,(m=t.scrollTop()-c)<0&&(m=0),m*=r/d,f=a/l*b,v=r/d*w,e.css({left:_-1,top:m-1,width:f,height:v}).show())}};!function(l){l.fn.button=function(t){if("string"==typeof t){if("disable"==t)l(this).addClass("disabled"),l(this).find("input").attr("disabled",!0);else if("enable"==t)l(this).removeClass("disabled"),l(this).find("input").attr("disabled",!1);else{if("isDisabled"==t)return l(this).hasClass("disabled");if("isSelected"==t)return l(this).hasClass("selected");if("unselect"==t)l(this).removeClass("selected");else if("select"==t)l(this).addClass("selected");else if("setText"==t)l(this).children(".text_content").html(arguments[1]);else if("setColor"==t)l(this).children(".btn_color").css("background-color","rgb("+arguments[1]+")");else if("getColor"==t){var e=l(this).children(".btn_color").css("background-color").replace(/\s/g,"");return e.substring(4,e.length-1)}}return l(this)}var i=l(this);i.unbind("click"),i.unbind("mousedown"),t.onClick&&i.bind("click",function(e){i.button("isDisabled")||t.onClick(e)}),t.onMousedown&&i.bind("mousedown",function(e){i.button("isDisabled")||(t.onMousedown(e),e.stopPropagation())})};var r=null;function a(e,t,i){var o,n;!e.attr("max")||(o=parseInt(e.attr("max")))<t&&(t=o),!e.attr("min")||t<(n=parseInt(e.attr("min")))&&(t=n),e.attr("old")!=t+i.unit&&i.onChange&&i.onChange(t),e.spinner("setValue",t+i.unit)}l.fn.dropdown=function(t){var e,i,o,n,a=l(this);a.find(".ico_selected").remove(),"string"!=typeof t?(null!=r&&r.menu.dropdown("close"),a=l(this),e=t.target,r={target:e,menu:a},i=e.offset(),e.addClass("selected"),a.show(),o="center"==t.position?i.left+e.outerWidth()/2-a.outerWidth()/2:"right"==t.position?i.left+e.outerWidth()-a.outerWidth():i.left,"top"==t.top?(n=i.top-a.outerHeight())<0&&(n=0):(n=i.top+e.outerHeight())+a.outerHeight()>l(window).height()&&(n=l(window).height()-a.outerHeight()),a.css({top:n,left:o}),void 0!==t.zindex&&a.css("z-index",t.zindex),a.unbind("mousedown").bind("mousedown",function(e){e.stopPropagation()}),void 0!==t.bind&&1!=t.bind||a.find("li:not(.devider,.menu_text)").unbind().bind("click",function(){var e=l(this);e.menuitem("isDisabled")||0!=e.children(".extend_menu").length||(t.onSelect&&t.onSelect(e),a.dropdown("close"))}),l(document).bind("mousedown.ui_dropdown",function(){a.dropdown("close")}),l("#hover_tip").length&&l("#hover_tip").is(":visible")&&l("#hover_tip").hide()):"close"==t?(a.hide(),r.target.removeClass("selected"),l(document).unbind("mousedown.ui_dropdown"),r=null):"select"==t&&arguments[1].prepend("<div class='ico ico_selected'></div>")},l.colorShow=function(i){var t=l("#color_picker");t.find(".selected").removeClass("selected"),t.attr("init")||(t.find("div").each(function(){var e=l(this).css("background-color");e=(e=e.replace(/\s/g,"")).substring(4,e.length-1),l(this).attr("col",e)}),t.attr("init",!0));var e,o=l.extend({},i,{bind:!1});t.dropdown(o),t.children(".color_items").children("div").off().on("mousedown",function(e){var t;e.preventDefault(),i.onSelect&&(t=l(this).css("background-color"),i.onSelect(t)),l("#color_picker").dropdown("close")}),t.children(".color_items").children("div").off("mouseenter").on("mouseenter",function(){var e=(e=l(this).css("background-color")).replace(/\s/g,"");e=UI.RGB2Hex(e),t.children(".color_hex").find("input").val(e)}),t.children(".color_hex").find("input").off("keyup").on("keyup",function(){var e,t=l(this).val();3!=t.length&&6!=t.length||(e=UI.hex2RGB("#"+t),i.onSelect&&i.onSelect(e))}),i.color&&(t.find("div[col='"+i.color+"']").addClass("selected"),e=UI.RGB2Hex("rgb("+i.color+")"),t.children(".color_hex").find("input").val(e)),1==i.trans?t.find(".color_transparent").show():t.find(".color_transparent").hide(),l("#color_picker").children(".color_extend").remove(),i.extend&&l("#color_picker").append("<div class='color_extend'>"+i.extend+"</div>")},l.colorpicker=function(o){var e,n,t,i,a=o.target;a.hasClass("selected")?a.removeClass("selected"):(l(".header-op-item.selected").not("[tit=bar_font_bold], [tit=bar_font_italic], [tit=bar_font_underline], [tit=dock_btn_navigator]").removeClass("selected"),a.addClass("selected"),(e=l("#color_picker")).find(".selected").removeClass("selected"),n=localStorage.getItem("recent_used_color"),t=0,n&&(n=JSON.parse(n),t=n.length),e.find(".history_color>div").each(function(e){e<t&&n[e]?l(this).css("background-color",n[e].color).removeClass("disabled"):l(this).removeAttr("style").removeAttr("col").addClass("disabled")}),e.attr("init")||(e.find(".color_items>div").each(function(){var e=l(this).css("background-color");e=(e=e.replace(/\s/g,"")).substring(4,e.length-1),l(this).attr("col",e)}),e.attr("init",!0)),i=l.extend({},o,{bind:!1}),e.dropdown(i),e.off("mousedown.color").on("mousedown.color",".color_items>div",function(){var t,e,i;o.onSelect&&(t=(t=l(this).css("background-color")).replace(/\s/g,""),e="",l(this).parent().hasClass("history_color")||(i={color:t,time:(new Date).getTime()},n?9==(n=n.filter(function(e){return e.color!=t})).length&&n.pop():n=[],n.unshift(i),localStorage.setItem("recent_used_color",JSON.stringify(n)),e=8==l(this).siblings().length?l(this).index()+1:l(this).index()+10),t=t.substring(4,t.length-1),o.onSelect(t,e)),l("#color_picker").dropdown("close"),a.removeClass("selected")}),e.children(".color_transparent").off("click").on("click",function(){o.onSelect("transparent",0),l("#color_picker").dropdown("close")}),o.color&&e.find("div[col='"+o.color+"']").addClass("selected"),1==o.trans?e.find(".color_transparent").show():e.find(".color_transparent").hide(),l("#color_picker").children(".color_extend").remove(),o.extend&&l("#color_picker").append("<div class='color_extend'>"+o.extend+"</div>"))},l.fn.colorButton=function(o){var n=l(this);"string"!=typeof o?(n.html("<div class='picker_btn_holder'></div><div class='ico ico_colordrop'></div>"),n.bind("mousedown",function(e){var t,i;n.button("isDisabled")||(e.stopPropagation(),(t=l.extend({},o)).target=n,t.onSelect=function(e){n.colorButton("setColor",e),o.onSelect&&o.onSelect(e)},i=(i=(i=l(this).children(".picker_btn_holder").css("background-color")).replace(/\s/g,"")).substring(4,i.length-1),t.color=i,l.colorpicker(t))})):"setColor"==o&&n.children(".picker_btn_holder").css("background-color","rgb("+arguments[1]+")")},l.fn.spinner=function(i){var o=l(this);if("string"==typeof i){if("getValue"!=i)return void("setValue"==i?(o.find("input").val(arguments[1]),o.attr("old",arguments[1])):"setOptions"==i&&(void 0!==(e=arguments[1]).min&&o.attr("min",e.min),void 0!==e.max&&o.attr("max",e.max)));var e,t=o.find("input").val();return t=parseInt(t)}o.html("<div class='spinner_input'><input type='text'/></div><div class='buttons'><div class='spinner_up'></div><div class='spinner_down'></div></div>");void 0!==(i=l.extend({step:1,unit:""},i)).min&&o.attr("min",i.min),void 0!==i.max&&o.attr("max",i.max);var n=o.children(".spinner_input").find("input");o.spinner("setValue",i.min+i.unit),o.find(".spinner_up").bind("click",function(){var e;o.button("isDisabled")||(e=o.spinner("getValue")+i.step,a(o,e,i))}),o.find(".spinner_down").bind("click",function(){var e;o.button("isDisabled")||(e=o.spinner("getValue")-i.step,a(o,e,i))}),n.bind("keydown",function(e){var t;13==e.keyCode&&(t=parseInt(l(this).val()),isNaN(t)&&(t=i.min),a(o,t,i))}).bind("focus",function(e){l(this).select(),l(this).bind("mouseup",function(e){e.preventDefault(),l(this).unbind("mouseup")});var t=l(this).parent().parent();t.hasClass("active")||t.addClass("active inset")}).bind("blur",function(e){var t=l(this).parent().parent();t.hasClass("inset")&&t.removeClass("active inset")})},l.fn.menuitem=function(e){var t=l(this);if("string"==typeof e)if("disable"==e)t.addClass("disabled");else if("enable"==e)t.removeClass("disabled");else{if("isDisabled"==e)return t.hasClass("disabled");if("isSelected"==e)return 0<t.children(".ico_selected").length;if("unselect"==e)return t.children(".ico_selected").remove();if("select"==e)return t.prepend("<div class='ico ico_selected'></div>")}};var o=0;l.mask=function(e,t){var i;void 0===e&&(e="open"),"open"==e?(null==t&&(t=10),(i=l("<div class='dlg_mask' style='display:none'></div>").appendTo("body")).css({width:l(window).width()+"px",height:l(window).height()+"px",filter:"alpha(opacity=60)",opacity:"0.6",zIndex:t+o}).show(),o++,l(window).bind("resize.mask",function(){i.css({width:l(window).width()+"px",height:l(window).height()+"px"})}),i.on("click",function(){0==l(".dialog:visible").length&&l.mask("close")})):"close"==e&&(o=o-1<0?0:o-1,l(".dlg_mask").eq(o).remove(),l(window).unbind("resize.mask"))},l.fn.dlg=function(e){var t,i=l(this);i.length&&("string"!=typeof e?(e=l.extend({closable:!0},e),0==(t=i.children(".dlg_close")).length&&(t=l("<div class='ico dlg_close'></div>").appendTo(i)),0==e.closable?t.hide():t.show(),t.unbind().bind("click",function(){i.hide(),l.mask("close"),e&&e.onClose&&e.onClose(),l(document).unbind("keydown.closedlg"),i.find("input,textarea,select").unbind("keydown.closedlg")}),i.css({left:(l(window).width()-i.outerWidth())/2,top:(l(window).height()-i.outerHeight())/2,zIndex:11+o}),"block"!=i.css("display")&&l.mask(),i.show(),e.closable&&(i.find("input,textarea,select").unbind("keydown.closedlg").bind("keydown.closedlg",function(e){27==e.keyCode&&i.children(".dlg_close").trigger("click")}),l(document).unbind("keydown.closedlg").bind("keydown.closedlg",function(e){27==e.keyCode&&i.children(".dlg_close").trigger("click")})),i.children(".dialog_header").unbind("mousedown.drag_dlg").bind("mousedown.drag_dlg",function(e){var o=l(this).parent(),n=e.pageX,a=e.pageY,r=o.offset().left,s=o.offset().top;l(document).bind("mousemove.drag_dlg",function(e){var t=e.pageX-n+r,i=e.pageY-a+s;o.offset({left:t,top:i})}),l(document).bind("mouseup.drag_dlg",function(e){l(document).unbind("mousemove.drag_dlg"),l(document).unbind("mouseup.drag_dlg")})})):"close"==e&&i.children(".dlg_close").trigger("click"))}}(jQuery);