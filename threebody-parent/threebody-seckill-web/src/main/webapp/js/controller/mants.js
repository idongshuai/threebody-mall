Designer.events.addEventListener("initialized",function(){!localRuntime&&0!=CLB.findLocal()||Designer.open(definition)}),Designer.events.addEventListener("create",function(e){});var createdTip=!1;Designer.events.addEventListener("created",function(e){createdTip&&(UI.showStartStep("created",$("#"+e.id)),createdTip=!1)}),Designer.events.addEventListener("linkerCreating",function(e){}),Designer.events.addEventListener("resetBrokenLinker",function(e){var n=Model.define.page.lineJumps;if(null==n||0!=n||1!=e){if(e!=n&&null!=n&&(null!=e||0!=n)){var r=Model.orderList.length;if(400<r)return Model.intersection={},void(r<=600&&UI.showTip("<@i18n resource='diagraming.linejumps.tip'/>"));for(var a={},t=0,i=(_=Model.getLinkers("broken")).length;t<i;t++){a[(M=_[t]).id]=Utils.getLinesFromLinker(M)}var p=[];for(var o in a){var s=a[o];for(var l in a){var d=a[l];if(l!=o)for(t=0;t<s.length;t++)for(var h=s[t],c={x:h.x1,y:h.y1},g={x:h.x2,y:h.y2},v=0;v<d.length;v++){var u={},f=d[v],S={x:f.x1,y:f.y1},m={x:f.x2,y:f.y2};if(Utils.checkCross(c,g,S,m)){var y=Utils.intersection(c,g,S,m);if(Math.abs(y.x-c.x)<12&&Math.abs(y.y-c.y)<8)continue;if(Math.abs(y.x-g.x)<12&&Math.abs(y.y-g.y)<8)continue;if(Math.abs(y.x-S.x)<20&&Math.abs(y.y-S.y)<8)continue;if(Math.abs(y.x-m.x)<20&&Math.abs(y.y-m.y)<8)continue;y.y=Math.round(y.y);var x=o;c.y!=g.y&&S.y==m.y&&(x=l,0);var D=!1;if(0<p.length)for(var B=0;B<p.length;B++){var I=p[B];if(I.curveId&&I.curveId==x){u=I,D=!0;break}}null==u.points&&(u.points=[]),u.points.push(y),D||(u.curveId=x,p.push(u))}}}}var L=Utils.copy(Model.intersection);if(Model.intersection={},0<p.length)for(t=0;t<p.length;t++){var b=p[t],M=Model.getShapeById(b.curveId);b.points=b.points.sort(function(e,n){return e.x<n.x?-1:e.x>n.x?1:void 0});for(v=0;v<b.points.length-1;v++)b.points[v].x==b.points[v+1].x&&b.points[v].y==b.points[v+1].y&&(b.points.splice(v,1),v--);Designer.painter.renderLinker(M,null,null,b),Model.intersection[b.curveId]=b}if(!$.isEmptyObject(L))for(var o in L){null==Model.intersection[o]&&null!=(M=Model.getShapeById(o))&&Designer.painter.renderLinker(M)}used=[],p={},a=null}}else for(var _,t=0,i=(_=Model.getLinkers("broken")).length;t<i;t++){var M=_[t];Designer.painter.renderLinker(M),Model.intersection={}}}),Designer.events.addEventListener("changeLinkers",function(e){Designer.events.push("resetBrokenLinker")}),Designer.events.addEventListener("linkerCreated",function(e){Designer.events.push("resetBrokenLinker")}),Designer.events.addEventListener("setDefaultStyle",function(e){UI.setDefaultStyle(e)}),Designer.events.addEventListener("selectChanged",function(){UI.update(),Dock.update(),UI.showShapeOptions()}),Designer.events.addEventListener("clipboardChanged",function(e){0<e?$("#bar_list_edit").children("li[ac=paste]").menuitem("enable"):$("#bar_list_edit").children("li[ac=paste]").menuitem("disable")}),Designer.events.addEventListener("undoStackChanged",function(e){0==e?($("#bar_list_edit").children("li[ac=undo]").menuitem("disable"),$("#bar_undo").button("disable")):($("#bar_list_edit").children("li[ac=undo]").menuitem("enable"),$("#bar_undo").button("enable"))}),Designer.events.addEventListener("redoStackChanged",function(e){0==e?($("#bar_list_edit").children("li[ac=redo]").menuitem("disable"),$("#bar_redo").button("disable")):($("#bar_list_edit").children("li[ac=redo]").menuitem("enable"),$("#bar_redo").button("enable"))}),Designer.events.addEventListener("beforeResize",function(e){var n=e.shapes,r=e.minSize,a=e.dir;if(1==n.length){var t=n[0];if("verticalPool"==t.name){if("b"==a){for(var i=0,p=0;p<t.children.length;p++){var o=t.children[p];"horizontalSeparator"==(c=Model.getShapeById(o)).name&&(i+=c.props.h)}0==i?i=90:i+=40,r.h=i}else if("l"==a||"r"==a){for(var s=20,l=null,d=0,p=0;p<t.children.length;p++){o=t.children[p];"horizontalSeparator"==(c=Model.getShapeById(o)).name?d++:"verticalLane"==c.name&&((null==l||c.props.x<l.props.x&&"l"==a||c.props.x>l.props.x&&"r"==a)&&(l=c),s+=c.props.w)}null!=l&&(s-=l.props.w),0<d&&(s+=20),r.w=s}}else if("verticalLane"==t.name&&"b"==a){for(var i=0,l=t,h=Model.getShapeById(l.parent),p=0;p<h.children.length;p++){o=h.children[p];"horizontalSeparator"==(c=Model.getShapeById(o)).name&&(i+=c.props.h)}0==i&&(i=50),r.h=i}else if("horizontalPool"==t.name){if("r"==a){for(s=0,p=0;p<t.children.length;p++){o=t.children[p];"verticalSeparator"==(c=Model.getShapeById(o)).name&&(s+=c.props.w)}0==s?s=90:s+=40,r.w=s}else if("t"==a||"b"==a){for(i=20,l=null,d=0,p=0;p<t.children.length;p++){o=t.children[p];"verticalSeparator"==(c=Model.getShapeById(o)).name?d++:"horizontalLane"==c.name&&((null==l||c.props.y<l.props.y&&"t"==a||c.props.y>l.props.y&&"b"==a)&&(l=c),i+=c.props.h)}null!=l&&(i-=l.props.h),0<d&&(i+=20),r.h=i}}else if("horizontalLane"==t.name&&"r"==a){for(s=0,l=t,h=Model.getShapeById(l.parent),p=0;p<h.children.length;p++){var c,o=h.children[p];"verticalSeparator"==(c=Model.getShapeById(o)).name&&(s+=c.props.w)}0==s&&(s=50),r.w=s}else"cls"!=t.name&&"interface"!=t.name&&"package"!=t.name&&"combinedFragment"!=t.name||(r.h=50)}}),Designer.events.addEventListener("resizing",function(e){var n=e.shape,r=e.dir,a=e.offset,t=[];if("verticalPool"==n.name){if("b"==r)for(var i=0;i<n.children.length;i++){var p=n.children[i];"verticalLane"!=(h=Model.getShapeById(p)).name&&"verticalSeparatorBar"!=h.name||(h.props.h=n.props.h-40,Designer.painter.renderShape(h),t.push(h))}else if("r"==r){if(n.children&&0<n.children.length){for(var o=null,i=0;i<n.children.length;i++){p=n.children[i];"horizontalSeparator"==(h=Model.getShapeById(p)).name&&(h.props.w=n.props.w,Designer.painter.renderShape(h),t.push(h)),"verticalLane"==h.name&&(null==o||h.props.x>o.props.x)&&(o=h)}null!=o&&(o.props.w+=a.w,Designer.painter.renderShape(o),t.push(o))}}else if("l"==r&&n.children&&0<n.children.length){for(o=null,i=0;i<n.children.length;i++){p=n.children[i];"horizontalSeparator"==(h=Model.getShapeById(p)).name?(h.props.x+=a.x,h.props.w+=a.w,Designer.painter.renderShape(h),t.push(h)):"verticalSeparatorBar"==h.name&&(h.props.x+=a.x,Designer.painter.renderShape(h),t.push(h)),"verticalLane"==h.name&&(null==o||h.props.x<o.props.x)&&(o=h)}null!=o&&(o.props.w+=a.w,o.props.x+=a.x,Designer.painter.renderShape(o),t.push(o))}}else if("verticalLane"==n.name){var s,t=[s=Model.getShapeById(n.parent)];if(s.props.w+=a.w,s.props.h=n.props.h+40,s.props.x+=a.x,Designer.painter.renderShape(s),"r"==r){for(var l=[],d=Model.getPersistenceById(n.id),i=0;i<s.children.length;i++){(p=s.children[i])!=n.id&&(c=Model.getPersistenceById(p),"horizontalSeparator"==(h=Model.getShapeById(p)).name?(h.props.w+=a.w,Designer.painter.renderShape(h),t.push(h)):c.props.x>d.props.x&&"verticalLane"==c.name&&l.push(h))}0<l.length&&(g=Utils.getContainedShapes(l),v=Utils.getOutlinkers(g),g=g.concat(v),l=l.concat(g),Designer.op.moveShape(l,{x:a.w.toScale(),y:0}),t=t.concat(l))}else if("b"==r)for(i=0;i<s.children.length;i++){(p=s.children[i])!=n.id&&("verticalLane"!=(h=Model.getShapeById(p)).name&&"verticalSeparatorBar"!=h.name||(h.props.h=n.props.h,Designer.painter.renderShape(h),t.push(h)))}else if("l"==r){for(l=[],d=Model.getPersistenceById(n.id),i=0;i<s.children.length;i++){(p=s.children[i])!=n.id&&(c=Model.getPersistenceById(p),"horizontalSeparator"==(h=Model.getShapeById(p)).name?(h.props.x+=a.x,h.props.w+=a.w,Designer.painter.renderShape(h),t.push(h)):"verticalSeparatorBar"==h.name?(h.props.x+=a.x,Designer.painter.renderShape(h),t.push(h)):c.props.x<d.props.x&&"verticalLane"==c.name&&l.push(h))}0<l.length&&(g=Utils.getContainedShapes(l),v=Utils.getOutlinkers(g),g=g.concat(v),l=l.concat(g),Designer.op.moveShape(l,{x:a.x.toScale(),y:0}),t=t.concat(l))}}else if("horizontalSeparator"==n.name){t=[s=Model.getShapeById(n.parent)],s.props.h+=a.h,Designer.painter.renderShape(s);for(i=0;i<s.children.length;i++){var p=s.children[i],h=Model.getShapeById(p);p!=n.id&&("horizontalSeparator"!=h.name?(h.props.h+=a.h,Designer.painter.renderShape(h),t.push(h)):h.props.y>n.props.y&&(h.props.y+=a.h,Designer.painter.renderShape(h),t.push(h)))}}else if("horizontalPool"==n.name){if("r"==r)for(i=0;i<n.children.length;i++){p=n.children[i];"horizontalLane"!=(h=Model.getShapeById(p)).name&&"horizontalSeparatorBar"!=h.name||(h.props.w=n.props.w-40,Designer.painter.renderShape(h),t.push(h))}else if("b"==r){if(n.children&&0<n.children.length){for(o=null,i=0;i<n.children.length;i++){p=n.children[i];"verticalSeparator"==(h=Model.getShapeById(p)).name&&(h.props.h=n.props.h,Designer.painter.renderShape(h),t.push(h)),"horizontalLane"==h.name&&(null==o||h.props.y>o.props.y)&&(o=h)}null!=o&&(o.props.h+=a.h,Designer.painter.renderShape(o),t.push(o))}}else if("t"==r&&n.children&&0<n.children.length){for(o=null,i=0;i<n.children.length;i++){p=n.children[i];"verticalSeparator"==(h=Model.getShapeById(p)).name?(h.props.y+=a.y,h.props.h+=a.h,Designer.painter.renderShape(h),t.push(h)):"horizontalSeparatorBar"==h.name&&(h.props.y+=a.y,Designer.painter.renderShape(h),t.push(h)),"horizontalLane"==h.name&&(null==o||h.props.y<o.props.y)&&(o=h)}null!=o&&(o.props.h+=a.h,o.props.y+=a.y,Designer.painter.renderShape(o),t.push(o))}}else if("horizontalLane"==n.name){if(t=[s=Model.getShapeById(n.parent)],s.props.h+=a.h,s.props.w+=a.w,s.props.y+=a.y,Designer.painter.renderShape(s),"r"==r)for(i=0;i<s.children.length;i++){(p=s.children[i])!=n.id&&("horizontalLane"!=(h=Model.getShapeById(p)).name&&"horizontalSeparatorBar"!=h.name||(h.props.w=n.props.w,Designer.painter.renderShape(h),t.push(h)))}else if("b"==r){for(l=[],d=Model.getPersistenceById(n.id),i=0;i<s.children.length;i++){(p=s.children[i])!=n.id&&(c=Model.getPersistenceById(p),"verticalSeparator"==(h=Model.getShapeById(p)).name?(h.props.h+=a.h,Designer.painter.renderShape(h),t.push(h)):c.props.y>d.props.y&&"horizontalLane"==c.name&&l.push(h))}0<l.length&&(g=Utils.getContainedShapes(l),v=Utils.getOutlinkers(g),g=g.concat(v),l=l.concat(g),Designer.op.moveShape(l,{x:0,y:a.h.toScale()}),t=t.concat(l))}else if("t"==r){for(var c,g,v,l=[],d=Model.getPersistenceById(n.id),i=0;i<s.children.length;i++){(p=s.children[i])!=n.id&&(c=Model.getPersistenceById(p),"verticalSeparator"==(h=Model.getShapeById(p)).name?(h.props.y+=a.y,h.props.h+=a.h,Designer.painter.renderShape(h),t.push(h)):"horizontalSeparatorBar"==h.name?(h.props.y+=a.y,Designer.painter.renderShape(h),t.push(h)):c.props.y<d.props.y&&"horizontalLane"==c.name&&l.push(h))}0<l.length&&(g=Utils.getContainedShapes(l),v=Utils.getOutlinkers(g),g=g.concat(v),l=l.concat(g),Designer.op.moveShape(l,{x:0,y:a.y.toScale()}),t=t.concat(l))}}else if("verticalSeparator"==n.name){t=[s=Model.getShapeById(n.parent)],s.props.w+=a.w,Designer.painter.renderShape(s);for(i=0;i<s.children.length;i++){p=s.children[i],h=Model.getShapeById(p);p!=n.id&&("verticalSeparator"!=h.name?(h.props.w+=a.w,Designer.painter.renderShape(h),t.push(h)):h.props.x>n.props.x&&(h.props.x+=a.w,Designer.painter.renderShape(h),t.push(h)))}}return t}),Designer.events.addEventListener("beforeRemove",function(e){for(var n={},r=0;r<e.length;r++){n[(a=e[r]).id]=a}for(var a,t=[],r=0;r<e.length;r++){if("verticalSeparatorBar"==(a=e[r]).name&&!n[a.parent]&&t.indexOf(a.id)<0)delete n[a.id];else if("horizontalSeparatorBar"==a.name&&!n[a.parent]&&t.indexOf(a.id)<0)delete n[a.id];else if("horizontalSeparator"==a.name){for(var i=Model.getShapeById(a.parent),p=null,o=0,s=0;s<i.children.length;s++){var l=i.children[s];"horizontalSeparator"!=(d=Model.getShapeById(l)).name||n[l]?"verticalSeparatorBar"==d.name&&(p=d):o+=1}0==o&&null!=p&&(n[p.id]=p,t.indexOf(p.id)<0&&t.push(p.id))}else if("verticalSeparator"==a.name){for(i=Model.getShapeById(a.parent),p=null,o=0,s=0;s<i.children.length;s++){var d,l=i.children[s];"verticalSeparator"!=(d=Model.getShapeById(l)).name||n[l]?"horizontalSeparatorBar"==d.name&&(p=d):o+=1}0==o&&null!=p&&(n[p.id]=p,t.indexOf(p.id)<0&&t.push(p.id))}}for(var h in e=[],n)e.push(n[h]);return e}),Designer.events.addEventListener("removed",function(e){for(var n=e.shapes,r=e.range,a=e.changedIds,t=[],i=[],p=0;p<n.length;p++){var o=n[p];"verticalLane"==o.name&&r.indexOf(o.parent)<0&&i.indexOf(o.parent)<0||"horizontalLane"==o.name&&r.indexOf(o.parent)<0&&i.indexOf(o.parent)<0?i.push(o.parent):"verticalSeparatorBar"==o.name&&r.indexOf(o.parent)<0?((l=Model.getShapeById(o.parent)).props.w-=o.props.w,l.props.x+=o.props.w,Designer.painter.renderShape(l),a.indexOf(o.parent)<0&&(a.push(o.parent),t.push(l))):"horizontalSeparatorBar"==o.name&&r.indexOf(o.parent)<0?((l=Model.getShapeById(o.parent)).props.y+=o.props.h,l.props.h-=o.props.h,Designer.painter.renderShape(l),a.indexOf(o.parent)<0&&(a.push(o.parent),t.push(l))):("horizontalSeparator"==o.name&&r.indexOf(o.parent)<0&&i.indexOf(o.parent)<0||"verticalSeparator"==o.name&&r.indexOf(o.parent)<0&&i.indexOf(o.parent)<0)&&i.push(o.parent)}for(var s=0;s<i.length;s++){var l,d=i[s];if("verticalPool"==(l=Model.getShapeById(d)).name){for(var h=0,c=0,p=0;p<l.children.length;p++){var g=l.children[p];"verticalLane"==(f=Model.getShapeById(g)).name?(c++,h+=f.props.w):"verticalSeparatorBar"==f.name&&(h+=f.props.w)}0<c&&(l.props.w=h,Designer.painter.renderShape(l),a.indexOf(d)<0&&(a.push(d),t.push(l)),v=Utils.rangeChildren(l),t=t.concat(v))}else if("horizontalPool"==l.name){for(var v,u=0,c=0,p=0;p<l.children.length;p++){var f,g=l.children[p];"horizontalLane"==(f=Model.getShapeById(g)).name?(c++,u+=f.props.h):"horizontalSeparatorBar"==f.name&&(u+=f.props.h)}0<c&&(l.props.h=u,Designer.painter.renderShape(l),a.indexOf(d)<0&&(a.push(d),t.push(l)),v=Utils.rangeChildren(l),t=t.concat(v))}}return t}),Designer.events.addEventListener("shapeChanged",function(e){}),Designer.events.addEventListener("vip-limit",function(e){console.log("触发会员"),UI.showVipLimitDlg(e)}),Designer.events.addEventListener("setTopUpgradeBtn",function(){UI.setTopUpgradeBtnB()}),Designer.events.addEventListener("setNickPortrait",function(e){CLB.userInfo.nickName=CLB.filterIllegalWord(e.nickname);var n=e.portraitUrl||"";CLB.userInfo.portrait=n.split("?")[0]}),Designer.events.addEventListener("searchDocerIcon",function(n){$.ajax({url:"/docer/icon/search",data:{name:n.name,offset:n.offset,limit:n.limit},success:function(e){encrypted_session&&e.data;n.callback(e)},error:function(e){n.callback(e)}})}),Designer.events.addEventListener("recDocerIcon",function(n){$.ajax({url:"/docer/rec_icons",success:function(e){encrypted_session&&e.data;n.callback(e)},error:function(e){n.callback(e)}})}),Designer.events.addEventListener("po-vip-limit",function(e){var n;"undefined"==typeof vipOrderPosition&&!vipOrderPosition[e]||(n=vipOrderPosition[e].replace("_po_","_act_"),sendMessage("notify",{eventType:"useMembershipFeatures",action:n}))}),Designer.events.addEventListener("vip-limit-warn",function(){Util.globalTopTip2({content:"当前图形数还有20个达到上限",type:"top_info",btn:"升级",delay:1e4,btnclick:function(){UI.upgradeVip("nodecout_warn")}})}),Designer.events.addEventListener("setUpgradeBtn",function(){setTimeout(function(){UI.setTopUpgradeBtnB()},500)}),Designer.events.addEventListener("tdocCollect",function(e){try{var n={panel_basic:"basis",panel_flow:"flowchart",panel_bpmn:"bpmn",panel_evc:"",panel_epc:"",panel_lane:"swimming",panel_er:"",panel_org:"",panel_venn:"",panel_uml_usecase:"",panel_uml_sequence:"",panel_uml_class:"",panel_uml_stateactivity:"",panel_uml_deployment:"",panel_uml_component:""};console.log(e),n[e.type]&&tdocCollect({opername:"flowchart",module:"graphics",action:n[e.type],ver5:e.index+1})}catch(e){}}),Designer.events.addEventListener("showDocerVipBtn",function(e){"add"==e?($("#shape_panel").append("<div class='panel_container panel_collapsed'><h3 class='panel_title search'><input id='shape_search' type='text' placeholder='搜索'/></h3><div id='panel_search' class='content'> </div></div>"),$("#panel_search").next().hasClass("docer-icon-vip-btn")||$("#panel_search").after("<div id='icon-docer-vip-btn' class='docer-icon-vip-btn docer-vip-btn docer-upgrade-btn'><img class='docer-vip-imgicon' src='/assets/images/svip_icon_new.svg' ><span class='upgrade-vip-text'>升级超级会员</span></div>")):Utils.testVipState(function(){tdocVipInfo.indexOf(12)<0&&tdocVipInfo.indexOf(40)<0||$("#icon-docer-vip-btn").css("display","none")})});