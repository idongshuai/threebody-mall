var mindDesigner=function(e,t,i,n){var o,r,l,s;this.container=$(e),this.containerId=e,this.opts=$.extend({canvasW:2e4,canvasH:2e4,readonly:!1},t),null!=n&&(this.opts.themeDef=n),null==this.opts.chartId&&(this.opts.chartId=this.model.newId()),this.model.groupList.clearData(),null!=i||null!=(i=this.messageSource.checkLocalValue(this.opts.chartId))?(o="object"==typeof i?i:JSON.parse(i),r=this.util.getNewDef(o,this),this.model.topic=r):((l=this.model).topic=this.util.copy(l.topicDef),s=l.topic,l.groupList.doGroup(s,l.topic.structure)),localStorage.removeItem("recentTags"),this.styles=this.style.getThemeStyle.call(this,n),this.initCanvas(),this.line.renderLineCon.call(this),this.operation.setWatermark.call(this,null,!0),this.render(),this.events.push("loadsuccess",this)};mindDesigner.prototype={currentRoot:null,render:function(){var e=this.model.topic;this.model.topicList.resetTopicList.call(this),this.renderTopic(e)},renderTopic:function(e){var t=this;t.renderCenterTopic(e),t.range.rangeTopics.call(t,e),t.renderFreeTopics(),t.renderFreeSummaries(),t.connection.loadConnections.call(t)},renderSubTopic:function(e,t,i,n){var u=this,h=u.summary;u.model;!function e(t,i,n,o){if(!t)return;if(t.summary){if("mind_tree"==u.model.topic.structure)return;h.renderSummaryDom(u,t,n)}else u.renderTopicDom(t,n,i,o);if(t.collapsed)return;var r=t.children;var l=r.length;if(0<l)for(var s=0;s<l;s++){var a=r[s];e(a,null,n)}if(null!=t.summaries&&0<t.summaries.length)for(var c=t.summaries.length,d=0;d<c;d++){var p=t.summaries[d];e(p,null,n)}}(e,t,i,n)},renderFreeSummaries:function(e,t){var i=this,n=i.model.topic,o=i.currentRoot||n,r=n.structure,l="mind_tree"==n.structure,s=i.util,a=i.operation.zoomVal/100,c=o.summaries;if(!l){var d=null!=i.currentRoot,p=[];if(null!=c&&0<c.length){for(var u=o.children,h=o.leftChildren||[],m=c.length,r="mind_org"==n.structure,g=0;g<m;g++){var f=c[g],v=s.copy(f);if(!(null!=t&&0<=t.indexOf(v.id))){var y=v.range+"",x=Number(0<y.indexOf(",")?y.split(",")[0]:y),b=Number(0<y.indexOf(",")?y.split(",")[1]:y),T={},C=null,S=null,S="right"==v.part||d?(C=u[x],u[b]):(C=h[x],h[b]);if(null==C&&null!=h[x]&&(C=h[x],v.part="left"),null==S&&null!=h[b]&&(S=h[b],v.part="left"),null==S&&(S=u[u.length-1]),null!=C){var w=s.getTopicContainer(C.id),k=s.getTopicContainer(S.id),$=Math.max(w.width(),k.width()),I=Math.min(w.position().left,k.position().left),L=-1;r&&(L=Math.max(w.position().top/a+w.height(),k.position().top/a+k.height()));for(var P=x+1;P<b;P++){var _,M="left"==v.part?h[P]:u[P];null!=M&&(_=s.getTopicContainer(M.id),$=Math.max($,_.width()),I=Math.min(I,_.position().left),r&&(L=Math.max(L,_.position().top/a+_.height())))}var W=w.position().left/a+$+38;"left"==v.part&&(W=I/a-38);var O=w.position().top/a,D=k.position().top/a+k.outerHeight(),B=(O+D)/2;r&&($=k.position().left+k.width()-w.position().left,B=L+38,W=w.position().left/a+$/2,T.x1=k.position().left/a+k.width(),T.x2=w.position().left/a),T.x=W,T.y=B,T.minY=O,T.maxY=D,r&&(T.maxY=L),v.pos=s.copy(T),i.renderSubTopic(v,null,v.part||"right");var A=s.getTopicContainer(v.id);r?A.css("left","-="+A.width()/2+"px"):(A.css("top","-="+A.height()/2+"px"),"left"==v.part&&A.css("left","-="+A.width()+"px"));var H=A.children(".topic-box"),z=r?{x:A.outerWidth()/2,y:H.outerHeight(),h:H.outerHeight()}:l?{x:9,y:H.outerHeight(),h:H.outerHeight()}:"left"==v.part?{x:A.outerWidth()-H.outerWidth(),y:A.outerHeight()/2-.5,h:H.outerHeight()}:{x:H.outerWidth(),y:A.outerHeight()/2-.5,h:H.outerHeight()};i.line.renderLines.call(i,v,z,v.part),p.push(v)}}}i.summary.renderFreeSummariesShape.call(i,p,r,o)}}},renderFreeTopics:function(){var p=this,e=p.model,u=p.summary,t=e.groupList,i=e.topic,n="mind_org"==i.structure,h="mind_tree"==i.structure,o=p.util,r=p.line;if(t.freeList.length)for(var l=0,s=t.freeList.length;l<s;l++){var a=t.freeList[l];!function e(t,i,n){t.summary?h||u.renderSummaryDom(p,t,i):p.renderTopicDom(t,i,null,n);if(t.collapsed)return;var o=t.children,r=o.length;if(0<r)for(var l=0;l<r;l++){var s=o[l];e(s,i)}if(null!=t.summaries&&0<t.summaries.length)for(var a=t.summaries.length,c=0;c<a;c++){var d=t.summaries[c];e(d,i)}}(a);var c=o.getSelectedPart(a.id,i.structure),d=o.getTopicContainer(a.id),m=d.children(".topic-box"),g=n?{x:d.outerWidth()/2,y:m.outerHeight(),h:m.outerHeight()}:h?{x:9,y:m.outerHeight(),h:m.outerHeight()}:"left"==c?{x:d.outerWidth()-m.outerWidth(),y:d.outerHeight()/2-.5,h:m.outerHeight()}:{x:m.outerWidth(),y:d.outerHeight()/2-.5,h:m.outerHeight()};r.renderLines.call(p,a,g,c)}},renderTopics:function(e,t){var d=this;d.summary;!function e(t,i){if(t.collapsed)return;var n=t.children,o=n.length;if(0<o)for(var r=0;r<o;r++){var l=n[r];d.renderTopicDom(l,i),e(l,i)}if(null!=t.summaries&&0<t.summaries.length)for(var s=t.summaries.length,a=0;a<s;a++){var c=t.summaries[a];e(c,i)}}(e,t)},renderTopicDom:function(e,t,i,n){var o=this,r=o.util,l=o.designer,s=this.model,a=o.operation,c=o.currentRoot||s.topic,d=c.structure||s.topic.structure,p=this.styles,u=r.getMargin.call(o),h=u.childMarginW,m=u.childMarginH,g=$("#"+e.id);0<g.length&&g.parent().remove();var f="mind_org"==d,v="mind_tree"==d,y=e.title.replace(/\n/g,"<br>").replace(/\&lt;br\&gt;/g,"<br>").replace(/\u2029/g,"<br>").replace(/\u2028/g,"<br>").replace(/\x0a/g,"<br>").replace(/\x0d/g,"<br>").replace(/[\x00-\x1f]+/g," "),x="";f?(x="org",m=40):v&&(x="tree",m=26);var b,T,C,S,w,k,I=(g=$("<div class='topic-container "+x+"'><div id='"+e.id+"' class='topic-box'><div class='topic'>"+y+"</div></div></div>")).children(".topic-box");e.root||e.parent==c.id?(I.attr("sub",!0),e.pos?(g.css("position","absolute").appendTo(l),g.css({left:e.pos.x,top:e.pos.y}),I.addClass("free")):g.css("position","absolute").prependTo(l),o.line.renderSubLineCon(g,e.id)):(b="topic-children",0==(C=(T=$("#"+e.parent).parent()).children("."+b)).length&&(C=$("<div class='"+b+"'></div>"),"left"==t?(C.prependTo(T),f||v?v&&C.css("margin-right",p.childMarginW+8):C.css("margin-right",h+16)):(C.appendTo(T),f||v?v&&C.css("margin-left",p.childMarginW+8):C.css("margin-left",h+16))),g.css("margin-top",m),null!=n?0<=(S=n-1)?null!=i&&null!=i.summaries&&0<i.summaries.length?(w=i.children[S],(k=r.getTopicContainer(w.id)).parent().parent().hasClass("summary-con")?k.parent().parent().index()+(k.parent().children().length-1)<=n?k.parent().parent().after(g):C.append(g):k.after(g)):(k=C.children().eq(n-1)).after(g):S<0&&(null!=i&&null!=i.summaries&&0<i.summaries.length&&0<(k=C.children().eq(0)).length&&k.parent().parent().hasClass("summary-con")?C.append(g):C.prepend(g),"0px"==g.next().css("margin-top")&&g.next().css("margin-top",m)):g.appendTo(C),"left"==t&&g.addClass("part_left")),a.renderTopicImage(e);var L=o.style.getStyle.call(o,e);return this.renderTopicStyle(I,e,L,p.thinner),o.icons.renderTopicIcons(r,e,t),o.remark.renderTopicNote(r,e,t),a.renderTopicLink(r,e,t),o.tags.renderTopicTag(r,e,t),o.task.renderTopicTask(r,e,t),null!=i?(this.renderTopicExpand(i,$("#"+i.id),t,L),0<e.children.length&&this.renderTopicExpand(e,I,t,L)):this.renderTopicExpand(e,I,t,L),g},renderCenterTopic:function(e){var t=this.model;this.renderTopicDom(e);var i=this.opts,n=t.getTopicDomById(e.id);n.css({left:(i.canvasW-n.width())/2,top:(i.canvasH-n.height())/2}),i.readonly||this.util.selectOne.call(this,e)},renderTopicStyle:function(e,t,i,n){var o;i["font-family"]=i["font-family"]||i.family,i["font-style"]=null!=i["font-style"]?i["font-style"]:i.italic?"italic":"normal",i["font-weight"]=null!=i["font-weight"]?i["font-weight"]:i.bold?"bold":"normal",null!=i["border-style"]&&null==i["border-width"]&&(i["border-width"]="0px"),e.removeAttr("style"),e.css(i),null!=i["text-decoration"]&&"none"!=i["text-decoration"]?e.children(".topic").css("text-decoration",i["text-decoration"]):e.children(".topic").removeAttr("style"),n&&null!=i.lineStyle&&i.lineStyle.underLine&&(o=this.style.getLineColor(),e.css("border-bottom-color",o))},renderTopicExpand:function(e,t,i,n){var o,r,l,s,a,c,d,p;e.children.length<1||e.root||((o=t.find("span.expand_box")).length<1&&(o=$("<span class='expand_box mind-icons'>&#xe7bb;</span>").appendTo(t)),e.collapsed&&this.operation.nodeAmount.call(this,e),r=this.model,l=this.currentRoot||r.topic,s=r.topic.background||this.styles.background,"left"==i&&o.addClass("left"),a={},a="mind_org"==l.structure?{backgroundColor:s,top:t.outerHeight()+14}:"mind_tree"==l.structure?{backgroundColor:s,top:t.outerHeight()+4}:{backgroundColor:s},c=e.id,(d=$("#line_"+c).attr("stroke"))?(a.color=d,a.borderColor=d):null==n||(p=n.lineStyle)&&p.lineColor&&(a.color=p.lineColor,a.borderColor=p.lineColor),o.css(a))},resetTopicExpandPos:function(e,t){var i=e.find(".expand_box");"mind_org"==t?i.css({top:e.outerHeight()+14}):"mind_tree"==t?i.css({top:e.outerHeight()+4}):i.css({})},range:{rangeTopics:function(e){var t=this,i=t.opts,n=t.operation,o=t.model,r=t.util,l=t.line,s=e.structure||o.topic.structure,a=o.groupList,c=t.styles,d=r.getTopicDomProp(e.id,n.zoomVal/100);if(a.doGroup(e,s),"mind"==s||"mind_right"==s||"mind_free"==s){var p=e.leftChildren||[],u=a.rightList,h=r.getMargin.call(t),m=p.length,g=u.length,f=0,v=0,y=h.marginW,x=h.marginH,b={};if(0<m)for(var T=0;T<m;T++){var C=p[T];t.renderSubTopic(C,null,"left"),f+=(P=r.getTopicContainer(C.id)).outerHeight(),T<m-1&&(f+=x),b[C.id]=P}for(var S={},T=0;T<g;T++){C=u[T];t.renderSubTopic(C,null,"right"),v+=(P=r.getTopicContainer(C.id)).outerHeight(),T<g-1&&(v+=x),S[C.id]=P}for(var w=d.x+d.w+y,k=Math.round(d.y+(d.h-v)/2),$={x:d.x+d.w/2,y:d.y+d.h/2},T=0;T<g;T++){(P=S[(C=u[T]).id]).css({top:k,left:w});var I={x:w,y:k+P.outerHeight()/2};l.renderSubLine.call(t,C,e,$,I,"right"),(0<C.children.length||null!=C.summaries&&0<C.summaries.length)&&(M={x:(_=P.children(".topic-box")).outerWidth(),y:Math.round(P.outerHeight()/2),h:_.outerHeight()},l.renderLines.call(t,C,M,"right")),k+=x+P.outerHeight()}if(0<m){w=d.x-y,k=Math.round(d.y+(d.h-f)/2);for(T=0;T<m;T++){(P=b[(C=p[T]).id]).css({top:k,right:i.canvasW-w});I={x:w,y:k+P.outerHeight()/2};l.renderSubLine.call(t,C,e,$,I,"left"),(0<C.children.length||null!=C.summaries&&0<C.summaries.length)&&(M={x:(_=P.children(".topic-box")).position().left,y:Math.floor(P.outerHeight()/2),h:_.outerHeight()},l.renderLines.call(t,C,M,"left")),k+=x+P.outerHeight()}}}else if("mind_org"==s){for(var g=(u=a.rightList).length,L=0,y=c.marginW,x=c.marginH,S={},T=0;T<g;T++){C=u[T];t.renderSubTopic(C,null,"right");var P=r.getTopicContainer(C.id);S[C.id]=P}for(w=($={x:d.x+d.w/2,y:d.y+d.h}).x,k=d.y+d.h+2*x,T=0;T<g;T++){(P=S[(C=u[T]).id]).css({top:k,left:w}),L+=P.outerWidth(),T!=g-1&&(L+=y/2)}w-=L/2;for(T=0;T<g;T++){(P=S[(C=u[T]).id]).css({left:w});I={x:w+P.outerWidth()/2,y:k};l.renderSubLine.call(t,C,e,$,I,"right"),(0<C.children.length||null!=C.summaries&&0<C.summaries.length)&&(_=P.children(".topic-box"),M={x:P.outerWidth()/2,y:_.outerHeight(),h:_.outerHeight()},l.renderLines.call(t,C,M,"right")),w+=P.outerWidth()+y/2}}else if("mind_tree"==s){for(g=(u=a.rightList).length,L=0,y=c.marginW,x=c.marginH,S={},T=0;T<g;T++){C=u[T];t.renderSubTopic(C,null,"right");P=r.getTopicContainer(C.id);S[C.id]=P}for(w=($={x:d.x+d.w/2,y:d.y+d.h}).x,k=d.y+d.h+2*x,T=0;T<g;T++){(P=S[(C=u[T]).id]).css({top:k,left:w}),L+=P.outerWidth(),T!=g-1&&(L+=y/2)}w-=L/2;for(T=0;T<g;T++){(P=S[(C=u[T]).id]).css({left:w});var _,M,I={x:w+P.children(".topic-box").outerWidth()/2,y:k};l.renderSubLine.call(t,C,e,$,I,"right"),0<C.children.length&&(M={x:10,y:(_=P.children(".topic-box")).outerHeight(),h:_.outerHeight()},l.renderLines.call(t,C,M,"right")),w+=P.outerWidth()+y/2}}},changeOrgTopicPos:function(e,t,i,n,o,r,l){for(var s=e.model,a=e.currentRoot||s.topic,c=s.groupList,d=c.rightList.length,p=e.util,u=e.operation.zoomVal/100,h=p.getTopicDomProp(a.id,u),m=c.rightList,g=0,f={},v={x:h.x+h.w/2,y:h.y+h.h}.x,y=h.y+h.h+2*l,x=0;x<d;x++){var b=m[x],T=p.getTopicContainer(b.id);(f[b.id]=T).css({top:y,left:v}),g+=T.outerWidth(),x!=d-1&&(g+=r/2)}v-=g/2;for(x=0;x<d;x++){(T=f[(b=m[x]).id]).css({left:v}),v+=T.outerWidth()+r/2}},changeTopicPos:function(e,t,i,n,o){var r,l,s,a,c,d=e.model,p=e.opts,u=e.currentRoot||d.topic,h="mind_org"==u.structure,m="mind_tree"==u.structure,g=e.util,f=0,v=(e.styles,e.operation.zoomVal/100),y=e.util.getMargin.call(e),x=y.marginW,b=y.marginH;if(h||m)this.changeOrgTopicPos(e,t,i,o,h,x,b);else{if(t.id!=i.id){if((f=((r=g.getTopicContainer(i.id)).outerHeight()-o.h)/2)<=0)return}else f=((r=g.getTopicContainer(t.id)).outerHeight()+b)/2;if(!i.free){if("right"==n){if(1==d.groupList.rightList.length)return l=g.getTopicDomProp(u.id,v),void r.css({left:l.x+l.w+x,top:Math.round(l.y+(l.h-r.outerHeight())/2)});a=null==(s=d.getPrevTopicWithoutFree(i))?i.id==t.id?(c=d.getNextTopic(i),null==(l=g.getTopicDomProp(c.id,v))?((l=g.getTopicDomProp(u.id,v)).x=l.x+l.w+x,l.y+(l.h-r.outerHeight())/2):l.y-f):(l=g.getTopicDomProp(i.id,v)).y-f:(l=g.getTopicDomProp(s.id,v)).y+l.h+b-f,r.css({left:l.x,top:Math.round(a)}),e.range.doChangeSubTopicPos(e,i,f,0,n)}else if("left"==n){if(1==u.leftChildren.length)return l=g.getTopicDomProp(u.id,v),void r.css({right:p.canvasW-l.x+x,top:Math.round(l.y+(l.h-r.outerHeight())/2)});a=null==(s=d.getPrevTopicWithoutFree(i,n))?i.id==t.id?(c=d.getNextTopic(i,n),(l=g.getTopicDomProp(c.id,v)).y-f):(l=g.getTopicDomProp(i.id,v)).y-f:(l=g.getTopicDomProp(s.id,v)).y+l.h+b-f,r.css({right:p.canvasW-l.x-l.w,top:Math.round(a)}),e.range.doChangeSubTopicPos(e,i,f,0,n)}return f}r.css({top:"-="+f})}},doChangeOrgSubTopicPos:function(e,t,i,n,o,r){var l=e.util,s=Math.abs;if(t.root){var a=l.getTopicContainer(t.id);return 0<i?a.css("top","-="+2*s(i)):i<0&&a.css("top","+="+2*s(i)),void(0<n?a.css("left","-="+s(n)/2):n<0&&a.css("left","+="+s(n)/2))}if(!t.free&&0!=n)for(var c=e.model,l=(e.currentRoot||c.topic,e.util),d=c.groupList.rightList,p=!0,u=d.length,h=0;h<u;h++){var m,g=d[h];g.id!=t.id?(m=l.getTopicContainer(g.id),p?m.css("left","-="+n/2):p||m.css("left","+="+n/2)):(p=!1,(m=l.getTopicContainer(g.id)).css("left","-="+n/2))}},doChangeSubTopicPos:function(e,t,i,n,o,r){var l=e.util,s=e.model;if("mind_org"!=(h=e.currentRoot||s.topic).structure&&"mind_tree"!=h.structure){if(t.root){var a=l.getTopicContainer(t.id),c=t.leftChildren||[];if(0<i?a.css("top","-="+Math.abs(i)):i<0&&a.css("top","+="+Math.abs(i)),0<n){if(a.css("left","-="+Math.abs(n)),0<c.length)for(var d=0,p=c.length;d<p;d++){var u=c[d];l.getTopicContainer(u.id).css("right","+="+Math.abs(n))}}else if(n<0&&(a.css("left","+="+Math.abs(n)),0<c.length))for(d=0,p=c.length;d<p;d++){u=c[d];l.getTopicContainer(u.id).css("right","-="+Math.abs(n))}}else if(0!=i)if(t.free){(a=e.util.getTopicContainer(t.id)).css("top","-="+i)}else{var s=e.model,h=e.currentRoot||s.topic,l=e.util,m=s.groupList.rightList,g=!0;"left"==o&&(m=h.leftChildren);for(p=m.length,d=0;d<p;d++){var f,v=m[d];v.id!=t.id?(f=l.getTopicContainer(v.id),g?f.css("top","-="+i):g||f.css("top","+="+i)):(g=!1,(i<0||r)&&(f=l.getTopicContainer(v.id)).css("top","-="+i))}}}else this.doChangeOrgSubTopicPos(e,t,i,n,o,r)},resetSubTopics:function(e){var t=this,i=t.model,n=this.currentRoot||i.topic,o=t.operation.zoomVal/100,r=t.opts,l=t.util,s=t.line,a=n.structure,c=i.groupList,d=(t.styles,l.getTopicDomProp(n.id,o));if(0!=n.children.length||null!=n.leftChildren){var p=t.util.getMargin.call(t),u=c.rightList;"left"==e&&(u=n.leftChildren||[]);var h=u.length,m=0,g=p.marginH,f=p.marginW,v={};if(0<h)for(var y=0;y<h;y++){null==(w=u[y]).pos&&(m+=(k=l.getTopicContainer(w.id)).outerHeight(),y<h-1&&(m+=g),v[w.id]=k)}var x={x:d.x+d.w/2,y:d.y+d.h/2},b=Math.round(d.y+(d.h-m)/2);if("left"==e)for(var T=d.x-f,y=0;y<h;y++){null!=(w=u[y]).pos||n.id==w.parent&&w.summary||((k=v[w.id]).css({top:b,right:r.canvasW-T}),$={x:T,y:b+k.outerHeight()/2},s.renderSubLine.call(t,w,n,x,$,"left"),b+=g+k.outerHeight())}else if("mind_tree"==a||"mind_org"==a){for(var T=(x={x:d.x+d.w/2,y:d.y+d.h}).x,b=d.y+d.h+2*g,C=0,y=0;y<h;y++){null!=(w=u[y]).pos||n.id==w.parent&&w.summary||(C+=(k=v[w.id]).outerWidth(),y!=h-1&&(C+=f/2))}T-=C/2;for(var S,y=0;y<h;y++){null==(w=u[y]).pos&&((k=v[w.id]).css({left:T,top:b}),$={x:T+(S=k.children(".topic-box")).position().left+S.outerWidth()/2,y:b},s.renderSubLine.call(t,w,n,x,$,"right"),T+=k.outerWidth()+f/2)}}else for(var w,k,$,T=d.x+d.w+f,y=0;y<h;y++){null!=(w=u[y]).pos||n.id==w.parent&&w.summary||((k=v[w.id]).css({top:b,left:T}),$={x:T,y:b+k.outerHeight()/2},s.renderSubLine.call(t,w,n,x,$,e),b+=g+k.outerHeight())}}}},initCanvas:function(){var e=this.container,t=(this.model.topic,this.opts),i=(this.styles,$(window).height());e.css({height:t.height?t.height:i-e.siblings("div:visible:not(.embeditem)").height()});var n=$("<div class='mind-designer'></div>").appendTo(e);n.css({width:t.canvasW,height:t.canvasH}),this.designer=n,this.operation.moveToCenter.call(this),this.operation.setBackground.call(this),this.initEvent()},initEvent:function(){var k=this,I=k.opts,d=k.operation,L=k.util,P=k.model,_=P.topic,M=k.connection;$(document).off("mousedown.dragmove").on("mousedown.dragmove",function(e){var n,o,r=e.pageX,l=e.pageY;c=0,(e.ctrlKey||e.metaKey)&&k.plugins.presenter.beforeSelecting?0==k.plugins.presenter.selecting&&(k.plugins.presenter.selecting=!0,k.plugins.presenter.initEvent(k,r,l,e)):2!=e.button&&(k.events.push("hideMenu"),e.ctrlKey||e.metaKey?d.selectingBox.call(k,e):(n=k.container.scrollTop(),o=k.container.scrollLeft(),$(document).on("mousemove.dragmove",function(e){var t=e.pageX-r,i=e.pageY-l;(6<Math.abs(t)||6<Math.abs(i))&&(k.container.scrollLeft(o-t),k.container.scrollTop(n-i))}),$(document).on("mouseup.dragmove",function(e){$(document).off("mousemove.dragmove"),$(document).off("mouseup.dragmove"),k.plugins.navigator.renderViewport()})))}),$(document).off("mouseup.expand").on("mouseup.expand",".expand_box",function(e){$(document).off("mousemove.dragmove"),$(document).off("mouseup.dragmove");var t=$(this).parent().attr("id");k.operation.showOrHideChildren.call(k,t),e.stopPropagation()}),$(document).off("mousedown.expand").on("mousedown.expand",".expand_box",function(e){e.stopPropagation()}),$(document).off("dblclick.expand").on("dblclick.expand",".expand_box",function(e){e.stopPropagation()});var o,g,c,s=0,a=0,p=!1,u=null;function e(e){o=Math.round(100*e.scale),e.preventDefault()}function t(e){var t,i=Math.round(100*e.scale),n=i-o;5<=Math.abs(n)&&(n<0?((t=k.operation.zoomVal-=5)<40&&(t=40),k.operation.tochZoom.call(k,k.designer,t),$(".mind-zoomtxt").text(t+"%")):0<n&&(200<(t=k.operation.zoomVal+=5)&&(t=200),k.operation.tochZoom.call(k,k.designer,t),$(".mind-zoomtxt").text(t+"%")),o=i),e.preventDefault()}function i(e){e.preventDefault()}$(document).off("mousemove.mouse").on("mousemove.mouse",function(e){p||(s=e.pageX,a=e.pageY)}),k.designer.on("mousewheel DOMMouseScroll",function(e){var t,i,n,o,r=e.originalEvent.wheelDelta||-e.originalEvent.detail,l=Math.max(-1,Math.min(1,r));e.ctrlKey||e.metaKey?(p=!0,e.preventDefault(),t=k.container.scrollLeft()+s,i=k.container.scrollTop()+a,n=t/k.opts.canvasW*100+"% "+i/k.opts.canvasH*100+"%",l<0?(o=k.operation.zoomVal-=5)<40&&(o=40):200<(o=k.operation.zoomVal+=5)&&(o=200),k.operation.tochZoom.call(k,k.designer,o,n),$(".mind-zoomtxt").text(o+"%"),null==u&&(u=setTimeout(function(){p=!1,u=null},200))):k.plugins.navigator.renderViewport(),$("#note_view_box").dropdown("close")}),document.addEventListener("gesturestart",function(e){e.preventDefault()}),0<navigator.userAgent.indexOf("Mac OS")&&(k.designer[0].removeEventListener("gesturestart",e),k.designer[0].removeEventListener("gesturechange",t),k.designer[0].removeEventListener("gestureend",i),o=0,k.designer[0].addEventListener("gesturestart",e,!1),k.designer[0].addEventListener("gesturechange",t,!1),k.designer[0].addEventListener("gestureend",i,!1)),k.opts.readonly||($(window).on("resize.canvas",function(e){var t=$(window).height(),i=($(window).width(),k.container);i.css({height:k.opts.height?k.opts.height:t-i.siblings("div:visible").height()})}),g="",c=0,$(document).off("keydown.hotkey").on("keydown.hotkey",function(e){if(k.opts.readonly||3<c)return k.plugins.presenter.keyEvent(e,k),void(3<c&&e.preventDefault());var t,i,n;if(!d.draging)if(c++,13==(s=e.keyCode)){if(d.appendTopic.call(k,!1),0==(o=k.util.getSelectedId()).length)return;d.editTopicDom.call(k,o),k.model.poPasteType="editpaste",e.preventDefault()}else if(45==s||9==s){if(e.preventDefault(),0==(t=k.util.getSelectedId()).length)return;d.appendTopic.call(k,!0);var o=k.util.getSelectedId();d.editTopicDom.call(k,o),k.model.poPasteType="editpaste"}else if(27==s)d.closeTip(),$(".topic-box.cut_related").removeClass("cut_related"),e.preventDefault();else if(46==s||8==s)if(e.preventDefault(),""!=g)d.removeTopicImage.call(k,g),g="";else{if(M.currentLine&&M.deleteConnection(k,M.currentLine),0==(t=k.util.getSelectedId()).length||""==t)return;e.ctrlKey||e.metaKey?d.removeTopicSelf.call(k):d.removeTopic.call(k)}else if(37==s){if(e.ctrlKey||e.metaKey){c--;var r=k.container.scrollLeft();return k.container.scrollLeft(r-10),void e.preventDefault()}if(k.plugins.presenter.presenting)return void k.plugins.presenter.prevSlide(k);null!=(l=P.getNearTopic.call(k,"left"))&&(L.selectOne.call(k,l),e.preventDefault())}else if(38==s||36==s){if(e.ctrlKey||e.metaKey){c--;r=k.container.scrollTop();return k.container.scrollTop(r-10),void e.preventDefault()}null!=(l=P.getNearTopic.call(k,"up"))&&(L.selectOne.call(k,l),e.preventDefault()),36==s&&e.preventDefault()}else if(39==s){if(e.ctrlKey||e.metaKey){c--;r=k.container.scrollLeft();return k.container.scrollLeft(r+10),void e.preventDefault()}if(k.plugins.presenter.presenting)return void k.plugins.presenter.nextSlide(k);var l,o=k.util.getSelectedId();null!=(l=P.getNearTopic.call(k,"right"))&&(L.selectOne.call(k,l),e.preventDefault())}else if(40==s||35==s){if(e.ctrlKey||e.metaKey){c--;r=k.container.scrollTop();return k.container.scrollTop(r+10),void e.preventDefault()}null!=(l=P.getNearTopic.call(k,"down"))&&(L.selectOne.call(k,l),e.preventDefault()),35==s&&e.preventDefault()}else if(32==s){var o=L.getSelectedId();e.preventDefault(),""!=o&&(d.editTopicDom.call(k,o,!0),k.model.poPasteType="editpaste")}else if(67==s&&(e.ctrlKey||e.metaKey)){0<(o=L.selectedIds).length&&P.doCopy.call(k,o),e.preventDefault()}else if(65==s&&(e.ctrlKey||e.metaKey))k.util.selectById.call(k,"root"),e.preventDefault();else if(88==s&&(e.ctrlKey||e.metaKey)){0<(o=L.selectedIds).length&&P.doCut.call(k,o),e.preventDefault()}else if((e.ctrlKey||e.metaKey)&&86==s){c=0;var o=L.getSelectedId();P.poPasteType="node",""!=o?null==document.activeElement.getAttribute("id")&&k.operation.editTopicDomInit.call(k,o):(e.preventDefault(),$.showTip("请选择主题后，再进行粘贴",1200))}else if(83==s&&(e.ctrlKey||e.metaKey))(e.ctrlKey||e.metaKey)&&(k.events.push("saveOnline"),e.preventDefault());else if(90==s&&(e.ctrlKey||e.metaKey)){if(e.preventDefault(),c=0,e.shiftKey)return void k.messageSource.redo(k);k.messageSource.undo(k)}else if(89==s&&(e.ctrlKey||e.metaKey))e.preventDefault(),c=0,k.messageSource.redo(k);else if(221!=s&&219!=s||!e.ctrlKey&&!e.metaKey)if(17==s||91==s)e.preventDefault();else if(66==s&&(e.ctrlKey||e.metaKey)){""!=(o=L.getSelectedId())&&(null==(i=P.getTopicById(o)).style||null!=i.style.bold&&0==i.style.bold||"normal"==i.style["font-weight"]||null==i.style["font-weight"]?mind.operation.setStyle.call(mind,{"font-weight":"bold"}):mind.operation.setStyle.call(mind,{"font-weight":"normal"})),e.preventDefault()}else if(70==s&&e.altKey){return}else if(71==s&&(e.ctrlKey||e.metaKey))k.events.push("initBrash"),e.preventDefault();else if(82==s&&(e.ctrlKey||e.metaKey))e.preventDefault(),k.events.push("showRight","remark");else if(75==s&&(e.ctrlKey||e.metaKey))e.preventDefault(),k.events.push("showLink");else if(73==s&&(e.ctrlKey||e.metaKey))e.preventDefault(),k.events.push("showRight","style");else if((e.ctrlKey||e.metaKey)&&83==e.keyCode)c=0,e.preventDefault();else if(!e.ctrlKey&&!e.metaKey||187!=e.keyCode&&107!=e.keyCode)if(!e.ctrlKey&&!e.metaKey||189!=e.keyCode&&109!=e.keyCode)if((e.ctrlKey||e.metaKey)&&48==e.keyCode){e.preventDefault(),c=0,k.operation.zoomVal=85,k.operation.zoomIn.call(k,k.designer);a=k.operation.zoomVal;$(".mind-canvas-con").find(".mind-zoomtxt").text(a+"%"),$("#note_view_box").dropdown("close")}else if((e.ctrlKey||e.metaKey)&&49<=e.keyCode&&e.keyCode<=57){e.preventDefault(),c=0;var s=e.keyCode-49;$(".mind-icons-dlg").find("[n=priority][ico="+s+"]").trigger("click")}else if((e.ctrlKey||e.metaKey)&&191==e.keyCode){e.preventDefault(),c=0,""!=(o=k.util.getSelectedId())&&("root"==o&&$.showTip("中心主题无法展开关闭",1400),0<(n=L.getTopicDom(o)).children(".expand_box").length&&n.children(".expand_box").trigger("mouseup"))}else if((e.ctrlKey||e.metaKey)&&76==e.keyCode){e.preventDefault(),c=0,""!=(o=k.util.getSelectedId())&&$(".header-item.icon_conn").trigger("click")}else if(16==e.keyCode)$(".topic-box.free").parent().addClass("noevent");else if((e.ctrlKey||e.metaKey)&&70==e.keyCode)e.preventDefault();else if(e.shiftKey||e.ctrlKey||e.metaKey)e.preventDefault();else{if(""!=(o=k.util.getSelectedId())){if(e.metaKey)return;d.editTopicDom.call(k,o),k.model.poPasteType="editpaste"}}else{e.preventDefault(),c=0,k.operation.zoomOut.call(k,k.designer);var a=k.operation.zoomVal;$(".mind-canvas-con").find(".mind-zoomtxt").text(a+"%"),$("#note_view_box").dropdown("close")}else{e.preventDefault(),c=0,k.operation.zoomIn.call(k,k.designer);var a=k.operation.zoomVal;$(".mind-canvas-con").find(".mind-zoomtxt").text(a+"%"),$("#note_view_box").dropdown("close")}else;}),$(document).off("keyup.hotkey").on("keyup.hotkey",function(e){c=0,16==e.keyCode&&$(".topic-box.free").parent().removeClass("noevent")}),k.events.push("documentkeydown"),$(document).off("dblclick.edit").on("dblclick.edit",".topic-box",function(e){var t;I.readonly||($(this),""!=(t=L.getSelectedId())&&(d.editTopicDom.call(k,t,!0),k.model.poPasteType="editpaste"))}),$(document).off("click.selected").on("click.selected",".topic-box",function(e){var t=$(this);$(".header-op-item:not('.node-click-show').selected").removeClass("selected");var i=P.getTopicById(t.attr("id"));e.ctrlKey||e.metaKey?k.util.select([i],k):(k.util.selectOne.call(k,i),k.events.push("setDock",i)),M.currentLine=null,k.operation.brash.call(k,i.id),k.operation.hideLink(),k.plugins.hideSummaryTip(),e.stopPropagation(),k.events.push("hideMenu")}),$(document).off("mouseup.topicnote").on("mouseup.topicnote",".topic-note",function(e){var t=$(this),i=P.getTopicById(t.parent().attr("id"));k.util.selectOne.call(k,i),k.events.push("setDock",i),k.events.push("openNote",i),e.stopPropagation()}),k.designer.off("mousedown.dragmovefree").on("mousedown.dragmovefree",".topic-box.free",function(e){if(!I.readonly&&2!=e.button){var t=$(this).attr("id"),d=k.model.getTopicById(t);if(!d.summary||null==d.pos&&null==d.part){var p=Math.abs,u=k.operation.zoomVal/100;$(document).on("selectstart",function(){return!1}),e.stopPropagation(),k.operation.brash.call(k,t),$(".mind-util-container").addClass("noevent"),$("header").addClass("noevent"),$(".mind-canvas-con").addClass("noevent"),$(".mind-right-con").addClass("noevent"),$(".mind-right-menu").addClass("noevent"),k.plugins.closeGlobalMenu(),M.clearControls();var h=[],l=[],s={},a=[],m=L.getTopicContainer(t),g=m.position().left,f=m.position().top,v=[];if(1<k.util.selectedIds.length)for(var i=0;i<k.util.selectedIds.length;i++){var n,o=k.util.selectedIds[i],r=L.getTopicContainer(o),c=k.model.getTopicById(o);c.root||c.summary||(h.push({dom:r,id:o,free:c.free,left:r.position().left,top:r.position().top}),l.push(c),n=M.getConnectionsByTopic.call(k,o),v=v.concat(n),a.push(o))}else h.push({dom:m,id:t,free:d.free,left:g,top:f}),l.push(d),v=M.getConnectionsByTopic.call(k,d.id)||[],a.push(t);l=L.getAvailableSelected(k,_,l);var y=e.pageX,x=e.pageY,b=!1,T={},C=L.copyArray(v),S=k.container.scrollTop(),w=k.container.scrollLeft();k.operation.initScrollPos();e.offsetX,e.offsetY;k.designer.off("mousemove.dragmovefree").on("mousemove.dragmovefree",function(e){var t=e.pageX,i=e.pageY,n=t-y,o=i-x;if(1<p(n)||1<p(o)){k.operation.draging=!0,k.operation.isScroll(e.pageX,e.pageY);var r=k.container.scrollTop(),l=(k.container.scrollLeft()-w)/u,s=(r-S)/u;if(0<h.length){m.css({left:g/u+n/u+l,top:f/u+o/u+s});for(var a=0;a<h.length;a++){var c=h[a];1==c.free&&c.dom.css({left:c.left/u+n/u+l,top:c.top/u+o/u+s}),c.dom.hasClass("mind-disable1")||c.dom.addClass("topic-moving-related").addClass("mind-disable1")}}0==$(".topic-insert").length&&k.virtualTopic.setMovingRelated(d,null),k.virtualTopic.initEvent.call(k,d,T,{x:e.pageX,y:e.pageY},e),null!=v&&0<v.length&&M.resetConnectionsOnMoving.call(k,v),b=!0}k.designer.addClass("noselect"),e.stopPropagation(),e.preventDefault()}),k.designer.off("mouseup.dragmovefree").on("mouseup.dragmovefree",function(e){if($(document).off("selectstart"),k.designer.off("mousemove.dragmovefree"),k.designer.off("mouseup.dragmovefree"),k.designer.removeClass("noselect"),m.removeClass("topic-moving-related").css("z-index",2).removeClass("mind-disable1"),0<h.length)for(var t=0;t<h.length;t++){(o=h[t]).dom.removeClass("topic-moving-related").css("z-index",2).removeClass("mind-disable1")}if($(".mind-util-container").removeClass("noevent"),$("header").removeClass("noevent"),$(".mind-canvas-con").removeClass("noevent"),$(".mind-right-con").removeClass("noevent"),$(".mind-right-menu").removeClass("noevent"),k.operation.stopScroll(),k.operation.draging=!1,b)if("svg"==e.target.tagName&&(T={}),null!=T.id){for(var i=L.copyArray(l),n=!1,t=0;t<i.length;t++){if(i[t].id==d.id){n=!0;break}}n||(i.push(L.copy(d)),L.selectedIds.push(d.id),a.push(d.id),i=L.getAvailableSelected(k,_,i));try{P.updateTopicPos.call(k,i,null,T,!0,null,a)}catch(e){poCollect1("拖拽接口报错:updatePos",i,e)}}else if(b&&0<h.length){for(t=0;t<h.length;t++){var o,r={x:(o=h[t]).dom.position().left/u,y:o.dom.position().top/u};s[o.id]=r}k.model.updateFreeTopicPos.call(k,l,s,v,C)}M.hideOrShowConnectionText(null,"show"),$(".topic-insert").remove(),$(".topic-moving-target").removeClass("topic-moving-target"),$(this).css({cursor:"default"}),k.virtualTopic.removeShape(),k.virtualTopic.offEvent.call(k),k.virtualTopic.insertDomList=[]})}}}),k.designer.off("dblclick.freetopic").on("dblclick.freetopic",".mind-line-svg",function(e){var t,i;k.opts.readonly||(null==k.currentRoot?"over"!=k.operation.testTopicCount.call(k)&&(t={parent:_.id,title:"自由主题",children:[],id:P.newId()},i=L.getRealPos.call(k,e.pageX,e.pageY),P.addFreeTopic(t,i,k),e.stopPropagation()):$.showTip("聚焦模式下无法新建自由主题",1400))}),k.designer.off("mousedown.dragmovetp").on("mousedown.dragmovetp",".topic-box:not(.free)",function(e){if(!I.readonly&&2!=e.button){k.events.push("hidepopeditor"),k.plugins.closeGlobalMenu(),k.plugins.hideContextMenu();var n=$(this),t=n.attr("id");if(n.hasClass("summary"))e.stopPropagation();else{0;var i,o=k.model.getTopicById(t),r=e.pageX,l=e.pageY,s=!1;if(o.root){var a=k.container.scrollTop(),c=k.container.scrollLeft();return k.designer.off("mousemove.dragmovetp").on("mousemove.dragmovetp",function(e){var t=e.pageX-r,i=e.pageY-l;(6<Math.abs(t)||6<Math.abs(i))&&(s||n.addClass("noevent"),s=!0,k.container.scrollLeft(c-t),k.container.scrollTop(a-i),0)}),k.designer.off("mouseup.dragmovetp").on("mouseup.dragmovetp",function(e){k.designer.off("mousemove.dragmovetp"),k.designer.off("mouseup.dragmovetp"),s=!1,n.removeClass("noevent"),e.stopPropagation()}),e.stopPropagation(),void e.preventDefault()}d.topicDrag.call(k,{x:r,y:l},o,e),0<$(".connection_point").length&&(i=document.getElementsByClassName("mind-connection-label"),L.unSelectText(i),M.blurConnection(k),M.currentLine=null),e.stopPropagation()}}}),$(document).off("click.menuPanel").on("click.menuPanel",".topic-menu",function(){var e=$(this).parent(),t=e.attr("id");k.plugins.hideContextMenu(),k.plugins.showContextMenu.call(k,e,t),$(document).off("mousedown.contextmenu").on("mousedown.contextmenu",function(e){k.plugins.hideContextMenu(),e.stopPropagation()}),$(".mind-context-menu").off("mousedown.contextmenu").on("mousedown.contextmenu",function(e){e.stopPropagation()})}),$(document).off("mouseenter.menuPanel").on("mouseenter.menuPanel",".topic-menu",function(){}),$(document).on("click",".connection-line",function(e){var t=_.lines[$(this).attr("id").substring(5)];M.isFocus=!1,M.focusConnection(k,t)}),k.designer.off("keyup.conn-label").on("keyup.conn-label",".mind-connection-label",function(e){var t,i,n,o=$(this);13==e.keyCode&&(t=o.html(),i=M.currentLine,e.altKey||e.shiftKey||null==i.label||t==i.label||""!=t&&"label"!=t&&(n=L.copy(i),i.label=t,M.saveConnectionText(k,i,n),M.clearControls())),e.stopPropagation()}),$(document).on("keydown.conn-label",".mind-connection-label",function(e){e.stopPropagation(),13!=e.keyCode||e.shiftKey||e.preventDefault(),13!=e.keyCode||e.altKey||e.preventDefault()}),k.designer.off("mousedown.conn-label").on("mousedown.conn-label",".mind-connection-label",function(e){var t=$(this).parent().attr("conn"),i=_.lines[t];M.focusConnection(k,i),e.stopPropagation()}),k.designer.off("mousedown.conn-label").on("mousedown.conn-label",".mind-connection-label",function(e){L.selectText(this),e.stopPropagation()}),k.designer.on("mouseenter",".summary-dot",function(e){var t=$(this).parent().attr("id");k.plugins.showSummaryTip(k,t),e.stopPropagation()}),k.designer.on("mouseenter",".mind-connection-label-icons",function(e){var t=$(this).parent().attr("conn"),i=_.lines[t];M.currentLine=i,k.plugins.showConnectionTip(i,k),e.stopPropagation()}),k.designer.off("blur.conn-label").on("blur.conn-label",".mind-connection-label",function(e){var t,i=$(this),n=$.trim(i.html()),o=M.tempLine||M.currentLine;null!=o&&(o.label!=n&&(t=L.copy(o),o.label=n,M.saveConnectionText(k,o,t)),""!=n&&"label"!=n||(i.parent().remove(),M.currentLine=null))}),k.designer.off("focus.conn-label").on("focus.conn-label",".mind-connection-label",function(e){var t=$(this).parent().attr("conn");line=_.lines[t],M.currentLine=line,M.tempLine=line}),k.designer.on("mousedown.conn-label",function(e){var t;0<$(".connection_point").length&&(t=document.getElementsByClassName("mind-connection-label"),L.unSelectText(t),M.blurConnection(k)),k.plugins.closeGlobalMenu(),null!=k.operation.brashData.style&&e.target.classList[0].indexOf("topic")<0&&k.operation.closeTip(),k.events.push("hideMenus"),k.operation.hideLink(),k.util.clearSelect(),k.plugins.hideConnectionTip(),k.events.push("changeOpStatus",k)}),k.designer.on("mousedown.conn-label",".connection_point",function(e){e.stopPropagation()}),k.designer.on("mousemove.move",function(e){var t,i=$(e.target);if(i.hasClass("topic")||i.hasClass("expand_box")||i.hasClass("topic-menu")||i.hasClass("topic-box")||i.hasClass("connection_point"))k.designer.off("mousedown.connection"),k.designer.css("cursor","default");else{var n=_.lines;if(null==n||$.isEmptyObject(n))return;var o=L.getRealPos.call(k,e.pageX,e.pageY),r=M.getConnectionByPoint.call(k,o.x,o.y);if(0<r.inline&&20!=r.inline){var l=r.lines[0];if(null==document.getElementById("line_"+l.id))return;k.designer.css("cursor","pointer"),t=l,k.designer.off("mousedown.connection").on("mousedown.connection",function(e){_.lines[t.id];M.focusConnection(k,t),k.designer.css("cursor","default"),k.designer.off("mousedown.connection"),e.stopPropagation()})}else k.designer.css("cursor","default"),k.designer.off("mousedown.connection")}}),k.designer.off("mousedown.conn-menu").on("mousedown.conn-menu",".mind-connection-menu",function(e){e.stopPropagation()}),k.designer.on("mousedown.conn-menu",function(){$(".mind-connection-menu").hide(),k.designer.find(".img-dot").remove(),k.designer.find(".topic-image .img-btn").remove(),k.designer.find(".topic-image img.active").removeClass("active"),k.events.push("hidepopeditor"),g=""}),k.designer.on("click.image",function(e){g="",k.designer.find(".img-dot").remove(),k.designer.find(".topic-image img.active").removeClass("active"),k.designer.find(".topic-image .img-btn").remove()}),k.designer.on("click.imagedel",".topic-image > .img-btn",function(e){""!=g&&(d.removeTopicImage.call(k,g),g="",$("#mind_hover_tip").remove()),e.stopPropagation()}),k.designer.on("mousedown.imagedel",".topic-image > .img-btn",function(e){e.stopPropagation()}),k.designer.on("contextmenu.image",".topic-image > img",function(e){$(this).trigger("click.image"),e.preventDefault()}),k.designer.on("mousedown.imagemove",".topic-image > img",function(e){var a=$(this),i=e.pageX,n=(e.pageY,Math.abs),c=a.parent().parent().attr("id");$.showTip("拖动到其他主题上，可以快速复制图片",null),k.designer.off("mousemove.imagemove").on("mousemove.imagemove",function(e){var t=e.pageX;e.pageY;5<n(i-t)&&0}),k.designer.off("mouseup.imagemove").on("mouseup.imagemove",function(e){k.designer.off("mousemove.imagemove"),k.designer.off("mouseup.imagemove"),$.showTip("close");for(var t,i,n=$(e.target).parents(),o=!1,r=null,l=0;l<n.length;l++){var s=$(n[l]);if(s.hasClass("topic-box")){o=!0,r=s;break}}o&&r.attr("id")!=c&&(t=a.attr("src"),(i=new Image).src=t,i.onload=function(){d.setTopicImage.call(k,r.attr("id"),t,i)})}),e.stopPropagation(),e.preventDefault()}),k.designer.on("click.image",".topic-image > img",function(e){var c,d,p=$(this),t=p.width(),i=p.height(),n=p.attr("id").substring(10);g=n;var o=P.getTopicById(n);e.ctrlKey||e.metaKey?k.util.select([o],k):(k.events.push("setDock",o),k.util.selectById.call(k,n));var u=L.copy(P.getTopicById(n));k.designer.find(".img-dot").remove(),k.designer.find(".topic-image .img-btn").remove(),k.designer.find(".topic-image img.active").removeClass("active");var h=$("<span title='调节图片大小' class='img-dot'></span>");p.parent().append(h);var m=$("<span title='删除图片' class='img-btn del'><span class='mind-icons'>&#xe669;</span></span>");p.parent().append(m),p.addClass("active"),h.css({top:i-h.height()+2,left:t-h.width()}).show(),$(".topic-image .img-dot").off("mousedown").on("mousedown",function(e){e.stopPropagation();var r=e.pageX,l=e.pageY,s=p.width(),a=p.height();m.hide(),k.designer.off("mousemove.img-dot").on("mousemove.img-dot",function(e){e.preventDefault(),e.stopPropagation();var t=e.pageX,i=e.pageY,n=t-r,o=i-l;(5<Math.abs(n)||5<Math.abs(o))&&(d=(c=s+n)*a/s,20<c&&(p.width(c),p.height(d),h.css({left:c-h.width(),top:d-h.height()})))}),k.designer.off("mouseup.img-dot").on("mouseup.img-dot",function(e){s=p.width(),a=p.height();var t=L.copy(u);m.show(),t.image=$.extend(!0,t.image,{w:s,h:a}),P.updateTopicImage.call(k,t,u,!0),k.designer.off("mouseup.img-dot"),k.designer.off("mousemove.img-dot"),$("#mind_hover_tip").remove()})}),e.stopPropagation()}),k.designer.on("dblclick.imagePreview",".topic-image > img",function(e){e.stopPropagation();var t=$(this).attr("src");k.operation.previewTopicImage.init(t)}),k.designer.off("contextmenu.rightclick").on("contextmenu.rightclick",function(e){if(I.readonly)e.preventDefault();else if(0<$(".topic-moving").length||0==e.button)e.preventDefault();else{var t=e.pageX,i=e.pageY,n=e.target,o=n.getAttribute("class")+"";if(0<=o.indexOf("topic-container"))k.plugins.showGlobalMenu(k,t,i),e.preventDefault();else if(0<=o.indexOf("topic")||0<=o.indexOf("textarea_topic")||0<=o.indexOf("topic-box")||0<=o.indexOf("topic-tag")||0<=o.indexOf("topic-task")||0<=o.indexOf("topic-icons")){var r=null;if((r=!(0<=o.indexOf("textarea_topic"))&&$(n).attr("id")?$(n):$(n).parent()).hasClass("cut_related"))return void e.preventDefault();var l,s=r.attr("id");null!=s&&(l=P.getTopicById(s),L.selectOne.call(k,l),r.children(".topic-menu").trigger("click")),e.preventDefault()}else"svg"==n.tagName&&0<=n.className.baseVal.indexOf("mind-line-svg")&&(k.plugins.showGlobalMenu(k,t,i),e.preventDefault())}}),k.designer.off("click.clickicon").on("click.clickicon",".topic-icons > span",function(e){var t=$(this),i=null==t.attr("n")?"":t.attr("n"),n=t.attr("ico"),o=t.text(),r=t.attr("iconimg"),l={name:i,index:n,text:o};r&&(l.url=r),k.icons.currentIcon=l,k.plugins.showIconsMenu.call(k,l,t)}),k.designer.off("click.clicktag").on("click.clicktag",".topic-tag",function(e){e.stopPropagation();var t=$(this),i=t.find(".topic-tags-text").text(),n=t.parents(".topic-tags").parent().attr("id");k.util.selectById.call(k,n);var o=$(e.target);if(o.hasClass("close_tag")){var r=k.tags;o.parent();return r.removeTag.call(k,i),r.resetPanel(k,n),void r.renderTags(k,n)}k.tags.showTag.call(k,i,n)}),k.designer.off("click.clicktask").on("click.clicktask",".topic-task",function(e){var t=$(this).parent().attr("id");k.task.showTask.call(k,t),k.util.selectById.call(k,t),e.stopPropagation()}),k.designer.off("mouseover.mouseover.link").on("mouseover.mouseover.link",".topic-link",function(e){var t=$(this),i=t.parent().attr("id");k.operation.showLinkMenu.call(k,t,i)}))},operation:{moveToCenter:function(){var e,t,i=this.container,n=$(".mind-designer:first"),o=this.model,r=this.currentRoot||o.topic,l=i.width(),s=i.height(),a=0,c=0;c="mind_tree"==r.structure||"mind_org"==r.structure?(e=$(window).height()/2,a=(n.width()-l)/2,(n.height()-s+e)/2):(a=null==r.leftChildren||0==r.leftChildren.length&&0<r.children.length?(t=$(window).width()/2,(n.width()-l+t)/2):0<r.leftChildren.length&&0==r.children.length?(t=$(window).width()/2,(n.width()-l-t)/2):(n.width()-l)/2,(n.height()-s-100)/2),i.scrollLeft(a),i.scrollTop(c)},draging:!1,topicDrag:function(c,d,e){if(0<$(".topic-moving").length)$(".topic-moving").remove();else{var p=this,u=p.model,h=p.util,t=(p.line,p.currentRoot||u.topic),i=(u.groupList,p.util.getMargin.call(p).marginH,$("#"+d.id)),m=i.clone(!1).appendTo("body").addClass("topic-moving");m.children(".topic").siblings().remove(),m.removeClass("selected"),m.css({background:"#fff","box-shadow":"1px 1px 0px #ccc"});var n=h.selectedIds.length,o=[],g=[],f=[];if(1<n){m.children(".topic").text(n+"个节点");for(var r=$(".topic-box.selected[sub=true]").get().reverse(),l=$(".topic-box.selected"),s=0;s<l.length;s++){var a=l[s];null==$(a).attr("sub")&&(r=r.concat(a))}for(s=0;s<r.length;s++){var v=(a=$(r[s])).attr("id"),y=u.getTopicById(v);y.root||y.summary||(o.push(y),f.push(y.id))}}else o.push(d);0==(g=h.getAvailableSelected(p,t,o)).length&&1==o.length&&(g=o);var x={},b=u.getParentTopic(d.parent),T=(i.parent(),!1);$(".mind-util-container").addClass("noevent"),$("header").addClass("noevent"),$(".mind-canvas-con").addClass("noevent"),$(".mind-right-con").addClass("noevent"),$(".mind-right-menu").addClass("noevent"),p.operation.initScrollPos(),p.designer.off("mousemove.dragmove").on("mousemove.dragmove",function(e){var t=e.pageX-c.x,i=e.pageY-c.y,n=Math.abs(t),o=Math.abs(i);(8<n||8<o)&&(p.operation.isScroll(e.pageX,e.pageY),T=!0,p.operation.draging=!0,$(this).css({cursor:"move"}),0==$(".topic-insert").length&&(p.virtualTopic.setMovingRelated(d,b,g),m.find(".topic-insert").remove()),0==$("#mind-tip").length&&$.showTip("拖动到其他主题上，进行排序或移动",null),(200<o||200<n)&&("svg"==e.target.tagName?$.showTip("松开鼠标，即可添加为自由主题",null):$.showTip("close")),m.css({left:e.pageX-m.width()/2,top:e.pageY-m.height()/2}),p.virtualTopic.initEvent.call(p,d,x,{x:e.pageX,y:e.pageY},e))}),p.designer.off("mouseup.dragmove").on("mouseup.dragmove",function(e){p.model.copying=!1;var t=e.pageX-c.x,i=e.pageY-c.y;"svg"==e.target.tagName&&(x.id=null),p.operation.draging=!1,$(".mind-util-container").removeClass("noevent"),$("header").removeClass("noevent"),$(".mind-canvas-con").removeClass("noevent"),$(".mind-right-con").removeClass("noevent"),$(".mind-right-menu").removeClass("noevent"),p.operation.stopScroll();var n,o,r,l,s=m.offset().left,a=m.offset().top;if(m.remove(),$(".topic-insert").remove(),$(".topic-moving-target").removeClass("topic-moving-target"),$(this).css({cursor:"default"}),p.virtualTopic.removeShape(),p.designer.off("mouseup.dragmove"),p.designer.off("mousemove.dragmove"),p.designer.off("mouseenter.dragmove"),$(".topic-moving-related").removeClass("topic-moving-related"),8<Math.abs(t)||8<Math.abs(i))if(null!=x.id)try{u.updateTopicPos.call(p,h.copyArray(g),null,x,null,null,f)}catch(e){poCollect1("拖拽接口报错:updatePos",h.copyArray(g),e)}else if(T){if(null!=mind.currentRoot)return void $.showTip("聚焦模式下无法成自由主题",1400);(200<Math.abs(t)||200<Math.abs(i))&&(o=null,(n=u.topic.margin)&&(o=n.marginH),r=null==o?p.styles.marginH:o,(l=h.getRealPos.call(p,s,a)).y-=$("#"+d.id).parent().outerHeight()/2-r,u.changeToFreeTopic.call(p,d,null,l))}$.showTip("close"),p.virtualTopic.insertDomList=[]})}},selectingBox:function(t){var a=this;a.model,a.util;a.util.clearSelect();var c=null,i=t.pageX,n=t.pageY,o=t.offsetX,r=t.offsetY,e=a.designer,l=a.container,s=a.operation.zoomVal/100,d=l.scrollLeft(),p=l.scrollTop();1!=s&&(d=Math.abs(e.offset().left)/s,p=Math.abs(e.offset().top)/s);var u={};$(document).on("selectstart",function(){return!1}),$(document).off("mousemove.multiselect").on("mousemove.multiselect",function(e){2<Math.abs(e.pageX-t.pageX)&&(null==c&&(c=$("<div id='selecting_box'></div>").appendTo(a.designer)),o=e.pageX<i?e.pageX:i,r=e.pageY<n?e.pageY:n,u.x=d+o/s,u.y=p+r/s,u.w=Math.abs(t.pageX-e.pageX),u.h=Math.abs(t.pageY-e.pageY),c.css({left:u.x,top:u.y,width:u.w/s,height:u.h/s}))}),$(document).off("mouseup.multiselect").on("mouseup.multiselect",function(e){if(null!=c){for(var t=a.operation.zoomVal/100,i={x:c.offset().left/t,y:c.offset().top/t,w:c.width(),h:c.height()},n=a.util.getTopicsByRange(i,t),o=[],r=0;r<n.length;r++){var l=n[r],s=a.model.getTopicById(l);o.push(s)}a.util.clearSelect(),a.util.select(o,a),c.remove()}u={},$(document).off("mouseup.multiselect"),$(document).off("mousemove.multiselect"),$(document).off("selectstart")})},setConfig:function(e,t,i){$.ajax({url:"/mindmap/config",data:{field:e,value:t,userid:userId},cache:!1,type:"post",success:function(e){null!=i&&i(e)}})},removeTopicSelf:function(){var e=this,t=e.model,i=(e.line,e.currentRoot||t.topic),n=(e.operation,e.util),o=e.util.selectedIds;if((1!=o.length||o[0]!=i.id)&&0!=o.length){for(var r=[],l={},s={},a={},c=0;c<o.length;c++){var d=o[c],p=t.getTopicById(d);if(!(p.summary||p.root||p.free||0==p.children.length)){var u=n.getSelectedPart(d,i.structure);s[d]=u,r.push(p),l[p.id]=[];for(var h=0;h<p.children.length;h++){var m=p.children[h];l[p.id].push(m),a[m.id]=u}}}0<r.length&&t.removeAndAdd.call(e,n.copyArray(r),n.copy(l),s,a)}},removeTopic:function(){var e=this,t=e.model,i=(e.line,e.currentRoot||t.topic),n=e.util.selectedIds;if((1!=n.length||n[0]!=i.id)&&0!=n.length){for(var o=[],r=0;r<n.length;r++){var l=n[r],s=t.getTopicById(l);o.push(s)}0<o.length&&t.removeTopic.call(e,o,null)}},focusTopic:function(e,t,i){var n=this,o=n.model,r=n.util,l="",s=o.topic;n.operation.zoomVal=100,n.events.push("zoom",100);var a=null;if(null!=e)l=e;else{var c=r.selectedIds;if(0==c.length)return;l=c[0]}if(null==t&&!n.events.push("focusable"))return;var d=o.getTopicById(l);if(null!=d){if(null!=n.currentRoot){var p=o.getTopicById(n.currentRoot.id),u=p.summaries;if(null!=u&&0<u.length)for(var h=0;h<u.length;h++){delete u[h].pos}a=p.id,delete p.root,delete p.structure,n.currentRoot=null}null==d.root&&(n.currentRoot=d,n.currentRoot.root=!0,n.currentRoot.structure=s.structure),n.operation.clearCanvas.call(n),n.initCanvas(),n.line.renderLineCon.call(this),n.renderTopic(d),n.plugins.navigator.init.call(n);var m=!0;t?(n.operation.renderFocusBar(n,!0),m=null):n.operation.renderFocusBar(n),null==i&&n.messageSource.send.call(n,"focus",{targetId:l,sourceId:a,local:m},m)}null==n.currentRoot?n.events.push("focus",null):n.events.push("focus",!0)},renderFocusBar:function(e,t){var i=e.currentRoot;if(null!=i){var n=e.model.getParentTopics(i.id);$(".mind-util-container").find(".mind-topic-focus").remove();for(var o=['<div class="mind-topic-focus">'],r=n.length-1;0<=r;r--){var l=n[r],s=l.title;o.push('<div topicid="'+l.id+'">'+s+'</div><i class="mind-icons">&#xe736;</i>')}o.push('<div class="active" topicid="'+i.id+'">'+i.title+'</div><i title="退出聚焦模式" class="mind-icons close">&#xe622;</i>'),o.push("</div>"),$(".mind-util-container").append(o.join("")),this.initFocusEvent(e,t)}else $(".mind-topic-focus").remove()},initFocusEvent:function(n,o){$(".mind-topic-focus").children().off("click").on("click",function(e){var t,i=$(this);i.hasClass("active")||("div"==this.tagName.toLowerCase()?(null!=(t=i.attr("topicid"))&&null==o?n.operation.focusTopic.call(n,t):o&&n.operation.focusTopic.call(n,t,!0,!1),t==n.model.topic.id&&n.operation.exitFocus.call(n)):i.hasClass("close")&&(o?n.operation.focusTopic.call(n,n.model.topic.id,!0,!1):n.operation.focusTopic.call(n,n.model.topic.id),n.operation.exitFocus.call(n),$("#mind_hover_tip").remove()),e.stopPropagation())})},insertParent:function(e){var t=this.model;e&&(e.root||e.summary||e.free)||"over"!=this.operation.testTopicCount.call(this)&&t.insertParentTopic.call(this,e)},exitFocus:function(){this.currentRoot=null,$(".mind-topic-focus").remove()},testTopicCount:function(){var e=this,t=e.model,i=e.util,n=Object.keys(t.topicList.data).length;return console.log(n,"我是节点新鲜"),n<100?(79==n&&i.testVipState(function(){-1==tdocVipInfo.indexOf(20)&&-1==tdocVipInfo.indexOf(30)&&-1==tdocVipInfo.indexOf(40)&&e.events.push("vip-limit-warn","addtopic_free")},"addtopic"),""):n<=200?(i.testVipState(function(){-1==tdocVipInfo.indexOf(20)&&-1==tdocVipInfo.indexOf(30)&&-1==tdocVipInfo.indexOf(40)?e.events.push("vip-limit","addtopic"):179==n&&-1==tdocVipInfo.indexOf(30)&&-1==tdocVipInfo.indexOf(40)&&e.events.push("vip-limit-warn","addtopic_vip")},"addtopic"),-1==tdocVipInfo.indexOf(20)&&-1==tdocVipInfo.indexOf(30)&&-1==tdocVipInfo.indexOf(40)?"over":""):200<n&&(i.testVipState(function(){-1==tdocVipInfo.indexOf(30)&&-1==tdocVipInfo.indexOf(40)&&e.events.push("vip-limit","addtopic_svip")},"addtopic_svip"),-1==tdocVipInfo.indexOf(30)&&-1==tdocVipInfo.indexOf(40))?"over":void 0},appendTopic:function(e){var t=this,i=t.model,n=i.topic,o="mind_org"==n.structure,r="mind_tree"==n.structure,l=t.util;t.line;if(0!=this.util.selectedIds.length&&"over"!=t.operation.testTopicCount.call(t)){var s=l.getSelectedId(),a=null,c=i.getTopicById(s),d=i.newId(),p="子主题",u="right";if(!(e&&c.collapsed||(c.summary||c.free)&&c.collapsed)){a=c.root||c.free||c.summary||e?c:i.getTopicById(c.parent),u=l.getSelectedPart(s,n.structure);var h=a.id;if(h){(e&&c.root||!e&&a.root)&&(p="分支主题"),!c.root||o||r||l.getChildrenCount(n,"left")<l.getChildrenCount(n,"right")&&(u="left"),null!=t.currentRoot&&(u="right");var m=i.getNewTopicIndex(c,a,e,u),g={},f={};f[d]=u,g[d]=m;var v={id:d,parent:h,children:[],title:p};return i.addTopicMulti.call(t,[v],null,g,f),l.selectOne.call(t,v),v}}}},hideTopics:function(e){for(var t=this.model,i=this.currentRoot||t.topic,n=i.children,o=i.leftChildren||[],r=[],l=0;l<n.length;l++)r.push(n[l].id);for(l=0;l<o.length;l++)r.push(o[l].id);t.hideTopics.call(this,r,e)},showTopics:function(e){for(var t=this.model,i=this.currentRoot||t.topic,n=i.children,o=i.leftChildren||[],r=[],l=0;l<n.length;l++)r.push(n[l].id);for(l=0;l<o.length;l++)r.push(o[l].id);t.showTopics.call(this,r,e)},hideChildren:function(e,t){var i,n,o,r=this,l=r.model,s=(l.groupList,r.currentRoot||l.topic),a=l.getSubTopic(e),c=r.util,d=r.line,p=c.getTopicContainerProp(a.id),u=c.getSelectedPart(e.id,s.structure);c.getTopicContainer(e.id).children(".topic-children").remove(),d.deleteChildrenLines(e),null==a.summary&&(n=((i=c.getTopicContainerProp(a.id)).h-p.h)/2,o=0,"mind_org"!=s.structure&&"mind_tree"!=s.structure||(o=i.w-p.w),r.range.doChangeSubTopicPos(r,a,n,o,u)),r.renderFreeSummaries(u),d.resetLines.call(r,[a.id],n,u)},showChildren:function(e){var t=this,i=t.model,n=t.util,o=t.currentRoot||i.topic,r=t.line,l=(i.groupList,i.getSubTopic(e)),s=n.getSelectedPart(e.id,o.structure),a=e.children,c=a.length,d=n.getTopicContainerProp(l.id),p=(n.getTopicContainer(e.id),a);e.summary&&null!=e.part&&(s=e.part);for(var u,h,m,g=0;g<c;g++){var f=p[g];t.renderSubTopic(f,null,s)}if(e.summaries&&0<e.summaries.length)for(g=0;g<e.summaries.length;g++){var v=e.summaries[g];t.summary.renderSummaryDoms(t,v,s)}null==l.summary&&(h=((u=n.getTopicContainerProp(l.id)).h-d.h)/2,m=0,"mind_org"!=o.structure&&"mind_tree"!=o.structure||(m=u.w-d.w),t.range.doChangeSubTopicPos(t,l,h,m,s,!0)),t.renderFreeSummaries(s),r.resetLines.call(t,[l.id],h,s),t.events.push("change_expands_tyle",e)},showOrHideChildren:function(e,t,i){var n=this,o=n.util,r=n.model,l=n.currentRoot||r.topic,s=o.getTopicDom(e),a=s.children(".expand_box"),c=r.getTopicById(e),d=o.getSelectedPart(c.id,l.structure);null==t&&(t=c.collapsed?"show":"hide"),"show"==t?(a.html("&#xe7bb;").removeClass("hide").css("font-size","14px"),delete c.collapsed,n.operation.showChildren.call(n,c),n.connection.showConnectionMulti(n,[c])):"hide"==t&&(n.operation.nodeAmount.call(n,c),c.collapsed=!0,n.operation.hideChildren.call(n,c,s),n.connection.deleteConnectionByTopics.call(n,[c],!1)),n.connection.resetAllConnectionPos.call(n,l),n.opts.readonly||(r.changeTopicExpand.call(n,c,t,d,i),n.events.push("isShowOrHideChildren"))},nodeAmount:function(e){var o=0;var t=$("#"+e.id).find(".expand_box.mind-icons"),i=function e(t){for(var i=0;i<t.length;i++){var n=t[i];if(99<o)return;o++,n.children&&0<n.children.length&&e(n.children)}return o}(e.children);i<=99?(t.attr("data-sub",i),i="",t.addClass("icon_slight").css("font-size","12px")):(i="&#xe712;",t.removeClass("icon_slight").css("font-size","14px")),t.html(i).addClass("hide")},isPaste:!1,editTopicDomInit:function(e){var t,i,n,o,r,l,s=this,a=(s.operation,s.util),c=s.model.getTopicById(e),d=s.util.getTopicDom(e);c&&(t=c.title,i=d.find(".topic"),d.find(".textarea_topic").remove(),n=$("<div contenteditable='true' spellcheck=false id='area_"+e+"' class='textarea_topic'></div>").prependTo(d),(new Date).valueOf()%2==0&&a.tipCount()?n.addClass("tip1"):a.tipCount()&&n.addClass("tip2"),r={"font-family":(o=s.style.getStyle.call(s,c)).family,"font-size":o["font-size"],"font-weight":o.bold?"bold":"normal","font-style":o.italic?"italic":"normal","text-align":o.textAlign},n.css(r),l=t.replace(/\n/g,"<br>"),n.html(l).focus(),n.css({left:0,width:i.outerWidth(),height:i.outerHeight()}),null!=c.image&&n.css({bottom:0-n.height()/2,top:"auto"}),null!=c.tags&&n.css({top:n.height()/2+2}),$("#textarea_topic_temp").remove(),$("<div id='textarea_topic_temp'></div>").appendTo(d).css(r),$(".topic-menu").remove(),$("<span class='icons topic-menu'>&#xe65a</span>").appendTo(d).hide(),document.getElementById("area_"+e))},uploading:!1,uploadImage:function(e,t,i){var n,o=this;o.uploading||(o.uploading=!0,(n=new FormData).append("image",e),n.append("fileID",file_id),n.append("type","mind"),n.append("scene",scene),$.ajax({url:"https://docs.qq.com/cooperation/v1/images",type:"post",crossDomain:!0,xhrFields:{"Access-Control-Allow-Origin":"*",withCredentials:!0},headers:{"Client-Id":client_id,"Access-Token":encrypted_session,"Open-Id":tdoc_user_id},data:n,processData:!1,contentType:!1,success:function(e){o.uploading=!1,null!=i&&(e=JSON.parse(e),i(e))},error:function(){o.uploading=!1}}))},editTopicDom:function(e,i){var o=this,t=o.model,n=o.util,r=!1,l=!1,s=(o.operation,$("#area_"+e));0==s.length&&(this.operation.editTopicDomInit.call(o,e),s=$("#area_"+e));var a=t.getTopicById(e),c=n.getTopicDom(e),d=a.title,p=c.find(".topic"),u=$("#textarea_topic_temp");s.css({"z-index":9,width:p.parent().outerWidth(),opacity:1}),null!=a.image&&s.css({bottom:0-s.height()/2,top:"auto"}),s.off().on({keydown:function(e){var t=$(this),i=t.html();e.altKey&&"<br>"!==i.substring(i.length-4,i.length)&&t.append("<br>"),e.altKey&&13==e.keyCode?(e.preventDefault(),n.setBrNode(t[0])):e.altKey||e.shiftKey||13!=e.keyCode?27==e.keyCode?($("#textarea_topic_temp").remove(),s.remove()):9==e.keyCode?(s.trigger("blur"),e.preventDefault()):((e.ctrlKey||e.metaKey)&&(187==e.keyCode||107==e.keyCode)||(e.ctrlKey||e.metaKey)&&(189==e.keyCode||109==e.keyCode)||(e.ctrlKey||e.metaKey)&&83==e.keyCode)&&e.preventDefault():m(i,t),e.stopPropagation()},focus:function(e){document.execCommand("selectAll",!1,null);var t="";window.getSelection?t=window.getSelection().toString():document.selection&&(t=document.selection.createRange().text),""!=$.trim(t)&&i&&popEditor.init(this)},blur:function(){var e=$(this),t=e.html();m(t,e),o.model.poPasteType="node"},keyup:function(e){var t=$(this).html();u.html(t);var i=u.outerHeight(),n=u.outerWidth()+19;n<c.outerWidth()&&(n=c.outerWidth()+10),popEditor.renderMenuPos($(this)),s.css({width:n,height:i,left:(c.outerWidth()-n)/2-3}),null!=a.image&&s.css({bottom:0-s.height()/2,top:"auto"}),e.stopPropagation()},mousemove:function(e){l=!0,e.stopPropagation()},mousedown:function(e){r=!0,e.stopPropagation()},mouseup:function(e){l&&r&&(popEditor.init(this),r=l=!1)},click:function(e){e.stopPropagation()},dblclick:function(e){e.stopPropagation()}});var h=d.replace(/\n/g,"<br>");s.html(h).focus(),$(".topic-box.free").parent().removeClass("noevent");var m=function(e,t){var i,n;e=e.replace(/\n/g,"<br>"),"safari"==o.util.isPaste&&(e=0<(i=t.find("img:first")).length?(Util.globalTopTip("close"),Util.globalTopTip("暂时还不支持Firfox和Safari粘贴截图","top_error",4e3),i.remove(),a.title):((n=document.createElement("div")).innerHTML=e,n.innerText)),$("#textarea_topic_temp").remove(),s.remove(),o.events.push("hidepopeditor"),o.util.isPaste=!1,e!=a.title&&(o.model.updateTopicText.call(o,a,e),o.events.push("outline-prebuild",{topics:[a],rebuild:"current"}))}},setDisable:function(){this.opts.readonly=!0},setEnable:function(){this.opts.readonly=!1},clearWatermark:function(e){var t=this.model.topic,i=t.watermark,n=$(".mind-line-svg"),o=n.find("defs")[0];0<$(o).find("#pattern_mark").length&&($(o).find("#pattern_mark").remove(),n.find("#rect_mark").remove()),t.watermark="",e||this.messageSource.send.call(this,"setWatermark",{content:"",original:i})},setWatermark:function(e,t,i){var n=this.util,o=this.styles,r=this.model.topic,l=r.background||o.background,s=e,a=r.watermark||"";if(null==s){if(!a)return;s=a}null!=l&&0<l.indexOf("null")&&(l="rgb(244,244,244)"),0<=l.indexOf("rgb")&&(l=n.getHexColor(l).hex);var c=n.getRgbFromHex(l);null==c&&(c={r:190,g:190,b:190});var d=c.r-20,p=c.g-20,u=c.b-20;d<0&&0!=c.r?d=0:c.r<10&&(d=c.r+40),p<0&&0!=c.g?p=0:c.g<10&&(p=c.g+40),u<0&&0!=c.b?u=0:c.b<10&&(u=c.b+40);var h,m,g,f,v="rgb("+d+","+p+","+u+")";i?(m="pattern_mark_view",g="rect_mark_view",f=(h=$(i)).find("defs")[0],0<h.find("#pattern_mark_view").length&&h.find("#pattern_mark_view").remove(),h.find("#rect_mark_view").length&&h.find("#rect_mark_view").remove()):(m="pattern_mark",g="rect_mark",f=(h=$(".mind-line-svg")).find("defs")[0],$(f).find("#pattern_mark").length&&$(f).find("#pattern_mark").remove(),h.find("#rect_mark").length&&h.find("#rect_mark").remove());var y="http://www.w3.org/2000/svg",x=document.createElementNS(y,"pattern");x.setAttributeNS(null,"patternUnits","userSpaceOnUse"),x.setAttributeNS(null,"id",m),x.setAttributeNS(null,"width","300"),x.setAttributeNS(null,"height","300"),f.appendChild(x);var b=document.createElementNS(y,"text");b.setAttributeNS(null,"x","0"),b.setAttributeNS(null,"y","96"),b.setAttributeNS(null,"fill",v),b.setAttributeNS(null,"font-size","18"),b.setAttributeNS(null,"transform","rotate(-45, 150, 150)"),b.textContent=$("<span/>").html(s).text(),x.appendChild(b);var T=document.createElementNS(y,"rect");T.setAttributeNS(null,"fill","url(#"+m+")"),T.setAttributeNS(null,"x","5000"),T.setAttributeNS(null,"y","5000"),T.setAttributeNS(null,"width",1e4),T.setAttributeNS(null,"height",1e4),T.setAttributeNS(null,"id",g),T.setAttributeNS(null,"pointer-events","none"),i&&h.find("#svgbackgroundid").length?h.find("#svgbackgroundid").after(T):h.prepend(T),i||(r.watermark=s,t||this.messageSource.send.call(this,"setWatermark",{content:s,original:a}))},setMargin:function(e,t){var a=this,i=a.util,c=a.line,n=a.model,d=a.currentRoot||n.topic;if("mind_org"!=d.structure&&"mind_tree"!=d.structure){var o=i.copy(n.topic.margin);if(n.topic.margin=$.extend(n.topic.margin,e),!$.isEmptyObject(e)||!$.isEmptyObject(o)){var r,l=o.marginH==a.styles.marginH&&o.marginW==a.styles.marginW&&o.childMarginH==a.styles.childMarginH&&o.childMarginW==a.styles.childMarginW;if($.isEmptyObject(e)&&!l)n.topic.margin={},s();else if($.isEmptyObject(e)&&l)return;0<=e.marginH&&e.marginH!=o.marginH?(a.range.resetSubTopics.call(a,"left"),a.range.resetSubTopics.call(a,"right")):0<=e.childMarginH&&s(),0<=e.marginW&&e.marginW!=o.marginW?(a.range.resetSubTopics.call(a,"left"),a.range.resetSubTopics.call(a,"right")):0<=e.childMarginW&&s(),a.renderFreeSummaries("left,right"),a.connection.resetAllConnectionPos.call(a,n.topic),null==t&&(r=i.copy(n.topic.margin),a.messageSource.send.call(a,"updatePage",{content:r,original:o,type:"margin"})),a.events.push("updateMargin")}}function s(){for(var e=[],t=d.children||[],i=t.length,n=d.leftChildren||[],o=n.length,r=0;r<i;r++){var l=t[r];e.push(l.id),a.renderSubTopic(l,null,"right")}for(r=0;r<o;r++){var s=n[r];e.push(s.id),a.renderSubTopic(s,null,"left")}a.range.resetSubTopics.call(a,"left"),a.range.resetSubTopics.call(a,"right"),c.resetLines.call(a,e,null,"left,right")}},setBackground:function(e,t,i){var n=$(this.designer),o=this.styles,r=this.model.topic,l=r.background||o.background,s=e||o.background;null==e&&l&&(s=l),0<=s.indexOf("obqv3yxb1.bkt.clouddn.com")&&(s=s.replace("obqv3yxb1.bkt.clouddn.com","cdn3.processon.com")),n.css({background:s}),t&&(r.background=s,null==i&&this.messageSource.send.call(this,"updateBg",{content:s,original:l})),this.designer.find(".expand_box").css("background-color",s)},showLink:function(e){var t,o,i,r,n,l,s,a=this,c=a.util,d=a.model,p=e||c.getSelectedId(),u=a.operation;function h(e){return null==e||""==e?"":e=(e=(e=(e=(e=(e=(e=e.toString()).replace(/</g,"&lt;")).replace(/%3C/g,"&lt;")).replace(/>/g,"&gt;")).replace(/%3E/g,"&gt;")).replace(/'/g,"&#39;")).replace(/"/g,"&quot;")}null!=p&&""!=$.trim(p)&&(a.opts.readonly||(t=c.getTopicDom(p),0==(o=$(".mind-link-box")).length&&(o=$("<div class='mind-topic-box mind-link-box'><div class='topic-box-list'><span>链接</span><input id='mind-topic-link' autofocus type='text'/></div><div class='mind-input-error' style='display:none'><div style='width:46px'></div><label>请输入正确链接格式</label></div><div class='mind-box-btn'><div tit='cancel' class='box_cel_btn mind-button gray'>取消</div><div tit='ok' class='box_ok_btn mind-button mind-disable'>添加</div></div></div>").appendTo(a.designer)),i=d.getTopicById(p),r=o.find("input:first"),n=o.find(".box_ok_btn"),l=o.find(".box_cel_btn"),null!=i.link&&(r.val(i.link.value||""),i.link.value&&n.removeClass("mind-disable")),$.fn.showPanel({target:t,panel:o}),setTimeout(function(){console.log(r),r.focus()},100),s=o.find("#remove_link"),r.on("blur",function(){var e=h($.trim($(this).val()));""!=e&&!c.isUrl(e)&&e.length<5e3&&$(this).val("http://"+e)}),r.on("keyup",function(e){""==$.trim($(this).val())?n.addClass("mind-disable"):n.removeClass("mind-disable"),o.find(".mind-input-error").hide(),13==e.keyCode&&(r.trigger("blur"),setTimeout(function(){n.trigger("click")},100))}),n.off().on("click",function(e){e.stopPropagation();var t,i=$("#mind-topic-link"),n=h($.trim(i.val()));""!=n&&c.isUrl(n)&&n.length<5e3?(r.val("http://"+n),t={value:n,type:"url"},u.setLink.call(a,t),u.hideLink()):(i.focus(),i.attr("placeholder","请输入合法的URL地址"),o.find(".mind-input-error").css("display","flex"))}),l.off().on("click",function(e){e.stopPropagation(),u.hideLink()}),s.off().on("click",function(){u.removeLink.call(a),u.hideLink()})))},showLinkMenu:function(e,i){var n=this,o=n.operation,r=n.model.getTopicById(i).link.value,t=$("#topic-link-list");0==t.length&&(t=$("<div id='topic-link-list' class='topic-link-list'><span tp='open'>打开链接</span><span class='sep'></span><span class='mind-icons' title='复制链接' title_pos='top' tp='copy'>&#xe70b;</span><span class='sep'></span><span class='mind-icons' title='取消链接' title_pos='top' tp='delete'>&#xe737;</span><span class='sep'></span><span class='mind-icons' title='修改链接' title_pos='top' tp='edit'>&#xe738;</span><input id='topic-ipt-link' type='text' style='z-index:-1;opacity:0;position:absolute;' value='"+r+"' /></div>").appendTo($("body")));var l=$("#"+i),s=l.find(".topic-link"),a=l.offset(),c=a.top-t.outerHeight()-2,d=a.left;c<45&&(c=a.top+l.outerHeight()+2),s.offset().left+s.outerWidth()+10-l.offset().left>t.outerWidth()&&(d=e.offset().left+e.outerWidth()-t.outerWidth()),t.css({position:"absolute",top:c,left:d}),t.off("click.link").on("click.link","span[tp]",function(e){e.stopPropagation();var t=$(this).attr("tp");if(t)switch(t){case"open":r&&window.open(r);break;case"copy":document.getElementById("topic-ipt-link").select(),document.execCommand("Copy")&&$.showTip("复制链接成功",2e3);break;case"delete":o.removeLink.call(n,i),o.moveLinkMenu(),o.hideLink();break;case"edit":o.showLink.call(n,i),o.moveLinkMenu()}}),$(document).off("mouseup.link").on("mouseup.link",function(){o.moveLinkMenu()})},moveLinkMenu:function(){setTimeout(function(){$("#topic-link-list").remove(),$("#mind_hover_tip").hide()},200)},hideLink:function(){$(".mind-topic-box").hide(),setTimeout(function(){$(".mind-topic-box").find("input[type=text]").val("")},500)},setLink:function(e,t,i){var n,o,r=this.util,l=this.model,s=t||r.getSelectedId();null!=s&&""!=$.trim(s)&&""!=$.trim(e.value)&&(this.opts.readonly||($.trim(e.value),null==(n=l.getTopicById(s)).link&&(n.link={}),null!=(o=r.copy(n)).link&&o.link.value==e.value&&null!=o.link&&o.link.title==e.title||(n.link={value:e.value,type:i||"url",title:e.title},l.updateTopicNode.call(this,n,o,"link"))))},removeLink:function(e){var t,i,n=this.util,o=this.model,r=e||n.getSelectedId();null!=r&&""!=$.trim(r)&&(this.opts.readonly||null!=(t=o.getTopicById(r)).link&&(i=n.copy(t),delete t.link,o.updateTopicNode.call(this,t,i,"link")))},borderCoverBorderChild:!1,setStyle:function(e){var t=this,i=t.util,n=t.model,o=i.selectedIds;if(0!=o.length){if(!t.opts.readonly){for(var r=[],l=[],s=0,a=o.length;s<a;s++){var c=o[s],d=n.getTopicById(c),p=i.copy(d);l.push(p);var u,h,m,g,f,v,y,x,b,T="line";null!=e["line-width"]?(d.lineStyle=d.lineStyle||{},d.lineStyle.lineWidth=e["line-width"]):null!=e["line-color"]?(d.lineStyle=d.lineStyle||{},d.lineStyle.lineColor=e["line-color"]):null!=e["line-type"]?(d.lineStyle=d.lineStyle||{},d.lineStyle.lineType=e["line-type"]):(u=i.copyArray(e),0<(h=$("#"+c)).length&&(!u["border-width"]||u["border-color"]||u["border-style"]||(h.css("borderColor")&&"none"!=h.css("borderColor")||(u["border-color"]="#666"),"rgb(255, 255, 255)"!=h.css("borderColor")||h.css("borderStyle")&&"none"!=h.css("borderStyle")||(u["border-color"]="#666"),h.css("borderStyle")&&"none"!=h.css("borderStyle")||(u["border-style"]="solid"),h.css("borderStyle")&&"double"==h.css("borderStyle")&&(u["border-width"]=3*parseInt(e["border-width"])+"px")),!u["border-color"]||u["border-width"]||u["border-style"]||(0==parseFloat(h.css("borderWidth")||0)&&(u["border-width"]="1px"),h.css("borderStyle")&&"none"!=h.css("borderStyle")||(u["border-style"]="solid")),!u["border-style"]||u["border-width"]||u["border-color"]||(m=h.css("borderStyle"),g=u["border-style"],f=parseInt(h.css("borderWidth"))||0,"double"==m&&"double"!=g&&(u["border-width"]=f/3+"px"),"double"==g?0==f?u["border-width"]="3px":"double"!=m&&(u["border-width"]=3*f+"px"):0==f&&(u["border-width"]="1px"),h.css("borderColor")||(u["border-color"]="#666"))),d.style=$.extend(d.style,u),T="style",d.style.border&&(y=(v=d.style.border.split(" "))[0],x=v[1],b=v.length,tpBorderColor=3==b?v[2]:(tpBorderColorArray=v.slice(2,b),tpBorderColorArray.join(" ")),t.style.borderCoverBorderChild?(delete d.style["border-color"],delete d.style["border-width"],delete d.style["border-style"]):(d.style["border-width"]||(d.style["border-width"]=y),d.style["border-color"]||(d.style["border-color"]=tpBorderColor),d.style["border-style"]||(d.style["border-style"]=x),(d.style["border-width"]&&d.style.border||d.style["border-color"]&&d.style.border||d.style["border-style"]&&d.style.border)&&delete d.style.border))),r.push(d)}t.style.borderCoverBorderChild=!1,n.updateTopicNode.call(t,r,l,T)}}else t.style.borderCoverBorderChild=!1},clearStyle:function(){var e=this.util,t=this.model,i=e.selectedIds;if(0!=i.length&&!this.opts.readonly){for(var n=[],o=[],r=0,l=i.length;r<l;r++){var s=i[r],a=t.getTopicById(s),c=e.copy(a);o.push(c),delete a.style,delete a.lineStyle;for(var d=a.title.split("<br>"),p=$("<div id='temp_input' style='display:none;' contenteditable='true'></div>").appendTo("body"),u=[],h=0;h<d.length;h++){var m=d[h];p.html(m),u.push(p.text())}$("#temp_input").remove(),a.title=u.join("<br>"),n.push(a)}t.updateTopicNode.call(this,n,o,"clearStyle")}},setTopicImage:function(e,t,i){var n,o,r,l=this.model,s=this.util;this.opts.readonly||(null==e&&(e=s.getSelectedId()),null!=e&&(n=l.getTopicById(e),o=s.copy(n),(r=s.copy(n)).image=$.extend(!0,{w:i.width,h:i.height},{url:t}),l.updateTopicImage.call(this,r,o)))},removeTopicImage:function(e){var t,i,n=this.model,o=this.util;this.opts.readonly||(t=n.getTopicById(e),i=o.copy(t),null!=t&&(delete t.image,n.updateTopicImage.call(this,t,i)))},renderTopicImage:function(e){if(e.image&&e.image.url){var t,i=$(".topic-box[id="+e.id+"]");600<e.image.w&&(t=600*e.image.h/e.image.w,e.image.w=600,e.image.h=t);var n=null!=(r=e.image.url)&&""!=r?r=(r=(r=(r=(r=(r=(r=r.toString()).replace(/</g,"&lt;")).replace(/%3C/g,"&lt;")).replace(/>/g,"&gt;")).replace(/%3E/g,"&gt;")).replace(/'/g,"&#39;")).replace(/"/g,"&quot;"):"";0<=n.indexOf("orgu2a928.bkt.clouddn.com")?n=n.replace("orgu2a928.bkt.clouddn.com","cdn2.processon.com"):0<=n.indexOf("7xt9nt.com1.z0.glb.clouddn.com")?n=n.replace("7xt9nt.com1.z0.glb.clouddn.com","cdn.processon.com"):0<=n.indexOf("p7o7ul1nf.bkt.clouddn.com")&&(n=n.replace("p7o7ul1nf.bkt.clouddn.com","cdn1.processon.com"));var o=$("<div style='height:"+e.image.h+"px;width:"+e.image.w+"px;' class='topic-image'><img style='height:"+e.image.h+"px;width:"+e.image.w+"px;' id='topic_img_"+e.id+"' src='"+n+"'/></div>");return i.prepend(o),o}var r},previewTopicImage:{data:{imgUrl:"",imgW:0,imgH:0,scale:100,scaleMin:10,scaleMax:500,scaleInt:15,translateX:0,translateY:0,clientWidth:0,clientHeight:0,zoomNoticeTimeIdx:0,imageShow:!1},init:function(e){var a,t,i,n;e?(t=(a=this).data,i=$("#img-preview"),n=$("#img-preview .current-image")[0],t.imageShow=!0,t.scale=100,t.translateX=0,t.translateY=0,t.imgUrl=e,n.src=e,n.onload=function(){t.imageShow&&(t.imgW=n.width,t.imgH=n.height,a.imgInit(),console.log(t),i.show())},n.onerror=function(){t.imageShow&&$.showTip("图片打开失败",2500)},i.off("mousedown").on("mousedown",function(e){e.stopPropagation()}),$("#img-preview .current-image").off("mousedown").on("mousedown",function(e){e.stopPropagation();var n=a.data,o=n.translateX,r=n.translateY,l=e.pageX,s=e.pageY;$(document).off("mousemove.imgPreview").on("mousemove.imgPreview",function(e){e.stopPropagation();var t=e.pageX,i=e.pageY;n.translateX=Math.round(o+(t-l)),n.translateY=Math.round(r+(i-s)),a.setChange()}),$(document).off("mouseup.imgPreview").on("mouseup.imgPreview",function(e){$(document).off("mousemove.imgPreview"),$(document).off("mouseup.imgPreview")})}),i.off("mousewheel DOMMouseScroll").on("mousewheel DOMMouseScroll",function(e){var t=e.originalEvent.wheelDelta||-e.originalEvent.detail,i=Math.max(-1,Math.min(1,t));return e.preventDefault(),i<0?a.zoomFn(-1):a.zoomFn(1),!1}),$("#img-preview .bottom-tool").off("click").on("click",".tool-item",function(){$(this).hasClass("zoom-in")?a.zoomFn(1):$(this).hasClass("zoom-out")?a.zoomFn(-1):$(this).hasClass("zoom-size-adapt")&&a.zoomFn(0)}),$("#img-preview .close-btn").off("click").on("click",function(){t.imageShow=!1,i.hide(),n.src=""})):$.showTip("图片打开失败",2500)},zoomFn:function(e){var t,i,n=this.data,o=n.scale,r=Math.floor((n.scale-100)/n.scaleInt)+e,l=n.scaleInt*r+100;0===e?(n.scale=100,n.translateX=0,n.translateY=0):(n.scale=l<n.scaleMin?n.scaleMin:l>n.scaleMax?n.scaleMax:l,t=Math.round(n.imgW*n.scale/100),i=Math.round(n.imgH*n.scale/100),n.clientWidth=$(document).width(),n.clientHeight=$(document).height(),t>n.clientWidth&&(n.translateX=n.translateX-Math.round(n.imgW*(n.scale-o)/200)),i>n.clientHeight&&(n.translateY=n.translateY-Math.round(n.imgH*(n.scale-o)/200))),this.zoomNotice(),this.setChange()},setChange:function(){var e=this.data,t=Math.round(e.imgW*e.scale/100),i=Math.round(e.imgH*e.scale/100);e.clientWidth=$(document).width(),e.clientHeight=$(document).height();var n=t>e.clientWidth?t-e.clientWidth:0,o=i>e.clientHeight?i-e.clientHeight:0;n||o?$("#img-preview .current-image").addClass("move"):$("#img-preview .current-image").removeClass("move"),e.translateX=0<e.translateX?0:e.translateX<-n?-n:e.translateX,e.translateY=0<e.translateY?0:e.translateY<-o?-o:e.translateY,$("#img-preview .current-image").css({width:t,height:i}),$("#img-preview .image-container").css({width:t,height:i,left:e.translateX,top:e.translateY})},imgInit:function(){var e=this.data;e.clientWidth=$(document).width(),e.clientHeight=$(document).height(),(e.imgW>e.clientWidth||e.imgH>e.clientHeight)&&(e.scale=Math.round(100*Math.min(e.clientWidth/e.imgW,e.clientHeight/e.imgH))),this.setChange()},zoomNotice:function(){var e=$("#img-preview .zoom-ratio-notice"),t=this.data.scale+"%";e.is(":visible")&&clearTimeout(this.data.zoomNoticeTimeIdx),e.html(t).show(),this.data.zoomNoticeTimeIdx=setTimeout(function(){e.hide()},1e3)}},clearCanvas:function(){var e=$(".mind-context-menu");e.hide(),e.appendTo($(".mind-util-container"));var t=$("#mind-task");t.hide(),t.appendTo($(".mind-util-container")),this.container.html("")},changeStructure:function(e,t,o,r){var l=this,s=l.model,d=s.topic,a=l.operation,c=l.messageSource,p=d.structure,u=l.util;a.zoomVal=100,d.structure=e;for(var h="&#xe6fe;",i=d.children,n=u.copyArray(i),m=[],g=0,f=0;f<n.length;f++){var v,y=n[f];y.free&&(v=u.copy(y),m.push(v),i.splice(f-g,1),g++)}switch(e){case"mind_right":var x=u.copyArray(d.leftChildren||[]),b=J(d.children.length,"right","left");d.leftChildren=[],d.children=d.children.concat(x),h="&#xe6fb;",Z(e,t||b.newSums,b.oldSums);break;case"mind_free":var T=[],C=[],S={},w={};if(d.summaries&&0<d.summaries.length)for(var k={},f=0;f<d.summaries.length;f++){var I,L=(N=d.summaries[f]).range+"",P=Number(L.split(",")[0]),_=Number(L.split(",")[1]);0!=(i="left"==N.part?d.leftChildren:d.children).length&&(I=i[P].id,F=i[_].id,k[N.id]=[I,F])}i=$.extend([],d.children),x=$.extend([],d.leftChildren);d.children=[],d.leftChildren=[];var M=i.concat(x),W=M.length,O=W/2;W%2==1&&(O=(W+1)/2);for(f=0;f<W;f++){var D=M[f],B=0,A="",A=f<O?(B=d.children.length,d.children.push(D),"right"):(B=d.leftChildren.length,d.leftChildren.push(D),"left");S[D.id]=A,w[D.id]=B}var x=d.leftChildren,i=d.children,H=d.summaries;if(null!=H&&0<H.length)for(var z=0;z<H.length;z++){var N=H[z],E=u.copy(N);delete E.children;var R,F,V,j,Y,K,X,U,q=k[N.id];q&&(R=q[0],F=q[1],V=S[R],j=S[F],Y=w[R],K=w[F],X=!1,V==j?(N.part=V,N.range=Y+","+K,X=!0):"left"==V&&"right"==j?(N.part="left",N.range=Y+","+Y,X=!0):"right"==V&&"left"==j&&(N.part="right",N.range=Y+","+Y,X=!0),X&&(delete(U=u.copy(N)).children,T.push(E),C.push(U)))}Z(e,t||C,T);break;case"mind_left":b=J((d.leftChildren||[]).length,"left","right");d.structure="mind_right";i=$.extend([],d.children);d.leftChildren=d.leftChildren||[],d.children=[];for(f=0;f<i.length;f++){var G=i[f];G.free?d.children.push(G):d.leftChildren.push(G)}h="&#xe6fc;",Z(e,t||b.newSums,b.oldSums);break;case"mind_org":b=J(d.children.length,"right","left"),i=$.extend([],d.leftChildren);d.leftChildren=[],d.children=d.children.concat(i),h="&#xe6fd;",Z(e,t||b.newSums,b.oldSums);break;case"mind_tree":b=J(d.children.length,"right","left"),i=$.extend([],d.leftChildren);delete d.leftChildren,d.children=d.children.concat(i),h="&#xe6fd;",Z(e,t||b.newSums,b.oldSums)}function J(e,t,i){var n=[],o=[];if(d.summaries&&0<d.summaries.length)for(var r=0;r<d.summaries.length;r++){var l,s,a,c=u.copy(d.summaries[r]);c.children=[],c.part&&c.part==i&&(n.push(u.copy(c)),l=c.range+"",s=Number(l.split(",")[0])+e+","+(Number(l.split(",")[1])+e),a=t,c.part=a,c.range=s,o.push(c),d.summaries[r].part=a,d.summaries[r].range=s)}return{oldSums:n,newSums:o}}function Z(e,t,i){0<m.length&&(d.children=d.children.concat(m)),null!=o&&o(h),s.groupList.doGroup(d,d.structure),s.topicList.resetTopicList.call(l),a.clearCanvas.call(l);var n=l.opts.themeDef;mind=new mindDesigner("#mind_con",{chartId:chartId},d,n),null==r&&c.send.call(l,"updateStructure",{content:e,original:p,newSums:t,oldSums:i})}},renderTopicLink:function(e,t,i){var n,o,r,l;t.link&&null!=t.link.value?(n=t.link,(o=(l=e.getTopicDom(t.id)).children(".topic-link")).length?(o.attr("href",n.value),"file"==t.link.type&&o.html("&#xe6b0;")):(r="&#xe64c;","file"==t.link.type&&(r="&#xe6b0;"),o=$("<a href='"+n.value+"' target='_blank' class='topic-link mind-icons'>"+r+"</a>"),t.note?l.find(".topic-note").after(o):l.find(".topic").after(o)),"right"==i||null==i?o.addClass("right"):"left"==i&&o.addClass("left")):(l=e.getTopicDom(t.id)).children(".topic-link").remove()},zoomVal:100,zoomIn:function(e){var t=this.operation;t.zoomVal=Number(t.zoomVal)+15;var i,n=t.zoomVal;200<n?t.zoomVal=200:(i=n/100,e.css({transform:"scale("+i+")","-webkit-transform":"scale("+i+")","-moz-transform":"scale("+i+")"}),mind.plugins.navigator.init.call(mind))},zoomOut:function(e){var t=this.operation;t.zoomVal=Number(t.zoomVal)-15;var i,n=t.zoomVal;n<40?t.zoomVal=40:(i=n/100,e.css({transform:"scale("+i+")","-webkit-transform":"scale("+i+")","-moz-transform":"scale("+i+")"}),mind.plugins.navigator.init.call(mind))},tochZoom:function(e,t,i){var n,o=this.operation;t<40?o.zoomVal=40:200<t?o.zoomVal=200:(n=(o.zoomVal=t)/100,e.css({transform:"scale("+n+")","-webkit-transform":"scale("+n+")","-moz-transform":"scale("+n+")"}),null!=i&&e.css({"transform-origin":i,"-webkit-transform-origin":i}),mind.plugins.navigator.init.call(mind))},initBrash:function(e){var t,i,n,o=e.util,r=o.getSelectedId(),l=e.model,s=e.operation;""!=r&&(t=l.getTopicById(r),i=e.style.getStyle.call(e,t),n=o.copy(i),s.brashData.style=n,s.brashData.id=r,s.showTip())},brash:function(e){var t,i,n,o=this,r=o.util,l=o.model,s=o.operation,a=o.currentRoot||l.topic;null!=s.brashData&&null!=s.brashData.style&&s.brashData.id!=e&&(t=l.getTopicById(e),i=s.brashData.style,n=r.getSelectedPart(t.id,a.structure),o.style.setTopicStyles(o,t,i,n))},brashData:{id:null,style:null},showTip:function(){$("#mind-brash-tip").show().css({left:25,top:88})},closeTip:function(){$("#mind-brash-tip").hide(),this.brashData.style=null,this.brashData.id=null,$(".brash").addClass("mind-disable")},scrollStv:null,scrollIsOver:!1,scrollLayout:null,scrollPos:{},initScrollPos:function(){var e=$(window);this.scrollLayout=$("#mind_con"),this.scrollPos.b=e.height()-50,this.scrollPos.t=75,this.scrollPos.l=50,this.scrollPos.r=e.width()-50},isScroll:function(e,t){var i=this;e<i.scrollPos.l?i.startScroll("l"):e>i.scrollPos.r?i.startScroll("r"):t<i.scrollPos.t?i.startScroll("t"):t>i.scrollPos.b?i.startScroll("b"):i.scrollIsOver&&i.stopScroll()},stopScroll:function(){window.clearInterval(this.scrollStv),this.scrollStv=null,this.scrollIsOver=!1},startScroll:function(e){var t=this;t.scrollIsOver||(t.scrollIsOver=!0,t.scrollStv=setInterval(function(){t.scrolling(e)},20))},scrolling:function(e){var t=this.scrollLayout;switch(e){case"t":t.scrollTop(t.scrollTop()-5);break;case"b":t.scrollTop(t.scrollTop()+5);break;case"l":t.scrollLeft(t.scrollLeft()-5);break;case"r":t.scrollLeft(t.scrollLeft()+5)}}}},mindDesigner.prototype.line={renderLineCon:function(){$(this.designer).append('<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="100%" height="100%" xlink="http://www.w3.org/1999/xlink" class="mind-line-svg"><defs></defs><g  class="svg-topic-con" transform="translate(0.5,0.5)"></g><g class="svg-connection-con" transform="translate(0.5,0.5)"></g><g class="svg-freesums-con" transform="translate(0.5,0.5)"></g></svg>')},renderSubLineCon:function(e,t){var i='<svg xmlns="http://www.w3.org/2000/svg" version="1.1" width="100%" height="100%"  xlink="http://www.w3.org/1999/xlink"><g id="subline_'+t+'" transform="translate(0.5,-0.5)"></g><g transform="translate(0.5,0)"></g><g  class="svg-summary-con" transform="translate(0.5,0.5)"></g></svg>';e.append(i)},getLineDom:function(e){return $("#line_"+e)},renderSubLine:function(e,t,i,n,o){var r=this,l=document,s=r.model,a=r.currentRoot||s.topic,c=r.line,d=r.styles,p=l.getElementsByClassName("svg-topic-con")[0],u=r.style,h=r.util,m=$("#line_"+e.id);m.length&&m.remove();var g=u.getLineStyle.call(r,e),f="mind_org"==a.structure||"mind_tree"==a.structure?h.copy(c.getOrgSubLinePath(g,i,n)):h.copy(c.getSubLinePath(g,e,t,d.thinner,i,n,o,null,a.id)),v=l.createElementNS("http://www.w3.org/2000/svg","path");for(var y in v.setAttributeNS(null,"part",o),v.setAttributeNS(null,"sub","true"),v.setAttributeNS(null,"id","line_"+e.id),f)v.setAttributeNS(null,y,f[y]);p.appendChild(v)},getOrgSubLinePath:function(e,t,i,n){var o=Math.floor(t.x),r=Math.floor(i.y);i.x=Math.floor(i.x),t.y=Math.floor(t.y),Math.abs(o-i.x)<3&&o!=i.x&&(i.x=o);var l="M"+o+" "+t.y+" L"+o+" "+(r-23)+" L"+i.x+" "+(r-23)+" L"+i.x+" "+r;return n?l:{d:l,stroke:e.lineColor,fill:"none","stroke-width":e.lineWidth}},getSubLinePath:function(e,t,i,n,o,r,l,s,a){var c=e.lineType,d="sub"+c+"UnderLine";return e.underLine&&null!=this.linePaths[d]?this.linePaths[d](t,i,e,o,r,n,l,s,a):this.linePaths["sub"+c](t,i,e,o,r,n,l,s,a)},getLinePath:function(e,t,i,n,o,r,l,s){return i.underLine&&null!=this.linePaths[i.lineType+"UnderLine"]?this.linePaths[i.lineType+"UnderLine"](e,t,i,o,r,l,null,s):this.linePaths[i.lineType](e,t,i,o,r,l,null,s)},getTreeLinePath:function(e,t,i,n,o,r,l,s){var a=o.y+2,c=o.x+r.w+10,d="M"+o.x+" "+a+" L"+o.x+" "+r.y+"L"+c+" "+r.y;return s?d:{d:d,p:t.id,stroke:i.lineColor,fill:"none","stroke-linecap":"round","stroke-width":1}},getOrgLinePath:function(e,t,i,n,o,r,l,s){var a=Math.floor(o.y)+2;o.x=Math.floor(o.x),r.x=Math.floor(r.x),r.y=Math.floor(r.y),Math.abs(o.x-r.x)<3&&o.x!=r.x&&(r.x=o.x);var c,d="M"+o.x+" "+a+" L"+o.x+" "+(a+24)+" L"+r.x+" "+(a+24)+"L"+r.x+" "+(r.y-2);return t.summary&&(c=o.x,Math.abs(r.x-c)<6&&(r.x=c),d="M"+c+" "+a+" L"+c+" "+(a+24)+" L"+r.x+" "+(a+24)+"L"+r.x+" "+(r.y-2)),s?d:{d:d,p:t.id,stroke:i.lineColor,fill:"none","stroke-linecap":"round","stroke-width":i.lineWidth}},renderLines:function(c,e,n){var d=this,p=d.util,u=d.operation.zoomVal/100,h=d.line,t=d.model,m=(d.currentRoot||t.topic).structure;function g(e,t){var i;e.summary&&"mind_tree"==m||(d.summary.renderSummarieShape.call(d,e,n,t),e.collapsed||(i=p.getChildTopicRelativePos.call(d,e.id,u),"left"==n?v(e,i):(e.summary&&"mind_org"==m?i.x+=i.w/2:i.x+=i.w,f(e,i))))}function f(e,t){if(!(e.summary&&"mind_tree"==m||e.collapsed)){var i=e.children,n=i.length,o=e.summaries,r=i;if(null!=o&&0<o.length&&(n=(r=i.concat(o)).length),0!=n&&0<n)for(var l=0;l<n;l++){var s=r[l];if(s){if("mind_org"==m){var a=p.getOrgChildTopicRelativePos.call(d,s.id,u);s.summary?g(s,e):h.renderLine.call(d,s,e,t,a,c.id),a.y+=a.h}else if("mind_tree"==m){if(s.summary)continue;a=p.getTreeChildTopicRelativePos.call(d,s.id,u);if(s.summary)continue;h.renderLine.call(d,s,e,t,a,c.id),a.x+=9}else{a=p.getChildTopicRelativePos.call(d,s.id,u);s.summary?g(s,e):h.renderLine.call(d,s,e,t,a,c.id),a.x+=a.w}s.summary||f(s,a)}}}}function v(e,t){if(!e.collapsed){var i=e.children,n=i.length,o=e.summaries,r=i;if(null!=o&&0<o.length&&(n=(r=i.concat(o)).length),0<n)for(var l=0;l<n;l++){var s=r[l],a=p.getChildTopicRelativePos.call(d,s.id,u);s.summary?g(s,e):(h.renderLine.call(d,s,e,t,a,c.id,"left"),v(s,a))}}}("left"==n?v:f)(c,e)},renderLine:function(e,t,i,n,o,r){if(0!=i.w){var l=this,s=l.model,a=l.currentRoot||s.topic,c=l.style,d=a.structure||s.topic.structure,p=$("#line_"+e.id),u=document.getElementById("subline_"+o);p.length&&p.remove();var h=c.getLineStyle.call(l,e),m="mind_org"==d?l.line.getOrgLinePath(e,t,h,!1,i,n,r):"mind_tree"!=d?l.line.getLinePath(e,t,h,!1,i,n,r,a.id):l.line.getTreeLinePath(e,t,h,!1,i,n,r),g=document.createElementNS("http://www.w3.org/2000/svg","path");if(g.setAttributeNS(null,"id","line_"+e.id),"object"==typeof m)for(var f in m)g.setAttributeNS(null,f,m[f]);u.appendChild(g)}},renderNewLine:function(e,t,i,n,o){var r=e.line;i.root?r.renderSubLine.call(e,t,i,{x:0,y:0,h:0},{x:0,y:0,h:0},o):(document.getElementById("subline_"+n),r.renderLine.call(e,t,i,{x:0,y:0,h:0,w:0},{x:0,y:0,h:0,w:0},n,o))},renderNewLines:function(e,t,i){var n=e.line,o=t.children,r=o.length;if(0<r)for(var l=0;l<r;l++){var s=o[l];n.renderNewLine(e,s,t,i),s.collapsed||n.renderNewLines(e,s,i)}},resetSubLines:function(e){for(var t=this,i=t.util,n=t.model,o=t.operation.zoomVal/100,r=t.currentRoot||n.topic,l=t.styles,s=t.line,a=$(".svg-topic-con"),c=null,c=null!=e&&0<=e.indexOf("left")&&e.indexOf("right")<0?a.children("path[part=left]"):null!=e&&0<=e.indexOf("left")&&0<=e.indexOf("right")?a.children("path"):a.children("path[part=right]"),d=i.getTopicContainerProp(r.id,o),p={x:d.x+d.w/2,y:d.y+d.h/2},u=c.length,h=0;h<u;h++){var m=c[h],g=m.getAttribute("id").substr(5),f="mind_org"==r.structure?i.getSubTopicDomProp(g,"mind_org",o):"mind_tree"==r.structure?i.getSubTopicDomProp(g,"mind_tree",o):i.getSubTopicDomProp(g,null,o),v=m.getAttribute("part");"left"==v&&(f.x+=f.w);var y,x,b=n.getTopicById(g),T=t.style.getLineStyle.call(t,b);x="mind_org"==r.structure||"mind_tree"==r.structure?s.getOrgSubLinePath(T,p,f,!0):(y=n.getParentTopic(b.parent),s.getSubLinePath(T,b,y,l.thinner,p,f,v,!0,r.id)),m.setAttribute("d",x)}},resetLines:function(e,t,i){(new Date).valueOf();var n=this,o=n.util,r=(n.opts,n.operation.zoomVal/100),l=n.model,s=n.currentRoot||l.topic,a=s.structure||l.topic.structure,c=n.styles,d=n.line,p=$(".svg-topic-con"),u=null!=i&&0<=i.indexOf("left")&&i.indexOf("right")<0?p.children("path[part=left]"):null!=i&&0<=i.indexOf("left")&&0<=i.indexOf("right")?p.children("path"):p.children("path[part=right]"),h="mind_org"==a,m="mind_tree"==a,g=u.length;null==t||0!=t||h||m||(g=0);for(var f={},v=o.getTopicDomProp(s.id,r),y={x:v.x+v.w/2,y:v.y+v.h/2},x=0;x<g;x++){var b=u[x],T=b.getAttribute("id").substr(5),C=b.getAttribute("part"),S=h?o.getSubTopicDomProp(T,"mind_org",r):m?o.getSubTopicDomProp(T,"mind_tree",r):o.getSubTopicDomProp(T,null,r);"left"==C&&(S.x+=S.w),f[T]=C;var w,k,I,L=l.getTopicById(T);L.free||(w=n.style.getLineStyle.call(n,L),I="",I=h||m?d.getOrgSubLinePath(w,y,S,!0):(k=l.getParentTopic(L.parent),d.getSubLinePath(w,L,k,c.thinner,y,S,C,!0,s.id)),b.setAttribute("d",I))}if(0<e.length)for(x=0;x<e.length;x++){var P,_,T=e[x],M=l.getTopicById(T);null!=M&&((P=$("#subline_"+T)).children("path").length,C=f[T],0==M.children.length&&null==M.summaries||0==P.length||(null==C&&(C=i,null!=M.part&&(C=M.part)),h?y=o.getSubTopicRelativePos(T,"mind_org"):m?(y=o.getSubTopicRelativePos(T,"mind_tree")).x+=9:(y=o.getSubTopicRelativePos(T),"left"==C?(_=o.getTopicDomProp(T),y.x=_.w-y.w-2):y.x=y.w),d.renderLines.call(n,M,y,C)))}},deleteLine:function(e){var t=e.children,i=t.length;if($("path[id=line_"+e.id+"]").remove(),e.summary&&$("path[id=sum_"+e.id+"]").remove(),0<i)for(var n=0;n<i;n++){var o=t[n];this.deleteLine(o)}if(null!=e.summaries&&0<e.summaries.length)for(n=0;n<e.summaries.length;n++){o=e.summaries[n];this.deleteLine(o)}},deleteChildrenLines:function(e){var t=e.children,i=t.length;if(0<i)for(var n=0;n<i;n++){var o=t[n];$("path[id=line_"+o.id+"]").remove(),this.deleteChildrenLines(o)}if(null!=e.summaries&&0<e.summaries.length)for(n=0;n<e.summaries.length;n++){(o=e.summaries[n]).summary&&$("path[id=sum_"+o.id+"]").remove(),this.deleteChildrenLines(o)}},linePaths:{subcurve:function(e,t,i,n,o,r,l,s){if(r){var a=["M"],c=n.y-6,d=n.y+6,p=n.x+10,u=-120,h=-100;"left"==l&&(u=120,h=100,p=n.x-10),o.y<c?(a.push(n.x),a.push(c),a.push("C"),a.push(n.x),a.push(c),a.push(o.x+u),a.push(o.y),a.push(o.x),a.push(o.y),a.push("C"),a.push(o.x+h),a.push(o.y),a.push(p),a.push(n.y),a.push(p),a.push(n.y),a.push("L"),a.push(n.x),a.push(c),a.push("Z")):o.y>=c&&o.y<=d?(a.push(n.x),a.push(c),a.push("L"),a.push(n.x),a.push(d),a.push("L"),a.push(o.x),a.push(o.y),a.push("L"),a.push(n.x),a.push(c)):(a.push(n.x),a.push(d),a.push("C"),a.push(n.x),a.push(d),a.push(o.x+u),a.push(o.y),a.push(o.x),a.push(o.y),a.push("C"),a.push(o.x+h),a.push(o.y),a.push(p),a.push(n.y),a.push(p),a.push(n.y),a.push("L"),a.push(n.x),a.push(d),a.push("Z"));var m=a.join(" ");return s?m:{d:m,stroke:i.lineColor,fill:i.lineColor,"stroke-width":2}}(a=["M"]).push(n.x),a.push(n.y),a.push("C"),a.push(n.x),a.push(n.y),"left"==l?a.push(n.x-10):a.push(n.x+10),a.push(o.y),a.push(o.x),a.push(o.y);m=a.join(" ");return s?m:{d:m,stroke:i.lineColor,fill:"none","stroke-width":i.lineWidth}},substraight:function(e,t,i,n,o,r,l,s){if(r){var a=["M"],c=n.y-6,d=n.y+6,p=n.x+6;"left"==l&&(p=n.x-6),o.y<c?(a.push(n.x),a.push(c),a.push("L"),a.push(p),a.push(n.y),a.push("L"),a.push(o.x),a.push(o.y),a.push("L"),a.push(n.x),a.push(c)):o.y>=c&&o.y<=d?(a.push(n.x),a.push(c),a.push("L"),a.push(n.x),a.push(d),a.push("L"),a.push(o.x),a.push(o.y),a.push("L"),a.push(n.x),a.push(c)):(a.push(n.x),a.push(d),a.push("L"),a.push(p),a.push(n.y),a.push("L"),a.push(o.x),a.push(o.y),a.push("L"),a.push(n.x),a.push(d)),a.push("Z");var u=a.join(" ");return s?u:{d:u,stroke:i.lineColor,fill:i.lineColor,"stroke-width":2}}a="M"+n.x+" "+n.y+" L"+o.x+" "+o.y;return s?a:{d:a,stroke:i.lineColor,fill:"none","stroke-width":i.lineWidth}},subbroken:function(e,t,i,n,o,r,l,s){if(r)return path;var a=Math.ceil(n.x),c=Math.ceil(o.y),d="M"+a+" "+n.y+" L"+a+" "+c+" L"+o.x+" "+c;return s?d:{d:d,stroke:i.lineColor,fill:"none","stroke-width":i.lineWidth}},subroundBroken:function(e,t,i,n,o,r,l,s){var a=["M"];if(r)return path;var c=n.y<o.y;a.push(n.x),a.push(n.y),a.push("L"),a.push(n.x),8<Math.abs(o.y-n.y)&&(a.push(c?o.y-8:o.y+8),a.push("A"),a.push(8),a.push(8),a.push(0),a.push(0),"left"==l?(a.push(c?1:0),a.push(n.x-8)):(a.push(c?0:1),a.push(n.x+8))),a.push(o.y),a.push("L"),a.push(o.x),a.push(o.y);var d=a.join(" ");return s?d:{d:d,stroke:i.lineColor,fill:"none","stroke-width":i.lineWidth}},subcurveUnderLine:function(e,t,i,n,o,r,l,s){var a=["M"],c=$("#"+e.id),d=c.outerHeight();c.outerWidth();if(o.y=o.y+d/2-1.5,o.x="left"==l?o.x-1:o.x,r){var a=["M"],p=n.y-6,u=n.y+6,h=n.x+10,m=-120,g=-100;"left"==l&&(m=120,g=100,h=n.x-10),o.y<p?(a.push(n.x),a.push(p),a.push("C"),a.push(n.x),a.push(p),a.push(o.x+m),a.push(o.y),a.push(o.x),a.push(o.y),a.push("C"),a.push(o.x+g),a.push(o.y),a.push(h),a.push(n.y),a.push(h),a.push(n.y),a.push("L"),a.push(n.x),a.push(p),a.push("Z")):o.y>=p&&o.y<=u?(a.push(n.x),a.push(p),a.push("L"),a.push(n.x),a.push(u),a.push("L"),a.push(o.x),a.push(o.y),a.push("L"),a.push(n.x),a.push(p)):(a.push(n.x),a.push(u),a.push("C"),a.push(n.x),a.push(u),a.push(o.x+m),a.push(o.y),a.push(o.x),a.push(o.y),a.push("C"),a.push(o.x+g),a.push(o.y),a.push(h),a.push(n.y),a.push(h),a.push(n.y),a.push("L"),a.push(n.x),a.push(u),a.push("Z"));var f=a.join(" ");return s?f:{d:f,stroke:i.lineColor,fill:i.lineColor,"stroke-width":2}}(a=["M"]).push(n.x),a.push(n.y),a.push("C"),"left"==l?(a.push(n.x-30),a.push(n.y),a.push(n.x-10)):(a.push(n.x+30),a.push(n.y),a.push(n.x+10)),a.push(o.y),a.push(o.x),a.push(o.y);f=a.join(" ");return s?f:{d:f,stroke:i.lineColor,fill:"none","stroke-width":i.lineWidth}},curve:function(e,t,i,n,o,r,l){var s=["M"],a=o.x;Math.abs(o.y-n.y)<=3&&(o.y=n.y);var c=o.x-20,d=n.x+24,p=16;"left"==r&&(c=o.x+18+o.w,d=n.x-20,p=-16,a+=o.w);n.y,o.y;s.push(n.x),s.push(n.y),s.push("L"),s.push(n.x+p),s.push(n.y),s.push("C"),s.push(d),s.push(n.y),s.push(c),s.push(o.y),s.push(a),s.push(o.y);var u=s.join(" ");return l?u:{d:u,p:t.id,stroke:i.lineColor,"stroke-linecap":"round",fill:"none","stroke-width":i.lineWidth}},straight:function(e,t,i,n,o,r,l){Math.abs(o.y-n.y)<=3&&(o.y=n.y);var s=o.x,a=(o.y,""),a="left"==r?(s+=o.w,"M"+(n.x-4)+" "+n.y+" L"+(n.x-17)+" "+n.y+" L"+s+" "+o.y):"M"+(n.x+4)+" "+n.y+" L"+(n.x+17)+" "+n.y+" L"+s+" "+o.y;return l?a:{d:a,p:t.id,stroke:i.lineColor,fill:"none","stroke-linecap":"round","stroke-width":i.lineWidth}},broken:function(e,t,i,n,o,r,l,s){Math.abs(o.y-n.y)<=3&&(o.y=n.y);var a="",c=n.x,d=i.underLine?n.y+n.h/2:n.y,p=i.underLine?o.y+o.h/2:o.y,u=!!t.summary;return t.parent==s||u||"left"!=r||(c-=n.w),a="left"==r?(o.x+=o.w,"M"+c+" "+d+"L"+Math.ceil(c-15)+" "+d+" L"+Math.ceil(c-15)+" "+p+" L"+o.x+" "+p):"M"+c+" "+d+"L"+Math.ceil(c+15)+" "+d+" L"+Math.ceil(c+15)+" "+p+" L"+o.x+" "+p,l?a:{d:a,p:t.id,stroke:i.lineColor,fill:"none","stroke-linecap":"square","stroke-width":i.lineWidth}},roundBroken:function(e,t,i,n,o,r,l,s){Math.abs(o.y-n.y)<=3&&(o.y=n.y);var a=["M"],c=n.x,d=i.underLine?n.y+n.h/2:n.y,p=i.underLine?o.y+o.h/2:o.y,u=p>n.y,h=t.parent==s,m=!!t.summary;h||m||"left"!=r||(c-=n.w),a.push(c),a.push(h?n.y:d),a.push("L"),"left"==r?(c=Math.ceil(c-18),o.x+=o.w):c=Math.ceil(n.x+18),a.push(c),a.push(h?n.y:d),a.push("L"),a.push(c),5<Math.abs(p-d)&&(a.push(u?p-4:p+4),a.push("A"),a.push(4),a.push(4),a.push(0),a.push(0),"left"==r?(a.push(u?1:0),a.push(c-4)):(a.push(u?0:1),a.push(c+4))),a.push(p),a.push("L"),a.push(o.x),a.push(p);var g=a.join(" ");return l?g:{d:g,p:t.id,stroke:i.lineColor,fill:"none","stroke-linecap":"square","stroke-width":i.lineWidth}},roundBrokenUnderLine:function(e,t,i,n,o,r,l,s){var a,c=["M"];if(0==n.x)return"";Math.abs(o.y-n.y)<=3&&(o.y=n.y);var d=Math.floor(n.y+n.h/2);t.summary&&(d-=Math.floor(n.h/2));var p,u=Math.floor(o.y+o.h/2),h=u>n.y,m=t.parent==s;c.push(n.x),c.push(m?n.y:d),c.push("L"),a="left"==r?Math.ceil(n.x-18):Math.ceil(n.x+18),c.push(a),c.push(m?n.y:d),c.push("L"),c.push(a),20<Math.abs(u-d)&&(c.push(h?u-4:u+4),c.push("A"),c.push(4),c.push(4),c.push(0),c.push(0),"left"==r?(c.push(h?1:0),c.push(a-4)):(c.push(h?0:1),c.push(a+4))),c.push(u),c.push("L"),"left"==r?c.push(o.x):(p=$("#"+e.id).outerWidth(),c.push(o.x+p)),c.push(u);var g=c.join(" ");return l?g:{d:g,p:t.id,stroke:i.lineColor,fill:"none","stroke-linecap":"square","stroke-width":i.lineWidth}},curveUnderLine:function(e,t,i,n,o,r,l,s){var a,c=["M"];if(0==n.x)return"";Math.abs(o.y-n.y)<=3&&(o.y=n.y);var d=Math.floor(n.y+n.h/2),p=Math.floor(o.y+o.h/2);n.y,t.parent;c.push(n.x),c.push(d),c.push("L"),a="left"==r?Math.ceil(n.x-18):Math.ceil(n.x+18),c.push(a),c.push(d),c.push("M"),c.push(a),c.push(d),c.push("C");var u,h=o.x;"left"==r&&(h+=$("#"+e.id).outerWidth()),"left"==r?(c.push(h+20),c.push(d),c.push((n.x+h)/2)):(c.push(o.x-20),c.push(d),c.push((n.x+o.x)/2)),c.push(p),c.push(h),c.push(p),c.push("L"),"left"==r?c.push(o.x):(u=$("#"+e.id).outerWidth(),c.push(o.x+u)),c.push(p);var m=c.join(" ");return l?m:{d:m,p:t.id,stroke:i.lineColor,fill:"none","stroke-linecap":"square","stroke-width":i.lineWidth}},brokenUnderLine:function(e,t,i,n,o,r,l,s){Math.abs(o.y-n.y)<=3&&(o.y=n.y);var a,c=["M"],d=$("#"+e.id).outerWidth(),p=!!t.summary,u=n.y;p||(u+=n.h/2);var h=o.y+o.h/2,m=(n.y,t.parent==s);c.push(n.x),c.push(m?n.y:u),c.push("L"),a="left"==r?Math.ceil(n.x-18):Math.ceil(n.x+18),c.push(a),c.push(m?n.y:u),c.push("L"),c.push(a),c.push(h),c.push("L"),"left"==r?c.push(a-d-18):c.push(a+d+18),c.push(h);var g=c.join(" ");return l?g:{d:g,p:t.id,stroke:i.lineColor,fill:"none","stroke-linecap":"square","stroke-width":i.lineWidth}}}},mindDesigner.prototype.summary={model:{styles:{lineColor:"#bf1e1b",lineWidth:"1",lineType:"curve_complex"},currentStyle:null,addSummary:function(e,t){for(var i=this,n=i.util,o=i.model,r=i.currentRoot||o.topic,l=i.line,s=o.groupList,a=e.length,c={},d=[],p=0;p<a;p++){var u=n.copy(e[p]),h=u.part,m=o.getTopicById(u.parent);m&&d.push(m);var g,f=o.getSubTopic(u);null==h&&(h=n.getSelectedPart(f.id,r.structure)),m.id==r.id&&(u.pos={}),null==m.summaries&&(m.summaries=[]),m.summaries.push(u),o.addTopicToList(u,m),null==u.part?(g=null,m.root||(g=n.getTopicContainerProp(f.id)),i.renderSubTopic(u,null,h),i.range.changeTopicPos(i,u,f,h,g),l.resetLines.call(i,[f.id],null,h)):i.renderSubTopic(u,null,h),c[u.id]=h}s.doGroup(r,r.structure),o.topicList.resetTopicList.call(i),i.renderFreeSummaries(h),d&&0<d.length&&i.events.push("outline-prebuild",{topics:d,insertChild:!0}),null==t&&(i.messageSource.send.call(i,"addSummary",{content:e,parts:c}),n.selectOne.call(i,e[0]))},removeSummary:function(e,t,i){var n=this,o=n.model,r=n.currentRoot||o.topic,l=(o.groupList,n.util),s=n.line,a=(n.styles,n.util.getMargin.call(n)),c=a.marginW,d=a.marginH,p=[],u={},t=t||{},h="";n.connection.deleteConnectionByTopics.call(n,e);for(var m=e.length-1;0<=m;m--){var g=e[m],f=o.getParentTopic(g.parent);if(null!=f){var v,y,x,b,T=o.getSubTopic(g),C=l.getSelectedPart(g.id,r.structure),S=0,w=l.getTopicContainerProp(T.id),k=$(".topic-box[id="+g.id+"]").parent().parent().prev();k.length&&0<k.children().length&&(0,(v=g.range+"").indexOf(",")<0?0:(v.split(",")[0],v.split(",")[1]),y=k.parent(),k.children().each(function(){var e=$(this);y.before(e)}),y.remove()),s.deleteLine(g),g.free||null==w||(T.id==g.id?(S=w.h+d,b=0,"mind_org"!=r.structure&&"mind_tree"!=r.structure||(b=-w.w-c/2),n.range.doChangeSubTopicPos(n,T,-S/2,b,C)):(S=(x=l.getTopicContainerProp(T.id)).h-w.h,b=0,"mind_org"!=r.structure&&"mind_tree"!=r.structure||(b=x.w-w.w),n.range.doChangeSubTopicPos(n,T,S/2,b,C)),p.indexOf(T.id)<0&&p.push(T.id)),null==i&&l.selectOne.call(n,f);for(var I=f.summaries,L=I.length,P=0;P<L;P++){if(I[P].id==g.id){u[g.id]=P,I.splice(P,1);break}}h+=(t[g.id]=C)+","}}n.model.topicList.resetTopicList.call(n),o.groupList.doGroup(r,r.structure),s.resetLines.call(n,p,null,h),null==i&&n.messageSource.send.call(n,"deleteSummary",{content:e,index:u,parts:t}),n.connection.resetAllConnectionPos.call(n,r),0<parents.length&&n.events.push("outline-prebuild",{topics:parents,insertChild:!0})}},renderSummaryDoms:function(d,e,t){var p=this;"mind_tree"!=d.model.topic.structure&&!function e(t,i){p.renderSummaryDom(d,t,i);if(t.collapsed)return;var n=t.children;var o=n.length;if(0<o)for(var r=0;r<o;r++){var l=n[r];d.renderSubTopic(l,null,i)}if(null!=t.summaries&&0<t.summaries.length)for(var s=t.summaries.length,a=0;a<s;a++){var c=t.summaries[a];e(c,i)}}(e,t)},renderSummaryDom:function(e,t,i){var n=e.util,o=e.designer,r=e.model,l=e.operation,s=r.topic,a=e.styles,c=$("#"+t.id);0<c.length&&c.parent().remove();var d=$(".summary-con[for="+t.id+"]");0<d.length&&d.remove();var p="mind_org"==s.structure,u="mind_tree"==s.structure,h=e.util.getMargin.call(e),m=h.childMarginW,g=h.childMarginH,f=t.title.replace(/\n/g,"<br>").replace(/\&lt;br\&gt;/g,"<br>").replace(/\u2029/g,"<br>").replace(/\u2028/g,"<br>").replace(/\x0a/g,"<br>").replace(/\x0d/g,"<br>").replace(/[\x00-\x1f]+/g," "),v="";p?(v="org",g=20):u&&(v="tree",g=26);var y=(c=$("<div class='topic-container "+v+"'><div id='"+t.id+"' class='topic-box summary'><div class='topic'>"+f+"</div></div></div>")).children(".topic-box");if(t.root||t.parent==s.id||null!=t.pos)y.attr("sub",!0),t.pos?(c.css("position","absolute").appendTo(o),c.css({left:t.pos.x,top:t.pos.y}),y.addClass("free")):c.css("position","absolute").prependTo(o),e.line.renderSubLineCon(c,t.id);else{var x="topic-children",b=t.range+"",T=$("#"+t.parent).parent(),C=T.children("."+x),S=0,w=0,k=r.getTopicById(t.parent);w=b.indexOf(",")<0?S=b+"":(S=b.split(",")[0],Number(b.split(",")[1]));var I=k.children.length;I-1<S?S=I-1:S<0&&(S=0),I-1<w?w=I-1:w<0&&(w=0);var L,P,_,M,W=k.children[S],O=k.children[w];0<(E=C.children(".topic-container").eq(S)).length&&E.hasClass("summary-con")&&(_=0<=(P=(L=r.getTopicById(E.attr("for"))).range+"").indexOf(",")?P.split(",")[1]:P,Number(w)>Number(_)||(C=C.children("[for="+L.id+"]").children("div").eq(0))),0==C.length&&(C=$("<div class='"+x+"'></div>"),M=0,p||u?u&&(M=a.childMarginW+8):M=m+24,"left"==i?(C.prependTo(T),C.css("margin-right",M)):(C.appendTo(T),C.css("margin-left",M)));var D="";W.collapsed&&O.collapsed&&(D="left"==i?'style="margin-right:46px;"':'style="margin-left:46px;"');var B=$("<div for='"+t.id+"' class='topic-container summary-con'><div></div><div "+D+"></div></div>");"left"==i&&B.addClass("part_left");var A,H=B.children("div:first"),z=B.children("div:last");if(c.appendTo(z),S-1<0?C.prepend(B):(A=k.children[S],n.getTopicDom(A.id).parent().before(B)),b.indexOf(",")<0){var N=k.children[b];(E=n.getTopicDom(N.id).parent()).appendTo(H)}else for(var E,w=b.split(",")[1],R=S;R<=w;R++){null!=(N=k.children[R])&&(E=n.getTopicDom(N.id).parent()).appendTo(H)}0<B.index()&&B.css("margin-top",g),"left"==i&&c.addClass("part_left")}l.renderTopicImage(t);var F=e.style.getStyle.call(e,t);return e.renderTopicStyle(y,t,F,a.thinner),e.icons.renderTopicIcons(n,t,i),e.remark.renderTopicNote(n,t,i),l.renderTopicLink(n,t,i),e.tags.renderTopicTag(n,t,i),e.task.renderTopicTask(n,t,i),e.renderTopicExpand(t,y,i,F),c},getSummaryPos:function(e){var t=this.util,i=this.model;if(1==e.length){var n=t.getTopicContainer(e[0]),o=n.offset(),r=t.getRealPos.call(this,o.left,o.top);return r.w=n.outerWidth(),r.h=n.outerHeight(),{part:t.getSelectedPart(e[0],i.topic.structure),startY:r.y,endY:r.y+r.h,startX:r.x+r.w}}},getFreeSummarySize:function(e,t,i,n){var o=this.util,r=e.range+"",l=Number(r.split(",")[0]),s=Number(r.split(",")[1]),a=null,c=null,c="left"==i||"left"==e.part?(a=t.leftChildren[l],t.leftChildren[s]):(a=t.children[l],t.children[s]),d=o.getTopicContainer(a.id),p=o.getTopicContainer(c.id);return{maxY:p.position().top/n+p.height(),minY:d.position().top/n,minX:d.position().left/n,maxX:p.position().left/n+p.width()}},getChunkPos:function(e,t,i){var n,o,r=this,l=r.model,s=r.util,a=r.currentRoot||l.topic,c=r.operation.zoomVal/100,d=s.getTopicDom(e.id).parent(),p=(e.range,0),u=0;t.root?(u=(h=r.summary.getFreeSummarySize.call(r,e,t,i,c)).maxY,p=h.minY):u=0==(n=d.parent().prev()).length||0==n.height()?(p=(o=$(".topic-box[id="+e.parent+"]")).position().top/c+4)+o.outerHeight()-4:(p=n.position().top/c+4,n.position().top/c+n.height()-4);var h,m,g,f,v,y,x={x:"left"==i?Math.floor(d.position().left/c)+d.width():Math.floor(d.position().left/c),minY:Math.floor(p),maxY:Math.floor(u)};return"mind_org"==a.structure&&(t.root?(h=r.summary.getFreeSummarySize.call(r,e,t,i,c),x.x=h.minX,x.x1=h.maxX):0<(m=s.getTopicDom(e.id).parent().parent().prev()).length&&(g=m.children().eq(0),f=m.children().eq(m.children().length-1),v=g.position().left/c+4,y=f.position().left/c+f.outerWidth()+8,x.x=v,x.x1=y),x.minY+=10,x.maxY+=10),x},getSummaryChunk:function(e,t){if(0!=t.length){for(var i=e.model,n=e.util,o=e.currentRoot||i.topic,r=(t.length,{}),l=!0,s=0;s<t.length;s++){var a,c=t[s],d=i.getTopicById(c);d.root||d.free||d.summary?l=!1:(w=n.getSelectedPart(c,o.structure),m=(k=i.getTopicById(d.parent)).id,k.root&&(m+="_"+w),a=i.getTopicIndex(d,k,w),null==r[m]&&(r[m]=[]),r[m].push(a),r[m].sort(function(e,t){return t<e?1:-1}))}if(!l)return[];var p=[];for(var u in r){var h=r[u],m=u,g=null;0<u.indexOf("_")&&(m=u.split("_")[0],g=u.split("_")[1]);for(var f=[],s=0;s<h.length;s++){var v,y=h[s];if(s==h.length-1){v=y-1==h[s-1]?(f.push(y),{parent:m,range:f}):{parent:m,range:[y]},null!=g&&(v.part=g),p.push(v);break}y+1==h[s+1]?f.push(y):(f.push(y),p.push({parent:m,range:f}),f=[])}}for(var x=[],b={},s=0;s<p.length;s++)for(var T=p[s],C=(k=i.getTopicById(T.parent)).summaries||[],S=0;S<C.length;S++){var w="";w=(O=C[S]).part?O.part:n.getSelectedPart(O.id,o.structure),b[O.id]=w}for(s=0;s<p.length;s++){for(var k,$,I=p[s],L=I.range,w=I.part||w,P=L[0],_=L[L.length-1],M=P+","+_,W=!0,C=(k=i.getTopicById(I.parent)).summaries||[],S=0;S<C.length;S++){var O,D=(O=C[S]).range+"";if(0<D.indexOf(",")){var B=Number(D.split(",")[0]),A=Number(D.split(",")[1]),g=b[O.id];if(P<B&&B<=_||A<_&&P<=A){if(g==w){W=!1;break}}else if(B<=P&&_<=A&&g==w){W=!1;break}if(D==M&&g==w){W=!1;break}}}W&&(null!=($=i.getTopicById(I.parent))&&$.root&&null==I.part&&(w=n.getSelectedPart(c,o.structure),I.part=w),I.range=M,x.push(n.copy(I)))}return 0==x.length?[]:x}},addSummary:function(e){var t=this,i=t.util,n=t.model,o=t.currentRoot||n.topic,r=t.summary;if(!(0<=e.join(",").indexOf(o.id))){var l=r.getSummaryChunk(t,e),s=l.length;if(0!=s){for(var a=[],c={},d=0;d<s;d++){for(var p=l[d],u=n.getTopicById(p.parent).summaries||[],h=!1,m=0;m<u.length;m++){var g=u[m];if(g.range==p.range&&g.part==p.part){h=!0;break}}h||(p=$.extend(p,{title:"概要",children:[],summary:!0,id:n.newId()}),null!=r.model.currentStyle?p.style=i.copy(r.model.currentStyle):p.style=i.copy(r.model.styles),null!=p.part&&(c[p.id]=p.part),a.push(p))}0!=a.length?r.model.addSummary.call(t,a):$.showTip("当前位置已存在相同的概要",2e3)}else $.showTip("当前位置无法添加概要",2e3)}},updateSummary:function(e,t,i){var n=this,o=n.model,r=n.currentRoot||o.topic,l=n.util,s="mind_org"==r.structure;e=l.copy(e),t=l.copy(t);var a=l.getSelectedPartByPos(e.id),c=$(".svg-summary-con").children("#sum_"+e.id);null!=e.part&&e.summary&&(c=$(".svg-freesums-con").children("#sum_"+e.id));var d,p,u=!1,h=!1;if(null!=e.style&&(null!=e.style.lineType&&(g=o.getTopicById(e.parent),M=a,(W=o.getSubTopic(g)).free&&"left"==M&&(M="right"),d=n.summary.getSummaryD.call(n,e,M,s,g),c.attr("d",d.join(""))),null!=e.style.lineColor&&c.attr("stroke",e.style.lineColor),null!=e.style.lineWidth&&c.attr("stroke-width",e.style.lineWidth),(p=o.getTopicById(e.id)).style=$.extend(p.style,e.style),u=!0),e.range!=t.range){h=!0;var m=n.operation.zoomVal/100,g=o.getTopicById(e.parent),f=e.range+"",v=t.range+"";o.topicList.resetTopicList.call(n),o.getTopicById(e.id).range=f;var y=Number(0<v.indexOf(",")?v.split(",")[0]:v),x=Number(0<v.indexOf(",")?v.split(",")[1]:v),b=Number(0<f.indexOf(",")?f.split(",")[0]:f),T=Number(0<f.indexOf(",")?f.split(",")[1]:f);if(e.parent!=r.id){var C=$(".summary-con[for="+e.id+"]");if(b<y)for(var S=y;b<=S;S--){var w=g.children[S],k=l.getTopicContainer(w.id);C.children().eq(0).prepend(k)}else if(y<b)for(S=y;S<b;S++){var w=g.children[S],I=g.children.length,k=l.getTopicContainer(w.id);C.before(k);var L,P=C.css("margin-top");"0px"!=P&&null!=P||(L=g.children[I-1],k=l.getTopicContainer(L.id),C.css("margin-top",k.css("margin-top")))}else if(x<T)for(S=Number(x)+1;S<=T;S++){w=g.children[S],k=l.getTopicContainer(w.id);C.children().eq(0).append(k)}else{if(!(T<x))return;for(S=x;S>Number(T);S--){w=g.children[S],k=l.getTopicContainer(w.id);C.after(k)}}var _,M,W=o.getSubTopic(g),O=r.id==e.parent,D=0,B=$(".topic-summary-resize");O||(_=l.getTopicContainer(W.id).offset(),M=a,W.free&&"left"==M&&(M="right"),n.line.resetLines.call(n,[W.id],null,M),D=B.parent().width());for(var A=g.children,H=A.length,z={},S=0;S<H;S++){var N,w=A[S],E=l.getTopicContainer(w.id),R=E.height()+1;O?(N=E.position().top/m,z[S]=[N,R+N],D=Math.max(D,E.width())):(V=(F=(E.offset().top-3-_.top)/m)+R,z[S]=[F,V])}var F=z[b][0],V=z[T][1];B.css({top:F,height:V-F}),n.range.resetSubTopics.call(n,a)}else{var j=l.getTopicDom(e.id);n.summary.renderSummaryOp.call(n,e,j)}n.renderFreeSummaries(a)}null==i&&(h||u)&&(e.children=[],t.children=[],M=a,W.free&&"left"==M&&(M="right"),n.messageSource.send.call(n,"updateSummary",{content:e,original:t,part:M}),n.util.selectOne.call(n,e)),(h||u)&&n.connection.resetAllConnectionPos.call(n,r)},getRemovedSums:function(e,t,i,n,o,r,l){if(!$.isEmptyObject(t)){var s=e.util,a=e.model,c=null==t?i.updates:t.updates;for(var d in c)for(var p=c[d],u=0;u<p.length;u++){var h=p[u];if(null!=t)if(h.removed){var m=a.getTopicById(h.parent),g=s.copy(h),f=(s.copy(h),g.range+""),v=0,y=0;f.indexOf(",")<0?v=y=f:(v=f.split(",")[0],y=f.split(",")[1]);var x=null;if(null==l?(g.parent=o,x=n[h.id]):(x=m.children[v].id,o=h.parent),null==x)continue;var b=r||s.getSelectedPart(x,a.topic.structure);a.getTopicById(g.parent).root?g.part=b:(delete g.pos,delete g.part);var T=a.getTopicById(x),C=a.getTopicById(o),S=r||s.getSelectedPart(C.id,a.topic.structure);null!=g.part&&(S=b);var w=a.getTopicIndex(T,C,S),k=Number(y)-Number(v),I=Number(w)+k;g.range=0==k?w+","+w:w+","+I,!C.root&&g.part&&(delete g.part,delete g.pos),null==C.summaries&&(C.summaries=[]);var L,P=s.copy(g);delete P.removed,C.summaries.push(P),a.addTopicToList(P,C),e.summary.renderSummaryDoms(e,P,S),null==l&&(c=i.updates,L=i.original,null==c[C.id]&&(c[C.id]=[]),null==L[C.id]&&(L[C.id]=[]),c[C.id].push(g),L[C.id].push(s.copy(g)))}else{var C=a.getTopicById(h.parent),_=a.getTopicById(h.id);_.range=h.range,a.addTopicToList(_,C)}else null==(C=a.getTopicById(h.parent)).summaries&&(C.summaries=[]),delete(g=s.copy(h)).removed,C.summaries.push(g),null==(c=i.updates)[C.id]&&(c[C.id]=[]),c[C.id].push(h)}}},getUpdatedSummaries:function(y,x,e,t,i,n){var o={},r={},l={},b=this,T=b.util,C=b.model,S=b.model.topic;if(null!=n){for(var s in n){var a=C.getTopicById(s),c=e[s],d=n[s];if(null!=d&&0<d.length)for(var p=0;p<d.length;p++){var u=d[p],h=T.copy(u);if(u.removed)if("delete"==t){for(var m=0;m<a.summaries.length;m++){if((M=a.summaries[m]).id==u.id){h.removed=!0,l[h.id]=!0,a.summaries.splice(m,1),N(h,h,a.id);break}}C.removeTopicFromList(h.id)}else{null==a.summaries&&(a.summaries=[]);var g=T.copy(u);null==c&&(c=T.getSelectedPart(a.id,C.topic.structure)),delete g.removed,a.summaries.push(g),C.addTopicToList(g,a),b.summary.renderSummaryDoms(b,u,c),l[u.id]=!0,N(h,h,a.id)}else for(m=0;m<a.summaries.length;m++){var f=a.summaries[m],v=T.copy(f);f.id==u.id&&(f.range=u.range,C.addTopicToList(f,a),l[f.id]=!0,N(h,v,a.id))}}}return E(l),{updates:o,original:r}}for(var w=[],k=0,I=y.length;k<I;k++){(L=y[k]).summary&&w.push(L.id)}for(k=0,I=y.length;k<I;k++){var L=y[k],P=x[L.id],c=e[L.id],a=C.getTopicById(L.parent);if(!L.summary&&(null!=a&&a.summaries&&0<a.summaries.length))for(var p=0,_=(H=a.summaries).length;p<_;p++){var M=H[p];0<=w.indexOf(M.id)||null!=M.part&&M.part!=c||null!=(W=function(e,t,i){var n=F(e.range+""),o=n.r1,r=n.r2,l=0,s=0;if("delete"==i)if(t<o)s=l=-1;else{if(!(o<=t&&t<=r))return null;s=-1}else if(t<=o)s=l=1;else{if(!(o<t&&t<=r))return null;s=1}return{r1:l,r2:s}}(M,P,t))&&(null==l[M.id]?l[M.id]=W:(A=l[M.id].r1,D=l[M.id].r2,l[M.id].r1=A+W.r1,l[M.id].r2=D+W.r2))}}if(!$.isEmptyObject(l)){c="right";for(var s in l){var W=l[s];if(null!=(M=C.getTopicById(s))){var O=C.getTopicById(M.parent),v=T.copy(M);if("delete"==t){var D,B=F(M.range+""),A=Number(B.r1)+W.r1;if((D=Number(B.r2)+W.r2)<A){v.removed=!0;for(var H,z=(H=O.summaries).length,k=0;k<z;k++){if(H[k].id==M.id){O.summaries.splice(k,1),N(v,v,O.id);break}}C.removeTopicFromList(v.id)}else R(M,W),N(M,v,O.id)}else R(M,W),N(M,v,O.id)}}E(l)}return{updates:o,original:r};function N(e,t,i){null==o[i]&&(o[i]=[]),o[i].push(T.copy(e)),null==r[i]&&(r[i]=[]),r[i].push(T.copy(t))}function E(e){var t=[];for(var i in e){var n=C.getTopicById(i);if(null!=n){var o,r=C.getTopicById(n.parent);if(0!=(o=$(".summary-con[for="+n.id+"]")).length)for(var l=o.children().eq(0),s=o.index(),a=F(n.range+""),c=0,d=y.length;c<d;c++){var p=y[c],u=x[p.id];if(p.parent==r.id){var h=T.getTopicContainer(p.id);if(u<a.r1){if(0<=t.indexOf(p.id))continue;var m=r.children[u-1];null!=m?T.getTopicContainer(m.id).after(h):u+1==a.r1?o.before(h):(m=r.children[u+1],T.getTopicContainer(m.id).before(h));continue}if(u==a.r1){h.prependTo(l),t.push(p.id);continue}if(u>a.r2)continue;var g=u-s;1<=g?l.children().eq(g-1).after(h):h.prependTo(l)}}else{var f=T.getSelectedPart(n.parent,S.structure);b.summary.renderSummaryDoms(b,n,f)}}else{(o=$(".summary-con[for="+i+"]")).remove(),$("path[id=sum_"+i+"]").remove();var v=T.getTopicContainer(i);0<v.length&&v.remove()}}}function R(e,t){var i,n=e.range+"";n.indexOf(",")<0?e.range=parseInt(n)+t.r1:(i=F(n),e.range=parseInt(i.r1)+t.r1+","+(parseInt(i.r2)+t.r2)),C.addTopicToList(e,O)}function F(e){var t=0,i=0;return e.indexOf(",")<0?t=i=e:(t=e.split(",")[0],i=e.split(",")[1]),{r1:t,r2:i}}},addSummaries:function(e,t,i){if(null!=t&&!$.isEmptyObject(t)){var n=e.model,o=e.util,r=t.update,l=r.length;if(0<l)for(var s=0;s<l;s++){var a,c,d,p,u,h,m,g,f,v,y,x=r[s];!x.removed||null!=(a=i[x.id])&&(c=n.getTopicById(a),d=n.getTopicById(x.parent),p=o.getSelectedPart(d.id,n.topic.structure),-1==(u=n.getTopicIndex(c,d,p))&&(u=newIndexs[c.id]),g=m=0,(h=x.range+"").indexOf(",")<0?m=g=h:(m=h.split(",")[0],g=h.split(",")[1]),f=Number(g)-Number(m),v=Number(u)+f,x.range=0==f?u:u+","+v,null==d.summaries&&(d.summaries=[]),delete(y=o.copy(x)).removed,d.summaries.push(y),n.addTopicToList(y,d),e.summary.renderSummaryDoms(e,y,p))}}},renderSummaryOp:function(e,t,i){var n=this;if(e.summary){var o=n.summary,r=n.model,l=n.util;if("mind_org"==n.model.topic.structure)return;var s=n.operation,a=s.zoomVal/100;$(".summary-dot").hide(),0==t.find(".summary-dot").length&&t.append('<div class="summary-dot"><span class="mind-icons">&#xe663;</span></div>'),t.find(".summary-dot").show();var c,d=$("#"+e.id).parent().parent().prev(),p=0,u=0,h=0;if(0==d.length){for(var m=e.range+"",g=Number(0<m.indexOf(",")?m.split(",")[0]:m),f=Number(0<m.indexOf(",")?m.split(",")[1]:m),v=r.getTopicById(e.parent),y="left"==e.part?v.leftChildren||[]:v.children,x=(y.length,y[g],y[f],g);x<=f;x++){var b,T=y[x];null!=T&&(b=l.getTopicContainer(T.id),x==g&&(c=b.position().top/a),x==f&&(h=(h=b.position().top/a+b.height())-c-3),p="left"!=e.part||0==p?b.position().left:Math.min(b.position().left,p),u=Math.max(u,b.outerWidth()))}p=p/a-1,u-=3,d=n.designer}else p=d.position().left/a-3,c=d.position().top/a-3,u=d.outerWidth()+6,h=d.outerHeight();var C,S=n.summary.model.styles.lineColor;e.style&&e.style.lineColor&&(S=e.style.lineColor),C={x:p,y:c,w:u,h:h},$(".topic-summary-resize").remove(),(s=$('<div class="topic-summary-resize"><span><i class="mind-icons">&#xe76e;</i></span><span><i class="mind-icons">&#xe76e;</i></span></div>').appendTo(d)).css({left:C.x,top:C.y,width:C.w,height:C.h,"border-color":S}),s.find("span").css("background",S),o.resizeEvent(n,e)}else $(".topic-summary-resize").remove()},getSummaryD:function(e,t,i,n){var o=this.summary,r=e.pos&&null!=e.pos.x?e.pos:o.getChunkPos.call(this,e,n,t),l=[],s=null==e.style?null:e.style.lineType;null==s&&(s="curve_complex");var a=Math.floor((r.minY+r.maxY)/2),c=Math.floor(r.x-22),d=Math.floor(r.x-12),p=Math.floor(r.x-2);if(i){var u=Math.floor(r.x),h=Math.floor(r.x1),m=Math.floor(r.maxY+10),g=m+20,f=Math.floor((r.x+r.x1)/2),v=e.range+"";""!=v&&(v.split(",")[1]!=n.children.length-1||n.root||(h-=10,f=Math.floor((r.x+h)/2))),n.root&&(u=Math.floor(r.x2),f=Math.floor((r.x2+r.x1)/2)),l.push(" M "+u+" "+m),l.push(" L "+u+" "+(m+10)),l.push(" L "+h+" "+(m+10)),l.push(" L "+h+" "+m),l.push(" M "+f+" "+(m+10)),l.push(" L "+f+" "+g)}else switch(s){case"straight":var y=(w=Math.floor(r.x))-18,x=w,b=Math.floor(r.minY),T=Math.floor(r.maxY),C=Math.floor((b+T)/2),S=w-9;"left"==t&&(y=w+18,S=w+9,x=w-9),l.push(" M "+y+" "+b),l.push(" L "+S+" "+C),l.push(" L "+y+" "+T);break;case"curve":x=(y=Math.floor(r.x)-22)-2,b=Math.floor(r.minY),T=Math.floor(r.maxY),C=Math.floor((b+T)/2),S=y+15;"left"==t?(x=(w=Math.floor(r.x))+22,y=w+2,S=w+6,l.push(" M "+x+" "+b),l.push(" Q "+(S-10)+" "+C+" "+x+" "+T),l.push(" M "+(S+3)+" "+C),l.push(" L "+(S-6)+" "+C)):(l.push(" M "+y+" "+b),l.push(" Q "+(S+10)+" "+C+" "+y+" "+T),l.push(" M "+(S-3)+" "+C),l.push(" L "+(S+10)+" "+C));break;case"broken":"left"==t&&(c=Math.floor(r.x+22),d=Math.floor(r.x+12),p=Math.floor(r.x+2)),l.push(" M "+c+" "+Math.floor(r.minY)),l.push(" L "+d+" "+Math.floor(r.minY)),l.push(" L "+d+" "+Math.floor(r.maxY)),l.push(" L "+c+" "+Math.floor(r.maxY)),l.push(" M "+d+" "+a),l.push(" L "+p+" "+a);break;case"curve_complex":var w,y=(w=Math.floor(r.x))-18,x=w,b=Math.floor(r.minY),T=Math.floor(r.maxY),C=Math.floor((b+T)/2),S=w-9,k=17,$=5,I=4;Math.abs(T-b)<50&&(k=12,$=2,I=1),"left"==t?(x=(y=w)+18,S=w+9,l.push(" M "+x+" "+b),l.push(" C "+(x-k)+" "+(b+I)+" "+(S+k)+" "+(C-$)+" "+(S-$)+" "+C),l.push(" M "+x+" "+T),l.push(" C "+(x-k)+" "+(T-I)+" "+(S+k)+" "+(C+$)+" "+(S-$)+" "+C)):(l.push(" M "+y+" "+b),l.push(" C "+(y+k)+" "+(b+I)+" "+(S-k)+" "+(C-$)+" "+(S+$)+" "+C),l.push(" M "+y+" "+T),l.push(" C "+(y+k)+" "+(T-I)+" "+(S-k)+" "+(C+$)+" "+(S+$)+" "+C))}return l},renderFreeSummariesShape:function(e,t,i){for(var n=this,o=this.summary,r=$(".svg-freesums-con"),l=n.util.copy(o.model.styles),s=0;s<e.length;s++){var a=e[s],c=(a.pos,document.getElementById("sum_"+a.id));null==c&&((c=document.createElementNS("http://www.w3.org/2000/svg","path")).setAttribute("id","sum_"+a.id),r[0].appendChild(c),c=document.getElementById("sum_"+a.id));var d,p=a.part;null!=a.style?(c.setAttributeNS(null,"fill","none"),c.setAttributeNS(null,"stroke",a.style.lineColor||l.lineColor),c.setAttributeNS(null,"stroke-width",a.style.lineWidth||l.lineWidth),d=n.summary.getSummaryD.call(n,a,p,t,i)):(d=n.summary.getSummaryD.call(n,a,p,t,i),c.setAttributeNS(null,"stroke",l.lineColor),c.setAttributeNS(null,"fill","none"),c.setAttributeNS(null,"stroke-width",l.lineWidth)),c.setAttributeNS(null,"d",d.join("")),c.setAttributeNS(null,"stroke-linecap","round")}},renderSummarieShape:function(e,t,i){var n=this,o=n.model,r=n.util,l=o.topic.margin,s=null;l&&(s=l.childMarginH);null===s&&n.styles.childMarginH;var a="mind_org"==n.model.topic.structure,c=n.summary;null==i&&(i=o.getTopicById(e.parent));var d,p=o.getSubTopic(e),u=r.getTopicDom(p.id).parent().find(".svg-summary-con")[0];null!=document.getElementById("sum_"+e.id)&&(d=document.getElementById("sum_"+e.id)).parentNode.removeChild(d),(m=document.createElementNS("http://www.w3.org/2000/svg","path")).setAttribute("id","sum_"+e.id),u.appendChild(m);var h,m=document.getElementById("sum_"+e.id),g=t?t:"right";null!=e.style?(m.setAttributeNS(null,"fill","none"),m.setAttributeNS(null,"stroke",e.style.lineColor||c.model.styles.lineColor),m.setAttributeNS(null,"stroke-width",e.style.lineWidth||c.model.styles.lineWidth),h=n.summary.getSummaryD.call(n,e,g,a,i)):(h=n.summary.getSummaryD.call(n,e,g,a,i),m.setAttributeNS(null,"stroke",c.model.styles.lineColor),m.setAttributeNS(null,"fill","none"),m.setAttributeNS(null,"stroke-width",c.model.styles.lineWidth)),m.setAttributeNS(null,"d",h.join("")),m.setAttributeNS(null,"stroke-linecap","round")},resizeEvent:function(I,L){var P=I.model,_=I.util,M=L.parent,W=I.currentRoot||P.topic,O=I.operation.zoomVal/100;$(".topic-summary-resize").children("span").off().on("mousedown.summary",function(e){for(var t=$(this),c=t.index(),d=t.parent(),i=P.getParentTopic(M),n="left"==L.part?i.leftChildren||[]:i.children,p=n.length,u={},h={},m=-1,g=-1,o=P.getSubTopic(i),r=W.id==L.parent,l=_.getTopicContainer(o.id).offset().top,f=-1,v=-1,s=0;s<p;s++){var a,y,x,b,T,C,S,w=n[s];w.free||(y=(a=_.getTopicContainer(w.id)).height()+1,x=a.offset().top,b=a.offset().top+y,u[s]=[x,b],r?(T=a.position().top/O,h[s]=[T,T+y]):(S=(C=(x-l)/O)+y,h[s]=[C,S]))}var k=L.range+"",v=k.indexOf(",")<0?f=k:(f=k.split(",")[0],k.split(",")[1]),f=Number(f);v=Number(v),m=f,g=v,0==c?I.designer.addClass("nresize"):I.designer.addClass("sresize"),$(document).on("mousemove.summary",function(e){if(1<p){var t,i,n=e.pageY,o=-1;for(var r in u){var l=u[r],s=l[0],a=l[1];if(n<=a&&s<=n){o=r;break}}0<=o&&(0==c&&m!=o?m=o:1==c&&g!=o&&(g=o),v<m&&(m=v),g<f&&(g=f),t=h[m][0],i=h[g][1],d.css({top:t,height:i-t-4}))}}),$(document).on("mouseup.summary",function(){$(document).off("mousemove.summary"),$(document).off("mouseup.summary"),0==c?I.designer.removeClass("nresize"):I.designer.removeClass("sresize");var e=P.getParentTopic(M).summaries||[],t=!0;if(1<e.length)for(var i=0;i<e.length;i++){var n=e[i];if(n.id!=L.id){if(n.part&&L.part&&n.part!=L.part)continue;var o=n.range+"",r=0<o.indexOf(",")?o.split(",")[0]:o,l=0<o.indexOf(",")?o.split(",")[1]:o;if(!(g<r||l<m||r<=m&&g<l||r<m&&g<=l)){t=!1;break}}}if(!t)return $.showTip("当前位置无法修改概要",2e3),void $(".topic-summary-resize").remove();var s=_.copy(L);L.range=m+","+g,I.summary.updateSummary.call(I,L,s)}),e.stopPropagation()})},initEvent:function(c){var d=this,p=d.model,u=d.util,h=d.summary,e=p.getTopicById(c).style,t=$(".mind-summary-menu");t.find(".active").removeClass("active");var i=h.model.styles.lineColor,n=h.model.styles.lineWidth,o=h.model.styles.lineType;null!=e&&(null!=e.lineColor&&(i=e.lineColor),null!=e.lineWidth&&(n=e.lineWidth),null!=e.lineType&&(o=e.lineType)),0<=i.indexOf("rgb")&&(i="#"+u.getHexColor(i).hex),t.find("[alt=color] > [ac="+i+"]").addClass("active"),t.find("[alt=width] > [ac="+n+"]").addClass("active"),t.find("[alt=type] > [ac="+o+"]").addClass("active"),t.find("div[alt]").children().off("click").on("click",function(e){var t=$(this),i=t.parent(),n=t.attr("ac"),o=i.attr("alt"),r=p.getTopicById(c),l=u.copy(r),s=r.style||{};if("width"==o){if(s.lineWidth==n)return;r.style=$.extend(s,{lineWidth:n})}else if("color"==o){if(s.lineColor==n)return;r.style=$.extend(s,{lineColor:n})}else if("type"==o){if(s.lineType==n)return;r.style=$.extend(s,{lineType:n})}t.addClass("active").siblings().removeClass("active"),d.summary.updateSummary.call(d,r,l);var a=u.copy(h.model.styles);h.model.currentStyle=$.extend(a,r.style)})},getSummaryByTopic:function(e,d){var p=this,u=null;return function e(t){if(t.root)return;var i=p.model.getTopicById(t.parent),n=p.util.copyArray(i.summaries)||[],o=n.length;if(n&&0<o)for(var r=p.model.getTopicIndex(t,i,d),l=0;l<o;l++){var s=n[l],a=s.range.split(",")[0],c=s.range.split(",")[1];if(s.part){if(s.part==d&&a<=r&&r<=c){u=s;break}}else if(a<=r&&r<=c){u=s;break}}u||e(i)}(e),u}},mindDesigner.prototype.connection={currentLine:null,tempLine:null,loadConnections:function(e){var t=this,i=t.model,n=i.topic,o=n.lines,r=t.connection;if(null!=e&&(o=e),null!=o){var l=!1;for(var s in o){var a,c,d,p=o[s],u=i.getTopicById(p.from),h=i.getTopicById(p.to),m=i.checkParentIsCollapsed(p.from),g=i.checkParentIsCollapsed(p.to);null==u||null==h||m||g||0!=$("#"+u.id).length&&0!=$("#"+h.id).length&&(null!=p.start.x?(null==p.realEnd&&(p.start.x<.1&&1<Math.abs(p.end.x)&&(p.end.x=.5,p.end.y=.5),a=t.util.getTopicRealPos.call(t,p.to),p.realEnd={x:a.x,y:a.y}),r.renderConnectionDom(p,!0),p.label&&"label"!=p.label&&r.renderConnectionText(t,p),null!=p.points&&0==p.points.length&&p.realStart,null==p.pts&&0<p.points.length&&(p.pts=[{x:0,y:0},{x:0,y:0}],(c=t.util.getTopicRealPos.call(t,p.from)).x+=c.w/2,(d=t.util.getTopicRealPos.call(t,p.to)).x+=d.w/2,p.pts[0].x=p.points[0].x-c.x,p.pts[0].y=p.points[0].y-c.y,p.pts[1].x=p.points[1].x-d.x,p.pts[1].y=p.points[1].y-d.y,l=!0,delete p.start.p,delete p.end.p)):delete n.lines[s])}r.resetAllConnectionPos.call(t,n,null,!0),l&&"undefined"!=typeof wpsId&&$.ajax({url:"/mindmap/updatedef",type:"post",data:{id:t.opts.chartId,def:JSON.stringify(n),group_id:group_id,parent_id:parent_id,user_id:userId,file_id:file_id,encrypted_session:encrypted_session,ignore:"def"},success:function(e){},error:function(){}})}},setConnectionD:function(e){var t=e.realStart,i=e.realEnd,n=e.points,o=[];if(null==n||0==n.length)o.push("M "+t.x+" "+t.y),o.push("L "+i.x+" "+i.y);else{for(var r=[],l=0;l<n.length;l++){var s=n[l];r.push({x:s.x,y:s.y})}o.push("M "+t.x+" "+t.y),o.push("C "+r[0].x+" "+r[0].y),o.push(" "+r[1].x+" "+r[1].y),o.push(" "+i.x+" "+i.y)}document.getElementById("line_"+e.id).querySelector(".connection-line").setAttributeNS(null,"d",o.join(""))},createConnection:function(e,t,i){var n=this,o=n.util,r=n.model,l=n.connection,s=n.styles,i=i||o.getSelectedId(),a=$.extend(!0,{styles:s.connectionStyle},{id:r.newId()}),c=o.getRealPos.call(n,e.pageX,e.pageY),d=l.getPointInSVG(n,t,c);return a.start=d,a.realEnd=c,a.realStart={x:t.x,y:t.y},l.renderConnectionDom(a),a},createConnectionByLines:function(e,t){for(var i=e.connection,n=0;n<t.length;n++){var o=t[n];i.renderConnectionDom(o),i.renderArrow(e,o),i.renderConnectionText(e,o),i.renderConnControls(e,o)}},getCanvasPos:function(e,t){var i,n,o=e.x<=t.x?(i=e.x,t.x):(i=t.x,e.x),r=e.y<t.y?(n=e.y,t.y):(n=t.y,e.y);return t.x<e.x&&t.y>e.y?{x:i,y:n-10,w:o-i+10,h:r-n+10,start:{x:o-i,y:10},end:{x:10,y:r-n}}:t.x<e.x&&t.y<e.y?{x:i,y:n,w:o-i+10,h:r-n+10,start:{x:o-i,y:r-n},end:{x:10,y:10}}:t.x>e.x&&t.y<e.y?{x:i-10,y:n,w:o-i+10,h:r-n+10,start:{x:10,y:r-n},end:{x:o-i,y:10}}:{x:i-10,y:n-10,w:o-i+10,h:r-n+10,start:{x:10,y:10},end:{x:o-i,y:r-n}}},getSvgPos:function(e,t,i,n){var o={x:t.x-t.w/2,y:t.y-t.h/2,w:t.w,h:t.h},r={x:e.x-e.w/2,y:e.y-e.h/2,w:e.w,h:e.h},l=r.x<=o.x?r.x:o.x,s=r.y<o.y?r.y:o.y,a=o.x+o.w<r.x+r.w?r.x+r.w:o.x+o.w,c=o.y+o.h<r.y+r.h?r.y+r.h:o.y+o.h;return null!=i&&(i.x<l?l=i.x:i.x>a&&(a=i.x),i.y<s?s=i.y:i.y>c&&(c=i.y),n.x<l?l=n.x:n.x>a&&(a=n.x),n.y<s?s=n.y:n.y>c&&(c=n.y)),{x:l,y:s,w:a-l,h:c-s}},resetConnectionsOnMoving:function(e){var t=this,i=t.util,n=t.connection;for(var o in e){var r,l,s,a,c=e[o];null!=document.getElementById("line_"+c.id)&&((r=i.getTopicRealPos.call(t,c.from)).x+=r.w/2,(l=i.getTopicRealPos.call(t,c.to)).x+=l.w/2,s=n.getPointInSVG(t,r,l),c.start=s,a=n.getPointInSVG(t,l,r),c.end=a,c.realStart={x:r.x-r.w/2+r.w*s.x,y:r.y-r.h/2+r.h*s.y},c.realEnd={x:l.x-l.w/2+l.w*a.x,y:l.y-l.h/2+l.h*a.y},c.angle=i.getAngle(c.realStart,c.realEnd),null!=c.points&&0<c.points.length&&(c.points=[],c.pts=[]),n.setConnectionD(c),n.renderArrow(t,c),n.hideOrShowConnectionText(c,"hide"))}},resetAllConnectionPos:function(e,t,i){var n=this,o=e.lines;n.model;if(null!=n.currentRoot&&(o=n.model.topic.lines),null!=o&&!$.isEmptyObject(o)){null!=t&&(o=t);var r=n.util,l=n.connection;for(var s in o){var a,c,d=o[s];d.canvasPos;if(null!=document.getElementById("line_"+d.id)){try{(a=r.getTopicRealPos.call(n,d.to)).x+=a.w/2,(c=r.getTopicRealPos.call(n,d.from)).x+=c.w/2}catch(e){continue}var p,u=d.points,h={x:c.x-c.w/2+d.start.x*c.w,y:c.y-c.h/2+d.start.y*c.h},m={x:a.x-a.w/2+d.end.x*a.w,y:a.y-a.h/2+d.end.y*a.h};d.realStart=h,d.realEnd=m,null!=u&&0<u.length&&(0==(p=d.pts).length||(u[0]={x:p[0].x+c.x,y:p[0].y+c.y},u[1]={x:p[1].x+a.x,y:p[1].y+a.y}));var g={},g=0==u.length?{x:(m.x+h.x)/2,y:(m.y+h.y)/2}:{x:u[1].x,y:u[1].y},f={x:m.x,y:m.y};d.angle=r.getAngle(g,f),l.setConnectionD(d),l.renderArrow(n,d),l.renderConnectionText(n,d,!1)}}}},renderConnectionDom:function(e,t){var i,n,o="http://www.w3.org/2000/svg",r=document.getElementsByClassName("svg-connection-con")[0],l=document.getElementById("line_"+e.id),s=e.styles;return l?(i=l.querySelector(".connection-line"),n=l.querySelector(".connection-end-arrow")):(l=document.createElementNS(o,"g"),i=document.createElementNS(o,"path"),n=document.createElementNS(o,"path"),l.appendChild(i),l.appendChild(n),r.appendChild(l),i.setAttributeNS(null,"fill","none"),i.setAttributeNS(null,"d",""),i.setAttributeNS(null,"class","connection-line"),n.setAttributeNS(null,"class","connection-end-arrow"),i.setAttributeNS(null,"stroke-linejoin","round"),l.setAttributeNS(null,"id","line_"+e.id),l.setAttributeNS(null,"class","connection-svg")),"dashed"==s.lineType?i.setAttributeNS(null,"stroke-dasharray","10,8"):i.removeAttribute("stroke-dasharray"),3<s.lineWidth?(n.setAttributeNS(null,"stroke-linejoin","round"),n.setAttributeNS(null,"stroke-linecap","round")):(n.removeAttribute("stroke-linejoin"),n.removeAttribute("stroke-linecap")),1!=s.lineArrow?n.setAttributeNS(null,"fill",s.lineColor):n.removeAttribute("fill"),i.setAttributeNS(null,"stroke",s.lineColor),i.setAttributeNS(null,"stroke-width",s.lineWidth),n.setAttributeNS(null,"stroke",s.lineColor),n.setAttributeNS(null,"stroke-width",s.lineWidth),1!=t&&this.setConnectionD(e),l},creating:!1,render:function(e){var a,t,c,d,n,o,p=this,u=p.util,h=(p.model,u.getSelectedId()),m=p.connection,g=(p.styles,p.operation);g.zoomVal;0!=h&&(p.creating||(p.creating=!0,$(".connection-svg").each(function(e,t){console.log(e,t)}),(a=u.getTopicRealPos.call(p,h)).x=a.x+a.w/2,t=$("#"+h),c=m.createConnection.call(p,e,a,h),(d=document.getElementById("line_"+c.id)).querySelector(".connection-line"),p.designer.css("cursor","move"),g.initScrollPos(),t.offset().left,t.outerWidth(),t.offset().top,t.outerHeight(),p.designer.off("mousemove.connection").on("mousemove.connection",function(e){0==$("#mind-tip").length&&$.showTip("点击其他主题，即可设置关联连线",null),g.isScroll(e.pageX,e.pageY),n=e.pageX,o=e.pageY;var t=u.getRealPos.call(p,n,o);c.realEnd=t;var i=m.getPointInSVG(p,a,t);c.start=i,c.realStart={x:a.x-a.w/2+a.w*i.x,y:a.y-a.h/2+a.h*i.y},m.setConnectionD(c)}),p.designer.off("mouseup.connection").on("mouseup.connection",function(e){p.designer.off("mousemove.connection"),p.designer.off("mouseup.connection"),g.stopScroll();var t=$(e.target),i=t.parents();p.creating=!1;for(var n=0;n<i.length;n++){var o=$(i[n]);if(o.hasClass("topic")||o.hasClass("topic-box")){t=o;break}}if(t.hasClass("topic")||t.hasClass("topic-box")){var r=t.attr("id");if(null==r&&(r=t.parent().attr("id")),r==h)return void d.remove();c.from=h,c.to=r;var l=u.getTopicRealPos.call(p,r);l.x+=l.w/2;var s=m.getPointInSVG(p,l,a);c.end=s,c.realEnd={x:l.x-l.w/2+l.w*s.x,y:l.y-l.h/2+l.h*s.y},c.angle=u.getAngle(c.realStart,c.realEnd),c.points=[],m.currentLine=c,m.setConnectionD(c),m.renderArrow(p,c),m.renderConnControls(p,c),m.renderConnectionText(p,c),m.renderConnectionTip(c),m.addConnection(p,u.copy(c))}else d.remove();$.showTip("close"),p.designer.css("cursor","default")})))},renderArrow:function(e,t){var i=document.getElementById("line_"+t.id).querySelector(".connection-end-arrow"),n=t.realEnd,o=t.styles,r=t.angle,l=(o.lineType,o.lineWidth),s=e.util.getArrowPoints(r,n,l),a=[];switch(a.push("M"+n.x+" "+n.y),o.lineArrow){case"1":a.push("L"+s.x1+" "+s.y1),a.push("M"+n.x+" "+n.y),a.push("L"+s.x2+" "+s.y2),a.push("Z");break;case"2":a.push("L"+s.x1+" "+s.y1),a.push("M"+n.x+" "+n.y),a.push("L"+s.x2+" "+s.y2),a.push("L"+s.x1+" "+s.y1),a.push("Z");break;case"3":a=[];break;default:a.push("L"+s.x1+" "+s.y1),a.push("M"+n.x+" "+n.y),a.push("L"+s.x2+" "+s.y2),a.push("Z")}var c=a.join(" ");i.setAttributeNS(null,"d",c)},getSvgPosProperty:function(e,t,i){var n={},o={},r=e.util.getTopicRealPos.call(e,i),l={x:r.x,y:r.y-r.h/2},s=(r.x,r.y+r.h/2),a=r.x+r.w,c=r.y-r.h/2,d=(r.x,r.w,r.y+r.h/2);if(t.x<l.x&&t.y<l.y)n.x=t.x,n.y=t.y,n.w=l.x+r.w-t.x,n.h=l.y+r.h-t.y,o.x=0,o.y=0;else if(t.x<l.x&&t.y>=l.y&&t.y<=s)n.x=t.x,n.y=l.y,n.w=l.x+r.w-t.x,n.h=r.h,o.x=0,o.y=t.y-l.y;else if(t.x<l.x&&t.y>s)n.x=t.x,n.y=l.y,n.w=l.x+r.w-t.x,n.h=t.y-l.y,o.x=0,o.y=t.y-l.y;else if(t.x>=l.x&&t.x<=a&&t.y<l.y)n.x=l.x,n.y=t.y,n.w=r.w,n.h=s-t.y,o.x=t.x-l.x,o.y=0;else if(t.x>=l.x&&t.x<=a&&t.y>s)n.x=l.x,n.y=l.y,n.w=r.w,n.h=t.y-l.y,o.x=t.x-l.x,o.y=t.y-l.y;else if(t.x>a&&t.y<c)n.x=l.x,n.y=t.y,n.w=t.x-l.x,n.h=s-t.y,o.x=n.w,o.y=0;else if(t.x>a&&t.y>=c&&t.y<=d)n.x=l.x,n.y=l.y,n.w=t.x-l.x,n.h=r.h,o.x=n.w,o.y=t.y-c;else{if(!(t.x>a&&t.y>d))return null;n.x=l.x,n.y=l.y,n.w=t.x-l.x,n.h=t.y-l.y,o.x=n.w,o.y=n.h}return n.end=o,n},initEvent:function(x){var b=x.util,T=x.connection,C=T.currentLine,e=b.getTopicRealPos.call(x,C.from),t=b.getTopicRealPos.call(x,C.to),S={x:e.x+e.w/2,y:e.y,w:e.w,h:e.h},w={x:t.x+t.w/2,y:t.y,w:t.w,h:t.h},n=(document.getElementById("line_"+C.id),x.designer),o=b.copy(C);n.off("mousedown.points").on("mousedown.points",".connection_point",function(t){var c,d,p,u=$(this),h=t.pageX,m=t.pageY,g=x.operation.zoomVal/100,f=$(".connection_point[tp=from]"),v=$(".connection_point[tp=to]"),y=$(".mind-connection-con[conn="+C.id+"]"),i=y.find(".mind-connection-label");x.plugins.hideConnectionTip(),y.find(".mind-connection-label-icons").hide(),n.off("selectstart").on("selectstart",function(){return!1}),i.attr("contenteditable",!1),x.util.clearSelect(),T.currentLine=C;u.position().left,u.width(),u.position().top,u.height();n.off("mousemove.points").on("mousemove.points",function(e){var t,i,n,o,r=e.pageX,l=e.pageY,s=r-h,a=l-m;(2<Math.abs(s)||2<Math.abs(a))&&(v=$(".connection_point[tp=to]"),f=$(".connection_point[tp=from]"),t=b.getRealPos.call(x,r,l),i=u.attr("tp"),T.resetControls(i,t,C,x),p="from"==i?(d=t,{x:v.position().left/g+v.outerWidth()/2,y:v.position().top/g+v.outerHeight()/2}):(d={x:f.position().left/g+f.outerWidth()/2,y:f.position().top/g+f.outerHeight()/2},t),"from"==i?(n=T.getPointInSVG(x,S,t),C.start=n,C.realStart={x:S.x-S.w/2+S.w*n.x,y:S.y-S.h/2+S.h*n.y},C.points[0]={x:t.x,y:t.y},C.points[1]={x:p.x,y:p.y},c=b.getAngle({x:p.x,y:p.y},w)):(c=b.getAngle(t,w),o=T.getPointInSVG(x,w,t),C.end=o,C.realEnd={x:w.x-w.w/2+w.w*o.x,y:w.y-w.h/2+w.h*o.y},C.points[1]={x:t.x,y:t.y},C.points[0]={x:d.x,y:d.y}),C.pts=[],C.pts[0]={x:C.points[0].x-S.x,y:C.points[0].y-S.y},C.pts[1]={x:C.points[1].x-w.x,y:C.points[1].y-w.y},C.angle=c,T.setConnectionD(C),T.renderArrow(x,C),T.renderConnectionTextPos(x,y,C)),e.preventDefault()}),n.off("mouseup.points").on("mouseup.points",function(e){i.attr("contenteditable",!0),T.updateConnection(x,C,o),n.off("mousemove.points"),n.off("mouseup.points"),n.off("selectstart").on("selectstart",function(){return!0}),y.find(".mind-connection-label-icons").show(),t.stopPropagation()}),t.stopPropagation()}),$(".mind-connection-menu").find("div[alt]").children().off("click").on("click",function(e){var t=$(this),i=t.parent(),n=t.attr("ac"),o=i.attr("alt"),r=T.currentLine;if(null!=r){var l=b.copy(r),s=r.styles||{};if("width"==o){if(s.lineWidth==n)return;r.styles=$.extend(s,{lineWidth:n})}else if("color"==o){if(s.lineColor==n)return;r.styles=$.extend(s,{lineColor:n})}else if("type"==o){if(s.lineType==n)return;r.styles=$.extend(s,{lineType:n})}else if("arrow"==o){if(s.lineArrow==n)return;r.styles=$.extend(s,{lineArrow:n})}t.addClass("active").siblings().removeClass("active");var a=b.copy(r);T.updateConnection(x,a,l),T.createConnectionByLines(x,[a])}}),$(".mind-connection-menu").find(".mind-button").off().on("click",function(e){T.currentLine&&T.deleteConnection(x,C),e.stopPropagation()})},setSVGPos:function(e,t,i){var n={},o=1;return e.x<t.x&&e.y<t.y?(n.x=e.x,n.y=e.y,o=3):e.x<=t.x&&e.y>=t.y?(n.x=e.x,n.y=t.y,o=2):t.x<e.x&&t.y>e.y?(n.x=t.x,n.y=e.y,o=4):t.x<=e.x&&t.y<=e.y&&(n.x=t.x,n.y=t.y,o=1),n.w=Math.abs(t.x-e.x),n.h=Math.abs(t.y-e.y),this.setSVGPosByPos(n,i),o},setSVGPosByPos:function(e,t){t.style.cssText="left:"+e.x+"px;top:"+e.y+"px;width:"+e.w+"px;height:"+e.h+"px"},focusConnection:function(e,t){this.currentLine=t,this.renderConnControls(e,t),this.renderConnectionText(e,t),this.renderConnectionTip(t),e.util.clearSelect()},blurConnection:function(t){setTimeout(function(){var e=t.connection;e.clearControls(),$(".mind-connection-con[conn]").each(function(e,t){var i=$.trim($(t).find(".mind-connection-label").html());""!=i&&"label"!=i||$(t).remove()}),e.currentLine=null,e.renderConnectionTip(!1),t.plugins.hideConnectionTip()},10)},renderConnectionText:function(e,t,i){var n=$(".mind-connection-con[conn="+t.id+"]");0==n.length&&null==i&&(n=$("<div conn='"+t.id+"' class='mind-connection-con'><div class='mind-connection-label' spellcheck='false' contenteditable='true'>label</div><span class='mind-icons mind-connection-label-icons'>&#xe663;</span></div>"),e.designer.append(n));var o=n.children(".mind-connection-label");n.children(".mind-connection-label-icons");t.label&&o.html(t.label),this.renderConnectionTextPos(e,n,t)},hideOrShowConnectionText:function(e,t){var i;"show"!=t?(i=$(".mind-connection-con[conn="+e.id+"]")).length&&i.children(".mind-connection-label").hide():$(".mind-connection-label").show()},renderConnectionTip:function(e){0==e?$(".mind-connection-label-icons").hide():$(".mind-connection-con[conn="+e.id+"]").find(".mind-icons").show()},renderConnectionTextPos:function(e,t,i){var n=this.getConnectionMidPoint(i);t.css({left:n.x,top:n.y,background:i.styles.lineColor,color:i.styles.color})},renderConnControls:function(e,t){var i=e.designer,n=e.connection,o=t.points,r=(t.canvasPos,t.realStart),l=t.realEnd,s={x:(r.x+l.x)/2,y:(r.y+l.y)/2};function a(e,t){$(".connection_line[tp="+e+"]").remove(),$(".connection_point[tp="+e+"]").remove();$("<div tp='"+e+"' class='connection_line'></div>").appendTo(i),$("<div tp='"+e+"' class='connection_point'></div>").appendTo(i);return null==t&&(t={},"from"==e?(t.x=(s.x+r.x)/2,t.y=(s.y+r.y)/2):(t.x=(l.x+s.x)/2,t.y=(l.y+s.y)/2)),t}var c=o[0],d=o[1],p=a("from",c),u=a("to",d);n.resetControls("from",p,t,e),n.resetControls("to",u,t,e),n.currentLine=t,this.initEvent(e)},resetControls:function(e,t,i,n){var o=n.util,r=n.connection,l=(i=i||r.currentLine).styles,s=$(".connection_line[tp="+e+"]"),a=0;$(".connection_point[tp="+e+"]").css({left:t.x,top:t.y,border:"1px solid "+l.lineColor});var c,d,p=i.realStart,u=i.realEnd,h="from"==e?(a=o.calcDistance(p,t),c=(t.x+p.x)/2,d=(t.y+p.y)/2,o.getAngle(p,t)):(c=(t.x+u.x)/2,d=(t.y+u.y)/2,a=o.calcDistance(u,t),o.getAngle(u,t));s.css({left:c,top:d-a/2,height:a,"-webkit-transform":"rotate("+(90+h)+"deg)",transform:"rotate("+(90+h)+"deg)",background:l.lineColor})},clearControls:function(e){$(".connection_point").remove(),$(".connection_line").remove(),$(".mind-connection-label-icons").hide()},getConnectionMidPoint:function(e){var t,i,n=e.points,o=[],r=e.realStart,l=e.realEnd;return o=0==n.length?[{x:t=(l.x+r.x)/2,y:i=(l.y+r.y)/2},{x:t,y:i}]:[{x:n[0].x,y:n[0].y},{x:n[1].x,y:n[1].y}],{x:.125*r.x+.375*o[0].x+.375*o[1].x+.125*l.x,y:.125*r.y+.375*o[0].y+.375*o[1].y+.125*l.y}},getConnectionByPoint:function(e,t){var i=this.model.topic.lines,n=this.connection,o=[];for(var r in i){var l,s=i[r];if(0<(l=n.pointInConnection({x:e,y:t},s,7))){o.push(s);break}}return{inline:l,lines:o}},pointInConnection:function(e,t,i){for(var n=this.getConnectionPoints(t),o=n.length,r={x:e.x-i,y:e.y},l={x:e.x+i,y:e.y},s={x:e.x,y:e.y-i},a={x:e.x,y:e.y+i},c=1;c<o;c++){var d=n[c-1],p=n[c],u=this.checkCross(r,l,d,p);if(u)return c;if(this.checkCross(s,a,d,p))return c}return-1},getConnectionPoints:function(e){var t,i,n=[],o=e.points,r={},l=e.realStart,s=e.realEnd;r=0==o.length?[{x:t=(s.x+l.x)/2,y:i=(s.y+l.y)/2},{x:t,y:i}]:[{x:o[0].x,y:o[0].y},{x:o[1].x,y:o[1].y}];for(var a=0;a<=1;){var c={x:(1-a)*(1-a)*(1-a)*l.x+3*(1-a)*(1-a)*a*r[0].x+3*(1-a)*a*a*r[1].x+a*a*a*s.x,y:(1-a)*(1-a)*(1-a)*l.y+3*(1-a)*(1-a)*a*r[0].y+3*(1-a)*a*a*r[1].y+a*a*a*s.y};n.push(c),a+=.05}return n.push(e.end),n},checkCross:function(e,t,i,n){var o,r,l=!1,s=(t.x-e.x)*(n.y-i.y)-(t.y-e.y)*(n.x-i.x);return 0!=s&&(o=((e.y-i.y)*(n.x-i.x)-(e.x-i.x)*(n.y-i.y))/s,r=((e.y-i.y)*(t.x-e.x)-(e.x-i.x)*(t.y-e.y))/s,0<=o&&o<=1&&0<=r&&r<=1&&(l=!0)),l},getPointInSVG:function(e,t,i){return this.getActivePosOnTopic(t,i)},getActivePosOnTopic:function(e,t){var i,n=e.h/2,o=e.w/2,r=(t.y-e.y)/(t.x-e.x),l=0,s=0,a=1;return t.x>e.x&&t.y<e.y?(l=(o+(i=-n/r))/e.w,s=0,o<i&&(l=1,s=(n+r*o)/e.h),a=2):t.x>=e.x&&t.y>=e.y?(l=(o+(i=n/r))/e.w,s=1,o<i&&(l=1,s=(n+r*o)/e.h),a=3):t.x<=e.x&&t.y>=e.y?(l=(o-(i=-n/r))/e.w,s=1,o<i&&(l=0,s=(n-r*o)/e.h),a=4):t.x<=e.x&&t.y<=e.y&&(l=(o-(i=n/r))/e.w,s=0,o<i&&(l=0,s=(n-r*o)/e.h),a=1),{x:l.toFixed(1),y:s.toFixed(1),index:a}},getConnectionsByTopic:function(e){var t=this.model,i=t.topic.lines;this.util,this.connection;if(null!=i&&!$.isEmptyObject(i)){var n=t.getTopicById(e),o=t.getChildrenIds(n);o.push(e);var r=o.join(","),l=[];for(var s in i){var a=i[s];(0<=r.indexOf(a.from)||0<=r.indexOf(a.to))&&l.push(a)}return l}},addConnection:function(e,t){this.addConnectionMulti(e,[t])},addConnectionMulti:function(e,t,i){for(var n=0;n<t.length;n++){var o=t[n];this.saveConnection(e,o),this.currentLine=o}null==i&&e.messageSource.send.call(e,"addConnection",{content:t})},updateConnection:function(e,t,i,n){this.saveConnection(e,t),null==n&&e.messageSource.send.call(e,"updateConnection",{content:t,original:i})},saveConnection:function(e,t){var i=e.model.topic;null==i.lines&&(i.lines={}),i.lines[t.id]=t},saveConnectionText:function(e,t,i){e.model.topic.lines[t.id]=t,e.messageSource.send.call(e,"updateConnection",{content:t,original:i})},deleteConnection:function(e,t){this.deleteConnectionMulti(e,[t])},deleteConnectionMulti:function(e,t,i){if(0!=t.length){for(var n=e.model,o=n.topic,r=o.lines,l=0,s=t.length;l<s;l++){var a=t[l];$("g[id=line_"+a.id+"]").remove(),$(".mind-connection-con[conn="+a.id+"]").remove(),delete r[a.id]}$.isEmptyObject(r)&&delete o.lines,this.clearControls(),n.topicList.resetTopicList.call(e),(this.currentLine=null)==i&&e.messageSource.send.call(e,"deleteConnection",{content:t})}},deleteConnectionByTopics:function(e,t){var i=this.model,n=i.topic,o=this.connection,r=n.lines;if(0<e.length&&null!=r){var l=[];if(0==t){for(var s=0,a=e.length;s<a;s++){var c=e[s],d=i.getChildrenIdsWithoutSelf(c).join(",");$.each(r,function(e,t){(0<=d.indexOf(t.from)||0<=d.indexOf(t.to))&&l.push(t)})}o.hideConnectionMulti(this,l)}else{for(s=0,a=e.length;s<a;s++){c=e[s],d=i.getChildrenIds(c).join(",");$.each(r,function(e,t){(0<=d.indexOf(t.from)||0<=d.indexOf(t.to))&&l.push(t)})}o.deleteConnectionMulti(this,l)}}},hideConnectionMulti:function(e,t){if(0!=t.length){e.model.topic.lines;for(var i=0,n=t.length;i<n;i++){var o=t[i];$("g[id=line_"+o.id+"]").remove(),$(".mind-connection-con[conn="+o.id+"]").remove()}this.clearControls()}},showConnectionMulti:function(e,t){var i=[],n=e.model,o=n.topic.lines;if(null!=o){for(var r=0,l=t.length;r<l;r++){var s=t[r],a=n.getChildrenIdsWithoutSelf(s).join(",");$.each(o,function(e,t){(0<=a.indexOf(t.from)||0<=a.indexOf(t.to))&&i.push(t)})}this.loadConnections.call(e,i)}}},mindDesigner.prototype.virtualTopic={setMovingRelated:function(e,t,i){$(".topic-box").append("<div class='topic-insert before'></div><div class='topic-insert after'></div><div class='topic-insert in'></div></div>");var n=$("#"+e.id),o=n.siblings(".topic-children"),r=n.siblings(".topic-children-summary"),l=n.parent(),s=mind.currentRoot||mind.model.topic;if($(".topic-box[id="+s.id+"]").find(".topic-insert:not(.in)").remove(),null!=i&&0<i.length)for(var a=0;a<i.length;a++){var c=i[a],d=$("#"+c.id).parent();d.addClass("topic-moving-related"),d.find(".topic-insert").remove()}else l.addClass("topic-moving-related");if(n.find(".topic-insert").remove(),o.find(".topic-insert").remove(),r.find(".topic-insert").remove(),$(".topic-box.free").children(".topic-insert:not(.in)").remove(),$(".topic-box.summary").children(".topic-insert:not(.in)").remove(),null!=t){for(var p=0,u=t.children.concat(t.summaries||[]),a=0,h=u.length;a<h;a++){if((c=u[a]).id==e.id){p=a;break}}var m=u[p-1],g=u[p+1];null!=m&&$(".topic-box[id="+m.id+"]").children(".topic-insert.after").remove(),null!=g&&$(".topic-box[id="+g.id+"]").children(".topic-insert.before").remove()}},removeShape:function(){var e=document.getElementById("mind-svg-insert-temp");null!=e&&$(e).remove()},renderShape:function(e,t,i,n){this.removeShape();var o="http://www.w3.org/2000/svg",r=document.createElementNS(o,"svg");document.body.appendChild(r),r.setAttributeNS(null,"id","mind-svg-insert-temp");var g=mind.operation.zoomVal/100,l=document.createElementNS(o,"path"),s={ht:32,wt:130,posx:t.x,posy:t.y},a={},a="in"!=t.weizhi?this.setShapeStyle.call(mind,s,t.weizhi,e,i,n):{ht:32,wt:130,posx:"left"==i?t.x-125:t.x,posy:t.y},c="z-index:2;position:fixed;width:"+(s=$.extend(!0,{},a)).wt+"px;height:"+s.ht+"px;stroke: rgb(80, 194, 139);left:"+s.posx+"px;top:"+s.posy+"px;";if(null!=n.structure&&"mind_org"==n.structure||"mind_tree"==n.structure&&e.parent==n.id){if("in"==t.weizhi)l.setAttributeNS(null,"d","M13 0 L13 50L25 50L25 119L1 119 L1 50L13 50"),c+="height:120px;width:26px;top:"+(t.y+t.h/2+13)+"px;left:"+(t.x-t.w/2-11)+"px";else{var d="",p="",u=s.posx,h=s.posy,m=$("#"+e.id),f=s.ht,v=(y=s.treeCore)-u+" 0";if(p=m.offset().top-h,d=!("after"==t.weizhi&&m.offset().left+m.outerWidth()*g>y)&&(s.wt<=32||m.offset().left<y)?18*g:s.wt-18*g,null==(x=w.call(mind,"org",d,p,v)))return;l.setAttributeNS(null,"d",x)}r.style.cssText=c}else if(null!=n.structure&&"mind_tree"==n.structure){if("in"==t.weizhi)l.setAttributeNS(null,"d","M0 13 L30 13L30 4L32 2L116 2 L118 4L118 22L116 24L32 24L30 22L30 13");else{var y,x,u=s.posx,f=s.ht,p="before"==t.weizhi?f-26*g:f-20*g,v=(y=s.treeCore)-u+" 0",d=10*g;if(null==(x=w.call(mind,"tree",d,p,v)))return;l.setAttributeNS(null,"d",x)}r.style.cssText=c}else if("left"==i){if("in"==t.weizhi)l.setAttributeNS(null,"d","M128 13 L90 13L90 4L88 2L4 2L2 4L2 22L4 24 L88 24L90 22L90 13");else{var h=s.posy,p=14*g,b=s.rootCore,m=$("#"+e.id),T=$("#"+e.parent).offset().left,v=s.wt+" ",C=T-(m.offset().left+m.outerWidth()*g)+5*g,d=s.wt-C;if(t.y-10*g<b&&"before"==t.weizhi||t.y+m.outerHeight()*g<b&&"after"==t.weizhi?v+=3<=(S=Math.abs(h+s.ht-b))?s.ht-S:s.ht:(p=s.ht-16*g,v+=3<=(S=Math.abs(h-b))?s.ht-S:0),null==(x=w.call(mind,i,d,p,v)))return;l.setAttributeNS(null,"d",x)}r.style.cssText=c}else if("right"==i){if("in"==t.weizhi)l.setAttributeNS(null,"d","M0 13 L30 13L30 4L32 2L116 2 L118 4L118 22L116 24L32 24L30 22L30 13");else{var S,h=s.posy,p=14*g,b=s.rootCore,v="0 ",m=$("#"+e.id);if(t.y-10*g<b&&"before"==t.weizhi||t.y+m.outerHeight()*g<b&&"after"==t.weizhi?v+=3<=(S=Math.abs(h+s.ht-b))?s.ht-S:s.ht:(p=s.ht-16*g,v+=3<=(S=Math.abs(h-b))?s.ht-S:"0"),null==(x=w.call(mind,i,s.orgx,p,v)))return;l.setAttributeNS(null,"d",x)}r.style.cssText=c}function w(e,t,i,n){var o=[],r="M"+n,l=g<1?26*g:26,s=g<1?120*g:120,a=g<1?l/2*g:l/2,c=1,d=t,p=i;"right"==e?(o.push({x:d,y:p}),o.push({x:d,y:p-a+c}),o.push({x:d+c,y:p-a}),o.push({x:d+s-c,y:p-a}),o.push({x:d+s,y:p-a+c}),o.push({x:d+s,y:p+a-c}),o.push({x:d+s-c,y:p+a}),o.push({x:d+c,y:p+a}),o.push({x:d,y:p+a-c}),o.push({x:d,y:p})):"left"==e?(o.push({x:d,y:p}),o.push({x:d,y:p-a+c}),o.push({x:d-c,y:p-a}),o.push({x:d-s+c,y:p-a}),o.push({x:d-s,y:p-a+c}),o.push({x:d-s,y:p+a-c}),o.push({x:d-s+c,y:p+a}),o.push({x:d-c,y:p+a}),o.push({x:d,y:p+a-c}),o.push({x:d,y:p})):"tree"==e?(l=g<1?100*g:100,a=g<1?7*g:7,s=18,halfH=g<1?s/2*g:s/2,c=1,o.push({x:d+(g<1?10*g:10),y:p}),o.push({x:d+l,y:p}),o.push({x:d+l+c,y:p+c}),o.push({x:d+l+c,y:p+halfH}),o.push({x:d+l,y:p+halfH+c}),o.push({x:d-a,y:p+halfH+c}),o.push({x:d-a-c,y:p+halfH}),o.push({x:d-a-c,y:p+c}),o.push({x:d-a,y:p}),o.push({x:d+(g<1?10*g:10),y:p})):"org"==e&&(o.push({x:d,y:p}),o.push({x:d+a,y:p}),o.push({x:d+a+c,y:p+c}),o.push({x:d+a+c,y:p+s}),o.push({x:d+a,y:p+s+c}),o.push({x:d-a,y:p+s+c}),o.push({x:d-a-c,y:p+s}),o.push({x:d-a-c,y:p+c}),o.push({x:d-a,y:p}),o.push({x:d,y:p}));for(var u,h,m=0;m<o.length;m++)r+=(u="L",typeof(h=o[m])!=String?u+h.x+" "+h.y:u+h);return r}l.setAttributeNS(null,"stroke","rgb(252, 126, 0)"),l.setAttributeNS(null,"fill-opacity",".4"),l.setAttributeNS(null,"stroke-linecap","round"),l.setAttributeNS(null,"stroke-width",2),l.setAttributeNS(null,"fill","rgb(252, 126, 0)"),r.appendChild(l)},setShapeStyle:function(e,t,i,n,o){var r,l,s,a,c,d=this.operation.zoomVal/100,p=o.structure||"mind",u=$("#"+i.id),h=$("#"+i.parent),m=h.offset(),g=e.posx,f=e.posy,v=u.outerHeight()*d,y=u.outerWidth()*d,x=h.outerHeight()*d,b=h.outerWidth()*d,T=m.top+x/2,C=m.left+b/2,S=36*d,w=3*d,k=128*d,I=g-(m.left+b)+6*d;return e.ht=Math.abs(m.top+x-(void 0+104*d)),"mind_org"==p||"mind_tree"==p&&i.parent==o.id?e.ht=Math.abs(m.top+x-u.offset().top-k):"mind_tree"==p?(r="before"==t?u.offset().top+w:u.offset().top+v+w+20*d,e.ht=Math.abs(m.top+x-r),e.wt=Math.abs(u.offset().left-C)+k):"left"==n?(e.wt=Math.abs(m.left-(g+y))+k,e.posx=m.left-e.wt+w):"right"==n&&(e.wt=Math.abs(e.posx-(m.left+b))+k,e.posx=m.left+b-w),"mind_org"==p||"mind_tree"==p?(e.posy=Math.abs(m.top+x),l=u.offset().left,"mind_org"==p||"mind_tree"==p&&i.parent==o.id?(s="","before"==t&&l<C||l+y<C&&"after"==t?(s="before"==t?Math.abs(C-(l-S)):Math.abs(C-(l+y)),e.posx=C-s):(e.posx=C,(s="before"==t?Math.abs(C-l):Math.abs(C-(l+y+S)))<=S&&(e.posx-=C+S-l)),e.wt=s<S?S:s):e.posx=l):f<T&&"before"==t||f+v<T&&"after"==t?"before"==t?(e.ht=Math.abs(f-m.top)+v+32*d,e.posy=f-32*d,e.posy+e.ht>T&&(e.ht-=e.posy+e.ht-T)):(a=Math.abs(f-m.top-w),e.ht=a<S?S:a,e.posy=f+v+w,0<(c=e.posy-T)&&(e.posy-=c,e.ht+=c)):(e.posy=T,"before"==t?(a=f-T-w,e.ht=a<S?S:a,0<(c=e.posy+e.ht+1-u.offset().top)&&(e.posy-=c)):(0<(c=e.posy+e.ht+1-u.offset().top)&&(e.posy-=c),e.ht=f+v+30*d-T)),e.ht<S&&(e.ht=S),$.extend(!0,{},e,{rootCore:T,treeCore:C,orgx:I})},insertDomList:[],moveTopicDom:[],convasOps:{},initEvent:function(c,d,e,t){var p=this,a=(p.operation,p.container),u=p.virtualTopic,h=p.model,m=p.currentRoot||h.topic,g=p.util,f=p.operation.zoomVal/100;0==u.insertDomList.length&&($(".topic-insert").each(function(e,t){var i=$(t),n=i.parent(),o=i.offset().left/f+a.scrollLeft()/f,r=o+i.outerWidth(),l=i.offset().top/f+a.scrollTop()/f,s=l+i.outerHeight();u.insertDomList.push({parentDom:n,indom:i,minX:o,maxX:r,minY:l,maxY:s})}),u.convasOps={canvasLeft:a.scrollLeft(),canvasTop:a.scrollTop()});for(var i=u.convasOps.canvasLeft/f,n=u.convasOps.canvasTop/f,o=a.scrollLeft()/f,r=a.scrollTop()/f,l=e.x/f+i-(i-o),s=e.y/f+n-(n-r),v=0;v<u.insertDomList.length;v++){var y=u.insertDomList[v],x=y.minX,b=y.maxX,T=y.minY,C=y.maxY;if(x<=l&&l<=b&&T<=s&&s<=C){var S=y.parentDom.attr("id"),w=y.indom;return-1==u.moveTopicDom.indexOf(S)&&u.moveTopicDom.push(S),$(".topic-moving-target").removeClass("topic-moving-target"),void function(e,t,i){var n=(e=(t=e.find(t)).parent()).attr("id");if(!n||n==c.id)return;e.addClass("topic-moving-target");var o=e.offset(),r=h.getTopicById(n),l=g.getSelectedPart(n,m.structure);h.getSubTopic(r).summary&&(l=g.getSelectedPartByPos(n));var s={x:o.left,y:o.top,w:e.outerWidth()*f,h:e.outerHeight()*f,weizhi:"before"};{if(d.id=n,d.pos="before",n==m.id){var a=t.width(),o=t.offset();return i.offsetX<a/2&&null==p.currentRoot?(s={x:o.left,y:o.top+t.height()/2*f-13,w:e.outerWidth()*f,h:e.outerHeight()*f,weizhi:"in"},d.pos="in",u.renderShape(r,s,"left",m),d.rootPos="left"):(s={x:o.left+e.outerWidth()*f,y:o.top+t.height()/2*f-13,w:e.outerWidth()*f,h:e.outerHeight()*f,weizhi:"in"},d.pos="in",u.renderShape(r,s,"right",m),d.rootPos="right")}delete d.rootPos}t.hasClass("in")?(s={x:"left"==l?o.left:o.left+e.outerWidth()*f,y:t.offset().top+t.height()/2*f-13,w:e.outerWidth()*f,h:e.outerHeight()*f,weizhi:"in"},d.pos="in"):t.hasClass("after")&&(s={x:o.left,y:o.top,w:e.outerWidth()*f,h:e.outerHeight()*f,weizhi:"after"},d.pos="after");u.renderShape(r,s,l,m)}(y.parentDom,w,t)}u.moveTopicDom.length&&($(".topic-moving-target").removeClass("topic-moving-target"),u.removeShape(),y.indom.removeClass("selected"),u.moveTopicDom=[],d.id=null)}},offEvent:function(){this.designer.off("mouseenter.dragmove"),this.designer.off("mouseleave.dragmove")}},mindDesigner.prototype.model={newId:function(){return this.newIdS4()+this.newIdS4()+this.newIdS4()},newIdS4:function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},topicDef:{id:"root",root:!0,title:"中心主题",children:[],structure:"mind_right",theme:"theme3"},topic:{id:"root1",root:!0,title:"中心主题",leftChildren:[],children:[],structure:"mind_right",theme:"",background:"#f4f4f4"},clipboard:{type:"copy",list:[]},persistenTopic:{},topicList:{parentTopics:{},data:{},build:function(e){var t=(this.data[e.id]=e).children;if(0<(r=t.length))for(var i=0;i<r;i++){var n=t[i];this.build(n)}var o=e.leftChildren;if(null!=o)for(var i=0,r=o.length;i<r;i++){n=o[i];this.build(n)}var l=e.summaries;if(null!=l)for(i=0,r=l.length;i<r;i++){n=l[i];this.build(n)}},resetTopicList:function(){var e=this.model,t=e.topicList,i=e.topic;t.data={},t.build(i)}},addTopicToList:function(e,t){this.topicList.build(e)},removeTopicFromList:function(e){delete this.topicList.data[e]},groupList:{leftList:[],rightList:[],freeList:[],justPos:"right",justTopic:null,doGroup:function(e,t){this.clearData(),this.leftList=[],this.rightList=[];for(var i=e.children,n=i.length,o=0;o<n;o++){var r=i[o];this.setList(r,t)}},clearData:function(){this.leftList=[],this.rightList=[],this.freeList=[],this.justTopic=null,this.justPos="right"},setList:function(e,t,i,n){var o=this;return e.free?(o.freeList.push(e),void(o.justPos="")):null!=i&&"right"==i?(null!=n?o.rightList.splice(n,0,e):o.rightList.push(e),void(o.justPos="right")):("mind_right"!=t&&"mind_free"!=t&&"mind"!=t&&"mind_org"!=t&&"mind_tree"!=t||(o.rightList.push(e),o.justPos="right"),o.justPos)}},getTopicById:function(e){return this.topicList.data[e]},getSubTopic:function(e){var n,o=this;if(e.root||e.free)return e;return function e(t){var i=o.getTopicById(t.parent);{if(i.root)return void(n=t);e(i)}}(e),n},getTopicByIndex:function(e,t){for(var i=[],n=0,o=t.length;n<o;n++){var r=t[n];r.free||i.push(r)}return i[e]},getTopicIndex:function(e,t,i){if(e.root)return null;var n=t.children;t.root&&"left"==i&&(n=t.leftChildren);for(var o=n.length,r=-1,l=0;l<o;l++){if(n[l].id==e.id){r=l;break}}return r},getNewTopicIndex:function(e,t,i,n){var o=this.groupList,r=o.rightList;o.leftList;return e.root&&"right"==n?r.length:e.root&&"left"==n?(null==e.leftChildren&&(e.leftChildren=[]),e.leftChildren.length):i?e.children.length:this.getTopicIndex(e,t,n)+1},getTopicDomById:function(e){return $(".topic-box[id="+e+"]").parent()},getTopicDomProp:function(e){var t=$(".topic-container[id="+e+"]");return{h:t.outerHeight(),w:t.outerWidth(),x:t.position().left,y:t.position().top}},getNearTopic:function(e,t){var i=this,n=i.model,o="mind_org"==(i.currentRoot||n.topic).structure,r=i.util,l=r.getSelectedId();if(""==l)return null;var s=n.getTopicById(l),a=r.getSelectedPartByPos(l);if("left"==e){if(o)if(1<(m=(g=n.getParentTopic(s.parent)).children).length){for(var c=0,d=0,p=m.length;d<p;d++){if(m[d].id==s.id){c=d-1;break}}return c<0?g:m[c]}if(s.root)return s.leftChildren[0];if("left"==a)return!s.collapsed&&s.children[0]?s.children[0]:i.summary.getSummaryByTopic.call(i,s,"left")||s;if(s.summary){var c=s.range.split(",")[0],u=n.getParentTopic(s.parent);return"left"==s.part?u.leftChildren[c]:u.children[c]}return n.getParentTopic(s.parent)}if("right"==e){if(o)if(1<(m=(g=n.getParentTopic(s.parent)).children).length){for(var c=0,d=0,p=m.length;d<p;d++){if(m[d].id==s.id){c=d+1;break}}if(c>m.length-1){if(0<s.children.length)return s.children[s.children.length-1];var h=n.getSubTopic(s);return n.getNextTopic(h,a)}return m[c]}if("left"!=a)return!s.collapsed&&s.children[0]?s.children[0]:i.summary.getSummaryByTopic.call(i,s,"right")||s;if(s.summary){c=s.range.split(",")[0],u=n.getParentTopic(s.parent);return"left"==s.part?u.leftChildren[c]:u.children[c]}return n.getParentTopic(s.parent)}if("up"==e){if(s.root)return s.children[0];var m=(g=n.getParentTopic(s.parent)).children;if(g.root&&"left"==a&&(m=g.leftChildren),1<m.length){for(c=0,d=0,p=m.length;d<p;d++){if(m[d].id==s.id){c=d-1;break}}return c<0?g:m[c]}return g}if("down"==e){if(s.root)return(m=s.children)[(p=m.length)-1];var g,m=(g=n.getParentTopic(s.parent)).children;if(o)return!s.collapsed&&s.children[0]?s.children[0]:i.summary.getSummaryByTopic.call(i,s,"right")||s;if(g.root&&"left"==a&&(m=g.leftChildren),1<m.length){for(c=0,d=0,p=m.length;d<p;d++){if(m[d].id==s.id){c=d+1;break}}if(c>m.length-1&&!s.collapsed){if(0<s.children.length)return s.children[s.children.length-1];h=n.getSubTopic(s);return n.getNextTopic(h,a)}return m[c]}return s}},getPrevTopicWithoutFree:function(e,t){var i=0,n=[],o=this.getParentTopic(e.parent),r=o.children;o.root&&"left"==t&&(r=o.leftChildren);for(var l=r.length,s=0;s<l;s++){var a=r[s];if(!a.free){if(n.push(a),a.id==e.id)break;i++}}return n[i-1]},getFreeCountBefore:function(e,t,i){var n=e.children;"left"==i&&(n=e.leftChildren);for(var o=n.length,r=0,l=0;l<o;l++){var s=n[l];if(s.free)r++;else if(s.id==t)break}return r},getPrevTopic:function(e,t){var i=0,n=this.getParentTopic(e.parent),o=n.children;n.root&&"left"==t&&(o=n.leftChildren);for(var r=o.length,l=0;l<r;l++){var s=o[l];if(!s.free&&s.id==e.id){i=l-1;break}}return i<0?this.getNextTopic(e,t):o[i]},getNextTopic:function(e,t){var i=0,n=this.getParentTopic(e.parent),o=n.children;n.root&&"left"==t&&(o=n.leftChildren);for(var r=o.length,l=0;l<r;l++){if(o[l].id==e.id){i=l+1;break}}return r<i?null:o[i]},getPreTopic:function(e){if(e.root)return 0<e.children.length?e.children[0]:e;for(var t=0,i=this.getParentTopic(e.parent),n=i.children,o=n.length,r=0;r<o;r++){if(n[r].id==e.id){t=r-1;break}}return t<0?1<n.length?n[1]:i:n[t]},getFirstTopic:function(e){var n;return function e(t){var i=t.children;n=i[0];0<n.children.length&&e(n)}(e),n},getLastTopic:function(e){var n;return function e(t){var i=t.children;n=0==i.length?t:i[i.length-1];0<n.children.length&&e(n)}(e),n},getLastTopicTop:function(e){var t=this.model.getLastTopic(e),i=this.model.getTopicDomById.call(this,t.id);return i.position().top+i.outerHeight()},getStyleTopics:function(e){var a=[],c=this.util;return function e(t){if(!t)return;if(t.style||t.lineStyle||t.theme&&t.background||t.margin){if(a.push(c.copy(t)),t.summary){if(null!=t.style)for(var i in t.style)"lineWidth"!=i&&"lineColor"!=i&&"lineType"!=i&&delete t.style[i]}else delete t.style;delete t.lineStyle}t.theme&&delete t.background;t.margin&&delete t.margin;var n=t.children,o=[];t.root&&(o=t.leftChildren,n=n.concat(o));if(0<n.length)for(var r=0,l=n.length;r<l;r++){var s=n[r];e(s)}}(e),a},addTopicStyles:function(e,t){this.util;for(var a={},c="",i=0,n=t.length;i<n;i++){var o=t[i];a[o.id]=o,c+=o.id+","}return function e(t){{var i;0<=c.indexOf(t.id)&&((i=a[t.id]).style&&(t.style=i.style),t.theme&&i.background&&(t.background=i.background),i.margin&&(t.margin=i.margin))}var n=t.children,o=[];t.root&&(o=t.leftChildren,n=n.concat(o));if(0<n.length)for(var r=0,l=n.length;r<l;r++){var s=n[r];e(s)}}(e),t},getParentTopic:function(e){return this.getTopicById(e)},getParentTopicById:function(e){var t=this.getTopicById(e);return this.getTopicById(t.parent)},getParentTopicPos:function(e){var t=$(this.getDesigner()).find(".topic-container[id="+e+"]");return{x:t.position().left+t.outerWidth()/2,y:t.positon().top+t.outerHeight()/2}},getParentTopics:function(e,t,n){var i=this.getTopicById(e),o=this,r=[];return t&&r.push(i),function e(t){if(null!=n&&n==t)return;var i=o.getTopicById(t);null!=i&&(r.push(i),i.root||e(i.parent))}(i.parent),r},getChildrenIds:function(e){var r=[];return function e(t){var i=t.children,n=i.length;if(r.push(t.id),null!=i&&0<n)for(var o=0;o<n;o++)e(i[o]);if(null!=t.summaries&&0<t.summaries.length)for(o=0;o<t.summaries.length;o++)e(t.summaries[o])}(e),r},getChildrenIdsWithoutSelf:function(e){var l=[];return function e(t){var i=t.children,n=i.length;if(null!=i&&0<n)for(var o=0;o<n;o++){var r=i[o];l.push(r.id),e(r)}if(null!=t.summaries&&0<t.summaries.length)for(o=0;o<t.summaries.length;o++)r=t.summaries[o],l.push(r.id),e(r)}(e),l},getParentTopicIds:function(e){var n=this,t=n.getParentTopicById(e),o=[];return function e(t){o.push(t.id);if(t.root)return;var i=n.getTopicById(t.parent);{if(i.root)return;e(i)}}(t),o},checkParentIsCollapsed:function(e){var n=this,t=n.getTopicById(e);if(null==t)return!1;t=n.getParentTopicById(e);var o=!1;if(null==t)return o;return function e(t){if(t.root)return;if(t.collapsed)return void(o=!0);var i=n.getTopicById(t.parent);{if(i.root)return;e(i)}}(t),o},resetTopicId:function(e,t){var i=this.newId();e.id=i,e.free?e.parent="root":e.parent=$.trim(t);var n=e.children,o=n.length;if(0<o)for(var r=0;r<o;r++){var l=n[r];this.resetTopicId(l,e.id)}if(null!=e.summaries&&0<e.summaries.length)for(var s=e.summaries,r=0;r<s.length;r++){l=s[r];this.resetTopicId(l,e.id)}},changeTopicExpand:function(e,t,i,n){this.model.topic;null==n&&this.messageSource.send.call(this,"changetopicexpand",{content:e.id,type:t,part:i})},addTopicMulti:function(e,t,i,n,o){if(0!=e.length){for(var r=this,l=r.model,s=r.currentRoot||l.topic,a=(s.structure,s.leftChildren,r.util),c=r.line,d=r.messageSource,p=[],u="",h={},m={},g={},f=[],v=[],y=0,x=e.length;y<x;y++){var b,T,C,S=e[y],w=i[S.id],k=n[S.id],I=(S.id,l.getTopicById(S.parent));null!=I&&(v.indexOf(I)<0&&v.push(I),S.summary?(null==I.summaries&&(I.summaries=[]),null==w&&(w=0),I.summaries.splice(w,0,S)):(b=I.children,I.root&&"left"==k&&(b=I.leftChildren||[]),null==w&&(w=b.length),T=0,I.root&&(T=l.getFreeCountBefore(I,S.id,k),i[S.id]=w+T),b.splice(w+T,0,S)),l.addTopicToList(S,I),(C=l.getSubTopic(S)).free&&C.id!=S.id&&(null==m[C.id]&&(m[C.id]=0),m[C.id]+=a.getTopicContainer(C.id).outerHeight()),u+=k+",",I.root&&l.groupList.setList(S,null,k,w),f.push(a.copy(S)),0<S.children.length||null!=S.summaries&&0<S.summaries.length?(r.renderSubTopic(S,I,k,w),r.renderTopicExpand(I,$("#"+I.id),k)):S.summary?r.renderSubTopic(S,null,k):r.renderTopicDom(S,k,I,w),S.id,p.indexOf(C.id)<0&&p.push(C.id),C.free&&C.id!=S.id&&(null==h[C.id]&&(h[C.id]=0),h[C.id]+=a.getTopicContainer(C.id).outerHeight(),null==g[C.id]&&(g[C.id]=0),g[C.id]=h[C.id]-m[C.id]))}for(var L in g){var P=a.getTopicContainer(L),_=g[L];null!=_&&P.css("top","-="+_/2+"px")}var M=r.summary.getUpdatedSummaries.call(r,e,i,n,null,null,t);0<=u.indexOf("right")&&r.range.resetSubTopics.call(r,"right"),0<=u.indexOf("left")&&r.range.resetSubTopics.call(r,"left"),c.resetLines.call(r,p,null,u),null==o&&d.send.call(r,"create",{content:f,index:i,parts:n,updates:t||M.updates,original:M.original,updateTps:g}),r.renderFreeSummaries(u),r.connection.resetAllConnectionPos.call(r,s),0<v.length&&r.events.push("outline-prebuild",{topics:v,rebuild:"current"})}},updateFreeTopicPos:function(e,t,i,n,o){var r=this,l=r.model,s=r.currentRoot||l.topic,a=r.util,c=r.connection;if(0!=e.length){var d={},p=[];if(null==i){i=[];for(var u,h=0;h<e.length;h++){null==(m=e[h]).free||m.summary||null!=(u=c.getConnectionsByTopic.call(r,m.id))&&0<u.length&&(i=i.concat(u))}}for(var m,g,f,h=0;h<e.length;h++){null==(m=e[h]).free||m.summary||(g=a.getTopicContainer(m.id),f=t[m.id],d[m.id]=a.copy(m.pos),m.pos=f,g.css({left:f.x,top:f.y}),p.push(m.id))}l.topicList.resetTopicList.call(r),0<i.length&&c.resetAllConnectionPos.call(r,s,i,!0),null==o&&r.messageSource.send.call(r,"updateFreeTopic",{content:a.copy(t),original:d,topicIds:p,lines:i,oldLines:n})}},addFreeTopic:function(e,t,i,n){var o=i.util,r=i.model,l=r.topic,s=r.groupList;e.free=!0,e.pos={x:t.x,y:t.y},l.children.push(e),s.doGroup(l,l.structure),r.topicList.resetTopicList.call(i),i.renderTopicDom(e),i.events.push("outline-prebuild",{topics:[l],insertChild:!0}),null==n&&(i.messageSource.send.call(i,"addFreeTopic",{content:e}),o.selectOne.call(i,e))},changeToFreeTopic:function(e,t,i,n){var o,r,l=this,s=l.model,a=s.topic,c=s.groupList,d=l.line,p=l.util,u=(l.styles,[]),h=p.copy(e),m=l.util.getMargin.call(l),g=m.marginW,f=m.marginH,v=p.getTopicContainer(e.id),y=(v.clone(!1),s.getSubTopic(e)),x=p.getSelectedPart(e.id,a.structure),b=0,T=p.getTopicContainerProp(y.id);v.remove(),d.deleteLine(e),y.id==e.id?(b=T.h+f,r=0,"mind_org"!=a.structure&&"mind_tree"!=a.structure||(r=-T.w-g/2),l.range.doChangeSubTopicPos(l,y,-b/2,r,x)):(b=(o=p.getTopicContainerProp(y.id)).h-T.h,r=0,"mind_org"!=a.structure&&"mind_tree"!=a.structure||(r=o.w-T.w),l.range.doChangeSubTopicPos(l,y,b/2,r,x)),u.push(y.id);var C=s.getTopicById(e.parent),S=C.children;C.root&&"left"==x&&(S=C.leftChildren);for(var w=S.length,k=0,$=0;$<w;$++){if(S[$].id==e.id){k=$;break}}S.splice(k,1);var I={};I[e.id]=k;var L={};L[e.id]=x;var P=l.summary.getUpdatedSummaries.call(l,[e],I,L,"delete",null,t);0==S.length&&(p.getTopicDom(C.id).find(".expand_box").remove(),p.getTopicContainer(C.id).find(".topic-children:first").remove()),h.parent=a.id,a.children.push(h),h.free=!0,h.pos={x:i.x,y:i.y},c.doGroup(a,a.structure),s.topicList.resetTopicList.call(l),d.resetLines.call(l,u,null,x),l.renderSubTopic(h);var _=p.getTopicContainer(h.id),M=_.children(".topic-box"),W={},O="mind_org"==a.structure,D="mind_tree"==a.structure,W=O?{x:_.outerWidth()/2,y:M.outerHeight(),h:M.outerHeight()}:D?{x:10,y:M.outerHeight(),h:M.outerHeight()}:{x:M.outerWidth(),y:_.outerHeight()/2-.5,h:M.outerHeight()};l.renderFreeSummaries(x),d.renderLines.call(l,h,W),null==n&&(p.selectOne.call(l,h),l.messageSource.send.call(l,"changeToFreeTopic",{content:h,original:e.parent,index:k,part:x,updates:t||P.updates,updates_origi:P.original})),l.connection.resetAllConnectionPos.call(l,a),l.events.push("outline-prebuild",{topics:[a],rebuild:"current"})},addTopic:function(e,t,i,n){this.addTopicToList(e,t),t.root&&this.groupList.setList(e,null,n),t.children.splice(i,0,e)},unInsertParentTopic:function(e,t,i,n){var o,r,l=this,s=l.model,a=l.currentRoot||s.topic,c=(s.groupList,l.util),d=l.line,p=(l.styles,s.getTopicById(e.id)),u=c.copy(p),h=s.getTopicById(u.parent),m=c.copy(s.getTopicById(t.id)),g=m.children;p.id=m.id,p.children=[],p.children=g,m.icons&&(p.icons=m.icons),m.task&&(p.task=m.task),m.style&&(p.style=m.style),m.link&&(p.link=m.link),m.free&&(p.free=m.free),m.summary&&(p.summary=m.summary),m.summaries&&(p.summaries=m.summaries),m.pos&&(p.pos=m.pos),m.image&&(p.image=m.image),m.collapsed&&(p.collapsed=m.collapsed),p.title=m.title,s.groupList.doGroup(a,a.structure),s.topicList.resetTopicList.call(l),$(".topic-box[id="+u.id+"]").parent(":not(body)").remove(),d.deleteLine(u),h.root?(l.renderSubTopic(p,null,i),l.range.resetSubTopics.call(l,i),d.renderNewLines(l,p,p.id),d.resetLines.call(l,[p.id],null,i)):(o=s.getSubTopic(h),l.renderSubTopic(o,null,i),l.range.resetSubTopics.call(l,i),d.renderNewLines(l,h,o.id),d.resetLines.call(l,[o.id],null,i)),l.renderFreeSummaries(i),null==n&&(c.selectOne.call(l,p),(r=c.copy(m)).children=[],u.children=[],l.messageSource.send.call(l,"unInsertParent",{content:u,original:r,part:i})),l.connection.resetAllConnectionPos.call(l,a)},insertParentTopic:function(e,t,i,n){var o=this,r=o.model,l=o.currentRoot||r.topic,s=(r.groupList,o.util),a=o.line,c=o.styles,d=r.getTopicById(e.parent),p=r.topic.margin,u=null;p&&(u=p.marginH);null==u&&c.marginH;i=i||s.getSelectedPart(e.id,l.structure);var h,m,g,f;d.children;if(d.root&&"left"==i&&d.leftChildren,null==t?(h=r.getTopicById(e.id),m=s.copy(h),e.id=r.newId(),m.parent=e.id,e.children=[],e.children.push(m)):(h=r.getTopicById(t.id),m=s.copy(h),h.id=e.id,h.title=e.title,m.parent=e.id,h.children=[],h.children.push(m),e=h),a.deleteLine(m),e.title="父主题",delete e.pos,delete e.free,delete e.summary,delete e.summaries,delete e.collapsed,delete e.image,delete e.icons,delete e.task,delete e.link,delete e.style,r.groupList.doGroup(l,l.structure),r.topicList.resetTopicList.call(o),d.root)o.renderSubTopic(e,null,i),o.range.resetSubTopics.call(o,i),a.renderNewLines(o,e,e.id),a.resetLines.call(o,[e.id],null,i);else{if(null!=d.summaries&&0<d.summaries.length)for(var v=0;v<d.summaries.length;v++){var y=d.summaries[v];$("div[for="+y.id+"]").remove()}o.range.resetSubTopics.call(o,i),o.operation.showChildren.call(o,d)}o.renderFreeSummaries(i),null==n&&(s.selectOne.call(o,e),g=s.copy(e),(f=s.copy(m)).children=[],g.children=[],o.messageSource.send.call(o,"insertParent",{content:g,original:f,part:i})),o.connection.resetAllConnectionPos.call(o,l),o.events.push("outline-prebuild",{topics:[d],rebuild:"current"})},replaceDef:function(e,t){that.messageSource.send.call(that,"replaceDef",{content:e,original:t})},updateTopicText:function(e,t,i){var n=this,o=n.model,r=n.util,l=n.line,s=n.currentRoot||o.topic,a=(o.groupList,e.title);e.title=t;var c=o.getSubTopic(e),d=r.getSelectedPart(e.id,s.structure),p=r.getTopicContainerProp(c.id),u=r.getTopicDom(e.id),h=u.find(".topic");h.html(t).show();var m=r.getTopicContainerProp(c.id),g=(m.h-p.h)/2,f=m.w-p.w;n.range.doChangeSubTopicPos(n,c,g,f,d,!0),n.resetTopicExpandPos(u,s.structure),null==i&&n.messageSource.send.call(n,"updateTitle",{content:e.id,original:a,update:t,part:d}),e.root?(d="left,right,",l.resetSubLines.call(n,d),n.events.push("savetitle",h.text())):(c.summary&&"left"==c.part&&(d="left"),l.resetLines.call(n,[c.id],null,d)),r.resetSelectDom(),n.events.push("outline-prebuild",{topics:[e],rebuild:"current"}),n.connection.resetAllConnectionPos.call(n,s),n.renderFreeSummaries(d),null==i&&n.util.selectOne.call(n,e)},updateTopicImage:function(l,s,e,a){var t=600,i=0,c=this,d=c.model,p=c.util,u=c.line,h=c.currentRoot||d.topic,m=(d.groupList,c.messageSource),g=p.getTopicDom(l.id),f=d.getSubTopic(l),v=p.getSelectedPart(f.id,h.structure),y=p.getTopicContainerProp(f.id),n=l.image,o=$("#topic_img_"+l.id),r=o.parent(),x=!1;if(e)return n.w==s.image.w&&n.h==s.image.h||b(),x=!0,void T();function b(){i=n.w<=t?(t=n.w,n.h):t*n.h/n.w,r.css({width:t,height:i}),o.css({width:t,height:i})}function T(){var e=p.getTopicContainerProp(f.id),t=(e.h-y.h)/2,i=e.w-y.w;c.range.doChangeSubTopicPos(c,f,t,i,v,!0),c.resetTopicExpandPos(g,h.structure),l.root?(v="left,right,",u.resetSubLines.call(c,v)):u.resetLines.call(c,[f.id],null,v);var n=d.getTopicById(l.id),n=$.extend(!0,n,l),o=p.copy(l).image,r=p.copy(s).image;null==a&&(m.send.call(c,"updateImage",{content:l.id,update:o,original:r,resize:x,part:v}),p.selectOne.call(c,l)),c.connection.resetAllConnectionPos.call(c,h),c.renderFreeSummaries(v)}null==n?0<o.length&&(delete d.getTopicById(l.id).image,r.remove(),T()):(0==o.length?(r=c.operation.renderTopicImage(l)).hide():(o.removeAttr("style"),o.attr("src",n.url)),b(),r.fadeIn(),T()),c.events.push("hideuploading")},updateTopicNode:function(e,t,i,n,o){var r=this,l=r.model,s=r.currentRoot||l.topic,a=r.operation,c=r.util,d=r.line,p=(l.groupList,""),u="",h={},m=[],g=!1;e instanceof Array||(e=[e],t=[t]),e=c.copyArray(e),t=c.copyArray(t);for(var f=0,v=e.length;f<v;f++){var y=c.copy(e[f]),x=c.copy(t[f]),b=l.getSubTopic(y);u+=(p=c.getSelectedPart(b.id,s.structure))+",",h[y.id]=p;var T=c.getTopicContainerProp(b.id),C=l.getTopicById(y.id);"note"==i?(r.remark.renderTopicNote(c,y,p),C.note=y.note):"tag"==i?(r.tags.renderTopicTag(c,y,p),C.tags=y.tags):"link"==i?(a.renderTopicLink(c,y,p),C.link=y.link):"icon"==i?(r.icons.renderTopicIcons(c,y,p),C.icons=y.icons):"style"==i?(r.style.setTopicStyle(r,y,p),C.style=y.style):"line"==i?(r.style.setTopicLineStyle(r,y,p),C.lineStyle=y.lineStyle,null!=y.lineStype&&(delete y.lineStyle.lineType,delete y.lineStyle.underLine),null!=C.lineStyle&&(delete C.lineStyle.lineType,delete C.lineStyle.underLine)):"task"==i?(r.task.renderTopicTask(c,y,p),C.task=y.task):"clearStyle"==i&&(r.style.setTopicStyle(r,y,p),c.getTopicDom(y.id).find(".topic").html(y.title),r.style.setTopicLineStyle(r,y,p));var S=c.getTopicDom(y.id),w=c.getTopicContainerProp(b.id),k=(w.h-T.h)/2,$=w.w-T.w;r.range.doChangeSubTopicPos(r,b,k,$,p,!0),r.resetTopicExpandPos(S,s.structure),b.root||m.push(b.id),y.children=[],x.children=[],y.root&&0==g&&(g=!0)}if(g&&(p="left,right,",d.resetSubLines.call(r,p)),d.resetLines.call(r,m,null,u),r.connection.resetAllConnectionPos.call(r,s),r.events.push("change_expands_tyle"),n&&l.topicList.resetTopicList.call(r),r.renderFreeSummaries(u),null==o){c.clearSelect(),c.select(e,r);for(var I=[],f=0;f<e.length;f++){(C=e[f]).children=[],I.push(C)}r.messageSource.send.call(r,"update",{content:I,original:t,type:i,parts:h})}},_updateTopicPos:function(e,t,i,n,o,r,l,s,a,c){for(var d,p,u=this,h=u.model,m=u.currentRoot||h.topic,g=(h.groupList,u.util),f=u.line,v=(u.styles,u.util.getMargin.call(u)),y=(v.marginW,v.marginH,[]),x="",b=0,T=i.length;b<T;b++){var C,S=i[b],w=h.getParentTopic(S.parent),k=l[S.id],I=s[S.id],L=h.getSubTopic(S);$(".topic-box[id="+S.id+"]").parent(":not(body)").remove(),f.deleteLine(S),1==w.children.length&&((C=g.getTopicDom(w.id)).find(".expand_box").remove(),C.parent().children(".topic-children").remove());var P=w.children;w.root&&"left"==k&&(P=w.leftChildren);for(var _=P.length,M=0;M<_;M++){if(P[M].id==S.id){P.splice(M,1);break}}y.indexOf(L.id)<0&&y.push(L.id);var W,O=e[b];O.free?(O.parent=h.topic.id,h.topic.children.push(O)):(W=t[O.id],(D=h.getTopicById(O.parent)).root&&"left"==I?D.leftChildren.splice(W,0,O):D.children.splice(W,0,O)),x+=k+","}p=u.summary.getUpdatedSummaries.call(u,i,n,l,"delete",null,r),h.groupList.doGroup(m,m.structure),h.topicList.resetTopicList.call(u);for(b=0,T=e.length;b<T;b++){var S=e[b],D=h.getTopicById(S.parent),B=t[S.id];B>=D.children.length&&(B=D.children.length-1);var A=h.getSubTopic(S),k=s[S.id];0<S.children.length||null!=S.summaries&&0<S.summaries.length?(u.renderSubTopic(S,D,k,B),u.renderTopicExpand(D,$("#"+D.id),k)):u.renderTopicDom(S,k,D,B),y.indexOf(A.id)<0&&A.id!=m.id&&y.push(A.id),x+=k+","}if(d=u.summary.getUpdatedSummaries.call(u,e,t,s,null,null,o),u.summary.getRemovedSums(u,null,d,null,null,k),0<=x.indexOf("right")&&u.range.resetSubTopics.call(u,"right"),0<=x.indexOf("left")&&u.range.resetSubTopics.call(u,"left"),u.renderFreeSummaries(x),f.resetLines.call(u,y,null,x),u.connection.resetAllConnectionPos.call(u,m),null==a)if(u.messageSource.send.call(u,"updatePos",{content:e,original:i,newIndex:t,oldIndex:n,oldPart:l,newPart:s,oldSums:g.copy(p),newSums:g.copy(d)}),null!=c&&0<c.length){u.util.clearSelect();for(var H=[],b=0;b<c.length;b++){S=u.model.getTopicById(c[b]);H.push(S)}u.util.select(H,u)}else u.util.selectDirect(e,u);u.events.push("outline-prebuild",{id:"root",rebuild:"current"})},updateTopicPos:function(e,t,i,n,o,r,l){var s,a,c=this,d=c.model,p=c.currentRoot||d.topic,u=(d.groupList,c.util),h=c.line,m=(c.styles,c.util.getMargin.call(c)),g=(m.marginW,m.marginH,"mind_org"==p.structure||"mind_tree"==p.structure),f=[],v=[],y=[],x={},b={},T="",C={},S={},w={},k=d.getTopicById(i.id),I=o||u.getSelectedPart(k.id,p.structure);if(!(k.collapsed&&"in"==i.pos||e.length<=0)){for(var L=0,P=e.length;L<P;L++){var _=e[L],M=d.getTopicById(_.parent),W=u.getSelectedPart(_.id,p.structure),O=d.getTopicIndex(_,M,W);b[_.id]=O,C[_.id]=W}a=k.root?k:d.getParentTopicById(k.id);for(var D={},L=0,B=e.length;L<B;L++){var A=e[L];if(M=(_=d.getTopicById(A.id)).free?p:d.getParentTopic(_.parent),$.isEmptyObject(D)&&null!=M.summaries&&0<M.summaries.length)for(var H=0;H<M.summaries.length;H++){var z=M.summaries[H],N=z.range+"",E=-1,E=N.indexOf(",")<0?N:N.split(",")[0];null!=z.part&&"left"==z.part&&z.parent==p.id?D[z.id]=M.leftChildren[E].id:D[z.id]=M.children[E].id}var R=d.getSubTopic(_),F=u.copy(_),V=u.copy(d.getTopicById(_.id));console.log(F,V),y.push(V);var j,Y,W=C[_.id],K=M.children;M.root&&"left"==W&&(K=M.leftChildren),1!=_.free?(j=d.getSubTopic(V),$(".topic-box[id="+V.id+"]").parent(":not(body)").remove(),h.deleteLine(V),f.push(j.id)):(delete F.free,delete F.pos),1==M.children.length&&((Y=u.getTopicDom(M.id)).find(".expand_box").remove(),Y.parent().children(".topic-children").remove()),"in"==i.pos?F.parent=k.id:F.parent=a.id,delete F.free,delete F.pos,v.push(F),null!=i.rootPos&&(I=i.rootPos),S[F.id]=g?"right":I;for(var X=K.length,H=0;H<X;H++){if(K[H].id==V.id){K.splice(H,1);break}}d.removeTopicFromList(V.id),T+=W+","}null==t&&(w=c.summary.getUpdatedSummaries.call(c,e,b,C,"delete",null,null));var U=[],q=null;"in"==i.pos?q=k.root&&"left"==I?(U="mind_org"!=p.structure&&"mind_tree"!=p.structure?a.leftChildren:a.children,a):null!=i.rootPos?"left"==i.rootPos&&"mind_org"!=p.structure&&"mind_tree"!=p.structure?(a.leftChildren||(a.leftChildren=[]),U=a.leftChildren,I="left",a):("left"!=i.rootPos||"mind_org"!=p.structure&&p.structure,U=k.children,k):(U=k.children,k):"before"!=i.pos&&"after"!=i.pos||(U=a.root&&"left"==I?a.leftChildren:a.children,q=a);X=U.length;if("in"==i.pos)for(L=0,P=v.length;L<P;L++){"right"==S[(G=v[L]).id]&&"left"==I&&g?(U.splice(0,0,G),x[G.id]=0):(U.push(G),x[G.id]=L+X)}else if("after"==i.pos)for(L=0;L<X;L++){if(U[L].id==k.id){for(H=1,P=v.length;H<=P;H++){var G=v[H-1];U.splice(L+H,0,G),x[G.id]=L+H}break}}else if("before"==i.pos)for(L=0;L<X;L++){if(U[L].id==k.id){for(var J=L-1<0?0:L,H=0,P=v.length;H<P;H++){G=v[H];U.splice(J+H,0,G),x[G.id]=J+H}break}}d.groupList.doGroup(p,p.structure),d.topicList.resetTopicList.call(c);for(L=0,P=v.length;L<P;L++){var O=x[(F=v[L]).id],Z=d.getTopicById(F.parent),R=d.getSubTopic(F),Q=S[F.id];0<F.children.length||null!=F.summaries&&0<F.summaries.length?(c.renderSubTopic(F,Z,Q,O),c.renderTopicExpand(Z,$("#"+Z.id),Q)):c.renderTopicDom(F,Q,Z,O),f.indexOf(R.id)<0&&R.id!=p.id&&f.push(R.id),T+=I+","}if(s=c.summary.getUpdatedSummaries.call(c,v,x,S,null,q.id,t),c.summary.getRemovedSums(c,w,s,D,q.id,I),0<=T.indexOf("right")&&c.range.resetSubTopics.call(c,"right"),0<=T.indexOf("left")&&c.range.resetSubTopics.call(c,"left"),c.renderFreeSummaries(T),h.resetLines.call(c,f,null,T),c.connection.resetAllConnectionPos.call(c,p),c.events.push("change_expands_tyle",_),"in"==i.pos||"root"==i.id?i.id:a.id,l||c.messageSource.send.call(c,"updatePos",{content:v,original:y,newIndex:x,oldIndex:b,newPart:S,oldPart:C,selectedIds:r,oldSums:w,newSums:s}),c.events.push("outline-prebuild",{topics:[{id:"root"}]}),null!=r&&0<r.length){c.util.clearSelect();for(var ee=[],L=0;L<r.length;L++){_=c.model.getTopicById(r[L]);ee.push(_)}c.util.select(ee,c)}else c.util.selectDirect(v,c)}},addAndRemove:function(e,t,i,n,o,r){var l=this,s=l.model,a=l.currentRoot||s.topic,c=(s.groupList,l.util),d=l.line,p=(l.styles,l.util.getMargin.call(l)),u=(p.marginW,p.marginH,[]),h=[],m="",g={},f={};for(var v in t)for(var y=t[v],x=0;x<y.length;x++){var b=y[x];u.push(b),$(".topic-box[id="+b.id+"]").parent(":not(body)").remove(),d.deleteLine(b)}0<u.length&&l.connection.deleteConnectionByTopics.call(l,u);for(x=0;x<u.length;x++){var T=u[x],C=-1,S=n[T.id];g[T.id]=S;var w=(I=s.getParentTopic(T.parent)).children;"left"==S&&I.root&&(w=I.leftChildren);for(var k=0;k<w.length;k++){if(w[k].id==T.id){C=k;break}}0<=C&&(w.splice(C,1),f[T.id]=C)}for(x=0;x<e.length;x++){var I,L=c.copy(e[x]),P=o[L.id],S=i[L.id],w=(I=s.getParentTopic(L.parent)).children;"left"==S&&I.root&&(w=I.leftChildren),w.splice(P,0,c.copy(L))}var _=l.summary.getUpdatedSummaries.call(l,u,f,g,"delete",null,null);if(s.topicList.resetTopicList.call(l),s.groupList.doGroup(a,a.structure),0<e.length)for(x=0;x<e.length;x++){var M=e[x],W=(s.getParentTopic(M.parent),s.getSubTopic(M));h.indexOf(W.id)<0&&h.push(W.id);P=o[L.id];m+=(S=i[M.id])+",",l.renderSubTopic(M,null,S,P+x)}l.summary.getRemovedSums(l,_,_,null,null,S,!0),l.range.resetSubTopics.call(l,S),d.resetLines.call(l,h,null,m),l.renderFreeSummaries(m),null==r&&(l.messageSource.send.call(l,"deleteSelfRestore",{removed:e,add:t,addPart:n,removedPart:i,removedIndex:o,addIndex:f}),l.util.selectOne.call(l,M)),l.connection.resetAllConnectionPos.call(l,a)},removeAndAdd:function(e,t,i,n,o){var r=this,l=r.model,s=r.currentRoot||l.topic,a=r.util,c=r.line,d=(r.styles,{}),p=[],u="",h={};0<e.length&&r.connection.deleteConnectionByTopics.call(r,e);for(var m=0;m<e.length;m++){var g=e[m],f=-1,v=l.getParentTopic(g.parent),y=i[g.id];h[g.id]=y;var x=t[g.id];$(".topic-box[id="+g.id+"]").parent(":not(body)").remove(),c.deleteLine(g);var b=v.children;"left"==y&&v.root&&(b=v.leftChildren);for(var T=0;T<b.length;T++){if(b[T].id==g.id){f=T;break}}if(0<=f&&(b.splice(f,1),d[g.id]=f),0<x.length)for(T=0;T<x.length;T++){var C=x[T];C.parent=v.id,b.splice(f+T,0,a.copy(C))}}var S=r.summary.getUpdatedSummaries.call(r,e,d,h,"delete",null,null);if(l.topicList.resetTopicList.call(r),l.groupList.doGroup(s,s.structure),0<x.length)for(m=0;m<x.length;m++){var w=x[m],k=(l.getParentTopic(w.parent),l.getSubTopic(w));p.indexOf(k.id)<0&&p.push(k.id),u+=(y=n[w.id])+",",r.renderSubTopic(w,null,y,f+m)}S.updates=S.original,r.summary.getRemovedSums(r,S,S,null,null,y,!0),r.range.resetSubTopics.call(r,y),c.resetLines.call(r,p,null,u),r.renderFreeSummaries(u),null==o&&(r.messageSource.send.call(r,"deleteSelf",{removed:e,add:t,removedIndex:d,addPart:n,removedPart:i}),r.util.selectOne.call(r,w)),r.connection.resetAllConnectionPos.call(r,s)},removeTopic:function(e,t,i,n){if(0!=e.length){var o=this,r=o.model,l=o.currentRoot||r.topic,s=(r.groupList,o.util),a=o.line,c=(o.styles,o.util.getMargin.call(o)),d=(c.marginW,c.marginH,[]),p={},u={},h="",m=null;o.connection.deleteConnectionByTopics.call(o,e);for(var g=[],f=0,v=e.length;f<v;f++)g.push(e[f].id);var y=s.getAvailableSelected(o,l,e);1==i&&(y=e);for(var x=[],b={},T={},C={},f=(v=y.length)-1;0<=f;f--){var S=y[f];if(null!=S&&!S.root){var w=r.getParentTopic(S.parent);if(null!=w||null!=S.pos){x.push(w);var k=r.getSubTopic(S);k.free&&k.id!=S.id&&(null==T[k.id]&&(T[k.id]=0),T[k.id]+=s.getTopicContainer(k.id).outerHeight());var I,L,P,_,M,W=S.part||s.getSelectedPart(S.id,l.structure);!S.summary||(I=$(".topic-box[id="+S.id+"]").parent().parent().prev()).length&&0<I.children().length&&(0,(L=S.range+"").indexOf(",")<0?0:(L.split(",")[0],L.split(",")[1]),P=I.parent(),I.children().each(function(){var e=$(this);P.before(e)}),$(".topic-summary-resize").remove(),P.remove()),1==w.children.length&&w.id!=l.id?(s.getTopicDom(w.id).find(".expand_box").remove(),$(".topic-box[id="+S.id+"]").parent().parent(":not(body)").remove()):$(".topic-box[id="+S.id+"]").parent(":not(body)").remove(),a.deleteLine(S),k.free&&k.id!=S.id&&(null==b[k.id]&&(b[k.id]=0),b[k.id]+=s.getTopicContainer(k.id).outerHeight(),null==C[k.id]&&(C[k.id]=0),C[k.id]=b[k.id]-T[k.id]),f!=v-1||S.free||null!=n||(m=S.summary?(_=(S.range+"").split(",")[0],w.id==r.topic.id&&"left"==W?w.leftChildren[_]:w.children[_]):null!=(M=r.getPrevTopic(S,W))?M:w);var O=w.children;S.summary?O=w.summaries:w.root&&"left"==W&&(O=w.leftChildren);for(var v=O.length,D=0;D<v;D++){var B=O[D];B.id;if(B.id==S.id){p[S.id]=D,O.splice(D,1);break}}"left"==W&&k.summary&&null==k.part?u[S.id]="right":u[S.id]=W,h+=W+",",S.free||d.indexOf(k.id)<0&&d.push(k.id)}}}for(var A in C){var H=s.getTopicContainer(A),z=C[A];null!=z&&H.css("top","-="+z/2+"px")}var N=o.summary.getUpdatedSummaries.call(o,e,p,u,"delete",null,t);o.model.topicList.resetTopicList.call(o),r.groupList.doGroup(l,l.structure),0<=h.indexOf("right")&&o.range.resetSubTopics.call(o,"right"),0<=h.indexOf("left")&&o.range.resetSubTopics.call(o,"left"),o.renderFreeSummaries(h),a.resetLines.call(o,d,null,h),null==n&&o.messageSource.send.call(o,"delete",{content:y,index:p,parts:u,selectedIds:g,updates:t||N.updates,original:N.original,updateTps:C}),o.connection.resetAllConnectionPos.call(o,l),0<x.length&&o.events.push("outline-prebuild",{topics:x,rebuild:"current"}),null!=m?s.selectOne.call(o,m):s.clearSelect()}},removeAttr:function(e,t){for(var i=0;i<e.length;i++){var n=e[i];n[t]&&delete n[t]}},hideTopics:function(e,t,i){var n=this,o=n.util,r=n.model,l=n.line,s=n.currentRoot||r.topic,a="",c=[],d={},p=[];if(0<e.length){if(t){for(var u=0;u<e.length;u++){var h=e[u];0<(f=r.getTopicById(h)).children.length&&(f.collapsed=!0,c.push(f),a+=(v=o.getSelectedPart(f.id,s.structure))+",",d[h]=v,p.push(h))}var m=c[0];o.getTopicContainer(m.id).children(".topic-children").remove(),l.deleteChildrenLines(m);o.getTopicDom(m.id).children(".expand_box");n.operation.nodeAmount.call(n,f);var g=r.getSubTopic(m)}else for(u=0;u<e.length;u++){var f,v,h=e[u];(f=r.getTopicById(h)).collapsed||0==f.children.length||(a+=(v=o.getSelectedPart(f.id,s.structure))+",",d[h]=v,p.push(h),o.getTopicContainer(f.id).children(".topic-children").remove(),l.deleteChildrenLines(f),f.collapsed=!0,c.push(f),o.getTopicDom(h).children(".expand_box"),n.operation.nodeAmount.call(n,f))}if(0==c.length)return;n.model.topicList.resetTopicList.call(n),0<=a.indexOf("right")&&n.range.resetSubTopics.call(n,"right"),0<=a.indexOf("left")&&n.range.resetSubTopics.call(n,"left"),t?l.resetLines.call(n,[g.id],null,a):l.resetLines.call(n,p,null,a),n.renderFreeSummaries(a),null==i&&n.messageSource.send.call(n,"hideTopics",{ids:p,parts:d,withChildren:t}),n.connection.deleteConnectionByTopics.call(n,c,!1),n.connection.resetAllConnectionPos.call(n,s)}},showTopics:function(e,t,i){var n=this,o=n.util,r=n.model,l=n.line,s=n.currentRoot||r.topic,a="",c=[],d={},p=[],u=[];if(0<e.length){if(t){for(var h=0;h<e.length;h++){var m=e[h];(g=r.getTopicById(m)).collapsed&&(delete g.collapsed,p.push(m),c.push(g))}if(0==c.length)return;(f=c[0]).parent!=s.id&&(f=r.getSubTopic(f)),a+=(v=o.getSelectedPart(f.id,s.structure))+",",d[m]=v;for(h=0;h<c.length;h++){d[c[h].id]=v}u.indexOf(f.id)<0&&u.push(f.id),n.renderSubTopic(f,null,v)}else for(h=0;h<e.length;h++){var g,f,v,m=e[h];(g=r.getTopicById(m)).collapsed&&(f=r.getSubTopic(g),delete g.collapsed,a+=(v=o.getSelectedPart(g.id,s.structure))+",",d[m]=v,p.push(m),c.push(g),u.indexOf(f.id)<0&&u.push(f.id),n.renderSubTopic(f,null,v),o.getTopicDom(m).children(".expand_box").html("&#xe7bb;").removeClass("hide"))}if(0==c.length)return;n.model.topicList.resetTopicList.call(n),0<=a.indexOf("right")&&n.range.resetSubTopics.call(n,"right"),0<=a.indexOf("left")&&n.range.resetSubTopics.call(n,"left"),l.resetLines.call(n,u,null,a),n.renderFreeSummaries(a),null==i&&n.messageSource.send.call(n,"showTopics",{ids:p,parts:d,withChildren:t}),n.connection.resetAllConnectionPos.call(n,s),n.connection.showConnectionMulti(n,c)}},copyToClipBoard:function(){var e,t=this.util,i=this.model,n=t.getSelectedId(),o=i.getTopicById(n);""!=n&&((e=document.createElement("input")).setAttribute("value","__mindmap__topic"+o.title),document.body.appendChild(e),e.select(),document.execCommand("copy",!1),document.body.removeChild(e))},nodePasteListener:null,poPasteType:"node",domPasteListener:{},registerNodePaste:function(e){var i,t,n,o=this,r=o.model,l=r.domPasteListener;e&&0!=e.length&&(i=[],e.forEach(function(e,t){i.push(e.getAttribute("id"))}),t=e[e.length-1],n=t.getAttribute("id"),l[n]&&(t.removeEventListener("paste",l[n]),l[n]=null),l[n]=function(e){r.execPaste.call(o,e,n),"editpaste"!=r.poPasteType&&t.blur(),o.util.isIE()&&"editpaste"==r.poPasteType||e.preventDefault(),e.stopPropagation()},setTimeout(function(){null==document.activeElement.getAttribute("id")&&o.operation.editTopicDomInit.call(o,n),t.addEventListener?t.addEventListener("paste",l[n]):element.attachEvent?t.attachEvent("onpaste",l[n]):t.onpaste=l[n]},100))},execPaste:function(s,a){var e,c=this,d=c.operation,p=c.util,u=c.model.poPasteType;function h(e){"editpaste"!=u?-1==e.indexOf("__mindmap__topic")?c.model.pasteStringToNodes.call(c,e,a):c.model.doPaste.call(c,a):m(e=e.replace("__mindmap__topic",""))}function m(e){e=(e=(e=(e=(e=(e=e.replace(/&/g,"&amp;")).replace(/</g,"&lt;")).replace(/>/g,"&gt;")).replace(/\n/g,"<br>")).replace(/\u2029/g,"<br>").replace(/\u2028/g,"<br>")).replace(/\x0a/g,"<br>").replace(/\x0d/g,"");var t=window.getSelection().getRangeAt(0);document.queryCommandSupported("insertHTML")?document.execCommand("insertHTML",!1,e):t.pasteHTML&&t.pasteHTML(e)}a&&((e=s.clipboardData||window.clipboardData)&&function(e){if(p.isIE()){return null!=(l=e.getData("text"))&&""!=l&&h(l)}for(var t,i=e.items,n=e.types||[],o=0;o<n.length;o++)if("Files"===n[o]){t=i[o];break}{if(t&&"file"===t.kind&&t.type.match(/^image\//i)&&4!=i.length){if(p.testVipState(function(){-1!=tdocVipInfo.indexOf(20)||-1!=tdocVipInfo.indexOf(30)||-1!=tdocVipInfo.indexOf(40)||c.events.push("vip-limit","pasteimg")},"pasteimg"),-1==tdocVipInfo.indexOf(20)&&-1==tdocVipInfo.indexOf(30)&&-1==tdocVipInfo.indexOf(40))return;var r=t.getAsFile();return(new FileReader).readAsDataURL(r),d.uploadImage(r,null,function(e){if("notmember"!=e.result){if(0!=e.ret)return Util.globalTopTip("close"),void Util.globalTopTip("粘贴截图出错了，请稍后再试","top_error",3e3);var t=new Image;t.src=e.data.url,c.events.push("showuploading"),t.onload=function(){d.setTopicImage.call(c,a,e.data.url,t),t.remove()}}else c.events.push("vip-limit","pasteimg")}),s.stopPropagation()}c.util.isPaste=!0;for(var l,o=0;o<n.length;o++)if("text/plain"==n[o]){t=i[o];break}if(p.isChrome()||p.isFirefox())t.getAsString(function(e){"editpaste"!=u?-1==e.indexOf("__mindmap__topic")?c.model.pasteStringToNodes.call(c,e,a):c.model.doPaste.call(c,a):m(e=e.replace("__mindmap__topic",""))});else if(p.isSafari()||p.isIE()){if(null!=(l=e.getData("text/plain"))&&""!=l)return h(l)}s.preventDefault()}}(e),c.util.isPaste=!0)},pasteStringToNodes:function(e,t,i){var n,o,r,l,s=this.util,a=this.model,c=this.currentRoot||a.topic,d=(a.clipboard,a.stringToNodes.call(this,e,t,i));a.copying||"over"!=this.operation.testTopicCount.call(this)&&(a.copying=!0,n={},o={},r=a.getTopicById(t),l=s.getSelectedPart(t,c.structure),d.forEach(function(e,t){n[e.id]=r.children.length+t,o[e.id]=l}),a.addTopicMulti.call(this,d,null,n,o),a.copying=!1,!i&&(0<e.indexOf("<br>")||0<e.indexOf("\n")||-1<e.indexOf("\n")||-1<e.indexOf("\r"))&&1==d.length&&a.switchMultTopicTip.call(this,t,d))},switchMultTopicTip:function(t,i){var n=this,o=n.model,e=i[0].id,r=$("#switch-mult-topic"),l=$("#"+e);n.util.selectOne.call(n,i[0]),0==r.length?r=$('<div id="switch-mult-topic" class="menu" style="position: absolute;display: none;"><div id="splitTopic-btn">分割成节点</div></div>').appendTo(l):r.appendTo(l);var s=l.outerWidth(),a=(s-r.outerWidth())/2;l.offset().left+s>$(document).outerWidth()&&(a=2),r.css({left:a,bottom:"-55px"}).show(),$("#splitTopic-btn").off("mousedown").on("mousedown",function(e){e.stopPropagation(),o.switchMultTopic.call(n,t,i),$("#switch-mult-topic").remove()})},switchMultTopic:function(e,t){var i=this.model,n=this.util,o=this.currentRoot||i.topic,r=this.util.copyArray(t),l=i.stringToNodes.call(this,r[0].title,e,!0),s={},a={},c=i.getTopicById(e),d={},p=n.getSelectedPart(e,o.structure);t.forEach(function(e,t){d[e.id]=p}),l.forEach(function(e,t){s[e.id]=c.children.length+t,a[e.id]=p});var u={};u[r[0].id]=l,i.removeAndAdd.call(this,n.copyArray(t),u,d,a)},stringToNodes:function(e,o,t){var r=this;e=(e=(e=(e=(e=e.replace("__mindmap__topic","")).replace(/\n/g,"<br>")).replace(/\u2029/g,"<br>").replace(/\u2028/g,"<br>")).replace(/\x0a/g,"<br>").replace(/\x0d/g,"")).replace(/[\x0d-\x1f]+/g," ");var i=[];t?i=(e=(e=(e=e.replace(/&amp;/g,"&")).replace(/&lt;/g,"<")).replace(/&gt;/g,">")).split("<br>"):i.push(e);var l=[];return i.forEach(function(e,t){var i=r.model.newId();if(!e)return!0;var n={id:i,children:[],title:e.replace(/&/g,"&amp;").replace(/<br>/g,"\n").replace(/</g,"&lt;").replace(/>/g,"&gt;"),parent:o};l.push(n)}),l},copying:!1,doCopy:function(e){var t=this.util,i=this.model,n=this.currentRoot||i.topic,o=i.clipboard;if(!i.copying){i.copying=!0;var r=t.getAvailableSelectedIds(this,n,e);o.list=[],o.type="copy";for(var l=0;l<r.length;l++){var s,a,c=r[l];c!=n.id&&(s=i.getTopicById(c),a=$.extend(!0,{},s),o.list.push(a))}"undefined"!=typeof chartId&&t.removeOtherDef([chartId]),$(".topic-box.cut_related").removeClass("cut_related"),0<o.list.length&&(i.copyToClipBoard.call(this,e),window.localStorage.setItem("clipboard_mind",JSON.stringify(o))),i.copying=!1}},doCut:function(e){var t=this.util,i=this.model,n=this.currentRoot||i.topic,o=i.clipboard;if(!i.copying){i.copying=!0;var r=t.getAvailableSelectedIds(this,n,e);o.list=[],o.type="cut";for(var l=[],s=0;s<r.length;s++){var a,c,d=r[s];d!=n.id&&(a=i.getTopicById(d),(c=$.extend(!0,{},a)).summary?l.push(c):o.list.push(c),t.getTopicDom(d).parent().find(".topic-box").addClass("cut_related"))}"undefined"!=typeof chartId&&t.removeOtherDef([chartId]),this.util.clearSelect(),0<o.list.length&&(i.copyToClipBoard.call(this,e),window.localStorage.setItem("clipboard_mind",JSON.stringify(o))),0<l.length&&this.summary.model.removeSummary.call(this,l),0<o.list.length&&i.removeTopic.call(this,o.list,null),i.copying=!1}},doPaste:function(e){var t=this.model,i=this.currentRoot||t.topic,n=t.clipboard,o=n.type,r=n.list,l=this.util;if(!t.copying){t.copying=!0;var s,a,c=t.getTopicById(e);if(c.collapsed)t.copying=!1;else if("over"!=this.operation.testTopicCount.call(this)){"cut"==o||(null==(s=window.localStorage.getItem("clipboard_mind"))||0<(a=JSON.parse(s).list).length&&(r=a)),r.reverse();for(var d=l.getSelectedPart(c.id,i.structure),p={},u={},h=[],m=0,g=r.length;m<g;m++){var f=r[m],v=$.extend(!0,{},f);t.resetTopicId(v,e),f.summary?(delete v.summary,delete v.range,delete v.part):v.free&&(delete v.free,delete v.pos,v.parent=e),h.push(v),p[v.id]=c.children.length,u[v.id]=d}t.addTopicMulti.call(this,l.copyArray(h),null,p,u),t.copyingTimer&&clearTimeout(t.copyingTimer),this.plugins.showTopicsLen.call(this),t.copyingTimer=setTimeout(function(){t.copying=!1},300)}else t.copying=!1}}},mindDesigner.prototype.util={selectedIds:[],select:function(e,t){for(var i,n=0;n<e.length;n++){var o,r,l=e[n];null!=l&&((o=this.getTopicDom(l.id)).hasClass("cut_related")||(0<=this.selectedIds.indexOf(l.id)?(r=this.selectedIds.indexOf(l.id),this.selectedIds.splice(r,1),o.removeClass("selected"),o.find(".topic-selected").remove()):(this.selectedIds.push(l.id),this.renderSelectDom(o),o.addClass("selected"))))}t.events.push("changeOpStatus",t),e&&0<e.length&&(t.model.poPasteType="node",i=document.getElementById(e[e.length-1].id),t.model.registerNodePaste.call(t,[i]),t.plugins.showTopicsLen.call(t))},RGB2Hex:function(e){if("#"==e.charAt(0))return e;var t=e.split(/\D+/),i=65536*Number(t[1])+256*Number(t[2])+Number(t[3]);return""+this.toHex(i,6)},toHex:function(e,t){for(var i=e.toString(16);i.length<t;)i="0"+i;return i},selectDirect:function(e,t){this.clearSelect();for(var i=0,n=e.length;i<n;i++){var o=e[i];this.selectedIds.push(o.id);var r=this.getTopicDom(o.id);this.renderSelectDom(r),r.addClass("selected")}t.events.push("changeOpStatus",t),t.plugins.showTopicsLen.call(t)},getTopicsLen:function(){return Object.keys(this.model.topicList.data).length},copy:function(e){return $.extend(!0,{},e)},copyArray:function(e){return $.extend(!0,[],e)},selectOne:function(e){var t=e.id,i=this.util.getTopicDom(t);if(0==i.length){var n=this.model.getTopicById(e.parent);return 0<n.children.length&&(n=n.children[n.children.length-1]),void this.util.selectOne.call(this,n)}i.hasClass("cut_related")||($(".topic-box.selected").removeClass("selected"),$(".topic-selected").remove(),this.util.renderSelectDom(i),i.addClass("selected"),this.util.setSelectedId(t,"clear"),this.operation.editTopicDomInit.call(this,t),this.summary.renderSummaryOp.call(this,e,i,t),this.events.push("changeOpStatus",this),this.events.push("outline-select",[t]),this.events.push("close-mind-topic-box",t),this.model.poPasteType="node",$("#switch-mult-topic").remove(),this.model.registerNodePaste.call(this,[document.getElementById(t)]),this.plugins.showTopicsLen.call(this))},renderSelectDom:function(e){0==e.find(".topic-selected").length&&$('<div class="topic-selected"></div>').appendTo(e),this.resetSelectDom(e)},resetSelectDom:function(e){var t=$(".topic-selected");function i(e){var t=e.parent();null!=t.css("border-width")&&t.css("border-width").replace("px",""),e.css({width:t.outerWidth()+3,height:t.outerHeight()+3})}null!=e&&(t=e.find(".topic-selected")),0!=t.length&&(1<t.length?t.each(function(e){i($(e))}):i(t))},selectById:function(e){var t=this.model.getTopicById(e);this.util.selectOne.call(this,t),this.events.push("setDock",t)},unselect:function(e){e.removeClass("selected"),$(".summary-dot").remove();var t=e.attr("id");this.selectedIds.splice(this.selectedIds.indexOf(t),1)},clearSelect:function(){$(".topic-menu").remove(),$("#textarea_topic_temp").remove(),$(".topic-box.selected").removeClass("selected"),$(".topic-selected").remove(),$(".summary-dot").remove(),$(".topic-summary-resize").remove(),$("#switch-mult-topic").remove(),this.selectedIds=[],mind.plugins.showTopicsLen.call(mind)},getSelectedId:function(){return 0==this.selectedIds.length?"":this.selectedIds[this.selectedIds.length-1]},setSelectedId:function(e,t){"clear"==t&&(this.selectedIds=[]),this.selectedIds.push(e)},removeOtherDef:function(e){null!=e&&e.length},getChildrenCount:function(e,t){for(var i=0,n=null,o=(n="left"==t?(null==e.leftChildren&&(e.leftChildren=[]),e.leftChildren):e.children).length,r=0;r<o;r++){var l=n[r];l.free||l.summary||i++}return i},setBrNode:function(e){var t=getSelection(),i=t.getRangeAt(0),n=document.createElement("br");i.insertNode(n),i.setEndAfter(n),i.collapse(!1),t.removeAllRanges(),t.addRange(i)},setCursorEnd:function(e){var t,i;$.support.msie?(t=document.selection.createRange(),(this.last=t).moveToElementText(e),t.select(),document.selection.empty()):((t=document.createRange()).selectNodeContents(e),t.collapse(!1),(i=window.getSelection()).removeAllRanges(),i.addRange(t))},selectText:function(e){var t,i;document.body.createTextRange?((i=document.body.createTextRange()).moveToElementText(e),i.select()):window.getSelection&&(t=window.getSelection(),(i=document.createRange()).selectNodeContents(e),t.removeAllRanges(),t.addRange(i))},unSelectText:function(e){window.getSelection().removeAllRanges()},parentsIsSelected:function(e){for(var t=this.model,i=this.util.selectedIds,n=!1,o=t.getParentTopicIds(e),r=0,l=o.length;r<l;r++){e=o[r];if(0<=i.indexOf(e)&&e!=t.topic.id){n=!0;break}}return n},getAvailableSelectedIds:function(e,t,i){for(var n=[],o=0,r=i.length;o<r;o++){var l=i[o];l!=t.id&&(this.parentsIsSelected.call(e,l)||n.push(l))}return n},getAvailableSelected:function(e,t,i){for(var n=[],o=[],r=0,l=i.length;r<l;r++){var s=i[r];s.id!=t.id&&(0<=o.indexOf(s.id)||this.parentsIsSelected.call(e,s.id)&&!s.free||(o.push(s.id),n.push(s)))}return n},getTopicContainer:function(e){return $("#"+e).parent()},getTopicContainerProp:function(e,t){var i=$("#"+e).parent(),n=i.position();return 0==i.length?null:{h:i.outerHeight(),w:i.outerWidth(),x:n.left/(t||1),y:n.top/(t||1)}},getSelectedPartByPos:function(e){var t=this.getTopicDom(e);if(0==t.length)return"right";var i=(mind.currentRoot||mind.model.topic).id,n=$("#"+i);return t.offset().left<n.offset().left?"left":"right"},getSelectedPart:function(e,t){if(null!=t&&("mind_org"==t||"mind_tree"==t))return"right";var i=this.getTopicDom(e);if(i.hasClass("free"))return"right";if(0<i.parents(".topic-container").find(".free").length)return"right";var n=(mind.currentRoot||mind.model.topic).id,o=$("#"+n);return i.offset().left<o.offset().left?"left":"right"},getTopicDom:function(e){return $("#"+e)},getTopicDomProp:function(e,t){var i=$("#"+e);if(0==i.length)return null;var n=i.parent(),o=n.position();return{h:n.outerHeight(),w:n.outerWidth(),x:o.left/t,y:o.top/t,dom:n}},getSubTopicDomProp:function(e,t,i){var n=$("#"+e),o=n.parent(),r=o.position();return"mind_org"==t?{x:r.left/i+o.outerWidth()/2,y:r.top/i,w:n.outerWidth(),h:n.outerHeight()}:"mind_tree"==t?{x:r.left/i+n.outerWidth()/2,y:r.top/i,w:n.outerWidth(),h:n.outerHeight()}:{h:o.outerHeight(),w:o.outerWidth(),x:r.left/i,y:r.top/i+o.outerHeight()/2}},getTopicsByRange:function(e,t){for(var i=$(".topic-box"),n=[],o=e.x+e.w,r=e.y+e.h,l=Math.max,s=Math.min,a=0,c=i.length;a<c;a++){var d=$(i[a]),p=d.offset(),u=d.width(),h=d.height(),m=l(p.left/t,e.x),g=l(p.top/t,e.y),f=s((p.left+u)/t,o),v=s((p.top+h)/t,r);m<f&&g<v&&n.push(d.attr("id"))}return n},getTopicLinePos:function(e,t){var i=this.model.topic,n=$(".topic-box[id="+i.id+"]"),o=n.position(),r=n.offset();o.left,r.left,o.top,r.top},getTopicRealPos:function(e,t){var i=this.model,n=(this.container,this.operation.zoomVal/100),o=(this.util,$("#"+e)),r=o.position(),l=r.left,s=r.top;if(o.attr("sub")){var a=(d=o.parent().position()).left,c=d.top;return"mind_org"==t?{x:a+o.outerWidth()/2,y:(c+s)/n,w:o.outerWidth(),h:o.outerHeight()}:{x:(a+l)/n,y:(c+s)/n+o.outerHeight()/2,w:o.outerWidth(),h:o.outerHeight()}}var d,p=i.getTopicById(e),u=i.getSubTopic(p),a=(d=$("#"+u.id).parent().position()).left,c=d.top;return"mind_org"==t?{x:(l+a)/n+o.outerWidth()/2,y:(s+c)/n,w:o.outerWidth(),h:o.outerHeight()}:{x:(l+a)/n,y:(c+s)/n+o.outerHeight()/2,w:o.outerWidth(),h:o.outerHeight()}},getRealPos:function(e,t){var i=this.container,n=this.operation.zoomVal/100,o=i.scrollLeft(),r=i.scrollTop();if(1==n)return{x:o+e,y:r+t};var l=this.designer.offset();return{x:Math.abs(l.left)/n+e/n,y:Math.abs(l.top)/n+t/n}},getChildTopicRelativePos:function(e,t){var i=$(".topic-box[id="+e+"]"),n=i.position(),o=n.left,r=n.top;return{x:o/t,y:Math.floor(r/t+i.outerHeight()/2),w:i.outerWidth(),h:i.outerHeight()}},getTreeChildTopicRelativePos:function(e,t){var i=$(".topic-box[id="+e+"]"),n=i.position();return{x:n.left/t,y:n.top/t+i.outerHeight(),w:i.outerWidth(),h:i.outerHeight()}},getOrgChildTopicRelativePos:function(e,t){var i=$(".topic-box[id="+e+"]"),n=i.position(),o=n.left,r=n.top;return{x:o/t+i.outerWidth()/2,y:r/t,w:i.outerWidth(),h:i.outerHeight()}},getSubTopicRelativePos:function(e,t){var i=$(".topic-box[id="+e+"]"),n=i.parent().outerHeight()/2-.5;return"mind_org"==t?{x:i.parent().outerWidth()/2-.5,y:i.outerHeight(),w:i.outerWidth(),h:i.outerHeight()}:"mind_tree"==t?{x:0,y:i.outerHeight(),w:i.outerWidth(),h:i.outerHeight()}:{x:0,y:n,w:i.outerWidth(),h:i.outerHeight()}},getAngle:function(e,t){var i=Math.atan(Math.abs(t.y-e.y)/Math.abs(t.x-e.x))/Math.PI*180;return e.x<=t.x&&e.y>t.y?i=180-i:e.x<t.x&&e.y<=t.y?i=180+i:e.x>=t.x&&e.y<t.y&&(i=360-i),i},getArrowPoints:function(e,t,i){var n=i<3?10:i<5?15:20,o=360-e+30,r=Math.sin(Math.PI*o/180)*n,l=Math.cos(Math.PI*o/180)*n,s=t.x+l,a=t.y-r,o=360-e-30,r=Math.sin(Math.PI*o/180)*n,l=Math.cos(Math.PI*o/180)*n;return{x1:s,y1:a,x2:t.x+l,y2:t.y-r}},calcDistance:function(e,t){var i=t.x-e.x,n=t.y-e.y;return Math.sqrt(Math.pow(i,2)+Math.pow(n,2))},calcX:function(e,t,i){var n=i.y-t.y,o=i.x-t.x;if(0==o)return null;var r=Math.abs(n/o);return i.x<t.x&&i.y<t.y||i.x>t.x&&i.y>t.y?r=-r:i.x>t.x&&i.y<t.y&&(r=Math.abs(n/o)),e/r},calcY:function(e,t,i){var n=i.y-t.y,o=i.x-t.x;if(0==o)return null;var r=n/o,r=Math.abs(n/o);return(i.x<t.x&&i.y<t.y||i.x>t.x&&i.y>t.y)&&(r=-r),r*e},isUrl:function(e){return!!new RegExp("(http|ftp|https)://[a-z0-9-_]+(.[a-z0-9-_]+)+([a-z0-9-.,@?^=%&;:/~+#]*[a-z0-9-@?^=%&;/~+#])?","i").test(e)},isHexColor:function(e){return/(^[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(e)},htmlEncode:function(e){return 0==e.length?"":e=(e=(e=(e=(e=(e=e.replace(/</g,"&lt;")).replace(/>/g,"&gt;")).replace(/\'/g,"&#39;")).replace(/\"/g,"&quot;")).replace(/\u2029/g,"\n").replace(/\u2028/g,"\n")).replace(/\x0a/g,"\n").replace(/\x0d/g,"")},htmlDecode:function(e){return 0==e.length?"":(e=(e=(e=(e=e.replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&#39;/g,"'")).replace(/&quot;/g,'"'),console.log(e),e)},getHexColor:function(e){var t={};if(e.indexOf("rgba(0")<0){var i=e.substring(4,e.length-1);function n(e){return("0"+parseInt(e).toString(16)).slice(-2)}return t.rgb=i,e=n((e=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/))[1])+n(e[2])+n(e[3]),t.hex=e,t}return null},getRgbFromHex:function(e){if(0<=e.indexOf("rgb"))return e;var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null},getNewDef:function(e,h){e.root&&e.theme;var t,i,n,o=!1,r=!1,u=!1;if(e.structure.indexOf("mind_")<0&&(o=!0),"mind"==e.structure&&(null==e.root||e.classic)){e.leftChildren=[],i=(t=e.children).length-1;for(var l=Math.floor(i/2),s=[],a=l;a<i;a++){var c=t[a];s.push(c)}t.splice(l,i-l),e.leftChildren=e.leftChildren.concat(s),e.structure="mind_free"}if(e.classic&&(0<=(n=e.classic).indexOf("defaultClassic")&&(n="theme3"),delete e.classic,e.theme=n),null==e.root&&(e.root=!0),$.isEmptyObject(e.lines))delete e.lines;else{var d=e.lines;for(var p in d){var m,g=e.lines[p],f=g.start,v=g.end;if((f.p||v.p)&&null!=g.canvasPos){for(a=0;a<g.points.length;a++){if(2e3<g.points[a].x){g.points=[],r=!0;break}}"bottom"==f.p?f={x:.5,y:1}:"top"==f.p?f={x:.5,y:0}:"left"==f.p?f={x:0,y:.5}:"right"==f.p&&(f={x:1,y:.5}),"bottom"==v.p?v={x:.5,y:1}:"top"==v.p?v={x:.5,y:0}:"left"==v.p?v={x:0,y:.5}:"right"==v.p&&(v={x:1,y:.5}),null==f.x&&(f.x=0,f.y=0),null==v.x&&(v.x=0,v.y=0),2e3<f.x&&(f.x=1),2e3<v.x&&(v.x=1),2e3<f.y&&(f.y=1),2e3<v.y&&(v.y=1)}g.canvasPos&&g.start.p&&(m=g.canvasPos,null!=g.points&&0<g.points.length&&(null!=g.points[0].x&&null!=g.points[0].y&&(g.points[0].x+=m.x,g.points[0].y+=m.y),null!=g.points[0].x&&null!=g.points[0].y&&(g.points[1].x+=m.x,g.points[1].y+=m.y)),(1<Math.abs(g.start.x)||1<Math.abs(g.start.y))&&(g.realStart={},g.realStart.x=g.canvasPos.x+f.x,g.realStart.y=g.canvasPos.y+f.y,g.start.x=g.start.x/g.canvasPos.w,g.start.y=g.start.y/g.canvasPos.h),(1<Math.abs(g.end.x)||1<Math.abs(g.end.y))&&(g.realEnd={},g.realEnd.x=g.canvasPos.x+v.x,g.realEnd.y=g.canvasPos.y+v.y,g.end.x=g.end.x/g.canvasPos.w,g.end.y=g.end.y/g.canvasPos.h),delete g.canvasPos)}}function y(e,t){if(null!=e.summaries&&0<e.summaries.length)for(var i=0;i<e.summaries.length;i++){var n,o=e.summaries[i],r=o.range+"";null!=o.range&&r.indexOf(",")<0&&(n=$.extend(!0,{},o),o.range="0,0",t&&(n.part="right"),u=!0),x(o)}}function x(e){e.free&&y(e),null!=e.summaries&&e.root?y(e,!0):null!=e.summaries&&y(e);for(var t=e.children,i=0;i<t.length;i++){var n=!1;if("root"==(d=t[i]).parent&&(n=!0),d.summary&&(delete d.summary,delete d.range),null!=d.summaries&&0<d.summaries.length)for(var o=0;o<d.summaries.length;o++){var r=(p=d.summaries[o]).range+"";if(null!=p.range&&r.indexOf(",")<0){var l,s,a=$.extend(!0,{},p);if(d.free?(l=p.children.length,p.range="0,"+(l-1)<0?0:l-1,0==d.children.length&&(p.range="0,0",s={id:h.model.newId(),parent:d.id,children:[],title:"子主题"},d.children.push(s))):(a.parent=e.id,a.range=i+","+i),n&&(a.part="right"),u=!0,!d.free){if(d.summaries.splice(o,1),null==e.summaries){e.summaries=[],e.summaries.push(a),x(e);break}e.summaries.push(a)}}x(p)}x(d)}var c=e.leftChildren||[];if(0<c.length)for(i=0;i<c.length;i++){var d,n=!1;if("root"==(d=c[i]).parent&&(n=!0),null!=d.summaries&&0<d.summaries.length)for(o=0;o<d.summaries.length;o++){var p,r=(p=d.summaries[o]).range+"";if(null!=p.range&&r.indexOf(",")<0)if((a=$.extend(!0,{},p)).parent=e.id,a.range=i+","+i,n&&(a.part="left"),u=!0,d.summaries.splice(o,1),!d.free){if(d.summaries.splice(o,1),null==e.summaries){e.summaries=[],e.summaries.push(a),x(e);break}e.summaries.push(a)}x(p)}x(d)}}return(""==e.background||null==e.background||0<e.background.indexOf("niupizhi.png"))&&delete e.background,function e(t){{var i,n;null!=t.tag&&(i=t.tag,(n=[]).push({text:i,color:"#276F86",background:"#d6f0f8"}),t.tags=n,delete t.tag)}null!=t.task&&(""==t.task.start&&delete t.task.start,""==t.task.end&&delete t.task.end);null!=t.link&&""==t.link.value&&delete t.link;if(null!=t.icons){var o=h.icons.icons;if(null!=o)for(var r=0,l=t.icons.length;r<l;r++){var s=t.icons[r];if(null!=s){var a=o[s.name];if(null!=a)for(var c=0;c<a.length;c++){var d=a[s.index];if(null==d){d=a[a.length-1],s.text=d.text;break}if(d.index==s.index){s.text=d.text;break}}}}}var p=t.children,l=p.length;for(var r=0;r<l;r++){var u=p[r];e(u)}}(e),x(e),(o||r||u)&&"undefined"!=typeof wpsId&&$.ajax({url:"/mindmap/updatedef",type:"post",data:{id:h.opts.chartId,def:JSON.stringify(e),group_id:group_id,parent_id:parent_id,user_id:userId,file_id:file_id,encrypted_session:encrypted_session,ignore:"def"},success:function(e){},error:function(){}}),e},isChrome:function(){return 0<=navigator.userAgent.toLowerCase().indexOf("chrome")},isFirefox:function(){return 0<=navigator.userAgent.toLowerCase().indexOf("firefox")},isSafari:function(){var e=navigator.userAgent.toLowerCase();return(-1!==e.indexOf("safari")||-1<e.indexOf("mac os"))&&-1===e.indexOf("chrome")},isIE:function(){return 0<=navigator.userAgent.toLowerCase().indexOf("trident")},tipCount:function(){var e=window.localStorage.getItem("tip_count");if(null==e)return localStorage.setItem("tip_count",1),!0;var t=parseInt(e);return!(20<t)&&(localStorage.setItem("tip_count",t+1),!0)},getMargin:function(){var e=this.model.topic.margin||{};return{marginH:null==e.marginH?this.styles.marginH:e.marginH,marginW:null==e.marginW?this.styles.marginW:e.marginW,childMarginH:null==e.childMarginH?this.styles.childMarginH:e.childMarginH,childMarginW:null==e.childMarginW?this.styles.childMarginW:e.childMarginW}},checkWebsocket:"notcreat",testVipState:function(t,e){var i=this;if(e&&(-1<tdocVipInfo.indexOf(20)||-1<tdocVipInfo.indexOf(40))&&mind.events.push("po-vip-limit",e),void 0===t&&(t=function(){}),"undefined"!=typeof vipPreTime){var n=(new Date).getTime();if(n-vipPreTime<12e4)return void t();vipPreTime=n}else vipPreTime=(new Date).getTime();"tdocyun"==this.deviceIdentify()&&$.ajax({url:"/user/query",type:"POST",data:{user_id:userId,encrypted_session:encrypted_session,client_id:client_id,file_id:file_id,trace_id:trace_id},success:function(e){"error"!=e.result&&(i.wpsVipInit(e),mind.events.push("setUpgradeBtn")),t()},error:function(){t()}})},wpsVipInit:function(e){if(tdocVipInfo=[],e){tdocVipInfo=[];var t=e.tdoc_is_svip,i=e.tdoc_is_vip,n=e.tdoc_type,o=e.has_vip_expansion;return 2==n?(tdocVipInfo.push(40),void tdocVipInfo.push(100)):3==n?void tdocVipInfo.push(101):(i&&tdocVipInfo.push(20),i&&o&&tdocVipInfo.push(30),t&&tdocVipInfo.push(40),void(i||tdocVipInfo.push(10)))}tdocVipInfo.push(10)},deviceIdentify:function(){return 0<navigator.userAgent.indexOf("Yun/")||window.cefQuery,"tdocyun"}},mindDesigner.prototype.tags={setTags:function(e){var t=this.util,i=this.model,n=t.getSelectedId();if(!this.opts.readonly&&null!=n&&""!=$.trim(n)&&""!=$.trim(e.text)){var o=$.trim(e.text),r=i.getTopicById(n),l=r.tags;null==l&&(r.tags=[]);var s,a=!1;for(var c in l)if(c.text==o){a=!0;break}a||(s=t.copy(r),r.tags.push(e),i.updateTopicNode.call(this,r,s,"tag"))}},renderTagColors:function(e){for(var t="#d6f0f8",i="#276F86",n=[],o=e.style.baseColor(),r=0,l=o.length;r<l;r++){var s=o[r],a="#f4f4f4"==s?"#333":"#fff;";n.push("<span style='background:"+s+";color:"+a+"'></span>")}return n.push("<span style='background:"+t+";color:"+i+";'></span>"),n.join("")},renderTopicTag:function(e,t,i){if(t.tags&&!$.isEmptyObject(t.tags)){var n=(c=e.getTopicDom(t.id)).children(".topic-tags");n.length?0<n.children().length&&n.children().remove():(n=$("<div class='topic-tags' style='padding-right:30px'></div>"),c.append(n));for(var o=t.tags,r="",l=0,s=o.length;l<s;l++){var a=o[l];null!=a&&(this.setToLocal(a),r+="<span class='topic-tag' style='background:"+a.background+";color:"+a.color+"'><label class='topic-tags-text'>"+a.text+"</label><label style='color:"+a.color+"' class='mind-icons close_tag'>&#xe6fc;</label></span>")}n.html(r)}else{var c,d=(c=e.getTopicDom(t.id)).children(".topic-tags");d.length&&d.remove()}},removeTag:function(e){var t=this.util,i=this.model,n=t.getSelectedId();if(null!=n&&""!=$.trim(n)){for(var o=i.getTopicById(n),r=t.copy(o),l=o.tags,s=0,a=0;a<l.length;a++){if(l[a].text==e){s=a;break}}this.tags.getTopicsTags(l[s],"remove"),l.splice(s,1),i.updateTopicNode.call(this,o,r,"tag")}},mindtags:[],getTopicsTags:function(e,t){if(e&&!$.isEmptyObject(e)){var a=this.mindtags;if("remove"==t)for(var i=0;i<a.length;i++){var n=a[i],o=n.text,r=n.background,l=e.text,s=e.background;o==l&&r==s&&a.splice(i,1)}else{-1==function(e){for(var t=-1,i=0;i<a.length;i++){var n=a[i],o=n.text,r=n.background,l=e.text,s=e.background;o==l&&r==s&&(t=i)}return t}(e)&&this.mindtags.unshift(e)}}},setToLocal:function(e){var t,i,n=localStorage.getItem("recentTags");e&&!$.isEmptyObject(e)&&(null!=n?(t=JSON.parse(n),i=JSON.stringify(e),-1==t.indexOf(i)&&t.length<20&&t.push(i),localStorage.setItem("recentTags",JSON.stringify(t)),this.renderRecentTags()):(localStorage.setItem("recentTags","[]"),this.setToLocal(e)))},removeLocal:function(e){var t,i,n=localStorage.getItem("recentTags");null==n||0<=(t=JSON.parse(n)).indexOf(e)&&(i=t.indexOf(e),t.splice(i,1),localStorage.setItem("recentTags",JSON.stringify(t)))},setTagColor:function(e,t){var i=this.util,n=this.model,o=i.getSelectedId();if(null!=o&&""!=$.trim(o)){var r=n.getTopicById(o),l=i.copy(r),s=r.tags||[];if(0==s.length)r.tags=[],r.tags.push({background:e.background,color:e.color,text:t});else for(var a=0,c=s.length;a<c;a++){var d=s[a];if(d.text==t){d.background=e.background,d.color=e.color;break}}n.updateTopicNode.call(this,r,l,"tag")}},checkExists:function(e,t,i){var n=e.model.getTopicById(t).tags,o=!0;if(null!=n&&0<n.length)for(var r=0;r<n.length;r++){if(n[r].text==i){o=!1;break}}return o},showTag:function(e,t){var i,n,o=this.util,r=(this.model,t||o.getSelectedId()),l=(this.operation,this.tags);null!=r&&""!=$.trim(r)&&(this.opts.readonly||(i=o.getTopicDom(r),0==(n=$("#mind-tags-box")).length&&(n=$("<div id='mind-tags-box' class='mind-topic-box'><div class='mind-tags-curr topic-box-list'><div>快速添加</div><div class='scroll'></div></div><div class='mind-tags-input topic-box-list'><span>标签文字</span><input id='mind-topic-tag' type='text' placeholder='输入文本，回车新建标签'/></div><div class='mind-input-error' style='display:none;'><div style='width:74px'></div><label>请勿超过20个字</label></div><div class='mind-tags-color topic-box-list'><div>标签颜色</div><div class='ft0'></div></div><div class='mind-box-btn'><div class='box_cel_btn mind-button gray'>取消</div><div class='box_ok_btn mind-button mind-disable'>确定</div></div></div>").appendTo(this.designer)),function(e){for(var t=e.children(".mind-tags-color"),i=e.children(".mind-tags-default"),n=(e.children(".mind-tags-input"),"#d6f0f8"),o="#276F86",r=[],l=mind.style.baseColor(),s=0,a=l.length;s<a;s++){var c=l[s],d="#fff;";"#f4f4f4"==c&&(d="#333");var p=0==s?"active":"";r.push("<span class='"+p+"' style='background:"+c+";color:"+d+"'></span>")}{r.push("<span style='background:"+n+";color:"+o+";'></span>"),r.push("<span style='background:#1E6FFF;color:#fff;margin-right:0;'></span>"),t.children().eq(1).html(r.join("")),0==i.children().eq(1).children().length&&i.children().eq(1).html('<span class="tags" style="background:#7a00f2;">待定</span><span class="tags" style="background:#50c28b;">已确认</span><span class="tags" style="background:#6d6d6d;">已完成</span><span class="tags" style="background:#c4c4c4;">已关闭</span><span class="tags" style="background:#2760f2;">进行中</span>')}}(n),l.renderTags(this,r),$.fn.showPanel({target:i,panel:n}),n.find("input").focus()))},renderTags:function(e,t){var i=$("#mind-tags-box"),n=i.children(".mind-tags-curr");if(null!=(i=JSON.parse(localStorage.getItem("recentTags")))&&0<i.length){for(var o=[],r=0;r<i.length;r++){var l=JSON.parse(i[r]);o.push("<span class='tags' style='background:"+l.background+";color:"+l.color+";'><span class='mind-tags-text'>"+l.text+"</span></span>")}n.show().children().eq(1).html(o.join(""))}else n.hide();this.initTagsEvent(e,t)},renderRecentTags:function(){var e=localStorage.getItem("recentTags");if(null!=e&&""!=e){for(var t=JSON.parse(e),i="",n=0;n<t.length;n++)i+='<span class="tags" style="background:#d6f0f8;color:#276F86;"><label>'+t[n]+'</label><i class="mind-icons">&#xe622;</i></span>';$("#mind-tags-recent").html(i)}else $("#mind-tags-recent").html("")},initTagsEvent:function(l,o){var s=this;function i(e){var t,i,n,o,r=mind.util.selectedIds[0];4<(mind.model.getTopicById(r).tags||[]).length?$.showTip("单个节点最多支持5个标签",2e3):(20<(e=l.util.htmlEncode(e)).length&&(e=e.substring(0,20)),s.checkExists(l,r,e)&&(i=(t=$(".mind-tags-color").find("span.active")).css("background-color")||t.css("background"),o={text:e,color:(n={color:t.css("color")||"#ffffff",background:i}).color,background:n.background},s.setTags.call(l,o),s.renderTags(l,r),s.setToLocal(o),$("#mind-topic-tag").val(""),$(".mind-box-btn").find(".box_ok_btn").addClass("mind-disable"),s.resetPanel(l,r)))}$(document).off("click.tags").on("click.tags",".mind-tags-curr .tags",function(e){var t,i,n,o=mind.util.selectedIds[0];4<(mind.model.getTopicById(o).tags||[]).length?$.showTip("单个节点最多支持5个标签",2e3):($("#mind-tags-box"),i=0<(t=$(this)).children("label").length?t.children("label").text():t.text(),s.checkExists(l,o,i)&&(n={text:i,background:t.css("background-color"),color:t.css("color")},s.setTags.call(l,n),e.stopPropagation()))}),$("#mind-topic-tag").off("keyup").on("keyup",function(e){console.log($(this).val().length);var t=$(this).val();if(20<t.length?($(this).addClass("ipt-error"),$(".mind-input-error").css("display","flex").find("label").text("请勿超过20字")):($(this).removeClass("ipt-error"),$(".mind-input-error").hide()),0==t.length?$(".mind-box-btn").find(".box_ok_btn").addClass("mind-disable"):$(".mind-box-btn").find(".mind-disable").removeClass("mind-disable"),13==e.keyCode){if(20<t.length)return;t=l.util.htmlEncode(t),""!=$.trim(t)&&i($.trim(t))}}),$("#mind-tags-box").children(".mind-box-btn").find(".box_ok_btn").off("click").on("click",function(e){var t=$.trim($("#mind-topic-tag").val());20<t.length||(t=l.util.htmlEncode(t),""!=$.trim(t)&&i($.trim(t)))}),$("#mind-tags-box").children(".mind-box-btn").find(".box_cel_btn").off("click").on("click",function(e){$(".mind-topic-box").hide()}),$("#mind-tags-box").children(".mind-tags-curr").find(".mind-icons").off("click").on("click",function(e){var t=$(this),i=t.parent();t.remove();var n=$.trim(i.text());i.remove(),s.removeTag.call(l,n),s.renderTags(l,o),s.resetPanel(l,o),e.stopPropagation()}),$("#mind-tags-recent").find(".mind-icons").off("click").on("click",function(e){var t=$(this).parent(),i=t.children("label").text();removeLocal(i),t.remove(),e.stopPropagation()}),$("#mind-tags-box").children(".mind-tags-color").find("span").off("click").on("click",function(e){$(this).addClass("active").siblings().removeClass("active"),e.stopPropagation()})},resetPanel:function(e,t){var i=e.util.getTopicDom(t);$.fn.showPanel({target:i,panel:$("#mind-tags-box")})}},mindDesigner.prototype.remark={setRemark:function(e,t){var i,n,o=this.util,r=this.model,l=t||o.getSelectedId();this.opts.readonly||null!=l&&""!=$.trim(l)&&(e=o.htmlEncode(e),null==(i=r.getTopicById(l)).note&&""==e||e!=i.note&&(n=o.copy(i),i.note=e,r.updateTopicNode.call(this,i,n,"note")))},renderTopicNote:function(i,n,e){var t,o,r=this;n.note?(0<(o=i.getTopicDom(n.id)).children(".topic-note").length&&o.children(".topic-note").remove(),t=$("<span class='topic-note mind-icons'>&#xe6c1a;</span>"),o.children(".topic").after(t),"right"==e||null==e?t.addClass("right"):"left"==e&&t.addClass("left"),t.off("mouseenter.remark").on("mouseenter.remark",function(e){var t=$(this);r.renderViewBox(n,t,i)}),t.off("click.remark").on("click.remark",function(e){mind.events.push("showRight","remark"),e.stopPropagation()}),t.off("mousedown.remark").on("mousedown.remark",function(e){e.stopPropagation()})):0<(o=i.getTopicDom(n.id)).children(".topic-note").length&&o.children(".topic-note").remove()},renderViewBox:function(e,t,i){var n=$("#note_view_box");n.length&&n.remove();var o=new showdown.Converter({simpleLineBreaks:!0,tables:!0,tasklists:!0}),r=i.htmlDecode(e.note),l=o.makeHtml(r).replace(/<(\/)?script([^>]+)?>/g,"&lt;$1script$2&gt;").replace("onerror","o n e r r o r'").replace("onclick","o n c l i c k ");console.log(o.makeHtml(r).replace(/<(\/)?script([^>]+)?>/g,"&lt;$1script$2&gt;")),(n=$("<div id='note_view_box'>"+l+"</div>").appendTo("body")).dropdown({target:t,position:"center"});var s=n.offset().top,a=t.offset().top,c=$(t).outerHeight();s<a+c&&n.css("top",a+c+2),n.off("mouseup.remark").on("mouseup.remark",function(e){e.stopPropagation()})}},mindDesigner.prototype.task={showTask:function(e){var t,i,n,o,r,l,s,a,c,d,p=this,u=p.util,h=p.model,m=e||u.getSelectedId(),g=(p.operation,p.task);null!=m&&""!=$.trim(m)&&(p.opts.readonly||(t=u.getTopicDom(m),i=h.getTopicById(m),n=$("#mind-task"),0==(o=$("#mind-task-box")).length&&(o=$("<div id='mind-task-box' class='mind-topic-box'><h3>任务<a id='remove-task' style='cursor:pointer;font-size:13px;font-size: 13px;font-weight: normal;float: right;text-decoration: underline;'>删除</a></h3></div>").appendTo(p.designer)).append(n),$.fn.showPanel({target:t,panel:o}),null!=i.task&&(r=$("#mind-icons-priority-list"),l=$("#mind-icons-completion-list"),s=r.find("li[priority="+i.task.priority+"]").clone(),a=l.find("li[completion="+i.task.completion+"]").clone(),s.find("span").remove(),a.find("span").remove(),c=s.text(),d=a.text(),""!=c?$("#mind-task-priority").children("span").text(c):$("#mind-task-priority").children("span").text("无"),""!=d?$("#mind-task-completion").children("span").text(d):$("#mind-task-completion").children("span").text("无"),a.remove(),s.remove(),$("#mind-task-start").find("span").text(i.task.start||"无"),$("#mind-task-end").find("span").text(i.task.end||"无"),$("#mind-task-assigned").val(i.task.assigned)),n.show(),o.find("input").focus(),$("#remove-task").on("click",function(){g.removeTask.call(p),$("#mind-task-assigned").val(""),p.operation.hideLink(),$(".mind-dock-right-task").find(".mind-select-box").text("无")})))},setTask:function(e,t){var i,n,o=this.util,r=this.model,l=t||o.getSelectedId();null!=l&&""!=$.trim(l)&&null!=e&&(this.opts.readonly||(i=r.getTopicById(l),n=o.copy(i),null==i.task&&(i.task={}),i.task=$.extend(i.task,e),r.updateTopicNode.call(this,i,n,"task")))},removeTask:function(){var e,t,i=this.util,n=this.model,o=i.getSelectedId();null!=o&&""!=$.trim(o)&&(this.opts.readonly||(i=this.util,n=this.model,o=i.getSelectedId(),e=n.getTopicById(o),t=i.copy(e),null!=e.task&&(delete e.task,n.updateTopicNode.call(this,e,t,"task"))))},renderTopicTask:function(e,t,i){var n,o,r,l,s,a;t.task&&!$.isEmptyObject(t.task)?(n=t.task,(o=(a=e.getTopicDom(t.id)).children(".topic-task")).length||(o=$("<div class='topic-task'></div>"),t.tags&&!$.isEmptyObject(t.tags)?a.find(".topic-tags").before(o):a.append(o)),r="",s=l=!1,n.start&&(r+="<span>"+n.start+"</span>",l=!0),n.end&&(0==l&&(r+="_ "),r+="<span> : "+n.end+"</span>",s=!0),0==s&&(r+=" : _"),0==l&&0==s&&(r=""),null!=n.assigned&&(r+="&nbsp;<span>("+n.assigned+")</span>"),o.html(r),""==o.html()&&o.remove()):(a=e.getTopicDom(t.id)).children(".topic-task").remove()}},mindDesigner.prototype.icons={renderTopicIcons:function(e,t,i){if(t.icons){var n=t.icons,o=this.icons;(h=(u=e.getTopicDom(t.id)).children(".topic-icons")).length?h.children().remove():(h=$("<span class='topic-icons'></span>"),u.find(".topic").before(h));for(var r="",l=0,s=n.length;l<s;l++){var a=n[l];if(null!=a)if(a.url)r+="<span n='"+a.name+"' ico='"+a.index+"' iconimg='"+a.url+"' class='mind-icon-url mind-icons'><img src='"+a.url+"' /></span>";else{var c=o[a.name];if(null==c)continue;var d=this.getIcon(c,a.index);if(null==d)continue;var p=a.color?"style='color:"+a.color+"'":"";r+="<span n='"+a.name+"' ico='"+a.index+"' "+p+" class='mind-icons'>"+d.text+"</span>"}}h.html(r),""==r&&h.remove(),"right"==i||null==i?h.addClass("right"):"left"==i&&h.addClass("left"),h.width(25.1*s)}else{var u,h;(h=(u=e.getTopicDom(t.id)).children(".topic-icons")).length&&h.remove()}},currentIcon:{},setIcon:function(e,t,i,n){var o=this,r=e.attr("ico"),l=(e.text(),{index:r,name:null==e.attr("n")?"":e.attr("n")});n&&(l.url=n),null!=i?l.color=i:null!=o.icons.currentIcon&&null!=o.icons.currentIcon.color&&o.icons.currentIcon.name==l.name&&(l.color=o.icons.currentIcon.color);var s=(o=this).util,a=o.model,c=s.selectedIds;if(!o.opts.readonly&&0!=c.length&&""!=l.index&&null!=l.index){for(var d=[],p=[],u=0,h=c.length;u<h;u++){var m=c[u],g=a.getTopicById(m),f=s.copy(g);p.push(f),null==g.icons&&(g.icons=[]);for(var v=g.icons,r=-1,y=-1,x=!1,b=0,T=v.length;b<T;b++){var C=v[b];if(l.index==C.index){y=b;break}if(C.name==l.name&&!n&&""!=l.name){r=b;break}}0<=r?g.icons.splice(r,1,l):0<=y?(g.icons.splice(y,1),x=!0):g.icons.push(l),null!=t&&(g.task=$.extend(g.task,t)),x?e.removeClass("selected"):e.addClass("selected"),d.push(g)}a.updateTopicNode.call(o,d,p,"icon")}},getIcon:function(e,t){var i=null;if(e){for(var n=0,o=e.length;n<o;n++){var r=e[n];if(t==r.index){i=r;break}}return i}},removeIcon:function(e){var t=this.icons.currentIcon;if(null!=e||null!=t&&null!=t.index){var i=this.util,n=this.model,o=i.selectedIds;if(0!=o.length){for(var r=[],l=[],s=0,a=o.length;s<a;s++){var c=o[s],d=n.getTopicById(c),p=i.copy(d),u=d.icons;l.push(p);for(var h=0,m=u.length;h<m;h++){var g=u[h];if(null!=e&&g.name==e){u.splice(h,1);break}if(g.index==t.index){u.splice(h,1);break}null!=e&&(d.task[e]=null)}r.push(d)}n.updateTopicNode.call(this,r,l,"icon")}}},setIconColor:function(e){var t=this.util,i=this.model,n=t.getSelectedId();if(null!=n&&""!=$.trim(n)){var o=this.icons.currentIcon;if(null!=o.index){for(var r=i.getTopicById(n),l=t.copy(r),s=r.icons,a=0,c=s.length;a<c;a++){var d=s[a];if(d.index==o.index){d.color=e;break}}i.updateTopicNode.call(this,r,l,"icon")}}},icons:{priority:[{index:0,text:"&#xe6a6;"},{index:1,text:"&#xe625"},{index:2,text:"&#xe62a"},{index:3,text:"&#xe635"},{index:4,text:"&#xe626"},{index:5,text:"&#xe62b"},{index:6,text:"&#xe627"},{index:7,text:"&#xe628"},{index:8,text:"&#xe629"}],face:[{index:9,text:"&#xe6c8"},{index:11,text:"&#xe6ca"},{index:10,text:"&#xe6c6"}],arrow:[{index:33,text:"&#xe68c"},{index:34,text:"&#xe68e"},{index:35,text:"&#xe68d"},{index:36,text:"&#xe68b"},{index:37,text:"&#xe6a0"}],flag:[{index:26,text:"&#xe67e"},{index:27,text:"&#xe67e"},{index:28,text:"&#xe67e"},{index:29,text:"&#xe67e"},{index:30,text:"&#xe67e"},{index:31,text:"&#xe67e"},{index:32,text:"&#xe67e"}],completion:[{index:17,text:"&#xe6d2"},{index:18,text:"&#xe6d3"},{index:19,text:"&#xe6d4"},{index:20,text:"&#xe6d5"},{index:21,text:"&#xe6d6"},{index:22,text:"&#xe6d7"},{index:23,text:"&#xe6d8"},{index:24,text:"&#xe6d9"}],"":[{index:38,text:"&#xe6d9;"},{index:39,text:"&#xe634"},{index:40,text:"&#xe640"},{index:41,text:"&#xe692"},{index:42,text:"&#xe6b8"},{index:43,text:"&#xe6bb"},{index:44,text:"&#xe6b9"},{index:45,text:"&#xe6bf"},{index:46,text:"&#xe663"},{index:47,text:"&#xe6bd"},{index:48,text:"&#xe621"},{index:49,text:"&#xe6bc"},{index:50,text:"&#xe6c1"},{index:51,text:"&#xe609"},{index:52,text:"&#xe688"},{index:53,text:"&#xe681"},{index:54,text:"&#xe639"},{index:55,text:"&#xe682"},{index:56,text:"&#xe67f"},{index:57,text:"&#xe695"},{index:58,text:"&#xe689"},{index:59,text:"&#xe6be"},{index:60,text:"&#xe683"},{index:61,text:"&#xe6c0"},{index:62,text:"&#xe6b6"},{index:63,text:"&#xe680"},{index:64,text:"&#xe693"}]},docerIcon:[]},mindDesigner.prototype.style={baseColor:function(){return["#bf1e1b","#63abf7","rgb(113, 203, 45)","#ff9f1a","#30bfbf","#444444","#f4f4f4"]},getThemeStyle:function(e){var t=this.model.topic,i=this.style.themes,n=t.classic||t.theme,o=this.util;if(null!=e&&""!=e&&"null"!=e)return e;var r=o.copy(i.theme3);if(n)if(n.indexOf("customise_")<0)i[n]&&(r=o.copy(i[n]));else{var l=window.sessionStorage.getItem("customiseThemes");if(null!=l&&""!=l){var s=JSON.parse(l);if(0<s.length)for(var a=0;a<s.length;a++){var c=s[a];if(c.id==n){r=c;break}}}}var d=t.background;return r=$.extend(r,{background:d||r.background})},setTheme:function(e){var t=this.model,i=this.currentRoot||t.topic;this.events.push("zoom",0),this.style.checkCustomiseStyle(i)?this.events.push("showThemeOperate",e):this.style.setThemeDirect.call(this,e)},setThemeDirect:function(e,t,i){var n=this.model.topic,o="";null!=n.classic&&(o=n.classic,delete n.classic,n.theme=o),o=n.theme,null==e&&""==e||(n.theme=e),this.operation.clearCanvas.call(this),this.operation.zoomVal=100,mind=new mindDesigner("#mind_con",{chartId:chartId,readonly:!!i},n,"string"==typeof e?"":e),$(document).off("selectstart"),null==t&&this.messageSource.send.call(this,"setTheme",{content:e,original:o})},setThemeOverWrite:function(e,t){var i=this,n=i.model,o=i.currentRoot||n.topic,r="";null!=o.classic&&(r=o.classic,delete o.classic,o.theme=r),r=o.theme,null==e&&""==e||(o.theme=e);var l=n.getStyleTopics.call(i,o);n.topicList.resetTopicList.call(i);for(var s=[],a=0,c=l.length;a<c;a++){var d=l[a];delete d.children,s.push(d)}i.styles=i.style.getThemeStyle.call(i),i.operation.setBackground.call(i),i.render(),i.events.push("change_expands_tyle"),i.messageSource.send.call(i,"setThemeOverWrite",{tps:s,content:e,original:r,operate:"delete"}),null!=t&&t()},setThemeOverWrite_:function(e,t,i,n){var o=this,r=o.model,l=o.currentRoot||r.topic,s=l.theme;null==e&&""==e||(l.theme=e),"add"==i?r.addTopicStyles.call(o,l,t):"delete"==i&&r.getStyleTopics.call(o,l),r.topicList.resetTopicList.call(o),o.styles=o.style.getThemeStyle.call(o),o.operation.setBackground.call(o),o.render(),null==n&&o.messageSource.send.call(o,"setThemeOverWrite",{tps:t,content:e,old:s,operate:i}),o.events.push("updateMargin")},checkCustomiseStyle:function(e){var r=!1;return function e(t){if(t.style||t.lineStyle||t.background&&t.root||t.margin&&t.root)return r=!0;var i=t.children;t.root&&null!=t.leftChildren&&(i=i.concat(t.leftChildren));for(var n=0,o=i.length;n<o;n++)if(e(i[n])){r=!0;break}}(e),r},getRadomColor:function(){return["rgb(220,220,220)","rgb(193,255,193)","rgb(254,224,198)","rgb(254,240,201)","rgb(255,204,204)","rgb(255,230,204)","rgb(230,255,204)","rgb(204,229,255)","rgb(204,204,255)","rgb(229,204,255)","rgb(255,204,255)","rgb(255,204,230)"][parseInt(10*Math.random())]},usedColors:[],getLineColor:function(){for(var e=this.getRadomLineColor();0<=this.usedColors.indexOf(e);)e=this.getRadomLineColor();return this.usedColors.push(e),10==this.usedColors.length&&(this.usedColors.length=[]),e},getRadomLineColor:function(){return["rgb(255,204,204)","rgb(153,204,255)","#FDB813","#80BC42","#e85d4e","#127c97","rgb(232, 124, 37)","rgb(0, 94, 170)","rgb(51, 156, 168)","rgb(212, 164, 235)"][parseInt(10*Math.random())]},themes:{theme3:{background:"#ffffff",thumbUrl:"/assets/images/mind/mr.jpg",thinner:!1,title:"默认风格",marginH:26,marginW:80,childMarginH:8,childMarginW:12,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"#50C28B",color:"#fff","font-size":"25px","border-radius":"5px",padding:"14px 12px 14px 12px"},secTopic:{backgroundColor:"#ffffff",border:"1px solid rgb(187,187,187)","border-radius":"5px",color:"rgb(68,68,68)","font-size":"17px",padding:"10px 10px 10px 10px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"rgb(170,170,170)"}},childTopic:{"font-size":"13px",color:"rgb(68,68,68)",padding:"2px 9px 4px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(140,140,140)"}}},default:{background:"#ffffff",thinner:!1,thumbUrl:"/assets/images/mind/wdmx.jpg",title:"文档模型",marginH:26,marginW:60,childMarginH:10,childMarginW:14,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"#50C28B",color:"#fff","font-size":"26px","border-radius":"5px",padding:"14px 15px 13px 15px"},secTopic:{backgroundColor:"#ffffff",border:"1px solid rgb(187,187,187)","border-radius":"5px",color:"rgb(68,68,68)","font-size":"17px",padding:"8px 12px 8px 12px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(170,170,170)"}},childTopic:{"font-size":"13px",color:"rgb(68,68,68)",padding:"2px 9px 4px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(140,140,140)"}}},shangwu:{background:"#ffffff",thinner:!1,thumbUrl:"/assets/images/mind/jysw.jpg",title:"简约商务",marginH:30,marginW:80,childMarginH:20,childMarginW:10,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"rgb(102, 102, 255)",color:"#fff","font-size":"27px","border-radius":"5px",padding:"14px 12px 14px 12px"},secTopic:{color:"rgb(102, 102, 255)","font-size":"17px",padding:"10px 10px 10px 10px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"rgb(0, 0, 204)"}},childTopic:{"font-size":"13px",color:"rgb(102, 102, 255)",padding:"2px 9px 4px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(102, 102, 255)"}}},paper:{background:"#fcf5de",thumbUrl:"/assets/images/mind/paper.jpg",thinner:!1,title:"简约风格",marginH:30,marginW:80,childMarginH:14,childMarginW:12,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"#ffffff",color:"#735C45","font-size":"30px","border-radius":"5px",border:"2px solid #3D474D",padding:"14px 12px 14px 12px"},secTopic:{backgroundColor:"#ffffff",border:"1px solid #3D474D","border-radius":"25px",color:"#735C45","font-size":"16px",padding:"10px 10px 10px 10px",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"#3D474D"}},childTopic:{"font-size":"14px",color:"#735C45",padding:"2px 9px 4px 9px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"#3D474D",underLine:!0}}},jianbihua:{background:"rgb(255, 249, 217)",thumbUrl:"/assets/images/mind/jbxt.jpg",title:"简笔线条",thinner:!1,marginH:40,marginW:80,childMarginH:20,childMarginW:20,common:{family:"Comic Sans MS,微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"rgb(255, 249, 217)","border-width":"7px",color:"#333","font-size":"34px",padding:"16px 12px 15px 12px",borderStyle:"solid","-webkit-border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60","border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60"},secTopic:{backgroundColor:"rgb(255, 249, 217)",color:"rgb(68,68,68)","font-size":"20px",padding:"2px 9px 4px","border-width":"3px","-webkit-border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60","border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60",borderStyle:"solid",lineStyle:{lineType:"curve",lineWidth:3,lineColor:"rgb(70,70,70)"}},childTopic:{"font-size":"17px",color:"rgb(68,68,68)",padding:"2px 9px 2px","border-width":"2px","-webkit-border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60","border-image":"url(https://www.processon.com/assets/images/mind/border.png) 35 60 45 60",borderStyle:"solid",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(110,110,110)"}}},niupizhi:{background:"rgb(252,246,207)",thumbUrl:"/assets/images/mind/npz.jpg",thinner:!1,title:"牛皮纸",marginH:30,marginW:80,childMarginH:20,childMarginW:10,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"rgb(221, 170, 68)",color:"#fff","font-size":"30px","border-radius":"5px",padding:"14px 12px 14px 12px"},secTopic:{backgroundColor:"rgb(221, 170, 68)","border-radius":"5px",color:"#ffffff","font-size":"17px",padding:"10px 10px 10px 10px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"rgb(187, 136, 34)"}},childTopic:{"font-size":"13px",color:"rgb(187, 136, 34)",padding:"2px 9px 4px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(187, 136, 34)"}}},caihongthinner:{background:"#ffffff",thumbUrl:"/assets/images/mind/chl.jpg",title:"有色彩的线条Thinner",thinner:!0,autoColor:!0,marginH:30,marginW:80,childMarginH:10,childMarginW:20,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"#50C28B",color:"#fff","font-size":"34px","border-radius":"5px",padding:"15px 12px 15px 12px"},secTopic:{backgroundColor:"#ffffff",border:"1px solid rgb(187,187,187)","border-radius":"5px",color:"rgb(68,68,68)","font-size":"17px",padding:"10px 10px 10px 10px",lineStyle:{lineType:"curve",lineWidth:8,lineColor:"rgb(170,170,170)"}},childTopic:{"font-size":"13px",color:"rgb(68,68,68)",padding:"2px 9px 3px",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"rgb(140,140,140)"}}},colorLines:{background:"#ffffff",thumbUrl:"/assets/images/mind/colorlines.png",title:"有色彩的线条",thinner:!1,autoColor:!0,marginH:30,marginW:80,childMarginH:10,childMarginW:20,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"#fff",border:"6px solid #3aa9ce",color:"#333","font-size":"30px","border-radius":"5px",padding:"15px 12px 15px 12px"},secTopic:{backgroundColor:"#ffffff",border:"3px solid #3aa9ce","border-radius":"5px",color:"rgb(68,68,68)","font-size":"17px",padding:"10px 10px 10px 10px",lineStyle:{lineType:"curve",lineWidth:5,lineColor:"#3aa9ce"}},childTopic:{"font-size":"13px",color:"rgb(68,68,68)",padding:"2px 9px 4px",lineStyle:{lineType:"roundBroken",lineWidth:2,lineColor:"rgb(58, 169, 206)",underLine:!0}}},caihong:{background:"#ffffff",thumbUrl:"/assets/images/mind/ch.jpg",title:"有色彩的线条",thinner:!1,autoColor:!0,marginH:30,marginW:80,childMarginH:10,childMarginW:20,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"#50C28B",color:"#fff","font-size":"34px","border-radius":"5px",padding:"15px 12px 15px 12px"},secTopic:{backgroundColor:"#ffffff",border:"1px solid rgb(187,187,187)","border-radius":"5px",color:"rgb(68,68,68)","font-size":"17px",padding:"10px 10px 10px 10px",lineStyle:{lineType:"curve",lineWidth:8,lineColor:"rgb(170,170,170)"}},childTopic:{"font-size":"13px",color:"rgb(68,68,68)",padding:"3px 9px 4px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"rgb(140,140,140)"}}},caihongpao:{title:"彩虹泡",thumbUrl:"/assets/images/mind/chp.jpg",background:"#ffffff",thinner:!1,marginH:30,marginW:80,childMarginH:8,childMarginW:20,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"#50C28B",color:"#fff","font-size":"26px","border-radius":"5px",padding:"9px 12px 10px 12px"},secTopic:{backgroundColor:"#ffffff","border-radius":"5px",color:"rgb(103,103,103)","font-size":"14px",padding:"6px 10px 5px 10px",boxShadow:"1px 1px 1px #ccc",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"#43a9ff"}},childTopic:{"font-size":"12px","border-radius":"5px",color:"rgb(103,103,103)",padding:"3px 9px 4px",boxShadow:"1px 1px 1px #ccc",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"#43a9ff"}}},simple:{background:"#ffffff",thinner:!1,thumbUrl:"/assets/images/mind/simple.jpg",title:"简约",marginH:26,marginW:60,childMarginH:8,childMarginW:14,show:!1,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:1,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"#50C28B",color:"#fff","font-size":"26px","border-radius":"5px",padding:"14px 15px 13px 15px"},secTopic:{backgroundColor:"#ffffff",border:"1px solid rgb(137,137,137)","border-radius":"5px",color:"rgb(68,68,68)","font-size":"17px",padding:"8px 12px 8px 12px",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"rgb(130,130,130)"}},childTopic:{"font-size":"13px",color:"rgb(68,68,68)",padding:"3px 6px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"rgb(130,130,130)"}}},basic:{background:"#fcf5ef",thumbUrl:"/assets/images/mind/basic.png",thinner:!1,title:"简约风格",marginH:30,marginW:80,childMarginH:20,childMarginW:12,show:!1,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"#50C28B",color:"#fff","font-size":"30px","border-radius":"5px",padding:"14px 12px 14px 12px"},secTopic:{backgroundColor:"#ffffff",border:"1px solid rgb(187,187,187)","border-radius":"5px",color:"rgb(68,68,68)","font-size":"17px",padding:"10px 10px 10px 10px",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"rgb(170,170,170)"}},childTopic:{"font-size":"14px",backgroundColor:"#ffffff",color:"rgb(68,68,68)",padding:"2px 9px 2px",border:"1px solid rgb(187,187,187)","border-radius":"5px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(140,140,140)"}}},theme1:{background:"#ffffdd",thinner:!0,thumbUrl:"/assets/images/mind/zxjx.jpg",title:"线条渐细",marginH:30,marginW:90,childMarginH:10,childMarginW:20,show:!1,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(113, 203, 45)",color:"#ffffff"},centerTopic:{backgroundColor:"#50C28B",color:"#fff","font-size":"40px","border-radius":"5px",padding:"14px 12px 14px 12px"},secTopic:{backgroundColor:"#ffffff",border:"1px solid rgb(187,187,187)","border-radius":"5px",color:"rgb(68,68,68)","font-size":"17px",padding:"10px",lineStyle:{lineType:"straight",lineWidth:4,lineColor:"rgb(170,170,170)"}},childTopic:{"font-size":"13px",color:"rgb(68,68,68)",padding:"2px 9px 4px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(140,140,140)"}}},red:{background:"#ffffff",thumbUrl:"/assets/images/mind/red.jpg",thinner:!1,title:"简约风格",marginH:30,marginW:80,childMarginH:6,childMarginW:16,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"#eb5e41",color:"#ffffff"},centerTopic:{backgroundColor:"#eb5e41",color:"#ffffff","font-size":"30px",padding:"14px 12px 14px 12px"},secTopic:{backgroundColor:"#eb5e41",color:"#fff","font-size":"16px",padding:"10px 10px 10px 10px",lineStyle:{lineType:"straight",lineWidth:2,lineColor:"#eb5e41"}},childTopic:{"font-size":"13px",backgroundColor:"#f0f0f0","border-bottom":"1px solid #eb5e41",color:"#735C45","box-shadow":"1px 0px 0px #ccc",padding:"2px 9px 4px 9px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"#eb5e41",underLine:!0}}},black:{background:"rgb(57, 60, 65)",thumbUrl:"/assets/images/mind/black.jpg",title:"heise",thinner:!1,marginH:40,marginW:80,childMarginH:12,childMarginW:20,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"#e8eaec",color:"#333"},centerTopic:{backgroundColor:"#ff8200",color:"#fff","border-radius":"35px","font-size":"34px",padding:"16px 18px 16px 18px"},secTopic:{backgroundColor:"#e8eaec",color:"rgb(68,68,68)","font-size":"17px",padding:"10px 15px 10px 15px","border-radius":"20px",lineStyle:{lineType:"curve",lineWidth:3,lineColor:"#e8eaec"}},childTopic:{"font-size":"12px",color:"#ffffff",padding:"4px 10px","border-radius":"20px",border:"1px solid #e8eaec",lineStyle:{lineType:"roundBroken",lineWidth:2,lineColor:"#e8eaec"}}},mindmap:{background:"#f5f5f5",thumbUrl:"/assets/images/mind/mindmap.jpg",title:"标准思维导图样式",thinner:!0,autoColor:!0,marginH:20,marginW:100,childMarginH:10,childMarginW:40,member:!0,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:1,lineColor:"#98a2ab",color:"#ffffff"},centerTopic:{backgroundColor:"rgb(80, 194, 139)",color:"#ffffff","font-size":"24px","border-radius":"6px",padding:"14px 16px 14px 16px"},secTopic:{color:"rgb(68, 68, 68)","font-size":"16px",padding:"10px 14px 10px 14px","border-bottom":"2px solid #888",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"#8a8a8a",underLine:!0}},childTopic:{"font-size":"12px",color:"rgb(68, 68, 68)",padding:"2px 9px 4px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"#8a8a8a",underLine:!0}}},mindmap1:{background:"#f5f5f5",thumbUrl:"/assets/images/mind/mindmap1.jpg",title:"标准思维导图样式",marginH:20,marginW:60,childMarginH:10,childMarginW:30,member:!0,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:1,lineColor:"#98a2ab",color:"#ffffff"},centerTopic:{backgroundColor:"rgb(80, 194, 139)",color:"#ffffff","font-size":"22px","border-radius":"6px",padding:"10px 12px 10px 12px"},secTopic:{color:"rgb(68, 68, 68)","font-size":"15px",padding:"10px 12px 10px 12px","border-bottom":"2px solid #888",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"#8a8a8a",underLine:!0}},childTopic:{"font-size":"12px",color:"rgb(68, 68, 68)",padding:"2px 9px 4px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"#8a8a8a",underLine:!0}}},mobdefault:{background:"#f5f5f5",thumbUrl:"/assets/images/mind/mobdefault.png",title:"移动端主题",thinner:!1,marginH:20,marginW:50,childMarginH:10,childMarginW:20,show:!1,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(80, 194, 139)",lineType:"dashed",color:"#ffffff"},centerTopic:{backgroundColor:"rgb(80, 194, 139)",color:"#ffffff","font-size":"20px","border-radius":"6px",padding:"10px 16px 12px"},secTopic:{backgroundColor:"#ffffff","border-radius":"6px",color:"rgb(68, 68, 68)","font-size":"14px",border:"1px solid rgba(138, 138, 138,.6)",padding:"6px 12px 8px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"#8a8a8a"}},childTopic:{"font-size":"12px",color:"rgb(68, 68, 68)",padding:"2px 9px 4px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"#8a8a8a"}}},mobdark:{background:"rgb(57, 60, 65)",thumbUrl:"/assets/images/mind/mobdark.jpg",title:"标准思维导图黑色",marginH:20,marginW:60,childMarginH:10,childMarginW:20,show:!1,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(80, 194, 139)",lineType:"dashed",color:"#ffffff"},centerTopic:{backgroundColor:"#ff8202",color:"#fff1de","font-size":"20px","border-radius":"6px",padding:"10px 16px 12px"},secTopic:{color:"rgb(57,60,65)","font-size":"14px",padding:"6px 12px 8px","border-radius":"6px",background:"#e8eaec",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"rgb(120,123,128)"}},childTopic:{"font-size":"12px",color:"#f7f7f6",padding:"2px 9px 4px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(120,123,128)"}}},mobpink:{background:"#fad8df",thumbUrl:"/assets/images/mind/mobpink.jpg",title:"标准思维导图样式",marginH:20,marginW:60,childMarginH:10,childMarginW:20,show:!1,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(80, 194, 139)",lineType:"dashed",color:"#ffffff"},centerTopic:{backgroundColor:"#ea8aba",color:"#fefcfc","font-size":"20px","border-radius":"30px",padding:"10px 16px 12px"},secTopic:{color:"rgb(89,88,89)",backgroundColor:"#fff","font-size":"14px",padding:"6px 12px 8px","border-radius":"30px",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"rgb(248,248,248)"}},childTopic:{"font-size":"12px",color:"rgb(89,88,89)",padding:"2px 9px 4px",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(255,255,255)"}}},"mob-border-dark":{background:"#fff",thumbUrl:"/assets/images/mind/mob-border-dark.jpg",title:"标准思维导图黑色",marginH:20,marginW:60,childMarginH:14,childMarginW:20,show:!1,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:2,lineColor:"rgb(80, 194, 139)",lineType:"dashed",color:"#ffffff"},centerTopic:{backgroundColor:"#000",color:"#dad8da","font-size":"20px","border-radius":"3px",padding:"10px 16px 12px"},secTopic:{color:"rbg(37,37,37)","font-size":"14px",padding:"6px 14px 7px","border-radius":"3px",border:"2px solid rgb(55,55,55)",background:"#fff",lineStyle:{lineType:"roundBroken",lineWidth:2,lineColor:"rgb(55,55,55)"}},childTopic:{"font-size":"12px",color:"rbg(45,45,45)","border-radius":"2px",padding:"3px 9px 5px",border:"1px solid rgb(55,55,55)",lineStyle:{lineType:"roundBroken",lineWidth:1,lineColor:"rgb(55,55,55)"}}},mindmap_dark:{background:"#333333",thumbUrl:"/assets/images/mind/dark.jpg",title:"标准思维导图黑色",marginH:20,marginW:60,childMarginH:14,childMarginW:30,member:!0,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:1,lineColor:"#98a2ab",color:"#ffffff"},centerTopic:{backgroundColor:"#00a5ff",color:"#ffffff","font-size":"22px","border-radius":"6px",padding:"10px 16px 12px"},secTopic:{color:"#eee","font-size":"15px",padding:"10px 12px 10px 12px","border-bottom":"2px solid #d0d5d9",lineStyle:{lineType:"curve",lineWidth:2,lineColor:"#d0d5d9",underLine:!0}},childTopic:{"font-size":"12px",color:"#eee",padding:"2px 9px 4px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"#d0d5d9",underLine:!0}}},mobcaihong:{background:"#f5f5f5",thumbUrl:"/assets/images/mind/mobcaihong.jpg",title:"标准思维导图样式",thinner:!0,autoColor:!0,member:!0,marginH:20,marginW:60,childMarginH:14,childMarginW:40,show:!1,common:{family:"微软雅黑",bold:!1,italic:!1,textAlign:"left"},connectionStyle:{lineWidth:1,lineColor:"#98a2ab",color:"#ffffff"},centerTopic:{backgroundColor:"rgb(80, 194, 139)",color:"#ffffff","font-size":"24px","border-radius":"6px",padding:"8px 14px 10px"},secTopic:{color:"rgb(68, 68, 68)","font-size":"16px",padding:"6px 10px 7px","border-bottom":"2px solid #888",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"#8a8a8a",underLine:!0}},childTopic:{"font-size":"12px",color:"rgb(68, 68, 68)",padding:"2px 9px 4px",lineStyle:{lineType:"curve",lineWidth:1,lineColor:"#8a8a8a",underLine:!0}}}},getLineStyle:function(e){var t,i,n,o,r=this.model,l=(this.currentRoot||r.topic,this.util.copy(this.styles)),s=this.style,a={},c=r.getTopicById(e.parent);return l.autoColor?e.root||((t=r.getParentTopic(e.parent)).root||t.free?(i=document.getElementById(e.id).style,t.free&&(i=document.getElementById(t.id).style),""!=(n=i.borderColor)?("initial"==n&&(n=i.backgroundColor),"initial"!=n&&(a.lineColor=n)):(l.thinner?""==(n=i["border-bottom-color"])&&(n=(i=document.getElementById(e.id).style)["border-bottom-color"]):n=s.getLineColor(),a.lineColor=n)):""!=(o=$("#line_"+e.parent).attr("stroke"))&&(a.lineColor=o)):window.sessionStorage.removeItem("branchLineColors"),a=c.root?$.extend(l.secTopic.lineStyle,a,e.lineStyle):$.extend(l.childTopic.lineStyle,a,e.lineStyle)},getStyle:function(e){var t,i,n,o,r,l=this.model,s=l.topic,a=this.util.copy(this.styles),c=this.style,d=null;return d=e.root||e.classic?$.extend({},a.common,a.centerTopic):l.getParentTopic(e.parent).root||e.free||e.summary?$.extend({},a.common,a.secTopic):$.extend({},a.common,a.childTopic),"caihongpao"==s.theme?e.root||(l.getParentTopic(e.parent).root?(t=window.localStorage.getItem("branchTopicColors"),o=c.getRadomColor(),(i={})[e.id]=o,t=$.extend(t,i),window.localStorage.setItem("branchTopicColors",JSON.stringify(t)),d.backgroundColor=o,d.border="1px solid "+o):(n=$(".topic-box[id="+e.parent+"]").css("background-color"),d.backgroundColor=n,d.border="1px solid "+n)):window.localStorage.removeItem("branchTopicColors"),(d=$.extend(d,e.style)).lineStype=$.extend(d.lineStyle,e.lineStyle),a.autoColor&&d.border&&d.lineStyle&&!e.root&&(null!=e.style&&null!=e.style.border||(o=c.getLineColor(),""!=(r=d.border.substring(0,d.border.lastIndexOf(" rgb")))&&null!=r||(r=d.border.substring(0,d.border.lastIndexOf(" #"))),d.border=r+" "+o)),d},setTopicStyle:function(e,t,i){var n,o,r,l=e.util,s=e.style.getStyle.call(e,t),a=t.style;e.opts.readonly||(t.style?(n=$.extend(s,a),o=l.getTopicDom(t.id),n["font-family"]=null!=n["font-family"]?n["font-family"]:n.family,n["font-style"]=null!=n["font-style"]?n["font-style"]:n.italic?"italic":"normal",n["font-weight"]=null!=n["font-weight"]?n["font-weight"]:n.bold?"bold":"normal",delete n.family,delete n.italic,delete n.bold,o.removeAttr("style"),o.css(n),null!=n["text-decoration"]&&"none"!=n["text-decoration"]?o.children(".topic").css("text-decoration",n["text-decoration"]):o.children(".topic").removeAttr("style")):(o=l.getTopicDom(t.id),r=e.style.getStyle.call(e,t),e.renderTopicStyle(o,t,r)))},setTopicLineStyle:function(e,t,i){e.util;var n,o,r=e.currentRoot||e.model.topic,l=e.style.getStyle.call(e,t),s=t.lineStyle;e.opts.readonly||t.id==r.id||null==s&&null==l.lineStyle||(n=$.extend(l.lineStyle,s),null!=(o=document.getElementById("line_"+t.id))&&(o.removeAttribute("stroke"),o.removeAttribute("stroke-width"),o.setAttribute("stroke-width",n.lineWidth),o.setAttribute("stroke",n.lineColor)))},setTopicStyles:function(e,t,i,n,o){var r,l,s,a,c,d,p,u=e.util,h=e.line,m=e.model,g=e.currentRoot||e.model.topic,f=e.operation.zoomVal/100;e.opts.readonly||(i=u.copy(i),r=m.getSubTopic(t),l=u.getTopicContainerProp(r.id,f),s=u.copy(t.style),t.style=u.copy(i),t.lineStyle=u.copy(i.lineStyle),null!=t.lineStyle&&(delete t.lineStyle.lineType,delete t.lineStyle.underLine),i=e.style.getStyle.call(e,t),a=u.getTopicDom(t.id),i["font-family"]=null!=i["font-family"]?i["font-family"]:i.family,i["font-style"]=null!=i["font-style"]?i["font-style"]:i.italic?"italic":"normal",i["font-weight"]=null!=i["font-weight"]?i["font-weight"]:i.bold?"bold":"normal",delete i.family,delete i.italic,delete i.bold,delete i.lineStyle.lineType,delete i.lineStyle.underLine,a.removeAttr("style"),a.css(i),null!=i["text-decoration"]&&"none"!=i["text-decoration"]?a.children(".topic").css("text-decoration",i["text-decoration"]):a.children(".topic").removeAttr("style"),e.style.setTopicLineStyle(e,t,n),d=((c=u.getTopicContainerProp(r.id,f)).h-l.h)/2,p=c.w-l.w,e.range.doChangeSubTopicPos(e,r,d,p,n,!0),e.resetTopicExpandPos(a,g.structure),e.connection.resetAllConnectionPos.call(e,g),t.root?(n="left,right,",h.resetSubLines.call(e,n)):h.resetLines.call(e,[r.id],d,n),null==o&&e.messageSource.send.call(e,"setTopicStyle",{content:t.id,original:s,update:u.copy(i),part:n}),u.resetSelectDom())}},mindDesigner.prototype.messageSource={checkLocalStorage:function(){return!!window.localStorage},saveLocal:function(e){var t=e.model.topic,i=e.opts;i.readonly||(t.id,localStorage.setItem("def_"+i.chartId,JSON.stringify(t)),e.events.push("savelocalsuccess"))},checkLocalValue:function(e){var t=localStorage.getItem("def_"+e);return t||null},isUndo:!0,messages:[],send:function(t,i,e){try{var n=this.messageSource;null!=this.currentRoot&&(i.focus=!0),n.messages.push({action:t,content:i}),this.events.push("savelocal"),n.submit(this,e)}catch(e){poCollect1("接口报错:"+t,i,e)}},submit:function(e,t){0<this.messages.length&&this.isUndo&&this.undoStack.push(this,this.messages),"undefined"!=typeof mindColla&&null==t&&mindColla.send(this.messages),this.messages=[]},undoStack:{stack:[],push:function(e,t,i){this.stack.push(t),void 0===i&&(i=!0),i&&(e.redoStack.stack=[]),mind.events.push("undoStackChanged",this.stack.length)},pop:function(e){var t=this.stack,i=t.length;if(0==i)return null;var n=t[i-1];return t.splice(i-1,1),e.messageSource.redoStack.push(n),e.events.push("undoStackChanged",this.stack.length),n}},redoStack:{stack:[],push:function(e){this.stack.push(e),mind.events.push("redoStackChanged",this.stack.length)},pop:function(e){var t=this.stack,i=t.length;if(0==i)return null;var n=t[i-1];return t.splice(i-1,1),e.messageSource.undoStack.push(e.messageSource,n,!1),e.events.push("redoStackChanged",this.stack.length),n}},undo:function(te){var ie,e=te.messageSource,ne=te.connection,oe=te.model,re=te.operation,le=e.undoStack.pop(te);null!=le&&(ie=le.length,e.doWithoutUndo(function(){for(var e=0;e<ie;e++){var t,i,n,o,r,l,s,a,c,d,p,u,h,m,g,f=le[e],v=f.action,y=f.content;if("create"==v){var x=y.content;null!=(R=y.original)&&$.isEmptyObject(R)&&(R=null),te.model.removeTopic.call(te,te.util.copyArray(x),R,!0)}else if("delete"==v){var x=y.content,b=y.index,T=y.parts,C=y.selectedIds;null!=(R=y.original)&&$.isEmptyObject(R)&&(R=null),te.model.addTopicMulti.call(te,te.util.copyArray(x),R,b,T);x.length;if(0<C.length){te.util.clearSelect();for(var S=[],e=0;e<C.length;e++){var w=te.model.getTopicById(C[e]);S.push(w)}te.util.select(S,te)}}else if("updateTitle"==v){var k=y.content,I=y.original,w=oe.getTopicById(k);te.model.updateTopicText.call(te,w,I),te.util.selectOne.call(te,w)}else if("updateImage"==v){var k=y.content,I=y.original,L=(y.update,y.resize),w=oe.getTopicById(k),P=te.util.copy(w);P.image=I,te.model.updateTopicImage.call(te,P,w,L),te.util.selectOne.call(te,w)}else if("setTheme"==v){var I=y.original;te.style.setThemeDirect.call(te,I)}else if("updateStructure"==v){var I=y.original,_=y.oldSums;re.changeStructure.call(te,I,_)}else if("deleteConnection"==v){var M=y.content;te.connection.createConnectionByLines(te,M),te.connection.addConnectionMulti(te,M)}else if("addConnection"==v){M=y.content;te.connection.deleteConnectionMulti(te,M)}else if("updateConnection"==v){var W=y.content,O=y.original;ne.updateConnection(te,O,W),ne.createConnectionByLines(te,[O])}else if("updatePos"==v){var D=y.content,B=y.original,A=y.newIndex,H=y.oldIndex,z=y.oldPart,N=y.newPart,C=y.selectedIds,_=y.oldSums,E=y.newSums;_=null!=_&&$.isEmptyObject(_)?null:_.original,E=null!=E&&$.isEmptyObject(E)?null:E.original;try{te.model._updateTopicPos.call(te,B,H,D,A,_,E,N,z,null,C)}catch(e){poCollect1("拖拽接口报错:_updatePos",B,e)}}else if("changeToFreeTopic"==v){var R,F=y.content,V=y.original,j=y.index,Y=y.part;null!=(R=y.updates_origi)&&$.isEmptyObject(R)&&(R=null);var K,X=te.util.copy(F),U=oe.getTopicById(V),q=U.children,G={};X.parent=V,"left"==Y&&U.root&&(q=U.leftChildren),delete X.pos,delete X.free,0==j?(null==(K=oe.getTopicByIndex(j,q))?(G.pos="in",G.id=V):(G.id=K.id,G.pos="before"),G.index=j):null==(K=oe.getTopicByIndex(j-1,q))?(G.id=V,G.pos="in",G.index=j):(G.id=K.id,G.pos="after");try{te.model.updateTopicPos.call(te,[X],R,G,!0,Y)}catch(e){poCollect1("拖拽接口报错:updatePos",[X],e)}te.util.selectOne.call(te,X)}else if("updateFreeTopic"==v){for(var J=y.original,Z=y.topicIds,x=[],e=0;e<Z.length;e++){var Q=Z[e],X=oe.getTopicById(Q);x.push(X)}var ee=y.oldLines,M=y.lines;oe.updateFreeTopicPos.call(te,x,J,ee,M)}else{"update"==v?(x=y.content,t=y.original,X=y.type,oe.updateTopicNode.call(te,t,x,X,!0)):"addFreeTopic"==v?(w=y.content,te.model.removeTopic.call(te,[w],null,!0)):"updateBg"==v?(i=y.original,te.operation.setBackground.call(te,i,!0)):"setThemeOverWrite"==v?(n=y.original,o=y.tps,te.style.setThemeOverWrite_.call(te,n,o,"add")):"setTopicStyle"==v?(r=y.original,Q=y.content,X=oe.getTopicById(Q),Y=y.part,te.style.setTopicStyles(te,X,r,Y)):"changetopicexpand"==v?(l="show"==y.type?"hide":"show",Q=y.content,te.operation.showOrHideChildren.call(te,Q,l)):"insertParent"==v?(w=y.content,s=y.original,Y=y.part,te.model.unInsertParentTopic.call(te,w,s,Y)):"addSummary"==v?(a=y.content,T=y.parts,null!=(R=y.original)&&$.isEmptyObject(R)&&(R=null),te.model.removeTopic.call(te,te.util.copyArray(a),R,!0)):"deleteSummary"==v?(a=y.content,te.summary.model.addSummary.call(te,a)):"updateSummary"==v?(O=y.original,y=y.content,te.summary.updateSummary.call(te,O,y)):"focus"==v?(null==(O=y.sourceId)&&(O="root"),null==y.local?te.operation.focusTopic.call(te,O,!0):te.operation.focusTopic.call(te,O)):"deleteSelf"==v?(d=y.removed,p=y.add,u=y.addPart,h=y.removedPart,c=y.removedIndex,te.model.addAndRemove.call(te,d,p,h,u,c)):"deleteSelfRestore"==v?(d=y.removed,p=y.add,u=y.addPart,h=y.removedPart,te.model.removeAndAdd.call(te,d,p,h,u)):"hideTopics"==v?(m=y.ids,T=y.parts,g=y.withChildren,te.model.showTopics.call(te,m,g)):"showTopics"==v?(m=y.ids,T=y.parts,g=y.withChildren,te.model.hideTopics.call(te,m,g)):"updatePage"==v?(y.content,I=y.original,mind.operation.setMargin.call(te,I)):"setWatermark"==v&&(y.content,(I=y.original)?mind.operation.setWatermark.call(mind,I,null):mind.operation.clearWatermark.call(mind))}}}))},redo:function(Z){var Q,e=Z.messageSource,ee=Z.connection,te=Z.model,ie=Z.operation,ne=e.redoStack.pop(Z);null!=ne&&(Q=ne.length,e.doWithoutUndo(function(){for(var e=0;e<Q;e++){var t,i,n,o,r,l,s,a,c,d,p,u,h,m,g,f,v,y,x,b=ne[e],T=b.action,C=b.content;if("create"==T){var S=C.content,w=C.index,k=C.parts;null!=(j=C.updates)&&$.isEmptyObject(j)&&(j=null),Z.model.addTopicMulti.call(Z,S,j,w,k),Z.util.selectDirect(S,Z)}else if("delete"==T){var S=C.content;null!=(j=C.updates)&&$.isEmptyObject(j)&&(j=null),Z.model.removeTopic.call(Z,S,j,!0)}else if("updateTitle"==T){var I=C.content,L=C.update,P=te.getTopicById(I);Z.model.updateTopicText.call(Z,P,L),Z.util.selectOne.call(Z,P)}else if("updateImage"==T){var I=C.content,L=C.update,_=(C.original,C.resize),P=te.getTopicById(I),M=Z.util.copy(P);M.image=L,Z.model.updateTopicImage.call(Z,M,P,_),Z.util.selectOne.call(Z,P)}else if("setTheme"==T){var C=C.content;Z.style.setThemeDirect.call(Z,C)}else if("updateStructure"==T){var W=(C=C.content).newSums;ie.changeStructure.call(Z,C,W)}else if("deleteConnection"==T){var O=C.content;Z.connection.deleteConnectionMulti(Z,O)}else if("addConnection"==T){O=C.content;Z.connection.createConnectionByLines(Z,O),Z.connection.addConnectionMulti(Z,O)}else if("updateConnection"==T){var D=C.content,B=C.original;ee.updateConnection(Z,D,B),ee.createConnectionByLines(Z,[D])}else if("updatePos"==T){var A=C.content,H=C.original,z=C.newIndex,N=C.oldIndex,E=C.oldPart,R=C.newPart,F=C.selectedIds,V=C.oldSums,W=C.newSums,V=null!=V&&$.isEmptyObject(V)?null:V.updates;W=null!=W&&$.isEmptyObject(W)?null:W.updates;try{Z.model._updateTopicPos.call(Z,A,z,H,N,W,V,E,R,null,F)}catch(e){poCollect1("拖拽接口报错:_updatePos",A,e)}}else if("changeToFreeTopic"==T){var j,Y=C.content,K=C.original,w=C.index;null!=(j=C.updates)&&$.isEmptyObject(j)&&(j=null);var X=Z.util.copy(Y),U=X.pos;delete X.pos,delete X.free,X.parent=K,te.changeToFreeTopic.call(Z,X,j,U)}else if("updateFreeTopic"==T){for(var U=C.content,q=C.topicIds,S=[],e=0;e<q.length;e++){var G=q[e],J=te.getTopicById(G);S.push(J)}te.updateFreeTopicPos.call(Z,S,U)}else{"update"==T?(S=C.content,t=C.original,J=C.type,te.updateTopicNode.call(Z,S,t,J,!0)):"addFreeTopic"==T?(P=C.content,te.addFreeTopic(P,P.pos,Z)):"updateBg"==T?(i=C.content,Z.operation.setBackground.call(Z,i,!0)):"setThemeOverWrite"==T?(n=C.content,o=C.tps,Z.style.setThemeOverWrite_.call(Z,n,o,"delete")):"setTopicStyle"==T?(r=C.update,G=C.content,J=te.getTopicById(G),a=C.part,Z.style.setTopicStyles(Z,J,r,a)):"changetopicexpand"==T?(l=C.type,G=C.content,Z.operation.showOrHideChildren.call(Z,G,l)):"insertParent"==T?(P=C.content,s=C.original,a=C.part,Z.model.insertParentTopic.call(Z,P,s,a)):"addSummary"==T?(c=C.content,Z.summary.model.addSummary.call(Z,c)):"deleteSummary"==T?(c=C.content,k=C.parts,Z.summary.model.removeSummary.call(Z,c,k)):"updateSummary"==T?(B=C.original,C=C.content,Z.summary.updateSummary.call(Z,C,B)):"focus"==T?(d=C.targetId,null==C.local?Z.operation.focusTopic.call(Z,d,!0):Z.operation.focusTopic.call(Z,d)):"deleteSelf"==T?(p=C.removed,u=C.add,h=C.addPart,m=C.removedPart,Z.model.removeAndAdd.call(Z,p,u,m,h)):"deleteSelfRestore"==T?(p=C.removed,u=C.add,h=C.addPart,m=C.removedPart,g=C.removedIndex,Z.model.addAndRemove.call(Z,p,u,m,h,g)):"hideTopics"==T?(f=C.ids,k=C.parts,v=C.withChildren,Z.model.hideTopics.call(Z,f,v)):"showTopics"==T?(f=C.ids,k=C.parts,v=C.withChildren,Z.model.showTopics.call(Z,f,v)):"updatePage"==T?(y=C.content,C.original,mind.operation.setMargin.call(Z,y)):"setWatermark"==T&&(x=C.content,C.original,x?mind.operation.setWatermark.call(mind,x,null):mind.operation.clearWatermark.call(mind))}}}))},doWithoutUndo:function(e){this.isUndo=!1,e(),this.isUndo=!0},excuteMsgDirect:function(e,t){var i=this,n=i.model,o=(e.uk,e.client),r=e.msg,l=[],s=i.operation;if(null==e.type||"forceRefresh"!=e.type){for(var a=0;a<r.length;a++){var c,d,p,u,h,m,g,f,v,y,x,b,T,C,S,w,k,I,L,P=r[a],_=P.action,M=P.content;if("create"==_){var W=M.content,O=M.index,D=M.parts;null!=(Q=M.updates)&&$.isEmptyObject(Q)&&(Q=null),n.addTopicMulti.call(i,W,Q,O,D,!0),l.push(W[0].id)}else if("delete"==_){var W=M.content;null!=(Q=M.updates)&&$.isEmptyObject(Q)&&(Q=null),i.model.removeTopic.call(i,W,Q,!0,!0)}else if("updateTitle"==_){var B=M.content,A=M.update,H=n.getTopicById(B);i.model.updateTopicText.call(i,H,A,!0),l.push(H.id)}else if("updateImage"==_){var B=M.content,A=M.update,z=(M.original,M.resize),H=n.getTopicById(B),N=i.util.copy(H);N.image=A,i.model.updateTopicImage.call(i,N,H,z,!0),l.push(H.id)}else if("setTheme"==_){var M=M.content;i.style.setThemeDirect.call(i,M,!0)}else if("updateStructure"==_){var E=(M=M.content).newSums;s.changeStructure.call(i,M,E,null,!0)}else if("deleteConnection"==_){var R=M.content;i.connection.deleteConnectionMulti(i,R,!0)}else if("addConnection"==_){R=M.content;i.connection.createConnectionByLines(i,R),i.connection.addConnectionMulti(i,R,!0)}else if("updateConnection"==_){var F=M.content,V=M.original;i.connection.updateConnection(i,F,V,!0),i.connection.createConnectionByLines(i,[F])}else if("updatePos"==_){var j=M.content,Y=M.original,K=M.newIndex,X=M.oldIndex,U=M.oldPart,q=M.newPart;if(M.moveFromOutline){var G=M.target;n.updateTopicPos.call(i,j,null,G,null,null,null,!0);continue}var J=M.selectedIds,Z=M.oldSums,E=M.newSums,Z=(null==Z||!$.isEmptyObject(Z))&&Z?Z.updates:null;E=(null==E||!$.isEmptyObject(E))&&E?E.updates:null;try{i.model._updateTopicPos.call(i,j,K,Y,X,E,Z,U,q,!0,J)}catch(e){poCollect1("拖拽接口报错:_updatePos",j,e)}}else if("changeToFreeTopic"==_){var Q,ee=M.content,te=M.original,O=M.index;null!=(Q=M.updates)&&$.isEmptyObject(Q)&&(Q=null);var ie=i.util.copy(ee),ne=ie.pos;delete ie.pos,delete ie.free,ie.parent=te,n.changeToFreeTopic.call(i,ie,Q,ne,!0)}else if("updateFreeTopic"==_){for(ne=M.content,l=(M.original,M.topicIds),W=[],a=0;a<l.length;a++){var oe=l[a],re=n.getTopicById(oe);W.push(re)}n.updateFreeTopicPos.call(i,W,ne,null,null,!0)}else{"update"==_?(W=M.content,c=M.original,re=M.type,n.updateTopicNode.call(i,W,c,re,!0,!0),l.push(H.id)):"addFreeTopic"==_?(H=M.content,n.addFreeTopic(H,H.pos,i,!0),l.push(H.id)):"updateBg"==_?(d=M.content,i.operation.setBackground.call(i,d,!0,!0)):"setThemeOverWrite"==_?(p=M.content,u=M.tps,i.style.setThemeOverWrite_.call(i,p,u,"delete",!0)):"setTopicStyle"==_?(h=M.update,oe=M.content,re=n.getTopicById(oe),f=M.part,i.style.setTopicStyles(i,re,h,f,!0),l.push(re.id)):"changetopicexpand"==_?(m=M.type,oe=M.content,i.operation.showOrHideChildren.call(i,oe,m,!0),l.push(oe)):"insertParent"==_?(H=M.content,g=M.original,f=M.part,i.model.insertParentTopic.call(i,H,g,f,!0)):"addSummary"==_?(v=M.content,i.summary.model.addSummary.call(i,v,!0)):"deleteSummary"==_?(v=M.content,D=M.parats,i.summary.model.removeSummary.call(i,v,D,!0)):"updateSummary"==_?(V=M.original,M=M.content,i.summary.updateSummary.call(i,M,V,!0)):"focus"==_?(y=M.targetId,i.operation.focusTopic.call(i,y,!0,!0)):"deleteSelf"==_?(x=M.removed,b=M.add,T=M.addPart,C=M.removedPart,i.model.removeAndAdd.call(i,x,b,C,T,!0)):"deleteSelfRestore"==_?(x=M.removed,b=M.add,T=M.addPart,C=M.removedPart,S=M.removedIndex,i.model.addAndRemove.call(i,x,b,C,T,S,!0)):"hideTopics"==_?(w=M.ids,D=M.parts,k=M.withChildren,i.model.hideTopics.call(i,w,k,!0),mind.plugins.navigator.init.call(mind)):"showTopics"==_?(w=M.ids,D=M.parts,k=M.withChildren,i.model.showTopics.call(i,w,k,!0),mind.plugins.navigator.init.call(mind)):"updatePage"==_?(I=M.content,M.original,mind.operation.setMargin.call(i,I,!0)):"setWatermark"==_&&(L=M.content,M.original,L?mind.operation.setWatermark.call(mind,L,!0):mind.operation.clearWatermark.call(mind,!0))}}null!=t&&t(l,o)}else i.events.push("refresh")}},mindDesigner.prototype.plugins={showContextMenu:function(e,t){var s=this,a=s.model,c=s.util,d=s.connection,p=s.operation,u=s.plugins;s.events.push("hidepopeditor"),s.operation.hideLink();$(window).width(),$(window).height();var i,n,o,r,l,h,m,g=$(".mind-context-menu");g.is(":visible")||(g.attr("activeId",t),g.hide(),p.zoomVal,n=(i=c.getRealPos.call(s,e.offset().left,e.offset().top)).x,o=i.y,e.outerHeight(),r=e.outerWidth(),g.appendTo(s.designer),g.css({left:n+r,top:o-30,opacity:0}).show(),l=n+r,h=o-30,e.offset().top,g.outerHeight(),e.offset().left,g.outerWidth(),g.stop().animate({left:l,top:h,opacity:1,"z-index":9},10),m=a.getTopicById(t),mind.events.push("setContextMenu",m),g.children(".mind-context-menu-content").find("li").off().on("click",function(e){var t=$(this),i=t.attr("op");if(!t.hasClass("disable")){if("copy"==i)0<(o=c.selectedIds).length&&a.doCopy.call(s,o);else if("cut"==i){0<(o=c.selectedIds).length&&a.doCut.call(s,o)}else if("paste"==i){""!=(o=c.getSelectedId())&&a.doPaste.call(s,o);var n=a.getTopicById(o);c.selectOne.call(s,n)}else if("insert-child"==i)p.appendTopic.call(s,!0);else if("remark"==i)console.log("beizhu"),mind.events.push("showRight","remark");else if("link"==i)p.showLink.call(s);else if("tag"==i)s.tags.showTag.call(s);else if("task"==i)s.task.showTask.call(s);else if("style"==i)mind.events.push("showStyle");else if("insert-siblings"==i)p.appendTopic.call(s,!1);else if("insert-parent"==i){var o=c.selectedIds,r=mind.model.getTopicById(o[0]);p.insertParent.call(s,r)}else if("insert-connection"==i)d.render.call(mind,e);else if("delete"==i)p.removeTopic.call(s);else if("delete-self"==i)p.removeTopicSelf.call(s);else if("focus"==i)p.focusTopic.call(s);else if("hideall"==i)p.hideTopics.call(s,!0);else if("openall"==i)p.showTopics.call(s,!0);else if("expand"==i){if(t.hasClass("disable"))return;var o=c.selectedIds,l=(r=mind.model.getTopicById(o)).collapsed?"show":"hide";s.operation.showOrHideChildren.call(s,o,l)}else"download-part"==i&&mind.events.push("downloadPart",s.util.getSelectedId());u.hideContextMenu()}}))},hideContextMenu:function(){$(".mind-context-menu").hide()},showSummaryTip:function(e,t){var i,n,o,r,l,s=$("#"+t).find(".summary-dot");0<s.length&&(i=e.util.getSelectedPartByPos(t),n=$(".mind-summary-menu"),r=(o=s.offset()).left+20,l=o.top+n.height()/2,"left"==i&&(r=o.left-n.width()),r<10&&(r=10),n.css({left:r,top:l}),n.show(),e.summary.initEvent.call(e,t))},hideSummaryTip:function(){$(".mind-summary-menu").hide()},showConnectionTip:function(e,t){var i=$(".mind-connection-menu"),n=$(".mind-connection-con[conn="+e.id+"]").find(".mind-icons"),o=n.offset();i.css({left:o.left+n.outerWidth()+10,top:o.top+n.outerHeight()/2-4}),i.find(".active").removeClass("active");var r=e.styles,l=r.lineColor;null!=l&&0<=l.indexOf("rgb")&&(l=t.util.getHexColor(l).hex),null!=l&&i.find("[ac="+l+"]").addClass("active"),i.find("[alt=type] [ac="+r.lineType+"]").addClass("active"),i.find("[alt=width] [ac="+r.lineWidth+"]").addClass("active"),i.find("[alt=arrow] [ac="+r.lineArrow+"]").addClass("active"),i.show()},hideConnectionTip:function(){$(".mind-connection-menu").hide(),this.hideSummaryTip()},showIconsMenu:function(u,e){var h=this,m=h.icons;$("#mind-icons-box").remove();var g=$("<div id='mind-icons-box' class='mind-icons-box'></div>").appendTo(h.designer),t=m.icons[u.name];function i(e,t){var i,n,o,r,l=[];if(e){l=["<div class='topic-box-list mind-tags-icons'><div>"];for(var s=0,a=e.length;s<a;s++){var c=e[s];u.url?l.push(c):l.push("<span n='"+u.name+"' ico='"+c.index+"' class='mind-icons'>"+c.text+"</span>")}}if($.fn.showPanel({target:t,panel:g,show:!0}),u.url)l.push("<div class='remove-icon-btn' style='margin-top:16px;'><span remove='true' class='remove-icon'>删除图标</span></div>");else{l.push("<span style='clear:both;'></span></div></div><div class='sep'></div>"),l.push("<div class='topic-box-list mind-tags-color'><div class='mind-icons-color'>");for(var d=mind.style.baseColor(),s=0,a=d.length;s<a;s++){var p=d[s];l.push("<span style='background:"+p+";'></span>")}l.push("</div></div><div class='sep'></div><div class='remove-icon-btn'><span remove='true' class='remove-icon'>删除图标</span></div>")}g.html(l.join("")),i=u,o=t,(n=g).find("span").removeClass("selected"),""==i.name||i.url?o.parent().find("span[n=''],span[iconimg]").each(function(){var e=$(this);n.find("span[ico="+e.attr("ico")+"]").addClass("selected")}):n.find("span[ico="+i.index+"]").addClass("selected"),r=t,$(document).off("mouseup.icons").on("mouseup.icons",function(e){$("#mind-icons-box").remove(),r.removeClass("selected")}),$(document).on("mouseup.icons","#mind-icons-box",function(e){e.stopPropagation()}),$(document).on("mousedown.icons","#mind-icons-box",function(e){e.stopPropagation()}),$(document).off("click.icons").on("click.icons","#mind-icons-box .mind-icons, #mind-icons-box .remove-icon",function(e){e.stopPropagation();var t=$(this),i=$(this).attr("iconimg");t.attr("id"),t.attr("mobantype");if(t.attr("n")&&$("#mind-icons-box .mind-icons").removeClass("selected"),t.attr("remove"))m.removeIcon.call(h),g.remove();else{if(t.attr("iconimg"))return void mind.icons.setIcon.call(mind,t,null,null,i);m.setIcon.call(h,t,!0)}}),$(document).off("click.iconcolors").on("click.iconcolors",".mind-icons-color span",function(e){var t=$(this).css("background-color");m.setIconColor.call(h,t),e.stopPropagation()}),h.events.push("iconStyle")}u.url&&!m.docerIcon.length?i(null,e):(u.url&&(t=m.docerIcon),i(t,e))},selectDefaultIcon:function(){},hideIconsMenu:function(){},showTopicsLen:function(){var e=this.util,t=$("#mind_topics_details").find(".topics_details_len"),i=e.selectedIds.length,n=e.getTopicsLen.call(this);i&&0<i&&(n=i+"/"+e.getTopicsLen.call(this)),t.html(n)},showGlobalMenu:function(n,e,t){var i=$(".mind-context-global-menu");i.length&&(i.css({left:e,top:t,opacity:1}).show(),n.currentRoot,mind.events.push("setContextMenuGlobal",n),i.find("li").off().on("click",function(e){var t=$(this),i=t.attr("op");t.hasClass("disable")||("torefresh"==i?window.location.reload():"tonew"==i?n.events.push("toNew"):"insert-free"==i||("tocenter"==i?n.operation.moveToCenter.call(n):"hideall"==i?n.operation.hideTopics.call(n,!1):"openall"==i&&n.operation.showTopics.call(n,!1)),n.plugins.closeGlobalMenu())}))},closeGlobalMenu:function(e,t){var i=$(".mind-context-global-menu");i.length&&i.hide().css({opacity:0})},navigator:{baseCalc:null,globalPos:null,init:function(){var e,t,i,n,o,r,l,s;"undefined"!=typeof showCanvas&&(e=this.plugins.navigator,0==(t=$(".mind-canvas-con")).length&&(i="",n="关闭视图导航","false"==showCanvas&&(i='style="display:none;"',n="显示视图导航"),t=$('<div class="mind-canvas-con"><div id="mind_topics_details" class="mind_topics_details" ><span class="topics_details_len"></span> 个节点</div><div style="position:absolute;bottom:32px;right:10px;"><div '+i+' class="mind-canvas"><canvas></canvas></div></div><div class="mind-canvas-op"></div></div>'),$("body").append(t),r='<span title="'+n+'" title_pos="top" tit="close" class="mind-icons">&#xe730;</span><span title="定位到中心主题" title_pos="top" tit="focus" class="mind-icons">&#xe72e;</span><span title="收起节点" title_pos="top" tit="hideall" class="mind-icons">&#xe76a;</span><span><label class="sep" style="height:12px"></label></span><span tit="full" title="全屏模式" title_pos="top" class="mind-icons">&#xe71f;</span><span  style="margin-right:10px;" title="缩小" title_pos="top" tit="zoomout" class="mind-icons mind-zoomout">&#xe720;</span><span title_pos="top" title="还原" tit="zoomtext" class="mind-zoomtxt">100%</span><span title="放大" title_pos="top" tit="zoomin" class="mind-icons mind-zoomin">&#xe724;</span>',(o=t.children(".mind-canvas-op")).append(r),"false"==showCanvas&&o.children("[tit=close]").addClass("nav-active")),l=e.calcPos(!1,!0),e.globalPos=l,s=e.calcCanvasSize(l,250,171),e.setCanvasStyle(s.w,s.h),e.render(l,s,250,171),e.initEvent(this))},initEvent:function(s){var a=$(".mind-canvas-con"),t=a.children(".mind-canvas-op"),c=($("#mind_con").children(".mind-designer"),this);t.children().off("mousedown").on("mousedown",function(e){$(document).on("selectstart",function(){return!1});var t,i,n,o,r=$(this),l=r.attr("tit");"full"==l?((t=document.documentElement).requestFullscreen?t.requestFullscreen():t.mozRequestFullScreen?t.mozRequestFullScreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen(),$(document).off("selectstart"),e.stopPropagation()):"exitFull"==l?((i=document.exitFullscreen||document.mozCancelFullScreen||document.webkitExitFullscreen||document.webkitExitFullscreen)?i.call(document):void 0===window.ActiveXObject||null!==(n=new ActiveXObject("WScript.Shell"))&&n.SendKeys("{F11}"),e.stopPropagation()):"focus"==l?s.operation.moveToCenter.call(s):"zoomout"==l?(s.operation.zoomOut.call(s,s.designer),o=s.operation.zoomVal,a.find(".mind-zoomtxt").text(o+"%")):"zoomin"==l?(s.operation.zoomIn.call(s,s.designer),o=s.operation.zoomVal,a.find(".mind-zoomtxt").text(o+"%")):"zoomtext"==l?(s.operation.zoomVal=85,s.operation.zoomIn.call(s,s.designer),a.find(".mind-zoomtxt").text("100%")):"hideall"==l?(s.operation.hideTopics.call(s,!1),r.attr("tit","openall"),r.html("&#xe773;"),r.attr("title","展开节点"),$("#mind_hover_tip:visible").find(".tip_content").html("展开节点")):"openall"==l?(s.operation.showTopics.call(s,!1),r.attr("tit","hideall"),r.html("&#xe76a;"),r.attr("title","收起节点"),$("#mind_hover_tip:visible").find(".tip_content").html("收起节点")):"close"==l&&(r.hasClass("nav-active")?(c.showCanvas(),r.removeClass("nav-active"),s.operation.setConfig("canvas","true"),r.attr("title","关闭视图导航"),$("#mind_hover_tip:visible").find(".tip_content").html("关闭视图导航")):(c.hideCanvas(),r.addClass("nav-active"),s.operation.setConfig("canvas","false"),r.attr("title","显示视图导航"),$("#mind_hover_tip:visible").find(".tip_content").html("显示视图导航")))}),t.children().off("mouseup").on("mouseup",function(){$(document).off("selectstart")}),window.onresize=function(){var e;document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen||document.webkitFullScreen||document.msFullScreen?(console.log("全屏状态"),(e=t.children("[tit=full]")).attr("tit","exitFull"),e.html("&#xe775;"),e.attr("title","退出全屏"),$("#mind_hover_tip:visible").find(".tip_content").html("退出全屏")):t.children("[tit=exitFull]").length&&(console.log("退出全屏"),(e=t.children("[tit=exitFull]")).attr("tit","full"),e.html("&#xe71f;"),e.attr("title","全屏模式"),$("#mind_hover_tip:visible").find(".tip_content").html("全屏模式"))}},resetCanvas:!0,showCanvas:function(){$(".mind-canvas").show()},hideCanvas:function(){$(".mind-canvas").hide()},render:function(u,e,t,i){var n,o,h,m,r,g;this.resetCanvas&&(n=$("#mind_con").children(".mind-designer").find(".topic-box"),o=$(".mind-canvas").children("canvas")[0],(h=o.getContext("2d")).clearRect(0,0,o.width,o.height),m=e.w/u.w,r=mind,g=r.currentRoot||r.model.topic,this.baseCalc=m,n.each(function(e,t){var i=$(t),n=i.offset(),o=i.attr("id"),r=n.left,l=n.top,s=i.outerWidth()*m,a=i.outerHeight()*m,c=(r-u.x)*m,d=(l-u.y)*m,p=i[0].style.backgroundColor;h.save(),o==g.id?("rgb(255, 255, 255)"==p&&(p="#57a8ca"),h.fillStyle=p):h.fillStyle="#d0d0d0",h.fillRect(c,d,s,a),h.restore()}),this.renderViewport(u,m))},renderViewport:function(){var e,t,i,n,o,r,l,s,a,c,d,p;!this.resetCanvas||0!=(t=(e=$(".mind-canvas")).find("canvas")).length&&(i=this.baseCalc,n=this.calcPos(!1,!0),this.globalPos=n,o=this.calcPos(!0,!1),isNaN(o.w)||isNaN(o.h)?$(".viewport").hide():($(".viewport").show(),r=t.position().left,l=t.position().top,s=o.x-n.x,a=o.y-n.y,0==(c=e.children(".viewport")).length&&(c=$('<div class="viewport"></div>'),$(".mind-canvas").append(c)),d=o.w*i,p=o.h*i,c.css({left:s*i+r,top:a*i+l,width:d-4,height:p-4}),this.initViewportEvent()))},initViewportEvent:function(m){var p=$(".mind-canvas"),m=(p.find("canvas"),p.children(".viewport")),g=this.baseCalc,u=this,i=$(document);m.on("mousedown",function(e){var s=e.pageX,a=e.pageY,c=m.position().left,d=m.position().top,t=(m.outerWidth(),m.outerHeight(),m.parent()),p=(t.width(),t.height(),$("#mind_con")),u=p.scrollLeft(),h=p.scrollTop();i.on("selectstart",function(){return!1}),i.off("mousemove.nav").on("mousemove.nav",function(e){var t=e.pageX,i=e.pageY,n=t-s,o=i-a,r=c+n,l=d+o;m.css({left:r,top:l}),p.scrollLeft(u+n/g),p.scrollTop(h+o/g),e.stopPropagation()}),i.off("mouseup.nav").on("mouseup.nav",function(e){i.off("mousemove.nav"),i.off("mouseup.nav"),i.off("selectstart"),e.stopPropagation()}),e.stopPropagation()}),p.off("mousedown").on("mousedown",function(e){var t=$("#mind_con"),i=t.scrollLeft(),n=t.scrollTop(),o=p.children(".viewport");if(!o.is(":visible"))return o.css({width:120,height:60,left:65,top:55.5}).show(),mind.operation.moveToCenter.call(mind),void e.stopPropagation();var r=o.position().left,l=o.position().top,s=o.width(),a=o.height(),c=e.offsetX-s/2,d=e.offsetY-a/2;o.css({left:c,top:d}),t.scrollLeft(i+(c-r)/g),t.scrollTop(n+(d-l)/g),u.renderViewport(),e.stopPropagation()}),p.off("mouseup").on("mouseup",function(e){i.off("mousemove.nav"),i.off("mouseup.nav"),i.off("selectstart"),u.renderViewport()})},setCanvasStyle:function(e,t){$("#mind_con").children(".mind-designer");var i=$(".mind-canvas").children("canvas")[0];i.width=e,i.height=t},calcCanvasSize:function(e,t,i){var n=e.w*i/e.h,o=i;return t<n&&(n=t,o=e.h*t/e.w),{w:n,h:o}},calcPos:function(o,e){var t=null,t=e?$(".mind-designer").children(".topic-container"):$(".mind-designer").find(".topic-box"),r="first",l=0,s=0,a=0,c=$(window).width(),d=$(window).height();return t.each(function(e,t){var i=$(t),n=i.offset();return!!(o&&n.left<0)||(!!(o&&n.top<0)||(!!(o&&n.top+i.outerHeight()>d)||(!!(o&&n.left+i.outerWidth()>c)||("first"==r&&(r=n.left,l=n.top),n.left<r&&(r=n.left),n.top<l&&(l=n.top),n.left+i.outerWidth()>s&&(s=n.left+i.outerWidth()),void(n.top+i.outerHeight()>a&&(a=n.top+i.outerHeight()))))))}),{x:r,y:l,w:s-r,h:a-l}}},presenter:{sliders:[],sliderIndex:0,selecting:!1,presenting:!1,presentingIndex:0,beforeSelecting:!1,ready:function(e){if(0==this.sliders.length)return $.showTip("close"),void $.showTip("[ Cril + 拖拽 ] 选择并添加幻灯片",2e3);e.util.clearSelect(),e.events.push("hideElements"),this.renderControls(e),this.presenting=!0},calcScale:function(e){var t=$(window).width()-80,i=$(window).height()-40,n=t/e.w,o=i/e.h;return n<=o?n:o},keyEvent:function(e,t){37==e.keyCode||38==e.keyCode?this.presenting&&this.prevSlide(t):39==e.keyCode||40==e.keyCode?this.presenting&&this.nextSlide(t):46==e.keyCode||8==e.keyCode?(this.deleteSlider(this.sliderIndex),this.saveSliders(t)):27==e.keyCode&&this.exitShowSlide(t)},nextSlide:function(e){this.presentingIndex++,this.toSlide(e,this.presentingIndex)},prevSlide:function(e){this.presentingIndex--,this.toSlide(e,this.presentingIndex)},toSlide:function(e,t){var i,n,o,r,l,s,a,c,d=this.sliders,p=d[t];null!=p?(this.presentingIndex=t,i=p.pos,n=this.calcScale(i),o=$(window).width(),r=$(window).height(),l=e.container,s=e.designer,a=i.x-o/2+i.w/2,c=i.y-r/2+i.h/2,l.stop().animate({scrollLeft:a,scrollTop:c},500),s.css({"transform-origin":i.x+i.w/2+"px "+(i.y+i.h/2)+"px 0px",transition:"all 1s",transform:"scale("+n+")"}),e.operation.zoomVal=100*n,$(".mind-slide-controls").children().removeClass("active"),$(".mind-slide-controls").children().eq(t).addClass("active"),this.changeTopicStatus(t,e)):t>=d.length?this.presentingIndex=d.length-1:t<0&&(this.presentingIndex=0)},exitShowSlide:function(e){e.container;e.designer.css({"transform-origin":"50% 50%",transition:"all 1s",transform:"scale(1)"}),e.operation.moveToCenter.call(e),e.events.push("showElements"),e.operation.zoomVal=100},changeTopicStatus:function(e,t){var i=this.sliders;$(".topic-box").addClass("mind-slide-disable"),$("g").children("path").css({opacity:"0.06"});for(var n=0;n<i.length;n++)if(n==e){var o=i[n].ids;$(o).removeClass("mind-slide-disable");for(var r=o.split(","),l=0,s=r.length;l<s;l++){var a=r[l].substring(1),c=t.connection.getConnectionsByTopic.call(t,a);if($("#line_"+a).css({opacity:1}),0<$("#sum_"+a).length&&$("#sum_"+a).css({opacity:1}),0<c.length)for(var d=0;d<c.length;d++){var p=c[d].id;$("#line_"+p).children("path").css({opacity:1})}}}},renderSelections:function(e){var t=this.sliders,i=t.length,n=this;if($(".mind-slide-selection").remove(),0<i){for(var o=0;o<i;o++){var r=t[o],l=$("<div idx="+r.index+" class='mind-slide-selection'><span class='selection-index'>"+(r.index+1)+"</span></div>");l.appendTo(".mind-designer"),l.css({left:r.pos.x,top:r.pos.y,width:r.pos.w,height:r.pos.h}),l.find(".selection-index").show()}$(document).off("click.mss",".mind-slide-selection").on("click.mss",".mind-slide-selection",function(){var e=$(this);n.focusSelection(e)}),n.initDotEvent(e)}return i},renderControls:function(t){for(var i=this,e=this.sliders,n="<div class='mind-slide-controls'>",o=0;o<e.length;o++)n+="<span idx='"+o+"'></span>";n+="</div>",$(n).appendTo("body").css({left:"50%"}),$(document).off("click.slidecontrols",".mind-slide-controls > span").on("click.slidecontrols",".mind-slide-controls > span",function(){var e=$(this).attr("idx");i.toSlide(t,e)})},renderSelection:function(){var t=this,e=$("<div class='mind-slide-selection'><span class='selection-index'></span></div>");return e.appendTo(".mind-designer"),this.focusSelection(e),$(document).off("click.mss",".mind-slide-selection").on("click.mss",".mind-slide-selection",function(){var e=$(this);t.focusSelection(e)}),e},focusSelection:function(e){$(".selection-dot").remove(),$(".selection-del").remove(),e.addClass("active"),e.siblings(".mind-slide-selection").removeClass("active");var t=$("<span title='删除' onclick='mind.plugins.presenter.deleteOneSlider.call(mind)' class='selection-del mind-icons'>&#xe60c;</span><span class='selection-dot lt'></span><span class='selection-dot rt'></span><span class='selection-dot lb'></span><span class='selection-dot rb'></span>");this.sliderIndex=e.attr("idx"),t.appendTo(e)},setSelectionPos:function(e,t){e.css({left:+t.x,top:+t.y,width:t.w+0,height:t.h+0})},deleteOneSlider:function(){var e=this.plugins.presenter;e.deleteSlider(e.sliderIndex),e.saveSliders(this),$("#mind_hover_tip").remove()},deleteSlider:function(e){$(".mind-slide-selection[idx="+e+"]").remove(),this.sliders.splice(e,1);for(var t=this.sliders.length,i=0;i<t;i++){e<=i&&(--this.sliders[i].index,$(".mind-slide-selection[idx="+(i+1)+"]").attr("idx",i),$(".mind-slide-selection[idx="+i+"]").children("span").text(i+1))}},resetSelectionByTopics:function(e,t,i,n,o){for(var r=$(".topic-box.selected"),l=e.x,s=e.y,a=e.x+e.w,c=e.y+e.h,d=0,p=r.length;d<p;d++){var u=$(r[d]),h=u.offset(),m=u.outerWidth(),g=u.outerHeight(),f=h.left/o,v=h.top/o;t+f<l&&(l=t+f),a<t+f+m&&(a=t+f+m),i+v<s&&(s=i+v),c<i+v+g&&(c=i+v+g)}h={x:l,y:s,w:a-l,h:c-s};return this.setSelectionPos(n,h),h},setSelectedRealTime:function(e,t,i,n,o){var r={x:e.x-t,y:e.y-i,w:e.w,h:e.h},l=o.util.getTopicsByRange(r,n);if(0==l.length)return l;l[0]="#"+l[0];var s=l.join(",#");return $(".topic-box").removeClass("selected"),$(s).addClass("selected"),s},saveSliders:function(e){var t=this.sliders;e.events.push("saveSliders",t)},initEvent:function(n,o,r,e){var l,s,t=n.designer,i=n.container,a=n.plugins.presenter,c=n.operation.zoomVal/100,d=this.renderSelection(),p=o/c,u=r/c,h=i.scrollLeft(),m=i.scrollTop();1!=c&&(h=Math.abs(t.offset().left)/c,m=Math.abs(t.offset().top)/c);var g,f={};$(document).off("mousemove.presenter").on("mousemove.presenter",function(e){var t=e.pageX/c,i=e.pageY/c;l=t<o?(p=t,o):t,s=i<r?(u=i,r):i,f.x=h+p,f.y=m+u,f.w=l-p,f.h=s-u,d.css({left:f.x,top:f.y,width:f.w,height:f.h}),g=a.setSelectedRealTime(f,h,m,c,n)}),$(document).off("mouseup.presenter").on("mouseup.presenter",function(){var e,t;$(document).off("mousemove.presenter"),$(document).off("mouseup.presenter"),a.selecting=!1,0!=g.length?(t={index:e=a.sliders.length},a.sliders.push(t),a.sliderIndex=e,d.attr("idx",e),d.children(".selection-index").text(e+1),f=a.resetSelectionByTopics(f,h,m,d,c),a.sliders[a.sliderIndex].pos=f,a.sliders[a.sliderIndex].ids=g,a.saveSliders(n),$(".selection-index").fadeIn(),n.events.push("startPreview"),a.initDotEvent(n)):d.remove()})},initDotEvent:function(a){var e=a.designer,c={},d=Math.abs,p=a.operation.zoomVal/100,u=this,h=a.container.scrollLeft(),m=a.container.scrollTop();1!=p&&(h=Math.abs(e.offset().left)/p,m=Math.abs(e.offset().top)/p);var g;$(document).off("mousedown.selectiondot",".selection-dot").on("mousedown.selectiondot",".selection-dot",function(e){var r,l=$(this).attr("class"),t=a.container;h=t.scrollLeft(),m=t.scrollTop(),g=$(".mind-slide-selection[idx="+u.sliderIndex+"]");var s=u.sliders[u.sliderIndex].pos;c.x=h+e.pageX,c.y=m+e.pageY,$(document).on("selectstart",function(){return!1}),$(document).off("mousemove.selectiondot").on("mousemove.selectiondot",function(e){var t,i,n,o;null!=l&&(t=h+e.pageX,c.x,i=m+e.pageY,c.y,0<l.indexOf("rt")?(n=s.y+s.h,s.y=i,s.w=t-s.x,s.h=n-i):0<l.indexOf("lt")?(o=s.x+s.w,n=s.y+s.h,s.y=i,s.x=t,s.w=o-t,s.h=n-i):0<l.indexOf("rb")?(s.w=d(t-s.x),s.h=d(i-s.y)):0<l.indexOf("lb")&&(o=s.x+s.w,s.x=t,s.w=o-t,s.h=d(i-s.y)),u.setSelectionPos(g,s),r=u.setSelectedRealTime(s,h,m,p,a),e.stopPropagation())}),$(document).off("mouseup.selectiondot").on("mouseup.selectiondot",function(e){$(document).off("mousemove.selectiondot"),u.resetSelectionByTopics(s,h,m,g,p),$(document).off("mouseup.selectiondot"),$(document).off("selectstart"),u.sliders[u.sliderIndex].pos=s,u.sliders[u.sliderIndex].ids=r,u.saveSliders(a),e.stopPropagation()}),e.stopPropagation()})}}},mindDesigner.prototype.events={push:function(e,t){var i=this.listeners[e];return i?i(t):null},listeners:{},addEventListener:function(e,t){this.listeners[e]=t}};