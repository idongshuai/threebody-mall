mindDesigner.prototype.events.addEventListener("savelocal",function(){$("#savetip").text("已保存到WPS云文档"),mindUI.isOperated=!0}),mindDesigner.prototype.events.addEventListener("zoom",function(e){$(".mind-zoomtxt").text(e+"%")}),mindDesigner.prototype.events.addEventListener("showImage",function(){$(".mind-image-dlg").dialog(),mindUI.loadUserImages()}),mindDesigner.prototype.events.addEventListener("showStyle",function(){$(".header-center").children("[tit=style]").trigger("click")}),mindDesigner.prototype.events.addEventListener("initBrash",function(){mind.operation.initBrash(mind)}),mindDesigner.prototype.events.addEventListener("scrollLeft",function(e){var t=$("#mind_con").scrollLeft();$("#mind_con").scrollLeft(t+e)}),mindDesigner.prototype.events.addEventListener("scrollTop",function(e){var t=$("#mind_con").scrollTop();$("#mind_con").scrollTop(t+e)}),mindDesigner.prototype.events.addEventListener("showLink",function(){mind.operation.showLink.call(mind)}),mindDesigner.prototype.events.addEventListener("changeOpStatus",function(e){mindUI.changeOpStatus(e)}),mindDesigner.prototype.events.addEventListener("isShowOrHideChildren",function(){mindUI.showTopicsIcons()}),mindDesigner.prototype.events.addEventListener("focus",function(e){e?($(".change-theme-btn[tit=mind_themes]").addClass("mind-disable1"),$(".opt-select[tit=mind_structure]").addClass("mind-disable1"),$("[tit=mind_hide_topics]").addClass("mind-disable1").attr("isfocus",!0),$("[tit=mind_show_topics]").addClass("mind-disable1").attr("isfocus",!0)):($(".change-theme-btn[tit=mind_themes]").removeClass("mind-disable1"),$(".opt-select[tit=mind_structure]").removeClass("mind-disable1"),$("[tit=mind_hide_topics]").removeClass("mind-disable1").removeAttr("isfocus"),$("[tit=mind_show_topics]").removeClass("mind-disable1").removeAttr("isfocus"))}),mindDesigner.prototype.events.addEventListener("iconStyle",function(){}),mindDesigner.prototype.events.addEventListener("tagTip",function(){mindTip.globalTopTip("点击选择标签后，才可以设置颜色","top_error",2e3,$("#mind-tags-box"),!0)}),mindDesigner.prototype.events.addEventListener("changeHeader",function(){}),mindDesigner.prototype.events.addEventListener("showRight",function(e){mindUI.showRightDetail(e)}),mindDesigner.prototype.events.addEventListener("savetitle",function(e){""!=e&&null!=e&&"未命名文件"==chartTitle&&($(".header-item .title").val(e),setTimeout(function(){mindUI.saveTitle(e)},1600))}),mindDesigner.prototype.events.addEventListener("savelocalsuccess",function(){$("#savetip").text("")}),mindDesigner.prototype.events.addEventListener("poCollect1",function(e){var t,i,n;"undefined"!=typeof poCollect1&&null!=e&&(t=e.category,i=e.action,n=e.label,poCollect1(t,i,n))}),mindDesigner.prototype.events.addEventListener("documentkeydown",function(){$(document).on("keydown.hotkey",".mind-topic-box,.mind-right-corner,.mind-left-corner, .mind-image-dlg, .header-item .title,.mind-dock-right-con, .mind-menu-list,.mind-help-con,.mind-dlg,.op-con-detail",function(e){e.stopPropagation()}),$(document).on("mousemove.hotkey",".mind-topic-box,.mind-right-corner,.mind-left-corner, .mind-image-dlg, .header-item .title,.mind-dock-right-con, .mind-menu-list,.mind-help-con,.mind-dlg:not(.mind-watermark-dlg),.op-con-detail",function(e){e.stopPropagation()})}),mindDesigner.prototype.events.addEventListener("changeHeadColor",function(e){"#ffffff"==e||"rgb(255, 255, 255)"==e?$("header").css({background:"#f5f5f5"}):$("header").css({background:"#ffffff"})}),mindDesigner.prototype.events.addEventListener("undoStackChanged",function(e){var t=$("#mind_undo");0==e?t.addClass("mind-disable"):t.removeClass("mind-disable")}),mindDesigner.prototype.events.addEventListener("redoStackChanged",function(e){var t=$("#mind_redo");0==e?t.addClass("mind-disable"):t.removeClass("mind-disable")}),mindDesigner.prototype.events.addEventListener("loadsuccess",function(i){mindUI.initStructureIcon(i.model.topic.structure,i),vipUpgradePos="topright";var e=i.styles;"#ffffff"!=e.background&&"rgb(255,255,255)"!=e.background?$(".mind-dock-right").css("right","16px"):$(".mind-dock-right").css("right","10px");var t=chartTitle||"中心主题";$(".header-item .title").text(t),chartTitle=t,chartId=i.opts.chartId,setTimeout(function(){$("#mind-loading").fadeOut(200,function(){$("#mind-loading").remove()});var e=i.util.getSelectedId(),t=i.model.getTopicById(e);t&&mindUI.initDock(t)},200),offlineMask=!1,"undefined"==typeof userInfoInitTag&&i.util.testVipState(function(){zhuge.identify(userId,{nickname:userName,userid:userId,vip:tdocVipInfo.join(","),povip:po_is_vip,device:deviceType}),userInfoInitTag=1}),$(document).off("keydown.backspace").on("keydown.backspace",function(e){e.stopPropagation(),8==e.keyCode&&e.preventDefault()}),mindUI.setTopicLworBw(i),poCollect("page_show",{page:"mind_editor",page_from:"",userId:userId,vip:tdocVipInfo.join(","),povip:po_is_vip,device:deviceType})}),mindDesigner.prototype.events.addEventListener("hidepopeditor",function(){$(".pop-editor").remove()}),mindDesigner.prototype.events.addEventListener("setDock",function(e){mindUI.initDock(e)}),mindDesigner.prototype.events.addEventListener("openNote",function(){var e=$(".mind-dock-right").children("div[tit=mind-dock-right-remark]");0==$(".mind-dock-right-con").css("opacity")&&e.trigger("click")}),mindDesigner.prototype.events.addEventListener("saveOnline",function(){}),mindDesigner.prototype.events.addEventListener("showThemeOperate",function(e){mindUI.showThemeOperate(e)}),mindDesigner.prototype.events.addEventListener("toNew",function(){mindUI.createNew()}),mindDesigner.prototype.events.addEventListener("hideElements",function(){$(".mind-slide-selection").hide(),$(".mind-slide-con").hide(),$("header").hide(),$(".mind-slider-dlg").hide()}),mindDesigner.prototype.events.addEventListener("hideMenus",function(){$(".mind-menu").hide(),$(".mind-menu-list").hide(),$("[tit].selected").removeClass("selected")}),mindDesigner.prototype.events.addEventListener("showElements",function(){$(".mind-slider-close").trigger("click")}),mindDesigner.prototype.events.addEventListener("saveSliders",function(){}),mindDesigner.prototype.events.addEventListener("setContextMenuGlobal",function(e){var t=$(".mind-context-global-menu").find("ul");t.find(".disable").removeClass("disable"),e.currentRoot?(t.children("[op=hideall]").addClass("disable"),t.children("[op=openall]").addClass("disable")):(t.children("[op=hideall]").removeClass("disable"),t.children("[op=openall]").removeClass("disable"))}),mindDesigner.prototype.events.addEventListener("setContextMenu",function(e){var t=$(".mind-context-menu-content").find("ul");t.find(".disable").removeClass("disable");var i=mind.model.clipboard.list;e.root&&(t.children("[op=insert-parent]").addClass("disable"),t.children("[op=insert-siblings]").addClass("disable"),t.children("[op=cut]").addClass("disable"),t.children("[op=copy]").addClass("disable"),t.children("[op=delete]").addClass("disable"),t.children("[op=delete-self]").addClass("disable"),t.children("[op=focus]").addClass("disable"),t.children("[op=expand]").addClass("disable")),e.collapsed&&(t.children("[op= insert-child]").addClass("disable"),t.children("[op=focus]").addClass("disable")),e.pos&&(t.children("[op=insert-parent]").addClass("disable"),t.children("[op=insert-siblings]").addClass("disable")),0==i.length&&t.children("[op=paste]").addClass("disable"),e.summary&&(t.children("[op=focus]").addClass("disable"),t.children("[op=insert-parent]").addClass("disable"),t.children("[op=insert-siblings]").addClass("disable"),t.children("[op=delete-self]").addClass("disable")),1<mindColla.collaUserCount?(t.children("[op=focus]").addClass("disable"),t.children("[op=focus]").find(".mind-tip").show()):t.children("[op=focus]").find(".mind-tip").hide(),0==e.children.length&&(t.children("[op=delete-self]").addClass("disable"),t.children("[op=expand]").addClass("disable"))}),mindDesigner.prototype.events.addEventListener("showuploading",function(){mindUI.showUploading()}),mindDesigner.prototype.events.addEventListener("hideuploading",function(){mindUI.hideUploading()}),mindDesigner.prototype.events.addEventListener("vip-limit",function(e){mindUI.showVipLimitDlg(e)}),mindDesigner.prototype.events.addEventListener("po-vip-limit",function(e){var t;limitAid[e]&&(t=limitAid[e].replace("_po_","_act_"),sendMessage("notify",{eventType:"useMembershipFeatures",action:t}))}),mindDesigner.prototype.events.addEventListener("setUpgradeBtn",function(){setTimeout(function(){mindUI.setTopUpgradeBtnB()},500)}),mindDesigner.prototype.events.addEventListener("vip-limit-warn",function(){Util.globalTopTip2({content:"当前节点数还有20个达到上限",type:"top_info",btn:"升级",delay:1e4,btnclick:function(){limitType="nodecout_warn",mindUI.upgradeVip()}})}),mindDesigner.prototype.events.addEventListener("setNickPortrait",function(e){mindColla.userInfo.nickName=mindColla.filterIllegalWord(e.nickname);var t=e.portraitUrl||"";mindColla.userInfo.portrait=t.split("?")[0],console.log(mindColla.userInfo)}),mindDesigner.prototype.events.addEventListener("outline-select",function(e){var t=$("#outline-dlg");0<t.length&&"block"==t.css("display")&&Outline.controller.selectNodeById(e)}),mindDesigner.prototype.events.addEventListener("outline-prebuild",function(e){var t=$("#outline-dlg");0<t.length&&"block"==t.css("display")&&Outline.controller.updateNodeById(e)}),mindDesigner.prototype.events.addEventListener("outline-collapse",function(e){var t=$("#outline-dlg");0<t.length&&"block"==t.css("display")&&Outline.controller.foldNodeById(e)}),mindDesigner.prototype.events.addEventListener("outline-posupdate",function(e){var t=$("#outline-dlg");0<t.length&&"block"==t.css("display")&&Outline.controller.nodePosUpdate(e)}),mindDesigner.prototype.events.addEventListener("load-outline",function(){mindUI.showLeft("outline",$(this)),mindUI.loadOutline()}),mindDesigner.prototype.events.addEventListener("focusable",function(){var e=mindColla.collaUsers,t=Object.keys(e);return 1==t.length||(!(1<t.length)||(mindColla.renderTipDig("focus"),!1))}),mindDesigner.prototype.events.addEventListener("close-mind-topic-box",function(){var e=$(".mind-topic-box");0<e.length&&e.css("display","none")}),$(document).ready(function(){tutorial_,mindColla.init(),$("[title-tip]").live("mouseenter",function(){var e=$(this),t=$(this).attr("title-tip"),i=$("#title-tip");t&&(0==i.length&&(i=$('<div id="title-tip">'+t+"</div>").appendTo("body")),i.html(t).css({left:parseInt(e.offset().left+e.outerWidth()/2-i.outerWidth()/2),top:parseInt(e.offset().top+e.outerHeight()+14)}).show())}).live("mouseleave",function(){$("#title-tip").hide()}),PoNetwork.init({offlineHandle:function(){"undefined"!=typeof mind&&mind.util.clearSelect()},onlineChange:function(){void 0!==mindColla&&(mindColla.errorOrderHandle(),mindColla.reconnectCount<10&&"undefined"!=typeof poWebSocket&&poWebSocket&&1!=poWebSocket.readyState&&(1<Object.keys(mindColla.collaUsers).length&&0!=mindColla.reconnectCount?(poWebSocket.close(1e3),location.reload()):mindColla.cooperatingSend(function(e){1<e?location.reload():mindColla.socketReconnect()})))}}),$(".checkbox-con").off("click").on("click",function(){$(this).children(".check-box").toggleClass("checked")}),$(".style-chage-type").off("click").on("click",function(e){var t=$(e.target),i=t.attr("opt-tit");if(i){if(t.hasClass("active"))return;$(this).children().removeClass("active"),$(this).children("span[opt-tit="+i+"]").addClass("active"),$(".set-style-con").hide(),$(".set-style-con[tit="+i+"]").show()}}),$(".header-center").children().on("click",function(){var e=$(this),t=e.attr("tit");e.addClass("active").siblings().removeClass("active"),$(".header-op > [tit="+t+"]").show().siblings().hide(),$(".mind-topic-box").hide();var i=$("#fold-headerop-btn");i.hasClass("opened")||(i.removeClass("opened").addClass("opened"),$("#header-op-container").removeClass("folded"),$("#head-slither").removeClass("close"),$("#right-help-con").css({height:$(document).outerHeight()-100,top:100})),setTimeout(function(){$("#outline_btn").css("display","block"),mindUI.headOpWidth()},300)}),$(".opt-select[tit], .right-item-change[tit], .header-op-item[tit],.header-right-item[tit]").on("click",function(e){e.stopPropagation();var t,s=$(this),i=s.attr("tit"),n=mind,o="",r="",a="";switch(s.siblings().removeClass("selected"),i){case"mind_insert_child":n.operation.appendTopic.call(n,!0),o="add_subtopic",r="node";break;case"mind_insert_parent":var l,d=n.util.getSelectedId();""!=d&&(l=n.model.getTopicById(d),n.operation.insertParent.call(n,l)),o="add_parent_topic",r="node";break;case"mind_insert_brother":n.operation.appendTopic.call(n,!1),o="add_topic",r="node";break;case"mind_help":var c=$("#mind-help-list");console.log(c),mindUI.showDropdown(s,c,function(e){var t=e.attr("tp");"shortcut"==t?mindUI.showRightDetail("shortcut"):"mind_guide"==t?tutorial.init():"mind_book"==t&&window.open("/support")});break;case"toolbar_but_insert":c=$("#mind_insert_list");mindUI.showDropdown(s,c,function(e){switch(e.attr("tp")){case"mind_img":mindUI.loadUserImages(function(e){mindUI.insertUserImage(e)}),o="image",r="insert";break;case"mind_tag":n.tags.showTag.call(n);break;case"mind_task":n.task.showTask.call(n);break;case"mind_link":n.operation.showLink.call(n),o="link",r="insert";break;case"mind_remark":mindUI.showRightDetail("remark",!0);break;case"mind_icon_show":mindUI.showRightDetail("icons"),mindUI.showIcons($(".mind-icons-item"))}o&&r&&tdocCollect({opername:"mind",module:r,action:o,ver5:a,ver6:""})},"left");break;case"mind_layout":mindUI.showRightDetail("style"),r=o="format";break;case"mind_edit":""!=(t=n.util.getSelectedId())&&n.operation.editTopicDom.call(n,t);break;case"mind_del":n.operation.removeTopic.call(n);break;case"mind_connection":n.connection.render.call(n,e);break;case"mind_summary":var m=n.util.selectedIds;if(0==m.length)return void $.showTip("请先选中一个主题",1e3);n.summary.addSummary.call(n,m),o="add_summary",r="node";break;case"mind_file":if(0==(t=n.util.selectedIds).length)return;mindUI.uploadFile(t[0]);break;case"mind_watermark":mind.model.topic.watermark||""?$("#mind-watermark li[tp=mind_watermark_del]").removeAttr("original-title").removeClass("mind-disable1"):$("#mind-watermark li[tp=mind_watermark_del]").attr("original-title","暂无可删除的水印").addClass("mind-disable1"),mindUI.showDropdown(s,$("#mind-watermark"),function(e){var t=e.attr("tp");"mind_watermark_set"==t&&($(".mind-watermark-dlg").dialog(),mindUI.waterMark.init()),"mind_watermark_del"!=t||e.hasClass("mind-disable1")||(mind.operation.clearWatermark.call(mind),$.showTip("已删除水印",5e3))});break;case"seticon":var p=null;null!=s.css("color")&&(p=s.css("color")),mind.icons.setIcon.call(mind,s,null,p);break;case"mind_topic_style":c=$(".mind-topics-dlg");mindUI.showDropdown(s,c,function(e){var t,i,n,o;e.length&&(i={"background-color":(t=e.find(".pre-topic")).css("background-color"),color:t.css("color"),"border-width":t.css("border-width"),"border-color":t.css("border-color"),"border-style":t.css("border-style"),"border-radius":t.css("border-radius")},mind.operation.setStyle.call(mind,i),n=s.children("span").first(),o=$.extend({"text-align":"center"},i),console.log(i),n.css(o),tdocCollect({opername:"mind",module:"node",action:"style",ver5:e.attr("n"),ver6:""}))});break;case"mind_topic_bgcolor":mindUI.showColorBox(s,function(e,t){var i;null==e||"transparent"==e?(i=mind.designer.css("background-color"),s.children("span").first().css("background",e),mind.operation.setStyle.call(mind,{"background-color":i})):(e="rgb("+e+")",s.children("span").first().css("background",e),mind.operation.setStyle.call(mind,{"background-color":e})),tdocCollect({opername:"mind",module:"node",action:"fill_color",ver5:t,ver6:""})});break;case"mind_canvas_bgcolor":mindUI.showColorBox(s,function(e,t){e="transparent"==e?e:"rgb("+e+")",s.children("span").first().css("background",e),mind.operation.setBackground.call(mind,e,!0),tdocCollect({opername:"mind",module:"format",action:"background_color",ver5:t,ver6:""})});break;case"mind_topicline_color":mindUI.showColorBox(s,function(e,t){"root"!=n.util.getSelectedId()&&(e=null==e||"transparent"==e?"transparent":"rgb("+e+")",s.children("span").first().css("background",e),mind.operation.setStyle.call(mind,{"line-color":e}),tdocCollect({opername:"mind",module:"line",action:"color",ver5:t,ver6:""}))});break;case"mind_topic_txt_color":mindUI.showColorBox(s,function(e,t){e="transparent"==e?null:"rgb("+e+")",mind.operation.setStyle.call(mind,{color:e}),s.children("span").first().css("background",e||"rgba(0,0,0,.8)"),tdocCollect({opername:"mind",module:"text",action:"color",ver5:t,ver6:""})});break;case"mind_topic_font":mindUI.showDropdown(s,$("#mind-font-list"),function(e){var t=e.text();s.children("span").text(t),mind.operation.setStyle.call(mind,{"font-family":t})}),o="font",r="text";break;case"mind_topic_font_size":$("#mind-fontsize-list").css("height","auto"),mindUI.showDropdown(s,$("#mind-fontsize-list"),function(e){var t=e.text();s.children("span").text(t),mind.operation.setStyle.call(mind,{"font-size":t})},"bottom",!0),o="size",r="text";break;case"mind_topic_b":s.hasClass("selected")?(s.removeClass("selected"),n.operation.setStyle.call(n,{"font-weight":"normal"})):(s.addClass("selected"),n.operation.setStyle.call(n,{"font-weight":"bold"})),o="bold",r="text";break;case"mind_topic_i":s.hasClass("selected")?(s.removeClass("selected"),n.operation.setStyle.call(n,{"font-style":"normal"})):(s.addClass("selected"),n.operation.setStyle.call(n,{"font-style":"italic"})),o="italic",r="text";break;case"mind_topic_u":s.hasClass("selected")?(s.removeClass("selected"),mind.operation.setStyle.call(mind,{"text-decoration":"none"})):(s.addClass("selected"),mind.operation.setStyle.call(mind,{"text-decoration":"underline"})),o="underscore",r="text";break;case"mind_topic_s":break;case"mind_topic_align_l":n.operation.setStyle.call(n,{"text-align":"left"}),s.addClass("selected"),s.siblings("[align]").removeClass("selected"),o="align",r="text",a=1;break;case"mind_topic_align_c":n.operation.setStyle.call(n,{"text-align":"center"}),s.addClass("selected"),s.siblings("[align]").removeClass("selected"),o="align",r="text",a=3;break;case"mind_topic_align_r":n.operation.setStyle.call(n,{"text-align":"right"}),s.addClass("selected"),s.siblings("[align]").removeClass("selected"),o="align",r="text",a=2;break;case"mind_border_radius":c=$("#mind_border_radius");mindUI.showDropdown(s,c,function(e){var t=e.attr("tp"),i=parseInt(t)+"px";mind.operation.setStyle.call(mind,{"border-radius":i}),s.children("span").first().html(e.html()),tdocCollect({opername:"mind",module:"node",action:"fill_radian",ver5:e.attr("n"),ver6:""})});break;case"mind_topic_border_c":var u=n.util.selectedIds,h="#666";mindUI.showColorBox(s,function(e,t){e=null==e||"transparent"==e?"transparent":"rgb("+e+")",s.children("span").first().css("background",e);var i={"border-color":e};n.operation.setStyle.call(n,i),tdocCollect({opername:"mind",module:"node",action:"border_color",ver5:t,ver6:""})}),1==u.length&&(h=$("#"+u[0]).css("borderColor")||"#666"),s.children("span").first().css("backgroundColor",h);break;case"mind_topic_border_t":var f=$("#mind-customise-borderst");mindUI.showDropdown(s,f,function(e){var t=e.attr("tp"),i={"border-style":t};n.operation.setStyle.call(n,i),s.children("span").first().attr("line",t),tdocCollect({opername:"mind",module:"node",action:"fill_style",ver5:e.attr("n"),ver6:""})});break;case"mind_clear_style":n.operation.clearStyle.call(n);break;case"mind_themes":c=$(".mind-theme-dlg");mindUI.showMenu(s,c,"left_middle");break;case"mind_structure":f=$("#mind-structures-list");mindUI.showDropdown(s,f,function(e){var t=e.attr("tp");mind.operation.changeStructure.call(mind,t,function(){mindUI.initStructureIcon(t),f.hide(),s.removeClass("selected")}),tdocCollect({opername:"mind",module:"format",action:"select_structure",ver5:e.attr("n"),ver6:""})});break;case"mind_ppt":console.log("脑图PPT"),window.cefQuery({request:'jsAsynCall(\'{"method": "openConvertToPptDlg"}\')'});break;case"mind_hide_topics":mind.operation.hideTopics.call(mind,!1),$(this).addClass("mind-disable1"),$(".header-op-item[tit=mind_show_topics]").removeClass("mind-disable1");break;case"mind_show_topics":mind.operation.showTopics.call(mind,!1),$(this).addClass("mind-disable1"),$(".header-op-item[tit=mind_hide_topics]").removeClass("mind-disable1")}n.operation.hideLink(),r&&o&&tdocCollect({opername:"mind",module:r,action:o,ver5:a,ver6:""})}),$("#mind-help").on("click",function(){var e=$(this);mindUI.showLeft("shortcut",e)}),$("#history").on("click",function(){var e=$(this);mindUI.showLeft("history",e)}),$(document).off("mouseover.tags","#mind-tags-box").on("mouseover.tags","#mind-tags-box",function(){$("#mind_con").css("overflow","hidden")}).on("mouseout.tags",function(){$("#mind_con").css("overflow","auto")}),$("#offline_btn").off("click").on("click",function(){var e=$(this),t=$(".mind-offline-dlg");t.show().css({opacity:1,top:50}),setTimeout(function(){t.css("opacity","0.5")},2500),e.hide(),e.next().show(),mindColla.offlineModel=!0,mind.messageSource.saveLocal(mind),mindColla.stop(!1)}),$("#offline_save_btn").off("click").on("click",function(){var e=$(".mind-offline-dlg");e.css({opacity:1}),$(".mind-offline-dlg .closeoff").prev().text("保存中..."),mindColla.doSync(chartId,function(){$(".mind-offline-dlg .closeoff").prev().text("保存成功"),setTimeout(function(){$(".mind-offline-dlg .closeoff").prev().text("已进入离线模式"),e.css("opacity",".5")},1e3)})}),$(".mind-offline-dlg .closeoff").off("click").on("click",function(){var e=$(this),t=$(".mind-offline-dlg");e.prev().text("保存中..."),mindColla.doSync(chartId,function(){$(".mind-offline-dlg .closeoff").prev().text("保存成功"),$("#offline_save_btn").hide(),$("#offline_btn").show(),mindColla.offlineModel=!1,mindColla.isOffLine=!1,setTimeout(function(){mindUI.removeFile(chartId),$("#btnoffline").children().eq(0).show(),$("#btnoffline").children().eq(1).hide(),$(".mind-offline-dlg .closeoff").prev().text("已进入离线模式"),t.css("opacity","0"),t.hide()},1500)})}),$(".header-item .title").off("focus").on("focus",function(e){$(this).select(),e.stopPropagation()}),$(".header-item .title").off("keydown").on("keydown",function(e){var t,i;13==e.keyCode&&(t=$(this),""!=(i=$.trim(t.val()))&&mindUI.saveTitle(i),t.removeAttr("contenteditable"),e.preventDefault())}),$(".header-item .title").off("blur").on("blur",function(e){e.stopPropagation();var t=$(this),i=$.trim(t.val());""!=i&&mindUI.saveTitle(i)}),$("#mind_undo").off("click").on("click",function(){var e=mind;e.messageSource.undo(e),tdocCollect({opername:"mind",module:"edit",action:"undo",ver5:"",ver6:""})}),$("#mind_redo").off("click").on("click",function(){var e=mind;e.messageSource.redo(e),tdocCollect({opername:"mind",module:"edit",action:"redo",ver5:"",ver6:""})}),$("#mind_brash").off("click").on("click",function(){var e=mind;e.operation.initBrash(e),tdocCollect({opername:"mind",module:"edit",action:"format_brush",ver5:"",ver6:""})}),$("#quick_to_outline").off("click").on("click",function(){location.href=location.href.replace(/&outline=true/g,"")+"&outline=true"}),$(".mind-zoomin").off().on("click",function(){mind.operation.zoomIn.call(mind,mind.designer);var e=mind.operation.zoomVal;$(".mind-zoomtxt").text(e)}),$(".mind-zoomout").off().on("click",function(){mind.operation.zoomOut.call(mind,mind.designer);var e=mind.operation.zoomVal;$(".mind-zoomtxt").text(e)}),$("#mind-theme-customise").on("click",function(e){e.stopPropagation(),$(".mind-theme-customise-dlg").dialog();var t=mind.style.themes.theme3;mindUI.initCustomise(t)}),$("#btn-customise-close").on("click",function(){$(".mind-theme-customise-dlg").dialog("close")}),$("#mind-background-img").on("mousedown",function(e){e.stopPropagation(),backgroundImage.init(),$("#mind-color-picker").dropdown("close"),$(".mind-background-img-dlg").dialog()}),$(".mind-background-img-dlg").on("click",".mind-button.gray",function(){$(".mind-background-img-dlg").dialog("close")}),$(".op-con-detail > div[tit=style]").off().on("click","h3",function(){var e=$(this).next(),t=$(this);if(0<e.length&&"h3"!=e[0].tagName.tolowercase){if($(this).hasClass("con-hide-detail"))return t.removeClass("con-hide-detail"),void e.stop().slideToggle(100);e.stop().slideToggle(100,function(){t.addClass("con-hide-detail")})}});var n=$("#fold-headerop-btn");n.off("click.fold").on("click.fold",function(){var e=n,t=$("#header-op-container");if(e.hasClass("opened"))return e.removeClass("opened"),t.removeClass("folded").addClass("folded"),$(".auto-save-tip").css("top","37px"),$("#head-slither").addClass("close").css("display","none"),$("#outline_btn").css("display","none"),void $("#right-help-con").css({height:$(document).outerHeight()-40,top:40});e.removeClass("opened").addClass("opened"),t.removeClass("folded"),$(".auto-save-tip").css("top","97px"),$("#head-slither").removeClass("close");var i=$(document).outerHeight()-100;$("#right-help-con").css({height:i,top:100})}),$(".mind-help").on("click",function(){var e=$("#helpcenter-dlg");0==e.css("opacity")?e.show().css({opacity:1,right:60}):e.show().css({opacity:0,right:-200}),$("#sharecenter-dlg").hide(),$(document).on("mouseup.closeme",function(){e.show().css({opacity:0,right:-200})}),e.on("mouseup.closeme",function(e){e.stopPropagation()})}),$("#callback_dlg_cancel").on("click",function(){$(".mind-callback-dlg").dialog("close")}),$("#callback_dlg_save").on("click",function(){var e=$(this);e.addClass("mind-disable"),mindUI.saveFeedBack(function(){$(".mind-callback-dlg").dialog("close"),$.showTip("已提交成功，感谢您的反馈",2e3),e.removeClass("mind-disable")})}),$(".drop-menu-download").off("click").on("click","li",function(e){e.stopPropagation();var t=$(this).attr("tit");if(!t)return!1;mindUI.exportFile.handle(t)}),$("#mind-task-priority").on("click",function(){var a=$(this);$("#mind-icons-priority-list").dropdown({target:a,position:"right",width:80,onSelect:function(e){var t=e.clone();t.find("span").remove();var i=t.text(),n=t.attr("priority"),o=t.attr("ico"),s=e.find(".mind-icons").css("color"),r=$(".mind-icons-dlg").find("[ico="+o+"]");null==n?mind.icons.removeIcon.call(mind,"priority"):mind.icons.setIcon.call(mind,r,{priority:n},s),a.children("span").text(i),a.removeClass("selected"),t.remove()},onClose:function(){a.removeClass("selected")}}),a.addClass("selected")}),$("#mind-task-completion").on("click",function(){var a=$(this);$("#mind-icons-completion-list").dropdown({target:a,position:"right",width:80,onSelect:function(e){var t=e.clone();t.find("span").remove();var i=t.text(),n=t.attr("completion"),o=t.attr("ico"),s=e.find(".mind-icons").css("color");a.children("span").text(i);var r=$(".mind-icons-dlg").find("[ico="+o+"]");null==n?mind.icons.removeIcon.call(mind,"completion"):mind.icons.setIcon.call(mind,r,{completion:n},s),a.removeClass("selected"),t.remove()},onClose:function(){a.removeClass("selected")}}),a.addClass("selected")}),$("#mind-task-end").off("click").on("click",function(e){var t=$(this);$("#mind-task-end").datePicker({dateFormat:"yyyy-MM-dd",selected:function(e){t.find("span").text(e),mind.task.setTask.call(mind,{end:e})}}),e.stopPropagation()}),$("#mind-task-start").off("click").on("click",function(e){var t=$(this);$("#mind-task-start").datePicker({dateFormat:"yyyy-MM-dd",selected:function(e){t.find("span").text(e),mind.task.setTask.call(mind,{start:e})}}),e.stopPropagation()}),$("#mind-task-assigned").on("blur",function(){var e=$(this),t=$.trim(e.val());""!=t&&t.length<20?mind.task.setTask.call(mind,{assigned:t}):""==t&&mind.task.setTask.call(mind,{assigned:null})}),$(document).on("mousedown.titlemenu","#body-mask,.header-item .title,.mind-title-menu,.mind-theme-dlg,.mind-image-dlg,.header-item.icon.down,.header-item.icon.theme,.header-item.icon.image,header,.op-con-detail",function(e){e.stopPropagation()}),$(document).on("keydown.hotkey",".mind-image-dlg",function(e){e.stopPropagation()});var t=null;$("#mind-topic-remack").on("blur",function(){var e=$(this).val();mind.remark.setRemark.call(mind,e,t)}),$("#mind-topic-remack").on("focus",function(){t=mind.util.getSelectedId()}),$(".mind-icons-item[tit=icons-native]").off("click.icons").on("click.icons",".mind-icons",function(e){e.stopPropagation();var t,i=$(this);i.attr("remove")?mind.icons.removeIcon.call(mind):(t=null,"flag"==i.attr("n")&&(t=i.css("color")),mind.icons.setIcon.call(mind,i,null,t))}),$("#head-slither").off("click").on("click",function(e){var t=$(this),i=t.hasClass("right")?"right":"left",n="right"==i?"left":"right",o=$(".header-center .active").attr("tit"),s=$("#header-op-container").find("div[tit="+o+"]"),r=$("#header-op-container").outerWidth()-s.outerWidth()-70;0<=r||("left"==i&&(r="0"),s.css("transform","translate("+r+"px, 0)"),$("#outline_btn").css("transform","translate("+r+"px, 0)"),t.removeClass(i).addClass(n),$("#temp-slither").remove(),e.stopPropagation())}),setTimeout(function(){mindUI.loadThemes(mind)},1e3),$(document).off("click.upgrade").on("click.upgrade","#dlg-tdoc-upgrade-btn, #thme-upgrade-link, #bot-nodevip-btn",function(e){var t,i,n;e.stopPropagation(),"bot-nodevip-btn"==$(this).attr("id")&&(limitType="leftdown_nodecout"),mindUI.upgradeVip(),limitAid[limitType]&&(t="mind",i="node",-1<limitType.indexOf("download")&&(t="download",i=-1<limitType.indexOf("pnghd")?"PNG":-1<limitType.indexOf("pdf")?"PDF":-1<limitType.indexOf("jpg")?"JPG":-1<limitType.indexOf("pos")?"POS":""),-1<limitType.indexOf("pasteimg")&&(t="paste",i="screencut"),n=limitAid[limitType].replace("_po_","_act_"),tdocCollect({opername:t,module:i,action:n,ver5:2,ver6:""}))})});var PoNetwork={preStatus:"online",offlineCallback:null,onlineCallback:null,onlineVal:"online",offlineVal:"offline",intervalTime:1e4,networkTimer:null,imgExpireLoadTime:5e3,imgTimeoutTimer:null,imgTimeoutTimer2:null,init:function(e){e=e||{},PoNetwork.offlineHandlePub=e.offlineHandle,PoNetwork.onlineHandlePub=e.onlineHandle,e.onlineChange&&(PoNetwork.onlineChangePub=e.onlineChange),PoNetwork.networkTimer&&clearInterval(PoNetwork.networkTimer),PoNetwork.networkTimer=setInterval(function(){PoNetwork.test()},PoNetwork.intervalTime),Object.defineProperty(PoNetwork,"status",{get:function(){return this.preStatus},set:function(e){"offline"==e&&"online"==this.preStatus&&(console.log("offline set"),PoNetwork.offlineChange()),"online"==e&&"offline"==this.preStatus&&(console.log("online set"),PoNetwork.onlineChange()),this.preStatus=e}})},onlineChange:function(){this.onlineChangePub&&this.onlineChangePub()},offlineChange:function(){},offlineHandle:function(){"undefined"==typeof offlineMask&&(offlineMask=!1),offlineMask||PoNetwork.openDialog(),offlineMask=!0,PoNetwork.offlineHandlePub&&PoNetwork.offlineHandlePub(),this.offlineCallback&&this.offlineCallback()},onlineHandle:function(){"undefined"==typeof offlineMask&&(offlineMask=!1),offlineMask&&PoNetwork.closeDialog(),offlineMask=!1,PoNetwork.onlineCallback&&(console.log("onlineCallback"),PoNetwork.onlineCallback()),PoNetwork.onlineHandlePub&&PoNetwork.onlineHandlePub()},clearNetworkTimer:function(){clearInterval(PoNetwork.netWorkTimer)},test:function(e){var t;null==e&&(e={}),PoNetwork.onlineCallback=e.onlineCallback||null,PoNetwork.offlineCallback=e.offlineCallback||null,PoNetwork.saveTrigger=e.saveTrigger||null,0==navigator.onLine?PoNetwork.offlineFc():((t=new Image).src="https://docimg10.docs.qq.com/image/kcl6PdZb3wvNL6RdWxwbhg?w=1&h=1?_u="+(new Date).getTime(),PoNetwork.imgTimeoutTimer=setTimeout(function(){PoNetwork.testAgain(),t=null},PoNetwork.imgExpireLoadTime),t.onload=function(){clearTimeout(PoNetwork.imgTimeoutTimer),clearTimeout(PoNetwork.imgTimeoutTimer2),PoNetwork.onlineFc(),t=null})},offlineFc:function(){PoNetwork.offlineHandle(),PoNetwork.status="offline"},onlineFc:function(){PoNetwork.onlineHandle(),PoNetwork.status="online"},testAgain:function(){var e=this,t=new Image;t.src="https://nettest.processon.com/assets/netest.jpg?_u="+(new Date).getTime(),PoNetwork.imgTimeoutTimer2=setTimeout(function(){e.offlineFc(),t=null},PoNetwork.imgExpireLoadTime),t.onload=function(){clearTimeout(PoNetwork.imgTimeoutTimer2),e.onlineFc(),t=null}},openDialog:function(){"undefined"!=typeof mind?$(".offline-dlg").dialog({onClose:function(){offlineMask=!1}}):console.log("请检查您的网络情况")},closeDialog:function(){"undefined"!=typeof mind?$(".offline-dlg").dialog("close"):"function"==typeof $&&"object"==typeof $.fn&&"function"==typeof $.fn.dlg?$(".offline-dlg").dlg("close"):console.log("请检查您的网络情况")}},postWpsErrorMsg={SecretGroupLocked:"私密文件夹已经锁定",fileNameConflict:"文件名冲突",userNotLogin:"用户尚未登录",fileNameEmpty:"文件名不能为空, ",SecretGroupPermissionDenied:"私密文件夹操作权限不足",permissionDenied:"您的操作权限不足",InvalidArgument:"无效的参数",SpaceFull:"思维导图自动保存至云文档，占用WPS云空间。WPS云空间不足导致保存失败，您可开通会员或整理云文档获取更多可用的云空间。",userDeptSpaceFull:"WPS企业云空间不足导致保存失败，您可开通会员或整理云文档获取更多可用的云空间。",userSpaceFull:"云空间不足导致保存失败，您可开通会员或整理云文档获取更多可用的云空间。",fileNameLengthExceed:"文件名需控制在100个字符以内，请修改文件名。",illegalFname:"文件名不能包含*等特殊字符，请修改文件名。",notGroupMember:"您已不是该团队成员",fileNotUploaded:"文件未上传",fileNotExists:"文件(夹)不存在"},directMatch={outline:{executing:!1,mess:[],init:function(n){var e=n.msg,t=mind.model,i=t.topic;if(this.executing)this.mess.concat(e);else{this.executing=!0;var o=mind.util.copyArray(this.mess.concat(e));try{for(var s=0;s<o.length;s++){var r=o[s];switch(r.action){case"add":var a=r.content,l=r.indexs,d=r.parts;if(a&&0<a.length)for(var c,m,p=0,u=a.length;p<u;p++){"root"==(x=a[p]).parent?d[x.id]||(d[x.id]="right"):(c=t.getSubTopic(x),m=mind.util.getSelectedPart(c.id,i.structure),d[x.id]=m)}var h={msg:[{action:"create",content:{content:a,index:l,parts:d}}],client:n.client};mind.messageSource.excuteMsgDirect.call(mind,h);break;case"update":var a=(U=r.content).nodes,f=(U.oldNodes,U.key);if("title"==f)for(p=0,u=a.length;p<u;p++){var h={msg:[{action:"updateTitle",content:{content:(x=a[p]).id,update:x.title}}],client:n.client};mind.messageSource.excuteMsgDirect.call(mind,h)}else"note"==f||"tag"==f||"link"==f||"icon"==f||"style"==f||"task"==f?(h={msg:[{action:"update",content:{content:(U=r.content).nodes,original:U.oldNodes,type:f=U.key}}],client:n.client},mind.messageSource.excuteMsgDirect.call(mind,h)):"collapsed"==f&&(h={msg:[{action:"changetopicexpand",content:{content:a[0].id,type:null}}],client:n.client},mind.messageSource.excuteMsgDirect.call(mind,h));break;case"moveNode":for(var g=(U=r.content).sourceId,v=U.target,a=(U.source,[]),p=0,u=g.length;p<u;p++){var b=g[p];(v.id||v[b])&&a.push(mind.model.getTopicById(b))}if(v.id)y(a,v);else for(var $=0,_=a.length;$<_;$++){var w=a[$];y([w],S=v[w.id])}function y(e,t){t.pos&&("up"==t.pos&&(t.pos="before"),"down"==t.pos&&(t.pos="after"),t.pos);var i={msg:[{action:"updatePos",content:{content:mind.util.copyArray(e),target:t,moveFromOutline:!0}}],client:n.client};mind.messageSource.excuteMsgDirect.call(mind,i)}break;case"delete":a=r.content,h={msg:[{action:"delete",content:{content:mind.util.copyArray(a),updates:null}}],client:n.client};mind.messageSource.excuteMsgDirect.call(mind,h);break;case"open":case"close":break;case"indent":var k=(U=r.content).ids,C=U.targets,I=(U.origins,U.type);if(0==k.length)return;for(var T=mind.util.copyArray(k),a=[],u=T.length,p=0;p<u;p++){var v=C[D=T[p]],x=mind.util.copy(mind.model.getTopicById(D)),S=v;v&&("undo"!=I&&(S={id:v.id,pos:"in"}),h={msg:[{action:"updatePos",content:{content:[x],target:S,moveFromOutline:!0}}],client:n.client},mind.messageSource.excuteMsgDirect.call(mind,h))}break;case"unIndent":var U,T=(U=r.content).ids,C=U.targets;U.origins;0<T.length&&T.reverse();for(k=mind.util.copyArray(T),p=0;p<T.length;p++){var D=T[p];"root"!=(x=mind.model.getTopicById(D)).parent&&(h={msg:[{action:"updatePos",content:{content:[x],target:v={id:x.parent,pos:"after"},moveFromOutline:!0}}],client:n.client},mind.messageSource.excuteMsgDirect.call(mind,h))}}}}catch(e){}this.executing=!1,this.mess=[]}}}},mindColla={offlineModel:!1,isChecking:!1,isSending:!1,mess:[],tempMess:[],qqSaveTime:3e4,qqSaveCount:0,versionNow:0,version:0,qqSaving:!1,qqSaveTimer:null,curMindInterval:null,qqSaveTimeCount:0,errorSave:0,saveWpsStatusError:0,saveWpsErrorTip:0,prePoSaveStatus:"success",preWpsSaveStatus:"success",init:function(){var e=this;mindColla.curMindInterval&&clearInterval(mindColla.curMindInterval),mindColla.curMindInterval=window.setInterval(function(){e.qqSaveTimeCount+=1},1e3),window.onbeforeunload=function(){mindColla.postData2Wps(),"undefined"!=typeof poWebSocket&&poWebSocket&&poWebSocket.close(1e3)},$(document).on("mouseleave",function(){e.version!=e.versionNow&&(e.qqSaveTimeCount<5||mindColla.postData2Wps())}),mindColla.qqSaveTimer&&clearInterval(mindColla.qqSaveTimer),mindColla.qqSaveTimer=window.setInterval(function(){mindColla.postData2Wps()},mindColla.qqSaveTime),mindColla.poSaveStatus||Object.defineProperty(mindColla,"poSaveStatus",{get:function(){return this.prePoSaveStatus},set:function(e){"success"==e&&"error"==this.prePoSaveStatus&&0<mindColla.errorSave&&mindColla.postData2Wps("all"),this.prePoSaveStatus=e}}),mindColla.tdocSaveStatus||Object.defineProperty(mindColla,"tdocSaveStatus",{get:function(){return this.preWpsSaveStatus},set:function(e){"success"==e&&"error"==this.preWpsSaveStatus&&0<mindColla.errorSave&&mindColla.postData2Wps("all"),this.preWpsSaveStatus=e}})},deleteCurrentRootFlag:function(e,t){var i=e.leftChildren||[],n=e.children||[];0<i.length&&this.deleteCRootHandle(i,t),0<n.length&&this.deleteCRootHandle(n,t)},deleteCRootHandle:function(e,t){for(var i=0,n=e.length;i<n;i++){var o=e[i];if(o.id==t)return delete o.root,void delete o.structure;var s=o.children||[];0<s.length&&this.deleteCRootHandle(s,t)}},clickSaveTimer:null,saveToWPSErrorCount:0,postData2Wps:function(n){var e,t,i,o,s=this;this.version==this.versionNow&&"click"!=n||this.qqSaving||(this.qqSaving=!0,this.qqSaveCount+=1,e="",("click"==n||"all"==n||"netTrigger"==n||0<mindColla.errorSave)&&(t=mind.util.copy(mind.model.topic),null!=mind.currentRoot&&(i=mind.currentRoot.id,this.deleteCurrentRootFlag(t,i)),e=JSON.stringify(t)),$("#savetip").text("正在保存..."),o={user_id:userId,encrypted_session:encrypted_session,client_id:"processon",file_id:file_id,msgStr:e,ignore:"msgStr",trace_id:trace_id,defId:defId,sync:!0},$.ajax({url:"/tdocs/template/mindmap/msg",data:o,cache:!1,type:"post",success:function(e){if(s.qqSaving=!1,s.qqSaveTimeCount=0,"success"==e.result)return $("#manage_save_template").html("保存成功: "+(new Date).getHours()+":"+(new Date).getMinutes()+":"+(new Date).getSeconds()),s.versionNow=s.version,(3<this.qqSaveCount||"click"==n||"all"==n||"netTrigger"==n||0<mindColla.errorSave)&&(s.qqSaveCount=0),mindColla.tdocSaveStatus="success",s.saveWpsStatusError=0,s.saveWpsIntervalTimer&&(clearInterval(s.saveWpsIntervalTimer),s.saveWpsIntervalTimer=null),s.saveToWPSErrorCount=0,$("#postwps-error-tip-temp").hide(),void setTimeout(function(){sendMessage("notify",{eventType:"save_success"})},100);var t,i;mindColla.tdocSaveStatus="error",mindColla.saveWpsStatusError++,"success"!=e.result&&(s.qqSaveCount=3,t=$("#postwps-notExist-dlg"),i="请您稍后尝试，如果仍提示失败，您可通过qq群（186074255） 反馈给我们！",postWpsErrorMsg.hasOwnProperty(e.result)?("SpaceFull"==e.result?(t.find(".mind-dlg-buttons").show(),t.find(".dialog-cancel").text("不了")):t.find(".mind-dlg-buttons").hide(),i=postWpsErrorMsg[e.result],t.find(".error-des").text(i),"block"!=t.css("display")&&t.dialog()):(s.saveToWPSErrorCount++,s.saveToWPSErrorCount<3?s.saveToWPSErrorCount:$("#postwps-error-tip-temp").show()),mind.messageSource.saveLocal(mind))},error:function(t){if(s.qqSaving=!1,mindColla.tdocSaveStatus="error",s.qqSaveTimeCount=0,s.qqSaveCount=3,"netTrigger"==n)return!1;PoNetwork.test({onlineCallback:function(){var e=$("#postwps-error-dlg");e.find(".error-des").text("请稍后尝试，如果仍提示失败，您可通过qq群（186074255） 反馈给我们！"),s.saveWpsStatusError++,0!=t.status&&(s.saveWpsErrorTip++,"block"!=e.css("display")&&1<s.saveWpsErrorTip&&(s.saveWpsErrorTip=0,$(mind.designer).trigger("mouseup"),e.dialog())),mind.messageSource.saveLocal(mind),0===t.status&&1==s.saveWpsStatusError&&(console.log("jqxr.status === 0+++++"),s.postData2Wps("netTrigger")),this.error=null}})}}))},saveLocalwps:function(){var e,t,i=document.createElement("canvas");i.getContext("2d"),i.toDataURL,""!=JSON.stringify(mind.model.topic)&&(null!=mind.currentRoot&&(e=mind.currentRoot.id,mind.currentRoot=null,delete(t=mind.model.getTopicById(e)).root,delete t.structure,JSON.stringify(mind.model.topic)),localStorage.setItem("def_"+file_id,JSON.stringify(mind.model.topic)))},errorOrder:[],errorOrderPush:function(e){var n=mind.model.topicList.data;if(e instanceof Array){for(var t=0,i=e.length;t<i;t++){var o,s=e[t];s&&"create"==s.action&&s.content&&s.content.content&&(o=s.content.content).forEach(function(e,t){var i=e.id;n.hasOwnProperty(i)&&delete o[t]})}mindColla.errorOrder=mindColla.errorOrder.concat(e)}},errorOrderHandling:!1,errorOrderHandle:function(){this.errorSave&&this.postData2Wps("netTrigger")},deleteRepeatCreate:function(e){var o={};return e instanceof Array&&Array.prototype.forEach.call(e,function(e){e.action&&"create"==e.action&&e.content&&e.content.content&&0<e.content.content.length&&!function i(n){Array.prototype.forEach.call(n,function(e,t){return e.id in o?(n.splice(t,1),console.log("msg-repeate"),!0):void((o[e.id]=e).children&&0<e.children.length&&i(e.children))})}(e.content.content)}),e},send:function(e){this.version++;var r=this,t=mind.util.copyArray(e);if($("#savetip").text(""),this.isSending)return this.tempMess=this.tempMess.concat(t),!1;this.mess=this.tempMess.concat(t),this.tempMess=[],this.isSending=!0;var a=JSON.stringify(this.deleteRepeatCreate(this.mess)),i={user_id:userId,encrypted_session:encrypted_session,client_id:"processon",file_id:file_id,msgStr:a,ignore:"msgStr",trace_id:trace_id,defId:defId,sync:!1};$.ajax({url:"/tdocs/template/mindmap/msg",data:i,cache:!1,type:"post",success:function(e){if(mindColla.isSending=!1,"error"==e.result){mindColla.poSaveStatus="error",mindColla.errorSave++,mindColla.qqSaveCount=3,console.log("result=error,pushmsg");try{for(var t=r.deleteRepeatCreate(r.mess),i="",n=0;n<t.length;n++)i+=t[n].action+";";poCollect1("接口报错:"+i,a,e.msg)}catch(e){console.log(e)}}else{"success"==e.result&&($("#manage_save_template").html("保存成功: "+(new Date).getHours()+":"+(new Date).getMinutes()+":"+(new Date).getSeconds()),r.errorSave=0);try{var o=mind.util.copyArray(mindColla.mess)}catch(e){mindColla.mess=[]}if(mindColla.mess=[],mindColla.poSaveStatus="success","undefined"!=typeof poWebSocket&&poWebSocket){var s={type:"_s@deliver",content:{client:r.userInfo.client,msg:o}};try{poWebSocket.send(JSON.stringify(s))}catch(e){}}setTimeout(function(){mind.plugins.navigator.init.call(mind)},100),mindColla.mess=[]}},error:function(e){mindColla.isSending=!1,mindColla.poSaveStatus="error",mindColla.errorSave++,mind.util.clearSelect(),mindColla.qqSaveCount=3,PoNetwork.test({onlineCallback:function(){e.status&&0==(e.status+"").indexOf("50")?$("#savetip").text("服务异常，未保存"):$("#savetip").text("有操作未保存")}});try{for(var t=r.deleteRepeatCreate(r.mess),i="",n=0;n<t.length;n++)i+=t[n].action+";";poCollect1("接口报错:"+i,a,e.msg)}catch(e){console.log(e)}}}),mindColla.poSaveStatus="success",setTimeout(function(){mind.plugins.navigator.init.call(mind)},100)},checkNetwork:function(){$.ajax({url:"/mindmap/checknetwork",success:function(e){"success"==e.result&&($("#savetip").text("正在保存..."),mindColla.doSync(chartId,function(){mindColla.closeTip(),mindColla.isOffLine=!1}))},error:function(){}})},saveCount:1,saving:!1,doSync:function(e,t){var i=mindUI.getFile(e);if(null!=i&&""!=$.trim(i)){var n=this;if(n.saving)return void $.showTip("还在保存中，请稍后尝试",2e3);var o,s,r=!(n.saving=!0);null!=mind.currentRoot&&(o=mind.currentRoot.id,mind.currentRoot=null,delete(s=mind.model.getTopicById(o)).root,delete s.structure,i=JSON.stringify(mind.model.topic),r=!0),$.ajax({url:"/mindmap/saveonline",type:"post",cache:!1,data:{id:e,def:i,shapecount:i.split('"children":[').length,ignore:"def"},success:function(e){"success"==e.result?(t(),r&&(mind.operation.focusTopic.call(mind,mind.model.topic.id),mind.operation.exitFocus.call(mind))):"error"==e.error&&($(".mind-offline-dlg .closeoff").prev().text("网络未连接"),setTimeout(function(){$(".mind-offline-dlg .closeoff").prev().text("已进入离线模式")},1500)),n.saving=!1},error:function(){n.saving=!1,$.showTip("保存失败，确保恢复网络后再次尝试",2e3)}})}else $.showTip("未找到本地数据，请编辑一下节点，再重新尝试",4e3)},showOffline:function(){},errorDlg2PopCount:0,showTip:function(){if(3<=this.errorDlg2PopCount){var e=mind.messageSource.undoStack.stack.slice(0,5),i=[];$.each(e,function(e,t){t&&$.each(t,function(e,t){i.push(t.action)})});var t=$("#postwps-error-dlg2");return 0<t.length&&"none"==t.css("display")&&$("#postwps-error-dlg2").dialog(),void(this.errorDlg2PopCount=0)}this.errorDlg2PopCount++},closeTip:function(){var e=$("#mind-error-tip");e.fadeOut(function(){e.remove()})},collaClient:null,collaUk:null,collaItv:null,collaUsers:{},collaUserClient:{},baseUrl:0<=window.location.host.indexOf("processon.com")?"https://cb.processon.com/":"/",webSocketUrl:"wss://tdocscolla.processon.com/websocket",userInfo:{defaultPort:window.location.origin+"/assets/images/user-port-default.png"},collaStart:function(){},heartCheck:{heartRate:1e4,timer:null,serverTimer:null,reset:function(){return clearTimeout(this.timer),clearTimeout(this.serverTimer),this},start:function(){var e=this;this.timer=setTimeout(function(){e.timer&&clearTimeout(e.timer),e.serverTimer&&clearTimeout(e.serverTimer);poWebSocket.send(JSON.stringify({type:"PING"})),e.serverTimer=setTimeout(function(){console.log("serverTimerColse"),e.reset(),mindColla.stopCollaDlg()},e.heartRate)},this.heartRate)}},createWebsocket:function(){},reconnecting:!1,reconnectTimer:null,reconnectCount:0,reconnectTimerSpace:1e4,socketReconnect:function(){},collaEventInit:function(){var l=this;poWebSocket.onopen=function(){l.reconnecting=!1,l.reconnectCount=1,poWebSocket.send(JSON.stringify({type:"ONLINE_USER"})),l.closeCollaElseDlg(),"undefined"!=typeof getCollaCountTimer&&getCollaCountTimer&&clearInterval(getCollaCountTimer)},poWebSocket.onmessage=function(e){console.log("socket msg");var t=JSON.parse(e.data);switch(t.type){case"pong":break;case"ONLINE_USER":var i=t.clients;if(console.log(i),null==i)return;l.collaUserCount=i.length,l.renderUsers(i);break;case"JOIN_IN":l.collaUserCount+=1,l.renderUsers(t.content,"join");break;case"LEAVE_OUT":--l.collaUserCount,l.renderUsers(t.content,"leave");break;case"_s@deliver":for(var n=t.content,o=n.msg,s=0;s<o.length;s++){var r=o[s];if(n.client!=l.userInfo.client){if(null!=r&&0<r.length){var a=r[0];if(null!=a&&"disable"==a.action){l.renderOff("focus"),mind.operation.setDisable.call(mind);break}null!=a&&a.action}if("outline"!=n.source)try{mind.messageSource.excuteMsgDirect.call(mind,n,function(e){l.showUserOp(e,n.client)})}catch(e){continue}else directMatch.outline.init(n)}}}l.heartCheck.reset().start()},poWebSocket.onerror=function(e){console.log("socket error"),console.log(e.code),l.heartCheck.reset(),setTimeout(function(){mindColla.stopCollaDlg()},500)},poWebSocket.onclose=function(e){console.log("socket onclose"),console.log(e.code),l.heartCheck.reset(),setTimeout(function(){mindColla.stopCollaDlg()},2e3)}},collaUserCount:1,saveVersion:function(){},collaCount:0,filterIllegalWord:function(e){return e.replace(/[(\ )(\!)(\@)(\#)(\$)(\%)(\^)(\&)(\*)(\\)(\')(\")(\,)(\.)(\/)(\<)(\>)(\?)]+/g,"")},renderUsers:function(e,t){var i=this;if(null==t&&e instanceof Array&&(i.collaUsers={},i.collaUserClient={},e.forEach(function(e){null==i.collaUserClient[e.clientId]&&(i.collaUserClient[e.clientId]=e),null==i.collaUsers[e.userId]&&(i.collaUsers[e.userId]=e,i.collaUserClient[e.clientId]=e)})),"join"==t&&(i.collaUserClient[e.clientId]=e,null==i.collaUsers[e.userId]&&(i.collaUsers[e.userId]=e),mindUI.forceExitFocus()),"leave"==t){var n=0;for(var o in i.collaUserClient){i.collaUserClient[o].userId==e.userId&&n++}i.collaUserClient[e.clientId]&&delete i.collaUserClient[e.clientId],i.collaUsers[e.userId]&&0<n&&n<2&&delete i.collaUsers[e.userId]}},userOpCount:{},showUserOp:function(e,t){var i,n,o,s,r,a,l=mindColla.collaUserClient[t];null!=l&&0!=e.length&&(i=e[0],null!=(n=$("#"+i))&&(o=n.offset(),0==(a=$(".colla-user-tip-con[uk="+t+"]")).length&&(s=decodeURIComponent(l.avatar||this.userInfo.defaultPort),r=l.userName||"访客",a=$("<div uk='"+t+"' class='colla-user-tip-con'><img src='"+s+"'/> <span>"+mindUI.collaDecode(r)+"</span>正在编辑</div>").appendTo("body"),null!=mindColla.userOpCount[t]&&window.clearTimeout(mindColla.userOpCount[t]),mindColla.userOpCount[t]=setTimeout(function(){a.fadeOut().remove()},2e3)),a.css({left:o.left+n.outerWidth()+12,top:o.top+n.outerHeight()/2-a.outerHeight()/2,display:"block"})))},stm:null,showCollaTip:function(e,t,i){for(var n,o="",s=[],r=0;r<t.length;r++){var a,l=t[r],d=this.collaUsers[l];"join"==i?(a="/photo/"+d.userId+".png",0<=window.location.host.indexOf("processon.com")&&(a="https://accounts.processon.com/photo/"+d.userId+".png"),s.indexOf(d.userId)<0&&(n="<div uid='"+l+"' class='colla-user' title_pos='top' title='"+d.name+"'><a target='_blank' href='/u/"+d.uname+"/profile'><img src='"+a+"'/></a></div>",e.append(n),s.push(d.userId))):e.find("[uid="+l+"]").remove(),null!=d&&d.client!=mindColla.collaClient&&(""!=o&&(o+=","),o+=d.name)}},setReadOnly:function(){"undefined"!=typeof mind&&(mind.opts.readonly=!0,$(document).off("selectstart"))},stop:function(){poWebSocket.close(1e3)},cooperatingSending:!1,cooperatingSend:function(t){var i=this,n=1;i.cooperatingSending?t&&t(n):(i.cooperatingSending=!0,$.ajax({url:"https://wpscb.processon.com/online_user",data:{chartId:file_id},cache:!1,type:"GET",async:!0,success:function(e){i.cooperatingSending=!1,e&&1<e.length&&(n=e.length),t&&t(n)},error:function(){i.cooperatingSending=!1,t&&t(n)}}))},stopCollaDlg:function(e){var t=this;if("undefined"!=typeof getCollaCountTimer&&getCollaCountTimer&&clearInterval(getCollaCountTimer),Object.keys(t.collaUserClient).length<2&&!e)return t.socketReconnect(),void(getCollaCountTimer=setInterval(function(){t.cooperatingSend(function(e){1<e&&t.stopCollaDlg(!0)})},2e4));var i=$("#stop-colla-dlg");0==i.length&&(i=$('<div id="stop-colla-dlg" class=" mind-dlg" style="width: 400px;min-height: 158px; "><h3 style="padding:3px 18px;margin-bottom:16px;">协作断开</h3><div style="padding:0px 18px;margin-bottom:12px;"><div style="font-size:14px;">当前文档处于多人协作，协作中断后需同步到最新才能继续编辑。</div></div><div style="margin:10px 0;" class="mind-dlg-buttons"><span style="margin-right: 20px;" onclick="location.reload();" class="mind-button">同步最新</span></div></div>').appendTo($(".mind-util-container"))),"block"!=i.css("display")&&(i.dialog({closable:!1}),this.closeCollaElseDlg("stop"))},closeCollaElseDlg:function(e){var t,i={support:"#suppor-colla-dlg",stop:"#stop-colla-dlg",server:"#colla-server-error"};for(var n in i){e!=n&&(0<(t=$(i[n])).length&&t.dialog("close"))}$(".offline-dlg").dialog("close")},collaServerError:function(){var e=$("#colla-server-error");0==e.length&&(e=$('<div id="colla-server-error" class=" mind-dlg" style="width: 400px;"><h3>协作异常</h3><div><div style="font-size:14px;">当前多人协作未成功连接，请确保网络通畅的情况，稍后重试。</div></div><div class="mind-dlg-buttons"><span class="mind-button" style="margin-right: 20px;" onclick="location.reload()">刷新重试</span></div></div>').appendTo($(".mind-util-container"))),e.dialog(),this.closeCollaElseDlg("server")},notSupportColla:function(){0==$("#suppor-colla-dlg").length&&$('<div id="suppor-colla-dlg" class=" mind-dlg" style="width: 400px;"><h3 style="padding:0px 18px;margin-bottom:16px;">协作提醒</h3><div style="padding:0px 18px;margin-bottom:12px;"><div style="font-size:14px;">当前存在多个终端正在编辑文件，当前浏览器版本暂不支持协作，请在其他浏览打开尝试或进入浏览模式</div></div><div style="margin:10px 0;" class="mind-dlg-buttons"><span class="mind-button" style="margin-right: 20px;" onclick="location.href.replace(\'diagrams/view\', \'diagrams/edit\')">预览模式</span></div></div>').appendTo($(".mind-util-container")),this.closeCollaElseDlg("support")},renderOff:function(e){if(0<$("#stop_listen_tip").length)return $("#stop_listen_tip").dialog(),void $("#stop_listen_tip").find(".mind-dlog-close").remove();mindColla.saveVersion(),$('<div id="stop_listen_tip" class="mind-dlg"><h3>提示</h3><div class="mind-dlg-content">'+("focus"==e?"其他浏览器已经进入聚焦模式<br><br>只允许一端存在编辑操作，防止数据出现覆盖或者丢失，您可以关闭此页面<br><br></div>":'当前存在多个终端正在编辑文件<br><br>无法离线，系统已自动为您存储历史版<br><br><div>点击 <a style="color:#63abf7;cursor:pointer" onclick="location.reload();">刷新恢复</a></div>')+"<br><br></div></div>").appendTo("body").dialog(),$("#stop_listen_tip").find(".mind-dlog-close").remove()},renderTipDig:function(){0<$("#focus_dlg_tip").length?$("#focus_dlg_tip").dialog():$('<div id="focus_dlg_tip" style="width:466px;height:208px;" class="mind-dlg"><h3>提示</h3><div class="mind-dlg-content">暂时无法进入聚焦模式<br><br>因为当前存在多人同时编辑脑图，进入聚焦模式会影响其他人正常操作。<br><br><br><div><a style="color:#63abf7;cursor:pointer" onclick="mindColla.renderTipDigClose();">放弃聚焦</a></div><br><br></div></div>').appendTo("body").dialog()},renderTipDigClose:function(){$("#focus_dlg_tip").dialog("close")}},mindUI={chartId:function(){return chartId},newId:function(){return this.newIdS4()+this.newIdS4()+this.newIdS4()},newIdS4:function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},forceExitFocus:function(){0==$(".mind-topic-focus").length||0<$("#root").length||(mind.operation.focusTopic.call(mind,mind.model.topic.id,!0,!1),mind.operation.exitFocus.call(mind),$.showTip("您的文件处于多人协作， 已退出聚焦模式",3e3))},collaDecode:function(t){if(t)try{return decodeURI(t)}catch(e){return t}},initStructureIcon:function(e,t){t&&"mind_right"==e&&t.model.topic.leftChildren&&0<t.model.topic.leftChildren.length&&0==t.model.topic.children.length&&(e="mind_left");var i=$(".opt-select[tit=mind_structure]").children().first("span");"mind_right"==e?i.html("右侧分布"):"mind_org"==e?i.html("组织结构"):"mind_left"==e?i.html("左侧分布"):"mind_tree"==e?i.html("树状结构"):"mind_free"==e&&i.html("左右分布")},setTopUpgradeBtnB:function(){var e=$("#mind_topics_details"),t=e.find("#bot-nodevip-btn");0<t.length&&t.remove(),(t=$('<div title="当前上限100，升级节点数上限" title_pos="top" id="bot-nodevip-btn" class="bot-nodevip-btn">升级上限</div>')).appendTo(e),-1<tdocVipInfo.indexOf(30)||-1<tdocVipInfo.indexOf(40)?t.hide():(t.css("display","inline-block"),-1<tdocVipInfo.indexOf(20)?t.attr("title","当前上限200，升级节点数上限"):t.attr("title","当前上限100，升级节点数上限"))},showDownload:function(){$("#download_menu").css({left:6,top:38}).show(),$(document).off("mousedown.hidemenu").on("mousedown.hidemenu",function(){$("#download_menu").hide()}),$("#download_menu").off("mousedown.hidemenu").on("mousedown.hidemenu",function(e){e.stopPropagation()}),$("#download_menu").children().off().on("click",function(){var e=$(this).attr("ac");e&&mindUI.exportFile.handle(e),$("#download_menu").hide()})},openImportGuide:function(){},closeImportGuide:function(e){$("#importGuide-nodlg-check").hasClass("checked")&&localStorage.setItem("importGuide-nodlg-flag","1")},closeHistory:function(e){null==e&&(e=this.currentDef),mind.operation.clearCanvas.call(mind),mind=new mindDesigner("#mind_con",{chartId:chartId},e),mind.operation.setEnable.call(mind),this.currentDef=null,mindUI.isViewingHistory=!1,mindUI.currentDefId=null,$("#history_versions").find(".active").removeClass("active"),$("#btn-history-restore").addClass("mind-disable").removeClass("active"),$("#mind-history-tip").css({top:-56}).hide()},revertHistory:function(e){sendMessage("restore",{ret:0,message:"还原成功"}),location.reload()},sendVersion:function(e,i){var t={user_id:userId,encrypted_session:encrypted_session,file_id:file_id,client_id:"processon",trace_id:trace_id,scene:scene,version:e,type:i};$.post("/diagrams/revision",t,function(e){var t;if("success"==e.result){if("view"==i)mindUI.openHistory(e.def),$("#mind-history-tip").css({top:56,marginLeft:-122}).show().find(".mind-tip-text").html("<@i18n resource='diagraming.history.viewing'/><a href='javascript:' style='margin-left: 10px;color:#fff;text-decoration:underline;' onclick='mindUI.closeHistory()'><@i18n resource='diagraming.history.back'/></a>");else if("rollback"==i){if(null==e.def)return;mindUI.revertHistory(data.def)}}else"view"==i?(console.log("view","预览失败------------------------------------------"),t={ret:1,message:"预览失败"},sendMessage("view",t)):"rollback"==i&&(console.log("rollback","还原失败------------------------------------------"),t={ret:0,message:"还原失败"},sendMessage("rollback",t))})},exportFile:{type:null,partId:null,handle:function(e,t,i){if(this.errorNum=0,this.errorUrls=[],this.proUrlObj={},this._errorUrls=[],this.type=e,this.partId=t||null,"pof"!=e){var n=t?"&partId="+t:"";if(this.exportUrlType="pnghd"==e?"png":"jpghd"==e?"jpg":"pdfhd"==e?"pdf":e,this.cos_url=i,this.url=encodeURI(exportUrl+"/diagram_export/mind?chartId="+chartId+"&type="+this.exportUrlType+"&title="+encodeURIComponent(chartTitle)+"&user_id="+userId+"&encrypted_session="+encrypted_session+"&client_id="+client_id+"&file_id="+file_id+"&trace_id="+trace_id+"&scene="+scene+n),this.filter="png"==e||"pnghd"==e?"图片格式 (*.png)":"pos"==e?"POS格式(*.pos)":"word"==e?"Word大纲文件(*.docx)":"ppt"==e?"PPT模板文件(*.pptx)":"jpg"==e||"jpghd"==e?"JPG图片文件(*.jpg)":"svg"==e?"SVG格式(*.svg)":"fmind"==e?"FreeMind格式(*.mm)":"PDF格式 (*.pdf)",this.openAfterDownloaded="false","png"==e||"tdoc_docx"==e||"tdoc_pptx"==e)if("png"==e)this.drawImage();else{if("tdoc_docx"==e||"tdoc_pptx"==e)return this.openAfterDownloaded="true",void this.sendCosUrl(e);this.clientRequest()}else{var o=this;if(mind.util.testVipState(function(){if(-1==tdocVipInfo.indexOf(20)&&-1==tdocVipInfo.indexOf(30)&&-1==tdocVipInfo.indexOf(40))return o.url=null,mindUI.showVipLimitDlg("download_"+e),void o.clientRequest(1)},"download_"+e),-1==tdocVipInfo.indexOf(20)&&-1==tdocVipInfo.indexOf(30)&&-1==tdocVipInfo.indexOf(40))return;if("jpg"==e||"pdf"==e||"svg"==e||"pnghd"==e||"jpghd"==e||"pdfhd"==e)this.drawImage();else{if("tdoc_docx"==e||"tdoc_pptx"==e)return this.openAfterDownloaded="true",void this.sendCosUrl(e);this.clientRequest()}}}else{localStorage.getItem("userpoftips")?createQuickOpen():(localStorage.setItem("userpoftips","1"),$(".quick-open-dlg").dialog())}},url:"",openAfterDownloaded:!1,exportUrlType:"",filter:"",sendCosUrl:function(e){var t=this,i={cos_url:this.cos_url,chartId:"tencent",fileId:file_id,category:e,scene:scene,ignore:"cos_url",user_id:userId,encrypted_session:encrypted_session,client_id:"processon",trace_id:trace_id};$.post("/mindmap/pre_export_image",i,function(e){"success"==e.result?t.clientRequest():t.clientRequest(2)})},clientRequest:function(e){var t={ret:e||0,type:this.exportUrlType};this.url&&(t.url=this.url),this.cos_url&&(t.cos_url=this.cos_url),sendMessage("export_file",t),$("#svg-wrap").remove(),poCollect("result_downfile",{result:"success",type:t.type,page:"mind_editor",userId:userId,vip:tdocVipInfo.join(","),povip:po_is_vip,device:deviceType})},drawImage:function(){var u=this.type,n=this.partId,h=this,o=!0;function s(e,t){var i={isView:!1,isVip:o,imgBgW:e,imgBgH:t,partId:n,type:u};MindToSvg.init(function(e,t){var i='<?xml version="1.0" standalone="no"?><?xml-stylesheet type="text/css" href="https://www.processon.com/themes/default/mind/icons/icons.css" ?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'+$("#svg-wrap").html().replace(/&nbsp;/g," ");if("svg"!=u)return function l(d,c,m,e){var p=e||1;-1!=u.indexOf("hd")&&null==e&&(p=h.scaleMax(c,m));console.log("图片大小："+c+"*"+m+"="+c*m);if(c*m>268435456/Math.pow(p,2))return $.showTip("文件内容超出下载限制",3e3),void poCollect("result_downfile",{result:"failed",type:u,reason:"文件内容超出下载限制",page:"mind_editor",userId:userId,vip:tdocVipInfo.join(","),povip:po_is_vip,device:deviceType});$("#svg-wrap").html('<canvas id="canvas_exporter" width="'+c*p+'" height="'+m*p+'"></canvas>');canvg("canvas_exporter",d.replace(/\u00a0/g,"<tspan> </tspan>"),{log:!0,ignoreDimensions:!0,enableRedraw:!0,ignoreClear:!0,forceRedraw:!0,useCORS:!0,scaleWidth:c*p,scaleHeight:m*p,renderCallback:function(){if(0<h.errorNum)console.log("后台导出");else{console.log("前端导出");var e,t,i,n=document.getElementById("canvas_exporter");if(i="jpg"==u||"jpghd"==u?(e=n.toDataURL(),t=chartTitle||"无标题思维导图","jpg"):"pdf"==u||"pdfhd"==u?(e=n.toDataURL(),t=chartTitle||"无标题思维导图","pdf"):(e=n.toDataURL(),t=chartTitle||"无标题思维导图","png"),e.length<10)2<p?l(d,c,m,2):1<p?l(d,c,m,1):($.showTip("文件内容超出下载限制",3e3),poCollect("result_downfile",{result:"failed",type:u,reason:"文件内容超出下载限制",page:"mind_editor",userId:userId,vip:tdocVipInfo.join(","),povip:po_is_vip,device:deviceType}));else{if(console.log("实际放大倍数："+p),"jpg"==i||"png"==i)return a(URL.createObjectURL(r(e)),t+"."+i),h.url=null,void h.clientRequest();var o=new FormData,s=new Blob([e],{type:"text/plain"});o.append("content",s),o.append("category",i),o.append("chartId",chartId),o.append("user_id",userId),o.append("fileId",fileId),o.append("encrypted_session",encrypted_session),o.append("client_id","processon"),o.append("trace_id",trace_id),o.append("scene",scene),o.append("ignore",i+"Text"),$.ajax({url:"/mindmap/pre_export_image",data:o,timeout:6e4,type:"post",processData:!1,contentType:!1,success:function(e){"success"===e.result?(h.url=encodeURI(exportUrl+"/diagram_export/mind?chartId="+chartId+"&type="+h.exportUrlType+"&title="+encodeURIComponent(chartTitle)+"&user_id="+userId+"&encrypted_session="+encrypted_session+"&client_id="+client_id+"&file_id="+file_id+"&trace_id="+trace_id+"&scene="+scene+"&exportType=base64"),h.clientRequest()):(console.log(e),sendMessage("export_file",{ret:1,message:"下载图片失败，请重新尝试"}),poCollect("result_downfile",{result:"failed",type:u,reason:"下载图片失败",page:"mind_editor",userId:userId,vip:tdocVipInfo.join(","),povip:po_is_vip,device:deviceType}))},error:function(e){console.log("[下载高清PNG] 上传图片失败"),sendMessage("export_file",{ret:1,message:"下载图片失败，请重新尝试"}),poCollect("result_downfile",{result:"failed",type:u,reason:e.statusText,page:"mind_editor",userId:userId,vip:tdocVipInfo.join(","),povip:po_is_vip,device:deviceType})},complete:function(e,t){"timeout"==t&&(sendMessage("export_file",{ret:1,message:"下载图片超时，请重新尝试"}),poCollect("result_downfile",{result:"failed",type:u,reason:"下载图片超时",page:"mind_editor",userId:userId,vip:tdocVipInfo.join(","),povip:po_is_vip,device:deviceType}))}}),$("#svg-wrap").remove()}}function r(e){for(var t=atob(e.split(",")[1]),i=t.length,n=new Uint8Array(i),o=0;o<i;o++)n[o]=t.charCodeAt(o);return new Blob([n],{type:"image/png"})}function a(e,t){var i=new MouseEvent("click",{view:window,bubbles:!1,cancelable:!0}),n=document.createElement("a");n.setAttribute("download",t),n.setAttribute("href",e),n.setAttribute("target","_blank"),n.dispatchEvent(i)}}})}(i,e,t),!1;$.ajax({url:"/mindmap/pre_export_svg",data:{svgText:i,category:"svg",chartId:chartId,userid:userId,fileId:fileId,ignore:"svgText"},type:"post",success:function(){h.url=encodeURI(exportUrl+"/diagram_export/mind?chartId="+chartId+"&type="+h.exportUrlType+"&title="+encodeURIComponent(chartTitle)+"&user_id="+userId+"&encrypted_session="+encrypted_session+"&client_id="+client_id+"&file_id="+file_id+"&trace_id="+trace_id+"&scene="+scene+"&exportType=base64"),h.clientRequest()},error:function(){console.log("上传svg失败")}}),setTimeout(function(){MindToSvg.container.innerHTML=""},1e3)},i)}100!=mind.operation.zoomVal&&(mind.operation.zoomVal=100,$(".mind-zoomtxt").text(100),$(".mind-designer").css({transform:"scale(1)","-webkit-transform":"scale(1)","-moz-transform":"scale(1)"})),setTimeout(function(){var e,i,t=mind.style.getThemeStyle.call(mind,null);-1<(e=mind.opts.themeDef&&null!=mind.opts.themeDef&&null!=mind.opts.themeDef.background?mind.opts.themeDef.background:t.background).indexOf("url")?((i=document.createElement("img")).onload=function(){var e=this.width,t=this.height;i.remove(),s(e,t)},i.src=e.replace("url(","").replace(")","")):s(0,0)},300)},scaleMax:function(e,t){var i=Math.sqrt(268435456/(Math.ceil(e)*Math.ceil(t))),n=Math.floor(10*i)/10;return console.log("最大放大倍数："+n),8<n?3:4<n?2:2<n?1.5:1},errorNum:0,errorUrls:[],proUrlObj:{},_errorUrls:[],exportError:function(e){this.errorUrls.indexOf(e)<0&&this.errorUrls.push(e),this.type.indexOf("hd"),0<this.errorNum||(console.log("后台导出"),this.url=null,Util.globalTopTip("有不授信图片无法下载","top_error",3e3),this.clientRequest("E004"),$("#svg-wrap").remove(),this.errorNum++)},exportErrorTip:function(e){console.log(e),0<this.errorNum||(Util.globalTopTip("不授信图片无法下载","top_error",5e3),this.errorNum++)}},upgradeVip:function(){var e,t=limitAid[limitType];console.log("aid="+t),t&&(e={encrypted_session:encrypted_session,user_id:userId,trace_id:trace_id,client_id:client_id,file_id:file_id,file_type:"mind",source:"mind"},$.ajax({url:"/order/preOrder",type:"POST",data:e,success:function(e){if("success"==e.result)return orderId=e.order_id,$(".tdoc-vip-dlg").is(":visible")&&$(".tdoc-vip-dlg").dialog("close"),sendMessage("notify",{eventType:"joinMembership",aid:t}),void poCollect("result_pre_order",{result:"success",position:t,orderid:orderId,page:"mind_editor",userId:userId,vip:tdocVipInfo.join(","),povip:po_is_vip,device:deviceType});console.log("预下单失败"),Util.globalTopTip("打开开通会员窗口失败","top_error",4e3),poCollect("result_pre_order",{result:"failed",position:t,page:"mind_editor",userId:userId,vip:tdocVipInfo.join(","),povip:po_is_vip,device:deviceType,reason:e.msg})},error:function(e){console.log("error"),Util.globalTopTip("打开开通会员窗口失败","top_error",4e3),poCollect("result_pre_order",{result:"failed",position:t,page:"mind_editor",userId:userId,vip:tdocVipInfo.join(","),povip:po_is_vip,device:deviceType,reason:e.statusText})}}))},switchExpireTime:function(e){if(!e)return"";var t=new Date(e);return t.getFullYear()+"/"+(+t.getMonth()+1)+"/"+t.getDate()},expireTimeJudge:function(e,t){var i=(new Date).getTime();return 0<e-i&&e-i<24*t*60*60*1e3},changeExpandStyle:function(e){function t(e){for(var t=0;t<e.length;t++){var i=$(e[t]),n=i.parent().attr("id"),o=$("#line_"+n).attr("stroke");o&&i.css({color:o,"border-color":o})}}t(null==e?$(".expand_box"):$("#"+e.id).parent().find(".expand_box"))},showImport:function(){window.importSupportCallback=null,window.importSupportCallback=function(e){JSON.parse(e).result?bigPipe.render({js:["/assets/js/plugins/promise-1.0.0.js","/assets/js/plugins/jquery.xml2json.js","/assets/js/plugins/zip.js","/assets/js/plugins/import.min.js"]},function(){$("#dlg_import").dialog({onClose:function(){$("#import_btn").html("添加文件"),document.querySelector("#share_upload_form").reset(),$("#share_doc_import").replaceWith('<input id="share_doc_input" class="file-upload" name="file" type="file" accept=".pos,.mmap,.mm,.km,.opml,.txt" />')}})}):$(".apiSupport-error-dlg").dialog()},window.cefQuery({request:'jsAsynCall(\'{"method": "common.util.support","params" :{"api": "importFile"}, "callback": "importSupportCallback"}\')'})},saveTamp:0,getRandomColor:function(){return["rgb(255, 244, 179)","rgb(179, 229, 255)","rgb(196, 179, 255)","rgb(236, 255, 179)","rgb(216, 210, 210)"][parseInt(5*Math.random())]},filterXss:function(e){return null==e||""==e?"":e=(e=(e=(e=(e=(e=(e=e.toString()).replace(/</g,"&lt;")).replace(/%3C/g,"&lt;")).replace(/>/g,"&gt;")).replace(/%3E/g,"&gt;")).replace(/'/g,"&#39;")).replace(/"/g,"&quot;")},restoreXss:function(e){return null==e||""==e?"":e=(e=(e=(e=e.replace(/&lt;/g,"<")).replace(/&gt;/g,">")).replace(/&#39;/g,"'")).replace(/&quot;/g,'"')},setTopicLworBw:function(i){var n=$("#mind_topic_border_w"),t=$("#mind_topicline_width");n.numberBox({width:100,min:0,max:6,callback:function(e){if(e<0)return e=0,void n.find("input").val(parseInt(e)+"px");if(6<e)return e=6,void n.find("input").val(parseInt(e)+"px");var t={"border-width":e};i.operation.setStyle.call(i,t),tdocCollect({module:"node",opername:"mind",action:"fill_bold",ver5:e,ver6:""})}},2),t.numberBox({width:100,min:1,max:6,callback:function(e){if("root"!=i.util.getSelectedId()){if(e<1)return e=1,void t.find("input").val(parseInt(e)+"px");if(6<e)return e=6,void t.find("input").val(parseInt(e)+"px");mind.operation.setStyle.call(mind,{"line-width":e}),console.log(e),tdocCollect({module:"line",opername:"mind",action:"bold",ver5:e,ver6:""})}}},2)},changeOpStatus:function(e){var t=e.util.selectedIds;if(0==t.length)$(".header-op-item").each(function(e,t){var i=$(t).attr("tit");"quick_to_outline"!==i&&"mind_layout"!==i&&"shortcut"!==i&&"mind_guide"!==i&&"mind_book"!==i&&"undo"!=i&&"redo"!=i&&$(t).addClass("mind-disable1")}),$("#topic-style-con").find(".opt-select").addClass("mind-disable1"),$(".mind-dock-right-mg").addClass("mind-disable1");else{$(".header-op-item").removeClass("mind-disable1"),$(".mind-dock-right-mg").removeClass("mind-disable1"),$("#mind_brash").removeClass("mind-disable1"),$("#topic-style-con").find(".opt-select").removeClass("mind-disable1");var i=e.currentRoot||e.model.topic;1<t.length&&(r("mind_summary"),r("toolbar_but_insert"),r("mind_insert_child"),r("mind_insert_parent"),r("mind_insert_brother"),$("#mind_brash").addClass("mind-disable1"));for(var n=0;n<t.length;n++){var o=t[n],s=e.model.getTopicById(o);if(o==i.id||s&&s.free||$("#"+o).hasClass("summary")){$(".header-op-item[tit=mind_summary]").addClass("mind-disable1"),$("[tit=mind_insert_brother]").addClass("mind-disable1"),$("[tit=mind_insert_parent]").addClass("mind-disable1");break}}}function r(e){$("[tit="+e+"]").addClass("mind-disable1")}"mind_tree"==e.model.topic.structure&&$(".header-op-item[tit=mind_summary]").addClass("mind-disable1"),mindUI.resetHeadOp.icon(e)},resetHeadOp:{icon:function(e){$(".show_right_con .mind-icons-item [ico].selected").removeClass("selected");var t=e.util.getSelectedId(),i=e.model.getTopicById(t);i&&i.icons&&(i.icons||[]).forEach(function(e){e&&e.index&&0<=e.index&&e.index<=64&&$(".show_right_con .mind-icons-item [ico="+e.index+"]").addClass("selected")})}},initDock:function(e){var t=mind.model.topic;e.root||$(".brash").removeClass("mind-disable"),e.summary||e.free?$(".header-op-item > [tit=mind_insert_brother]").addClass("mind-disable1"):$(".header-op-item > [tit=mind_insert_brother]").removeClass("mind-disable"),"root"==e.id||e.summary||e.free?($(".header-op-item > [tit=mind_insert_parent]").addClass("mind-disable1"),$(".opt-select[tit=mind_topicline_color]").addClass("mind-disable1"),$("#mind_topicline_width").addClass("mind-disable1")):($(".header-op-item > [tit=mind_insert_parent]").removeClass("mind-disable1"),$(".opt-select[tit=mind_topicline_color]").removeClass("mind-disable1"),$("#mind_topicline_width").removeClass("mind-disable1"));var i,n,o,s,r,a,l,d,c=mind.style.getStyle.call(mind,e),m=t.background||mind.styles.background;null!=e.style&&(n=(i=e.style)["font-size"],o=i["font-family"],s=i.color,r=i["font-weight"],a=i["font-style"],l=i["text-align"],d=i["background-color"]),"bold"==(r||c["font-weight"])?$("#mind-font-b").addClass("selected"):$("#mind-font-b").removeClass("selected"),"italic"==(a||c["font-style"])?$("#mind-font-i").addClass("selected"):$("#mind-font-i").removeClass("selected"),"underline"==c["text-decoration"]?$("#mind-font-u").addClass("selected"):$("#mind-font-u").removeClass("selected"),"line-through"==c["text-decoration"]?$("#mind-font-ml").addClass("selected"):$("#mind-font-ml").removeClass("selected");var p,u,h,f,g=c["border-width"],v=c.border;null!=g||v?(u=(p=$("#"+e.id)).css("border-width"),h=p.css("border-style"),f=p.css("border-color"),h&&"double"==h&&(u=Math.floor(parseInt(u)/3)+"px"),$("#mind_topic_border_w").find("input").val(u),$(".opt-select[tit=mind_topic_border_t]").children().first().attr("line",h),$(".opt-select[tit=mind_topic_border_c]").children().first().css("backgroundColor",f)):($("#mind_topic_border_w").find("input").val("0px"),$(".opt-select[tit=mind_topic_border_t]").children().first().attr("line","solid"),$(".opt-select[tit=mind_topic_border_c]").children().first().css("backgroundColor","#ffffff"));var b,_=c.lineStyle;null!=_&&($(".opt-select[tit=mind_topicline_color]").children().first().css("backgroundColor",_.lineColor),b=parseInt(_.lineWidth)+"px",$("#mind_topicline_width").find("input").val(b));var w,y,k,C,I=c["border-radius"];null!=I&&(I=parseInt(I),y=(w=$("#mind_border_radius")).find("li[tp=0]").html(),5==I?y=w.find("li[tp=5px]").html():0==I?y=w.find("li[tp=0]").html():30==I&&(y=w.find("li[tp=30px]").html()),$(".opt-select[tit=mind_border_radius]").children().first().html(y)),$(".opt-select[tit=mind_topic_font]").children().first().text(o||c["font-family"]),$(".opt-select[tit=mind_topic_font_size]").children().first().text(null==n?c["font-size"]:n),$(".opt-select[tit=mind_topic_txt_color]").children().first().css("backgroundColor",s||c.color),$("#mind-font-left").removeClass("selected"),$("#mind-font-center").removeClass("selected"),$("#mind-font-right").removeClass("selected"),(l||c["text-align"])&&(k=l||c["text-align"],$("#mind-font-"+k).addClass("selected")),null!=d||null!=c.backgroundColor?(C=d||c.backgroundColor,console.log(C),$(".opt-select[tit=mind_topic_bgcolor]").children().first().css("backgroundColor",C)):$(".opt-select[tit=mind_topic_bgcolor]").children().first().css("backgroundColor","#ffffff"),$(".opt-select[tit=mind_canvas_bgcolor]").children().first().css("backgroundColor",m);var T,x,S,U,D,P,L,O=e.note,N=e.tags,E=e.link,H=e.task;if(O?(T=mindUI.restoreXss(O),$("#mind-topic-remack").val(T)):$("#mind-topic-remack").val(""),N){for(var W=$("#mind-topic-tags"),M="",A=0,q=N.length;A<q;A++){var j=N[A];M+="<span style='color:"+j.color+";background:"+j.background+"'><label>"+j.text+"</label> <label class='mind-icons'>&#xe622;</label></span>"}W.html(M)}else $("#mind-topic-tags").html("");E?($("#mind-topic-link").val(E.value),$("#mind-topic-linktitle").val(E.title)):($("#mind-topic-link").val(""),$("#mind-topic-linktitle").val("")),H?(x=$("#mind-icons-priority-list"),S=$("#mind-icons-completion-list"),U=x.find("li[priority="+H.priority+"]").clone(),D=S.find("li[completion="+H.completion+"]").clone(),U.find("span").remove(),D.find("span").remove(),P=U.text(),L=D.text(),""!=P?$("#mind-task-priority").children("span").text(P):$("#mind-task-priority").children("span").text("无"),""!=L?$("#mind-task-completion").children("span").text(L):$("#mind-task-completion").children("span").text("无"),D.remove(),U.remove(),$("#mind-task-start").children("span").text(H.start||"无"),$("#mind-task-end").children("span").text(H.end||"无"),$("#mind-task-assigned").val(H.assigned)):($("#mind-task-priority").children("span").text("无"),$("#mind-task-completion").children("span").text("无"),$("#mind-task-start").children("span").text("无"),$("#mind-task-end").children("span").text("无"),$("#mind-task-assigned").val(""))},getFile:function(e){return localStorage.getItem("def_"+e)},saveFile:function(e,t){localStorage.setItem("def_"+e,t)},removeFile:function(e){localStorage.removeItem("def_"+e)},setLocalFiles:function(){var e,t,i,n,o=localStorage,s=[],r=o.getItem("localFiles")||"[]",a=JSON.parse(r);for(var l in o){"currentId"==l||"currentTitle"==l||0<=l.indexOf("def_local")||l.indexOf("def_")<0||(e=o[l],t=JSON.parse(e),function(e,t){if(0==t.length)return!1;for(var i=!1,n=0,o=t.length;n<o;n++){if(t[n].id==e){i=!0;break}}return i}(i=l.substring(4),a)||(n={id:i,title:t.title,localId:localId},s.push(n)))}a=a.concat(s),o.setItem("localFiles",JSON.stringify(a))},loadRecentFiles:function(){""!=chartId&&$.ajax({url:"/mindmap/getrecentfiles",success:function(e){var t=$(".mind-title-menu-con");if(t.html(""),null!=e.charts)for(var i=e.charts,n=0,o=i.length;n<o;n++){var s=i[n],r=$('<div id="title_'+s.chartId+'" class="mind-title-menu-item"><a href="/mindmap/'+s.chartId+'">'+s.title+'</a><span style="float:right;">'+s.lastModify+"</span></div>");s.chartId==mindUI.chartId()&&r.addClass("active"),t.append(r)}}})},loadLocalFiles:function(){var e=localStorage.getItem("localFiles"),t=$(".mind-title-menu-con");if($(".mind-title-menu-item").remove(),null!=e){for(var i=JSON.parse(e),n=0,o=i.length;n<o;n++){var s,r=i[n];r.localId==localId&&(s=$('<div id="title_'+r.id+'" class="mind-title-menu-item"><a>'+r.title+'</a><span class="mind-icons">&#xe622;</span></div>'),r.id==mindUI.chartId()&&s.addClass("active"),t.append(s))}$(".mind-title-menu-item").on("click",function(){var e=$(this).attr("id").replace("title_","");mindUI.openFile(e)}),$(".mind-title-menu-item .mind-icons").on("click",function(e){var t=$(this).parent(),i=t.attr("id");t.parent().find(".mind-file-delete").remove();var n=$("<div class='mind-file-delete'><span class='delete'>确认删除</span> <span class='cancel'>取消</span></div>");n.appendTo(t),n.animate({left:0},50),$(".mind-title-menu-item .delete").on("click",function(e){0<=i.indexOf("title_")&&(i=i.substring(6)),mindUI.deleteLocalFile(i),t.remove(),e.stopPropagation()}),$(".mind-title-menu-item .cancel").on("click",function(e){$(this).parent().parent().find(".mind-file-delete").remove(),e.stopPropagation()}),e.stopPropagation()})}},deleteLocalFile:function(e){var t=localStorage.getItem("localFiles"),i=JSON.parse(t),n=[];for(var o in i){var s=i[o];s.id!=e&&n.push(s)}var r=n[0];localStorage.setItem("localFiles",JSON.stringify(n)),localStorage.removeItem("def_"+e),e==chartId&&(null!=r?$(".mind-title-menu-item:first").trigger("click"):(localStorage.removeItem("localFiles"),localStorage.removeItem("currentId"),localStorage.removeItem("currentTitle"),$(".header-item .title").text(""),mind.operation.clearCanvas.call(mind),window.location.hash=""))},isAdding:!1,addHistory:function(){},currentDef:null,currentDefId:null,isViewingHistory:!1,loadHistorys:function(){var r,a;""!=chartId&&(r=$("#history_versions"),a="",0==r.length&&(r=$('<ul id="history_versions"><ul>').appendTo($("#history-container"))),$.ajax({url:"/diagraming/get_versions",data:{chartId:chartId},cache:!1,success:function(e){console.log(e);for(var t=e.list,i=0,n=t.length;i<n;i++){var o=t[i],s=o._id.$oid;a+='<li vid="'+s+'" def="'+o.definitionId+'"><input type="checkbox" name="version" class="version"/><div class="history_remark">'+o.remark+'<span class="mind-icons">&#xe622;</span></div><div class="history_info"><span>'+o.fullName+'</span> <span class="version_time">'+o.createDate+"</span></div></div></li>"}r.html(a),"error"!=e.result&&""!=$.trim(e)?$("#history-none-tip").hide():$("#history-none-tip").show(),$("#history_versions").children("li").off().on("click",function(){var e=$(this),t=e.attr("def");t!=mindUI.currentDefId&&(mindUI.currentDefId=t,e.addClass("active").siblings().removeClass("active"),mindUI.getHistory(t),mindUI.isViewingHistory=!0,$("#btn-history-restore").removeClass("mind-disable").addClass("active"))}),$("#history_versions").find(".version").off().on("click",function(e){0<$("input[type=checkbox]:checked").length?$("#btn-history-clear").removeClass("mind-disable").addClass("active"):$("#btn-history-clear").removeClass("active").addClass("mind-disable"),$("#btn-history-restore").removeClass("active").addClass("mind-disable"),e.stopPropagation()}),$("#history_versions").find(".mind-icons").on("click",function(e){var t,i=$(this).parent().parent(),n=i.attr("def"),o=i.attr("vid");null!=o&&((t=$("<div class='mind-history-delete'><div class='text'>确认删除此版本信息？</div><div class='btns'><span class='btn-delete mind-button'>删除</span><span class='btn-cancel mind-button gray'>取消</span></div></div>")).appendTo(i),t.find(".btn-delete").on("click",function(e){mindUI.removeHistory(o),n==mindUI.currentDefId&&mindUI.closeHistory(),e.stopPropagation()}),t.find(".btn-cancel").on("click",function(e){t.remove(),e.stopPropagation()})),e.stopPropagation()})}}))},getHistory:function(e){console.log(e,"----------------------------------------"),null!=e&&$.ajax({url:"/diagraming/get_versiondef",data:{id:e},success:function(e){null!=e.def&&(mindUI.openHistory(e.def),$("#mind-history-tip").css({top:56,marginLeft:-122}).show().find(".mind-tip-text").html("<@i18n resource='diagraming.history.viewing'/><a href='javascript:' style='margin-left: 10px;color:#fff;text-decoration:underline;' onclick='mindUI.closeHistory()'><@i18n resource='diagraming.history.back'/></a>"))}})},removeHistory:function(i){null!=i&&$.ajax({url:"/diagraming/del_version",data:{vid:i},cache:!1,success:function(){if(i&&0<i.indexOf(",")){var e=i.split(",");if(0<e.length)for(var t=0;t<e.length;t++)$("#history_versions").children("li[vid="+e[t]+"]").remove()}else $("#history_versions").children("li[vid="+i+"]").remove()}})},openingDef:null,openHistory:function(e){var t;null==this.currentDef&&(t=JSON.stringify(mind.model.topic),this.currentDef=t),this.openingDef=e,mind.operation.clearCanvas.call(mind);var i=new mindDesigner("#mind_con",{chartId:chartId,readonly:!0},e);mind.operation.setDisable.call(mind),i.util.clearSelect()},restoreHistory:function(){var e;$("#history_versions").children(".active").length&&(e=this.openingDef,$.ajax({url:"/mindmap/restore",type:"post",data:{def:e,chart_id:chartId,ignore:"def"},success:function(){mindUI.closeHistory(e),this.openingDef=null,$("#history_versions").find("input[type=checkbox]").prop("checked",""),$("#btn-history-clear").addClass("mind-disable").removeClass("active")}}))},saveTitle:function(e){var t;30<e.length&&(e=e.substring(0,30)),e!=chartTitle&&(t={action:"changeTitle",title:chartTitle=e},mindColla.send([t]),mindUI.loadRecentFiles())},setLocalFileTitle:function(e,t){for(var i=window.localStorage,n=i.getItem("localFiles"),o=JSON.parse(n),s=0,r=o.length;s<r;s++){var a=o[s];a.localId==localId&&a.id==e&&(a.title=t)}i.setItem("localFiles",JSON.stringify(o))},setLocalFileId:function(e,t){for(var i=window.localStorage,n=i.getItem("localFiles"),o=JSON.parse(n),s=0,r=o.length;s<r;s++){var a=o[s];if(a.localId==localId&&a.id==e){a.id=t;break}}i.setItem("localFiles",JSON.stringify(o))},addLocalFile:function(e,t){var i=window.localStorage,n=i.getItem("localFiles"),o=JSON.parse(n),s={id:e,title:t,localId:localId};o.push(s),i.setItem("localFiles",JSON.stringify(o))},savePublish:function(e){var t=$("#publish_category").val(),i=$("#publish_language").val(),n=$("#publish_description").val(),o=$("#publish_tags").val().replace(/，/gi,",").split(",");if(0==(o=this.removeFromArray(o,"")).length)return $("#publish_tags").attr("placeholder","请输入标签"),void $("#publish_tags").focus();$("#publish_dlg_save").addClass("mind-disable"),$.ajax({url:"/folder/publish",type:"post",data:{id:chartId,status:"public",language:i,industry:t,description:n,tags:o,_public_edit:$("#public_edit").is(":checked"),_public_clone:$("#public_clone").is(":checked")},traditional:!0,success:function(){$("#publish_dlg_save").removeClass("mind-disable"),e()}})},showDropdown:function(t,e,i,n,o){t.hasClass("selected")?t.removeClass("selected"):($(".header-op-item.selected").removeClass("selected"),t.addClass("selected"),$(".mind-menu").hide(),e.dropdown({target:t,position:n||"right",compel:o||!1,onSelect:function(e){i&&i(e),t.removeClass("selected")},onClose:function(){}}),t.addClass("selected"))},showColorBox:function(i,n,e){var t,o;e?$("#mind-background-img").show():$("#mind-background-img").hide(),i.hasClass("selected")?i.removeClass("selected"):($(".header-op-item.selected").removeClass("selected"),i.addClass("selected"),$(".mind-menu").hide(),o=(t=i.children().first()).css("background-color")||t.css("background"),$.colorpicker({target:i,trans:!0,color:o,onSelect:function(e,t){n(e,t),i.removeClass("selected")},onClose:function(){}}))},showIcons:function(e){var t=mind.util.selectedIds;if(0!=t.length){var i=mind.model.getTopicById(t[0]).icons;if(i){e.find(".selected").removeClass("selected");for(var n=0,o=i.length;n<o;n++){var s=i[n];e.find(".mind-icons[ico="+s.index+"], .mind-icon-url[ico="+s.index+"]").addClass("selected")}}else e.find(".selected").removeClass("selected")}else e.find(".selected").removeClass("selected")},showThemeOperate:function(e){$(".mind-theme-dlg").hide(),$(".mind-theme-customise-dlg").hide();var t=$(".mind-exists-dlg");t.dialog(),$("#btn-style-overwrite").off("click").on("click",function(){mind.style.setThemeOverWrite.call(mind,e,function(){t.dialog("close")})}),$("#btn-style-remain").off("click").on("click",function(){mind.style.setThemeDirect.call(mind,e),t.dialog("close")}),$("#btn-style-cancel").off("click").on("click",function(){t.dialog("close")})},renderCustomiseThemes:function(e){var t=[],i=$("#mind-customise-themes-list");if(0!=e.length){for(var n=0;n<e.length;n++){var o,s,r=e[n],a=JSON.parse(r.theme);null!=a&&(o=r.themeName||"未命名风格",s=a.background,"#ffffff"!=a.background&&"rgb(255,255,255)"!=a.background||(s="#e7e6e5"),t.push("<div cid='"+r.id+"' themeId='"+a.id+"' style='color:"+s+"' class='theme-item'>"),t.push("<span class='mind-icons icons-theme'>&#xe71b;</span>"),t.push("<div class='theme-item-date'><input type='text' class='theme-item-title' value='"+o+"' /><div>"+r.updateTime.substring(0,16)+"</div></div>"),t.push("<div class='theme-item-op'><span title='使用主题风格' class='mind-icons icon-button icons-use'>&#xe6b5;</span><span title='修改主题风格' class='mind-icons icon-button icons-edit'>&#xe636;</span><span title='删除主题风格' class='icon-button mind-icons icons-close'>&#xe669;</span></div>"),t.push("</div>"))}t.push("<div style='clear:both;'></div>"),i.html(t.join("")),i.find(".theme-item-op > .icons-use").on("click",function(){var e=$(this).parent().parent().attr("themeId");mind.style.setTheme.call(mind,e),$.showTip("主题风格应用成功",1e3),setTimeout(function(){$(".mind-theme-customise-dlg").dialog("close")},1e3)}),i.find(".theme-item-title").off().on("blur",function(){var e=$(this).parent().parent().attr("themeId"),t=$(this).val();10<t.length?$.showTip("请输入10字以内的名称",1500):mindUI.saveThemeName(e,t)}),i.find(".theme-item-op > .icons-close").on("click",function(e){var t=$(this),i=t.parent().parent(),n=i.attr("cid");t.confirm({content:"确定要删除当前主题？",width:140,height:40,onConfirm:function(){mindUI.removeCustomiseTheme(n,function(){mindUI.loadCustomiseThemesOn(),i.remove(),mindUI.editCustomiseId=null})}}),e.stopPropagation()}),i.find(".theme-item-op > .icons-edit").on("click",function(e){var t=$(this).parent().parent().attr("themeId"),i=sessionStorage.getItem("customiseThemes"),n=null;if(null!=i){for(var o=JSON.parse(i),s=0;s<o.length;s++){var r=o[s];if(r.id==t){n=r;break}}mindUI.editCustomiseId=n.id,mindUI.customiseTheme=n,mindUI.renderTopic(),$("#mind-tabs-styles").trigger("click")}e.stopPropagation()})}else i.html("<div style='flex:1;height:224px;line-height:200px;text-align:center;font-size:18px;color:#999;'><span style='font-size:28px;' class='mind-icons'>&#xe619;</span> 未找到自定义的主题风格</div>")},saveThemeName:function(e,t){$.ajax({url:"/mindmap/savethemename",data:{id:e,val:t,userid:userId},type:"post",success:function(e){"success"==e.result&&$.showTip("风格名称保存成功",1e3)}})},removeCustomiseTheme:function(e,t){$.ajax({url:"/mindmap/deletetheme",data:{id:e},type:"post",success:function(e){"success"==e.result?($.showTip("删除成功",1e3),t()):$.showTip("删除失败",1e3)},error:function(){$.showTip("删除失败",1e3)}})},showCustomiseStyles:function(e){var t=$(".mind-theme-customise-dlg"),i=t.find("div[tit=mind-tabs-styles]");$("#mind-tabs-styles").addClass("selected").siblings().removeClass("selected"),t.css({height:624,marginTop:-312}),i.show().siblings().hide(),mindUI.customiseTheme=e,mindUI.renderTopic(),t.find("#btn-customise-save").show()},showCustomiseThemes:function(){var e=$(".mind-theme-customise-dlg"),t=e.find("div[tit=mind-tabs-canvas]");$("#mind-tabs-themes").addClass("selected").siblings().removeClass("selected"),e.css({height:348}),t.show().siblings().hide(),e.find("#btn-customise-save").show()},loadCustomiseThemesOn:function(s){""!=chartId&&null!=chartId&&$.ajax({url:"/mindmap/getthemes",type:"post",data:{userid:userId},success:function(e){var t=e.themes;if(null==t)s();else{for(var i=[],n=0;n<t.length;n++){var o=t[n];i.push(JSON.parse(o.theme))}mindUI.renderCustomiseThemes(t),sessionStorage.setItem("customiseThemes",JSON.stringify(i))}},error:function(){}})},saveTheme:function(e,t){var i,n;""!=chartId&&null!=chartId&&(i=e.id,n=JSON.stringify(e),$.ajax({url:"/mindmap/savetheme",type:"post",data:{id:i,theme:n,ignore:"theme",userid:userId},success:function(e){"over"==e.result||("error"==e.result?$.showTip("保存失败",2e3):"success"==e.result&&($.showTip("保存成功",2e3),t()))},error:function(){$.showTip("保存失败",2e3)}}))},initCustomise:function(e){var i=$(".mind-theme-customise-dlg");mindUI.customiseTheme=mind.util.copy(e),mindUI.editCustomiseId=null;var n=$("#previewTopic"),o="centerTopic";function t(){var e=$(".mind-number-box.padding").map(function(){return $(this).children("input").val()}).get().join(" ");mindUI.customiseTheme[o].padding=e,mindUI.renderTopic(o)}function s(e){mindUI.customiseTheme[o]["border-radius"]=e,mindUI.renderTopic(o)}function r(e,t,i){$.colorpicker({target:t,setColor:e,onSelect:function(e){null==e?null!=i&&i("transparent"):(e="rgb("+e+")",t.find(".color_line").css("background-color",e),null!=i&&i(e)),t.removeClass("selected")},onClose:function(){t.removeClass("selected")}})}mindUI.loadCustomiseThemesOn(),$("#mind-customise-topic").off().on("click",function(){var i=$(this);$("#mind-customise-topic-list").dropdown({target:i,width:200,onSelect:function(e){var t=e.text();i.children("span").text(t),n.text(t),o=e.attr("tp"),null==mindUI.customiseTheme[o]&&(mindUI.customiseTheme[o]=$.extend({},mindUI.customiseTheme.secTopic)),"centerTopic"==o?($("#linestylecon").find(".mind-select-box").addClass("mind-disable"),$("#linestylecon").find(".mind-color-box").addClass("mind-disable"),$("#previewLine").hide()):($("#linestylecon").find(".mind-select-box").removeClass("mind-disable"),$("#linestylecon").find(".mind-color-box").removeClass("mind-disable"),$("#previewLine").show()),mindUI.renderTopic(o),i.removeClass("selected")},onClose:function(){i.removeClass("selected")}})}),$("#btn-customise-close").off("click").on("click",function(){}),$("#btn-customise-restore").off().on("click",function(){mindUI.editCustomiseId=null,mindUI.customiseTheme=null,o=null,mindUI.renderTopic(),$.showTip("重置成功",1e3)}),$("#btn-customise-new").off().on("click",function(){$("#mind-tabs-styles").trigger("click"),mindUI.editCustomiseId=null,mindUI.customiseTheme=null,o=null,mindUI.renderTopic()}),$("#btn-customise-save").off().on("click",function(){var e=mindUI.customiseTheme;if(null!=e){var t=sessionStorage.getItem("customiseThemes"),i=JSON.parse(t)||[];if(null!=mindUI.editCustomiseId){for(var n=0,o=0;o<i.length;o++){if(i[o].id==mindUI.editCustomiseId){n=o;break}}return i.splice(n,n,e),sessionStorage.setItem("customiseThemes",JSON.stringify(i)),void mindUI.saveTheme(e,function(){$(".mind-theme-customise-dlg").hide(),$.mask("close"),mind.style.setTheme.call(mind,e.id),mindUI.customiseTheme=null})}var s=mindUI.newId();e.id="customise_"+s,i.push(e),sessionStorage.setItem("customiseThemes",JSON.stringify(i)),mindUI.saveTheme(e,function(){$(".mind-theme-customise-dlg").hide(),$.mask("close"),mind.style.setTheme.call(mind,e.id),mindUI.customiseTheme=null})}}),$(".mind-dlg-tabs").children().off().on("click",function(){var e=$(this),t=e.attr("id");e.addClass("selected").siblings().removeClass("selected"),i.find("div[tit="+t+"]").show().siblings("[tit]").hide()}),$("#mind-customise-size").numberBox({callback:function(e){e+="px",mindUI.customiseTheme[o]["font-size"]=e,mindUI.renderTopic(o)}}),$("#mind-customise-paddingt").numberBox({width:60,inputWidth:36,callback:function(){t()}}),$("#mind-customise-paddingr").numberBox({width:60,inputWidth:36,callback:function(){t()}}),$("#mind-customise-paddingb").numberBox({width:60,inputWidth:36,callback:function(){t()}}),$("#mind-customise-paddingl").numberBox({width:60,inputWidth:36,callback:function(){t()}}),$("#mind-customise-font").off().on("click",function(){var i=$(this);$("#mind-font-list").dropdown({target:i,onSelect:function(e){var t=e.text();i.children("span").text(t),mindUI.customiseTheme.common.family=t,i.removeClass("selected"),mindUI.renderTopic(o)},onClose:function(){i.removeClass("selected")}})}),$("#mind-customise-color").off().on("click",function(){var e=$(this);r(e.find(".color_line").css("background-color"),e,function(e){mindUI.customiseTheme[o].color=e,mindUI.renderTopic(o)})}),$("#mind-customise-b").off().on("click",function(){var e=$(this);e.hasClass("selected")?(mindUI.customiseTheme.common.bold=!1,e.removeClass("selected")):(mindUI.customiseTheme.common.bold=!0,e.addClass("selected")),mindUI.renderTopic(o)}),$("#mind-customise-i").off().on("click",function(){var e=$(this);e.hasClass("selected")?(mindUI.customiseTheme.common.italic=!1,e.removeClass("selected")):(mindUI.customiseTheme.common.italic=!0,e.addClass("selected")),mindUI.renderTopic(o)}),$("#mind-customise-bw").off().on("click",function(){var i=$(this);$("#mind-customise-borderw").dropdown({target:i,onSelect:function(e){var t=e.attr("tp");"none"==t?(mindUI.customiseTheme[o]["border-width"]=0,delete mindUI.customiseTheme[o]["border-color"],delete mindUI.customiseTheme[o].border):mindUI.customiseTheme[o]["border-width"]=t,mindUI.customiseTheme[o]["border-style"]="solid",mindUI.renderTopic(o),i.removeClass("selected")},onClose:function(){i.removeClass("selected")}})}),$("#mind-customise-bc").off().on("click",function(){var e=$(this);r(e.find(".color_line").css("background-color"),e,function(e){mindUI.customiseTheme[o]["border-color"]=e,mindUI.renderTopic(o)})}),$("#mind-customise-canvasbg").off().on("click",function(){var e=$(this);r(e.find(".color_line").css("background-color"),e,function(e){mindUI.customiseTheme.background=e,$(".mind-customise-prev").css("background",e)})}),$("#mind-customise-linec").off().on("click",function(){var e=$(this);r(e.find(".color_line").css("background-color"),e,function(e){null==mindUI.customiseTheme[o].lineStyle&&(mindUI.customiseTheme[o].lineStyle={}),mindUI.customiseTheme[o].lineStyle.lineColor=e,document.getElementById("previewLine").querySelector("path").setAttributeNS("","stroke",e)})}),$("#mind-customise-linet").off().on("click",function(){var n=$(this);$("#mind-customise-linet-list").dropdown({target:n,onSelect:function(e){var t=e.attr("tp"),i=e.text();n.children("span").text(i),null==mindUI.customiseTheme[o].lineStyle&&(mindUI.customiseTheme[o].lineStyle={}),mindUI.customiseTheme[o].lineStyle.lineType=t,n.removeClass("selected")},onClose:function(){n.removeClass("selected")}})}),$("#mind-customise-linew").off().on("click",function(){var i=$(this);$("#mind-customise-linew-list").dropdown({target:i,onSelect:function(e){var t=e.attr("tp");i.children("span").text(t+"px"),null==mindUI.customiseTheme[o].lineStyle&&(mindUI.customiseTheme[o].lineStyle={}),mindUI.customiseTheme[o].lineStyle.lineWidth=t,i.removeClass("selected"),document.getElementById("previewLine").querySelector("path").setAttributeNS("","stroke-width",t)},onClose:function(){i.removeClass("selected")}})}),$("#mind-customise-bs1").off().on("click",function(){s("0px"),$("#mind-customise-bs1").addClass("selected"),$("#mind-customise-bs2").removeClass("selected"),$("#mind-customise-bs3").removeClass("selected")}),$("#mind-customise-bs2").off().on("click",function(){s("5px"),$("#mind-customise-bs2").addClass("selected"),$("#mind-customise-bs1").removeClass("selected"),$("#mind-customise-bs3").removeClass("selected")}),$("#mind-customise-bs3").off().on("click",function(){$("#mind-customise-bs3").addClass("selected"),$("#mind-customise-bs2").removeClass("selected"),$("#mind-customise-bs1").removeClass("selected"),s("30px")}),$("#mind-customise-fill").off().on("click",function(){var e=$(this);r(e.find(".color_line").css("background-color"),e,function(e){mindUI.customiseTheme[o].backgroundColor=e,mindUI.renderTopic(o)})}),$("#mind-customise-sd").off("").on("click",function(){var e=$(this),t="none";e.hasClass("selected")?e.removeClass("selected"):(t="1px 2px 6px #aaa",e.addClass("selected")),function(e){"none"==e?delete mindUI.customiseTheme[o]["box-shadow"]:mindUI.customiseTheme[o]["box-shadow"]=e;mindUI.renderTopic(o)}(t)}),mindUI.renderTopic(),$("input[name=mind_upload_bg_file]").off("change").on("change",function(){var e=this.files[0].type;""!=$.trim($(this).val())&&(0<=e.indexOf("image")?($.showTip("上传中...",6e3),$("#upload_mind_img_bg").submitForm({success:function(e){var t;"size_wrong"!=e.result?"type_wrong"!=e.result?null!=e.img_url?""!=e.img_url&&((t=new Image).src=e.img_url,t.onload=function(){$(".mind-customise-prev").css("background","url("+e.img_url+")"),mindUI.customiseTheme.background="url("+e.img_url+")"}):$.showTip("上传失败",1e3):$.showTip("只能上传图片格式",1e3):$.showTip("图片大小不能超过500k",1e3)},error:function(){$.showTip("上传失败",1e3)}})):$.showTip("只支持图片格式，请重新选择",1500))})},customiseTheme:null,editCustomiseId:null,renderTopic:function(e){null==mindUI.customiseTheme&&(mindUI.customiseTheme=mind.util.copy(mind.style.themes.theme3));var t={},i=mindUI.customiseTheme,n=$("#previewTopic");"centerTopic"==e||null==e?t=i.centerTopic:"secTopic"==e?t=i.secTopic:"childTopic"==e?t=i.childTopic:"freeTopic"==e&&(t=i.freeTopic?i.freeTopic:i.secTopic),(t=$.extend(t,i.common))["font-family"]=t.family,t["font-weight"]=t.bold?"bold":"normal",t["font-style"]=t.italic?"italic":"normal",delete t.family,delete t.bold,delete t.italic,n.removeAttr("style"),n.css(t);var o="secTopic"==e?"分支主题":"childTopic"==e?"子主题":"中心主题";n.text(o),$("#mind-customise-topic").children("span").text(o),$(".mind-theme-customise-dlg").find(".color_line").removeAttr("style"),$(".mind-customise-prev").css("background",i.background),mindUI.initStyles(t)},initStyles:function(e){var t,i,n,o,s,r,a,l,d,c=$("#previewTopic");$("#mind-customise-font").children("span").text(e.family),$("#mind-customise-size").children("input").val(e["font-size"]),null!=e.padding&&(t=e.padding.split(" "),$("#mind-customise-paddingt").children("input").val(t[0]),$("#mind-customise-paddingr").children("input").val(t[1]),$("#mind-customise-paddingb").children("input").val(t[2]),$("#mind-customise-paddingl").children("input").val(t[3])),null!=e.lineStyle&&(i=e.lineStyle.lineColor,n=e.lineStyle.lineWidth,s="curv"==(o=e.lineStyle.lineType)||"curve"==o?"曲线":"straight"==o?"直线":"roundBroken"==o?"圆角折线":"折线",(r=document.getElementById("previewLine").querySelector("path")).setAttributeNS("","stroke",i),r.setAttributeNS("","stroke-width",n),$("#mind-customise-linew").children("span").text(n+"px"),$("#mind-customise-linec").find(".color_line").css("background",i),$("#mind-customise-linet").children("span").text(s)),"bold"==e["font-wdith"]&&$("#mind-customise-b").addClass("selected"),"italic"==e["font-style"]&&$("#mind-customise-i").addClass("selected"),$("#mind-customise-color").find(".color_line").css("background",e.color),$("#mind-customise-bs1,#mind-customise-bs2,#mind-customise-bs3").removeClass("selected"),null!=e["border-radius"]&&(a=e["border-radius"].replace("px",""),Number(a)<1?$("#mind-customise-bs1").addClass("selected"):Number(a)<10?$("#mind-customise-bs2").addClass("selected"):10<Number(a)&&$("#mind-customise-bs3").addClass("selected")),null==e.border&&null==e["border-width"]||0==e["border-width"]?($("#mind-customise-bw").children("span").text("无"),$(".customise-bdstyle").find(".mind-color-box").addClass("mind-disable")):null!=e["border-width"]?($("#mind-customise-bw").children("span").text(e["border-width"]),$(".customise-bdstyle").find(".mind-color-box").removeClass("mind-disable"),$("#mind-customise-bc").find(".color_line").css("background",e["border-color"])):(l=c.css("border-width"),d=c.css("border-color"),null!=l&&($("#mind-customise-bw").children("span").text(l),$("#mind-customise-bc").find(".color_line").css("background",d),$(".customise-bdstyle").find(".mind-color-box").removeClass("mind-disable"))),null!=e["box-shadow"]?$("#mind-customise-sd").addClass("selected"):$("#mind-customise-sd").removeClass("selected"),$("#mind-customise-fill").find(".color_line").css("background",e.backgroundColor)},removeFromArray:function(e,t){var i=e.indexOf(t);return 0<=i&&e.splice(i,1),e},isOperated:!1,isSaving:!1,createNew:function(){window.location.href="/mindmap/new?category=mind_right&status=private"},openFile:function(e){var t;chartId!=e&&($.loading(),chartId=e,mind.operation.clearCanvas.call(mind),mind.model.groupList.clearData(),mind=null,mind=new mindDesigner("#mind_con",{chartId:chartId},null),t=$(".mind-title-menu"),mindUI.closeMenu(t),mindUI.loadHistorys())},saveFeedBack:function(e){var t=$.trim($("#feedback_message").val());if(""==t)return $("#feedback_message").val("").focus(),void $("#callback_dlg_save").removeClass("mind-disable");t=t.substring(0,600),$.ajax({url:"/mindmap/save_ask",type:"post",data:{content:t,url:location.href},success:function(){null!=e&&(e(),$("#feedback_message").val(""))}})},showMenu:function(e,t,i,n,o){if(e.hasClass("selected"))return e.removeClass("selected"),void $(".mind-menu").hide();$(".op-con-detail [tit].selected").removeClass("selected"),e.addClass("selected"),$(".mind-menu").hide();var s=0,r=0;-1<i.indexOf("left")?s=e.offset().left-t.outerWidth()-10:-1<i.indexOf("right")&&(s=e.offset().left+e.outerWidth()+10),-1<i.indexOf("middle")?r=e.offset().top-(t.outerHeight()-e.outerHeight())/2:-1<i.indexOf("top")?r=e.offset().top:-1<i.indexOf("bottom")&&(r=e.offset().top+e.outerHeight()),s+t.width()>$(document).width()&&(s=$(document).width()-t.width()-17),s<10&&(s=10),t.css({left:s,top:r,opacity:1,zIndex:10}).show(),null!=n&&n(),null!=o&&o.css({left:e.offset().left-t.offset().left+e.outerWidth()/2}),$(document).off("click.show-menu").on("click.show-menu",function(){$("header").find(".selected").removeClass("selected"),$(".op-con-detail").find(".selected").removeClass("selected"),$(".mind-theme-dlg").hide()})},closeMenu:function(e){e.hide()},loadThemes:function(n){var e,t,o,s,i;null!=n&&(e=n.style.themes,t=$("#mind-themes"),o=["<ul>"],s=1,$.each(e,function(e,t){if(0==t.show)return!0;var i="<li n="+s+"><div tit='"+e+"'><img src='"+t.thumbUrl+"'/></div></li>";o.push(i),s++}),o.push("</ul>"),t.prepend(o.join("")),$("#mind-themes").find("div[tit]").on("click",function(){var e=$(this).attr("tit"),t=$(this).parent().attr("n"),i=$(this).find("img").attr("src");n.style.setTheme.call(n,e),$("#backdrop-style-con .opt-theme").find("img").attr("src",i),$(".mind-theme-dlg").hide(),$(".change-theme-btn.selected").removeClass("selected"),$(document).off("selectstart"),tdocCollect({opername:"mind",module:"format",action:"edit_theme",ver5:t,ver6:""})}),i=n.styles.thumbUrl||"/assets/images/mind/mr.jpg",$("#backdrop-style-con .opt-theme").find("img").attr("src",i))},htmlEncode:function(e){return 0==e.length?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/ /g,"&nbsp;").replace(/\'/g,"&#39;").replace(/\"/g,"&quot;")},htmlDecode:function(e){return 0==e.length?"":e.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&nbsp;/g," ").replace(/&#39;/g,"'").replace(/&quot;/g,'"')},showProcess:function(){},initStyleEvent:function(){$(".pre-topic").on("mousedown",function(e){e.stopPropagation()}),$(".pre-topic").off("click").on("click",function(){var e=$(this),t={"background-color":e.css("background-color"),color:e.css("color"),"border-width":e.css("border-width"),"border-color":e.css("border-color"),"border-style":e.css("border-style"),"border-radius":e.css("border-radius")};mind.operation.setStyle.call(mind,t)})},showUploading:function(){var e=$("<div class='mind-upload-tip'><span class='left_arrow'><img src='/assets/images/tip_loading.png' class='rotate1' /></span><span>加载中...</span></div>");e.appendTo("body"),e.css({top:60,opacity:1}).show()},hideUploading:function(){$(".mind-upload-tip").remove()},showWeixin:function(){$.ajax({url:"/view/getlink",data:{chartId:chartId},success:function(e){var t,i;""!=e.viewLinkId&&((t=$("<div></div>").appendTo("body")).css({position:"absolute",width:200,height:216,left:"50%",top:"40%",marginLeft:-100,marginTop:-100,textAlign:"center",zIndex:9999999,border:"1px solid #ccc",background:"#fff",boxShadow:"1px 1px 12px #bbb"}),i=new QRCode(t[0],{width:180,height:180}),t.find("img").css({width:"180px",height:"180px",marginTop:10,marginLeft:10}).after("<div>微信扫一扫 分享</div>"),i.makeCode(e.viewLinkId),$(document).off("mousedown.weixin").on("mousedown.weixin",function(){t.remove()}))}})},insertUserImage:function(e){var t="",t="string"==typeof e?e:e.url,i=new Image;i.src=t,e.height&&e.width&&(i.style.height=e.height,i.style.width=e.width),i.onload=function(){mind.operation.setTopicImage.call(mind,null,t,i),mindUI.hideUploading(),$(".mind-image-dlg").dialog("close")},i.onerror=function(){mindUI.hideUploading(),$.showTip("图片错误",2500)}},uploadFile:function(e){var i=document.createElement("form"),n=document.createElement("input"),t=document.createElement("input"),o=document.createElement("input");n.setAttribute("name","upload_input"),n.setAttribute("type","file"),t.setAttribute("name","upload_input_chartid"),t.setAttribute("type","text"),t.setAttribute("value",fileId),o.setAttribute("name","upload_input_topic"),o.setAttribute("type","text"),o.setAttribute("value",e),i.setAttribute("id","upload_form"),i.setAttribute("action","/mindmap/upload_file"),i.setAttribute("method","post"),i.setAttribute("enctype","multipart/form-data"),i.appendChild(n),i.appendChild(t),i.appendChild(o),document.body.appendChild(i),n.addEventListener("change",function(){if(""!=$.trim($(this).val())){try{var t=0,t=n.files[0].size;t/=1024,t/=1024}catch(e){t=100}5<t?$.showTip("上传图片大小不能超过5M",1500):(mindUI.showUploading(),$(i).submitForm({success:function(e){var t;"size_wrong"!=e.result?""!=e.file_url&&(t={value:e.file_url,title:e.file_name,type:"file"},$.showTip("附件上传成功",1500),mind.operation.setLink.call(mind,t,null,"file"),$(i).remove(),mindUI.hideUploading()):$.showTip("上传图片大小不能超过5M",1500)},error:function(){mindUI.hideUploading()}}))}}),$(n).trigger("click")},loadUserImages:function(i){$("input[name=mind_upload_img_file]").unbind().bind("change",function(){var e=this.files[0];if($(this).val(""),!/image\/\w+/.test(e.type))return Util.globalTopTip("图片格式错误","top_error",2e3),!1;if(2097152<e.size)return Util.globalTopTip("图片大小不能超过2M","top_error",2e3),!1;mindUI.showUploading();var t=new FormData;t.append("image",e),t.append("fileID",file_id),t.append("type","mind"),t.append("scene",scene),$.ajax({url:"https://docs.qq.com/cooperation/v1/images",type:"post",crossDomain:!0,xhrFields:{"Access-Control-Allow-Origin":"*",withCredentials:!0},headers:{"Client-Id":client_id,"Access-Token":encrypted_session,"Open-Id":tdoc_user_id},data:t,processData:!1,contentType:!1,success:function(e){e=JSON.parse(e),mindUI.hideUploading(),"size_wrong"!=e.result?"type_wrong"!=e.result?e.ret?Util.globalTopTip("上传失败","top_error",2e3):e.data&&i&&i(e.data):Util.globalTopTip("只能上传图片格式","top_error",2e3):Util.globalTopTip("图片大小不能超过10M","top_error",2e3)},error:function(){mindUI.hideUploading(),Util.globalTopTip("上传失败","top_error",2e3)}})}),$("input[name=mind_upload_img_file]").trigger("click")},onIcons:!1,insertDocerIcons:{params:{name:"",offset:0,limit:45},totalNum:0,initData:{},init:function(){var i=this;$(".mind-icons-dlg.mind-menu").off().on("keydown",function(e){e.stopPropagation()}).on("mousedown",function(e){e.stopPropagation()}),$("#docer-search-pic").off().on("scroll",function(){var e=$(this).outerHeight(),t=$(this).scrollTop();if($(".docer-item-list").outerHeight()-35<e+t){if(i.params.offset+i.params.limit>=i.totalNum)return;i.searchIcons("loadmore")}});var t=$("#docer-search-input");if($(".docer-search-pro").off().on("click",".search-icons",function(e){e.stopPropagation(),""!=$.trim(t.val())||""==i.params.name?i.params.name!=$.trim(t.val())&&(i.params.name=$.trim(t.val()),i.searchIcons("searchfile")):$(".mind-icons.del-docer-icons").trigger("click")}),$("#docer-search-input").off().on({keyup:function(e){e.stopPropagation(),13==e.keyCode&&$(".search-icons").trigger("click")},focus:function(){$(this).parents(".docer-search-pro").addClass("focus")},blur:function(){$(this).parents(".docer-search-pro").removeClass("focus")}}),$(".docer-search-icons.mind-icons").off("click").on("click",function(e){e.stopPropagation(),$(this).hide(),t.select(),$(".docer-search-pro.vanish").removeClass("vanish")}),$(".mind-icons.del-docer-icons").off().on("click",function(e){e.stopPropagation(),$(".docer-search-icons").show(),$(".docer-search-pro").addClass("vanish"),""!=i.params.name&&(t.val(""),i.params.name="",i.params.offset=0,i.renderIcons("",i.initData))}),mindUI.onIcons&&i.initData)return i.renderIcons("",i.initData),void $(".del-docer-icons").trigger("click");this.loadIcons("firstfile")},searchFile:!1,searchIcons:function(i){var n=this;n.searchFile||("loadmore"==i?this.params.offset+=this.params.limit:this.params.offset=0,n.searchFile=!0,$.ajax({url:"/docer/icon/search",data:n.params,success:function(e){n.searchFile=!1;var t=encrypted_session?e.data:e;n.totalNum=t.total_num,n.renderIcons(i,t)},error:function(e){console.log(e),n.searchFile=!1}}))},loadfile:!1,loadIcons:function(i){var n=this;n.loadfile||(n.loadfile=!0,$.ajax({url:"/docer/rec_icons",success:function(e){mindUI.onIcons=!0,n.loadfile=!1;var t=encrypted_session?e.data:e;n.initData=t,n.renderIcons(i,t)},error:function(e){console.log(e),n.loadfile=!1}}))},renderIcons:function(e,t){var i=[],n=t.list,o=$("#docer-search-pic").find(".docer-item-list");if(n.length<1)return i=$('<div style="padding: 42px;text-align: center;font-size: 16px;">没有搜到相关图标</div>'),void o.html(i);for(var s=0;s<n.length;s++){var r=n[s],a=3==r.moban_type?"docervip":"";i.push('<span ico="img-'+r.id+'" mobantype = "'+r.moban_type+'" title="'+r.name+'" n="'+r.name+'" source="docer-img" id="'+r.id+'" iconimg="'+r.thumb_small_url+'" class="mind-icon-url mind-icons '+a+'"><img src="'+r.thumb_small_url+'" /></span>'+((s+1)%9==0?"<div></div>":""))}i=i.join(""),"loadmore"==e?o.append(i):o.html(i),"firstfile"!=e&&e||mindUI.showIcons($(".mind-icons-dlg"))}},insertDocerImage:{params:{page:1,limit:15,keyword:"",tags:""},pageObj:{homePage:$("#docer-con"),searchPage:$("#docer-search-con")},insertPage:1,dataImages:{},imgId:"",mobantype:"",homeLimit:15,currentPage:"homePage",loadList:!1,init:function(){var n=this;$(".insert_scroll").off("scroll").on("scroll",function(){var e=$(this).outerHeight(),t=$(this).scrollTop(),i=$(this).attr("place");if(!n.loadList)if("home"==i){if($("#docer-popular").height()+80+56-150<e+t){if(n.insertPage*n.homeLimit>=n.homeTotal)return;n.loadDocerImagelist("loadmore")}}else if($("#docer-search").height()-150<e+t){if(n.params.page*n.params.limit>=n.searchTotal)return;n.loaderSearchImage("loadmore")}});var o=$("#search-docer-img");$(".search-btn").off("click.search").on("click.search",function(e){e.stopPropagation();var t=$(this).siblings("input").val(),i=$(".docer-search-title").find("span");""!=t||""==n.params.keyword?n.params.keyword!=t&&(n.params.keyword=t,n.params.page=1,this.insertPage=1,"homePage"==n.currentPage&&($("#docer-con").hide().siblings("#docer-search-con").show(),o.val(n.params.keyword)),$(".chart_image").removeClass("active"),$("#searchInsertImage").addClass("mind-disable"),n.currentPage="searchPage",i.text(n.params.keyword),n.loaderSearchImage()):$("#docer-search-con .search-img-del").trigger("click")}),$("#docer-search-con").off("").on("click.del",".search-img-del",function(e){e.stopPropagation();var t=$("#searchImg");n.currentPage="homePage",n.params.keyword="",n.params.tags="",t.val(""),o.val(""),$(".chart_image").removeClass("active"),$("#searchInsertImage").addClass("mind-disable"),$("#docer-con").show().siblings("#docer-search-con").hide()}),$(".searchImg").off("keyup.search").on({"keyup.search":function(e){13==e.keyCode&&$(this).siblings(".search-btn").trigger("click")}}),$(".popular-con").off("click.label").on("click.label","li",function(e){e.stopPropagation();var t=$(this).text();$("#searchImg").val(t),$("#searchImg").siblings(".search-btn").trigger("click")}),$(".docer-image").off().on("click",".chart_image",function(e){e.stopPropagation();var t=$(this).attr("id"),i=$(this).attr("mobantype");n.imgId=t,n.mobantype=i,$(".chart_image").removeClass("active"),$("#searchInsertImage").removeClass("mind-disable"),$(this).addClass("active")}),$("#searchInsertImage").off().on("click",function(){n.downLoadimg(n.imgId)}),$("#docer-con").show().siblings("#docer-search-con").hide(),n.currentPage="homePage",$("#searchImg").val(""),$("#docer-popular").html(""),n.params.page=1,n.params.keyword="",this.loadLabel(),this.loadDocerImagelist()},download:!1,downLoadimg:function(e){var t=this;this.download||(this.download=!0,$.ajax({url:"/docer/download_pic",data:{mb_id:e,encrypted_session:encrypted_session},success:function(e){t.download=!1,imgUrl=e.download_url,imgUrl&&mindUI.insertUserImage(imgUrl)},error:function(e){t.download=!1,console.log(e)}}))},loadLabel:function(){$.ajax({url:"/docer/word_rec",success:function(e){var t=e.data.keyword,i=$("#popular-con"),n=["<ul>"];if(!(0<i.find("li").length)){for(var o=0;o<t.length&&!(7<o);o++)n.push("<li>"+t[o].word+"</li>");i.append(n.join("")+"</ul>")}},error:function(e){console.log(e)}})},docerLoding:!1,loadDocerImagelist:function(n){var o=$("#docer-popular"),s=this;$("#docer-con").find(".template-loading").show(),this.docerLoding||("loadmore"==n&&this.insertPage++,this.docerLoding=!0,$.ajax({url:"/docer/rec_pic",data:{page:s.insertPage,limit:s.homeLimit},success:function(e){s.docerLoding=!1;var t=e.data,i=t.total;if(i<1&&"firstload"==n)return $("#docer-con").find(".template-loading").hide(),void o.html("<div style='text-align:center;'><div style='margin-top:90px;color:#a0a0a0;'><span style='font-size:80px;' class='mind-icons'>&#xe746;</span><br><br>暂无推荐图片</div></div>");1==s.insertPage&&(s.dataImages=t),s.homeTotal=i,s.renderImageList(o,t,n)},error:function(e){s.docerLoding=!1,console.log(e)}}))},searchLoading:!1,loaderSearchImage:function(n){var o=$("#docer-search"),s=this;$("#docer-search-con").find(".template-loading").show(),this.searchLoading||("loadmore"==n&&this.params.page++,this.searchLoading=!0,$.ajax({url:"/docer/pic/search",data:this.params,success:function(e){s.searchLoading=!1;var t=e.data,i=t.total;if(i<1&&"loadmore"!=n)return $("#docer-search-con").find(".template-loading").hide(),void o.height("auto").html("<div style='text-align:center;'><div style='margin-top:125px;color:#a0a0a0;'><span style='font-size:80px;' class='mind-icons'>&#xe746;</span><br><br>未找到图片</div></div>");s.searchTotal=i,s.renderImageList(o,t,n)},error:function(e){s.searchLoading=!1,console.log(e)}}))},renderImageList:function(i,e,t){var i=i,n=this,o=e.list;"loadmore"!=t&&i.html(""),this.loadList=!0;for(var s,r=0;r<o.length;r++){var a=3==o[r].moban_type?'<div class="docer_image"><img src="/assets/images/docer_icon.svg"/></div>':'<div class="docer_image"><img src="/assets/images/vip_free_icon.svg"/></div>',l=$('<div class="chart_image" style="visibility: hidden;" mobantype = "'+o[r].moban_type+'" id="'+o[r].id+'"><img class="insert_image" src="'+o[r].thumb_big_url+'" alt="图片加载失败" />'+a+'<span class="img_mask"></span></div>');i.append(l)}var d=!0;!function e(t){i.find(".chart_image img").each(function(){if(0===this.height)return d=!1});d?(clearTimeout(s),t()):(d=!0,s=setTimeout(function(){e(t)},500))}(function(){$(".template-loading").hide(),n.waterfall(i),n.loadList=!1})},waterfall:function(e){var r=e.find(".chart_image"),a=r.eq(0).outerWidth(),l=Math.floor(e.width()/a),d=(e.width()-a*l)/2-2,c=parseInt(e.css("marginTop")),m=[];r.each(function(e,t){var i,n,o,s=r.eq(e).outerHeight();e<l?(i=e%l,m[e]=s-c,$(t).css({position:"absolute",left:i*a+i*d})):(n=Math.min.apply(null,m),o=$.inArray(n,m),$(t).css({position:"absolute",top:n+d,left:o*a+o*d}),m[o]+=r.eq(e).outerHeight()+d)}),e.find(".chart_image").css("visibility","visible");var t=Math.max.apply(null,m);e.height(t+50),this.isLoading=!0}},appendUserImage:function(e){var t=$("<div class='upload-img' id='"+e.imageId+"' fileId='"+e.fileId+"'></div>").appendTo($(".upload-imgs"));e.fileId;null!=e.fileId&&0<=e.fileId.indexOf("http")&&e.fileId,t.off().on("click",function(){$(".image_item_selected").removeClass("image_item_selected"),$(this).addClass("image_item_selected"),$("#selectimg-btncon").find(".mind-disable").removeClass("mind-disable")}).on("mouseenter",function(){var e=$(this),t=$("<div class='remove_icons'><span class='mind-icons'>&#xe6091;</span></div>").appendTo(e),i=e.attr("id");t.on("click",function(){e.remove(),$.ajax({url:"/user_image/remove",data:{imageId:i},success:function(){0==$(".upload-imgs").children(".image_item_selected").length&&$("#selectimg-btncon").find("#insertUserImage").addClass("mind-disable")}})})}).on("mouseleave",function(){$(this).find(".remove_icons").remove()})},showRightDetail:function(e,t){var i=$(".op-con-detail"),n=this;if(i.children("[tit="+e+"]").is(":visible")&&i.hasClass("show_right_con"))return t&&"remark"==e?void setTimeout(function(){$("#mind-topic-remack").focus()},200):void this.hideRightDetail(i);i.css("width","281px"),"shortcut"==e&&i.css("width","328px"),i.addClass("show_right_con"),i.children("[tit]").css("display","none"),i.children("[tit="+e+"]").css("display","block"),"remark"==e&&setTimeout(function(){$("#mind-topic-remack").focus()},200),$(".mind-canvas-con").css("width","calc(100% - 280px)"),i.find("h2 .close").off("mousedown.conhide").on("mousedown.conhide",function(e){e.stopPropagation(),n.hideRightDetail(i)}),mind.events.push("hideMenus")},hideRightDetail:function(e){e.removeClass("show_right_con"),$(".mind-canvas-con").css("width","100%"),mind.events.push("hideMenus")},showRight:function(e,t,i){var n=$(".mind-right-corner"),o=n.children("[tit=remark]"),s=n.children("[tit=remark]").is(":visible");if(styleShow=n.children("[tit=shortcut]").is(":visible"),n.children(".mind-icons").off("click").on("click",function(e){r(!0),e.stopPropagation()}),1==n.css("opacity")&&(styleShow&&"shortcut"==e||"remark"==e&&s))return i?void setTimeout(function(){$("#mind-topic-remack").focus()},200):void r();if(0==n.css("opacity"))return t.addClass("active"),n.css({right:0,opacity:1}),$(".mind-canvas-con").css("right","+=312px"),"remark"==e&&setTimeout(function(){o.find("textarea").focus()},200),void n.children("[tit="+e+"]").show().siblings("div").hide();if(1==n.css("opacity"))return n.children("[tit="+e+"]").show().siblings("div").hide(),void t.addClass("active").siblings().removeClass("active");function r(e){e?$(".header-item.active").removeClass("active"):t.removeClass("active"),n.css({right:-314,opacity:0}),$(".mind-canvas-con").css("right","-=312px")}},showLeft:function(e,t){var i=$(".mind-left-corner");i.children(".mind-icons").off("click").on("click",function(e){!function(e){e?$(".header-item.active").removeClass("active"):t.removeClass("active");i.css({left:-i.width(),opacity:0})}(!0),e.stopPropagation()}),"outline"==e&&i.children("[tit="+e+"]").show(),t.addClass("active"),i.css({left:0,opacity:1}),"remark"==e&&setTimeout(function(){remark.find("textarea").focus()},200)},renameCallback:function(e){$("#tip_result").hide(),$("#dlg_rename").dialog("close"),$("#file_new_title").removeAttr("submitting"),"ok"==(e=JSON.parse(e)).result?($('<div id="download_tip" class="toast"><span class="mind-icons toast-icon">&#xe6d9;</span><span>&nbsp;&nbsp;重命名成功</span><span onclick="$(this).parent().remove()" class="mind-icons toast-close">&#xe623;</span></div>').appendTo("body"),document.title=e.newname,chartTitle=e.newname,$("#file_new_title").val(e.newname)):$('<div id="download_tip" class="toast"><span style="color:#f60;" class="mind-icons toast-icon">&#xe6b8;</span><span>&nbsp;&nbsp;'+e.description+'</span><span onclick="$(this).parent().remove()" class="mind-icons toast-close">&#xe623;</span></div>').appendTo("body"),setTimeout(function(){$("#download_tip").fadeOut().remove()},3e3)},showVipLimitDlg:function(n){var e="";(-1<tdocVipInfo.indexOf(101)||-1<tdocVipInfo.indexOf("101"))&&(e="type3");var t=vipLimitTitle[n+e],i=vipLimitTxt[n+e],o=$(".tdoc-vip-dlg");limitType=n,e="",-1<tdocVipInfo.indexOf(101)||-1<tdocVipInfo.indexOf("101")?($(".footerStyle").children().hide(),$(".footerStyle").children(".tipStyle").show()):($(".footerStyle").children().show(),$(".footerStyle").children(".tipStyle").hide()),o.find(".confirmStyle").html("立即开通"),o.find("h3").text(t),o.find(".tdoc-vip-content").html("<span>"+i+"</span>"),o.dialog({onClose:function(){var e,t,i;mind.opts.readonly=!1,limitAid[n]&&(e="mind",t="node",-1<n.indexOf("download")&&(e="download",t=-1<n.indexOf("pnghd")?"PNG":-1<n.indexOf("pdf")?"PDF":-1<n.indexOf("jpg")?"JPG":-1<n.indexOf("pos")?"POS":-1<n.indexOf("word")?"WORD":-1<n.indexOf("ppt")?"PPT":""),-1<n.indexOf("pasteimg")&&(e="paste",t="screencut"),i=limitAid[n].replace("_po_","_act_"),tdocCollect({opername:e,module:t,action:i,ver5:1,ver6:""}))}}),$(".footerStyle").off("click.cancel").on("click.cancel",".cancelStyle, .tipStyle",function(e){e.stopPropagation(),o.dialog("close")}),poCollect("fun_viplimit",{limit:limitAid[n],page:"mind_editor",userId:userId,vip:tdocVipInfo.join(","),povip:po_is_vip,device:deviceType})},networkTesting:function(e,t){},networkTestingCallback:function(e){var t,i;e?((t=$("#imgnetest1")).length<1&&(t=$('<img id="imgnetest1" src="" style="width: 0;height: 0;display:none;" onload="mindUI.networkTestingCallbackS()" onerror="mindUI.networkTestingCallback()"/>').appendTo($("body"))),i="https://nettest.processon.com/assets/netest.jpg?_u="+(new Date).getTime(),t.attr("src",i)):offlineMask&&!mindUI.networkTestCallback2||($(".offline-dlg").dialog({onClose:function(){offlineMask=!1}}),offlineMask=!0,mind.util.clearSelect(),mindUI.networkTestCallback2&&mindUI.networkTestCallback2())},networkTestingCallbackS:function(){(offlineMask||mindUI.networkTestCallback1)&&(mindColla.errorOrderHandle(),$(".offline-dlg").dialog("close"),offlineMask=!1,mindUI.networkTestCallback1&&mindUI.networkTestCallback1())},loadOutline:function(){mind.util.copy(mind.model.topic);$("#outline-dlg").parent().off("scroll").on("scroll",function(e){e.stopPropagation();var t=$(this);$(".outline-dragable").css("top",t.scrollTop())}),$(".outline-dragable").off("mousedown").on("mousedown",function(e){e.stopPropagation();var i=$(".mind-left-corner"),n=i.width();i.addClass("noevent");var o=e.pageX;$(document).off("mousemove.outline").on("mousemove.outline",function(e){var t=e.pageX;i.css("width",n+t-o<330?330:n+t-o+"px")}),$(document).off("mouseup.outline").on("mouseup.outline",function(){$(document).off("mousemove.outline"),$(document).off("mouseup.outline"),i.removeClass("noevent"),i=null})})},showTopicsIcons:function(){if(!$(".header-op-item[tit=mind_hide_topics]").attr("isfocus")){for(var e=mind.model.topic.children.concat(mind.model.topic.leftChildren||[]),t=[],i=0;i<e.length;i++)1!=e[i].collapsed&&t.push(i);e.length==t.length?($(".header-op-item[tit=mind_hide_topics]").removeClass("mind-disable1"),$(".header-op-item[tit=mind_show_topics]").addClass("mind-disable1")):(t.length<e.length&&0<t.length?$(".header-op-item[tit=mind_hide_topics]").removeClass("mind-disable1"):$(".header-op-item[tit=mind_hide_topics]").addClass("mind-disable1"),$(".header-op-item[tit=mind_show_topics]").removeClass("mind-disable1"))}},headOpWidth:function(e){var t=$(".header-center .active").attr("tit"),i=$("#header-op-container").find("div[tit="+t+"]"),n=$("#head-slither");if(n.hasClass("close"))n.css("display","none");else{var o=$("#header-op-container").outerWidth()-parseInt(i.css("minWidth"))-70,s=i.offset().left,r=$("header").outerHeight()-n.outerHeight();if("resize"==e&&n.hasClass("left")&&"block"==n.css("display")&&o-s+70<0){var a=$("#temp-slither");return 0==a.length&&(a=$('<div id="temp-slither" class="head-slither right" style="display: block; top: '+r+'"><i class="mind-icons">&#xe6c1b;</i></div>').appendTo($("header"))),void a.off("click").on("click",function(){var e=$("#header-op-container").outerWidth()-i.outerWidth()-70;i.css("transform","translate("+e+"px, 0)"),$("#outline_btn").css("transform","translate("+e+"px, 0)"),$(this).remove()})}$("#temp-slither").remove(),$("#head-slither.left").trigger("click"),n.hasClass("left")&&null==e&&(i.css("transform","translate(0, 0)"),n.removeClass("left").addClass("right")),o<0?n.css({display:"block"}):n.attr("class","head-slither right").css({display:"none"})}},getUrlParams:function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),i=window.location.search.substr(1).match(t);return null!=i?unescape(i[2]):null},waterMark:{data:{wrapW:552,wrapH:301,imgW:0,imgH:0,bg:""},init:function(){var n=this,t=$(".mind-watermark-dlg .watermark-text .mind-text");100!=mind.operation.zoomVal&&(mind.operation.zoomVal=100,$(".mind-zoomtxt").text(100),$(".mind-designer").css({transform:"scale(1)","-webkit-transform":"scale(1)","-moz-transform":"scale(1)"})),mind.util.clearSelect(),$("#svg-view-wrap").html(""),this.inputTip("",!0),$(".mind-watermark-dlg").off("mousedown").on("mousedown",function(e){e.stopPropagation()}),$(".mind-watermark-dlg").off("click").on("click",".mind-dlog-close",function(){$("#svg-view-wrap").html("")}),mind.model.topic.watermark?t.val($("<span/>").html(mind.model.topic.watermark).text()).focus():t.val("").focus(),setTimeout(function(){MindToSvg.init(function(e,t,i){n.data.imgW=e,n.data.imgH=t,n.data.bg=i,n.watermarkImgView()},{isView:!0})},300),t.unbind("input propertychange").bind("input propertychange",function(e){e.stopPropagation();var t=$.trim($(this).val());!n.inputTip(t)&&""!=t||n.setWatermarkView(t)}),$(".watermark-submit-button").off("click").on("click",function(){var e=$.trim(t.val());t.val(e),n.inputTip(e)})},inputTip:function(e,t){return""!=e||t?($(".mind-watermark-dlg .watermark-text .mind-text").removeClass("error"),$(".mind-watermark-dlg .watermark-text .text-tip").removeClass("error").text("可输入30个字符，约15个汉字，超出部分将不显示"),!0):($(".mind-watermark-dlg .watermark-text .mind-text").addClass("error"),$(".mind-watermark-dlg .watermark-text .text-tip").addClass("error").text("请先输入水印文字"),!1)},setWatermarkView:function(e){var t=this.byteCut(e,30);mind.operation.setWatermark.call(mind,t,!1,"#svg-view-wrap>svg");var i=this.data,n=Math.round(i.imgW-1e4)/2,o=Math.round(i.imgH-1e4)/2;$("#svg-view-wrap>svg>rect").attr("x",n).attr("y",o)},watermarkImgView:function(){var e=this.data,t=e.imgW>e.wrapW?e.imgW-e.wrapW:0,i=e.imgH>e.wrapH?e.imgH-e.wrapH:0,d=$(".mind-watermark-dlg .watermark-preview"),n=$("#svg-view-wrap");n.css({backgroundColor:e.bg,width:e.imgW,height:e.imgH}),$("#svg-view-wrap #mind-svg-view-con").css({transform:"translate(-50% , -50%)"}),t||i?(n.addClass("move"),d.scrollLeft(t/2),d.scrollTop(i/2),n.off("mousedown").on("mousedown",function(e){e.stopPropagation();var s=d.scrollLeft(),r=d.scrollTop(),a=e.pageX,l=e.pageY;$(document).off("mousemove.watermarkView").on("mousemove.watermarkView",function(e){e.stopPropagation();var t=e.pageX,i=e.pageY,n=Math.round(s-(t-a)),o=Math.round(r-(i-l));d.scrollLeft(n),d.scrollTop(o)}),$(document).off("mouseup.watermarkView").on("mouseup.watermarkView",function(e){e.stopPropagation(),$(document).off("mousemove.watermarkView"),$(document).off("mouseup.watermarkView")})})):(n.removeClass("move"),d.scrollLeft(0),d.scrollTop(0))},byteCut:function(e,t){if(""==e)return e;for(var i="",n=0,o=/[^\u0000-\u00ff]/,s=0;s<e.length;s++){var r=e[s];if(o.test(r)){if(t<n+2)break;n+=2,i+=r}else{if(t<n+1)break;n++,i+=r}}return $("<span/>").text(i).html()}}},orderPayfunc={init:function(){$.ajax({url:"/order/upgrade",data:{userid:userId,fileType:"mind",serverId:wpsServerId[upgradePosFlag],csource:csource},dataType:"json",success:function(e){paySubmiting=!1,"success"!=e.result||window.parent.postMessage(JSON.stringify({eventName:"pom_pay",orderId:e.billno}),"*")},error:function(e){paySubmiting=!1}})}},backgroundImage={data:{img:{W:20,H:20,X:0,Y:0,opacity:100},content:{W:0,H:0,X:0,Y:0},repeat:"repeat",lock:0,url:"",imgBaes64:"",view:{scrollLeft:0,scrollTop:0,centerX:0,centerY:0,scale:1},iframeLoaded:!1,drawImg:!1,coverData:""},init:function(){var n=this,e=$("#background-set-iframe"),t=$("#background-img-center"),i=$(".mind-background-img-dlg .change-box"),o=i.find("input[type=text]"),s=i.find(".number-group:not(.select-group) .mind-icons"),r=i.find(".select-group"),a=r.find("ul"),l=$(".mind-background-img-dlg .sub-group .submit");$(".mind-background-img-dlg").off("mousedown").on("mousedown",function(e){e.stopPropagation()}),this.cleanData(),this.data.iframeLoaded=!1,e.attr("src","/diagrams/view?file_id="+file_id+"&chartId="+chartId+"&encrypted_session="+encrypted_session+"&group_id="+group_id),t.off("clikc").on("click",function(){n.centerView()}),o.off("change").on("change",function(){n.setVal(this,$(this).val())}),s.off("click").on("click",function(){var e=$(this).parents(".number-group").find("input[type=text]"),t=$(this).index(),i=parseInt(e.val());t?n.setVal(e,i-5):n.setVal(e,i+5)}),r.off("click").on("click",function(){$(this).find("ul").slideToggle(200)}),a.off("click").on("click","li",function(){if(!$(this).hasClass("checked")){switch("cover"!=$(this).attr("data-val")&&"cover"!=n.data.repeat||(n.data.drawImg=!0),n.data.repeat=$(this).attr("data-val"),$(this).parent().siblings(".checked-title").text($(this).text()),$(this).addClass("checked").siblings().removeClass("checked"),n.data.repeat){case"cover":var e={W:0,H:0,X:0,Y:0};n.data.content.W/n.data.content.H>n.data.lock?(e.W=n.data.content.W,e.H=parseInt(n.data.content.W/n.data.lock),e.Y=parseInt((n.data.content.H-e.H)/2)):(e.H=n.data.content.H,e.W=parseInt(n.data.content.H*n.data.lock),e.X=parseInt((n.data.content.W-e.W)/2)),n.data.coverData=e,n.disChange(["W","H","X","Y"],!0);break;default:n.data.coverData="",n.disChange(["W","H","X","Y"],!1)}n.backgroundImageShow()}}),$(".background-img-upload").off("change").on("change",function(){n.cleanData();var e=this.files[0];if($(this).val(""),!/image\/\w+/.test(e.type))return mindTip.globalTopTip("图片格式错误","top_error",2e3,$(".mind-background-img-dlg")),!1;if(2097152<e.size)return mindTip.globalTopTip("图片大小不能超过2M","top_error",2e3,$(".mind-background-img-dlg")),!1;$(".mind-background-img-dlg .left .img-upload").hide();var t=new FileReader;t.readAsDataURL(e),t.onload=function(){n.data.imgBaes64=this.result,n.data.url=this.result,n.imgData(this.result)}}),l.off("click").on("click",function(){$(this).hasClass("mind-disable1")||(n.data.url&&n.data.iframeLoaded?($(this).addClass("mind-disable1"),n.data.drawImg?n.drawToCanvas(!0):n.uploadImg()):mindTip.globalTopTip("请上传图片","top_error",2e3,$(".mind-background-img-dlg")))})},cleanData:function(){var e=this;$(".mind-background-img-dlg .right").addClass("disabled"),$(".mind-background-img-dlg .sub-group .submit").removeClass("mind-disable1"),$(".mind-background-img-dlg .left .img-upload").css({display:"flex"}),$(".mind-background-img-dlg .left .iframe-loading").css({display:"flex"}),$(".mind-background-img-dlg .left .change").hide(),$(".mind-background-img-dlg .number-group input").val(""),$(".mind-background-img-dlg .number-group input[data-name=opacity]").val("100%");var t=$(".mind-background-img-dlg .select-group ul li[data-val=repeat]");t.parent().siblings(".checked-title").text(t.text()),t.addClass("checked").siblings().removeClass("checked"),e.disChange(["W","H","X","Y"],!1),e.data.lock=0,e.data.url="",e.data.imgBaes64="",e.data.repeat=t.attr("data-val"),e.data.img.opacity=100,e.data.drawImg=!1,e.data.coverData=""},imgData:function(e){var t,i=this;this.data.iframeLoaded?((t=new Image).src=e,t.onload=function(){i.nameToSetVal("W",t.width),i.nameToSetVal("H",t.height),i.nameToSetVal("X",0),i.nameToSetVal("Y",0),i.data.lock=t.width/t.height,$(".mind-background-img-dlg .right").removeClass("disabled"),i.backgroundImageShow(),$(".mind-background-img-dlg .left .iframe-loading").hide(),$(".mind-background-img-dlg .left .change").css({display:"block"})}):setTimeout(function(){i.imgData(e)},1e3)},nameToSetVal:function(e,t){var i=".mind-background-img-dlg .number-group input[data-name="+e+"]";this.setVal(i,t,!0)},setVal:function(e,t,i){var n,o,s=$(e).attr("data-name"),r=$(e).attr("min-number")||"",a=$(e).attr("max-number")||"",l=$(e).attr("unit")||"",d=this.data.lock,c=parseInt(t);isNaN(c)?c=this.data.img[s]:(r&&c<r&&(c=parseInt(r),mindTip.globalTopTip("最小值为"+r+l,"top_error",2e3,$(".mind-background-img-dlg"))),a&&a<c&&(c=parseInt(a),mindTip.globalTopTip("最大值为"+a+l,"top_error",2e3,$(".mind-background-img-dlg")))),d&&("W"==s?(n=Math.round(c/d),r&&n<r&&(n=r),a&&a<n&&(n=a),this.data.img.H=n,$(".mind-background-img-dlg .number-group input[data-name=H]").val(n+""+l)):"H"==s&&(o=Math.round(c*d),r&&o<r&&(o=r),a&&a<o&&(o=a),this.data.img.W=o,$(".mind-background-img-dlg .number-group input[data-name=W]").val(o+""+l))),this.data.img[s]=c,$(e).val(c+""+l),"W"!=s&&"H"!=s||(this.data.drawImg=!0),i||("opacity"!=s?this.backgroundImageShow():this.drawToCanvas())},drawToCanvas:function(t){var i=this,n=$("#canvas-opacity")[0],o=new Image;o.src=i.data.imgBaes64,o.onload=function(){n.width=i.data.img.W,n.height=i.data.img.H;var e=n.getContext("2d");e.clearRect(0,0,n.width,n.height),e.globalAlpha=i.data.img.opacity/100,e.drawImage(o,0,0,i.data.img.W,i.data.img.H),i.data.url=n.toDataURL(),i.data.drawImg=!1,t?i.uploadImg():i.backgroundImageShow()}},base64ToBlob:function(e){for(var t=(0<=e.split(",")[0].indexOf("base64")?atob:unescape)(e.split(",")[1]),i=e.split(",")[0].split(":")[1].split(";")[0],n=new Uint8Array(t.length),o=0;o<t.length;o++)n[o]=t.charCodeAt(o);return new Blob([n],{type:i})},showSize:function(e){var t=e.replace("data:image/png;base64,",""),i=t.indexOf("=");0<t.indexOf("=")&&(t=t.substring(0,i));var n=t.length,o="",s=(o=(parseInt(n-n/8*2)/1024).toFixed(2))+"",r=s.indexOf(".");return"00"==s.substr(r+1,2)?s.substring(0,r)+s.substr(r+3,2):o},backgroundImageShow:function(e){var t=$("#background-set-iframe").contents().find(".mind-designer"),i=this.data,n=i.coverData?i.coverData:this.data.img,o="cover"==i.repeat?"no-repeat":i.repeat,s="url("+i.url+") "+(n.X+i.content.X)+"px "+(n.Y+i.content.Y)+"px / "+n.W+"px "+n.H+"px "+o;e?(mind.operation.setBackground.call(mind,s,!0),$(".mind-background-img-dlg").dialog("close"),this.cleanData(),$("#background-set-iframe").attr("src","")):t.css({background:s})},uploadImg:function(){var t=this,e=this.showSize(t.data.url);if(console.log("转化后的图片大小:",e),10<e/1024||0==e)return mindTip.globalTopTip("图片大小不能超过10M","top_error",2e3,$(".mind-background-img-dlg")),void $(".mind-background-img-dlg .sub-group .submit").removeClass("mind-disable1");var i=new FormData,n=t.base64ToBlob(t.data.url);i.append("mind_upload_bg_file",n),$.ajax({url:"/mindmap/upload_img_bg",type:"post",data:i,processData:!1,contentType:!1,success:function(e){$(".mind-background-img-dlg .sub-group .submit").removeClass("mind-disable1"),"size_wrong"!=e.result?"type_wrong"!=e.result?null!=e.img_url?""!=e.img_url&&(t.data.url=e.img_url,t.backgroundImageShow(!0)):mindTip.globalTopTip("上传失败","top_error",2e3,$(".mind-background-img-dlg")):mindTip.globalTopTip("只能上传图片格式","top_error",2e3,$(".mind-background-img-dlg")):mindTip.globalTopTip("图片大小不能超过10M","top_error",2e3,$(".mind-background-img-dlg"))},error:function(){$(".mind-background-img-dlg .sub-group .submit").removeClass("mind-disable1")}})},disChange:function(e,i){e&&e.length&&e.map(function(e){var t=$(".mind-background-img-dlg .number-group input[data-name="+e+"]").parent();i?t.addClass("disabled"):t.removeClass("disabled")})},computeSize:function(){var e,o,s,r,a,l,d,t,i,n,c,m;$(".mind-background-img-dlg").is(":hidden")||(e=this,a=r=s=o=null,i=t=d=l=0,$("#background-set-iframe").contents().find(".topic-container, .connection-svg, .mind-connection-con").each(function(){var e=$(this),t=e.offset(),i=t.left+(0==e.outerWidth()?e[0].getBBox().width:e.outerWidth()),n=t.top+(0==e.outerHeight()?e[0].getBBox().height:e.outerHeight());(null==o||t.left<o)&&(o=t.left,l=e.position().left),(null==s||t.top<s)&&(s=t.top,d=e.position().top),(null==r||r<i)&&(r=i),(null==a||a<n)&&(a=n)}),null==o&&(a=r=s=o=0),l-=30,d-=30,t=r+30-(o-=30),i=a+30-(s-=30),this.data.content.W=t,this.data.content.H=i,this.data.content.X=l,this.data.content.Y=d,this.data.view.scale=420/t<236/i?1<420/t?1:420/t:1<236/i?1:236/i,n=Math.round((420-t)/2-o),c=Math.round((236-i)/2-s),m=$("#background-set-iframe").contents().find(".mind-container"),this.data.view.scrollLeft=m.scrollLeft()-n,this.data.view.scrollTop=m.scrollTop()-c,this.data.view.centerX=Math.round(l+t/2),this.data.view.centerY=Math.round(d+i/2),this.data.view.scrollLeft<=0&&this.data.view.scrollTop<=0?setTimeout(function(){e.computeSize()},500):(this.centerView(),this.data.iframeLoaded=!0))},centerView:function(){var e=this.data.view,t=$("#background-set-iframe").contents().find(".mind-container"),i=$("#background-set-iframe").contents().find(".mind-designer");t.scrollLeft(e.scrollLeft),t.scrollTop(e.scrollTop),i.css({transformOrigin:e.centerX+"px "+e.centerY+"px",transform:"scale("+e.scale+")"})}},smartAiHelpCon={params:{width:"320px",height:"770px",newclass:"",hotCon:"",guide:!0,subUnit:!1,designerType:1,channel:1,tutorial:"45%",extra:!0,resultNum:5},init:function(e){var i=this,t=$("#right-help-con"),n=i.params=$.extend({},this.params,e);if(t.length<1){t=$("<div id='right-help-con' class='right-help-con'></div>").appendTo("body").hide(),n.newclass&&t.addClass(n.newclass);var o=$("<div class='brain-power-search-input'><span class='search-btn mind-icons'>&#xe691;</span><input id='powerIpt' autocomplete='off' class='power-input search-input' type='text' placeholder='搜索你想要的功能' /><div class='search-hot tag-box'><div class='hot-temp'></div></div><div class='power-search-del' style='display:none'><i class='mind-icons'>&#xe634;</i></div></div>");t.append(o);var s=$("<div class='tag-box power-hot-tag colle-box' style='display:none'><h6>热搜</h6><div class='hot-temp'></div></div>");t.append(s);var r=$("<div class='power-search-result' style='display: none'></div>");if(t.append(r),n.subUnit){var a=n.subUnit,l="";if("string"==typeof a)l=a;else{if(!(a instanceof Array))return;$.each(a,function(e,t){l+=t})}t.append(l)}t.css({top:n.top,left:n.left,right:n.right,width:n.width,height:n.height}),this.spread()}var d=$(".brain-power-search-input"),c=d.find(".power-search-del"),m=$("#powerIpt");m.off().on({keydown:function(e){e.stopPropagation()},keyup:function(e){e.stopPropagation()},input:function(e){e.timeStamp},focus:function(e){e.preventDefault();var t=m.val();if(""==t)i.hotLabelHideorShow("hide","show");else{if(i.hotLabelHideorShow("hide","hide"),"block"==$(".power-search-result").css("display"))return;i.powerSearch(t)}n.extra||$("#extra-box").hide(),c.show()},blur:function(e){""==m.val()?(setTimeout(function(){i.hotLabelHideorShow("show","hide")},10),n.extra||$("#extra-box").show(),c.hide()):i.hotLabelHideorShow("hide","hide"),e.stopPropagation()}}),d.off("click.search").on("click.search",".search-btn",function(e){var t=m.val();""!=t?(i.powerSearch(t),i.hotLabelHideorShow("hide","hide"),c.show()):($(".power-search-result").hide(),i.hotLabelHideorShow("hide","show"),c.hide()),e.stopPropagation()}),d.off("click.del").on("click.del",".power-search-del",function(){m.val(""),$(".power-search-result").hide(),i.hotLabelHideorShow("show","hide"),$("#extra-box").css("display","block"),c.hide()}),$(".search-hot").off("click.hot").on("click.hot",".hot-item",function(e){e.stopPropagation();var t=$(this).text();t!=m.val()&&(m.val(t),m.focus())}),$(".power-hot-tag, .power-search-result").off("mousedown").on("mousedown",".hot-item",function(e){e.stopPropagation();var t=$(this).text(),i=m.val();m.focus(),t!=i&&(m.val(t),m.siblings(".search-btn").trigger("click"))}),$("#right-help-con").off("mousedown.helpcon").on("mousedown.helpcon",function(e){e.stopPropagation()}),i.getHotCon(n)},receiveHot:!1,getHotCon:function(o){var e,s=this;s.receiveHot||(e="https://ai.processon.com/searchTag/"+o.channel+"/"+o.designerType,$.ajax({url:e,type:"POST",success:function(e){if("success"==e.result){if("success"==e.result){if(null==e.data)return;o.hotCon=e.data.tag;var t=o.hotCon.split(","),i="",n="";$.each(t,function(e,t){return!(3<e)&&(e<2&&(i+="<span class='hot-item'>"+t+"</span>"),void(n+="<span class='hot-item'>"+t+"</span>"))})}$(".brain-power-search-input").find(".hot-temp").html(i),$(".power-hot-tag").find(".hot-temp").html(n),s.receiveHot=!0}},error:function(){console.log("error")}}))},resultLoading:!1,powerSearch:function(m){var p,e,u=this;u.resultLoading||(u.resultLoading=!0,p=$(".power-search-result"),e=JSON.stringify({keyword:m,designerType:u.params.designerType,channel:u.params.channel}),$.ajax({url:"https://ai.processon.com/search",type:"POST",contentType:"application/json",data:e,success:function(e){if("success"==e.result){var t=e.data,i=t.toolbarList,n=t.docList,o=[];if(!t.elementsCount||t.elementsCount<1){if(0<$(".tag-box.empty-rec").length)return u.resultLoading=!1,void p.show();p.hide(),o.push("<div class='tag-box empty-rec colle-box'><h6 style='margin-top:-3px'>找不到你想要的，试试这样搜</h6><div class='hot-temp'>");var s=u.params.hotCon.split(",");$.each(s,function(e,t){e<4&&o.push("<span class='hot-item'>"+t+"</span>")}),o.push("</div></div>")}else{if(p.hide(),i.length)for(var r=0;r<i.length;r++){var a=c((d=i[r]).func.split(",")[0],m);r<u.params.resultNum&&o.push("<div id='"+d.id+"' class='res-temp' tit='"+d.tit+"'>"+a+"</div>")}if(n.length)for(var l=0;l<n.length;l++){var d,a=c((d=n[l]).title.split(",")[0],m);l<u.params.resultNum&&o.push("<div desc='"+d.desc+"' photoUrl='"+d.photoUrl+"' id='"+d.id+"' class='res-temp'>"+a+"</div>")}}function c(e,t){var i=t.length,n=e.indexOf(t);return-1<n?e.substring(0,n)+'<span style="color:#DE0F18">'+t+"</span>"+e.substring(n+i):e}o=o.splice(0,u.params.resultNum).join(""),p.html(o).show(),u.resultLoading=!1}else{if(0<$(".tag-box.empty-rec").length)return void(u.resultLoading=!1);o="<div class='tag-box empty-rec colle-box'><h6 style='margin-top:-3px'>找不到你想要的，试试这样搜</h6><div class='hot-temp'>",s=u.params.hotCon.split(",");$.each(s,function(e,t){e<4&&(o+="<span class='hot-item'>"+t+"</span>")}),o+="</div></div>",$(".power-search-result").html(o),u.resultLoading=!1}},error:function(){u.resultLoading=!1}}))},drawingTime:null,drawingPin:function(e,t){var i,n,o,s,r,a,l,d,c;e.length&&((s=$("#earch-drawing-pin")).length?clearTimeout(this.drawingTime):(n=(i=$("#right-help-con").find(".search-btn").offset()).top,o=i.left,s=$("<div id='earch-drawing-pin' style='top:"+(n-2)+"px; left:"+o+"px' class='search-drawing-pin'><div class='pin'><span class='mind-icons'>&#xe6c1c;</span></div><div class='pulse'></div></div>").appendTo($("body"))),a=(r=e.offset()).left,l=r.top,d=a,c=l-24,"center"==t&&(d+=e.outerWidth()/2-8),c=0<c?c:0,setTimeout(function(){s.css({top:c,left:d})}),this.drawingTime=setTimeout(function(){s.remove()},5e3),$(".power-search-result").hide())},tutorial:function(e,t,i){$("#power-tutorial-con").remove();var n=$('<div id="power-tutorial-con" style="overflow:hidden" class="tutorial-con"><h3></h3><h2></h2><div class="tutorial-image"></div><div class="tutorial-text"><div class="textarea"></div></div></div>');n.appendTo("body");var o,s=n.find("h2"),r=n.find(".tutorial-image"),a=n.find(".tutorial-text");function l(e){e.dialog()}s.text(e),a.find(".textarea").html(t),null!=i?(r.css({border:"1px solid #e3e3e3",padding:"20px 0px 20px 0px"}),n.css({"z-index":11,width:this.params.tutorial}),o='<img style="width:100%" src="'+i+'"/>',r.html(o),r.find("img").on("load",function(){l(n)})):(r.empty(),r.css({border:"none",padding:0}),l(n)),$(".power-search-result").hide()},close:function(){var e=$("#right-help-con");e.addClass("remove"),$(".brain-power-search-input").find(".search-img-del").trigger("click"),setTimeout(function(){e.css("display","none")},300)},spread:function(){$("#right-help-con").removeClass("remove").css("display","block")},hotLabelHideorShow:function(e,t){var i=$(".tag-box.power-hot-tag"),n=$(".brain-power-search-input").find(".search-hot");"show"==e?n.css({display:"block"}):n.css({display:"none"}),"show"==t?i.css({display:"block"}):i.css({display:"none"})}},limitType="",Device_platform=Util.getUrlParams("platform")||1e3,limitAid_platform={1e3:"wdweb",1001:"ios",1002:"an",1003:"wdmac",1004:"wdpc"},limitAid={addtopic:limitAid_platform[Device_platform]+"_mind_po_nodeslimit",addtopic_svip:limitAid_platform[Device_platform]+"_mind_po_nodesunlimit",download_pnghd:limitAid_platform[Device_platform]+"_mind_po_downloadpnghd",download_jpg:limitAid_platform[Device_platform]+"_mind_po_downloadjpg",download_pdf:limitAid_platform[Device_platform]+"_mind_po_downloadpdf",download_word:limitAid_platform[Device_platform]+"_mind_po_downloadword",download_ppt:limitAid_platform[Device_platform]+"_mind_po_downloadppt",download_pos:limitAid_platform[Device_platform]+"_mind_po_downloadpos",pasteimg:limitAid_platform[Device_platform]+"_mind_po_pastescreenshot",nodecout_warn:limitAid_platform[Device_platform]+"_mind_po_nodesalert",leftdown_nodecout:limitAid_platform[Device_platform]+"_mind_po_nodesshow"},vipLimitTitle={addtopic:"无法添加节点",addtopictype3:"无法添加节点",addtopic_svip:"无法添加节点",addtopic_sviptype3:"无法添加节点",pasteimg:"无法粘贴图片",pasteimgtype3:"无法粘贴图片",download_jpg:"无法导出JPG",download_jpgtype3:"无法导出JPG",download_tdoc_docx:"无法导出在线文档",download_tdoc_docxtype3:"无法导出在线文档",download_tdoc_pptx:"无法导出在线幻灯片",download_tdoc_pptxtype3:"无法导出在线幻灯片",download_pdf:"无法导出PDF",download_pdftype3:"无法导出PDF",download_pnghd:"无法导出高清PNG",download_pnghdtype3:"无法导出高清PNG",download_pos:"无法导出POS",download_postype3:"无法导出POS"},vipLimitTxt={addtopic:"开通文档超级会员尊享节点无限添加特权。",addtopictype3:"已达上限，无法继续添加节点。",addtopic_svip:"开通文档超级会员尊享节点无限添加特权。",addtopic_sviptype3:"已达上限，无法继续添加节点。",pasteimg:"开通文档超级会员可粘贴图片。",pasteimgtype3:"当前账号无法粘贴图片。",download_pnghd:"开通文档超级会员即可导出高清PNG、JPG、PDF、POS、在线文档、在线幻灯片。",download_pnghdtype3:"当前账号不支持导出高清png格式文件。",download_tdoc_docx:"开通文档超级会员即可导出高清PNG、JPG、PDF、POS、在线文档、在线幻灯片。",download_tdoc_docxtype3:"当前账号不支持导word格式文件。",download_tdoc_pptx:"开通文档超级会员即可导出高清PNG、JPG、PDF、POS、在线文档、在线幻灯片。",download_tdoc_pptxype3:"当前账号不支持导ppt格式文件。",download_jpg:"开通文档超级会员即可导出高清PNG、JPG、PDF、POS、在线文档、在线幻灯片。",download_jpgtype3:"当前账号不支持导出jpg格式文件。",download_pdf:"开通文档超级会员即可导出高清PNG、JPG、PDF、POS、在线文档、在线幻灯片。",download_pdftype3:"当前账号不支持导出pdf格式文件。",download_pos:"开通文档超级会员即可导出高清PNG、JPG、PDF、POS、在线文档、在线幻灯片。",download_postype3:"当前账号不支持导出pos格式文件。"},vipOrderPosition={"docer-upsvip":"mind_upgrade",download_vip_contrast:"mind_introduce",top_contrast:"mind_contrast",topright:"mind_edit_topright","thme-upgrade-link":"mind_theme_link",addtopic:"mind_node_150",addtopic_svip:"mind_node_300",download_pos:"mind_download_pos",download_svg:"mind_download_svg",download_pnghd:"mind_download_pnghd",download_word:"mind_download_word",download_ppt:"mind_download_ppt",download_fmind:"mind_download_fmind",pasteimg:"mind_screenshot",themenew:"mind_theme_0",themenew_svip:"mind_theme_3","yunsave-spacefull":"mind_edit_spacefull",docer_image:"docer_image",docer_icons:"docer_icons"},dwVipPostion={addtopic:"node_vip",addtopic_svip:"node_svip",download_pos:"edit_export",download_svg:"edit_export",download_pnghd:"edit_export",download_word:"edit_export",download_ppt:"edit_export",download_fmind:"edit_export",download:"edit_export",pasteimg:"pasteimg",top_contrast:"contrast",download_vip_contrast:"edit_introduce","docer-upsvip":"docer_upgrade",topright:"top_right",themenew:"theme_vip",themenew_svip:"theme_svip","yunsave-spacefull":"mind_edit_spacefull","thme-upgrade-link":"mind_theme_link"},mindTip={globalTopTip:function(e,t,i,n,o){var s,r;void 0!==e&&(null==i&&(i=5e3),null==t&&(t="top_success"),0<(s=$("#global_top_dialog")).length&&s.remove(),(s=$('<div id="global_top_dialog" class="global_top_dialog"><div class="left_arrow"></div>'+e+'<div class="right_arrow"></div></div>').appendTo("body")).addClass(t),o&&(s.find(".left_arrow").remove(),s.find(".right_arrow").remove(),s.addClass("noarrow")),r=s.outerWidth(),n?s.css("top",$(n).offset().top+"px"):0==$("#header").length&&s.css("top","0px"),s.css({left:n.offset().left+n.outerWidth()/2-.5*r+"px"}).show(),setTimeout(function(){s.addClass("show"),setTimeout(function(){s.removeClass("show"),setTimeout(function(){s.fadeOut("slow").remove()},250)},i)},50))},loadingball:function(e){var t,i;e.close?$(".ball-spinner").hide():(0<(i=(t=(t=e.con)||$("body")).children(".ball-spinner")).length?i.show():$('<div class="ball-spinner center-middle"><div class="ball1"></div><div class="ball2"></div><div class="ball3"></div>').appendTo(t),e.css&&"object"==typeof e.css&&$(".ball-spinner>div").css(e.css))}},Outline={dataList:[],nodeList:{},data:{},outlineScrollTop:0,init:function(e,t){$(".outline-search .search-input").focus().val(""),this.data=t,this.opts=$.extend({listType:"dot",indent:"default",target:"outline-con",line:{show:!1}},e),this.designer=document.getElementById(e.target),this.searchDesigner=document.getElementById(e.searchTarget),this.searchDesigner.innerHTML="",this.designer.style.display="block",this.searchDesigner.style.display="none",this.dataList=this.util.resetDataList(),null!=t?this.controller.renderAll():this.controller.add(),this.controller.initEvent()},initNodeEvent:function(n){var t=document,i=n.querySelector(".node-self");i.addEventListener("mouseenter",function(e){Outline.controller.posNodeBg(i,"hover"),e.stopPropagation()}),i.addEventListener("mouseleave",function(e){t.querySelector(".outline-hover-bg").style.display="none",e.stopPropagation()}),i.addEventListener("click",function(e){var t,i;"node-title"!=e.target.className&&!$(e.target).parents("node-title")||(t=n.getAttribute("id").replace("ol_","").replace("search_",""),i=Outline.util.getParentId(t),mind.model.showTopics.call(mind,i,!0),mind.util.selectById.call(mind,t)),e.stopPropagation()}),$("#ol_root").off().on("click",function(){mind.util.selectById.call(mind,"root")}),this.opts.readOnly},controller:{setTitle:function(e){$(Outline.designer).prev().html(e).attr("id","ol_root")},renderAll:function(e){var t=Outline.data,i=Outline.designer;if(e){if(document.querySelector("#ol_"+e.id).innerHTML="",this.add(null,e),e.summaries&&0<e.summaries.length){for(var n=0;n<e.children.length;n++)!0===e.children[n].summary&&delete e.children[n];e.children=e.children.concat(e.summaries)}(o=e.children)&&!e.collapsed&&this.renderChild(o)}else{var o=t.children||[],s=t.leftChildren||[];this.setTitle(t.title),i.innerHTML="";var r=o.concat(s);0!=r.length&&this.renderChild(r,i)}},renderChild:function(e,t){for(var i=0,n=e.length;i<n;i++){var o,s=e[i];s.summaries&&0<s.summaries.length&&(s.children=s.children.concat(s.summaries),delete s.summaries),this.add(null,s,t),0<s.children.length&&(o=s.children,this.renderChild(o))}},add:function(e,t,i){var n=document,o=Outline.opts,s=t?t.id:util.newId(),r=null,a=n.querySelector("#ol_"+s);a?r=a:(r=n.createElement("div"),"wider"==o.indent?r.setAttribute("class","node-element wider"):r.setAttribute("class","node-element"),r.setAttribute("id","ol_"+s),null!=t&&(null==i&&(i=n.getElementById("ol_"+t.parent).querySelector(".node-children")),i.appendChild(r)));var l=n.createElement("div");l.setAttribute("class","node-self"),r.appendChild(l);var d=n.createElement("span");l.appendChild(d);var c=n.createElement("span");d.appendChild(c);var m=n.createElement("div");m.setAttribute("class","node-title"),o.readOnly||m.setAttribute("contenteditable",!0),m.setAttribute("spellcheck","false"),m.setAttribute("autocapitalize","off");var p=t?t.title:"";m.innerHTML=p.replace(/<br>/g,"&nbsp;&nbsp;"),l.appendChild(m);var u=n.createElement("div"),h="node-children";o.line.show&&(h+=" line"),o.line.dashed&&(h+=" dashed"),u.setAttribute("class",h),r.appendChild(u),"num"==o.listType?d.setAttribute("class","node-type num"):d.setAttribute("class","node-type dot"),null!=t?this.addStateIcon(t,r):m.focus(),Outline.initNodeEvent(r)},addStateIcon:function(e,t){var i,n=document,o=t.querySelector(".node-state"),s=t.querySelector(".node-self");e.summaries=e.summaries?e.summaries:[],(0<e.children.length||0<e.summaries.length&&null==o)&&((o=n.createElement("div")).setAttribute("class","node-state"),(i=n.createElement("span")).setAttribute("class","collapse-icon openIcon"),o.appendChild(i),s.appendChild(o))},selectNodeById:function(e){var n=this;!e||e.length<1||e.forEach(function(e){var t=document.querySelector("#ol_"+e),i=null;t&&(i="root"==e?t:t.querySelector(".node-self"),n.selectNode(i))})},updateNodeById:function(e){for(var t=e.topics,i=e.insertChild,n=$(".outline-search .search-input").val(),o=[],s=0;s<t.length;s++){var r=t[s].id;if(0<n.length){Outline.dataList=Outline.util.resetDataList();for(var a=0;a<Outline.dataList.length;a++)-1<Outline.dataList[a].title.indexOf(n)&&"root"!=Outline.dataList[a].id&&o.push(Outline.dataList[a]);this.searchNode(o)}if("root"==r)return Outline.data=mind.util.copy(mind.model.topic),void this.renderAll();if(i||"current"==e.rebuild){var l=document.querySelector("#ol_"+r),d=mind.util.copy(this.getNodeById(r));return(c=l.querySelector(".node-children"))&&(c.innerHTML=""),void this.renderAll(d)}var c,m=this.getParentNodeById(r);if("root"==m.id)return void this.renderAll();(c=(l=document.querySelector("#ol_"+m.id)).querySelector(".node-children"))&&(c.innerHTML=""),this.renderAll(m)}},foldNodeById:function(e){var t=e.type,i=e.id;"show"!=t?this.closeChildren("ol_"+i):this.openChildren("ol_"+i)},nodePosUpdate:function(e){var t,i,n,o,s,r=e.id,a=e.target;"root"==a?this.renderAll():(t=document.querySelector("#ol_"+a),i=this.getNodeById(a),(n=t.querySelector(".node-children"))&&(n.innerHTML=""),this.renderChild(i.children)),r!=a&&("root"==r?this.renderAll():(o=this.getNodeById(r),(s=document.querySelector("#ol_"+r).querySelector(".node-children"))&&(s.innerHTML=""),this.renderChild(o.children)))},openChildren:function(e){var t=this.getNodeById(e.replace("ol_","")),i=document.querySelector("#"+e),n=i.querySelector(".node-children");n&&(n.innerHTML=""),0<t.children.length&&this.renderChild(t.children),t.summaries&&0<t.summaries.length&&this.renderChild(t.summaries),$(n).show();var o=i.querySelector(".collapse-icon");o&&(o.classList.remove("closeIcon"),o.classList.remove("openIcon"),o.classList.add("openIcon"))},closeChildren:function(e){var t=document.getElementById(e),i=t.querySelector(".node-children");$(i).hide();var n=t.querySelector(".collapse-icon");n&&(n.classList.remove("openIcon"),n.classList.remove("closeIcon"),n.classList.add("closeIcon"))},selectNode:function(e){this.posNodeBg(e,"current")},posNodeBg:function(e,t){var i=null;"hover"==t&&(i=document.querySelector(".outline-hover-bg")),"current"==t&&(i=document.querySelector(".outline-curt-bg"));var n=e.getBoundingClientRect(),o=$("#outline-dlg").parent().scrollTop();i.style.top=n.top-100+o+"px",i.style.display="block",i.style.height=e.offsetHeight+"px"},getNodeById:function(e){return mind.model.getTopicById(e)},getParentNodeById:function(e){e=e.replace("ol_","");var t=mind.model.getTopicById(e);return mind.model.getTopicById(t.parent)},initEvent:function(){var o=this;$(document).on("click",".node-state",function(e){var t=$(this),i=t.parent().parent().attr("id"),n=$(t.children()[0]);n.hasClass("openIcon")?(o.closeChildren(i),n.removeClass("openIcon").addClass("closeIcon")):(o.openChildren(i),n.removeClass("closeIcon").addClass("openIcon")),e.stopPropagation()}),$(".outline-search .search-input").off().on({input:function(){var e=mindUI.filterXss($(this).val().trim()),t=[];if(Outline.dataList=Outline.util.resetDataList(),""!=e&&0<e.length){Outline.designer.style.display="none",Outline.searchDesigner.style.display="block",Outline.searchDesigner.innerHTML="";for(var i=0;i<Outline.dataList.length;i++)-1<Outline.dataList[i].title.indexOf(e)&&"root"!=Outline.dataList[i].id&&t.push(Outline.dataList[i]);o.searchNode(t)}else Outline.designer.style.display="block",Outline.searchDesigner.style.display="none"}})},searchNode:function(e){var t=document,i=Outline.opts;if(Outline.searchDesigner.innerHTML="",0<e.length)for(var n=0;n<e.length;n++){var o=null;(o=t.createElement("div")).setAttribute("class","node-element wider"),o.setAttribute("id","search_ol_"+e[n].id),Outline.searchDesigner.appendChild(o);var s=t.createElement("div");s.setAttribute("class","node-self"),o.appendChild(s);var r=t.createElement("span");s.appendChild(r);var a=t.createElement("span");r.appendChild(a);var l=t.createElement("div");l.setAttribute("class","node-title"),i.readOnly||l.setAttribute("contenteditable",!0),l.setAttribute("spellcheck","false"),l.setAttribute("autocapitalize","off");var d=e[n]?e[n].title:"";l.innerHTML=d.replace(/<br>/g,"&nbsp;&nbsp;"),s.appendChild(l),"num"==i.listType?r.setAttribute("class","node-type num"):r.setAttribute("class","node-type dot"),Outline.initNodeEvent(o)}else{var c=t.createElement("p");c.innerHTML="暂无结果",c.style.color="#666666",c.style.paddingLeft="20px",Outline.searchDesigner.appendChild(c)}}},util:{newId:function(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+""+e()+e()+e()},copy:function(e){return $.extend({},e)},resetDataList:function(){var e=[];for(item in mind.model.topicList.data)e.push(mind.model.topicList.data[item]);return e},getParentId:function(e){var n=[],o=mind.model.topicList.data;return function e(t){var i=o[t].parent;"root"!=i&&(1==o[i].collapsed&&n.push(i),e(i))}(e),n.reverse()},getElementIndex:function(e){return $(e).index()},getCurrentDate:function(){var e=new Date,t=[],i=[];return t.push(e.getFullYear()),t.push(e.getMonth()+1),t.push(e.getDate()),i.push(e.getHours()),i.push(e.getMinutes()),i.push(e.getSeconds()),t.join("-")+" "+i.join(":")},moveToEnd:function(e){document.getElementById(e).setSelectionRange(1,1)},removeAttribute:function(e,t){if(e&&t)for(var i=0,n=e.length;i<n;i++){e[i].removeAttribute(t)}},setCursorPosition:function(e,t){var i,n,o,s,r=document.getElementById("ol_"+e);null!=r&&(i=r.querySelector(".node-title"),null==t&&(t=i.innerText.length),null!=(n=i.childNodes[0])&&(o=document.createRange(),s=window.getSelection(),o.setStart(n,t),o.setEnd(n,t),o.collapse(!0),s.removeAllRanges(),s.addRange(o)),i.focus())}}};