Schema.init(!0),Schema.initMarkers(),$(function(){$.get("/tdocs/template/getdef/"+file_id,function(e){if("success"===e.result){if(console.log(e.data.id),defId=e.data.id,definition=JSON.parse(e.data.def),Designer.init(),"undefined"!=typeof isView)return;"trial"==role?Designer.status="demo":"viewer"==role&&(Designer.status="readonly"),"readonly"==Designer.status?0==localRuntime&&Designer.setReadonly(!0):(UI.init(),Dock.init(),Navigator.init()),tutorial||(createdTip=!0,UI.gettingStart()),showToolbar||($("#bar_collapse").children("div").attr("class","ico expand"),$(".titlebar").hide(),$("#bar_return").show(),$(".layout").height($(window).height()-73)),$("#load_mask").remove(),setTimeout(function(){var e=0<(e=$("#designer_layout").width()-$("#designer_grids").width())?Math.round(e/2-10):0;$("#designer_layout").scrollTop(Designer.config.pageMargin-10),$("#designer_layout").scrollLeft(Designer.config.pageMargin-10-e)},1500),Designer.op.showShapesLen(0)}else alert(e.msg)})}),$(document).ready(function(){var e;Designer.initialize.initialized||(e=0<(e=$("#designer_layout").width()-$("#designer_grids").width())?Math.round(e/2-10):0,$("#designer_layout").scrollTop(Designer.config.pageMargin-10),$("#designer_layout").scrollLeft(Designer.config.pageMargin-10-e),Designer.initialize.initialized=!0)});var Designer={defaults:{linkerBeginArrowStyle:null,linkerEndArrowStyle:null},config:{panelItemWidth:50,panelItemHeight:50,pageMargin:1e3,anchorSize:8,rotaterSize:9,anchorColor:"#999999",selectorColor:"#1E6FFF",scale:1},status:"",initialize:{initialized:!1,initLayout:function(){$(window).bind("resize.designer",function(){var e=$(window).height()-$("#designer_header").outerHeight()-$("#designer_footer").outerHeight();$(".layout").height(e)}),$(window).trigger("resize.designer")},initModel:function(){Model.define={page:Utils.copy(Schema.pageDefaults),elements:{}},Model.persistence={page:Utils.copy(Schema.pageDefaults),elements:{}}},initCanvas:function(){var e,t=Model.define.page.width.toScale(),n=Model.define.page.height.toScale();2e4<t&&(t=2e4),2e4<n&&(n=2e4),"landscape"==Model.define.page.orientation&&(e=t,t=n,n=e);var i=Model.define.page.backgroundColor;"transparent"==i&&(i="255,255,255");var o=Utils.getDarkerColor(i),s=Utils.getDarkestColor(i);$("#designer_canvas").css({"background-color":"rgb("+o+")"});var r=$("#designer_grids");if(0<r.length){r.attr({width:t,height:n});var a=r[0].getContext("2d");a.clearRect(0,0,t,n);var l=Model.define.page.padding.toScale(),d=t-2*l,p=n-2*l;a.fillStyle="rgb("+i+")",a.beginPath(),a.rect(l,l,d,p),a.fill();var h=Math.round(Model.define.page.gridSize.toScale());if(h<10&&(h=10),Model.define.page.showGrid){a.translate(l,l),a.lineWidth=1,a.save();for(var c=.5,u=0;c<=p;)a.restore(),a.strokeStyle=u%4==0?"rgb("+s+")":"rgb("+o+")",a.beginPath(),a.moveTo(0,c),a.lineTo(d,c),c+=h,u++,a.stroke();for(c=.5,u=0;c<=d;)a.restore(),a.strokeStyle=u%4==0?"rgb("+s+")":"rgb("+o+")",a.beginPath(),a.moveTo(c,0),a.lineTo(c,p),c+=h,u++,a.stroke()}var g,y,f,x=Model.define.page.watermark;x&&(x=$("<span/>").html(Model.define.page.watermark).text(),$("#watermarkCanvas").length||$("body").append('<canvas id = "watermarkCanvas" width = "300px"  height = "300px" style="display:none;"></canvas>'),(y=(g=$("#watermarkCanvas")[0]).getContext("2d")).clearRect(0,0,300,300),y.font="18px Arial",y.rotate(-45*Math.PI/180),y.fillStyle="rgba("+s+",0.8)",y.fillText(x,-190,210),y.rotate(45*Math.PI/180),f=a.createPattern(g,"repeat"),Model.define.page.showGrid||a.translate(l,l),a.rect(0,0,d,p),a.fillStyle=f,a.fill())}$("#canvas_container").css({width:t,height:n,padding:Designer.config.pageMargin}),this.initialized||($("#designer_layout").scrollTop(Designer.config.pageMargin-10),$("#designer_layout").scrollLeft(Designer.config.pageMargin-10))},initShapes:function(){$("#shape_panel").empty(),$("#shape_panel").append("<div class='panel_container panel_collapsed'><h3 class='panel_title search'><input id='shape_search' type='text' placeholder='搜索'/></h3><div id='panel_search' class='content'></div></div>");for(var e=0;e<Schema.categories.length;e++){var t=Schema.categories[e];"standard"!=t.name&&$("#shape_panel").append("<div class='panel_container'><h3 class='panel_title'><div class='mind-icons ico_accordion'>&#xe613;</div>"+t.text+"</h3><div id='panel_"+t.name+"' class='content'></div></div>")}for(var n in $("#shape_panel").append('<div class="panel_container panel_more"><span class="designer_button normal" onclick="UI.showShapesManage()">更多图形</span></div>'),$(".panel_container").css("width",$("#shape_panel").outerWidth()),$(".panel_title").unbind().bind("click",function(){$(this).hasClass("search")||($(this).siblings(".content").stop().slideToggle(100),$(this).parent().toggleClass("panel_collapsed"))}),Schema.shapes){var i=Schema.shapes[n];i.attribute.visible&&"standard"!=i.category&&(i.groupName?SchemaGroup.getGroup(i.groupName)[0]==n&&r(i,i.groupName):r(i))}function r(r,e){r=Utils.copy(r);var t=Designer.config.panelItemWidth,n=Designer.config.panelItemHeight;("ui"==r.category||"ui_input"==r.category||0<=r.category.indexOf("ios_")||0<=r.category.indexOf("andriod_"))&&(n=t=30);var i="<div class='panel_box' shapeName='"+r.name+"'><canvas class='panel_item' width='"+t+"' height='"+n+"'></canvas></div>",a=$(i).appendTo("#panel_"+r.category);e&&3!=e&&1!=e&&a.append("<div class='group_icon' onmousedown='Designer.op.showPanelGroup(\""+e+"\", event, this)'></div>"),3==e&&a.addClass("search_icon_vip");var o=a.children()[0];a.bind("mouseenter",function(){var e,t,n,i,o,s;$(this).hasClass("readonly")||((e=$("#shape_thumb")).children("div").html(r.title),t=e.children("canvas")[0].getContext("2d"),e.attr("current",r.name),n={x:0,y:0,w:r.props.w,h:r.props.h,angle:r.props.angle},i=160,t.clearRect(0,0,i,160),r.props.w>=r.props.h?r.props.w>i&&(n.w=i,n.h=parseInt(r.props.h/r.props.w*n.w)):160<r.props.h&&(n.h=160,n.w=parseInt(r.props.w/r.props.h*n.h)),e.children("canvas").attr({width:180,height:n.h+20}),e.show(),r.props=n,t.save(),t.lineJoin="round",t.globalAlpha=r.shapeStyle.alpha,o=(180-n.w)/2,t.translate(o,10),t.translate(n.w/2,n.h/2),t.rotate(n.angle),t.translate(-n.w/2,-n.h/2),Designer.painter.renderShapePath(t,r,!1,function(){0<$("#shape_thumb[current="+r.name+"]:visible").length&&a.trigger("mouseenter")}),Designer.painter.renderMarkers(t,r,!1),t.restore(),t.translate(o,10),(s=a.offset().top-$("#designer_header").outerHeight()+a.height()/2-e.outerHeight()/2)<5?s=5:s+e.outerHeight()>$("#designer_viewport").height()-5&&(s=$("#designer_viewport").height()-5-e.outerHeight()),e.css("top",s))}).bind("mouseleave",function(){$("#shape_thumb").hide()}),Designer.painter.drawPanelItem(o,r.name)}$(".panel_box").die().live("mousedown",function(e){var l,c,u,g,d,t,n,y,f=$(this);f.hasClass("readonly")||(l=f.attr("shapeName"),c=[],Designer.op.changeState("creating_from_panel"),g=u=null,d=$("#designer_canvas"),t=function(e){var t=$("#creating_shape_canvas"),n=$("#creating_shape_container");0==t.length&&(n=$("<div id='creating_shape_container'></div>").appendTo("#designer"),t=$("<canvas id='creating_shape_canvas' width='"+Designer.config.panelItemWidth+"' height='"+Designer.config.panelItemHeight+"'></canvas>").appendTo(n));return n.css({left:"0px",top:"0px",width:$(".panel_container").width(),height:$("#shape_panel").outerHeight()}),Designer.painter.drawPanelItem(t[0],e),t}(l),n={type:$(this).parent().attr("id"),index:$(this).index(),first:!0},$("#designer").bind("mousemove.creating",function(e){!function(e,t){$("#creating_shape_container").show();var n=Utils.getRelativePos(t.pageX,t.pageY,$("#creating_shape_container"));e.css({left:n.x-Designer.config.panelItemWidth/2,top:n.y-Designer.config.panelItemHeight/2})}(t,e),n.first&&(Designer.events.push("tdocCollect",n),n.first=!1)}),$("#canvas_container").bind("mousemove.create",function(e){var t=Utils.getRelativePos(e.pageX,e.pageY,d);null==u&&(u=function(e,t,n){Utils.newId();var i=Schema.shapes[e],o=t.restoreScale()-i.props.w/2,s=n.restoreScale()-i.props.h/2,r=Model.create(e,o,s);return Designer.painter.renderShape(r),r}(l,t.x,t.y),(g=$("#"+u.id)).attr("class","shape_box_creating")),g.css({left:t.x-g.width()/2+"px",top:t.y-g.height()/2+"px","z-index":Model.orderList.length}),u.props.x=t.x.restoreScale()-u.props.w/2,u.props.y=t.y.restoreScale()-u.props.h/2;var n=u.props,i=Designer.op.snapLine(n,[u.id],!0,u);i.attach?u.attachTo=i.attach.id:delete u.attachTo,i.container?u.container=i.container.id:delete u.container,g.css({left:(u.props.x-10).toScale()+"px",top:(u.props.y-10).toScale()+"px","z-index":Model.orderList.length}),c=Utils.getShapeAnchorInLinker(u),Designer.op.hideLinkPoint();for(var o=0;o<c.length;o++)for(var s=c[o],r=0;r<s.anchors.length;r++){var a=s.anchors[r];Designer.op.showLinkPoint(Utils.toScale(a))}}),y=!1,$("#canvas_container").bind("mouseup.create",function(e){y=!0}),$(document).bind("mouseup.create",function(){if($(this).unbind("mouseup.create"),$("#designer").unbind("mousemove.creating"),$("#creating_shape_container").hide(),Designer.op.hideLinkPoint(),Designer.op.hideSnapLine(),$("#canvas_container").unbind("mouseup.create").unbind("mousemove.create"),null!=u){if("over"==Utils.vip.checkPrivilege("shapeCount"))return void g.remove();if(0==y)g.remove();else{if(MessageSource.beginBatch(),u.onCreated)if(0==u.onCreated())return g.remove(),void MessageSource.commit();g.attr("class","shape_box"),Designer.events.push("created",u),Model.add(u);Utils.getShapeContext(u.id),g.position();for(var e=0;e<c.length;e++){var t,n,i,o,s,r,a,l=c[e],d=l.linker;"line"==l.type?(Utils.copy(d),(t=Utils.copy(d)).id=Utils.newId(),1==l.anchors.length?(r=l.anchors[0],a=Utils.getPointAngle(u.id,r.x,r.y,7),d.to={id:u.id,x:r.x,y:r.y,angle:a},t.from={id:u.id,x:r.x,y:r.y,angle:a}):2==l.anchors.length&&(n=l.anchors[0],i=l.anchors[1],s=Utils.measureDistance(d.from,n)<Utils.measureDistance(d.from,i)?(o=n,i):(o=i,n),a=Utils.getPointAngle(u.id,o.x,o.y,7),d.to={id:u.id,x:o.x,y:o.y,angle:a},a=Utils.getPointAngle(u.id,s.x,s.y,7),t.from={id:u.id,x:s.x,y:s.y,angle:a}),l.anchors.length<=2&&(Designer.painter.renderLinker(d,!0),Model.update(d),Designer.painter.renderLinker(t,!0),t.props.zindex=Model.maxZIndex+1,Model.add(t),Designer.events.push("linkerCreated",t))):(r=l.anchors[0],a=Utils.getPointAngle(u.id,r.x,r.y,7),"from"==l.type?d.from={id:u.id,x:r.x,y:r.y,angle:a}:d.to={id:u.id,x:r.x,y:r.y,angle:a},Designer.painter.renderLinker(d,!0),Model.update(d))}Utils.unselect(),Utils.selectShape(u.id),MessageSource.commit(),Designer.op.editShapeText(u);var p=u.props.w,h=u.props.h;Designer.op.changeCanvas([u],p,h)}}f.css({left:"0px",top:"0px"}),Designer.op.resetState()}))}),$(".layout_bar").off("mousedown.resize").on("mousedown.resize",function(e){var i=$("#shape_panel"),o=i.width(),s=e.pageX,r=$("#designer_viewport"),a=($("#panel_basic").width(),$(".panel_container"));$(document).on("mousemove.panelresize",function(e){var t=e.pageX-s;if(2<Math.abs(t)){var n=o+t;if(n<84||616<n)return;i.width(n),a.width(n),r.css("margin-left",n+1+"px")}}),$(document).on("mouseup.panelresize",function(e){$(document).off("mousemove.panelresize"),$(document).off("mouseup.panelresize")})}),$("#shape_search").unbind("keyup").bind("keyup",function(e){$(this).val().length?$(".panel_title.search .close").length||($(".panel_title.search").append('<span class="mind-icons close">&#xe6fc;</span>'),$(".panel_title.search .close").unbind("click").bind("click",function(){$(this).remove(),$("#shape_search").val(""),$("#panel_search").empty(),$("#panel_search").parent().addClass("panel_collapsed"),$("#panel_search").prev(".panel_title_search").remove()})):$(".panel_title.search .close").remove()}),$("#shape_search").unbind("keydown").bind("keydown",function(e){if(13==e.keyCode){$("#panel_search").empty();var t=$(this).val().toLowerCase();if(""!=t.trim()){for(var n in $("#panel_search").parent().removeClass("panel_collapsed"),Schema.shapes)0<=n.indexOf("image_search_")&&delete Schema.shapes[n];for(var n in SchemaGroup.groups)0<=n.indexOf("image_search_")&&delete SchemaGroup.groups[n];var i=!1;for(var n in Schema.shapes){var o,s=Schema.shapes[n];s.title&&0<=s.title.toLowerCase().indexOf(t)&&s.attribute.visible&&"standard"!=s.category&&(i=!0,(o=Utils.copy(s)).category="search",r(o))}i?$("#panel_search").prepend("<div class='search_panel_title'>系统图形</div>"):$("#panel_search").html("<div class='search_panel_title' style='font-weight: normal;'>未搜索到图标</div>")}else $("#panel_search").parent().addClass("panel_collapsed"),$("#panel_search").prev(".panel_title_search").remove()}})}},hotkey:{init:function(){var u=null;$(window).unbind("keydown.hotkey").bind("keydown.hotkey",function(e){if((e.ctrlKey||e.metaKey)&&83==e.keyCode)e.preventDefault();else if((e.ctrlKey||e.metaKey)&&65==e.keyCode)Designer.selectAll(),e.preventDefault();else if(46==e.keyCode||8==e.keyCode)Designer.op.removeShape(),$(".shape_dashboard.menu").hide(),e.preventDefault();else if((e.ctrlKey||e.metaKey)&&90==e.keyCode)MessageSource.undo(),e.preventDefault();else if((e.ctrlKey||e.metaKey)&&89==e.keyCode)MessageSource.redo(),e.preventDefault();else if(!e.ctrlKey&&!e.metaKey||e.shiftKey||67!=e.keyCode){if((e.ctrlKey||e.metaKey)&&88==e.keyCode){Designer.clipboard.cut();c=document.createElement("input");document.body.appendChild(c),c.value=" ",c.setAttribute("class","temp_input"),c.select(),document.execCommand("copy"),setTimeout(function(){$(".temp_input").remove()},500),e.preventDefault()}else if(!e.ctrlKey&&!e.metaKey||86!=e.keyCode)if((e.ctrlKey||e.metaKey)&&68==e.keyCode)Designer.clipboard.duplicate(),e.preventDefault();else if((e.ctrlKey||e.metaKey)&&e.shiftKey&&66==e.keyCode)Designer.clipboard.brush(),e.preventDefault();else if(e.altKey&&76==e.keyCode)Designer.alignShapes("left"),e.preventDefault();else if(e.altKey&&82==e.keyCode)Designer.alignShapes("right"),e.preventDefault();else if(e.altKey&&67==e.keyCode)Designer.alignShapes("center"),e.preventDefault();else if(!(e.altKey||e.metaKey||e.ctrlKey)||187!=e.keyCode&&107!=e.keyCode)if(!(e.altKey||e.metaKey||e.ctrlKey)||189!=e.keyCode&&109!=e.keyCode){if(37<=e.keyCode&&e.keyCode<=40){var t,n,i,o,s,r,a;(null==u||0<Utils.getSelected().length)&&(n=Utils.getSelected(),t=Utils.getFamilyShapes(n),n=n.concat(t),i=Utils.getContainedShapes(n),n=n.concat(i),o=Utils.getAttachedShapes(n),n=n.concat(o),s=Utils.getCollapsedShapes(n),n=n.concat(s),r=Utils.getOutlinkers(n),u=n.concat(r)),0<u.length&&(e.preventDefault(),a=10,(e.ctrlKey||e.metaKey||e.shiftKey)&&(a=1),Utils.hideLinkerCursor(),UI.hideShapeOptions(),37==e.keyCode?Designer.op.moveShape(u,{x:-a,y:0}):38==e.keyCode?(Designer.op.moveShape(u,{x:0,y:-a}),e.preventDefault()):39==e.keyCode?Designer.op.moveShape(u,{x:a,y:0}):40==e.keyCode&&(Designer.op.moveShape(u,{x:0,y:a}),e.preventDefault()),$(document).unbind("keyup.moveshape").bind("keyup.moveshape",function(){Model.updateMulti(u),Designer.events.push("changeLinkers",u),u=null,$(document).unbind("keyup.moveshape"),Designer.op.hideTip(),Utils.showLinkerCursor(),UI.showShapeOptions()}))}else if((e.ctrlKey||e.metaKey)&&221==e.keyCode){var l="front";e.shiftKey&&(l="forward"),Designer.layerShapes(l)}else if((e.ctrlKey||e.metaKey)&&219==e.keyCode){l="back";e.shiftKey&&(l="backward"),Designer.layerShapes(l)}else if((e.ctrlKey||e.metaKey)&&71==e.keyCode)e.preventDefault(),e.shiftKey?Designer.ungroup():Designer.group();else if((e.ctrlKey||e.metaKey)&&76==e.keyCode)e.preventDefault(),e.shiftKey?Designer.unlockShapes():Designer.lockShapes();else if((18!=e.keyCode||!e.ctrlKey)&&18!=e.keyCode)if(27==e.keyCode)Designer.op.state?"creating_free_text"!=Designer.op.state&&"creating_free_linker"!=Designer.op.state||Designer.op.resetState():(Utils.unselect(),$(".options_menu").hide(),$(".color_picker").hide());else if(84!=e.keyCode||e.ctrlKey||e.metaKey)if(73!=e.keyCode||e.ctrlKey||e.metaKey)if(76!=e.keyCode||e.ctrlKey||e.metaKey)if(66==e.keyCode&&(e.ctrlKey||e.metaKey)){0<(p=Utils.getSelectedIds()).length&&(h=Model.getShapeById(p[0]),d=Utils.getShapeFontStyle(h.fontStyle),Designer.setFontStyle({bold:!d.bold}),UI.update()),e.preventDefault()}else if(73==e.keyCode&&(e.ctrlKey||e.metaKey)){0<(p=Utils.getSelectedIds()).length&&(h=Model.getShapeById(p[0]),d=Utils.getShapeFontStyle(h.fontStyle),Designer.setFontStyle({italic:!h.fontStyle.italic}),UI.update()),e.preventDefault()}else if(85==e.keyCode&&(e.ctrlKey||e.metaKey)){var d;0<(p=Utils.getSelectedIds()).length&&(h=Model.getShapeById(p[0]),d=Utils.getShapeFontStyle(h.fontStyle),Designer.setFontStyle({underline:!d.underline}),UI.update()),e.preventDefault()}else if(32!=e.keyCode||e.ctrlKey||e.metaKey){if(121==e.keyCode)e.preventDefault(),Dock.enterPresentation();else if(91==e.keyCode)return Designer.op.isMetaKey=!0,e.preventDefault(),!1}else{var p,h;1==(p=Utils.getSelectedIds()).length?(h=Model.getShapeById(p[0]),Designer.op.editShapeText(h)):Designer.op.changeState("drag_canvas"),e.preventDefault()}else $(".options_menu").hide(),$(".color_picker").hide(),Designer.op.changeState("creating_free_linker");else $(".options_menu").hide(),$(".color_picker").hide(),UI.showImageSelect(function(e,t,n){UI.insertImage(e,t,n)}),$("#designer_contextmenu").hide();else $(".options_menu").hide(),$(".color_picker").hide(),Designer.op.changeState("creating_free_text")}else Designer.zoomOut(),e.preventDefault();else Designer.zoomIn(),e.preventDefault()}else{Designer.clipboard.copy();var c=document.createElement("input");document.body.appendChild(c),c.value=" ",c.setAttribute("class","temp_input"),c.select(),document.execCommand("copy"),setTimeout(function(){$(".temp_input").remove()},500),e.preventDefault()}}),$("input,textarea,select,div[contenteditable]").die().live("keydown.hotkey",function(e){e.stopPropagation()}),$(window).unbind("keyup.hotkey").bind("keyup.hotkey",function(e){if(91==e.keyCode)return e.preventDefault(),Designer.op.isMetaKey=!1}),$(document).off("paste").on("paste",function(e){if(!$(e.target).hasClass("input_text")&&"textarea"!=e.target.tagName.toLowerCase()&&"shape_search"!=e.target.id&&!$(e.target).parent().hasClass("color_hex"))if(Utils.isChrome()){var t,n,i;if(r=e.clipboardData||e.originalEvent.clipboardData){t=r.items,i=r.types||[];for(var o=0;o<i.length;o++)if("Files"===i[o]){n=t[o];break}if(n&&"file"===n.kind&&n.type.match(/^image\//i)&&4!=t.length){if(!Utils.isChrome())return void Util.globalTopTip("暂时还不支持Safari和Firfox浏览器粘贴截图","top_error",4e3,$("#designer"),!0);if("over"==Utils.vip.checkPrivilege("screenshot"))return;var s=n.getAsFile();new FileReader;if(null==s)return;return UI.hideUploading(),UI.showUploading(),Designer.op.uploadImage(s,function(e){if("notmember"==e.result)return UI.hideUploading(),void Designer.events.push("vip-limit","screenshot");if(0!=e.ret)return UI.hideUploading(),void Util.globalTopTip("粘贴截图出错了，请稍后再试","top_error",2e3);var t=new Image;t.src=e.data.url,t.onload=function(){UI.insertImage(e.data.url,t.width,t.height),UI.hideUploading()}}),e.stopPropagation(),!1}Designer.clipboard.paste()}}else{var r;if(r=e.clipboardData||e.originalEvent.clipboardData){t=r.items,i=r.types||[];for(o=0;o<i.length;o++)if("Files"===i[o]){n=t[o];break}if(n&&"file"===n.kind&&n.type.match(/^image\//i)&&4!=t.length&&!Utils.isChrome())return void Util.globalTopTip("暂时还不支持Safari和Firfox浏览器粘贴截图","top_error",4e3,$("#designer"),!0)}Designer.clipboard.paste()}}),$("#designer").on("mousewheel DOMMouseScroll",function(e){var t=e.originalEvent.wheelDelta||-e.originalEvent.detail,n=Math.max(-1,Math.min(1,t));(e.ctrlKey||e.metaKey)&&(e.preventDefault(),n<0?Designer.zoomOut():Designer.zoomIn())})},cancel:function(){$(window).unbind("keydown.hotkey")}},contextMenu:{init:function(){$("#designer_contextmenu").unbind("mousedown").bind("mousedown",function(e){e.stopPropagation()}),$("#designer_contextmenu").find("li:not(.devider)").unbind("click").bind("click",function(){var e=$(this);e.menuitem("isDisabled")||0!=e.children(".extend_menu").length||(Designer.contextMenu.execAction(e),Designer.contextMenu.hide())}),$("#canvas_container").unbind("contextmenu").bind("contextmenu",function(e){var t,n;e.preventDefault(),e.ctrlKey||e.metaKey||(t=$("#designer_canvas"),n=Utils.getRelativePos(e.pageX,e.pageY,t),Designer.contextMenu.show(n.x,n.y))})},destroy:function(){$("#canvas_container").unbind("contextmenu"),this.hide()},menuPos:{x:0,y:0,shape:null},show:function(e,t){this.menuPos.x=e,this.menuPos.y=t;var n=$("#designer_contextmenu"),i=Utils.getShapeByPosition(e,t,!1);n.children().hide(),n.children("li[ac=selectall]").show(),n.children(".devi_selectall").show(),n.children("li[ac=drawline]").show();var o,s,r=Designer.clipboard.elements.length;0==r&&localStorage.clipboard&&(r=JSON.parse(localStorage.clipboard).length),null==i?0<r&&(n.children("li[ac=paste]").show(),n.children(".devi_clip").show()):(o=i.shape,(this.menuPos.shape=o).locked?(0<r&&(n.children("li[ac=paste]").show(),n.children(".devi_clip").show()),n.children("li[ac=unlock]").show(),n.children(".devi_shape").show()):(n.children("li[ac=cut]").show(),n.children("li[ac=copy]").show(),n.children("li[ac=duplicate]").show(),n.children("li[ac=replace]").show(),0<r&&n.children("li[ac=paste]").show(),n.children(".devi_clip").show(),n.children("li[ac=front]").show(),n.children("li[ac=back]").show(),n.children("li[ac=lock]").show(),2<=(s=Utils.getSelectedIds().length)&&(n.children("li[ac=group]").show(),$("#ctxmenu_align").show()),3<=s&&$("#ctxmenu_dist").show(),1==s?n.children("li[ac=defaultStyle]").show():n.children("li[ac=defaultStyle]").hide(),1<=Utils.getSelectedGroups().length&&n.children("li[ac=ungroup]").show(),n.children(".devi_shape").show(),1==s&&"linker"!=o.name&&o.link&&n.children("li[ac=changelink]").show(),("linker"==o.name||o.textBlock&&0<o.textBlock.length)&&n.children("li[ac=edit]").show(),n.children("li[ac=delete]").show(),n.children(".devi_del").show())),n.css({display:"block","z-index":Model.orderList.length+3+99999,left:e,top:t}),$(document).bind("mousedown.ctxmenu",function(){Designer.contextMenu.hide()})},hide:function(){$("#designer_contextmenu").hide(),$(document).unbind("mousedown.ctxmenu")},execAction:function(e){var t,n,i,o=e.attr("ac");"cut"==o?Designer.clipboard.cut():"copy"==o?Designer.clipboard.copy():"paste"==o?Designer.clipboard.paste(this.menuPos.x,this.menuPos.y):"duplicate"==o?Designer.clipboard.duplicate():"front"==o?Designer.layerShapes("front"):"back"==o?Designer.layerShapes("back"):"lock"==o?Designer.lockShapes():"unlock"==o?Designer.unlockShapes():"group"==o?Designer.group():"ungroup"==o?Designer.ungroup():"align_shape"==o?(t=e.attr("al"),Designer.alignShapes(t)):"distribute_shape"==o?(n=e.attr("dis"),Designer.distributeShapes(n)):"edit"==o?Designer.op.editShapeText(this.menuPos.shape,this.menuPos):"delete"==o?Designer.op.removeShape():"selectall"==o?Designer.selectAll():"drawline"==o?Designer.op.changeState("creating_free_linker"):"changelink"==o?UI.showInsertLink():"replace"==o?(i=Utils.getSelectedIds(),Designer.op.linkDashboard(i[0])):"defaultStyle"==o&&Designer.events.push("setDefaultStyle",e)}},init:function(){this.initialize.initLayout(),this.initialize.initModel(),0==localRuntime&&this.initialize.initCanvas(),this.initialize.initShapes(),this.hotkey.init(),this.contextMenu.init(),Designer.op.init(),Designer.events.push("initialized"),$("#designer_layout").on("scroll",function(){$(document).trigger("mouseup.multiselect")})},op:{init:function(){var s=$("#designer_canvas"),r=$("#canvas_container");r.unbind("mousemove.operate").bind("mousemove.operate",function(e){var t,n,i,o;null==Designer.op.state&&(Designer.op.destroy(),t=Utils.getRelativePos(e.pageX,e.pageY,s),null!=(n=Utils.getShapeByPosition(t.x,t.y))?"dataAttribute"==n.type?Designer.op.linkClickable(n.attribute.value,t):"linker"==n.type?(r.css("cursor","pointer"),Designer.op.shapeSelectable(n.shape),i=n.shape,o=n.pointIndex,"broken"==i.linkerType&&1<o&&o<=i.points.length?Designer.op.brokenLinkerChangable(i,o-1):null==i.from.id&&null==i.to.id&&(r.css("cursor","move"),Designer.op.shapeDraggable()),Designer.op.linkerEditable(i)):"linker_point"==n.type?(r.css("cursor","move"),Designer.op.shapeSelectable(n.shape),Designer.op.linkerDraggable(n.shape,n.point),Designer.op.linkerEditable(n.shape)):"linker_text"==n.type?(r.css("cursor","text"),Designer.op.shapeSelectable(n.shape),Designer.op.linkerEditable(n.shape)):("shape"==n.type?n.shape.locked?(r.css("cursor","default"),Designer.op.shapeSelectable(n.shape)):(r.css("cursor","move"),Designer.op.shapeSelectable(n.shape),Designer.op.shapeEditable(n.shape),Designer.op.shapeDraggable(),n.shape.link&&Designer.op.linkClickable(n.shape.link,t)):(r.css("cursor","crosshair"),Designer.op.shapeSelectable(n.shape),Designer.op.shapeLinkable(n.shape,n.linkPoint)),n.shape.parent?Utils.showAnchors(Model.getShapeById(n.shape.parent)):Utils.showAnchors(n.shape)):(r.css("cursor","default"),Designer.op.shapeMultiSelectable()))})},cancel:function(){$("#canvas_container").unbind("mousemove.operate").css("cursor","default"),this.destroy()},destroy:function(){$("#designer_canvas").unbind("mousedown.drag").unbind("dblclick.edit").unbind("mousedown.draglinker").unbind("mousedown.select").unbind("mousedown.brokenLinker").off("dblclick.edit_linker"),$("#canvas_container").unbind("mousedown.link").unbind("mousedown.create_text").unbind("mousedown.drag_canvas"),$("#designer_layout").unbind("mousedown.multiselect"),Utils.hideAnchors(),$("#link_spot").hide()},state:null,changeState:function(e){"creating_free_text"==(this.state=e)?(this.destroy(),$("#canvas_container").css("cursor","crosshair"),this.textCreatable()):"creating_free_linker"==e?(this.destroy(),$("#canvas_container").css("cursor","crosshair"),this.shapeLinkable()):"drag_canvas"==e?(this.destroy(),this.canvasDraggable()):"changing_curve"==e&&this.destroy()},resetState:function(){this.state=null,$("#canvas_container").css("cursor","default")},shapeSelectable:function(i){var o=$("#designer_canvas");o.bind("mousedown.select",function(e){Designer.op.changeState("seelcting_shapes");var t=i.id,n=[];e.ctrlKey||e.metaKey?(n=Utils.getSelectedIds(),Utils.isSelected(t)?Utils.removeFromArray(n,t):n.push(t),Utils.unselect(),0<n.length&&Utils.selectShape(n)):Utils.selectIds.indexOf(t)<0&&(Utils.unselect(),Utils.selectShape(t)),$(document).bind("mouseup.select",function(){Designer.op.resetState(),o.unbind("mousedown.select"),$(document).unbind("mouseup.select")})})},isMetaKey:!1,shapeDraggable:function(){var b=$("#designer_canvas"),k=$("#canvas_container"),M=!1;b.bind("mousedown.drag",function(e){Utils.hideLinkerCursor(),Utils.hideLinkerControls(),Designer.op.changeState("dragging");var l=Utils.getSelected(),d=Utils.getRelativePos(e.pageX,e.pageY,b),p=!0;1==l.length&&"linker"==l[0].name&&(p=!1);var h=null;p&&(h=Utils.getShapesBounding(l));var t=Utils.getFamilyShapes(l);l=l.concat(t);var n=Utils.getContainedShapes(l);l=l.concat(n);var i=Utils.getAttachedShapes(l);l=l.concat(i);var o=Utils.getCollapsedShapes(l);l=l.concat(o);var c=[];if(p)for(var s=0;s<l.length;s++){"linker"==(y=l[s]).name&&(y.from.id&&c.indexOf(y.from.id)<0&&c.push(y.from.id),y.to.id&&c.indexOf(y.to.id)<0&&c.push(y.to.id)),c.indexOf(y.id)<0&&c.push(y.id)}var u=l;if(0!=l.length){for(var r=Utils.getOutlinkers(l),l=l.concat(r),g=[],a=0;a<l.length;a++){var y=l[a];g.push(y.id)}Model.define.page.width.toScale(),Model.define.page.height.toScale();var f=u[0].props.w,x=u[0].props.h;Designer.op.initScrollPos();var v=e.pageX,m=e.pageY,S=0,w=0;k.bind("mousemove.drag",function(e){S=e.pageX-v,w=e.pageY-m,(Designer.op.isMetaKey||e.ctrlKey)&&(6<Math.abs(e.pageX-v)||6<Math.abs(e.pageY-m))&&0==M&&(Designer.clipboard.copy(),Designer.clipboard.paste(),l=Utils.getSelected(),M=!0),UI.hideShapeOptions();var t,n,i=Utils.getRelativePos(e.pageX,e.pageY,b),o={x:i.x-d.x,y:i.y-d.y},s=null;if(p&&((t=Utils.copy(h)).x+=o.x,t.y+=o.y,n=Designer.op.snapLine(t,c),o={x:t.x-h.x,y:t.y-h.y},i={x:d.x+o.x,y:d.y+o.y},h.x+=o.x,h.y+=o.y,1==u.length&&"boundaryEvent"==u[0].groupName&&(n.attach?u[0].attachTo=n.attach.id:delete l[0].attachTo),n.container&&(s=n.container)),0!=o.x||0!=o.y){for(var r=0;r<l.length;r++){var a=l[r];"linker"!=a.name&&(a.container&&0<=g.indexOf(a.container)||(s?a.container=s.id:delete a.container))}Designer.op.moveShape(l,o),d=i,Designer.op.isScroll(e.pageX,e.pageY),Designer.events.push("changeLinkers",l)}}),$(document).unbind("mouseup.drop").bind("mouseup.drop",function(){$(document).unbind("mouseup.drop"),0==S&&0==w||(Model.updateMulti(l),Designer.op.changeCanvas(u,f,x))}),$(document).bind("mouseup.drag",function(){Designer.op.isMetaKey=!1,M=!1,UI.showShapeOptions(),Designer.op.resetState(),k.unbind("mousemove.drag"),b.unbind("mousedown.drag"),$(document).unbind("mouseup.drag"),Designer.op.hideTip(),Designer.op.hideSnapLine(),Utils.showLinkerCursor(),Utils.showLinkerControls(),Designer.op.stopScroll()})}else b.unbind("mousedown.drag")})},changeSpacing:function(e,t){var h=Utils.getSelectedIds(),n=Utils.getSelected();Utils.hideLinkerCursor();var i=$("#canvas_container"),c=$("#designer_canvas"),u=Utils.getControlBox(h),g=e.attr("resizeDir"),y={};function o(e,t){if(null==e.id)return t?{type:"box",x:(e.x-u.x)/u.w,y:(e.y-u.y)/u.h}:{type:"fixed"};if(Utils.isSelected(e.id)){var n=Model.getShapeById(e.id),i={x:n.props.x+n.props.w/2,y:n.props.y+n.props.h/2},o=Utils.getRotated(i,e,-n.props.angle);return{type:"shape",x:(o.x-n.props.x)/n.props.w,y:(o.y-n.props.y)/n.props.h}}return{type:"fixed"}}0<=g.indexOf("l")?y.x=u.x+u.w:0<=g.indexOf("r")?y.x=u.x:y.x=u.x+u.w/2,0<=g.indexOf("t")?y.y=u.y+u.h:0<=g.indexOf("b")?y.y=u.y:y.y=u.y+u.h/2;var f=[],x={},s=[],r=Utils.getAttachedShapes(n);n=n.concat(r);for(var a=[],v={w:20,h:20},l=0;l<n.length;l++){var d=n[l];if(a.push(d.id),d.parent&&a.push(d.parent),"linker"==d.name)-1==s.indexOf(d.id)&&s.push(d.id);else{f.push(d),d.props.w>v.w&&(v.w=d.props.w),d.props.h>v.h&&(v.h=d.props.h),d.attachTo&&!Utils.isSelected(d.id)?x[d.id]={type:"attached",x:(d.props.x+d.props.w/2-u.x)/u.w,y:(d.props.y+d.props.h/2-u.y)/u.h}:x[d.id]={x:(d.props.x-u.x)/u.w,y:(d.props.y-u.y)/u.h};var p=Model.getShapeLinkers(d.id);if(p&&0<p.length)for(var m=0;m<p.length;m++){var S=p[m];-1==s.indexOf(S)&&s.push(S)}}}for(l=0;l<s.length;l++){var S=s[l],w=Model.getShapeById(S);f.push(w);n=Utils.isSelected(S);x[w.id]={from:o(w.from,n),to:o(w.to,n)}}var b=e.css("cursor");i.css("cursor",b);var k;Designer.events.push("beforeResize",{minSize:v,shapes:f,dir:g}),i.bind("mousemove.resize",function(e){UI.hideShapeOptions(),k=[];var t=Utils.getRelativePos(e.pageX,e.pageY,c),t=Utils.restoreScale(t),n=Utils.copy(u);0<=g.indexOf("r")?n.w=t.x-y.x:0<=g.indexOf("l")&&(n.w=y.x-t.x),0<=g.indexOf("b")?n.h=t.y-y.y:0<=g.indexOf("t")&&(n.h=y.y-t.y),n.w<v.w&&(n.w=v.w),n.h<v.h&&(n.h=v.h),0<=g.indexOf("l")&&(n.x=y.x-n.w),0<=g.indexOf("t")&&(n.y=y.y-n.h),Utils.removeAnchors();for(var i=0;i<f.length;i++){var o,s,r,a,l=f[i],d=x[l.id];"linker"!=l.name?"attached"==d.type?(l.props.x=n.x+n.w*d.x-l.props.w/2,l.props.y=n.y+n.h*d.y-l.props.h/2):(l.props.x=n.x+n.w*d.x,l.props.y=n.y+n.h*d.y,Designer.painter.renderShape(l),Utils.showAnchors(l)):("box"==d.from.type?(l.from.x=n.x+n.w*d.from.x,l.from.y=n.y+n.h*d.from.y):"shape"==d.from.type&&(s={x:(o=Model.getShapeById(l.from.id)).props.x+o.props.w*d.from.x,y:o.props.y+o.props.h*d.from.y},r={x:o.props.x+o.props.w/2,y:o.props.y+o.props.h/2},a=Utils.getRotated(r,s,o.props.angle),l.from.x=a.x,l.from.y=a.y),"box"==d.to.type?(l.to.x=n.x+n.w*d.to.x,l.to.y=n.y+n.h*d.to.y):"shape"==d.to.type&&(s={x:(o=Model.getShapeById(l.to.id)).props.x+o.props.w*d.to.x,y:o.props.y+o.props.h*d.to.y},r={x:o.props.x+o.props.w/2,y:o.props.y+o.props.h/2},a=Utils.getRotated(r,s,o.props.angle),l.to.x=a.x,l.to.y=a.y),Designer.painter.renderLinker(l,!0))}Designer.painter.drawControls(h);var p="W: "+Math.round(n.w)+"&nbsp;&nbsp;H: "+Math.round(n.h);n.x!=u.x&&(p="X: "+Math.round(n.x)+"&nbsp;&nbsp;Y: "+Math.round(n.y)+"<br/>"+p),Designer.op.showTip(p),$(document).unbind("mouseup.resize_ok").bind("mouseup.resize_ok",function(){if(0<k.length&&(f=f.concat(k)),0<=g.indexOf("t")||0<=g.indexOf("l")){for(var e=0;e<f.length;e++){var t,n,i,o,s,r=f[e];r.attribute&&r.attribute.collapsed&&(0<(n=Utils.getCollapsedShapesById(r.id)).length&&(t=Utils.getOutlinkers(n),n=n.concat(t),i=Model.getPersistenceById(r.id),o=r.props.x-i.props.x,s=r.props.y-i.props.y,Designer.op.moveShape(n,{x:o,y:s},!0),f=f.concat(n)))}Designer.painter.drawControls(h)}Model.updateMulti(f),$(document).unbind("mouseup.resize_ok")})}),$(document).bind("mouseup.resize",function(){UI.showShapeOptions(),i.css("cursor","default"),Designer.op.resetState(),i.unbind("mousemove.resize"),$(document).unbind("mouseup.resize"),Designer.op.hideTip(),Utils.showLinkerCursor(),Designer.op.hideSnapLine()})},shapeResizable:function(){$(".shape_controller").bind("mousedown",function(e){e.stopPropagation(),Designer.op.changeState("resizing");var t,S=Utils.getSelectedIds(),n=Utils.getSelected();0<$("#shape_text_edit").length&&"cls"!=n[0].name&&"interface"!=n[0].name&&(t=$("#shape_text_edit").val(),n[0].textBlock[0].text=t),Utils.hideLinkerCursor();var w,i=$("#canvas_container"),b=$("#designer_canvas"),o=$(this);1==S.length?(p=Model.getShapeById(S[0]),w=Utils.copy(p.props)):(w=Utils.getControlBox(S)).angle=0;var s={x:w.x+w.w/2,y:w.y+w.h/2},k=o.attr("resizeDir"),M={};function r(e,t){if(null==e.id)return t?{type:"box",x:(e.x-w.x)/w.w,y:(e.y-w.y)/w.h}:{type:"fixed"};if(Utils.isSelected(e.id)){var n=Model.getShapeById(e.id),i={x:n.props.x+n.props.w/2,y:n.props.y+n.props.h/2},o=Utils.getRotated(i,e,-n.props.angle);return{type:"shape",x:(o.x-n.props.x)/n.props.w,y:(o.y-n.props.y)/n.props.h}}return{type:"fixed"}}0<=k.indexOf("l")?M.x=w.x+w.w:0<=k.indexOf("r")?M.x=w.x:M.x=w.x+w.w/2,0<=k.indexOf("t")?M.y=w.y+w.h:0<=k.indexOf("b")?M.y=w.y:M.y=w.y+w.h/2,M=Utils.getRotated(s,M,w.angle);var _=[],D={},a=[],l=Utils.getAttachedShapes(n);n=n.concat(l);for(var I=[],d=0;d<n.length;d++){var p=n[d];if(I.push(p.id),p.parent&&I.push(p.parent),"linker"==p.name)-1==a.indexOf(p.id)&&a.push(p.id);else{_.push(p),p.attachTo&&!Utils.isSelected(p.id)?D[p.id]={type:"attached",x:(p.props.x+p.props.w/2-w.x)/w.w,y:(p.props.y+p.props.h/2-w.y)/w.h}:D[p.id]={x:(p.props.x-w.x)/w.w,y:(p.props.y-w.y)/w.h,w:p.props.w/w.w,h:p.props.h/w.h};var h=Model.getShapeLinkers(p.id);if(h&&0<h.length)for(var c=0;c<h.length;c++){var u=h[c];-1==a.indexOf(u)&&a.push(u)}}}for(d=0;d<a.length;d++){var u=a[d],g=Model.getShapeById(u);_.push(g);n=Utils.isSelected(u);D[g.id]={from:r(g.from,n),to:r(g.to,n)}}var y=o.css("cursor");i.css("cursor",y);var U=[],C={w:20,h:20};Designer.events.push("beforeResize",{minSize:C,shapes:_,dir:k}),i.bind("mousemove.resize",function(e){UI.hideShapeOptions(),U=[];var t=Utils.getRelativePos(e.pageX,e.pageY,b),t=Utils.restoreScale(t),n=Utils.getRotated(M,t,-w.angle),i=Utils.copy(w);0<=k.indexOf("r")?i.w=n.x-M.x:0<=k.indexOf("l")&&(i.w=M.x-n.x),0<=k.indexOf("b")?i.h=n.y-M.y:0<=k.indexOf("t")&&(i.h=M.y-n.y),(e.ctrlKey||e.metaKey)&&2==k.length?w.w>=w.h?(i.h=w.h/w.w*i.w,i.h<C.h&&(i.h=C.h,i.w=w.w/w.h*i.h)):(i.w=w.w/w.h*i.h,i.w<C.w&&(i.w=C.w,i.h=w.h/w.w*i.w)):(i.w<C.w&&(i.w=C.w),i.h<C.h&&(i.h=C.h));var o={};0<=k.indexOf("r")?o.x=M.x+i.w:0<=k.indexOf("l")?o.x=M.x-i.w:o.x=M.x,0<=k.indexOf("b")?o.y=M.y+i.h:0<=k.indexOf("t")?o.y=M.y-i.h:o.y=M.y;var s=Utils.getRotated(M,o,w.angle),r={x:.5*M.x+.5*s.x,y:.5*M.y+.5*s.y},a=Utils.getRotated(r,M,-w.angle);0<=k.indexOf("r")?i.x=a.x:0<=k.indexOf("l")?i.x=a.x-i.w:i.x=a.x-i.w/2,0<=k.indexOf("b")?i.y=a.y:0<=k.indexOf("t")?i.y=a.y-i.h:i.y=a.y-i.h/2,0==i.angle&&(_[0],Designer.op.snapResizeLine(i,I,k)),Utils.removeAnchors();for(var l=0;l<_.length;l++){var d,p,h,c,u,g,y,f,x=_[l],v=D[x.id];"linker"==x.name?("box"==v.from.type?(x.from.x=i.x+i.w*v.from.x,x.from.y=i.y+i.h*v.from.y):"shape"==v.from.type&&(p={x:(d=Model.getShapeById(x.from.id)).props.x+d.props.w*v.from.x,y:d.props.y+d.props.h*v.from.y},h={x:d.props.x+d.props.w/2,y:d.props.y+d.props.h/2},c=Utils.getRotated(h,p,d.props.angle),x.from.x=c.x,x.from.y=c.y),"box"==v.to.type?(x.to.x=i.x+i.w*v.to.x,x.to.y=i.y+i.h*v.to.y):"shape"==v.to.type&&(p={x:(d=Model.getShapeById(x.to.id)).props.x+d.props.w*v.to.x,y:d.props.y+d.props.h*v.to.y},h={x:d.props.x+d.props.w/2,y:d.props.y+d.props.h/2},c=Utils.getRotated(h,p,d.props.angle),x.to.x=c.x,x.to.y=c.y),Designer.painter.renderLinker(x,!0)):("attached"==v.type?(x.props.x=i.x+i.w*v.x-x.props.w/2,x.props.y=i.y+i.h*v.y-x.props.h/2):(u=Utils.copy(x.props),x.props.x=i.x+i.w*v.x,x.props.y=i.y+i.h*v.y,x.props.w=i.w*v.w,x.props.h=i.h*v.h,(g=Model.getShapeById(x.id).props).x=i.x+i.w*v.x,g.y=i.y+i.h*v.y,g.w=i.w*v.w,g.h=i.h*v.h,y={shape:x,offset:{x:x.props.x-u.x,y:x.props.y-u.y,w:x.props.w-u.w,h:x.props.h-u.h},dir:k},(f=Designer.events.push("resizing",y))&&(U=U.concat(f))),Designer.painter.renderShape(x),Utils.showAnchors(x))}Designer.painter.drawControls(S);var m="W: "+Math.round(i.w)+"&nbsp;&nbsp;H: "+Math.round(i.h);i.x!=w.x&&(m="X: "+Math.round(i.x)+"&nbsp;&nbsp;Y: "+Math.round(i.y)+"<br/>"+m),Designer.op.showTip(m),$(document).unbind("mouseup.resize_ok").bind("mouseup.resize_ok",function(){if(0<U.length&&(_=_.concat(U)),0<=k.indexOf("t")||0<=k.indexOf("l")){for(var e,t,n,i,o,s=0;s<_.length;s++){(r=_[s]).attribute&&r.attribute.collapsed&&(0<(t=Utils.getCollapsedShapesById(r.id)).length&&(e=Utils.getOutlinkers(t),t=t.concat(e),n=Model.getPersistenceById(r.id),i=r.props.x-n.props.x,o=r.props.y-n.props.y,Designer.op.moveShape(t,{x:i,y:o},!0),_=_.concat(t)))}Designer.painter.drawControls(S)}Model.updateMulti(_),Designer.events.push("changeLinkers",_),$(document).unbind("mouseup.resize_ok");for(var r,a=_[0],l=_[0],s=0;s<_.length;s++){(r=_[s]).props.w+r.props.x>a.props.w+a.props.x&&(a=r),r.props.h+r.props.y>l.props.h+l.props.y&&(l=r)}var d=a.props.w,p=a.props.h;a.id!=l.id?(Designer.op.changeCanvas([a],d,p),d=l.props.w,p=l.props.h,Designer.op.changeCanvas([l],d,p)):Designer.op.changeCanvas([a],d,p)})}),$(document).bind("mouseup.resize",function(){UI.showShapeOptions(),i.css("cursor","default"),Designer.op.resetState(),i.unbind("mousemove.resize"),$(document).unbind("mouseup.resize"),Designer.op.hideTip(),Utils.showLinkerCursor(),Designer.op.hideSnapLine()})})},shapeRotatable:function(){$(".shape_rotater").bind("mousemove",function(e){var t=$(this),n=e.pageX-t.offset().left,i=e.pageY-t.offset().top,o=t[0].getContext("2d");t.unbind("mousedown"),t.removeClass("rotate_enable"),o.isPointInPath(2*n,2*i)?(t.addClass("rotate_enable"),t.bind("mousedown",function(e){Utils.hideLinkerCursor(),$("#shape_text_edit").length&&$("#shape_text_edit").trigger("blur"),e.stopPropagation(),Designer.op.changeState("rotating");var t,g,y,n=Utils.getSelectedIds();y=1==n.length?(t=Model.getShapeById(n[0]),g=t.props,t.props.angle):(g=Utils.getControlBox(n),0);var f={x:g.x+g.w/2,y:g.y+g.h/2},x=Utils.toScale(f),v=$("#designer_canvas"),m=Utils.getSelected(),i=Utils.getAttachedShapes(m),m=m.concat(i),o=Utils.getOutlinkers(m);m=m.concat(o);var S=y;$(document).bind("mousemove.rotate",function(e){UI.hideShapeOptions();var t=Utils.getRelativePos(e.pageX,e.pageY,v),n=Math.atan(Math.abs(t.x-x.x)/Math.abs(x.y-t.y));t.x>=x.x&&t.y>=x.y?n=Math.PI-n:t.x<=x.x&&t.y>=x.y?n=Math.PI+n:t.x<=x.x&&t.y<=x.y&&(n=2*Math.PI-n),n%=2*Math.PI;var i=Math.PI/36,o=Math.round(n/i);if((n=i*o)!=S){S=n,Designer.op.showTip(5*o%360+"°"),Designer.painter.rotateControls(g,n),Utils.removeAnchors();for(var s=n-y,r=0;r<m.length;r++){var a,l,d,p,h,c=m[r],u=Model.getPersistenceById(c.id);"linker"!=c.name?(c.props.angle=Math.abs((s+u.props.angle)%(2*Math.PI)),a={x:u.props.x+u.props.w/2,y:u.props.y+u.props.h/2},l=Utils.getRotated(f,a,s),c.props.x=l.x-c.props.w/2,c.props.y=l.y-c.props.h/2,Designer.painter.renderShape(c),Utils.showAnchors(c)):(d=!1,(Utils.isSelected(c.id)&&null==c.from.id||Utils.isSelected(c.from.id))&&(h=Utils.getRotated(f,u.from,s),c.from.x=h.x,c.from.y=h.y,null!=c.from.angle&&(c.from.angle=Math.abs((u.from.angle+s)%(2*Math.PI))),d=!0),p=!1,(Utils.isSelected(c.id)&&null==c.to.id||Utils.isSelected(c.to.id))&&(h=Utils.getRotated(f,u.to,s),c.to.x=h.x,c.to.y=h.y,null!=c.to.angle&&(c.to.angle=Math.abs((u.to.angle+s)%(2*Math.PI))),p=!0),(d||p)&&Designer.painter.renderLinker(c,!0))}}}).bind("mouseup.rotate",function(){UI.showShapeOptions(),$(document).unbind("mousemove.rotate").unbind("mouseup.rotate"),Designer.op.resetState(),Model.updateMulti(m),Designer.painter.drawControls(n),Designer.op.hideTip(),Utils.showLinkerCursor(),Designer.events.push("changeLinkers",m)})})):(t.removeClass("rotate_enable"),t.unbind("mousedown"))})},groupShapeChangable:function(){$(".change_shape_icon").bind("mousedown",function(e){e.stopPropagation();var i=Utils.getSelected()[0],t=i.groupName,n=$(this).parent(),o=n.position(),s=o.left+n.width(),r=o.top+n.height()+10;Designer.op.groupDashboard(t,s,r,function(e){var t,n;i.name!=e&&(t=Designer.events.push("shapeChanged",{shape:i,name:e}),Model.changeShape(i,e),n=[i],t&&0<t.length&&(n=n.concat(t)),Model.updateMulti(n))})})},shapeMultiSelectable:function(){var s=$("#designer_canvas"),t=$("#designer_layout"),r=$("#canvas_container");t.unbind("mousedown.multiselect").bind("mousedown.multiselect",function(e){var i,o=null;e.ctrlKey||e.metaKey||Utils.unselect(),0<=(e.target.classList+"").indexOf("layout")||(i=Utils.getRelativePos(e.pageX,e.pageY,s),Designer.op.changeState("multi_selecting"),Designer.op.initScrollPos(),r.off("mousemove.multiselect").on("mousemove.multiselect",function(e){null==o&&(o=$("<div id='selecting_box'></div>").appendTo(s));var t=Utils.getRelativePos(e.pageX,e.pageY,s),n={"z-index":Model.orderList.length,left:t.x,top:t.y};t.x>i.x&&(n.left=i.x),t.y>i.y&&(n.top=i.y),n.width=Math.abs(t.x-i.x),n.height=Math.abs(t.y-i.y),o.css(n),Designer.op.isScroll(e.pageX,e.pageY)}),$(document).off("mouseup.multiselected").on("mouseup.multiselected",function(e){var t,n,i;null!=o&&(t={x:o.position().left.restoreScale(),y:o.position().top.restoreScale(),w:o.width().restoreScale(),h:o.height().restoreScale()},n=Utils.getShapesByRange(t),(e.ctrlKey||e.metaKey)&&(i=Utils.getSelectedIds(),Utils.mergeArray(n,i)),Utils.unselect(),Utils.selectShape(n),o.remove()),Designer.op.resetState(),$(document).off("mouseup.multiselected"),r.off("mousemove.multiselect"),Designer.op.stopScroll()}),t.unbind("mousedown.multiselect"))})},shapeEditable:function(n){var i=$("#designer_canvas");i.unbind("dblclick.edit").bind("dblclick.edit",function(e){i.unbind("dblclick.edit");var t=Utils.getRelativePos(e.pageX,e.pageY,i);Designer.op.editShapeText(n,t)})},editShapeText:function(p,e){if("linker"!=p.name){if(p.textBlock&&0!=p.textBlock.length){var t,n=p.getTextBlock(),o=0;if(e){e.x=e.x.restoreScale(),e.y=e.y.restoreScale(),0!=p.props.angle&&(t={x:p.props.x+p.props.w/2,y:p.props.y+p.props.h/2},e=Utils.getRotated(t,e,-p.props.angle));for(var i=e.x-p.props.x,s=e.y-p.props.y,r=0;r<n.length;r++){var a=n[r];if(Utils.pointInRect(i,s,a.position)){o=r;break}}}Designer.contextMenu.hide();var h=$("#shape_text_edit");0==h.length&&(h=$("<div contenteditable='true' spellcheck=false id='shape_text_edit'></div>").appendTo("#designer_canvas"));var c=$("#shape_text_ruler");0==c.length&&(c=$("<div contenteditable='true' spellcheck=false id='shape_text_ruler'></div>").appendTo("#designer_canvas")),$(".text_canvas[forshape="+p.id+"][ind="+o+"]").hide();var l,d,u=n[o],g=p.textBlock[o],y=Utils.getShapeFontStyle(p.fontStyle),y=$.extend({},y,u.fontStyle),f=u.position;"horizontal"==y.orientation&&(l=f.x+f.w/2,d=f.y+f.h/2,f={x:l-f.h/2,y:d-f.w/2,w:f.h,h:f.w});var x,v={width:f.w+"px","z-index":Model.orderList.length+2,"line-height":Math.round(1.25*y.size)+"px","font-size":y.size+"px","font-family":y.fontFamily,"font-weight":y.bold?"bold":"normal","font-style":y.italic?"italic":"normal","text-align":y.textAlign,color:"rgb("+y.color+")","text-decoration":y.underline?"underline":"none","word-wrap":"break-word"};h.css(v),c.css(v),h.show(),f.x+=p.props.x,f.y+=p.props.y,null!=u.text&&(x=u.text.replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;").replace(/\  /g,"&nbsp;&nbsp;"),h.html(x));var m=0,S=0,w=0,b=!1,k=!1;$("#shape_text_edit").off().on("keyup",function(e){c.html($(this).html()),m=c.height(),h.css({height:m});f.x,f.w;var t=f.y+f.h/2,n=0,i=0,o=f.h;"middle"==y.vAlign?o<m?(n=t-(o=m)/2,i=0):(n=t-f.h/2,i=(f.h-m)/2,o=f.h-i):"bottom"==y.vAlign?o<m?(o=m,n=t+f.h/2-o,i=0):(n=t-f.h/2,i=f.h-m,o=f.h-i):(n=t-f.h/2,i=0,o=o<m?m:f.h);var s,r=i+o,a={x:f.x+f.w/2,y:n+r/2},l=p.props.angle;0!=l&&(s={x:p.props.x+p.props.w/2,y:p.props.y+p.props.h/2},a=Utils.getRotated(s,a,l)),"horizontal"==y.orientation&&(l=(1.5*Math.PI+l)%(2*Math.PI));var d="rotate("+Math.round(l/(2*Math.PI)*360)+"deg) scale("+Designer.config.scale+")";h.css({width:f.w,height:o,"padding-top":i,left:a.x.toScale()-f.w/2-2,top:a.y.toScale()-r/2-2,"-webkit-transform":d,"-ms-transform":d,"-o-transform":d,"-moz-transform":d,transform:d}),e.stopPropagation()}).on("keydown",function(e){e.stopPropagation();var t,n,i=$(this);if(13==e.keyCode&&e.ctrlKey)return M(),!1;27==e.keyCode?(i.unbind().remove(),$(".text_canvas[forshape="+p.id+"][ind="+o+"]").show()):66==e.keyCode&&e.ctrlKey?(t=!y.bold,1==p.textBlock.length?p.fontStyle.bold=t:g.fontStyle=$.extend(g.fontStyle,{bold:t}),y.bold=t,Model.update(p),n=t?"bold":"normal",$(this).css("font-weight",n),c.css("font-weight",n),UI.update(),e.preventDefault()):73==e.keyCode&&e.ctrlKey?(t=!y.italic,1==p.textBlock.length?p.fontStyle.italic=t:g.fontStyle=$.extend(g.fontStyle,{italic:t}),y.italic=t,Model.update(p),n=t?"italic":"normal",$(this).css("font-style",n),c.css("font-style",n),UI.update(),e.preventDefault()):85==e.keyCode&&e.ctrlKey?(t=!y.underline,1==p.textBlock.length?p.fontStyle.underline=t:g.fontStyle=$.extend(g.fontStyle,{underline:t}),y.underline=t,Model.update(p),n=t?"underline":"none",$(this).css("text-decoration",n),c.css("text-decoration",n),e.preventDefault(),UI.update(),e.preventDefault()):13==e.keyCode&&Utils.isIE()&&!e.shiftKey&&e.preventDefault()}).on("blur",function(e){M()}).bind("focus",function(e){var t="";window.getSelection?t=window.getSelection().toString():document.selection&&(t=document.selection.createRange().text),""!=$.trim(t)&&Utils.popEditor.init(this),e.stopPropagation()}).on("mousemove",function(e){e.stopPropagation(),(3<Math.abs(e.pageX-S)||3<Math.abs(e.pageX-w))&&(k=!0)}).on("mousedown",function(e){S=e.pageX,w=e.pageY,k=!(b=!0),e.stopPropagation()}).on("mouseenter",function(e){Designer.op.destroy()}).on("paste",function(e){var t,n,i,o=e.clipboardData||e.originalEvent.clipboardData||window.clipboardData;if(o){t=o.items,i=o.types||[];for(var s,r=0;r<i.length;r++)if("text/plain"==i[r]){n=t[r];break}n.getAsString(function(e){e=(e=Utils.filterXss(e)).replace(/\n/g,"<div></div>");var t=window.getSelection().getRangeAt(0);document.queryCommandSupported("insertHTML")?document.execCommand("insertHTML",!1,e):t.pasteHTML&&t.pasteHTML(e)}),null!=n||!Utils.isIE()||""!=(s=o.getData("Text"))&&null!=s&&(s=s.replace(/\n/g,"<div></div>"),window.getSelection().getRangeAt(0).pasteHTML(s))}e.stopPropagation(),e.preventDefault()}),$("#shape_text_edit").trigger("keyup"),$(document).unbind("mouseup.edittext").bind("mouseup.edittext",function(e){var t="";window.getSelection?t=window.getSelection().toString():document.selection&&(t=document.selection.createRange().text),""!=$.trim(t)&&k&&b&&(Utils.popEditor.init($("#shape_text_edit")),b=!1),e.stopPropagation()}),Utils.selectText(h[0])}}else this.editLinkerText(p);function M(){Utils.popEditor.close();var e,t=$("#shape_text_edit").html();$("#shape_text_edit").length&&$("#shape_text_edit").is(":visible")&&(e=Model.getShapeById(p.id),t!=g.text&&(e.textBlock[o].text=t,"interface"!=p.name&&"cls"!=p.name||Designer.op.shapeChangeHeight(e,o,m,t),Model.update(e)),Designer.painter.renderShape(e),$("#shape_text_edit").remove(),p=null)}},editShapeText1:function(p,e){if("linker"!=p.name){if(p.textBlock&&0!=p.textBlock.length){var t,n=p.getTextBlock(),o=0;if(e){e.x=e.x.restoreScale(),e.y=e.y.restoreScale(),0!=p.props.angle&&(t={x:p.props.x+p.props.w/2,y:p.props.y+p.props.h/2},e=Utils.getRotated(t,e,-p.props.angle));for(var i=e.x-p.props.x,s=e.y-p.props.y,r=0;r<n.length;r++){var a=n[r];if(Utils.pointInRect(i,s,a.position)){o=r;break}}}Designer.contextMenu.hide();var h=$("#shape_text_edit");0==h.length&&(h=$("<textarea id='shape_text_edit'></textarea>").appendTo("#designer_canvas"));var c=$("#shape_text_ruler");0==c.length&&(c=$("<textarea id='shape_text_ruler'></textarea>").appendTo("#designer_canvas")),$(".text_canvas[forshape="+p.id+"][ind="+o+"]").hide();var l,d,u=n[o],g=p.textBlock[o],y=Utils.getShapeFontStyle(p.fontStyle),y=$.extend({},y,u.fontStyle),f=u.position;"horizontal"==y.orientation&&(l=f.x+f.w/2,d=f.y+f.h/2,f={x:l-f.h/2,y:d-f.w/2,w:f.h,h:f.w});var x={width:f.w+"px","z-index":Model.orderList.length+2,"line-height":Math.round(1.25*y.size)+"px","font-size":y.size+"px","font-family":y.fontFamily,"font-weight":y.bold?"bold":"normal","font-style":y.italic?"italic":"normal","text-align":y.textAlign,color:"rgb("+y.color+")","text-decoration":y.underline?"underline":"none"};h.css(x),c.css(x),h.show(),f.x+=p.props.x,f.y+=p.props.y,h.val(u.text);var v=0;$("#shape_text_edit").unbind().bind("keyup",function(){var e=$(this).val();c.val(e),c.scrollTop(99999),v=c.scrollTop(),h.css({height:v});f.x,f.w;var t=f.y+f.h/2,n=0,i=0,o=f.h;"middle"==y.vAlign?o<v?(n=t-(o=v)/2,i=0):(n=t-f.h/2,i=(f.h-v)/2,o=f.h-i):"bottom"==y.vAlign?o<v?(o=v,n=t+f.h/2-o,i=0):(n=t-f.h/2,i=f.h-v,o=f.h-i):(n=t-f.h/2,i=0,o=o<v?v:f.h);var s,r=i+o,a={x:f.x+f.w/2,y:n+r/2},l=p.props.angle;0!=l&&(s={x:p.props.x+p.props.w/2,y:p.props.y+p.props.h/2},a=Utils.getRotated(s,a,l)),"horizontal"==y.orientation&&(l=(1.5*Math.PI+l)%(2*Math.PI));var d="rotate("+Math.round(l/(2*Math.PI)*360)+"deg) scale("+Designer.config.scale+")";h.css({width:f.w,height:o,"padding-top":i,left:a.x.toScale()-f.w/2-2,top:a.y.toScale()-r/2-2,"-webkit-transform":d,"-ms-transform":d,"-o-transform":d,"-moz-transform":d,transform:d})}).bind("keydown",function(e){var t,n,i=$(this);if(13==e.keyCode&&(e.ctrlKey||e.metaKey))return m(),!1;27==e.keyCode?(i.unbind().remove(),$(".text_canvas[forshape="+p.id+"][ind="+o+"]").show()):66==e.keyCode&&(e.ctrlKey||e.metaKey)?(t=!y.bold,1==p.textBlock.length?p.fontStyle.bold=t:g.fontStyle=$.extend(g.fontStyle,{bold:t}),y.bold=t,Model.update(p),n=t?"bold":"normal",$(this).css("font-weight",n),c.css("font-weight",n),UI.update(),e.preventDefault()):73==e.keyCode&&(e.ctrlKey||e.metaKey)?(t=!y.italic,1==p.textBlock.length?p.fontStyle.italic=t:g.fontStyle=$.extend(g.fontStyle,{italic:t}),y.italic=t,Model.update(p),n=t?"italic":"normal",$(this).css("font-style",n),c.css("font-style",n),UI.update(),e.preventDefault()):85==e.keyCode&&(e.ctrlKey||e.metaKey)&&(t=!y.underline,1==p.textBlock.length?p.fontStyle.underline=t:g.fontStyle=$.extend(g.fontStyle,{underline:t}),y.underline=t,Model.update(p),n=t?"underline":"none",$(this).css("text-decoration",n),c.css("text-decoration",n),e.preventDefault(),UI.update(),e.preventDefault())}).bind("blur",function(e){m()}).bind("mousemove",function(e){e.stopPropagation()}).bind("mousedown",function(e){e.stopPropagation()}).bind("mouseenter",function(e){Designer.op.destroy()}).on("paste",function(e){e.stopPropagation()}),$("#shape_text_edit").trigger("keyup"),h.select()}}else this.editLinkerText(p);function m(){var e,t=$("#shape_text_edit").val();$("#shape_text_edit").length&&$("#shape_text_edit").is(":visible")&&(e=Model.getShapeById(p.id),t!=g.text&&(e.textBlock[o].text=t,"interface"!=p.name&&"cls"!=p.name||Designer.op.shapeChangeHeight(e,o,v,t),Model.update(e)),Designer.painter.renderShape(e),$("#shape_text_edit").remove(),p=null)}},shapeReplace:function(e,t){Schema.shapes[e];var n=Utils.copy(Model.getShapeById(t));Model.changeShape(n,e),Model.update(n)},shapeChangeHeight:function(e,t,n,i){var o,s;if("interface"==e.name)1==t?(n=n<30?30:n,o=e.props.h-e.textBlock[0].position.h,e.props.h+=n-o):0==t&&(s="h-"+(n=n<30?30:n),e.props.h+=n-e.path[1].actions[0].y,e.path[1].actions[0].y=n,e.path[1].actions[1].y=n,e.textBlock[0].position.h=n,e.textBlock[1].position.y=n,e.textBlock[1].position.h=s),Schema.initShapeFunctions(e);else if("cls"==e.name){var r,a=Number(e.textBlock[0].position.h),l=e.textBlock[1].position.h+"",d=e.textBlock[2].position.h+"";if(0<=l.indexOf("h")&&(l=(e.props.h-a)/2),0<=d.indexOf("h")&&(d=(e.props.h-a)/2),l=Number(l),d=Number(d),n=n<30?30:n,0==t){if(0==(r=n-a))return;e.props.h=n+l+d,e.textBlock[0].position.h=n,e.textBlock[1].position.y=n,e.textBlock[1].position.h=(e.props.h-n)/2,e.textBlock[2].position.y=(e.props.h-n)/2+n,e.textBlock[2].position.h=(e.props.h-n)/2,e.path[1].actions[0].y=n,e.path[1].actions[1].y=n,e.path[1].actions[2].y=e.props.h/2+n/2,e.path[1].actions[3].y=e.props.h/2+n/2}if(1==t){if(0==(r=n-l))return;e.props.h+=r,e.textBlock[1].position.h=n,e.textBlock[1].position.y=a,e.textBlock[2].position.y=a+n+2,e.textBlock[2].position.h=e.props.h-n-a,e.path[1].actions[0].y=a,e.path[1].actions[1].y=a,e.path[1].actions[2].y=a+n+2,e.path[1].actions[3].y=a+n+2}else if(2==t){if(0==(r=n-d))return;e.props.h=n+l+a,e.textBlock[1].position.h=l,e.path[1].actions[2].y=a+l,e.path[1].actions[3].y=a+l,e.textBlock[2].position.y=Number(a)+Number(l),e.textBlock[2].position.h=n}Schema.initShapeFunctions(e)}},shapeLinkable:function(o,s){var r=$("#designer_canvas"),a=$("#canvas_container");a.unbind("mousedown.link").bind("mousedown.link",function(e){var n,t,i;2!=e.button&&"over"!=Utils.vip.checkPrivilege("shapeCount")&&(Designer.op.changeState("linking_from_shape"),n=null,o?(i=s).id=o.id:(t=Utils.getRelativePos(e.pageX,e.pageY,r),i={x:t.x.restoreScale(),y:t.y.restoreScale(),id:null,angle:null}),Designer.op.initScrollPos(),a.bind("mousemove.link",function(e){a.css("cursor","default");var t=Utils.getRelativePos(e.pageX,e.pageY,r);null==n&&(n=function(e,t){var n=Utils.newId(),i=Utils.copy(Schema.linkerDefaults);i.from=e,i.to={id:null,x:t.x,y:t.y,angle:null},i.props={zindex:Model.maxZIndex+1},delete i.fontStyle;var o={};Designer.defaults.linkerBeginArrowStyle&&(o.beginArrowStyle=Designer.defaults.linkerBeginArrowStyle);Designer.defaults.linkerEndArrowStyle&&(o.endArrowStyle=Designer.defaults.linkerEndArrowStyle);var s=Model.define;null!=s.defaultLinkerStyle&&null!=s.defaultLinkerStyle.linkerStyle&&(o=$.extend(o,s.defaultLinkerStyle.linkerStyle));return i.lineStyle=o,i.id=n,i}(i,t),Designer.events.push("linkerCreating",n)),Designer.op.moveLinker(n,"to",t.x,t.y),$(document).unbind("mouseup.droplinker").bind("mouseup.droplinker",function(){20<Math.abs(t.x-i.x)||20<Math.abs(t.y-i.y)?(Model.add(n),Designer.events.push("linkerCreated",n),null==n.to.id&&null!=n.from.id&&Designer.op.linkDashboard(n),Utils.showLinkerCursor()):$("#"+n.id).remove(),Designer.op.hideSnapLine(),$(document).unbind("mouseup.droplinker")}),Designer.op.isScroll(e.pageX,e.pageY)}),$(document).bind("mouseup.link",function(){Designer.op.hideLinkPoint(),Designer.op.resetState(),a.unbind("mousedown.link"),a.unbind("mousemove.link"),$(document).unbind("mouseup.link"),Designer.op.stopScroll()}))})},linkerEditable:function(p){var m=$("#designer_canvas");m.off("dblclick.edit_linker").on("dblclick.edit_linker",function(){Designer.op.editLinkerText(p),m.off("dblclick.edit_linker")});var S="false";m.off("mousedown.linkerdrag").on("mousedown.linkerdrag",function(e){var t=e.target.classList+"";if(""==t||t.indexOf("linker_text")<0)return m.off("mousemove.linkerdrag"),m.off("mouseup.linkerdrag"),m.off("mousedown.linkerdrag"),void(S="false");var f=e.pageX,x=e.pageY,v={moving:!1},n=$("#"+p.id);if(0!=n.length){var i=n.children(".linker_text");n.attr("id"),i.position().left,i.position().top;i.addClass("active"),m.addClass("moving_status");for(var o=Utils.getLinkerLinesPoints(p),s=[],r=0;r<o.length;r++){var a=o[r],l=Math.floor(a.x),d=Math.floor(a.y);s.push([l,d])}v.points=s,v.plen=o.length,v.tval=-1,v.moving=!1,v.target=i,v.baseH=i.outerHeight(),v.baseW=i.outerWidth(),v.minX=n.position().left-1,v.minY=n.position().top-1,v.fromX=p.from.x,v.toX=p.to.x,v.fromY=p.from.y,v.toY=p.to.y,e.stopPropagation(),m.off("mousemove.linkerdrag").on("mousemove.linkerdrag",function(e){e.target.classList;if(Math.abs(e.pageX-f)<=3&&Math.abs(e.pageY-x)<=3)return S="false",void(v.moving=!1);v.moving=!0;for(var t=Utils.getRelativePos(e.pageX,e.pageY,m),n=Math.floor(t.x.restoreScale()),i=Math.floor(t.y.restoreScale()),o=v.points,s=o.length,r=null,a=0;a<s;a++){var l,d,p,h,c=o[a],u=c[0],g=c[1],y=Utils.measureDistance({x:n,y:i},{x:u,y:g});null!=r?(y<r&&(r=y,v.currentX=u,i<(v.currentY=g)-16&&v.fromX!=v.toX?v.pos="top":g+16<i&&v.fromX!=v.toX?v.pos="bottom":v.pos="in",v.tval=a),null!=v.currentX&&(l=v.currentX.toScale()-v.minX,d=v.currentY.toScale()-v.minY,p=Math.floor(l),h=Math.floor(d),"top"==v.pos?h=h-v.baseH-6..toScale():"bottom"==v.pos?h+=6..toScale():"in"==v.pos&&(h-=v.baseH/2),v.target.css({top:h,left:p-v.baseW/2}),S="true")):r=y}}),m.off("mouseup.linkerdrag").on("mouseup.linkerdrag",function(){var e,t;m.off("mousemove.linkerdrag"),m.off("mouseup.linkerdrag"),m.off("mousedown.linkerdrag"),v.target.removeClass("active"),m.removeClass("moving_status"),v.moving&&"true"==S&&(e=v.currentX,t=v.currentY,0<=v.tval&&(p.textPos={x:e,y:t,t:v.tval,pos:v.pos},Model.update(p)),v={moving:!1},S="false")})}})},editLinkerText:function(o){Designer.contextMenu.hide();var s=null,s=null!=o.textPos?{x:o.textPos.x,y:o.textPos.y}:Designer.painter.getLinkerMidpoint(o),r=$("#"+o.id).find(".text_canvas"),a=$("#linker_text_edit");0==a.length&&(a=$("<textarea id='linker_text_edit'></textarea>").appendTo("#designer_canvas")),$("#"+o.id).find(".text_canvas").hide();var e=Utils.getLinkerFontStyle(o.fontStyle),t="scale("+Designer.config.scale+")",l=Math.round(1.25*e.size);function i(){var e,t=$("#linker_text_edit");t.length&&t.is(":visible")&&((e=t.val())!=o.text&&(""==(o.text=e)&&delete o.textPos,Model.update(o)),Model.intersection[o.id]?Designer.painter.renderLinker(o,null,null,Model.intersection[o.id]):Designer.painter.renderLinker(o),t.remove())}a.css({"z-index":Model.orderList.length+99999,"line-height":l+"px","font-size":e.size+"px","font-family":e.fontFamily,"font-weight":e.bold?"bold":"normal","font-style":e.italic?"italic":"normal","text-align":e.textAlign,color:"rgb("+e.color+")","text-decoration":e.underline?"underline":"none","-webkit-transform":t,"-ms-transform":t,"-o-transform":t,"-moz-transform":t,transform:t}),a.val(o.text).show().select(),a.unbind().bind("keyup",function(){var e=$(this).val().replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br/>");r.html(e+"<br/>");var t=r.width();t<50&&(t=50);var n,i=r.height();i<l&&(i=l),void 0!==o.textPos?(n=s.y.toScale()-i/2-2,null!=o.textPos.pos&&"top"==o.textPos.pos?n=n-i/2-6:null!=o.textPos.pos&&"bottom"==o.textPos.pos&&(n+=i/2+6),a.css({left:s.x.toScale()-t/2-2,top:n,width:t,height:i})):a.css({left:s.x.toScale()-t/2-2,top:s.y.toScale()-i/2-2,width:t,height:i})}).bind("mousedown",function(e){e.stopPropagation()}).bind("keydown",function(e){return 13==e.keyCode&&(e.ctrlKey||e.metaKey)?(i(),!1):void(27==e.keyCode?(a.unbind().remove(),Designer.painter.renderLinkerText(o)):66==e.keyCode&&(e.ctrlKey||e.metaKey)?(t=!Utils.getLinkerFontStyle(o.fontStyle).bold,o.fontStyle.bold=t,Model.update(o),n=t?"bold":"normal",$(this).css("font-weight",n),r.css("font-weight",n),UI.update()):73==e.keyCode&&(e.ctrlKey||e.metaKey)?(t=!Utils.getLinkerFontStyle(o.fontStyle).italic,o.fontStyle.italic=t,Model.update(o),n=t?"italic":"normal",$(this).css("font-style",n),r.css("font-style",n),UI.update()):85==e.keyCode&&(e.ctrlKey||e.metaKey)&&(t=!Utils.getLinkerFontStyle(o.fontStyle).underline,o.fontStyle.underline=t,Model.update(o),n=t?"underline":"none",$(this).css("text-decoration",n),r.css("text-decoration",n),e.preventDefault(),UI.update()));var t,n}).bind("blur",function(){i()}),a.trigger("keyup")},linkerDraggable:function(o,s){var r,a;o.locked||(r=$("#designer_canvas"),a=$("#canvas_container"),r.bind("mousedown.draglinker",function(e){Utils.hideLinkerControls(),Designer.op.changeState("dragging_linker");var n=Utils.getSelectedIds(),i=!1;1<n.length&&(i=!0),Designer.op.initScrollPos(),a.bind("mousemove.draglinker",function(e){a.css("cursor","default");var t=Utils.getRelativePos(e.pageX,e.pageY,r);Designer.op.moveLinker(o,s,t.x,t.y),i&&Designer.painter.drawControls(n),$(document).unbind("mouseup.droplinker").bind("mouseup.droplinker",function(){$(document).unbind("mouseup.droplinker"),Model.update(o),Utils.showLinkerControls(),Designer.op.hideSnapLine(),Designer.events.push("linkerCreated",o)}),Designer.op.isScroll(e.pageX,e.pageY)}),$(document).bind("mouseup.draglinker",function(){Designer.op.hideLinkPoint(),Designer.op.resetState(),r.unbind("mousedown.draglinker"),a.unbind("mousemove.draglinker"),$(document).unbind("mouseup.draglinker"),Utils.showLinkerControls(),Designer.op.stopScroll()})}))},linkClickable:function(e,t){var n=$("#link_spot");0==n.length&&(n=$("<a id='link_spot' target='_blank' style='cursor: pointer'></a>").appendTo("#designer_canvas")).bind("dragstart",function(){return!1}),-1==e.trim().toLowerCase().indexOf("http")&&(e="http://"+e),n.attr("href",e),n.show().css({left:t.x-50,top:t.y-50,"z-index":Model.orderList.length+3})},textCreatable:function(){var s=$("#designer_canvas"),r=$("#canvas_container");r.unbind("mousedown.create_text").bind("mousedown.create_text",function(e){var n=null;e.ctrlKey||e.metaKey||Utils.unselect();var i=Utils.getRelativePos(e.pageX,e.pageY,s),o=null;"over"!=Utils.vip.checkPrivilege("shapeCount")&&(r.bind("mousemove.create_text",function(e){null==n&&(n=$("<div id='texting_box'></div>").appendTo(s));var t=Utils.getRelativePos(e.pageX,e.pageY,s);o={"z-index":Model.orderList.length,left:t.x-1,top:t.y-1},t.x>i.x&&(o.left=i.x-1),t.y>i.y&&(o.top=i.y-1),o.width=Math.abs(t.x-i.x-2),o.height=Math.abs(t.y-i.y-2),n.css(o)}),$(document).unbind("mouseup.create_text").bind("mouseup.create_text",function(e){var t;null!=o&&20<=o.width&&20<=o.height&&((t=Model.create("standardText",o.left.restoreScale(),o.top.restoreScale())).props.w=o.width.restoreScale(),t.props.h=o.height.restoreScale(),Model.add(t),Designer.painter.renderShape(t),Designer.op.editShapeText(t),Utils.unselect(),Utils.selectShape(t.id)),n.remove(),Designer.op.resetState(),$(document).unbind("mouseup.create_text"),r.unbind("mousemove.create_text")}),r.unbind("mousedown.create_text"))})},canvasDragTimeout:null,canvasDraggable:function(){var t=$("#canvas_container");t.css("cursor","url(/images/flow/cursor_hand.png) 8 8, auto"),t.off("mousedown.drag_canvas").on("mousedown.drag_canvas",function(i){var o=$("#designer_layout").scrollTop(),s=$("#designer_layout").scrollLeft();t.on("mousemove.drag_canvas",function(e){var t=e.pageX-i.pageX,n=e.pageY-i.pageY;$("#designer_layout").scrollLeft(s-t),$("#designer_layout").scrollTop(o-n)}),$(document).off("mouseup.drag_canvas").on("mouseup.drag_canvas",function(e){t.off("mousemove.drag_canvas"),$(document).off("mouseup.drag_canvas")})}),$(document).off("keyup.drag_canvas").on("keyup.drag_canvas",function(e){t.off("mousedown.drag_canvas"),Designer.op.resetState(),$(document).off("mouseup.drag_canvas"),e.preventDefault(),t.off("mousemove.drag_canvas")})},canvasFreeDraggable:function(){var t=$("#canvas_container");t.css("cursor","url(/images/flow/cursor_hand.png) 8 8, auto"),t.unbind("mousedown.drag_canvas").bind("mousedown.drag_canvas",function(i){var o=$("#designer_layout").scrollTop(),s=$("#designer_layout").scrollLeft();t.bind("mousemove.drag_canvas",function(e){var t=e.pageX-i.pageX,n=e.pageY-i.pageY;$("#designer_layout").scrollLeft(s-t),$("#designer_layout").scrollTop(o-n)}),$(document).unbind("mouseup.drag_canvas").bind("mouseup.drag_canvas",function(e){t.unbind("mousemove.drag_canvas"),$(document).unbind("mouseup.drag_canvas")})})},moveShape:function(e,n,t){for(var i=[],o=0;o<e.length;o++){var s=e[o];i.push(s.id)}for(var r=Utils.restoreScale(n),o=0;o<e.length;o++){if("linker"==(s=e[o]).name){var a=s,l=a.from,d=a.to,p=!1,h=!1;if(Utils.isSelected(a.id)?((null==l.id||0<=i.indexOf(l.id))&&(a.from.x+=r.x,a.from.y+=r.y,p=!0),(null==d.id||0<=i.indexOf(d.id))&&(a.to.x+=r.x,a.to.y+=r.y,h=!0)):(null!=l.id&&0<=i.indexOf(l.id)&&(a.from.x+=r.x,a.from.y+=r.y,p=!0),null!=d.id&&0<=i.indexOf(d.id)&&(a.to.x+=r.x,a.to.y+=r.y,h=!0)),p&&h){for(var c=0;c<a.points.length;c++){var u=a.points[c];u.x+=r.x,u.y+=r.y}var g,y=$("#"+s.id);0<y.length&&(g=y.position(),y.css({left:g.left+=n.x,top:g.top+=n.y}))}else(p||h)&&Designer.painter.renderLinker(a,!0);null!=a.textPos&&(a.textPos.x+=r.x,a.textPos.y+=r.y)}else!function(e){e.props.x+=r.x,e.props.y+=r.y;var t=$("#"+e.id);t.css({left:parseFloat(t.css("left"))+n.x,top:parseFloat(t.css("top"))+n.y})}(s),$(".shape_contour[forshape="+s.id+"]").css({left:s.props.x.toScale(),top:s.props.y.toScale()})}var f,x,v,m=Utils.getSelectedLinkerIds();1==e.length&&1==m.length||void 0===t&&(0<m.length?(f=Utils.getSelectedIds(),Designer.painter.drawControls(f)):(x=$("#shape_controls")).css({left:parseFloat(x.css("left"))+n.x,top:parseFloat(x.css("top"))+n.y}),v=$("#shape_controls").position(),Designer.op.showTip("X: "+Math.round(v.left.restoreScale())+"&nbsp;&nbsp;Y: "+Math.round(v.top.restoreScale())))},moveLinker:function(e,t,n,i){var o=null,s=null,r=Utils.getShapeByPosition(n,i,!0);if(Designer.op.hideLinkPoint(),null!=r){var a=r.shape;if(Utils.showAnchors(a),s=a.id,"bounding"==r.type)o=r.linkPoint,Designer.op.showLinkPoint(Utils.toScale(o));else if("shape"==r.type){var l,d="from"==t?(l={x:e.to.x,y:e.to.y},e.to.id):(l={x:e.from.x,y:e.from.y},e.from.id);if(a.id==d)Designer.op.hideLinkPoint(),o={x:n.restoreScale(),y:i.restoreScale(),angle:null},s=null;else{for(var p,h=a.getAnchors(),c=-1,u={x:a.props.x+a.props.w/2,y:a.props.y+a.props.h/2},g=0;g<h.length;g++){var y=h[g],f=Utils.getRotated(u,{x:a.props.x+y.x,y:a.props.y+y.y},a.props.angle),x=Utils.measureDistance(f,l);(-1==c||x<c)&&(c=x,p=f)}var v=Utils.getPointAngle(a.id,p.x,p.y,7),o={x:p.x,y:p.y,angle:v};Designer.op.showLinkPoint(Utils.toScale(o))}}}else{Designer.op.hideLinkPoint(),Utils.hideAnchors();var m=Designer.op.snapLinkerLine(n,i);o={x:m.x.restoreScale(),y:m.y.restoreScale(),angle:null},s=null}if("from"==t){if(e.from.id=s,e.from.x=o.x,e.from.y=o.y,e.from.angle=o.angle,null==s&&(o.x>=e.to.x-6&&o.x<=e.to.x+6&&(e.from.x=e.to.x),o.y>=e.to.y-6&&o.y<=e.to.y+6&&(e.from.y=e.to.y),e.from.x==e.to.x&&e.from.y==e.to.y))return}else if(e.to.x=o.x,e.to.y=o.y,e.to.id=s,e.to.angle=o.angle,null==s&&(o.x>=e.from.x-6&&o.x<=e.from.x+6&&(e.to.x=e.from.x),o.y>=e.from.y-6&&o.y<=e.from.y+6&&(e.to.y=e.from.y),e.from.x==e.to.x&&e.from.y==e.to.y))return;Designer.painter.renderLinker(e,!0)},showLinkPoint:function(e){var t=$("<canvas class='link_point_canvas' width=32 height=32></canvas>").appendTo($("#designer_canvas")),n=t[0].getContext("2d");n.translate(1,1),n.lineWidth=1,n.globalAlpha=.3,n.strokeStyle=Designer.config.anchorColor,n.fillStyle=Designer.config.anchorColor,n.beginPath(),n.moveTo(0,15),n.bezierCurveTo(0,-5,30,-5,30,15),n.bezierCurveTo(30,35,0,35,0,15),n.closePath(),n.fill(),n.stroke(),t.css({left:e.x-16,top:e.y-16,"z-index":Model.orderList.length}).show()},hideLinkPoint:function(){$(".link_point_canvas").hide()},brokenLinkerChangable:function(s,e){var t=$("#canvas_container"),r=$("#designer_canvas"),a=s.points[e-1],l=s.points[e];a.x==l.x?t.css("cursor","e-resize"):t.css("cursor","n-resize"),r.bind("mousedown.brokenLinker",function(e){Designer.op.changeState("changing_broken_linker");var i=Utils.getRelativePos(e.pageX,e.pageY,r),o=Utils.getSelectedIds();t.bind("mousemove.brokenLinker",function(e){var t=Utils.getRelativePos(e.pageX,e.pageY,r),n={x:t.x-i.x,y:t.y-i.y},n=Utils.restoreScale(n);a.x==l.x?(a.x+=n.x,l.x+=n.x):(a.y+=n.y,l.y+=n.y),Designer.painter.renderLinker(s),Designer.op.resetLinkerText(s),Designer.events.push("linkerCreated",s),1<o.length&&Designer.painter.drawControls(o),i=t,$(document).unbind("mouseup.changed").bind("mouseup.changed",function(){Model.update(s),$(document).unbind("mouseup.changed")})}),$(document).bind("mouseup.brokenLinker",function(){Designer.op.resetState(),t.unbind("mousemove.brokenLinker"),r.unbind("mousedown.brokenLinker"),$(document).unbind("mouseup.brokenLinker")})})},resetLinkerText:function(e){var t,n,i,o=$("#"+e.id),s=o.find(".text_canvas"),r=null;null!=e.textPos&&(t=Utils.getLinkerLinesPoints(e),e.textPos.t>t.length&&(e.textPos.t=t.length-1),null!=(r=t[e.textPos.t])&&(e.textPos.x=r.x,e.textPos.y=r.y)),null!=r&&null!=r.x&&(n=o.position(),i=r.y.toScale()-n.top-s.height()/2,null!=e.textPos&&(null!=e.textPos.pos&&"top"==e.textPos.pos?i=i-s.height()/2-6:null!=e.textPos.pos&&"bottom"==e.textPos.pos&&(i+=s.height()/2+6)),s.css({left:r.x.toScale()-n.left-s.width()/2,top:i}))},removeShape:function(){if(0<(t=Utils.getSelected()).length){Utils.unselect();for(var e=Utils.getAttachedShapes(t),t=t.concat(e),n=[],i=0;i<t.length;i++)var o=Utils.getChildrenShapes(t[i]),n=n.concat(o);t=t.concat(n);var s=Utils.getCollapsedShapes(t);t=t.concat(s),Model.remove(t)}},setDefaultStyle:function(){var e=Utils.getSelected();if(1==e.length){var t=e[0];if("standardImage"==t.name||"note"==t.name||"uiNote"==t.name)return"error";if(null!=t.category&&(0<=t.category.indexOf("ios_")||0<=t.category.indexOf("andriod_")))return"error";if(null!=t.category&&0<=t.category.indexOf("network"))return"error";if(null!=t.category&&(0<=t.category.indexOf("aws_")||0<=t.category.indexOf("azure")||0<=t.category.indexOf("aws2019")))return"error";if(null!=t.category&&(0<=t.category.indexOf("ali_")||0<=t.category.indexOf("cisco_")))return"error";var n={},i="shape",n="linker"==t.name?(i="linker",{linkerStyle:Utils.copy(t.lineStyle)}):{lineStyle:Utils.copy(t.lineStyle),fontStyle:Utils.copy(t.fontStyle),fillStyle:Utils.copy(t.fillStyle)};Model.setDefaultStyle(i,n)}},showTip:function(e){var t=$("#designer_op_tip");0==t.length&&(t=$("<div id='designer_op_tip'></div>").appendTo("#designer_canvas")),t.stop().html(e);var n=$("#shape_controls"),i=n.position();t.css({top:i.top+n.height()+5,left:i.left+n.width()/2-t.outerWidth()/2,"z-index":Model.orderList.length}).show()},hideTip:function(){$("#designer_op_tip").fadeOut(100)},snapLine:function(e,t,n,i){var o=e.y,s=e.y+e.h/2,r=e.y+e.h,a=e.x,l=e.x+e.w/2,d=e.x+e.w,p={v:null,h:null,attach:null,container:null},h=null,h=n?i:Model.getShapeById(t[0]);if(1==t.length&&"boundaryEvent"==h.groupName)for(var c=Model.orderList.length-1;0<=c;c--){var u,g,y,f=Model.orderList[c].id;(x=Model.getShapeById(f)).attribute&&x.attribute.collapseBy||"linker"!=x.name&&x.id!=h.id&&(M=x.props,null!=p.attach||0!=M.angle||"task"!=x.groupName&&"callActivity"!=x.groupName&&"subProcess"!=x.groupName||(u={x:M.x-2,y:M.y-2,w:M.w+4,h:M.h+4},Utils.pointInRect(l,s,u)&&(v=M.y,S=M.y+M.h,w=M.x,k=M.x+M.w,y=g=!1,s-2<=v&&v<=s+2?(e.y=v-e.h/2,y=!0):s-2<=S&&S<=s+2&&(e.y=S-e.h/2,y=!0),l-2<=w&&w<=l+2?(e.x=w-e.w/2,g=!0):l-2<=k&&k<=l+2&&(e.x=k-e.w/2,g=!0),(g||y)&&(p.attach=x))))}if(null==p.attach)for(c=Model.orderList.length-1;0<=c;c--){var x,f=Model.orderList[c].id;if((!(x=Model.getShapeById(f)).attribute||!x.attribute.collapseBy)&&!("linker"==x.name||0<=t.indexOf(f)||x.parent)){var v,m,S,w,b,k,M=x.props;if(null==p.h&&(v=M.y,m=M.y+M.h/2,S=M.y+M.h,s-2<=m&&m<=s+2?(p.h={type:"middle",y:m},e.y=m-e.h/2):o-2<=v&&v<=o+2?(p.h={type:"top",y:v},e.y=v):r-2<=S&&S<=r+2?(p.h={type:"bottom",y:S},e.y=S-e.h):o-2<=S&&S<=o+2?(p.h={type:"top",y:S},e.y=S):r-2<=v&&v<=r+2&&(p.h={type:"bottom",y:v},e.y=v-e.h)),null==p.v&&(w=M.x,b=M.x+M.w/2,k=M.x+M.w,l-2<=b&&b<=l+2?(p.v={type:"center",x:b},e.x=b-e.w/2):a-2<=w&&w<=a+2?(p.v={type:"left",x:w},e.x=w):d-2<=k&&k<=d+2?(p.v={type:"right",x:k},e.x=k-e.w):a-2<=k&&k<=a+2?(p.v={type:"left",x:k},e.x=k):d-2<=w&&w<=d+2&&(p.v={type:"right",x:w},e.x=w-e.w)),null==p.container&&x.attribute&&x.attribute.container&&Utils.rectInRect(e,x.props)&&(p.container=x),null!=p.h&&null!=p.v&&null!=p.container)break}}this.hideSnapLine();var _,D,I,U,C,P=$("#designer_canvas");return null==p.attach&&null==p.container||(0==(_=$("#designer_op_snapline_attach")).length&&(_=$("<div id='designer_op_snapline_attach'></div>").appendTo(P)),D=p.attach||p.container,I=Utils.getShapeLineStyle(D.lineStyle).lineWidth,_.css({width:(D.props.w+I).toScale(),height:(D.props.h+I).toScale(),left:(D.props.x-I/2).toScale()-2,top:(D.props.y-I/2).toScale()-2,"z-index":$("#"+D.id).css("z-index")}).show()),null!=p.h&&(0==(U=$("#designer_op_snapline_h")).length&&(U=$("<div id='designer_op_snapline_h'></div>").appendTo(P)),U.css({width:P.width()+2*Designer.config.pageMargin,left:-Designer.config.pageMargin,top:Math.round(p.h.y.toScale()),"z-index":Model.orderList.length+1}).show()),null!=p.v&&(0==(C=$("#designer_op_snapline_v")).length&&(C=$("<div id='designer_op_snapline_v'></div>").appendTo(P)),C.css({height:P.height()+2*Designer.config.pageMargin,top:-Designer.config.pageMargin,left:Math.round(p.v.x.toScale()),"z-index":Model.orderList.length+1}).show()),p},snapLinkerLine:function(e,t){for(var n={v:null,h:null},i=Model.orderList.length-1;0<=i;i--){var o=Model.orderList[i].id,s=Model.getShapeById(o);if((!s.attribute||!s.attribute.collapseBy)&&("linker"!=s.name&&!s.parent)){var r,a,l,d,p=s.props;if(null==n.h&&(r=p.y,a=p.y+p.h,t-2<=r&&r<=t+2?n.h=r:t-2<=a&&a<=t+2&&(n.h=a)),null==n.v&&(l=p.x,d=p.x+p.w,e-2<=l&&l<=e+2?n.v=l:e-2<=d&&d<=e+2&&(n.v=d)),null!=n.h&&null!=n.v)break}}this.hideSnapLine();var h,c,u=$("#designer_canvas");null!=n.h&&(0==(h=$("#designer_op_snapline_h")).length&&(h=$("<div id='designer_op_snapline_h'></div>").appendTo(u)),h.css({width:u.width()+2*Designer.config.pageMargin,left:-Designer.config.pageMargin,top:Math.round(n.h.toScale()),"z-index":Model.orderList.length+1}).show()),null!=n.v&&(0==(c=$("#designer_op_snapline_v")).length&&(c=$("<div id='designer_op_snapline_v'></div>").appendTo(u)),c.css({height:u.height()+2*Designer.config.pageMargin,top:-Designer.config.pageMargin,left:Math.round(n.v.toScale()),"z-index":Model.orderList.length+1}).show());var g={x:e,y:t};return null!=n.h&&(g.y=n.h),null!=n.v&&(g.x=n.v),g},snapResizeLine:function(e,t,n){for(var i=e.y,o=e.y+e.h/2,s=e.y+e.h,r=e.x,a=e.x+e.w/2,l=e.x+e.w,d={v:null,h:null},p=Model.orderList.length-1;0<=p;p--){var h=Model.orderList[p].id,c=Model.getShapeById(h);if((!c.attribute||!c.attribute.collapseBy)&&!("linker"==c.name||0<=t.indexOf(h)||c.parent)){var u,g,y,f,x,v,m=c.props;if(null==d.h&&(0<=n.indexOf("t")||0<=n.indexOf("b"))&&(u=m.y,g=m.y+m.h/2,y=m.y+m.h,o-2<=g&&g<=o+2?(d.h={type:"middle",y:g},0<=n.indexOf("t")?(e.h=2*(s-g),e.y=s-e.h):e.h=2*(g-e.y)):0<=n.indexOf("t")&&i-2<=u&&u<=i+2?(d.h={type:"top",y:u},e.y=u,e.h=s-u):0<=n.indexOf("b")&&s-2<=y&&y<=s+2?(d.h={type:"bottom",y:y},e.h=y-i):0<=n.indexOf("t")&&i-2<=y&&y<=i+2?(d.h={type:"top",y:y},e.y=y,e.h=s-y):0<=n.indexOf("b")&&s-2<=u&&u<=s+2&&(d.h={type:"bottom",y:u},e.h=u-e.y)),null==d.v&&(0<=n.indexOf("l")||0<=n.indexOf("r"))&&(f=m.x,x=m.x+m.w/2,v=m.x+m.w,a-2<=x&&x<=a+2?(d.v={type:"center",x:x},0<=n.indexOf("l")?(e.w=2*(l-x),e.x=l-e.w):e.w=2*(x-e.x)):0<=n.indexOf("l")&&r-2<=f&&f<=r+2?(d.v={type:"left",x:f},e.x=f,e.w=l-f):0<=n.indexOf("r")&&l-2<=v&&v<=l+2?(d.v={type:"right",x:v},e.w=v-e.x):0<=n.indexOf("l")&&r-2<=v&&v<=r+2?(d.v={type:"left",x:v},e.x=v,e.w=l-v):0<=n.indexOf("r")&&l-2<=f&&f<=l+2&&(d.v={type:"right",x:f},e.w=f-e.x)),null!=d.h&&null!=d.v)break}}this.hideSnapLine();var S,w,b=$("#designer_canvas");return null!=d.h&&(0==(S=$("#designer_op_snapline_h")).length&&(S=$("<div id='designer_op_snapline_h'></div>").appendTo(b)),S.css({width:b.width()+2*Designer.config.pageMargin,left:-Designer.config.pageMargin,top:Math.round(d.h.y.toScale()),"z-index":Model.orderList.length+1}).show()),null!=d.v&&(0==(w=$("#designer_op_snapline_v")).length&&(w=$("<div id='designer_op_snapline_v'></div>").appendTo(b)),w.css({height:b.height()+2*Designer.config.pageMargin,top:-Designer.config.pageMargin,left:Math.round(d.v.x.toScale()),"z-index":Model.orderList.length+1}).show()),d},hideSnapLine:function(){$("#designer_op_snapline_h").hide(),$("#designer_op_snapline_v").hide(),$("#designer_op_snapline_attach").hide()},linkDashboard:function(v){var e=0,t=0,n=null,i="string"!=typeof v,t=i?(n=Model.getShapeById(v.from.id),e=v.to.x.toScale(),v.to.y.toScale()):(e=(n=Model.getShapeById(v)).props.x.toScale()+n.props.w,n.props.y.toScale()),o=n.category;if(0!=$("#panel_"+o).length){var r=$("#shape_dashboard_"+o);if(0==r.length){function s(e,t){var n="<div class='dashboard_box' shapeName='"+e.name+"'><canvas title='"+e.title+"' title_pos='right' class='panel_item' width='"+Designer.config.panelItemWidth+"' height='"+Designer.config.panelItemHeight+"'></canvas></div>",i=$(n).appendTo(r);t&&i.append("<div class='group_icon link_shape_icon' group='"+t+"'></div>");var o=i.children()[0];Designer.painter.drawPanelItem(o,e.name)}for(var a in r=$("<div id='shape_dashboard_"+o+"' class='shape_dashboard menu'></div>").appendTo("#designer_canvas"),Schema.shapes){var l,d=Schema.shapes[a];d.category!=o||(l=d.attribute).visible&&l.linkable&&(d.groupName?SchemaGroup.getGroup(d.groupName)[0]==d.name&&s(d,d.groupName):s(d))}r.bind("mousemove",function(e){e.stopPropagation()}).bind("mousedown",function(e){e.stopPropagation()})}function p(e){if("over"!=Utils.vip.checkPrivilege("shapeCount")){var t,n=Schema.shapes[e],i=Utils.getEndpointAngle(v,"to"),o=Utils.getAngleDir(i),s=n.getAnchors();if(1==o)for(var r=null,a=0;a<s.length;a++){var l=s[a];(null==r||l.y<r)&&(r=l.y,t=l)}else if(2==o)for(var d=null,a=0;a<s.length;a++){l=s[a];(null==d||l.x>d)&&(d=l.x,t=l)}else if(3==o)for(var p=null,a=0;a<s.length;a++){l=s[a];(null==p||l.y>p)&&(p=l.y,t=l)}else if(4==o)for(var h=null,a=0;a<s.length;a++){l=s[a];(null==h||l.x<h)&&(h=l.x,t=l)}var c=Model.create(e,v.to.x-t.x,v.to.y-t.y);Designer.painter.renderShape(c),MessageSource.beginBatch(),c.onCreated&&c.onCreated();var u=c.props,g=Designer.op.snapLine(u,[c.id],!0,c);g.container&&(c.container=g.container.id),Designer.events.push("created",c),Model.add(c);var y=Utils.getPointAngle(c.id,v.to.x,v.to.y,7);v.to.id=c.id,v.to.angle=y,Designer.painter.renderLinker(v,!0),Model.update(v),MessageSource.commit(),Utils.unselect(),Utils.selectShape(c.id),Designer.op.editShapeText(c),Designer.op.hideSnapLine();var f=c.props.w,x=c.props.h;Designer.op.changeCanvas([c],f,x),Designer.events.push("linkerCreated",v)}}r.css({left:e,top:t,"z-index":Model.orderList.length}).show(),r.find(".link_shape_icon").unbind().bind("mousedown",function(e){e.stopPropagation();var t=$(this).attr("group"),n=$(this).parent().position(),i=r.position(),o=n.left+i.left+$(this).parent().outerWidth()-10,s=n.top+i.top+$(this).parent().outerHeight();Designer.op.groupDashboard(t,o,s,function(e){p(e),r.hide(),$(document).unbind("mousedown.dashboard")})}).bind("click",function(e){e.stopPropagation()}),r.children(".dashboard_box").unbind().bind("click",function(){r.hide(),$(document).unbind("mousedown.dashboard");var e=$(this).attr("shapeName");i?p(e):Designer.op.shapeReplace(e,v),0<$("#hover_tip").length&&$("#hover_tip").remove()}),$(document).bind("mousedown.dashboard",function(){r.hide(),$(document).unbind("mousedown.dashboard")})}},groupDashboard:function(e,t,n,i){$(".group_dashboard").hide();var o=$("#shape_group_dashboard_"+e);if(0==o.length){o=$("<div id='shape_group_dashboard_"+e+"' class='group_dashboard menu'></div>").appendTo("#designer_canvas");for(var s=SchemaGroup.getGroup(e),r=0;r<s.length;r++){var a,l=s[r],d=Schema.shapes[l];d.attribute.visible&&(a=$("<div class='dashboard_box' shapeName='"+l+"'><canvas title='"+d.title+"' title_pos='right' width='"+Designer.config.panelItemWidth+"' height='"+Designer.config.panelItemHeight+"'></canvas></div>").appendTo(o).children("canvas")[0],Designer.painter.drawPanelItem(a,d.name))}o.bind("mousedown",function(e){e.stopPropagation()})}return o.css({left:t,top:n,"z-index":Model.orderList.length+1}).show(),$(".dashboard_box").unbind().bind("click",function(){var e=$(this).attr("shapeName");i(e),o.hide(),$(document).unbind("mousedown.group_dashboard")}),$(document).bind("mousedown.group_dashboard",function(){o.hide(),$(document).unbind("mousedown.group_dashboard")}),o},showPanelGroup:function(e,t,n){t.stopPropagation();var i=$("#group_dashboard_"+e);if($(".group_dashboard").hide(),0==i.length){i=$("<div id='group_dashboard_"+e+"' class='group_dashboard menu'></div>").appendTo("#designer");for(var o=SchemaGroup.getGroup(e),s=0;s<o.length;s++){var r,a=o[s],l=Schema.shapes[a];l.attribute.visible&&(r=$("<div class='panel_box' shapeName='"+a+"'><canvas title='"+l.title+"' title_pos='right' width='"+Designer.config.panelItemWidth+"' height='"+Designer.config.panelItemHeight+"'></canvas></div>").appendTo(i).children("canvas")[0],Designer.painter.drawPanelItem(r,l.name))}i.css("position","fixed")}var d=$(n).parent(),p=d.offset();i.show();var h=p.top+d.outerHeight()-2;h+i.outerHeight()>$(window).height()&&(h=$(window).height()-i.outerHeight()),i.css({left:p.left-5,top:h}),$(document).bind("mousedown.group_board",function(){i.hide(),$(document).unbind("mousedown.group_board")})},changeShapeProps:function(l,d){function e(e){var t,n,i,o,s,r,a;void 0!==d.x&&(e.x+=d.x-l.props.x),void 0!==d.y&&(e.y+=d.y-l.props.y),void 0===d.w&&void 0===d.h&&void 0===d.angle||(t=$.extend({},l.props,d),n={x:l.props.x+l.props.w/2,y:l.props.y+l.props.h/2},i=Utils.getRotated(n,e,-l.props.angle),o=l.props.w,s=l.props.h,void 0!==d.w?(e.x=l.props.x+(i.x-l.props.x)/l.props.w*d.w,o=d.w):e.x=i.x,void 0!==d.h?(e.y=l.props.y+(i.y-l.props.y)/l.props.h*d.h,s=d.h):e.y=i.y,r={x:l.props.x+o/2,y:l.props.y+s/2},a=Utils.getRotated(r,e,t.angle),e.x=a.x,e.y=a.y),void 0!==d.angle&&(e.angle+=d.angle-l.props.angle)}var t=[],n=Model.getShapeLinkers(l.id);if(n&&0<n.length){for(var i=0;i<n.length;i++){var o=n[i],s=Model.getShapeById(o);l.id==s.from.id&&e(s.from),l.id==s.to.id&&e(s.to)}t=n}return $.extend(l.props,d),Designer.painter.renderShape(l),Utils.showLinkerCursor(),UI.showShapeOptions(),t},googleImgCallback:function(e){for(var t=e.responseData.results,n=0;n<t.length;n++){var i=t[n];UI.appendGoogleImage(i)}$("#google_image_items").append("<div style='clear: both'></div>"),$(".img_gg_loading_tip").remove(),$(".gg_img_more").remove(),this.searchIndex<=3&&$("#google_image_items").append("<div onclick='UI.loadGoogleImg()' class='gg_img_more toolbar_button active'><@i18n resource='diagraming.selectimage.showmore'/></div>")},scrollStv:null,scrollIsOver:!1,scrollLayout:null,scrollPos:{},initScrollPos:function(){var e=$("#designer");this.scrollLayout=$("#designer_layout"),this.scrollPos.b=e.height()+e.offset().top-30,this.scrollPos.t=e.offset().top+20,this.scrollPos.l=e.find("#shape_panel").width()+20,this.scrollPos.r=e.width()-20},isScroll:function(e,t){var n=this;e<n.scrollPos.l?n.startScroll("l"):e>n.scrollPos.r?n.startScroll("r"):t<n.scrollPos.t?n.startScroll("t"):t>n.scrollPos.b?n.startScroll("b"):n.scrollIsOver&&n.stopScroll()},stopScroll:function(){window.clearInterval(this.scrollStv),this.scrollStv=null,this.scrollIsOver=!1},startScroll:function(e){var t=this;t.scrollIsOver||(t.scrollIsOver=!0,t.scrollStv=setInterval(function(){t.scrolling(e)},20))},scrolling:function(e){var t=this.scrollLayout;switch(e){case"t":t.scrollTop(t.scrollTop()-5);break;case"b":t.scrollTop(t.scrollTop()+5);break;case"l":t.scrollLeft(t.scrollLeft()-5);break;case"r":t.scrollLeft(t.scrollLeft()+5)}},uploading:!1,uploadImage:function(e,t){var n,i=this;i.uploading||(i.uploading=!0,(n=new FormData).append("image",e),n.append("fileID",file_id),n.append("type","flowchart"),n.append("scene",scene),$.ajax({url:"https://docs.qq.com/cooperation/v1/images",type:"post",crossDomain:!0,xhrFields:{"Access-Control-Allow-Origin":"*",withCredentials:!0},headers:{"Client-Id":client_id,"Access-Token":encrypted_session,"Open-Id":tdoc_user_id},data:n,processData:!1,contentType:!1,success:function(e){i.uploading=!1,null!=t&&(e=JSON.parse(e),t(e))},error:function(){i.uploading=!1}}))},changeCanvas:function(e,t,n){var i,o,s,r;"portrait"==Model.define.page.orientation&&(i=Model.define.page.width,o=Model.define.page.height,s=e[0].props.x,r=e[0].props.y,i<s+t&&Designer.setPageStyle({width:Math.floor(s+t)+30}),o<r+n&&Designer.setPageStyle({height:Math.floor(r+n)+30}))},showShapesLen:function(){var e=$(".footer-left-con"),t=this.getShapesLen();selects=Utils.getSelected().length,selects&&0<selects&&(t=selects+"/"+this.getShapesLen());var n=e.find("#shapes-count-con");0==n.length&&(n=$('<div id="shapes-count-con" class="shapes-count-con"><span class="shapes-count"></span> 个图形</div>').appendTo(e)),n.find(".shapes-count").html(t)},getShapesLen:function(){return Object.keys(Model.define.elements).length}},events:{push:function(e,t){var n=this.listeners[e];return n?n(t):null},listeners:{},addEventListener:function(e,t){this.listeners[e]=t}},clipboard:{elements:[],presetedIds:{},presetIds:function(){this.presetedIds={};for(var e=0;e<this.elements.length;e++){var t=this.elements[e];this.presetedIds[t.id]=Utils.newId(),t.group&&!this.presetedIds[t.group]&&(this.presetedIds[t.group]=Utils.newId())}localStorage.presetedIds=JSON.stringify(this.presetedIds)},plus:!0,copy:function(){this.elements=[];var e=Utils.getSelected(),t=Utils.getFamilyShapes(e);(e=e.concat(t)).sort(function(e,t){return e.props.zindex-t.props.zindex});for(var n=0;n<e.length;n++){var i=Utils.copy(e[n]);"linker"==i.name&&(null!=i.from.id&&(Utils.isSelected(i.from.id)||(i.from.id=null,i.from.angle=null)),null!=i.to.id&&(Utils.isSelected(i.to.id)||(i.to.id=null,i.to.angle=null))),this.elements.push(i)}this.elements.sort(function(e,t){return e.props.zindex-t.props.zindex}),this.presetIds(),this.plus=!0,Designer.events.push("clipboardChanged",this.elements.length),localStorage.clipboard=JSON.stringify(this.elements),localStorage.clientId=CLB.clientId},cut:function(){this.copy(),Designer.op.removeShape(),this.plus=!1},paste:function(e,t){if(localStorage.clipboard){var n=JSON.parse(localStorage.clipboard),i=localStorage.clientId;if(CLB.clientId!=i){this.elements=n;for(var o,s=0;s<this.elements.length;s++){"linker"!=(m=this.elements[s]).name&&Schema.initShapeFunctions(m)}this.presetedIds=JSON.parse(localStorage.presetedIds),void 0===e&&(o=$("#designer_layout").scrollTop()-Designer.config.pageMargin+$("#designer_layout").height().restoreScale()/2,e=$("#designer_layout").scrollLeft()-Designer.config.pageMargin+$("#designer_layout").width().restoreScale()/2,t=o)}}if(0!=this.elements.length&&"over"!=Utils.vip.checkPrivilege("shapeCount")){var r,a=20,l=20;void 0!==e&&(a=e-(r=Utils.getShapesBounding(this.elements)).x-r.w/2,l=t-r.y-r.h/2);for(var d=[],p=[],s=0;s<this.elements.length;s++){if("linker"!=(m=this.elements[s]).name){(m=this.elements[s]).props.zindex=Model.maxZIndex+(s+1);var h=this.presetedIds[m.id];!this.plus&&void 0===e||(m.props.x+=a,m.props.y+=l),y=Utils.copy(m);for(var c=0;c<y.dataAttributes.length;c++){y.dataAttributes[c].id=Utils.newId()}if(y.id=h,y.children)for(var u=0;u<y.children.length;u++){var g=y.children[u];y.children[u]=this.presetedIds[g]}y.parent&&(y.parent=this.presetedIds[y.parent]),d.push(y),p.push(h),m.group&&(v=this.presetedIds[m.group],y.group=v)}}for(var y,s=0;s<this.elements.length;s++){if("linker"==(m=this.elements[s]).name){m.props.zindex=Model.maxZIndex+(s+1);h=this.presetedIds[m.id];if(this.plus||void 0!==e){m.from.x+=a,m.from.y+=l,m.to.x+=a,m.to.y+=l;for(var f=0;f<m.points.length;f++){var x=m.points[f];x.x+=a,x.y+=l}}(y=Utils.copy(m)).dataAttributes||(y.dataAttributes=[]);for(var v,c=0;c<y.dataAttributes.length;c++){y.dataAttributes[c].id=Utils.newId()}null!=m.from.id&&(y.from.id=this.presetedIds[m.from.id]),null!=m.to.id&&(y.to.id=this.presetedIds[m.to.id]),y.id=h,d.push(y),p.push(h),m.group&&(v=this.presetedIds[m.group],y.group=v)}}Model.addMulti(d);for(s=0;s<d.length;s++){var m=d[s];Designer.painter.renderShape(m)}Model.build(),this.presetIds(),Utils.unselect(),Utils.selectShape(p),this.plus=!0}},duplicate:function(){this.copy(),this.paste()},brush:function(){var e=Utils.getSelected();if(0!=e.length){for(var i={fontStyle:{},lineStyle:{},fillStyle:null,shapeStyle:null},t=0;t<e.length;t++){var n=e[t];"linker"==n.name?($.extend(i.lineStyle,n.lineStyle),$.extend(i.fontStyle,n.fontStyle)):(null==i.fillStyle&&(i.fillStyle={}),null==i.shapeStyle&&(i.shapeStyle={}),$.extend(i.lineStyle,n.lineStyle),$.extend(i.fontStyle,n.fontStyle),$.extend(i.shapeStyle,n.shapeStyle),$.extend(i.fillStyle,n.fillStyle))}delete i.fontStyle.orientation,$("#bar_brush").button("select"),UI.showTip("<@i18n resource='diagraming.brush.help'/>","left",function(){$("#bar_brush").button("unselect"),$(document).unbind("keydown.cancelbrush"),Utils.selectCallback=null,$("#bar_brush").button("disable")}),$(document).unbind("keydown.cancelbrush").bind("keydown.cancelbrush",function(e){27==e.keyCode&&(UI.hideTip(),$("#bar_brush").button("unselect"),$(document).unbind("keydown.cancelbrush"),Utils.selectCallback=null,$("#bar_brush").button("disable"))}),Utils.selectCallback=function(){for(var e=Utils.getSelected(),t=0;t<e.length;t++){var n=e[t];$.extend(n.lineStyle,i.lineStyle),$.extend(n.fontStyle,i.fontStyle),"linker"!=n.name?(n.lineStyle=i.lineStyle,delete n.lineStyle.beginArrowStyle,delete n.lineStyle.endArrowStyle,null!=i.fillStyle&&(n.fillStyle=i.fillStyle),null!=i.shapeStyle&&(n.shapeStyle=i.shapeStyle)):n.fontStyle&&delete n.fontStyle.vAlign,Designer.painter.renderShape(n)}Model.updateMulti(e)}}}},addFunction:function(e,t){if(Designer[e])throw"Duplicate function name!";this[e]=t},painter:{actions:{move:function(e){this.moveTo(e.x,e.y),this.prePoint=e,null==this.beginPoint&&(this.beginPoint=e)},line:function(e){if(void 0!==this.webkitLineDash&&void 0===this.lineDashOffset&&0!=this.lineWidth){for(var t=this.webkitLineDash,n=this.prePoint,i=0,o=1/Utils.measureDistance(n,e),s=n,r=0,a=!0;i<1;){1<(i+=o)&&(i=1);var l={x:(1-i)*n.x+i*e.x,y:(1-i)*n.y+i*e.y};(Utils.measureDistance(s,l)>=t[r]||1<=i)&&(a?this.lineTo(l.x,l.y):this.moveTo(l.x,l.y),a=!a,s=l,++r>=t.length&&(r=0))}this.moveTo(e.x,e.y)}else this.lineTo(e.x,e.y);this.prePoint=e,null==this.beginPoint&&(this.beginPoint=e)},curve:function(e){if(void 0!==this.webkitLineDash&&void 0===this.lineDashOffset&&0!=this.lineWidth){for(var t=this.webkitLineDash,n=this.prePoint,i=0,o=1/Utils.measureDistance(n,e),s=n,r=0,a=!0,l=0;i<1;){1<(i+=o)&&(i=1);var d,p,h={x:n.x*Math.pow(1-i,3)+e.x1*i*Math.pow(1-i,2)*3+e.x2*Math.pow(i,2)*(1-i)*3+e.x*Math.pow(i,3),y:n.y*Math.pow(1-i,3)+e.y1*i*Math.pow(1-i,2)*3+e.y2*Math.pow(i,2)*(1-i)*3+e.y*Math.pow(i,3)};(Utils.measureDistance(s,h)>=t[r]||1<=i)&&(a?(d=l+(i-l)/2,p={x:n.x*Math.pow(1-d,3)+e.x1*d*Math.pow(1-d,2)*3+e.x2*Math.pow(d,2)*(1-d)*3+e.x*Math.pow(d,3),y:n.y*Math.pow(1-d,3)+e.y1*d*Math.pow(1-d,2)*3+e.y2*Math.pow(d,2)*(1-d)*3+e.y*Math.pow(d,3)},this.lineTo(p.x,p.y),this.lineTo(h.x,h.y)):this.moveTo(h.x,h.y),a=!a,s=h,l=i,++r>=t.length&&(r=0))}this.moveTo(e.x,e.y)}else this.bezierCurveTo(e.x1,e.y1,e.x2,e.y2,e.x,e.y);this.prePoint=e,null==this.beginPoint&&(this.beginPoint=e)},quadraticCurve:function(e){if(void 0!==this.webkitLineDash&&void 0===this.lineDashOffset&&0!=this.lineWidth){for(var t=this.webkitLineDash,n=this.prePoint,i=0,o=1/Utils.measureDistance(n,e),s=n,r=0,a=!0,l=0;i<1;){1<(i+=o)&&(i=1);var d,p,h={x:n.x*Math.pow(1-i,2)+e.x1*i*(1-i)*2+e.x*Math.pow(i,2),y:n.y*Math.pow(1-i,2)+e.y1*i*(1-i)*2+e.y*Math.pow(i,2)};(Utils.measureDistance(s,h)>=t[r]||1<=i)&&(a?(d=l+(i-l)/2,p={x:n.x*Math.pow(1-d,2)+e.x1*d*(1-d)*2+e.x*Math.pow(d,2),y:n.y*Math.pow(1-d,2)+e.y1*d*(1-d)*2+e.y*Math.pow(d,2)},this.lineTo(p.x,p.y),this.lineTo(h.x,h.y)):this.moveTo(h.x,h.y),a=!a,s=h,l=i,++r>=t.length&&(r=0))}this.moveTo(e.x,e.y)}else this.quadraticCurveTo(e.x1,e.y1,e.x,e.y);this.prePoint=e,null==this.beginPoint&&(this.beginPoint=e)},close:function(){if(void 0!==this.webkitLineDash&&void 0===this.lineDashOffset&&0!=this.lineWidth)for(var e=this.webkitLineDash,t=this.prePoint,n=this.beginPoint,i=0,o=1/Utils.measureDistance(t,n),s=t,r=0,a=!0;i<1;){1<(i+=o)&&(i=1);var l={x:(1-i)*t.x+i*n.x,y:(1-i)*t.y+i*n.y};(Utils.measureDistance(s,l)>=e[r]||1<=i)&&(a?this.lineTo(l.x,l.y):this.moveTo(l.x,l.y),a=!a,s=l,++r>=e.length&&(r=0))}this.closePath()}},setLineDash:function(e,t){e.setLineDash||(e.setLineDash=function(){}),e.setLineDash(t),e.mozDash=t,e.webkitLineDash=t},renderShapePath:function(e,t,n,i){var o=n&&t.drawIcon?t.drawIcon(t.props.w,t.props.h):t.getPath();this.renderPath(e,t,o,n,i)},renderPath:function(e,t,n,i,o){for(var s=Utils.getShapeFillStyle(t.fillStyle,!i),r=Utils.getShapeLineStyle(t.lineStyle,!i),a=0;a<n.length;a++){var l=n[a];e.save();var d=$.extend({},r,l.lineStyle),p=$.extend({},s,l.fillStyle),h=!1;if("solid"!=d.lineStyle&&void 0===e.lineDashOffset&&"none"!=p.type&&(h=!0),h){e.save(),e.beginPath(),e.lineWidth=0,delete e.webkitLineDash;for(var c=0;c<l.actions.length;c++){var u=l.actions[c];this.actions[u.action].call(e,u)}this.fillShape(t,e,p,o),e.restore()}e.beginPath(),e.beginPoint=null,d.lineWidth?(e.lineWidth=d.lineWidth,"dashed"==d.lineStyle?i?this.setLineDash(e,[3*d.lineWidth,+d.lineWidth]):this.setLineDash(e,[5*d.lineWidth,2*d.lineWidth]):"dot"==d.lineStyle?this.setLineDash(e,[d.lineWidth,1.5*d.lineWidth]):"dashdot"==d.lineStyle?this.setLineDash(e,[5*d.lineWidth,2*d.lineWidth,d.lineWidth,2*d.lineWidth]):delete e.webkitLineDash):(e.lineWidth=0,delete e.webkitLineDash);for(c=0;c<l.actions.length;c++){u=l.actions[c];1==d.lineWidth&&(u.x+=.5,u.y+=.5),this.actions[u.action].call(e,u)}0==h&&this.fillShape(t,e,p,o),d.lineWidth&&(e.lineWidth=d.lineWidth,e.strokeStyle="rgb("+d.lineColor+")",e.stroke()),e.restore()}},drawImage:function(e,t){var n=$(".shape_img[src='"+t.image+"']");0==n.length?((n=$("<img class='shape_img' loaded='0' src=''/>").appendTo("#shape_img_container")).bind("load.drawshape",function(){e.drawImage(n[0],t.x,t.y,t.w,t.h),$(this).attr("loaded","1")}),n.attr("src",t.image)):"0"==n.attr("loaded")?n.bind("load.drawshape",function(){e.drawImage(n[0],t.x,t.y,t.w,t.h)}):e.drawImage(n[0],t.x,t.y,t.w,t.h)},drawPanelItem:function(e,t){var n=e.getContext("2d"),i=Utils.copy(Schema.shapes[t]),o=Designer.config.panelItemWidth,s=Designer.config.panelItemHeight;("ui"==i.category||"ui_input"==i.category||0<=i.category.indexOf("ios_")||0<=i.category.indexOf("andriod_"))&&(s=o=30);var r,a={x:0,y:0,w:i.props.w,h:i.props.h,angle:i.props.angle};n.clearRect(0,0,o,s),(a.w>=o||a.h>=o)&&(r=Utils.getShapeLineStyle(i.lineStyle,!1),i.props.w>=i.props.h?(a.w=o-2*r.lineWidth,a.h=parseInt(i.props.h/i.props.w*a.w)):(a.h=s-2*r.lineWidth,a.w=parseInt(i.props.w/i.props.h*a.h))),i.props=a,n.save(),n.lineJoin="round",n.globalAlpha=i.shapeStyle.alpha;var l=(o-a.w)/2,d=(s-a.h)/2;n.translate(l,d),n.translate(a.w/2,a.h/2),n.rotate(a.angle),n.translate(-a.w/2,-a.h/2),this.renderShapePath(n,i,!0,function(){Designer.painter.drawPanelItem(e,t)}),this.renderMarkers(n,i,!0),n.restore()},renderShape:function(n){if("linker"!=n.name){var e,t,i=$("#"+n.id);0==i.length&&(e=$("#designer_canvas"),i=$("<div id='"+n.id+"' class='shape_box'><canvas class='shape_canvas'></canvas></div>").appendTo(e)),"undefined"!=typeof isView&&n.link&&(-1==(t=n.link).trim().toLowerCase().indexOf("http")&&(t="http://"+t),$("<a title='"+n.link+"' target='_blank' href='"+t+"' class='shape_link'></a>").appendTo(i)),n.attribute&&n.attribute.collapseBy?i.hide():i.show();var o=Utils.isMac(),s=1;o&&(s=2);var r=Utils.getShapeBox(n),a=(r.w+20).toScale(),l=(r.h+20).toScale(),d=i.find(".shape_canvas")[0].getContext("2d");i.find(".shape_canvas").attr({width:a*s,height:l*s}),i.css({left:(r.x-10).toScale()+"px",top:(r.y-10).toScale()+"px",width:a,height:l}),o&&d.scale(s,s),d.clearRect(0,0,n.props.w+20,n.props.h+20),d.scale(Designer.config.scale,Designer.config.scale),d.translate(10,10),d.translate(n.props.x-r.x,n.props.y-r.y),d.translate(n.props.w/2,n.props.h/2),d.rotate(n.props.angle),d.translate(-n.props.w/2,-n.props.h/2),d.globalAlpha=n.shapeStyle.alpha,d.lineJoin="round",this.renderShapePath(d,n,!1,function(){var e=n.id,t=Model.getShapeById(e);Designer.painter.renderShape(t)}),o&&i.find(".shape_canvas").css({width:a+"px",height:l+"px"}),this.renderMarkers(d,n);var p=n.getPath(),h=Utils.copy(p[p.length-1]);h.fillStyle={type:"none"},h.lineStyle={lineWidth:0};var c=[h];if(this.renderPath(d,n,c),this.renderText(n,r),this.renderDataAttributes(n,r),i.children(".shape_comment_ico").remove(),showCommentIco){var u=!1;if(Model.comments&&0<Model.comments.length)for(var g=0;g<Model.comments.length;g++){if(Model.comments[g].shapeId==n.id){u=!0;break}}u&&$("<div class='shape_comment_ico'></div>").appendTo(i).bind("mousedown",function(e){e.stopPropagation(),Dock.showView("comment"),Utils.selectShape(n.id)})}}else this.renderLinker(n)},fillShape:function(l,d,p,e){var t,n,i;d.save(),"none"!=p.type&&void 0!==p.alpha&&(d.globalAlpha=p.alpha),"solid"==p.type?(d.fillStyle="rgb("+p.color+")",d.fill()):"gradient"==p.type?(t="linear"==p.gradientType?GradientHelper.createLinearGradient(l,d,p):GradientHelper.createRadialGradient(l,d,p),d.fillStyle=t,d.fill()):"image"==p.type&&(0<=p.fileId.indexOf("qiniu/")?n=p.fileId.replace(/^qiniu/,"http://7xpicf.com1.z0.glb.clouddn.com"):0==p.fileId.indexOf("http")?0<=(n=p.fileId).indexOf("orgu2a928.bkt.clouddn.com")?n=n.replace("orgu2a928.bkt.clouddn.com","cdn2.processon.com"):0<=n.indexOf("7xt9nt.com1.z0.glb.clouddn.com")?n=n.replace("7xt9nt.com1.z0.glb.clouddn.com","cdn.processon.com"):0<=n.indexOf("p7o7ul1nf.bkt.clouddn.com")&&(n=n.replace("p7o7ul1nf.bkt.clouddn.com","cdn1.processon.com")):(n=0<=p.fileId.indexOf("/images/")?p.fileId:"https://www.processon.com/file/id/"+p.fileId+"/diagram_user_image",localRuntime&&(n="http://localhost:8080"+n)),0==(i=$(".shape_img[src='"+n+"']")).length?((i=$("<img class='shape_img' loaded='0' src=''/>").appendTo("#shape_img_container")).bind("load.drawshape",function(){$(this).attr("loaded","1"),e&&e()}),i.attr("src",n)):"0"==i.attr("loaded")?i.bind("load.drawshape",function(){e&&e()}):function(e){if(d.save(),d.clip(),"fit"==p.display){var t=e.width(),n=e.height(),i=t/n;l.props.w/l.props.h<i?(r=l.props.w,o=0,a=r/i,s=l.props.h/2-a/2):(a=l.props.h,s=0,r=a*i,o=l.props.w/2-r/2),d.drawImage(e[0],o,s,r,a)}else if("stretch"==p.display)d.drawImage(e[0],0,0,l.props.w,l.props.h);else if("original"==p.display){var t=e.width(),n=e.height(),o=l.props.w/2-t/2,s=l.props.h/2-n/2;d.drawImage(e[0],o,s,t,n)}else if("tile"==p.display)for(o=0,t=e.width(),n=e.height();o<l.props.w;){for(s=0;s<l.props.h;)d.drawImage(e[0],o,s,t,n),s+=n;o+=t}else{var r,a;"static"==p.display?(o=0,t=e.width(),n=e.height(),d.drawImage(e[0],p.imageX,p.imageY,t,n)):(t=e.width(),n=e.height(),i=t/n,l.props.w/l.props.h<i?(a=l.props.h,s=0,r=a*i,o=l.props.w/2-r/2):(r=l.props.w,o=0,a=r/i,s=l.props.h/2-a/2),d.drawImage(e[0],o,s,r,a))}d.restore()}(i)),d.restore()},renderText:function(e,t){var n=$("#"+e.id),i=e.getTextBlock();n.find(".text_canvas").remove();for(var o=0;o<i.length;o++){var s,r,a,l,d,p,h,c,u,g,y,f,x,v,m,S=i[o],w=n.find(".text_canvas[ind="+o+"]");0==w.length&&(w=$("<div contenteditable=true spellcheck=false class='text_canvas' forshape='"+e.id+"' ind='"+o+"'></div>").appendTo(n)).bind("focus",function(){$(this).blur()}),w.attr("readonly","readonly"),S.text&&""!=S.text.trim()?(s=Utils.getShapeFontStyle(e.fontStyle),r=(s=$.extend({},s,S.fontStyle)).fontFamily,localRuntime&&Utils.containsChinese(S.text)&&!Utils.containsChinese(r)&&(r="宋体"),a={"line-height":Math.round(1.25*s.size)+"px","font-size":s.size+"px","font-family":r,"font-weight":s.bold?"bold":"normal","font-style":s.italic?"italic":"normal","text-align":s.textAlign,color:"rgb("+s.color+")","text-decoration":s.underline?"underline":"none",opacity:e.shapeStyle.alpha,"word-wrap":"break-word"},w.css(a),w.show(),p=S.position,"horizontal"==s.orientation&&(l=p.x+p.w/2,d=p.y+p.h/2,p={x:l-p.h/2,y:d-p.w/2,w:p.h,h:p.w}),w.css({width:p.w}),h=S.text.replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;").replace(/\  /g,"&nbsp;&nbsp;"),Model.define.page.richText,w.html(h),c=w.height(),u=0,u="middle"==s.vAlign?p.y+p.h/2-c/2:"bottom"==s.vAlign?p.y+p.h-c:p.y,f={x:p.x+p.w/2,y:u+c/2},0!=(g=e.props.angle)&&(y={x:e.props.w/2,y:e.props.h/2},f=Utils.getRotated(y,f,g)),"horizontal"==s.orientation&&(g=(1.5*Math.PI+g)%(2*Math.PI)),x="rotate("+Math.round(g/(2*Math.PI)*360)+"deg) scale("+Designer.config.scale+")",v=p.w,m=c,w.css({width:v,height:Utils.isFirefox()?m+1:m,left:(f.x+(e.props.x-t.x)+10).toScale()-p.w/2,top:(f.y+(e.props.y-t.y)+10).toScale()-c/2,"-webkit-transform":x,"-ms-transform":x,"-o-transform":x,"-moz-transform":x,transform:x})):w.css({height:"0px",width:"0px"}).hide()}},renderText1:function(e,t){var n=$("#"+e.id),i=e.getTextBlock();n.find(".text_canvas").remove();for(var o=0;o<i.length;o++){var s,r,a,l,d,p,h,c,u,g,y,f,x,v=i[o],m=n.find(".text_canvas[ind="+o+"]");0==m.length&&(m=$("<textarea class='text_canvas' forshape='"+e.id+"' ind='"+o+"'></textarea>").appendTo(n)).bind("focus",function(){$(this).blur()}),m.attr("readonly","readonly"),v.text&&""!=v.text.trim()?(s=Utils.getShapeFontStyle(e.fontStyle),r=(s=$.extend({},s,v.fontStyle)).fontFamily,localRuntime&&Utils.containsChinese(v.text)&&!Utils.containsChinese(r)&&(r="宋体"),a={"line-height":Math.round(1.25*s.size)+"px","font-size":s.size+"px","font-family":r,"font-weight":s.bold?"bold":"normal","font-style":s.italic?"italic":"normal","text-align":s.textAlign,color:"rgb("+s.color+")","text-decoration":s.underline?"underline":"none",opacity:e.shapeStyle.alpha},m.css(a),m.show(),p=v.position,"horizontal"==s.orientation&&(l=p.x+p.w/2,d=p.y+p.h/2,p={x:l-p.h/2,y:d-p.w/2,w:p.h,h:p.w}),m.css({width:p.w}),m.height(0),m.val(v.text),m.scrollTop(99999),h=m.scrollTop(),c=0,c="middle"==s.vAlign?p.y+p.h/2-h/2:"bottom"==s.vAlign?p.y+p.h-h:p.y,y={x:p.x+p.w/2,y:c+h/2},0!=(u=e.props.angle)&&(g={x:e.props.w/2,y:e.props.h/2},y=Utils.getRotated(g,y,u)),"horizontal"==s.orientation&&(u=(1.5*Math.PI+u)%(2*Math.PI)),f="rotate("+Math.round(u/(2*Math.PI)*360)+"deg) scale("+Designer.config.scale+")",x=p.w,m.css({width:x,height:h,left:(y.x+(e.props.x-t.x)+10).toScale()-p.w/2,top:(y.y+(e.props.y-t.y)+10).toScale()-h/2,"-webkit-transform":f,"-ms-transform":f,"-o-transform":f,"-moz-transform":f,transform:f})):m.css({height:"0px",width:"0px"}).hide()}},calculateTextLines:function(e,t,n){for(var i=t.w,o=(t.h,[]),s=e.split(/\n/),r=0;r<s.length;r++){var a=s[r];if(n.measureText(a).width<=i)o.push(a);else{for(var l=a.split(/\s/),d="",p=0;p<l.length;p++){var h=l[p];if(p!=l.length-1&&(h+=" "),i<n.measureText(h).width)for(var c=0;c<h.length;c++)var u=d+h[c],d=i<n.measureText(u).width?(o.push(d),h[c]):u;else{u=d+h;d=i<n.measureText(u).width?(o.push(d),h):u}}""!=d&&o.push(d)}}return o},renderMarkers:function(e,t,n){if(t.attribute&&t.attribute.markers&&0<t.attribute.markers.length){var i=t.attribute.markers,o=Schema.config.markerSize;n&&(o=10);var s=t.attribute.markerOffset;n&&(s=5);for(var r=i.length*o+4*(i.length-1),a=t.props.w/2-r/2,l=0;l<i.length;l++){var d=i[l];e.save(),e.translate(a,t.props.h-o-s);var p=Schema.markers[d].call(t,o);this.renderPath(e,t,p),e.restore(),a+=o+4}}},renderDataAttributes:function(v,m){if($("#"+v.id).children(".attr_canvas").remove(),v.dataAttributes&&0!=v.dataAttributes.length)for(var S={x:v.props.w/2,y:v.props.h/2},w=Utils.getShapeFontStyle(v),e=0;e<v.dataAttributes.length;e++){var t,n,i=v.dataAttributes[e];"none"!=i.showType&&(n=t="",i.showName&&(t=i.name+": "),"text"==i.showType?t+=i.value:"icon"==i.showType&&(n=i.icon),""==t&&""==n||function(e,t,n){var i=e.horizontal,o=e.vertical,s=$("<canvas id='attr_canvas_"+e.id+"' class='attr_canvas'></canvas>").appendTo($("#"+v.id)),r=s[0].getContext("2d"),a="12px ",l=w.fontFamily;localRuntime&&Utils.containsChinese(t)&&!Utils.containsChinese(l)&&(l="宋体");a+=l,r.font=a;var d,p,h=r.measureText(t).width;""!=n&&(h+=20);d="mostleft"==i?-h-2:"leftedge"==i?-h/2:"left"==i?2:"center"==i?(v.props.w-h)/2:"right"==i?v.props.w-h-2:"rightedge"==i?v.props.w-h/2:v.props.w+2;p="mosttop"==o?-20:"topedge"==o?-10:"top"==o?0:"middle"==o?(v.props.h-20)/2:"bottom"==o?v.props.h-20:"bottomedge"==o?v.props.h-10:v.props.h;var c={x:d,y:p,w:h,h:20},u=Utils.getRotatedBox(c,v.props.angle,S);s.attr({width:u.w.toScale(),height:u.h.toScale()}),r.font=a;var g=(u.x+(v.props.x-m.x)+10).toScale(),y=(u.y+(v.props.y-m.y)+10).toScale();s.css({left:g,top:y}),r.scale(Designer.config.scale,Designer.config.scale),r.translate(u.w/2,u.h/2),r.rotate(v.props.angle),r.translate(-u.w/2,-u.h/2),r.translate((u.w-c.w)/2,(u.h-c.h)/2),r.globalAlpha=v.shapeStyle.alpha,"link"==e.type?r.fillStyle="#4183C4":r.fillStyle="#333";{var f,x;r.textBaseline="middle",r.fillText(t,0,10),""!=n&&(f="/images/data-attr/"+n+".png",localRuntime&&(f="http://localhost:8080"+f),0==(x=$(".shape_img[src='"+f+"']")).length&&(x=$("<img class='shape_img' loaded='false' src='"+f+"'/>").appendTo("#shape_img_container")),"true"==x.attr("loaded")?r.drawImage(x[0],c.w-20,0,20,20):x.bind("load.drawshape",function(){$(this).attr("loaded","true"),r.drawImage(x[0],c.w-20,0,20,20)}))}{r.beginPath(),r.rect(0,0,h,20),r.closePath(),"link"==e.type&&$("<a href='"+e.value+"' target='_blank' class='attr_link'></canvas>").appendTo($("#"+v.id)).css({left:g,top:y,width:u.w.toScale(),height:u.h.toScale(),position:"absolute"})}}(i,t,n))}},renderLinker:function(e,t,n,i){t&&(e.points=Utils.getLinkerPoints(e)),"curve"!=e.linkerType&&"broken"!=e.linkerType||e.points&&0!=e.points.length||(e.points=Utils.getLinkerPoints(e));var o=e.points,s=Utils.copy(e.from),r=Utils.copy(e.to);if(e.attribute&&e.attribute.collapseBy)$("#"+e.id).hide();else{$("#"+e.id).show();var a=Utils.getEndpointAngle(e,"from"),l=Utils.getEndpointAngle(e,"to"),d=Utils.getLinkerLineStyle(e.lineStyle);Y(s,e,d.beginArrowStyle,a),Y(r,e,d.endArrowStyle,l);for(var p=r.x,h=r.y,c=s.x,u=s.y,c=r.x<s.x?(p=r.x,s.x):(p=s.x,r.x),u=r.y<s.y?(h=r.y,s.y):(h=s.y,r.y),g=0;g<o.length;g++){var y=o[g];y.x<p?p=y.x:y.x>c&&(c=y.x),y.y<h?h=y.y:y.y>u&&(u=y.y)}var f,x=p,v=h,m=c-p,S=u-h,w=$("#"+e.id);0==w.length&&(f=$("#designer_canvas"),w=$("<div id='"+e.id+"' class='shape_box linker_box'><canvas class='shape_canvas'></canvas></div>").appendTo(f)),Model.getShapeById(e.id)||w.css("z-index",Model.orderList.length+1);var b=Utils.isMac(),k=1;b&&(k=2);var M=w.find(".shape_canvas");M.attr({width:(m+20).toScale()*k,height:(S+20).toScale()*k}),w.css({left:(x-10).toScale(),top:(v-10).toScale(),width:(m+20).toScale(),height:(S+20).toScale()});var _=M[0].getContext("2d");b&&_.scale(2,2),_.scale(Designer.config.scale,Designer.config.scale),_.translate(10,10);var D=Utils.getLinkerLineStyle(e.lineStyle);_.lineWidth=D.lineWidth,_.strokeStyle="rgb("+D.lineColor+")",_.fillStyle="rgb("+D.lineColor+")",_.save();var I={x:s.x-x,y:s.y-v},U={x:r.x-x,y:r.y-v};if(1==D.lineWidth&&(I.x+=.5,I.y+=.5,U.x+=.5,U.y+=.5),_.save(),b&&M.css({width:(m+20).toScale()+"px",height:(S+20).toScale()+"px"}),"dashed"==D.lineStyle?this.setLineDash(_,[5*D.lineWidth,2*D.lineWidth]):"dot"==D.lineStyle?this.setLineDash(_,[D.lineWidth,1.5*D.lineWidth]):"dashdot"==D.lineStyle&&this.setLineDash(_,[5*D.lineWidth,2*D.lineWidth,D.lineWidth,2*D.lineWidth]),_.lineJoin="round",_.beginPath(),this.actions.move.call(_,I),"curve"==e.linkerType){var C=o[0],P=o[1],L={x1:C.x-x,y1:C.y-v,x2:P.x-x,y2:P.y-v,x:U.x,y:U.y};this.actions.curve.call(_,L)}else{var T=s;T.y=Math.round(T.y);var z=0,B=0;1==D.lineWidth&&(B=z=.5,lineW=8);var O=Utils.copyArray(o);2==o.length&&o[0].x==o[1].x&&o[0].y==o[1].y&&(O=[]),O.push(r);for(g=0;g<O.length;g++){var A=O[g];if(A.y=Math.round(A.y),A.x!=T.x||A.y!=T.y){if(i&&A.y==T.y&&A.x!=T.x&&D.lineWidth<6){for(var R=i.points,K=!1,W=0;W<R.length;W++){(F=R[W]).y==A.y&&Math.abs(F.x-A.x)<=6&&(K=!0)}if(K)continue;if(A.x<T.x)for(W=R.length-1;0<=W;W--){(F=R[W]).y==A.y&&F.x>=A.x&&F.x<=T.x&&(X=F.x-x+z,E=F.y-v+B,_.arc(X,E,6,0,Math.PI,!0))}else for(var F,X,E,W=0;W<R.length;W++){(F=R[W]).y==A.y&&F.x<A.x&&F.x>T.x&&(X=F.x-x+z,E=F.y-v+B,_.arc(X,E,6,Math.PI,0))}}var N=A.x-x+z,V=A.y-v+B;this.actions.line.call(_,{x:N,y:V}),T=A}}}Utils.isSelected(e.id)?(_.shadowBlur=4,_.shadowColor="#1E6FFF","curve"==e.linkerType&&Utils.getSelectedIds().length,w.css("z-index",99999)):w.css("z-index",Model.orderList[e.id]),_.stroke(),_.restore(),delete _.webkitLineDash,H(I,a,s.id,D.beginArrowStyle,s.angle),H(U,l,r.id,D.endArrowStyle,r.angle),_.restore(),this.renderLinkerText(e,t,n)}function Y(e,t,n,i){var o,s,r,a,l;!e.id||(o=Model.getShapeById(e.id))&&(s={x:0,y:0},r=Utils.getShapeLineStyle(o.lineStyle),a=Utils.getLinkerLineStyle(t.lineStyle),s.x="none"==n||"cross"==n?-r.lineWidth/2:"solidArrow"==n||"dashedArrow"==n?-r.lineWidth/2-1.3*a.lineWidth:"solidDiamond"==n||"dashedDiamond"==n?-r.lineWidth/2-a.lineWidth:-r.lineWidth/2-a.lineWidth/2,l=Utils.getRotated({x:0,y:0},s,i),e.x+=l.x,e.y+=l.y)}function H(e,t,n,i){var o,s,r,a,l,d,p,h,c,u,g,y,f,x,v,m,S,w;"normal"==i?(y=12,f=Math.PI/5,x=y/Math.cos(f),u=e.x-x*Math.cos(t-f),g=e.y-x*Math.sin(t-f),v=e.x-x*Math.sin(Math.PI/2-t-f),m=e.y-x*Math.cos(Math.PI/2-t-f),_.beginPath(),_.moveTo(u,g),_.lineTo(e.x,e.y),_.lineTo(v,m),_.stroke()):"solidArrow"==i?(y=12,f=Math.PI/10,x=y/Math.cos(f),u=e.x-x*Math.cos(t-f),g=e.y-x*Math.sin(t-f),v=e.x-x*Math.sin(Math.PI/2-t-f),m=e.y-x*Math.cos(Math.PI/2-t-f),_.beginPath(),_.moveTo(e.x,e.y),_.lineTo(u,g),_.lineTo(v,m),_.lineTo(e.x,e.y),_.closePath(),_.fill(),_.stroke()):"dashedArrow"==i?(_.save(),y=12,f=Math.PI/10,x=y/Math.cos(f),u=e.x-x*Math.cos(t-f),g=e.y-x*Math.sin(t-f),v=e.x-x*Math.sin(Math.PI/2-t-f),m=e.y-x*Math.cos(Math.PI/2-t-f),_.beginPath(),_.moveTo(e.x,e.y),_.lineTo(u,g),_.lineTo(v,m),_.lineTo(e.x,e.y),_.closePath(),_.fillStyle="white",_.fill(),_.stroke(),_.restore()):"solidCircle"==i?(_.save(),o=4,s=e.x-o*Math.cos(t),r=e.y-o*Math.sin(t),_.beginPath(),_.arc(s,r,o,0,2*Math.PI,!1),_.closePath(),_.fill(),_.stroke(),_.restore()):"dashedCircle"==i?(_.save(),o=4,s=e.x-o*Math.cos(t),r=e.y-o*Math.sin(t),_.beginPath(),_.arc(s,r,o,0,2*Math.PI,!1),_.closePath(),_.fillStyle="white",_.fill(),_.stroke(),_.restore()):"solidDiamond"==i?(_.save(),y=8,f=Math.PI/7,x=y/Math.cos(f),u=e.x-x*Math.cos(t-f),g=e.y-x*Math.sin(t-f),v=e.x-x*Math.sin(Math.PI/2-t-f),m=e.y-x*Math.cos(Math.PI/2-t-f),S=e.x-2*y*Math.cos(t),w=e.y-2*y*Math.sin(t),_.beginPath(),_.moveTo(e.x,e.y),_.lineTo(u,g),_.lineTo(S,w),_.lineTo(v,m),_.lineTo(e.x,e.y),_.closePath(),_.fill(),_.stroke(),_.restore()):"dashedDiamond"==i?(_.save(),y=8,f=Math.PI/7,x=y/Math.cos(f),u=e.x-x*Math.cos(t-f),g=e.y-x*Math.sin(t-f),v=e.x-x*Math.sin(Math.PI/2-t-f),m=e.y-x*Math.cos(Math.PI/2-t-f),S=e.x-2*y*Math.cos(t),w=e.y-2*y*Math.sin(t),_.beginPath(),_.moveTo(e.x,e.y),_.lineTo(u,g),_.lineTo(S,w),_.lineTo(v,m),_.lineTo(e.x,e.y),_.closePath(),_.fillStyle="white",_.fill(),_.stroke(),_.restore()):"cross"==i?(a=6*Math.cos(Math.PI/2-t),l=6*Math.sin(Math.PI/2-t),d=e.x+a,p=e.y-l,h=(S=e.x-14*Math.cos(t))-a,c=(w=e.y-14*Math.sin(t))+l,_.beginPath(),_.moveTo(d,p),_.lineTo(h,c),_.stroke()):"asynch1"==i?(_.save(),y=14,f=Math.PI/6.5,x=y/Math.cos(f),u=e.x-x*Math.cos(t-f),g=e.y-x*Math.sin(t-f),S=e.x-2*y*Math.cos(t),w=e.y-2*y*Math.sin(t),_.beginPath(),_.moveTo(e.x,e.y),_.lineTo(u,g),_.fillStyle="white",_.fill(),_.stroke(),_.restore()):"asynch2"==i&&(_.save(),y=14,f=Math.PI/6.5,x=y/Math.cos(f),v=e.x-x*Math.sin(Math.PI/2-t-f),m=e.y-x*Math.cos(Math.PI/2-t-f),S=e.x-2*y*Math.cos(t),w=e.y-2*y*Math.sin(t),_.beginPath(),_.moveTo(e.x,e.y),_.lineTo(v,m),_.fillStyle="white",_.fill(),_.stroke(),_.restore())}},renderLinkerText:function(e,t,n){var i=$("#"+e.id),o=i.find(".text_canvas");0==o.length&&(o=$("<div class='text_canvas linker_text'></div>").appendTo(i));var s=Utils.getLinkerFontStyle(e.fontStyle),r="scale("+Designer.config.scale+")",a=s.fontFamily;localRuntime&&Utils.containsChinese(e.text)&&!Utils.containsChinese(a)&&(a="宋体");var l,d,p,h,c,u={"line-height":Math.round(1.25*s.size)+"px","font-size":s.size+"px","font-family":a,"font-weight":s.bold?"bold":"normal","font-style":s.italic?"italic":"normal","text-align":s.textAlign,color:"rgb("+s.color+")","text-decoration":s.underline?"underline":"none","-webkit-transform":r,"-ms-transform":r,"-o-transform":r,"-moz-transform":r,transform:r};o.css(u),null!=e.text&&""!=e.text?(o.show(),l=e.text.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br/>"),o.html(l+"<br/>"),(d=null)!=e.textPos?t||n?(p=Utils.getLinkerLinesPoints(e),e.textPos.t>p.length&&(e.textPos.t=p.length-1),null!=(d=p[e.textPos.t])&&(e.textPos.x=d.x,e.textPos.y=d.y)):d={x:e.textPos.x,y:e.textPos.y}:d=this.getLinkerMidpoint(e),null!=d&&null!=d.x&&(h=i.position(),c=d.y.toScale()-h.top-o.height()/2,null!=e.textPos&&(null!=e.textPos.pos&&"top"==e.textPos.pos?c=c-o.height()/2-6:null!=e.textPos.pos&&"bottom"==e.textPos.pos&&(c+=o.height()/2+6)),o.css({left:d.x.toScale()-h.left-o.width()/2,top:c}))):o.hide()},getLinkerMidpoint:function(e){var t={};if("normal"==e.linkerType)t={x:.5*e.from.x+.5*e.to.x,y:.5*e.from.y+.5*e.to.y};else if("curve"==e.linkerType)var n=e.from,i=e.points[0],o=e.points[1],s=e.to,t={x:.125*n.x+.375*i.x+.375*o.x+.125*s.x,y:.125*n.y+.375*i.y+.375*o.y+.125*s.y};else{var r=[];r.push(e.from),(r=r.concat(e.points)).push(e.to);for(var a=0,l=1;l<r.length;l++){i=r[l-1],o=r[l];a+=h=Utils.measureDistance(i,o)}for(var d=a/2,p=0,l=1;l<r.length;l++){var h,i=r[l-1],o=r[l],c=p+(h=Utils.measureDistance(i,o));if(d<=c){var u=(d-p)/h;t={x:(1-u)*i.x+u*o.x,y:(1-u)*i.y+u*o.y};break}p=c}}return t},controlStatus:{resizeDir:[],rotatable:!0},drawControls:function(e){var t,n=$("#shape_controls");0==n.length&&(t=$("#designer_canvas"),(n=$("<div id='shape_controls'></div>").appendTo(t)).append("<canvas id='controls_bounding'></canvas>"),n.append("<div class='shape_controller' index='0' resizeDir='tl'></div>"),n.append("<div class='shape_controller' index='1' resizeDir='tr'></div>"),n.append("<div class='shape_controller' index='2' resizeDir='br'></div>"),n.append("<div class='shape_controller' index='3' resizeDir='bl'></div>"),n.append("<div class='shape_controller' resizeDir='l'></div>"),n.append("<div class='shape_controller' resizeDir='t'></div>"),n.append("<div class='shape_controller' resizeDir='r'></div>"),n.append("<div class='shape_controller' resizeDir='b'></div>"),Designer.op.shapeResizable(),n.append("<canvas class='shape_rotater' width='82' height='80' style='width:41px;height:40px;'></canvas>"),Designer.op.shapeRotatable(),n.append("<div class='group_icon change_shape_icon'></div>"),Designer.op.groupShapeChangable(),$(".shape_controller").css({"border-color":Designer.config.anchorColor,width:Designer.config.anchorSize-2,height:Designer.config.anchorSize-2})),$(".shape_controller").css({"z-index":Model.orderList.length}),$(".change_shape_icon").hide(),n.show();var i,o,s=0;1==e.length?(i=(l=Model.getShapeById(e[0])).props,s=l.props.angle,o=l.resizeDir,l.groupName&&SchemaGroup.groupExists(l.groupName)&&$(".change_shape_icon").show()):(i=Utils.getControlBox(e),o=["tl","tr","br","bl"]);for(var r=!0,a=0;a<e.length;a++){var l,d=e[a];(l=Model.getShapeById(d)).attribute&&0==l.attribute.rotatable&&(r=!1),(l.resizeDir&&0==l.resizeDir.length||l.parent&&1<e.length)&&(o=[])}return this.controlStatus.rotatable=r,this.controlStatus.resizeDir=o,this.rotateControls(i,s),n},rotateControls:function(e,t){var n=$("#shape_controls"),i=Utils.getRotatedBox(e,t),o=i.w.toScale(),s=i.h.toScale();n.css({left:i.x.toScale(),top:i.y.toScale(),width:o,height:s,"z-index":Model.orderList.length});var r=o+20,a=s+20,l=$("#controls_bounding");l.attr({width:r,height:a});var d=l[0].getContext("2d");d.lineJoin="round",0==this.controlStatus.resizeDir.length?(d.lineWidth=2,d.strokeStyle=Designer.config.selectorColor,d.globalAlpha=.8):(d.lineWidth=1,d.strokeStyle=Designer.config.selectorColor,d.globalAlpha=.5),d.save(),d.clearRect(0,0,r,a),d.translate(r/2,a/2),d.rotate(t),d.translate(-r/2,-a/2),d.translate(9.5,9.5);var p={x:Math.round((e.x-i.x).toScale()),y:Math.round((e.y-i.y).toScale()),w:Math.floor(e.w.toScale()+1),h:Math.floor(e.h.toScale()+1)};d.strokeRect(p.x,p.y,p.w,p.h),d.restore();var h=0-Designer.config.anchorSize/2;e=Utils.toScale(e),i=Utils.toScale(i);var c={x:e.x+e.w/2,y:e.y+e.h/2};n.children(".shape_controller").hide();for(var u=0;u<this.controlStatus.resizeDir.length;u++){var g,y,f=this.controlStatus.resizeDir[u],x=$(".shape_controller[resizeDir="+f+"]");x.show(),g=0<=f.indexOf("l")?e.x:0<=f.indexOf("r")?e.x+e.w:e.x+e.w/2,y=0<=f.indexOf("t")?e.y:0<=f.indexOf("b")?e.y+e.h:e.y+e.h/2;var v=Utils.getRotated(c,{x:g,y:y},t);x.css({left:v.x-i.x+h,top:v.y-i.y+h})}var m,S,w,b,k=Math.PI/8;n.children(".shape_controller").removeClass("s n e w"),k<t&&t<=3*k?(n.children("div[resizeDir=tl]").addClass("n"),n.children("div[resizeDir=tr]").addClass("e"),n.children("div[resizeDir=br]").addClass("s"),n.children("div[resizeDir=bl]").addClass("w"),n.children("div[resizeDir=l]").addClass("n w"),n.children("div[resizeDir=r]").addClass("s e"),n.children("div[resizeDir=b]").addClass("s w"),n.children("div[resizeDir=t]").addClass("n e")):3*k<t&&t<=5*k?(n.children("div[resizeDir=tl]").addClass("n e"),n.children("div[resizeDir=tr]").addClass("s e"),n.children("div[resizeDir=br]").addClass("s w"),n.children("div[resizeDir=bl]").addClass("n w"),n.children("div[resizeDir=l]").addClass("n"),n.children("div[resizeDir=r]").addClass("s"),n.children("div[resizeDir=b]").addClass("w"),n.children("div[resizeDir=t]").addClass("e")):5*k<t&&t<=7*k?(n.children("div[resizeDir=tl]").addClass("e"),n.children("div[resizeDir=tr]").addClass("s"),n.children("div[resizeDir=br]").addClass("w"),n.children("div[resizeDir=bl]").addClass("n"),n.children("div[resizeDir=l]").addClass("n e"),n.children("div[resizeDir=r]").addClass("s w"),n.children("div[resizeDir=b]").addClass("n w"),n.children("div[resizeDir=t]").addClass("s e")):7*k<t&&t<=9*k?(n.children("div[resizeDir=tl]").addClass("s e"),n.children("div[resizeDir=tr]").addClass("s w"),n.children("div[resizeDir=br]").addClass("n w"),n.children("div[resizeDir=bl]").addClass("n e"),n.children("div[resizeDir=l]").addClass("e"),n.children("div[resizeDir=r]").addClass("w"),n.children("div[resizeDir=b]").addClass("n"),n.children("div[resizeDir=t]").addClass("s")):9*k<t&&t<=11*k?(n.children("div[resizeDir=tl]").addClass("s"),n.children("div[resizeDir=tr]").addClass("w"),n.children("div[resizeDir=br]").addClass("n"),n.children("div[resizeDir=bl]").addClass("e"),n.children("div[resizeDir=l]").addClass("s e"),n.children("div[resizeDir=r]").addClass("n w"),n.children("div[resizeDir=b]").addClass("n e"),n.children("div[resizeDir=t]").addClass("s w")):11*k<t&&t<=13*k?(n.children("div[resizeDir=tl]").addClass("s w"),n.children("div[resizeDir=tr]").addClass("n w"),n.children("div[resizeDir=br]").addClass("n e"),n.children("div[resizeDir=bl]").addClass("s e"),n.children("div[resizeDir=l]").addClass("s"),n.children("div[resizeDir=r]").addClass("n"),n.children("div[resizeDir=b]").addClass("e"),n.children("div[resizeDir=t]").addClass("w")):13*k<t&&t<=15*k?(n.children("div[resizeDir=tl]").addClass("w"),n.children("div[resizeDir=tr]").addClass("n"),n.children("div[resizeDir=br]").addClass("e"),n.children("div[resizeDir=bl]").addClass("s"),n.children("div[resizeDir=l]").addClass("s w"),n.children("div[resizeDir=r]").addClass("n e"),n.children("div[resizeDir=b]").addClass("s e"),n.children("div[resizeDir=t]").addClass("n w")):(n.children("div[resizeDir=tl]").addClass("n w"),n.children("div[resizeDir=tr]").addClass("n e"),n.children("div[resizeDir=br]").addClass("s e"),n.children("div[resizeDir=bl]").addClass("s w"),n.children("div[resizeDir=l]").addClass("w"),n.children("div[resizeDir=r]").addClass("e"),n.children("div[resizeDir=b]").addClass("s"),n.children("div[resizeDir=t]").addClass("n")),this.controlStatus.rotatable?((m=n.find(".shape_rotater")).show(),S={x:e.x+e.w/2,y:e.y-20},w=Utils.getRotated(c,S,t),m.css({top:w.y-20-i.y,left:w.x-20.5-i.x}),(b=m[0].getContext("2d")).scale(2,2),b.lineWidth=1,b.strokeStyle=Designer.config.anchorColor,b.fillStyle="white",b.save(),b.clearRect(0,0,41,40),b.translate(20.5,20),b.rotate(t),b.translate(-20.5,-20),b.beginPath(),b.moveTo(20.5,20),b.lineTo(20.5,40),b.stroke(),b.beginPath(),b.arc(20.5,20,Designer.config.rotaterSize/2,0,2*Math.PI),b.closePath(),b.fill(),b.stroke(),b.restore(),b.scale(.5,.5)):n.find(".shape_rotater").hide()}}},Model={define:{},persistence:{},orderList:[],maxZIndex:0,linkerMap:{map:{},add:function(e,t){this.map[e]||(this.map[e]=[]),this.map[e].indexOf(t)<0&&this.map[e].push(t)},remove:function(e,t){this.map[e]&&Utils.removeFromArray(this.map[e],t)},empty:function(){this.map={}}},intersection:{},groupMap:{map:{},add:function(e,t){this.map[e]=t},push:function(e,t){this.map[e]||(this.map[e]=[]),this.map[e].push(t)},remove:function(e){delete this.map[e]},empty:function(){this.map={}}},create:function(e,t,n){var i=Utils.newId(),o=Utils.copy(Schema.shapes[e]);o.id=i,o.props.x=t,o.props.y=n,o.attribute.container?o.props.zindex=-1:o.props.zindex=Model.maxZIndex+1,o.props=$.extend(!0,{},Schema.shapeDefaults.props,o.props);for(var s=0;s<o.dataAttributes.length;s++){o.dataAttributes[s].id=Utils.newId()}var r=Model.define;return null!=r.defaultStyle&&null!=r.defaultStyle.fillStyle&&$.isEmptyObject(o.fillStyle)&&(o.fillStyle=r.defaultStyle.fillStyle),null!=r.defaultStyle&&null!=r.defaultStyle.lineStyle&&$.isEmptyObject(o.lineStyle)&&(o.lineStyle=r.defaultStyle.lineStyle),null!=r.defaultStyle&&null!=r.defaultStyle.fontStyle&&$.isEmptyObject(o.fontStyle)&&(o.fontStyle=r.defaultStyle.fontStyle),Designer.events.push("create",o),o},add:function(e,t){this.addMulti([e],t)},iconAccessLimit:function(){},addMulti:function(e,t){void 0===t&&(t=!0);for(var n=[],i=0;i<e.length;i++){var o=e[i];n.push(Utils.copy(o)),this.define.elements[o.id]=Utils.copy(o),this.persistence.elements[o.id]=Utils.copy(o)}this.build(),t&&MessageSource.send("create",n)},update:function(e){this.updateMulti([e])},updateMulti:function(e){for(var t=[],n=[],i=0;i<e.length;i++){var o=e[i];this.define.elements[o.id]&&(this.define.elements[o.id]=Utils.copy(o),n.push(Utils.copy(this.getPersistenceById(o.id))),t.push(Utils.copy(o)),this.persistence.elements[o.id]=Utils.copy(o))}this.build();var s={shapes:n,updates:t};MessageSource.send("update",s)},remove:function(e,t){void 0===t&&(t=!0),t&&(e=Designer.events.push("beforeRemove",e));var n=[],i=[],o=[],s=[],r=[];if(0==e.length)return!1;for(var a=0;a<e.length;a++){"linker"==(p=e[a]).name?r.push(p.id):s.push(p.id)}for(var l,a=0;a<e.length;a++){var d,p=e[a];if(n.push(Utils.copy(p)),$("#"+p.id).remove(),delete this.define.elements[p.id],delete this.persistence.elements[p.id],this.groupMap.remove(p.group),"linker"==p.name)null!=p.from.id&&this.linkerMap.remove(p.from.id,p.id),null!=p.to.id&&this.linkerMap.remove(p.to.id,p.id);else{p.parent&&s.indexOf(p.parent)<0&&((d=Model.getShapeById(p.parent))&&(Utils.removeFromArray(d.children,p.id),i.indexOf(p.parent)<0&&(i.push(p.parent),o.push(d))));var h=this.getShapeLinkers(p.id);if(h&&0<h.length)for(var c=0;c<h.length;c++){var u,g=h[c];r.indexOf(g)<0&&(null!=(u=this.getShapeById(g)).from.id&&u.from.id==p.id&&(u.from.id=null,u.from.angle=null),null!=u.to.id&&u.to.id==p.id&&(u.to.id=null,u.to.angle=null),i.indexOf(g)<0&&(i.push(g),o.push(u)))}delete this.linkerMap.map[p.id]}}return this.build(),MessageSource.beginBatch(),MessageSource.send("remove",n),!t||(l=Designer.events.push("removed",{shapes:e,changedIds:i,range:s}))&&l.length&&(o=o.concat(l)),0<o.length&&this.updateMulti(o),MessageSource.commit(),Designer.events.push("changeLinkers",n),Designer.op.showShapesLen(),!0},updatePage:function(e,t){var n=$.extend(Model.define.page,e),i={page:Utils.copy(Model.persistence.page),update:Utils.copy(n)};Model.persistence.page=Utils.copy(n),MessageSource.send("updatePage",i),Designer.initialize.initCanvas()},setTheme:function(e){Model.define.theme=e;var t={theme:Utils.copy(Model.persistence.theme),update:Utils.copy(e)};for(var n in Model.persistence.theme=Utils.copy(e),MessageSource.send("setTheme",t),Model.define.elements){var i=Model.getShapeById(n);Designer.painter.renderShape(i)}},updateWithBeautify:function(e,t,n){var i={content:t,updates:e};null!=n&&"{}"!=JSON.stringify(n)&&(i.theme=n,i.oldTheme=Model.define.theme);var o=Model.define.elements;MessageSource.send("update_with_beautify",i),null!=n&&(Model.define.theme=n);for(var s=0,r=e.length;s<r;s++){o[a=e[s].id]=$.extend(!0,o[a],e[s])}for(var a in Model.define.elements){var l=Model.getShapeById(a);Designer.painter.renderShape(l)}Designer.events.push("resetBrokenLinker")},setDefaultStyle:function(e,t){var n=null;"linker"==e?(n=Utils.copy(Model.define.defaultLinkerStyle),Model.define.defaultLinkerStyle=t):"all"==e?(n={linkerStyle:Utils.copy(Model.define.defaultLinkerStyle),shapeStyle:Utils.copy(Model.define.defaultStyle)},Model.define.defaultStyle=t.shapeStyle,Model.define.defaultLinkerStyle=t.linkerStyle):(n=Utils.copy(Model.define.defaultStyle),Model.define.defaultStyle=t);var i={style:n,type:e,update:Utils.copy(t)};MessageSource.send("setDefaultStyle",i)},clearDefaultStyle:function(){var e,t={linkerStyle:Utils.copy(Model.define.defaultLinkerStyle),shapeStyle:Utils.copy(Model.define.defaultStyle)};null==Model.define.defaultStyle&&null==Model.define.defaultLinkerStyle||(delete Model.define.defaultStyle,delete Model.define.defaultLinkerStyle,e={style:t,update:{}},MessageSource.send("clearDefaultStyle",e))},getShapeById:function(e){return this.define.elements[e]},getLinkers:function(e){var t=[];for(var n in Model.define.elements){var i=Model.getShapeById(n);"linker"==i.name&&i.linkerType==e&&t.push(i)}return t},getPersistenceById:function(e){return this.persistence.elements[e]},build:function(){for(var e in this.orderList=[],this.linkerMap.empty(),Model.define.elements){var t=Model.getShapeById(e);this.orderList.push({id:t.id,zindex:t.props.zindex}),"linker"==t.name&&(null!=t.from.id&&this.linkerMap.add(t.from.id,t.id),null!=t.to.id&&this.linkerMap.add(t.to.id,t.id)),t.group&&this.groupMap.push(t.group,t.id)}this.orderList.sort(function(e,t){return e.zindex-t.zindex});for(var n=0;n<Model.orderList.length;n++){e=Model.orderList[n].id;$("#"+e).css("z-index",n)}var i=0;0<this.orderList.length&&(i=this.orderList[this.orderList.length-1].zindex),this.maxZIndex=i},getShapeLinkers:function(e){return this.linkerMap.map[e]},getGroupShapes:function(e){return this.groupMap.map[e]},changeShape:function(e,t){var n=Utils.copy(Schema.shapes[t]);e.name=t,e.title=n.shapeName;var i=n.attribute;if(e.attribute&&void 0!==e.attribute.collapsed&&(i.collapsed=e.attribute.collapsed),e.attribute&&void 0!==e.attribute.collapseW&&(i.collapseW=e.attribute.collapseW),e.attribute&&void 0!==e.attribute.collapseH&&(i.collapseH=e.attribute.collapseH),e.attribute&&e.attribute.markers&&0<=e.attribute.markers.indexOf("expand")&&(i.markers||(i.markers=[]),i.markers.push("expand")),e.attribute=i,e.dataAttributes=n.dataAttributes,e.dataAttributes)for(var o=0;o<e.dataAttributes.length;o++){(i=e.dataAttributes[o]).id=Utils.newId()}var s="";0<e.textBlock.length&&(s=e.textBlock[0].text),e.path=n.path,e.textBlock=n.textBlock,0<e.textBlock.length&&(e.textBlock[0].text=s),e.anchors=n.anchors,e.fillStyle&&"image"==e.fillStyle.type&&n.fillStyle&&"image"==n.fillStyle.type&&(e.fillStyle=n.fillStyle),Schema.initShapeFunctions(e),Designer.painter.renderShape(e)}},Utils={getDomById:function(e){return document.getElementById(e)},newId:function(){return(Math.random()+(new Date).getTime()).toString(16).replace(".","")},isChrome:function(){return 0<=navigator.userAgent.toLowerCase().indexOf("chrome")},isFirefox:function(){return 0<=navigator.userAgent.toLowerCase().indexOf("firefox")},isSafari:function(){var e=navigator.userAgent.toLowerCase();return-1!==e.indexOf("safari")&&-1===e.indexOf("chrome")},isIE:function(){var e=navigator.userAgent;return-1<e.indexOf("MSIE ")||-1<e.indexOf("Trident/")||-1<e.indexOf("Edge/")},isMac:function(){return!0},getShapeByPosition:function(e,t,n){for(var i=[],o=Utils.isMac(),s=Model.orderList.length-1;0<=s;s--){var r=Model.orderList[s].id,a=$("#"+r),l=Model.getShapeById(r);if(!l.attribute||!l.attribute.collapseBy){var d=a.position(),p=e-d.left,h=t-d.top,c={x:d.left,y:d.top,w:a.width(),h:a.height()},u=a.find(".shape_canvas")[0].getContext("2d"),g=this.pointInRect(e,t,c);if("linker"==l.name){if(!g)continue;if(n)continue;var y={x:e-(m=(m=10).toScale()),y:t-m,w:2*m,h:2*m};if(this.pointInRect(l.to.x.toScale(),l.to.y.toScale(),y)){var f={type:"linker_point",point:"end",shape:l};i.push(f);continue}if(this.pointInRect(l.from.x.toScale(),l.from.y.toScale(),y)){var f={type:"linker_point",point:"from",shape:l};i.push(f);continue}var x=a.find(".text_canvas"),v=x.position(),y={x:v.left,y:v.top,w:x.outerWidth(),h:x.outerHeight()};if(this.pointInRect(p,h,y)){f={type:"linker_text",shape:l};i.push(f);continue}if(m=(m=7).toScale(),-1<(F=this.pointInLinker({x:e.restoreScale(),y:t.restoreScale()},l,m))){f={type:"linker",shape:l,pointIndex:F};i.push(f);continue}}else{if(g&&l.locked&&!n){u.isPointInPath(p,h)&&(f={type:"shape",shape:l},i.push(f));continue}var m=7;if(g){for(var y={x:e-(m=m.toScale()),y:t-m,w:2*m,h:2*m},S={x:l.props.x+l.props.w/2,y:l.props.y+l.props.h/2},w=l.getAnchors(),f=null,b=0;b<w.length;b++){var k=w[b],k=this.getRotated(S,{x:l.props.x+k.x,y:l.props.y+k.y},l.props.angle);if(Utils.pointInRect(k.x.toScale(),k.y.toScale(),y)){var M=Utils.getPointAngle(r,k.x,k.y,m);k.angle=M,f={type:"bounding",shape:l,linkPoint:k},u.isPointInPath(p,h)&&(f.inPath=!0);break}}if(null!=f){i.push(f);continue}}if(l.dataAttributes){for(var f=null,_=0;_<l.dataAttributes.length;_++){var D=l.dataAttributes[_];if("link"==D.type&&D.showType&&"none"!=D.showType){var I=a.children("#attr_canvas_"+D.id);if(0<I.length){var U=I.position(),C=p-U.left,P=h-U.top;if(I[0].getContext("2d").isPointInPath(C,P)){f={type:"dataAttribute",shape:l,attribute:D};break}}}}if(null!=f){i.push(f);continue}}if(!g)continue;var L=p,T=h;if(o&&(L=2*p+4,T=2*h+6),u.isPointInPath(L,T)){if(n){if((w=l.getAnchors())&&w.length){for(var z=!1,B=s+1;B<Model.orderList.length;B++){var O=Model.orderList[B].id,A=Model.getShapeById(O);Utils.rectInRect(A.props,l.props)&&(z=!0)}if(z)continue;f={type:"shape",shape:l};i.push(f);continue}continue}f={type:"shape",shape:l};i.push(f);continue}if((!l.attribute||void 0===l.attribute.linkable||l.attribute.linkable)&&null!=(M=Utils.getPointAngle(r,e.restoreScale(),t.restoreScale(),m))){for(var f=null,R={angle:M},K=1;K<=m;K++)if(0==M?(R.x=p+K,R.y=h):M<Math.PI/2?(R.x=p+K*Math.cos(M),R.y=h+K*Math.sin(M)):M==Math.PI/2?(R.x=p,R.y=h+K):M<Math.PI?(R.x=p-K*Math.sin(M-Math.PI/2),R.y=h+K*Math.cos(M-Math.PI/2)):M==Math.PI?(R.x=p-K,R.y=h):M<Math.PI/2*3?(R.x=p-K*Math.cos(M-Math.PI),R.y=h-K*Math.sin(M-Math.PI)):M==Math.PI/2*3?(R.x=p,R.y=h-K):(R.x=p+K*Math.sin(M-Math.PI/2*3),R.y=h-K*Math.cos(M-Math.PI/2*3)),u.isPointInPath(R.x,R.y)){R.x+=d.left,R.y+=d.top,R.x=R.x.restoreScale(),R.y=R.y.restoreScale(),f={type:"bounding",shape:l,linkPoint:R};break}if(null!=f){i.push(f);continue}}}}}f=null;if(1==i.length&&(f=i[0]),1<i.length&&n)f=i[0];else if(1<i.length){var W=i[0];if("bounding"==W.type&&"linker_point"!=W.type&&"linker"!=W.type)return W;for(var F=[],X=[],E=[],s=0;s<i.length;s++){"bounding"==(N=i[s]).type?E.push(N):"linker"==N.type?F.push(N):"linker_point"==N.type&&X.push(N)}if(0<E.length&&0<X.length)for(var N,s=0;s<E.length;s++){if((N=E[s]).inPath){f=N;break}}null==f&&0<X.length&&(X.sort(function(e,t){return Utils.isSelected(e.shape.id)&&!Utils.isSelected(t.shape.id)?-1:!Utils.isSelected(e.shape.id)&&Utils.isSelected(t.shape.id)?1:t.shape.props.zindex-e.shape.props.zindex}),f=X[0]),null==f&&0<F.length&&(F.sort(function(e,t){return Utils.isSelected(e.shape.id)&&!Utils.isSelected(t.shape.id)?-1:!Utils.isSelected(e.shape.id)&&Utils.isSelected(t.shape.id)?1:t.shape.props.zindex-e.shape.props.zindex}),f=F[0]),null==f&&(f=i[0])}return f},checkCross:function(e,t,n,i){var o,s,r=!1,a=(t.x-e.x)*(i.y-n.y)-(t.y-e.y)*(i.x-n.x);return 0!=a&&(o=((e.y-n.y)*(i.x-n.x)-(e.x-n.x)*(i.y-n.y))/a,s=((e.y-n.y)*(t.x-e.x)-(e.x-n.x)*(t.y-e.y))/a,0<=o&&o<=1&&0<=s&&s<=1&&(r=!0)),r},rectCross:function(e,t){var n=e.x,i=e.x+e.w,o=e.y,s=e.y+e.h,r=t.x,a=t.x+t.w,l=t.y,d=t.y+t.h;return n<a&&r<i&&o<d&&l<s},rectInRect:function(e,t){var n={x:e.x,y:e.y},i={x:e.x+e.w,y:e.y},o={x:e.x+e.w,y:e.y+e.h},s={x:e.x,y:e.y+e.h};return!!(this.pointInRect(n.x,n.y,t)&&this.pointInRect(i.x,i.y,t)&&this.pointInRect(o.x,o.y,t)&&this.pointInRect(s.x,s.y,t))},pointInPolygon:function(e,t){for(var n,i,o=e,s={x:-1e6,y:e.y},r=0,a=0;a<t.length-1;a++)n=t[a],i=t[a+1],1==Utils.checkCross(o,s,n,i)&&r++;return n=t[t.length-1],i=t[0],1==Utils.checkCross(o,s,n,i)&&r++,r%2!=0},pointInRect:function(e,t,n){return e>=n.x&&e<=n.x+n.w&&t>=n.y&&t<=n.y+n.h},pointInLinker:function(e,t,n){for(var i=this.getLinkerLinePoints(t),o={x:e.x-n,y:e.y},s={x:e.x+n,y:e.y},r={x:e.x,y:e.y-n},a={x:e.x,y:e.y+n},l=1;l<i.length;l++){var d=i[l-1],p=i[l],h=this.checkCross(o,s,d,p);if(h)return l;if(this.checkCross(r,a,d,p))return l}return-1},intersection:function(e,t,n,i){var o=e.x,s=e.y,r=t.x,a=t.y,l=n.x,d=n.y,p=i.x,h=i.y,c=(o-r)*(d-h)-(s-a)*(l-p);return{x:((o*a-s*r)*(l-p)-(o-r)*(l*h-d*p))/c,y:((o*a-s*r)*(d-h)-(s-a)*(l*h-d*p))/c}},getLinesFromLinker:function(e){var t=e.from,n=e.to,i=[],o=e.points;if(2==o.length&&o[0].x==o[1].x&&o[0].y==o[1].y)i.push({x1:t.x,y1:t.y,x2:n.x,y2:n.y});else{for(var s=t,r=0;r<o.length;r++){var a,l=o[r];l.x==s.x&&l.y==s.y||(a={x1:s.x,y1:s.y,x2:l.x,y2:l.y},i.push(a),s=l)}i.push({x1:s.x,y1:s.y,x2:n.x,y2:n.y})}return i},getLinkerLength:function(e){for(var t=this.getLinkerLinePoints(e),n=0,i=1;i<t.length;i++){var o=t[i-1],s=t[i];n+=Utils.measureDistance(o,s)}return n},getShapesByRange:function(e){var t=[];for(var n in Model.define.elements){var i=Model.getShapeById(n),o=i.props,o="linker"==i.name?this.getLinkerBox(i):this.getShapeBox(i);this.pointInRect(o.x,o.y,e)&&this.pointInRect(o.x+o.w,o.y,e)&&this.pointInRect(o.x+o.w,o.y+o.h,e)&&this.pointInRect(o.x,o.y+o.h,e)&&t.push(i.id)}return t},getControlBox:function(e){for(var t={x1:null,y1:null,x2:null,y2:null},n=0;n<e.length;n++){var i=e[n],o=Model.getShapeById(i),s="linker"==o.name?this.getLinkerBox(o):this.getShapeBox(o);(null==t.x1||s.x<t.x1)&&(t.x1=s.x),(null==t.y1||s.y<t.y1)&&(t.y1=s.y),(null==t.x2||s.x+s.w>t.x2)&&(t.x2=s.x+s.w),(null==t.y2||s.y+s.h>t.y2)&&(t.y2=s.y+s.h)}return{x:t.x1,y:t.y1,w:t.x2-t.x1,h:t.y2-t.y1}},getShapesBounding:function(e){for(var t={x1:null,y1:null,x2:null,y2:null},n=0;n<e.length;n++){var i=e[n],o="linker"==i.name?this.getLinkerBox(i):i.props;(null==t.x1||o.x<t.x1)&&(t.x1=o.x),(null==t.y1||o.y<t.y1)&&(t.y1=o.y),(null==t.x2||o.x+o.w>t.x2)&&(t.x2=o.x+o.w),(null==t.y2||o.y+o.h>t.y2)&&(t.y2=o.y+o.h)}return{x:t.x1,y:t.y1,w:t.x2-t.x1,h:t.y2-t.y1}},getShapeContext:function(e){return Utils.getDomById(e).getElementsByTagName("canvas")[0].getContext("2d")},selectIds:[],selectShape:function(e,t){if("string"==typeof e&&(l=e,(e=[]).push(l)),!(e.length<=0)){for(var n=[],i=0;i<e.length;i++){var o,s=e[i];(d=Model.getShapeById(s)).attribute&&d.attribute.collapseBy||(n.push(s),d.group&&(o=Model.getGroupShapes(d.group),Utils.mergeArray(n,o)))}for(var r=[],i=0;i<n.length;i++){s=n[i];(d=Model.getShapeById(s)).parent&&0==d.resizeDir.length&&r.indexOf(d.parent)<0?r.push(d.parent):r.indexOf(s)<0&&r.push(s)}e=r,Utils.removeAnchors(),Utils.selectIds=[];for(var a=0;a<e.length;a++){var l=e[a],d=Model.getShapeById(l);Utils.selectIds.push(l),"linker"==d.name?this.isLocked(d.id)?Utils.showLockers(d):Model.intersection[d.id]?Designer.painter.renderLinker(d,null,null,Model.intersection[d.id]):Designer.painter.renderLinker(d):this.isLocked(d.id)?Utils.showLockers(d):Utils.showAnchors(d)}var p=!1;1==(r=Utils.getSelectedIds()).length&&"linker"==Model.getShapeById(r[0]).name&&(p=!0,Utils.showLinkerControls()),0<r.length&&!p&&Designer.painter.drawControls(r),void 0===t&&(t=!0),this.selectCallback&&t&&this.selectCallback(),Designer.events.push("selectChanged"),this.showLinkerCursor(),Designer.op.showShapesLen()}},selectCallback:null,unselect:function(){var e=this.selectIds;this.selectIds=[];for(var t=0;t<e.length;t++){var n=e[t],i=Model.getShapeById(n);"linker"==i.name&&(Model.intersection[i.id]?Designer.painter.renderLinker(i,null,null,Model.intersection[i.id]):Designer.painter.renderLinker(i))}$("#shape_controls").hide(),Utils.removeLockers(),Utils.removeAnchors(),Designer.events.push("selectChanged"),this.hideLinkerCursor(),this.hideLinkerControls(),Designer.op.showShapesLen()},getSelected:function(){for(var e=[],t=0;t<this.selectIds.length;t++){var n,i=this.selectIds[t];Utils.isLocked(i)||(n=Model.getShapeById(i),e.push(n))}return e},getSelectedIds:function(){for(var e=[],t=0;t<this.selectIds.length;t++){var n=this.selectIds[t];Utils.isLocked(n)||e.push(n)}return e},getSelectedLinkers:function(){for(var e=[],t=0;t<this.selectIds.length;t++){var n,i=this.selectIds[t];Utils.isLocked(i)||"linker"==(n=Model.getShapeById(i)).name&&e.push(n)}return e},getSelectedLinkerIds:function(){for(var e=[],t=0;t<this.selectIds.length;t++){var n=this.selectIds[t];Utils.isLocked(n)||"linker"==Model.getShapeById(n).name&&e.push(n)}return e},getSelectedShapeIds:function(){for(var e=[],t=0;t<this.selectIds.length;t++){var n=this.selectIds[t];Utils.isLocked(n)||"linker"!=Model.getShapeById(n).name&&e.push(n)}return e},getSelectedLockedIds:function(){for(var e=[],t=0;t<this.selectIds.length;t++){var n=this.selectIds[t];Utils.isLocked(n)&&e.push(n)}return e},getSelectedGroups:function(){for(var e=[],t=0;t<this.selectIds.length;t++){var n=this.selectIds[t],i=Model.getShapeById(n);i.group&&e.indexOf(i.group)<0&&e.push(i.group)}return e},isSelected:function(e){return 0<=this.selectIds.indexOf(e)&&!this.isLocked(e)},selectText:function(e){var t,n;document.body.createTextRange?((n=document.body.createTextRange()).moveToElementText(e),n.select()):window.getSelection&&(t=window.getSelection(),(n=document.createRange()).selectNodeContents(e),t.removeAllRanges(),t.addRange(n))},isLocked:function(e){return!!Model.getShapeById(e).locked},linkerCursorTimer:null,showLinkerCursor:function(){this.hideLinkerCursor();var e=Utils.getSelectedIds();if(1==e.length){var t=Model.getShapeById(e[0]);if("linker"!=t.name){var n=Model.linkerMap.map[t.id];if(n&&n.length){for(var i=[],o=0;o<n.length;o++){var s=n[o],r=Model.getShapeById(s);if(t.id==r.from.id&&r.to.id){var a=this.getLinkerLength(r).toScale(),l=[];if("broken"==r.linkerType){l.push({x:r.from.x.toScale(),y:r.from.y.toScale(),t:0});for(var d=0;d<r.points.length;d++){var p=r.points[d];l.push({x:p.x.toScale(),y:p.y.toScale()})}l.push({x:r.to.x.toScale(),y:r.to.y.toScale()});for(var h=0,d=1;d<l.length;d++){var c=l[d-1],u=l[d];h+=Utils.measureDistance(c,u),u.t=h/a}}Math.floor(a/120);for(var g=3/a,y=120*Math.ceil(a/120)/a,f=0;f<a;){var x={t:f/a,step:g,linker:r,points:l,maxT:y};i.push(x),f+=120}}}this.playLinkerCursor(i)}}}},playLinkerCursor:function(c){for(var e=0;e<c.length;e++){var t=c[e],n=$("<div class='linker_cursor'></div>").appendTo("#designer_canvas"),i=t.linker,o=(Utils.getLinkerLineStyle(i.lineStyle).lineWidth+2).toScale();o<5&&(o=5);var s=o/2;t.half=s,(t.dom=n).css({width:o,height:o,"-webkit-border-radius":s,"-moz-border-radius":s,"-ms-border-radius":s,"-o-border-radius":s,"border-radius":s,"z-index":$("#"+i.id).css("z-index")})}this.linkerCursorTimer=setInterval(function(){for(var e=0;e<c.length;e++){var t=c[e],n=t.linker;t.t>=t.maxT&&(t.t=0,t.dom.show());var i,o,s=t.t;if("broken"==n.linkerType)for(var r=1;r<t.points.length;r++){var a=t.points[r-1],l=t.points[r];if(s>=a.t&&s<l.t){var d=(s-a.t)/(l.t-a.t),p=(1-d)*a.x+d*l.x,h=(1-d)*a.y+d*l.y;t.dom.css({left:p-t.half,top:h-t.half});break}}else h="curve"==n.linkerType?(i=n.from,a=n.points[0],l=n.points[1],o=n.to,p=i.x.toScale()*Math.pow(1-s,3)+a.x.toScale()*s*Math.pow(1-s,2)*3+l.x.toScale()*Math.pow(s,2)*(1-s)*3+o.x.toScale()*Math.pow(s,3),i.y.toScale()*Math.pow(1-s,3)+a.y.toScale()*s*Math.pow(1-s,2)*3+l.y.toScale()*Math.pow(s,2)*(1-s)*3+o.y.toScale()*Math.pow(s,3)):(p=(1-s)*n.from.x.toScale()+s*n.to.x.toScale(),(1-s)*n.from.y.toScale()+s*n.to.y.toScale()),t.dom.css({left:p-t.half,top:h-t.half});t.t+=t.step,1<=t.t&&t.dom.hide()}},30)},hideLinkerCursor:function(){this.linkerCursorTimer&&clearInterval(this.linkerCursorTimer),$(".linker_cursor").remove()},showLinkerControls:function(){this.hideLinkerControls();var e,t=Utils.getSelectedIds(),n=null;function i(l,t){var e=null,n=null,n="from"==t?(e=l.from,l.points[0]):(e=l.to,l.points[1]),i=Utils.measureDistance(e,n).toScale()-6,o={x:(.5*e.x+.5*n.x).toScale(),y:(.5*e.y+.5*n.y).toScale()},s=Utils.getAngle(e,n)+Math.PI/2,r=$("<div class='linker_control_line'></div>").appendTo("#designer_canvas"),d=$("<div class='linker_control_point'></div>").appendTo("#designer_canvas"),a="rotate("+Math.round(s/(2*Math.PI)*360)+"deg)";return r.css({left:o.x,top:o.y-i/2,height:i,"z-index":Model.orderList.length,"-webkit-transform":a,"-ms-transform":a,"-o-transform":a,"-moz-transform":a,transform:a}),d.css({left:n.x.toScale()-4,top:n.y.toScale()-4,"z-index":999999}),d.attr("ty",t),d.unbind().bind("mousedown",function(e){l=Model.getShapeById(l.id);var i=null,i="from"==t?l.points[0]:l.points[1];e.stopPropagation(),d.addClass("moving"),Designer.op.changeState("changing_curve");var o=e.pageX,s=e.pageY,r=0,a=0;null!=l.textPos&&(r=l.textPos.x,a=l.textPos.y),$(document).bind("mousemove.change_curve",function(e){var t,n=Utils.getRelativePos(e.pageX,e.pageY,$("#designer_canvas"));i.x=n.x,i.y=n.y,null!=l.textPos&&(t=Utils.restoreScale({x:e.pageX-o,y:e.pageY-s}),l.textPos.x=r+t.x,l.textPos.y=a+t.y),Designer.painter.renderLinker(l,null,!0),Model.define.elements[l.id]=l,Utils.showLinkerControls(),$(".linker_control_point[ty="+d.attr("ty")+"]").addClass("moving"),$(document).unbind("mouseup.changed_curve").bind("mouseup.changed_curve",function(e){Model.update(l),$(document).unbind("mouseup.changed_curve")})}),$(document).unbind("mouseup.change_curve").bind("mouseup.change_curve",function(e){$(document).unbind("mouseup.change_curve"),$(document).unbind("mousemove.change_curve"),$(".linker_control_point").removeClass("moving"),Designer.op.resetState()})}),d}1!=t.length||"linker"==(e=Model.getShapeById(t[0])).name&&"curve"==e.linkerType&&(n=e),null!=n&&(i(n,"from"),i(n,"to"))},hideLinkerControls:function(){$(".linker_control_line").remove(),$(".linker_control_point").remove()},showAnchors:function(e){if(!(0<$(".shape_contour[forshape="+e.id+"]").length)){var t=$("<div class='shape_contour' forshape='"+e.id+"'></div>").appendTo($("#designer_canvas"));t.css({left:e.props.x.toScale(),top:e.props.y.toScale(),"z-index":Model.orderList.length+1}),Utils.isSelected(e.id)||t.addClass("hovered_contour");for(var n=Designer.config.anchorSize-2,i={"border-color":Designer.config.anchorColor,"border-radius":Designer.config.anchorSize/2,width:n,height:n},o=e.getAnchors(),s={x:e.props.w/2,y:e.props.h/2},r=e.props.angle,a=0;a<o.length;a++){var l=o[a],d=$("<div class='shape_anchor'></div>").appendTo(t),p=this.getRotated(s,l,r);i.left=p.x.toScale()-Designer.config.anchorSize/2,i.top=p.y.toScale()-Designer.config.anchorSize/2,d.css(i)}}},hideAnchors:function(){$(".hovered_contour").remove()},removeAnchors:function(){$(".shape_contour").remove()},showLockers:function(e){var t,n,i=$("#"+e.id),o=i.position();function s(e){var t,n;(t=$("<canvas class='shape_locker' width='10px' height='10px'></canvas>").appendTo(i),(n=t[0].getContext("2d")).strokeStyle="#777",n.lineWidth=1,n.beginPath(),n.moveTo(2,2),n.lineTo(9,9),n.moveTo(2,9),n.lineTo(9,2),n.stroke(),t).css({left:e.x.toScale()-o.left-5,top:e.y.toScale()-o.top-5})}"linker"!=e.name?(n={x:(t=e.props).x+t.w/2,y:t.y+t.h/2},s(this.getRotated(n,{x:t.x,y:t.y},e.props.angle)),s(this.getRotated(n,{x:t.x+t.w,y:t.y},e.props.angle)),s(this.getRotated(n,{x:t.x+t.w,y:t.y+t.h},e.props.angle)),s(this.getRotated(n,{x:t.x,y:t.y+t.h},e.props.angle))):(s(e.from),s(e.to))},removeLockers:function(){$(".shape_locker").remove()},measureDistance:function(e,t){var n=t.y-e.y,i=t.x-e.x;return Math.sqrt(Math.pow(n,2)+Math.pow(i,2))},removeFromArray:function(e,t){var n=e.indexOf(t);return 0<=n&&e.splice(n,1),e},addToArray:function(e,t){return e.indexOf(t)<0&&e.push(t),e},mergeArray:function(e,t){for(var n=0;n<t.length;n++){var i=t[n];e.indexOf(i)<0&&e.push(i)}return e},getCirclePoints:function(e,t,n){for(var i=Math.PI/18,o=[],s=0;s<36;s++){var r=i*s,a={x:e-Math.cos(r)*n,y:t-Math.sin(r)*n,angle:r};o.push(a)}return o},getPointAngle:function(e,t,n,i){var o=$("#"+e).position(),s=Utils.getShapeContext(e),r=Utils.isMac();t=t.toScale()-o.left,n=n.toScale()-o.top;for(var a=this.getCirclePoints(t,n,i),l=a.length,d=!1,p=0;p<l;p++){var h=(u=a[p]).x,c=u.y;r&&(h=2*u.x+4,c=2*u.y+6),s.isPointInPath(h,c)?d=u.inPath=!0:u.inPath=!1}if(0==d)return null;for(var u,g=null,y=null,p=0;p<l;p++){if(!(u=a[p]).inPath)if(null==g&&a[(p-1+l)%l].inPath&&(g=u.angle),null==y&&a[(p+1+l)%l].inPath&&(y=u.angle),null!=g&&null!=y)break}return(g+(2*Math.PI+y-g)%(2*Math.PI)/2)%(2*Math.PI)},getAngleDir:function(e){var t=Math.PI;return t/4<=e&&e<t/4*3?1:t/4*3<=e&&e<t/4*5?2:t/4*5<=e&&e<t/4*7?3:4},getLinkerPoints:function(e){var t,n,i,o,s,r,a,l,d,p,h,c,u,g,y,f,x,v,m,S,w,b,k,M=[];function _(e,t){if(null!=e.id)return{x:e.x-k*Math.cos(e.angle),y:e.y-k*Math.sin(e.angle)};var n=Math.abs(e.y-t.y),i=Math.abs(e.x-t.x),o=Math.atan(n/i),s={};return e.x<=t.x?s.x=e.x+k*Math.cos(o):s.x=e.x-k*Math.cos(o),e.y<=t.y?s.y=e.y+k*Math.sin(o):s.y=e.y-k*Math.sin(o),s}return"broken"==e.linkerType?(t=Math.PI,w=e.from,b=e.to,n=Math.abs(b.x-w.x),i=Math.abs(b.y-w.y),null!=w.id&&null!=b.id?(o=this.getAngleDir(w.angle),s=this.getAngleDir(b.angle),1==o&&1==s?(f=w.y<b.y?(g=w,y=b,!1):(g=b,y=w,!0),d=Model.getShapeById(g.id).props,p=Model.getShapeById(y.id).props,y.x>=d.x-30&&y.x<=d.x+d.w+30?(c=y.x<d.x+d.w/2?d.x-30:d.x+d.w+30,u=g.y-30,M.push({x:g.x,y:u}),u=y.y-30):(u=g.y-30,M.push({x:g.x,y:u})),M.push({x:y.x,y:u})):3==o&&3==s?(f=w.y>b.y?(g=w,y=b,!1):(g=b,y=w,!0),d=Model.getShapeById(g.id).props,p=Model.getShapeById(y.id).props,y.x>=d.x-30&&y.x<=d.x+d.w+30?(u=g.y+30,c=y.x<d.x+d.w/2?d.x-30:d.x+d.w+30,M.push({x:g.x,y:u}),u=y.y+30):(u=g.y+30,M.push({x:g.x,y:u})),M.push({x:y.x,y:u})):2==o&&2==s?(f=w.x>b.x?(g=w,y=b,!1):(g=b,y=w,!0),d=Model.getShapeById(g.id).props,p=Model.getShapeById(y.id).props,y.y>=d.y-30&&y.y<=d.y+d.h+30?(c=g.x+30,u=y.y<d.y+d.h/2?d.y-30:d.y+d.h+30,M.push({x:c,y:g.y}),c=y.x+30):(c=g.x+30,M.push({x:c,y:g.y})),M.push({x:c,y:y.y})):4==o&&4==s?(f=w.x<b.x?(g=w,y=b,!1):(g=b,y=w,!0),d=Model.getShapeById(g.id).props,p=Model.getShapeById(y.id).props,y.y>=d.y-30&&y.y<=d.y+d.h+30?(c=g.x-30,u=y.y<d.y+d.h/2?d.y-30:d.y+d.h+30,M.push({x:c,y:g.y}),c=y.x-30):(c=g.x-30,M.push({x:c,y:g.y})),M.push({x:c,y:y.y})):1==o&&3==s||3==o&&1==s?(f=1==o?(g=w,y=b,!1):(g=b,y=w,!0),d=Model.getShapeById(g.id).props,p=Model.getShapeById(y.id).props,y.y<=g.y?(u=g.y-i/2,M.push({x:g.x,y:u})):(r=d.x+d.w,h=p.x+p.w,u=g.y-30,h>=d.x&&p.x<=r?(S=d.x+d.w/2,c=y.x<S?d.x<p.x?d.x-30:p.x-30:h<r?r+30:h+30,p.y<g.y&&(u=p.y-30)):c=y.x<g.x?h+(d.x-h)/2:r+(p.x-r)/2,M.push({x:g.x,y:u}),M.push({x:c,y:u}),u=y.y+30,M.push({x:c,y:u})),M.push({x:y.x,y:u})):2==o&&4==s||4==o&&2==s?(f=2==o?(g=w,y=b,!1):(g=b,y=w,!0),d=Model.getShapeById(g.id).props,p=Model.getShapeById(y.id).props,y.x>g.x?(c=g.x+n/2,M.push({x:c,y:g.y})):(l=d.y+d.h,a=p.y+p.h,c=g.x+30,a>=d.y&&p.y<=l?(S=d.y+d.h/2,u=y.y<S?d.y<p.y?d.y-30:p.y-30:a<l?l+30:a+30,p.x+p.w>g.x&&(c=p.x+p.w+30)):u=y.y<g.y?a+(d.y-a)/2:l+(p.y-l)/2,M.push({x:c,y:g.y}),M.push({x:c,y:u}),c=y.x-30,M.push({x:c,y:u})),M.push({x:c,y:y.y})):1==o&&2==s||2==o&&1==s?(f=2==o?(g=w,y=b,!1):(g=b,y=w,!0),d=Model.getShapeById(g.id).props,p=Model.getShapeById(y.id).props,y.x>g.x&&y.y>g.y?M.push({x:y.x,y:g.y}):(u=y.x>g.x&&p.x>g.x?(c=p.x-g.x<60?g.x+(p.x-g.x)/2:g.x+30,y.y-30):y.x<=g.x&&y.y>d.y+d.h?(l=d.y+d.h,c=g.x+30,y.y-l<60?l+(y.y-l)/2:y.y-30):(c=(h=p.x+p.w)>g.x?h+30:g.x+30,y.y<d.y?y.y-30:d.y-30),M.push({x:c,y:g.y}),M.push({x:c,y:u}),M.push({x:y.x,y:u}))):1==o&&4==s||4==o&&1==s?(f=4==o?(g=w,y=b,!1):(g=b,y=w,!0),d=Model.getShapeById(g.id).props,h=(p=Model.getShapeById(y.id).props).x+p.w,y.x<g.x&&y.y>g.y?M.push({x:y.x,y:g.y}):(u=y.x<g.x&&h<g.x?(c=g.x-h<60?h+(g.x-h)/2:g.x-30,y.y-30):y.x>=g.x&&y.y>d.y+d.h?(l=d.y+d.h,c=g.x-30,y.y-l<60?l+(y.y-l)/2:y.y-30):(c=p.x<g.x?p.x-30:g.x-30,y.y<d.y?y.y-30:d.y-30),M.push({x:c,y:g.y}),M.push({x:c,y:u}),M.push({x:y.x,y:u}))):2==o&&3==s||3==o&&2==s?(f=2==o?(g=w,y=b,!1):(g=b,y=w,!0),d=Model.getShapeById(g.id).props,p=Model.getShapeById(y.id).props,y.x>g.x&&y.y<g.y?M.push({x:y.x,y:g.y}):(u=y.x>g.x&&p.x>g.x?(c=p.x-g.x<60?g.x+(p.x-g.x)/2:g.x+30,y.y+30):y.x<=g.x&&y.y<d.y?(c=g.x+30,d.y-y.y<60?y.y+(d.y-y.y)/2:y.y+30):(c=(h=p.x+p.w)>g.x?h+30:g.x+30,y.y>d.y+d.h?y.y+30:d.y+d.h+30),M.push({x:c,y:g.y}),M.push({x:c,y:u}),M.push({x:y.x,y:u}))):(3==o&&4==s||4==o&&3==s)&&(f=4==o?(g=w,y=b,!1):(g=b,y=w,!0),d=Model.getShapeById(g.id).props,h=(p=Model.getShapeById(y.id).props).x+p.w,y.x<g.x&&y.y<g.y?M.push({x:y.x,y:g.y}):(u=y.x<g.x&&h<g.x?(c=g.x-h<60?h+(g.x-h)/2:g.x-30,y.y+30):y.x>=g.x&&y.y<d.y?(c=g.x-30,d.y-y.y<60?y.y+(d.y-y.y)/2:y.y+30):(c=p.x<g.x?p.x-30:g.x-30,y.y>d.y+d.h?y.y+30:d.y+d.h+30),M.push({x:c,y:g.y}),M.push({x:c,y:u}),M.push({x:y.x,y:u}))),f&&M.reverse()):null!=w.id||null!=b.id?(x=null!=w.id?(y=b,f=!1,(g=w).angle):(y=w,f=!0,(g=b).angle),v=Model.getShapeById(g.id).props,t/4<=x&&x<t/4*3?y.y<g.y?i<=n?M.push({x:g.x,y:y.y}):(S=i/2,M.push({x:g.x,y:g.y-S}),M.push({x:y.x,y:g.y-S})):(M.push({x:g.x,y:g.y-30}),i<=n?y.x>=v.x-30&&y.x<=v.x+v.w+30?(m=v.x+v.w/2,y.x<m?(M.push({x:v.x-30,y:g.y-30}),M.push({x:v.x-30,y:y.y})):(M.push({x:v.x+v.w+30,y:g.y-30}),M.push({x:v.x+v.w+30,y:y.y}))):y.x<v.x?(M.push({x:y.x+30,y:g.y-30}),M.push({x:y.x+30,y:y.y})):(M.push({x:y.x-30,y:g.y-30}),M.push({x:y.x-30,y:y.y})):y.x>=v.x-30&&y.x<=v.x+v.w+30?(m=v.x+v.w/2,y.x<m?(M.push({x:v.x-30,y:g.y-30}),M.push({x:v.x-30,y:y.y-30})):(M.push({x:v.x+v.w+30,y:g.y-30}),M.push({x:v.x+v.w+30,y:y.y-30})),M.push({x:y.x,y:y.y-30})):M.push({x:y.x,y:g.y-30})):t/4*3<=x&&x<t/4*5?y.x>g.x?i<=n?(S=n/2,M.push({x:g.x+S,y:g.y}),M.push({x:g.x+S,y:y.y})):M.push({x:y.x,y:g.y}):(M.push({x:g.x+30,y:g.y}),i<=n?y.y>=v.y-30&&y.y<=v.y+v.h+30?(m=v.y+v.h/2,y.y<m?(M.push({x:g.x+30,y:v.y-30}),M.push({x:y.x+30,y:v.y-30})):(M.push({x:g.x+30,y:v.y+v.h+30}),M.push({x:y.x+30,y:v.y+v.h+30})),M.push({x:y.x+30,y:y.y})):M.push({x:g.x+30,y:y.y}):y.y>=v.y-30&&y.y<=v.y+v.h+30?(m=v.y+v.h/2,y.y<m?(M.push({x:g.x+30,y:v.y-30}),M.push({x:y.x,y:v.y-30})):(M.push({x:g.x+30,y:v.y+v.h+30}),M.push({x:y.x,y:v.y+v.h+30}))):y.y<g.y?(M.push({x:g.x+30,y:y.y+30}),M.push({x:y.x,y:y.y+30})):(M.push({x:g.x+30,y:y.y-30}),M.push({x:y.x,y:y.y-30}))):t/4*5<=x&&x<t/4*7?y.y>g.y?i<=n?M.push({x:g.x,y:y.y}):(S=i/2,M.push({x:g.x,y:g.y+S}),M.push({x:y.x,y:g.y+S})):(M.push({x:g.x,y:g.y+30}),i<=n?y.x>=v.x-30&&y.x<=v.x+v.w+30?(m=v.x+v.w/2,y.x<m?(M.push({x:v.x-30,y:g.y+30}),M.push({x:v.x-30,y:y.y})):(M.push({x:v.x+v.w+30,y:g.y+30}),M.push({x:v.x+v.w+30,y:y.y}))):y.x<v.x?(M.push({x:y.x+30,y:g.y+30}),M.push({x:y.x+30,y:y.y})):(M.push({x:y.x-30,y:g.y+30}),M.push({x:y.x-30,y:y.y})):y.x>=v.x-30&&y.x<=v.x+v.w+30?(m=v.x+v.w/2,y.x<m?(M.push({x:v.x-30,y:g.y+30}),M.push({x:v.x-30,y:y.y+30})):(M.push({x:v.x+v.w+30,y:g.y+30}),M.push({x:v.x+v.w+30,y:y.y+30})),M.push({x:y.x,y:y.y+30})):M.push({x:y.x,y:g.y+30})):y.x<g.x?i<=n?(S=n/2,M.push({x:g.x-S,y:g.y}),M.push({x:g.x-S,y:y.y})):M.push({x:y.x,y:g.y}):(M.push({x:g.x-30,y:g.y}),i<=n?y.y>=v.y-30&&y.y<=v.y+v.h+30?(m=v.y+v.h/2,y.y<m?(M.push({x:g.x-30,y:v.y-30}),M.push({x:y.x-30,y:v.y-30})):(M.push({x:g.x-30,y:v.y+v.h+30}),M.push({x:y.x-30,y:v.y+v.h+30})),M.push({x:y.x-30,y:y.y})):M.push({x:g.x-30,y:y.y}):y.y>=v.y-30&&y.y<=v.y+v.h+30?(m=v.y+v.h/2,y.y<m?(M.push({x:g.x-30,y:v.y-30}),M.push({x:y.x,y:v.y-30})):(M.push({x:g.x-30,y:v.y+v.h+30}),M.push({x:y.x,y:v.y+v.h+30}))):y.y<g.y?(M.push({x:g.x-30,y:y.y+30}),M.push({x:y.x,y:y.y+30})):(M.push({x:g.x-30,y:y.y-30}),M.push({x:y.x,y:y.y-30}))),f&&M.reverse()):i<=n?(S=(b.x-w.x)/2,M.push({x:w.x+S,y:w.y}),M.push({x:w.x+S,y:b.y})):(S=(b.y-w.y)/2,M.push({x:w.x,y:w.y+S}),M.push({x:b.x,y:w.y+S}))):"curve"==e.linkerType&&(w=e.from,b=e.to,k=.4*this.measureDistance(w,b),M.push(_(w,b)),M.push(_(b,w))),M},getLinkerLinePoints:function(e){var t=[];if("curve"!=e.linkerType)t.push(e.from),t=t.concat(e.points);else for(var n=0;n<=1;){var i={x:(1-n)*(1-n)*(1-n)*e.from.x+3*(1-n)*(1-n)*n*e.points[0].x+3*(1-n)*n*n*e.points[1].x+n*n*n*e.to.x,y:(1-n)*(1-n)*(1-n)*e.from.y+3*(1-n)*(1-n)*n*e.points[0].y+3*(1-n)*n*n*e.points[1].y+n*n*n*e.to.y};t.push(i),n+=.05}return t.push(e.to),t},getLinkerLinesPoints:function(e){var t=[],n=0;if("broken"==e.linkerType){var i=[];i.push(e.from),(i=i.concat(e.points)).push(e.to);for(var o=1;o<i.length;o++)for(var s=i[o],r=i[o-1],n=0;n<=1;){var a={x:r.x*(1-n)+s.x*n,y:r.y*(1-n)+s.y*n};t.push(a),n+=.05}}if("normal"==e.linkerType)for(;n<1;){a={x:e.from.x*(1-n)+e.to.x*n,y:e.from.y*(1-n)+e.to.y*n};t.push(a),n+=.05}else for(;n<1;){a={x:(1-n)*(1-n)*(1-n)*e.from.x+3*(1-n)*(1-n)*n*e.points[0].x+3*(1-n)*n*n*e.points[1].x+n*n*n*e.to.x,y:(1-n)*(1-n)*(1-n)*e.from.y+3*(1-n)*(1-n)*n*e.points[0].y+3*(1-n)*n*n*e.points[1].y+n*n*n*e.to.y};t.push(a),n+=.05}return t},getLinkerBox:function(e){for(var t=this.getLinkerLinePoints(e),n=t[0].x,i=t[0].y,o=t[0].x,s=t[0].y,r=0;r<t.length;r++){var a=t[r];a.x<n?n=a.x:a.x>o&&(o=a.x),a.y<i?i=a.y:a.y>s&&(s=a.y)}return{x:n,y:i,w:o-n,h:s-i}},getShapeBox:function(e){var t=e.props,n=e.props.angle;return this.getRotatedBox(t,n)},getRotatedBox:function(e,t,n){if(0==t)return e;n=n||{x:e.x+e.w/2,y:e.y+e.h/2};var i=this.getRotated(n,{x:e.x,y:e.y},t),o=this.getRotated(n,{x:e.x+e.w,y:e.y},t),s=this.getRotated(n,{x:e.x+e.w,y:e.y+e.h},t),r=this.getRotated(n,{x:e.x,y:e.y+e.h},t),a=Math.min(i.x,o.x,s.x,r.x),l=Math.max(i.x,o.x,s.x,r.x),d=Math.min(i.y,o.y,s.y,r.y);return{x:a,y:d,w:l-a,h:Math.max(i.y,o.y,s.y,r.y)-d}},getRotated:function(e,t,n){var i=this.measureDistance(e,t);if(0==i||0==n)return t;var o=Math.atan(Math.abs(t.x-e.x)/Math.abs(e.y-t.y));t.x>=e.x&&t.y>=e.y?o=Math.PI-o:t.x<=e.x&&t.y>=e.y?o=Math.PI+o:t.x<=e.x&&t.y<=e.y&&(o=2*Math.PI-o);var s=((o%=2*Math.PI)+n)%(2*Math.PI);return{x:e.x+Math.sin(s)*i,y:e.y-Math.cos(s)*i}},getShapeAnchorInLinker:function(e){for(var t=e.getAnchors(),n=[],i={x:e.props.x+e.props.w/2,y:e.props.y+e.props.h/2},o=0;o<t.length;o++){var s=t[o],r={x:s.x+e.props.x,y:s.y+e.props.y},a=this.getRotated(i,r,e.props.angle);n.push(a)}for(var l=[],d=2,p=Model.orderList.length-1;0<=p;p--){var h=Model.orderList[p].id,c=Model.getShapeById(h);if(!("linker"!=c.name||c.attribute&&c.attribute.collapseBy)){for(var u=c,g=null,d=3,o=0;o<n.length;o++){var y={x:(f=n[o]).x-d,y:f.y-d,w:2*d,h:2*d};if(null==u.from.id&&this.pointInRect(u.from.x,u.from.y,y)){g={linker:u,anchors:[f],type:"from"};break}if(null==u.to.id&&this.pointInRect(u.to.x,u.to.y,y)){g={linker:u,anchors:[f],type:"to"};break}}if(d=2,null==g)for(o=0;o<n.length;o++){var f=n[o];-1<Utils.pointInLinker(f,u,d)&&(null==g&&(g={linker:u,anchors:[],type:"line"}),g.anchors.push(f))}null!=g&&l.push(g)}}return l},getEndpointAngle:function(e,t){var n,i,o,s="from"==t?e.from:e.to;return o="normal"==e.linkerType?"from"==t?e.to:e.from:"broken"==e.linkerType?"from"==t?e.points[0]:e.points[e.points.length-1]:(n=Utils.measureDistance(e.from,e.to),{x:(1-(i="from"==t?12/n:1-12/n))*(1-i)*(1-i)*e.from.x+3*(1-i)*(1-i)*i*e.points[0].x+3*(1-i)*i*i*e.points[1].x+i*i*i*e.to.x,y:(1-i)*(1-i)*(1-i)*e.from.y+3*(1-i)*(1-i)*i*e.points[0].y+3*(1-i)*i*i*e.points[1].y+i*i*i*e.to.y}),this.getAngle(o,s)},getAngle:function(e,t){var n=Math.atan(Math.abs(e.y-t.y)/Math.abs(e.x-t.x)),n=isNaN(n)?1.5707963267948966:n;return t.x<=e.x&&t.y>e.y?n=Math.PI-n:t.x<e.x&&t.y<=e.y?n=Math.PI+n:t.x>=e.x&&t.y<e.y&&(n=2*Math.PI-n),n},getDarkerColor:function(e,t){t=t||13;var n=e.split(","),i=parseInt(n[0]),o=parseInt(n[1]),s=parseInt(n[2]),r=Math.round(i-i/255*t);r<0&&(r=0);var a=Math.round(o-o/255*t);a<0&&(a=0);var l=Math.round(s-s/255*t);return l<0&&(l=0),r+","+a+","+l},getDarkestColor:function(e){return this.getDarkerColor(e,26)},toScale:function(e){var t={};for(var n in e)t[n]=e[n],"number"==typeof e[n]&&(t[n]=t[n].toScale());return t},restoreScale:function(e){var t={};for(var n in e)t[n]=e[n],"number"==typeof e[n]&&(t[n]=t[n].restoreScale());return t},getOutlinkers:function(e){for(var t=[],n=0;n<e.length;n++){var i=e[n];t.push(i.id)}for(var o=[],s=[],n=0;n<e.length;n++){if("linker"!=(i=e[n]).name){var r=Model.getShapeLinkers(i.id);if(r&&0<r.length)for(var a=0;a<r.length;a++){var l=r[a];!this.isSelected(l)&&s.indexOf(l)<0&&t.indexOf(l)<0&&(o.push(Model.getShapeById(l)),s.push(l))}}}return o},getFamilyShapes:function(e){for(var t=[],n=0;n<e.length;n++){var i,o,s,r=e[n];"linker"!=r.name&&(r.parent&&(i=Model.getShapeById(r.parent),Utils.isSelected(r.parent)||t.push(i),o=this.getChildrenShapes(i),t=t.concat(o)),s=this.getChildrenShapes(r),t=t.concat(s))}return t},getChildrenShapes:function(e){var t=[];if(e.children&&0<e.children.length)for(var n=0;n<e.children.length;n++){var i=e.children[n];Utils.isSelected(i)||t.push(Model.getShapeById(i))}return t},isFamilyShape:function(e,t){return e.parent==t.id||(e.id==t.parent||!(!e.parent||e.parent!=t.parent))},getContainedShapes:function(e){for(var t=[],r=[],n=0;n<e.length;n++){var i,o=e[n];"linker"!=o.name&&o.attribute&&o.attribute.container&&(i=function(e){for(var t=[],n=Model.orderList.length-1;0<=n;n--){var i,o,s=Model.orderList[n].id;e.id!=s&&!Utils.isSelected(s)&&r.indexOf(s)<0&&((i=Model.getShapeById(s)).attribute&&void 0!==i.attribute.container&&0!=i.attribute.container||Utils.isFamilyShape(i,e)||(o=Utils.getShapeBox(i),Utils.rectInRect(o,e.props)&&i.container==e.id&&(t.push(i),r.push(s))))}return t}(o),t=t.concat(i))}return t},getAttachedShapes:function(e){for(var t=[],n=0;n<e.length;n++)t.push(e[n].id);for(var i=[],n=0;n<e.length;n++){var o=e[n];if("task"==o.groupName||"callActivity"==o.groupName||"subProcess"==o.groupName){for(var s=[],r=Model.orderList.length-1;0<=r;r--){var a=Model.orderList[r].id,l=Model.getShapeById(a);l.attachTo==o.id&&!Utils.isSelected(a)&&t.indexOf(a)<0&&s.push(l)}i=i.concat(s)}}return i},copy:function(e){return $.extend(!0,{},e)},copyArray:function(e){return $.extend(!0,[],e)},rangeChildren:function(e){var t=[];if(e.children&&0<e.children.length)if("verticalPool"==e.name){for(var n=[],i=[],o=0;o<e.children.length;o++){var s=e.children[o];"horizontalSeparator"==(p=Model.getShapeById(s)).name?i.push(p):n.push(p)}n.sort(function(e,t){return e.props.x-t.props.x});for(var r=e.props.x,o=0;o<n.length;o++){(p=n[o]).props.x=r,Designer.painter.renderShape(p),t.push(p),r+=p.props.w}i.sort(function(e,t){return e.props.y-t.props.y});for(var a=e.props.y+40,o=0;o<i.length;o++){var l=(p=i[o]).props.y+p.props.h;p.props.w=e.props.w;var d=l-(p.props.y=a);p.props.h=d,Designer.painter.renderShape(p),t.push(p),a+=d}}else if("horizontalPool"==e.name){for(n=[],i=[],o=0;o<e.children.length;o++){s=e.children[o];"verticalSeparator"==(p=Model.getShapeById(s)).name?i.push(p):n.push(p)}n.sort(function(e,t){return e.props.y-t.props.y});for(a=e.props.y,o=0;o<n.length;o++){(p=n[o]).props.y=a,Designer.painter.renderShape(p),t.push(p),a+=p.props.h}i.sort(function(e,t){return e.props.x-t.props.x});for(r=e.props.x+40,o=0;o<i.length;o++){var p,h=(p=i[o]).props.x+p.props.w;p.props.h=e.props.h;var c=h-(p.props.x=r);p.props.w=c,Designer.painter.renderShape(p),t.push(p),r+=c}}return t},getRelativePos:function(e,t,n){var i=n.offset();return null==i&&(i={left:0,top:0}),{x:e-i.left+n.scrollLeft(),y:t-i.top+n.scrollTop()}},getCollapsedShapes:function(e){for(var t=[],n=[],i=0;i<e.length;i++){var o=e[i];if(o.attribute&&o.attribute.collapsed){for(var s=[],r=Model.orderList.length-1;0<=r;r--){var a=Model.orderList[r].id,l=Model.getShapeById(a);l.attribute&&l.attribute.collapseBy==o.id&&n.indexOf(a)<0&&s.push(l)}t=t.concat(s)}}return t},getCollapsedShapesById:function(e){for(var t=[],n=Model.orderList.length-1;0<=n;n--){var i=Model.orderList[n].id,o=Model.getShapeById(i);o.attribute&&o.attribute.collapseBy==e&&t.push(o)}return t},getShapeLineStyle:function(e,t){return 0!=t&&Model.define.theme&&Model.define.theme.shape?$.extend({},Schema.shapeDefaults.lineStyle,Model.define.theme.shape.lineStyle,e):$.extend({},Schema.shapeDefaults.lineStyle,e)},getLinkerLineStyle:function(e,t){return 0!=t&&Model.define.theme&&Model.define.theme.linker?$.extend({},Schema.linkerDefaults.lineStyle,Model.define.theme.linker.lineStyle,e):$.extend({},Schema.linkerDefaults.lineStyle,e)},getShapeFontStyle:function(e,t){return 0!=t&&Model.define.theme&&Model.define.theme.shape?$.extend({},Schema.shapeDefaults.fontStyle,Model.define.theme.shape.fontStyle,e):$.extend({},Schema.shapeDefaults.fontStyle,e)},getLinkerFontStyle:function(e,t){return 0!=t&&Model.define.theme&&Model.define.theme.linker?$.extend({},Schema.linkerDefaults.fontStyle,Model.define.theme.linker.fontStyle,e):$.extend({},Schema.linkerDefaults.fontStyle,e)},getShapeFillStyle:function(e,t){return 0!=t&&Model.define.theme&&Model.define.theme.shape?$.extend({},Schema.shapeDefaults.fillStyle,Model.define.theme.shape.fillStyle,e):$.extend({},Schema.shapeDefaults.fillStyle,e)},containsChinese:function(e){return 0<=escape(e).indexOf("%u")},filterXss:function(e){return e=(e=(e=(e=(e=(e=(e=e.toString()).replace(/</g,"&lt;")).replace(/%3C/g,"&lt;")).replace(/>/g,"&gt;")).replace(/%3E/g,"&gt;")).replace(/'/g,"&#39;")).replace(/"/g,"&quot;")},showError:function(){var e=$("#canvas-error");e.length&&(e=$("<div id='canvas-error'><span>保存出现了异常，为了防止内容丢失，请及时刷新页面或者反馈问题</span></div>").appendTo("body")).show()},RGB2Hex:function(e){if("#"==e.charAt(0))return e;var t=e.split(/\D+/),n=65536*Number(t[1])+256*Number(t[2])+Number(t[3]);return""+Utils.toHex(n,6)},toHex:function(e,t){for(var n=e.toString(16);n.length<t;)n="0"+n;return n},popEditor:{params:{span:null,range:null,selection:null},close:function(){$(".pop-editor").hide()},init:function(e){e=$(e);var t,n=this.getSelection();null!=n&&(this.params.range=n.range,this.params.selection=n.selection,t=this.renderMenu(),this.renderMenuPos(e),this.initEvent(t))},getSelection:function(){var e=document.getSelection();return e.isCollapsed?null:{selection:e,range:e.getRangeAt(0)}},initEvent:function(i){var o=this;(i=$(".pop-editor")).children("div").off("mousedown").on("mousedown",function(e){var t=$(this),n=t.data("key");if("down"==n)i.find(".pop-editor-items").hide(),t.find(".pop-editor-items").show();else{if("color"==n)return e.stopPropagation(),e.preventDefault(),void $.colorpicker({target:t,onSelect:function(e){null==(e="rgb("+e+")")&&(e="transparent"),0<=e.indexOf("rgb")&&(e=Utils.RGB2Hex(e)),o.setStyle("ForeColor",e)}});o.setStyle(n)}e.preventDefault(),e.stopPropagation()}),i.children("div").off("mouseup").on("mouseup",function(e){e.stopPropagation(),e.preventDefault()}),i.find(".pop-editor-items > div").off("mousedown").on("mousedown",function(e){var t=$(this),n=t.parent().data("key"),i=t.text();o.setStyle(n,i);return e.stopPropagation(),!1})},renderMenu:function(){var e=$(".pop-editor");return 0==e.length&&(e=$("<div class='pop-editor'><div data-key='bold'><div class='ico bold'></div></div><div data-key='italic'><div class='ico italic'></div></div><div data-key='underline'><div class='ico underline'></div></div><div data-key='color'><div class='ico fontcolor'></div></div>").appendTo("#designer_canvas")),e},renderMenuPos:function(e){var t=e,n=$(".pop-editor"),i=parseFloat(t.css("left")),o=parseFloat(t.css("top"));n.css({left:i+(t.outerWidth()/2-n.outerWidth()/2),top:o+t.outerHeight().toScale()}).show()},setStyle:function(e,t){this.params;switch(e){case"h":document.execCommand("formatBlock",!1,"<"+t+">");break;case"f":document.execCommand("FontName",!1,t);break;default:document.execCommand(e,!1,t)}return""}},vip:{vipInfo:0,vipLimitType:"",privilegeConfig:{shapeCount:59,vip_shapeCount:179,download:["jpg","pdf","image"],vip_download:["png","svg"],brand:!0,vip_brand:!1,screenshot:!1,vip_screenshot:!0,schema:["flowchart"],vip_schema:["flow","uml_common","uml_usecase","uml_sequence","uml_class","uml_stateactivity","uml_deployment","uml_component","bpmn","venn","lane","evc","epc","er","ui","ui_input","org"],quickBeautify:!1,vip_quickBeautify:!0,crossLine:!1,vip_crossLine:!0,insertImage:!1,vip_insertImage:!0},checkPrivilege:function(e,t){var n=this,i="";switch(t&&(n.vipLimitType=t.type),e){case"shapeCount":var o=Object.keys(Model.define.elements).length;if(console.log(o),o<n.privilegeConfig.shapeCount){o==n.privilegeConfig.shapeCount-20&&Utils.testVipState(function(){-1==tdocVipInfo.indexOf(20)&&-1==tdocVipInfo.indexOf(30)&&-1==tdocVipInfo.indexOf(40)&&Designer.events.push("vip-limit-warn","addtopic_free")},"addtopic");break}if(o>n.privilegeConfig.shapeCount&&o<n.privilegeConfig.vip_shapeCount){Utils.testVipState(function(){-1==tdocVipInfo.indexOf(20)&&-1==tdocVipInfo.indexOf(30)&&-1==tdocVipInfo.indexOf(40)?Designer.events.push("vip-limit","addShape"):o==n.privilegeConfig.vip_shapeCount-20&&-1==tdocVipInfo.indexOf(30)&&-1==tdocVipInfo.indexOf(40)&&Designer.events.push("vip-limit-warn","addtopic_vip")},"addShape"),-1==tdocVipInfo.indexOf(20)&&-1==tdocVipInfo.indexOf(30)&&-1==tdocVipInfo.indexOf(40)&&(i="over");break}if(o>n.privilegeConfig.vip_shapeCount){-1==tdocVipInfo.indexOf(30)&&-1==tdocVipInfo.indexOf(40)&&Designer.events.push("vip-limit","addShape_svip"),-1==tdocVipInfo.indexOf(30)&&-1==tdocVipInfo.indexOf(40)&&(i="over");break}break;case"download":var s=t.type||"png";if(Utils.testVipState(function(){!tdoc_is_vip&&n.privilegeConfig.download.indexOf(s)<0&&Designer.events.push("vip-limit","download")}),!tdoc_is_vip&&n.privilegeConfig.download.indexOf(s)<0){i="over";break}break;case"screenshot":if(Utils.testVipState(function(){-1==tdocVipInfo.indexOf(20)&&-1==tdocVipInfo.indexOf(30)&&-1==tdocVipInfo.indexOf(40)&&Designer.events.push("vip-limit","screenshot")},"screenshot"),-1!=tdocVipInfo.indexOf(20)||-1!=tdocVipInfo.indexOf(30)||-1!=tdocVipInfo.indexOf(40))break;i="over";break;case"schema":var r=t.type||"";if(Utils.testVipState(function(){!tdoc_is_vip&&n.privilegeConfig.schema.indexOf(r)<0&&Designer.events.push("vip-limit","schema")}),!tdoc_is_vip&&n.privilegeConfig.schema.indexOf(r)<0){i="over";break}break;case"quickBeautify":if(Utils.testVipState(function(){tdoc_is_vip||n.privilegeConfig.quickBeautify||Designer.events.push("vip-limit","quickBeautify")}),tdoc_is_vip||n.privilegeConfig.quickBeautify)break;i="over";break;case"crossLine":if(Utils.testVipState(function(){tdoc_is_vip||n.privilegeConfig.crossLine||Designer.events.push("vip-limit","crossLine")}),tdoc_is_vip||n.privilegeConfig.crossLine)break;i="over";break;case"insertImage":if(Utils.testVipState(function(){tdoc_is_vip||n.privilegeConfig.insertImage||Designer.events.push("vip-limit","insertImage")}),tdoc_is_vip||n.privilegeConfig.insertImage)break;i="over"}return i}},checkWebsocket:"notcreat",testVipState:function(t,e){var n=this;if(e&&(-1<tdocVipInfo.indexOf(20)||-1<tdocVipInfo.indexOf(40))&&mind.events.push("po-vip-limit",e),void 0===t&&(t=function(){}),"undefined"!=typeof vipPreTime){var i=(new Date).getTime();if(i-vipPreTime<12e4)return void t();vipPreTime=i}else vipPreTime=(new Date).getTime();var o=this.deviceIdentify();"tdocyun"==o&&$.ajax({url:"/user/query",type:"POST",data:{user_id:userId,encrypted_session:encrypted_session,client_id:client_id,file_id:file_id,trace_id:trace_id},success:function(e){"error"!=e.result&&(n.wpsVipInit(e),Designer.events.push("setUpgradeBtn")),t()},error:function(){t()}})},wpsVipInit:function(e){if(tdocVipInfo=[],e){tdocVipInfo=[];var t=e.tdoc_is_svip,n=e.tdoc_is_vip,i=e.tdoc_type,o=e.has_vip_expansion;return 2==i?(tdocVipInfo.push(40),void tdocVipInfo.push(100)):3==i?void tdocVipInfo.push(101):(n&&tdocVipInfo.push(20),n&&o&&tdocVipInfo.push(30),t&&tdocVipInfo.push(40),void(n||t||tdocVipInfo.push(10)))}tdocVipInfo.push(10)},deviceIdentify:function(){return"tdocyun"}},GradientHelper={createLinearGradient:function(e,t,n){var i,o,s,r=e.props,a=r.w>r.h?(o={x:0,y:r.h/2},s={x:r.w,y:r.h/2},(n.angle+Math.PI/2)%(2*Math.PI)):(o={x:r.w/2,y:0},s={x:r.w/2,y:r.h},n.angle);0!=a&&(i={x:r.w/2,y:r.h/2},o=Utils.getRotated(i,o,a),s=Utils.getRotated(i,s,a),o.x<0&&(o.x=0),o.x>e.props.w&&(o.x=e.props.w),o.y<0&&(o.y=0),o.y>e.props.h&&(o.y=e.props.h),s.x<0&&(s.x=0),s.x>e.props.w&&(s.x=e.props.w),s.y<0&&(s.y=0),s.y>e.props.h&&(s.y=e.props.h));var l=t.createLinearGradient(o.x,o.y,s.x,s.y);return l.addColorStop(0,"rgb("+n.beginColor+")"),l.addColorStop(1,"rgb("+n.endColor+")"),l},createRadialGradient:function(e,t,n){var i=e.props,o=i.h;i.w<i.h&&(o=i.w);var s=t.createRadialGradient(i.w/2,i.h/2,10,i.w/2,i.h/2,o*n.radius);return s.addColorStop(0,"rgb("+n.beginColor+")"),s.addColorStop(1,"rgb("+n.endColor+")"),s},getLighterColor:function(e){var t=e.split(","),n=parseInt(t[0]),i=parseInt(t[1]),o=parseInt(t[2]),s=Math.round(n+(255-n)/255*60);255<s&&(s=255);var r=Math.round(i+(255-i)/255*60);255<r&&(r=255);var a=Math.round(o+(255-o)/255*60);return 255<a&&(a=255),s+","+r+","+a},getDarkerColor:function(e){var t=e.split(","),n=parseInt(t[0]),i=parseInt(t[1]),o=parseInt(t[2]),s=Math.round(n-n/255*60);s<0&&(s=0);var r=Math.round(i-i/255*60);r<0&&(r=0);var a=Math.round(o-o/255*60);return a<0&&(a=0),s+","+r+","+a}},MessageSource={batchSize:0,messages:[],withUndo:!0,withMessage:!0,withDock:!0,undoStack:{stack:[],push:function(e,t){this.stack.push(e),void 0===t&&(t=!0),t&&(MessageSource.redoStack.stack=[]),Designer.events.push("undoStackChanged",this.stack.length)},pop:function(){var e=this.stack.length;if(0==e)return null;var t=this.stack[e-1];return this.stack.splice(e-1,1),MessageSource.redoStack.push(t),Designer.events.push("undoStackChanged",this.stack.length),t}},redoStack:{stack:[],push:function(e){this.stack.push(e),Designer.events.push("redoStackChanged",this.stack.length)},pop:function(){var e=this.stack.length;if(0==e)return null;var t=this.stack[e-1];return this.stack.splice(e-1,1),MessageSource.undoStack.push(t,!1),Designer.events.push("redoStackChanged",this.stack.length),t}},beginBatch:function(){this.batchSize++},commit:function(){this.batchSize--,this.submit()},submit:function(){if(0==this.batchSize&&0!=this.messages.length){if(this.withDock&&Dock.update(!0),0==this.withMessage)return void(this.messages=[]);var e;this.withUndo&&this.undoStack.push(this.messages),""!=chartId&&(e={action:"command",messages:this.messages,name:userName},CLB.send(e)),this.messages=[]}},send:function(e,t){this.messages.push({action:e,content:t}),this.submit()},receive:function(e){this.doWithoutMessage(function(){MessageSource.executeMessages(e,!0),Utils.showLinkerControls(),Utils.showLinkerCursor()})},undo:function(){var r=this.undoStack.pop();null!=r&&this.doWithoutUndo(function(){MessageSource.beginBatch();for(var e=0;e<r.length;e++){var t=r[e];if("create"==t.action)Utils.unselect(),Model.remove(t.content,!1),$(".shape_dashboard.menu").hide(),Designer.events.push("changeLinkers");else if("update"==t.action){var n=t.content.shapes;Model.updateMulti(n);for(var i=0;i<n.length;i++){var o=n[i];Designer.painter.renderShape(o)}var s=Utils.getSelectedIds();Utils.unselect(),Utils.selectShape(s,!1),Designer.events.push("changeLinkers")}else if("remove"==t.action){n=t.content;Model.addMulti(n);for(i=0;i<n.length;i++){o=n[i];Designer.painter.renderShape(o)}Designer.events.push("changeLinkers")}else"updatePage"==t.action?Model.updatePage(t.content.page):"setTheme"==t.action?(Model.setTheme(t.content.theme),Designer.events.push("changeLinkers")):"setDefaultStyle"==t.action?Model.setDefaultStyle(t.content.type,t.content.style):"clearDefaultStyle"==t.action?Model.setDefaultStyle("all",t.content.style):"update_with_beautify"==t.action&&Model.updateWithBeautify(t.content.content,t.content.updates,t.content.oldTheme)}MessageSource.commit()})},redo:function(){var e=this.redoStack.pop();null!=e&&this.doWithoutUndo(function(){MessageSource.executeMessages(e,!1)})},executeMessages:function(e,t){MessageSource.beginBatch();for(var n=0;n<e.length;n++){var i=e[n];if("create"==i.action){var o=i.content;if(t)for(var s=0;s<o.length;s++){"linker"!=(r=o[s]).name&&Schema.initShapeFunctions(r)}Model.addMulti(o);for(s=0;s<o.length;s++){var r=o[s];Designer.painter.renderShape(r)}Model.build(),Designer.events.push("changeLinkers")}else if("update"==i.action){for(var a=i.content.updates,s=0;s<a.length;s++){var l=a[s];t&&"linker"!=l.name&&Schema.initShapeFunctions(l),Designer.painter.renderShape(l)}Model.updateMulti(a);var d=Utils.getSelectedIds();Utils.unselect(),Utils.selectShape(d),Designer.events.push("changeLinkers")}else"remove"==i.action?(Utils.unselect(),Model.remove(i.content),Designer.events.push("changeLinkers"),0==Utils.getSelected().length&&$("#shape_text_edit").length&&$("#shape_text_edit").remove()):"updatePage"==i.action?Model.updatePage(i.content.update):"setTheme"==i.action?(Model.setTheme(i.content.update),Designer.events.push("changeLinkers")):"setDefaultStyle"==i.action?Model.setDefaultStyle(i.content.type,i.content.update):"clearDefaultStyle"==i.action?Model.clearDefaultStyle():"update_with_beautify"==i.action&&Model.updateWithBeautify(i.content.updates,i.content.content,i.content.theme)}MessageSource.commit()},doWithoutUndo:function(e){this.withUndo=!1,e(),this.withUndo=!0},doWithoutMessage:function(e){this.withMessage=!1,e(),this.withMessage=!0},doWithoutUpdateDock:function(e){this.withDock=!1,e(),this.withDock=!0}};Number.prototype.toScale=function(){return this*Designer.config.scale},Number.prototype.restoreScale=function(){return this/Designer.config.scale},Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var n in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),t)new RegExp("("+n+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[n]:("00"+t[n]).substr((""+t[n]).length)));return e};var bigPipe={jsVersion:"",cssVersion:"",count:0,jsCounter:0,render:function(e,t){for(var n=document.getElementsByTagName("script"),i=document.getElementsByTagName("link"),o=0;o<n.length;o++){if((r=n[o].getAttribute("src"))&&0<=r.indexOf("/assets/js/")){if(r.indexOf("-")<0)break;var s=r.substring(r.indexOf("-"),r.indexOf(".js"));bigPipe.jsVersion=s;break}}for(var r,o=0;o<i.length;o++){if((r=i[o].getAttribute("href"))&&0<=r.indexOf("/assets/css/")){if(r.indexOf("-")<0)break;s=r.substring(r.indexOf("-"),r.indexOf(".css"));bigPipe.cssVersion=s;break}}var a=e.css||[],l=e.js||[];this.jsCounter=l.length;for(o=0;o<a.length;o++){var d=a[o];this.renderCss(d)}for(var o=0,p=l.length;o<p;o++){var h=l[o];this.renderJs(h,t)}},renderCss:function(e){var t=document,n=this.cssVersion,i=t.createElement("link");i.setAttribute("rel","stylesheet"),i.setAttribute("type","text/css"),0<=e.indexOf("http")&&(n=""),e=e.replace(".css",n+".css"),i.setAttribute("href",e);var o=t.getElementsByTagName("head");o.length?o[0].appendChild(i):t.documentElement.appendChild(i)},renderJs:function(e,t){var n=document,i=this.jsVersion,o=n.createElement("script");0<=e.indexOf("http")&&(i=""),o.setAttribute("type","text/javascript"),e=e.replace(".js",i+".js"),o.setAttribute("src",e),o.setAttribute("charset","UTF-8"),n.body.appendChild(o),o.onload=function(){bigPipe.count++,bigPipe.handle(t)}},handle:function(e){this.count==this.jsCounter&&(null!=e&&e(),this.count=0,this.jsCounter=0)},init:function(){var e=!1;$(document).off("mousemove.ck").on("mousemove.ck",function(){e||null==sessionStorage.getItem("usid")&&($.get("/popular/init",function(e){var t=e.sid;sessionStorage.setItem("usid",t)}),e=!0)})}};