$(function(){CLB.init()});var PoNetwork={preStatus:"online",offlineCallback:null,onlineCallback:null,onlineVal:"online",offlineVal:"offline",intervalTime:1e4,networkTimer:null,imgExpireLoadTime:5e3,imgTimeoutTimer:null,imgTimeoutTimer2:null,init:function(e){e=e||{},PoNetwork.offlineHandlePub=e.offlineHandle,PoNetwork.onlineHandlePub=e.onlineHandle,e.onlineChange&&(PoNetwork.onlineChangePub=e.onlineChange),PoNetwork.networkTimer&&clearInterval(PoNetwork.networkTimer),PoNetwork.networkTimer=setInterval(function(){PoNetwork.test()},PoNetwork.intervalTime),window.addEventListener("offline",PoNetwork.offlineFc(),!1),window.addEventListener("online",PoNetwork.onlineFc(),!1),Object.defineProperty(PoNetwork,"status",{get:function(){return this.preStatus},set:function(e){"offline"==e&&"online"==this.preStatus&&(console.log("offline set"),PoNetwork.offlineChange()),"online"==e&&"offline"==this.preStatus&&(console.log("online set"),PoNetwork.onlineChange()),this.preStatus=e}})},onlineChange:function(){this.onlineChangePub&&this.onlineChangePub()},offlineChange:function(){},offlineHandle:function(){"undefined"==typeof offlineMask&&(offlineMask=!1),offlineMask||PoNetwork.openDialog(),offlineMask=!0,PoNetwork.offlineHandlePub&&PoNetwork.offlineHandlePub(),this.offlineCallback&&this.offlineCallback()},onlineHandle:function(){"undefined"==typeof offlineMask&&(offlineMask=!1),offlineMask&&PoNetwork.closeDialog(),offlineMask=!1,PoNetwork.onlineCallback&&(console.log("onlineCallback"),PoNetwork.onlineCallback()),PoNetwork.onlineHandlePub&&PoNetwork.onlineHandlePub()},clearNetworkTimer:function(){clearInterval(PoNetwork.netWorkTimer)},test:function(e){var n;null==e&&(e={}),PoNetwork.onlineCallback=e.onlineCallback||null,PoNetwork.offlineCallback=e.offlineCallback||null,PoNetwork.saveTrigger=e.saveTrigger||null,0==navigator.onLine?PoNetwork.offlineFc():((n=new Image).src="https://ks3-cn-beijing.ksyun.com/mind-files/netest.jpg?_u="+(new Date).getTime(),PoNetwork.imgTimeoutTimer=setTimeout(function(){PoNetwork.testAgain(),n=null},PoNetwork.imgExpireLoadTime),n.onload=function(){clearTimeout(PoNetwork.imgTimeoutTimer),clearTimeout(PoNetwork.imgTimeoutTimer2),PoNetwork.onlineFc(),n=null})},offlineFc:function(){PoNetwork.offlineHandle(),PoNetwork.status="offline"},onlineFc:function(){PoNetwork.onlineHandle(),PoNetwork.status="online"},testAgain:function(e){var n=this,t=new Image;t.src="https://nettest.processon.com/assets/netest.jpg?_u="+(new Date).getTime(),PoNetwork.imgTimeoutTimer2=setTimeout(function(){n.offlineFc(),t=null},PoNetwork.imgExpireLoadTime),t.onload=function(){clearTimeout(PoNetwork.imgTimeoutTimer2),n.onlineFc(),t=null}},openDialog:function(){if("function"==typeof $&&"object"==typeof $.fn&&"function"==typeof $.fn.dlg&&0<$(".offline-dlg").length){if(offlineMask=!0,"block"==$(".offline-dlg").css("display"))return;CLB.closeCollaElseDlg(),$(".offline-dlg").dlg({onClose:function(){offlineMask=!1}})}else console.log("请检查您的网络情况")},closeDialog:function(){offlineMask=!1,"function"==typeof $&&"object"==typeof $.fn&&"function"==typeof $.fn.dlg&&0<$(".offline-dlg").length?($(".offline-dlg").dlg("close"),offlineMask=!1):console.log("请检查您的网络情况")}},postWpsErrorMsg={SecretGroupLocked:"私密文件夹已经锁定",fileNameConflict:"文件名冲突",userNotLogin:"用户尚未登录",fileNameEmpty:"文件名不能为空, ",SecretGroupPermissionDenied:"私密文件夹操作权限不足",permissionDenied:"您的操作权限不足",InvalidArgument:"无效的参数",SpaceFull:"流程图自动保存至云文档，占用WPS云空间。WPS云空间不足导致保存失败，您可开通会员或整理云文档获取更多可用的云空间。",userDeptSpaceFull:"WPS企业云空间不足导致保存失败，您可开通会员或整理云文档获取更多可用的云空间。",userSpaceFull:"云空间不足导致保存失败，您可开通会员或整理云文档获取更多可用的云空间。",fileNameLengthExceed:"文件名需控制在100个字符以内，请修改文件名。",illegalFname:"文件名不能包含*等特殊字符，请修改文件名。",notGroupMember:"您已不是该团队成员",fileNotUploaded:"文件未上传",fileNotExists:"文件(夹)不存在"},CLB={socket:null,clientId:null,isOffLine:!1,saving:!1,collaClient:null,collaItv:null,collaUsers:null,collaUserCount:1,collaCount:1,collaPollTimeSingle:8e3,collaPollTime:2600,baseUrl:0<=window.location.host.indexOf("processon.com")?"https://cb.processon.com/":"/",versionSaveTime:3e5,wpsSaveTime:3e4,wpsSaveCount:0,versionNow:0,version:0,wpsSaving:!1,wpsSaveTimeCount:0,webSocketUrl:"wss://tdocscolla.processon.com/websocket",url:"",unloaded:!1,init:function(){var n=this;"tencent"==storePos&&(window.setInterval(function(){n.wpsSaveTimeCount+=1},1e3),$(document).on("mouseleave",function(){navigator.onLine&&n.version!=n.versionNow&&(n.wpsSaveTimeCount<5||CLB.postData2Wps())}),window.onbeforeunload=function(e){n.version!=n.versionNow&&CLB.postData2Wps(),"undefined"!=typeof poWebSocket&&poWebSocket&&poWebSocket.close()},window.setInterval(function(){n.version!=n.versionNow&&CLB.postData2Wps()},CLB.wpsSaveTime)),PoNetwork.init({})},connection:null,listenFlag:!0,deviceIdentify:function(){return 0<navigator.userAgent.indexOf("Yun/")||void 0===window.cefQuery?"wpsyun":0<navigator.userAgent.indexOf("Mac OS")?"wpsclient_mac":"wpsclient"},userInfo:{defaultPort:window.location.origin+"/assets/images/user-port-default.png"},collaStart:function(){},heartCheck:{heartRate:1e4,timer:null,serverTimer:null,reset:function(){return clearTimeout(this.timer),clearTimeout(this.serverTimer),this},start:function(){}},createWebsocket:function(){},reconnecting:!1,reconnectTimer:null,reconnectCount:0,socketReconnect:function(){},collaEventInit:function(){},clickSaveTimer:null,saveToWPSErrorCount:0,postData2Wps:function(e){var n,t,o=this;this.version==this.versionNow&&"click"!=e||this.wpsSaving||(this.wpsSaving=!0,this.wpsSaveCount+=1,n="",4!=this.wpsSaveCount&&"click"!=e&&"all"!=e||(this.wpsSaveCount=0,n=JSON.stringify(Model.define)),$("#saving_tip").text("正在保存..."),t={user_id:userId,encrypted_session:encrypted_session,client_id:client_id,file_id:file_id,trace_id:trace_id,sync:!0,ignore:"msgStr",defId:defId,msgStr:n},$.ajax({url:"/tdocs/template/diagraming/msg",data:t,cache:!1,type:"post",success:function(e){if(console.log(e),o.wpsSaving=!1,o.wpsSaveTimeCount=0,"success"==e.result)return $("#manage_save_template").html("保存成功: "+(new Date).getHours()+":"+(new Date).getMinutes()+":"+(new Date).getSeconds()),o.versionNow=o.version,setTimeout(function(){sendMessage("notify",{eventType:"save_success"}),$("#saving_tip").text("已保存至WPS云文档")},100),o.saveToWPSErrorCount=0,$("#postwps-error-tip-temp").hide(),void(CLB.saveWpsIntervalTimer&&(clearInterval(CLB.saveWpsIntervalTimer),CLB.saveWpsIntervalTimer=null));var n;"success"!=e.result&&($("#postwps-error-dlg"),n=$("#postwps-notExist-dlg"),postWpsErrorMsg.hasOwnProperty(e.result)?("SpaceFull"==e.result?n.find(".dialog_buttons").show():n.find(".dialog_buttons").hide(),n.find(".error-des").text(postWpsErrorMsg[e.result]),"block"!=n.css("display")&&n.dlg()):(o.saveToWPSErrorCount++,o.saveToWPSErrorCount<3?2==o.saveToWPSErrorCount&&$("#postwps-error-dlg-temp").dlg({onColse:function(){$("#postwps-error-tip-temp").show()}}):$("#postwps-error-tip-temp").show()),CLB.saveWpsyun_())},error:function(e){o.wpsSaving=!1,o.wpsSaveTimeCount=0;var n=$("#postwps-error-dlg");n.find(".error-des").text("请您尝试重新保存，如果仍提示失败，您可下载pos文件并反馈给我们！"),"block"!=n.css("display")&&n.dlg(),CLB.saveWpsyun_()}}))},saveWpsIntervalTimer:null,saveWpsyun_:function(){},saveVersion:function(e){},stopListen:function(){this.listenFlag=!1,CLB.connection&&CLB.connection.abort(),CLB.connection=null},sending:!1,onlineStatus:"on",messageQueue:[],mess:[],tempMess:[],send:function(e){this.version++;var n=null;if(e){if(n="[object Object]"===Object.prototype.toString.call(e)?Utils.copyArray([e]):Utils.copyArray(e),$("#savetip").text(""),1==this.sending)return this.tempMess=this.tempMess.concat(n),!1;this.sending=!0,this.mess=this.tempMess.concat(n),this.tempMess=[];var t=JSON.stringify(this.mess),o={user_id:userId,encrypted_session:encrypted_session,client_id:client_id,file_id:file_id,trace_id:trace_id,sync:!1,ignore:"msgStr",defId:defId,msgStr:t};$.ajax({url:"/tdocs/template/diagraming/msg",data:o,cache:!1,type:"post",success:function(e){if(console.log(e),CLB.sending=!1,"success"!=e.result)CLB.sendOnError(Utils.copyArray(CLB.mess)),CLB.saveWpsyun_(),CLB.saveLocalwps();else{$("#manage_save_template").html("保存成功: "+(new Date).getHours()+":"+(new Date).getMinutes()+":"+(new Date).getSeconds()),CLB.sendErrorCount=0;try{var n,t=Utils.copyArray(CLB.mess);"undefined"!=typeof poWebSocket&&poWebSocket&&(n={type:"_s@deliver",content:t},poWebSocket.send(JSON.stringify(n)))}catch(e){}}CLB.mess=[]},error:function(e){CLB.sending=!1,CLB.sendOnError(),CLB.saveWpsyun_(),CLB.saveLocalwps()}})}},sendOnError:function(e){CLB.sendErrorCount++,CLB.sendErrorCount<=1?setTimeout(function(){CLB.send(e)},4e3):localStorage?CLB.offline():CLB.showDisconnected()},sendErrorCount:0,localSaveCount:0,saveLocalwps:function(){var e=$(".diagram_title").text();localStorage["def_local_"+fileId]=JSON.stringify(Model.define),localStorage["title_local_"+fileId]=e,localStorage["version_local_"+fileId]=chartVersion+1},doSend:function(n){var t,e;if(void 0===n){if(0==this.messageQueue.length)return;t=this.messageQueue,this.messageQueue=[]}else t=n;e="string"!=typeof t?JSON.stringify(t):t,this.sending=!0,void 0===n&&$("#saving_tip").text("<@i18n resource='diagraming.saving'/>");var o={user_id:userId,encrypted_session:encrypted_session,client_id:client_id,file_id:file_id,trace_id:trace_id,sync:!1,ignore:"msgStr",defId:defId,msgStr:e};$.ajax({url:"/tdocs/template/diagraming/msg",data:o,cache:!1,type:"post",success:function(e){console.log(e),$("#manage_save_template").html("保存成功: "+(new Date).getHours()+":"+(new Date).getMinutes()+":"+(new Date).getSeconds()),CLB.sending=!1,void(CLB.sendErrorCount=0)===n&&(sendMessage("notify",{eventType:"save_success"}),$("#saving_tip").text("<@i18n resource='diagraming.saved'/>")),CLB.doSend(),chartVersion=e.version},error:function(e){CLB.sendErrorCount++,CLB.sendErrorCount<=1?setTimeout(function(){CLB.doSend(t)},4e3):localStorage?CLB.offline():CLB.showDisconnected(),CLB.sending=!1}})},sendDirectly:function(e,n){var t={userId:userId,clientId:CLB.clientId,subject:chartId},o=$.extend(t,e),i=JSON.stringify(o);$.ajax({url:"/tdocs/template/diagraming/msg_directly",data:{msgStr:i,ignore:"msgStr",chartId:chartId},cache:!1,type:"post",success:function(e){n&&n(e)}})},onMessage:function(e){for(var n=0;n<e.length;n++){var t=e[n],o=t.action;"refresh"==o?(CLB.listenTime=t.listenTime,CLB.listen()):"join"==o?$("#chat_user_"+t.userId).length:"leave"==o?t.userId!=userId&&$("#chat_user_"+t.userId).remove():"changeTitle"==o?t.clientId!=this.clientId&&$(".diagram_title").text(t.title):"chat"==o?t.clientId!=this.clientId&&this.appendChatMsg(t.name,t.message,!0):"changeSchema"==o?t.clientId!=this.clientId&&(""==t.categories?Designer.setSchema([]):Designer.setSchema(t.categories.split(","))):"command"==o?MessageSource.receive(t.messages):"addHistory"==o&&null!=Dock.historyVersions&&t.clientId!=this.clientId&&Dock.loadHistorys()}},offlineRemind:!0,offline:function(){this.onlineStatus="off",this.sending=!1,this.offlineRemind&&UI.showTip("<@i18n resource='diagraming.offline.tip'/><a href='javascript:' style='margin-left: 10px;color:#0080FF' onclick='CLB.notRemindOffline()'><@i18n resource='diagraming.offline.remind'/></a>","left")},online:function(){UI.hideTip(),this.onlineStatus="on"},notRemindOffline:function(){this.offlineRemind=!1,UI.hideTip()},showDisconnected:function(){$("#disconnected").dlg({closable:!1})},localToServer:function(n){var e=localStorage["def_local_"+chartId],t=localStorage["title_local_"+chartId];e&&(this.sending=!0,$.ajax({url:"/diagraming/savelocal",data:{def:e,title:t,chartId:chartId,ignore:"def"},cache:!1,type:"post",success:function(e){n&&n(e),CLB.sending=!1,CLB.removeLocal()},error:function(){CLB.sending=!1}}))},findLocal:function(){var e,n,t=!1;return localStorage&&localStorage["def_local_"+chartId]&&(e=localStorage["def_local_"+chartId],n=parseInt(localStorage["version_local_"+chartId]),parseInt(localStorage["title_local_"+chartId]),n>=chartVersion?(Designer.open(e),this.localToServer(),t=!0):this.removeLocal()),t},removeLocal:function(){localStorage.removeItem("def_local_"+chartId),localStorage.removeItem("title_local_"+chartId),localStorage.removeItem("version_local_"+chartId)},collaUsers:{},collaUserClient:{},filterIllegalWord:function(e){return e.replace(/[(\ )(\!)(\@)(\#)(\$)(\%)(\^)(\&)(\*)(\\)(\')(\")(\,)(\.)(\/)(\<)(\>)(\?)]+/g,"")},manageOnlineUsers:function(e,n){var t=this;if(null==n&&e instanceof Array&&(t.collaUsers={},t.collaUserClient={},e.forEach(function(e,n){null==t.collaUserClient[e.clientId]&&(t.collaUserClient[e.clientId]=e),null==t.collaUsers[e.userId]&&(t.collaUsers[e.userId]=e,t.collaUserClient[e.clientId]=e)})),"join"==n&&(t.collaUserClient[e.clientId]=e,null==t.collaUsers[e.userId]&&(t.collaUsers[e.userId]=e)),"leave"==n){var o=0;for(var i in t.collaUserClient){t.collaUserClient[i].userId==e.userId&&o++}t.collaUserClient[e.clientId]&&delete t.collaUserClient[e.clientId],t.collaUsers[e.userId]&&0<o&&o<2&&delete t.collaUsers[e.userId]}},cooperatingSending:!1,cooperatingSend:function(e){},stopCollaDlg:function(e){var n=this;if("undefined"!=typeof getCollaCountTimer&&getCollaCountTimer&&clearInterval(getCollaCountTimer),Object.keys(n.collaUserClient).length<2&&!e)return n.socketReconnect(),void(getCollaCountTimer=setInterval(function(){n.cooperatingSend(function(e){1<e&&n.stopCollaDlg(!0)})},2e4));var t=$("#stop-colla-dlg");0==t.length&&(t=$('<div id="stop-colla-dlg" class="dialog" style="width: 400px; "><h3 style="padding:5px 18px 0;margin-bottom:16px;">协作断开</h3><div style="padding:6px 18px 12px;margin-bottom:12px;"><div style="font-size:14px;">当前文档处于多人协作，协作中断后需同步到最新才能继续编辑。</div></div><div class="dialog_buttons"><span style="margin-right: 20px;" onclick="location.reload();" class="designer_button">同步最新</span></div></div>').appendTo($("#ui_container"))),"block"!=$(".offline-dlg").css("display")&&"block"!=t.css("display")&&(setTimeout(function(){t.dlg({closable:!1})},500),n.closeCollaElseDlg("stop"))},closeCollaElseDlg:function(e){var n,t={support:"#suppor-colla-dlg",stop:"#stop-colla-dlg",server:"#colla-server-error"};for(var o in t){e!=o&&(0<(n=$(t[o])).length&&n.dlg("close"))}$(".offline-dlg").dlg("close")},collaServerError:function(){var e=$("#colla-server-error");0==e.length&&(e=$('<div id="colla-server-error" class=" dialog" style="width: 400px;"><h3 style="padding:0px 18px;margin-bottom:16px;">协作异常</h3><div style="padding:0px 18px;margin-bottom:12px;"><div style="font-size:14px;">当前多人协作未成功连接，请确保网络通畅的情况，稍后重试。</div></div><div style="margin:10px 0;" class="dialog_buttons"><span class="designer_button" style="margin-right: 20px;" onclick="location.href=location.reload()">刷新重试</span></div></div>').appendTo($(".mind-util-container"))),e.dlg(),this.closeCollaElseDlg("server")},notSupportColla:function(){var e=$("#suppor-colla-dlg");0==e.length&&(e=$('<div id="suppor-colla-dlg" class=" dialog" style="width: 400px;"><h3 style="padding:0px 18px;margin-bottom:16px;">协作提醒</h3><div style="padding:0px 18px;margin-bottom:12px;"><div style="font-size:14px;">当前存在多个终端正在编辑文件，当前浏览器版本暂不支持协作，请在其他浏览打开尝试或进入浏览模式</div></div><div style="margin:10px 0;" class="dialog_buttons"><span class="designer_button" style="margin-right: 20px;" onclick="location.href=location.href.replace(\'diagrams/view\', \'diagrams/edit\')">预览模式</span></div></div>').appendTo($(".mind-util-container"))),e.dlg(),this.closeCollaElseDlg("support")},showChatWin:function(){$("#open_chat_btn").button("isSelected")?CLB.closeChatWin():($("#open_chat_btn").button("select"),$("#chattingbox").css("left",$("#shape_panel").outerWidth()).show(),$("#chatting_edit").focus().unbind().bind("keydown",function(e){if(13==e.keyCode){if(""==$.trim($(this).val()))return;return CLB.sendChatMsg(),!1}}),$("#chat_prompt").hide().text("0"))},closeChatWin:function(){$("#chattingbox").hide(),$("#open_chat_btn").button("unselect")},sendChatMsg:function(){var e,n=$("#chatting_edit").val();""!=n?(e={action:"chat",message:n,name:userName},CLB.sendDirectly(e),this.appendChatMsg(userName,n,!1),$("#chatting_edit").val("").focus()):$("#chatting_edit").focus()},appendChatMsg:function(e,n,t){var o;n=(n=Utils.filterXss(n)).replace(/\n/g,"<br/>"),$("#chat_messages").append("<li><span>"+e+"</span>:&nbsp;"+n+"</li>"),$("#chat_messages").scrollTop(9999999),t&&!$("#open_chat_btn").button("isSelected")&&(o=parseInt($("#chat_prompt").text())+1,$("#chat_prompt").show().text(o).animate({top:"-15px"},200).animate({top:"-9px"},200))},setConfig:function(e,n){$.ajax({url:"/diagraming/config",data:{field:e,value:n},cache:!1,type:"post",success:function(){}})}};